define("modules/clean/escape",[],function(){return{escape_to_entity:function(e){return e.replace("<","&lt;").replace(">","&gt;")}}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/image_cache",[],function(){var e;return e=function(){function e(t){this._evict_lru=__bind(this._evict_lru,this),this._add_newest_node=__bind(this._add_newest_node,this),this._remove_node=__bind(this._remove_node,this),this._insert=__bind(this._insert,this),this.get_image=__bind(this.get_image,this),this.preload_image=__bind(this.preload_image,this),t&&(e.MAX_SIZE=t)}return e.MAX_SIZE=100,e.image_nodes_by_url={},e.oldest=null,e.newest=null,e.size=0,e.prototype.preload_image=function(e){return this._insert(e)},e.prototype.get_image=function(e){var t;return t=this._insert(e),this._remove_node(t),this._add_newest_node(t),t.image},e.prototype._insert=function(t){var i,s;return e.image_nodes_by_url[t]?e.image_nodes_by_url[t]:(s=new Image,s.src=t,i={url:t,image:s},e.image_nodes_by_url[t]=i,this._add_newest_node(i),i)},e.prototype._remove_node=function(t){var i,s;return e.oldest===t&&(e.oldest=t.newer),e.newest===t&&(e.newest=t.older),i=t.newer,s=t.older,null!=i&&(i.older=s),null!=s&&(s.newer=i),t.newer=null,t.older=null,e.size--},e.prototype._add_newest_node=function(t){return 0===e.size?(e.oldest=t,e.newest=t):(t.older=e.newest,e.newest.newer=t,e.newest=t),e.size++,this._evict_lru()},e.prototype._evict_lru=function(){var t;return e.size>e.MAX_SIZE?(t=e.oldest,this._remove_node(t),delete e.image_nodes_by_url[t.url]):void 0},e}()}),define("modules/clean/photos/carousel_app/add_to_album_modal",["jquery","external/react","modules/core/i18n","modules/clean/react/modal","modules/clean/photos/carousel_app/album_list","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/carousel_app/carousel_album"],function(e,t,i,s,o,n,r){var _,a,l,u,h;return h=i._,l=s.Modal,u=t.DOM,a=t.createClass({getInitialState:function(){return{editing:!1}},componentWillUpdate:function(t,i){return this.state.editing&&!i.editing?e(this.refs["create-album-input"].getDOMNode()).unbind("keydown",this.create_album_input_key_down):void 0},componentDidUpdate:function(t,i){return this.state.editing&&!i.editing?(this.refs["create-album-input"].getDOMNode().focus(),e(this.refs["create-album-input"].getDOMNode()).bind("keydown",this.create_album_input_key_down)):void 0},edit:function(){return this.setState({editing:!0})},create_album_input_key_down:function(e){return 13===e.keyCode?e.target.value?this.props.create_album_with_name(e.target.value):this.setState({editing:!1}):27===e.keyCode&&this.state.editing?(this.setState({editing:!1}),e.stopPropagation()):void 0},render:function(){return u.div({className:"create-album-item"},u.div({className:"create-album-icon"},"+"),this.state.editing?u.input({className:"create-album-input",ref:"create-album-input",placeholder:h("Add album title",{project:"carousel-web"})}):u.div({className:"create-album-text",onClick:this.edit},h("Create new album",{project:"carousel-web"})))}}),_=function(){function e(){}return e.shown=!1,e.show=function(t){var i,s;return i=n().album_store,s=function(){return function(s){var _;return e.shown=!0,_=l.showInstance(l({title:h("Choose an album",{project:"carousel-web"}),acceptButtonText:null,onDismiss:function(){return e.shown=!1}},u.div({className:"add-to-album-modal"},s?void 0:u.div({className:"add-to-album-loading-bar"}),a({create_album_with_name:function(s){var o;return o=r.create_new_album(s,t),i.add_album(o),_.close(),e.shown=!1,n().open_albums_page_and_view_album(o)}}),s?o({className:"add-to-album-list",albums:s,on_album_click:function(i){return i.add_items(t),_.close(),e.shown=!1,n().open_albums_page_and_view_album(i)}}):void 0)))}}(this),i.albums||i.async_get_albums(function(){return function(t){return e.shown?s(t):void 0}}(this)),s(i.albums)},e}()}),define("modules/clean/photos/carousel_app/album_list",["external/react"],function(e){var t,i,s;return s=e.DOM,i=e.createClass({displayName:"AlbumListItem",getDefaultProps:function(){return{album:null,selected:!1,on_click:null}},render:function(){var t,i;return i=e.addons.classSet,t=i({"albums-list-item":!0,selected:this.props.selected}),s.div({className:t,onClick:function(e){return function(){return e.props.on_click(e.props.album)}}(this)},s.div({className:"album-thumb"},s.img(this.props.album.thumbnail_url_32?{className:"album-img",src:this.props.album.thumbnail_url_32}:{src:"/static/images/carousel/carousel_app/empty_album-vflaKuCMr.png"})),s.div({className:"album-info"},s.div({className:"album-name"},this.props.album.name),s.div({className:"album-count"},this.props.album.count)))}}),t=e.createClass({displayName:"AlbumList",getDefaultProps:function(){return{selected_album:null}},propTypes:{albums:e.PropTypes.array.isRequired,on_album_click:e.PropTypes.func.isRequired},render:function(){var e;return s.div({className:this.props.className},function(){var t,s,o,n;for(o=this.props.albums,n=[],t=0,s=o.length;s>t;t++)e=o[t],n.push(i({key:e.collection_gid,album:e,on_click:this.props.on_album_click,selected:this.props.selected_album===e}));return n}.call(this))}})});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function i(){this.constructor=e}for(var s in t)__hasProp.call(t,s)&&(e[s]=t[s]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};define("modules/clean/photos/carousel_app/album_store",["jquery","modules/clean/ajax","modules/clean/photos/carousel_app/carousel_album","modules/clean/photos/carousel_app/event_dispatcher"],function(e,t,i,s){var o;return o=function(e){function s(){this.move_to_front=__bind(this.move_to_front,this),this.add_album=__bind(this.add_album,this),s.__super__.constructor.call(this),this.albums=null,this.callbacks=[]}return __extends(s,e),s.CHANGE_EVENT="ALBUMS_STORE:CHANGE_EVENT",s.prototype.async_get_albums=function(e){var t;return this.albums&&e(this.albums,t=!this.albums_fetched_from_server),this.albums_fetched_from_server?void 0:(this.callbacks.push(e),this._fetch_albums())},s.prototype.add_album=function(e){return null==this.albums&&(this.albums=[]),this.albums.unshift(e),e.album_store=this,this.trigger(s.CHANGE_EVENT)},s.prototype.move_to_front=function(e){var t,i,o,n,r;for(r=this.albums,i=o=0,n=r.length;n>o;i=++o)if(t=r[i],t===e){this.albums.splice(i,1);break}return this.albums.unshift(t),this.trigger(s.CHANGE_EVENT)},s.prototype._fetch_albums=function(e){return this.request_in_flight?void 0:(this.request_in_flight=!0,t.WebRequest({url:"/collections",data:{limit:50},success:function(t){return function(s){var o,n,r,_,a,l,u,h;for(r=JSON.parse(s),null==t.albums&&(t.albums=[]),_=0,l=r.length;l>_;_++)n=r[_],o=new i(n),t.albums.push(o),o.album_store=t;for(h=t.callbacks,a=0,u=h.length;u>a;a++)(e=h[a])(t.albums);return t.albums_fetched_from_server=!0}}(this)}))},s.prototype.delete_album=function(e){var t,i,o,n,r;for(i=0,r=this.albums,i=o=0,n=r.length;n>o;i=++o)if(t=r[i],t.collection_gid===e.collection_gid){this.albums.splice(i,1);break}return e["delete"](),this.trigger(s.CHANGE_EVENT),this.albums[i]||this.albums[i-1]},s}(s)});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/albums_page",["jquery","external/jquery.mousewheel","external/react","modules/core/i18n","modules/clean/ajax","modules/clean/escape","modules/clean/photos/carousel_app/album_list","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/carousel_app/carousel_album","modules/clean/photos/carousel_app/react_timeline","modules/clean/photos/carousel_app/selection_limit_modal","modules/clean/photos/carousel_app/store_event","modules/clean/photos/carousel_out_of_band_sharing_utils","modules/clean/react/button","modules/clean/react/context_menu","modules/clean/react/modal","modules/clean/react/sprite","modules/core/dom"],function(e,t,i,s,o,n,r,_,a,l,u,h,c,p,d,m,g,f){var b,v,w,y,k,x,E,T;return E=n.escape_to_entity,v=d.ContextMenu,w=d.ContextMenuItem,k=m.SimpleModal,x=i.DOM,T=s.i18n_default_project("carousel-web")._,y=i.createClass({displayName:"AlbumPage",getInitialState:function(){return{renaming_album:!1,more_actions_dropdown_position:{},more_actions_dropdown_shown:!1,num_selected:0,header_width:"100%"}},getDefaultProps:function(){return{albums:[],current_album:null,set_loading:null,bind_scroll:!0}},propTypes:{albums:i.PropTypes.arrayOf(i.PropTypes.instanceOf(a)),album_store:i.PropTypes.object,current_album:i.PropTypes.instanceOf(a),current_album_changed:i.PropTypes.func,open_lightbox_at_item:i.PropTypes.func,thumb_loading_manager:i.PropTypes.object,update_timeline:i.PropTypes.func,bind_scroll:i.PropTypes.bool,set_loading:i.PropTypes.func,use_dropbox_chrome:i.PropTypes.bool.isRequired,open_albums_grid:i.PropTypes.func.isRequired},componentDidMount:function(){var t,i;return this.place_more_actions_dropdown(),e(document).bind("click",this.hide_menus),e(null!=(t=this.refs["more-actions-button"])?t.getDOMNode():void 0).bind("click",this.toggle_more_actions),e(null!=(i=this.refs["albums-nav"])?i.getDOMNode():void 0).bind("mousewheel",this.on_nav_scroll),this.props.current_album?this.set_current_album():void 0},componentWillReceiveProps:function(e){return this.props.current_album!==e.current_album?this.setState({num_selected:0}):void 0},componentWillUpdate:function(t){var i,s,o,n;return e(null!=(i=this.refs["more-actions-button"])?i.getDOMNode():void 0).unbind("click",this.toggle_more_actions),e(null!=(s=this.refs["albums-nav"])?s.getDOMNode():void 0).unbind("mousewheel",this.on_nav_scroll),this.props.current_album!==t.current_album?(null!=(o=this.props.current_album)&&o.item_store.off(h.SELECTED_CHANGED,this.on_items_selected),null!=(n=this.props.current_album)?n.item_store.off(h.ITEMS_DELETED,this.on_items_deleted):void 0):void 0},componentDidUpdate:function(t){var i,s,o;return this.place_more_actions_dropdown(),this.fetch_current_album_data(),e(null!=(i=this.refs["album-header-name-input"])?i.getDOMNode():void 0).select(),e(null!=(s=this.refs["more-actions-button"])?s.getDOMNode():void 0).bind("click",this.toggle_more_actions),e(null!=(o=this.refs["albums-nav"])?o.getDOMNode():void 0).bind("mousewheel",this.on_nav_scroll),this.props.current_album&&t.current_album!==this.props.current_album?this.set_current_album():void 0},componentWillUnmount:function(){var t,i,s,o;return e(document).unbind("click",this.hide_menus),e(null!=(t=this.refs["more-actions-button"])?t.getDOMNode():void 0).unbind("click",this.toggle_more_actions),e(null!=(i=this.refs["albums-nav"])?i.getDOMNode():void 0).unbind("mousewheel",this.on_nav_scroll),null!=(s=this.props.current_album)&&s.item_store.off(h.SELECTED_CHANGED,this.on_items_selected),null!=(o=this.props.current_album)?o.item_store.off(h.ITEMS_DELETED,this.on_items_deleted):void 0},set_current_album:function(){return this.props.current_album_changed(this.props.current_album),this.props.current_album.item_store.on(h.SELECTED_CHANGED,this.on_items_selected),this.props.current_album.item_store.on(h.ITEMS_DELETED,this.on_items_deleted),this.props.thumb_loading_manager.set_viewport({window_height:f.viewport_dimensions().height,scroll_position:f.scroll_offsets().top}),this.props.thumb_loading_manager.fetch_thumbs_around_viewport(this.props.current_album.item_store)},place_more_actions_dropdown:function(){return this.props.albums.length?setTimeout(function(e){return function(){var t;return(t=e.get_more_actions_dropdown_position())&&(e.state.more_actions_dropdown_position.top!==t.top||e.state.more_actions_dropdown_position.left!==t.left)?e.setState({more_actions_dropdown_position:e.get_more_actions_dropdown_position()}):void 0}}(this),1):void 0},fetch_current_album_data:function(){return this.props.current_album&&!this.props.current_album.item_data_fetched&&this.props.current_album.fetch_item_data(this.on_item_data_fetched),this.update_loading()},on_item_data_fetched:function(){return this.isMounted()?(this.forceUpdate(),this.update_loading(),"function"==typeof this.update_timeline&&this.update_timeline([this.props.current_album]),this.props.thumb_loading_manager.fetch_thumbs_around_viewport(this.props.current_album.item_store)):void 0},update_loading:function(){return this.props.current_album?this.props.set_loading(this.props.current_album.item_data_fetched?!1:!0):void 0},on_scrolling:function(e){var t,i,s,o;return o=e.window_width,s=e.window_height,i=e.scroll_top,t=i+s/2,this.props.thumb_loading_manager.set_viewport({window_height:s,scroll_position:t})},on_request_data_for_events:function(){return this.props.thumb_loading_manager.fetch_thumbs_around_viewport(this.props.current_album.item_store)},on_nav_scroll:function(){var t,i;return t=e(null!=(i=this.refs["albums-nav"])?i.getDOMNode():void 0),t.scrollTop(t.scrollTop()+event.deltaY),!1},on_nav_click:function(e){return this.setProps({current_album:e})},hide_menus:function(){return this.setState({more_actions_dropdown_shown:!1})},toggle_more_actions:function(e){return this.setState({more_actions_dropdown_shown:!this.state.more_actions_dropdown_shown}),e.stopPropagation()},album_name_input_key_down:function(e){return 13===e.keyCode?this.save_album_name(e):27===e.keyCode?this.setState({renaming_album:!1}):void 0},save_album_name:function(e){return e.target.value&&this.props.current_album.rename(e.target.value,this.save_album_name_failed),this.setState({renaming_album:!1})},save_album_name_failed:function(){return this.setState({renaming_album:!0})},share_album:function(){var e;return e=new c({should_show_loading_dialog_before_link_sharing:!0,should_use_dropbox_branded_link:!0}),e.share_album_link(this.props.current_album)},delete_album:function(){var e;return e=this.props.current_album,k.show({title_text:T("Delete album?"),body_html:T("All the photos and videos in <strong>%(album_name)s</strong> will still be in your Carousel. Delete the album?").format({album_name:E(e.name)}),confirm_text:T("Delete"),cancel_text:T("Cancel"),confirm_callback:function(t){return function(){var i;return t.props.current_album.item_store.deselect_all(),i=t.props.album_store.delete_album(e),t.props.use_dropbox_chrome?t.props.open_albums_grid():t.setProps({current_album:i})}}(this)})},select_all:function(){var e;return this.props.current_album.num_items>u.SELECTION_MAX_SIZE?void u.show():(e=this.props.current_album.item_store,e.selected_items.length===e.all_items.length?e.deselect_all():e.select_all())},on_items_selected:function(){return this.setState({num_selected:this.props.current_album.item_store.selected_items.length})},on_items_deleted:function(){return this.forceUpdate()},get_more_actions_dropdown_position:function(){var t,i,s,o,n,r,_;return(r=this.refs["more-actions-dropdown"])?(i=e(r.getDOMNode()),t=e(r.refs.arrow.getDOMNode()),s=e(this.refs["more-actions-button"].getDOMNode()),_=s.offset(),n=t.position(),o=i.outerWidth()-n.left,{top:_.top+s.outerHeight()+10,left:_.left-i.outerWidth()+o+s.outerWidth()/2}):void 0},render_empty_state:function(e){return null==e&&(e=!1),x.div({className:"empty-state"},x.div({className:"empty-wrapper "+(e?"empty-album":"")},x.div({className:"empty-content"},x.img({src:"/static/images/carousel/carousel_app/photos-vflrai3Bq.png"}),x.div({className:"empty-content-header"},T(e?"This album is empty":"You don’t have any albums yet")),e?x.p({},T("Select some photos from your timeline to add to this album.")):x.p({},T("Select some photos from your timeline to start a new album.")))))},render_album_header:function(){return x.div({className:"album-header-container"},x.div({className:"album-header",style:{width:this.state.header_width}},this.state.renaming_album?x.input({type:"text",className:"album-header-name-input",onBlur:this.save_album_name,onKeyDown:this.album_name_input_key_down,defaultValue:this.props.current_album.name,ref:"album-header-name-input"}):x.div({className:"album-header-name",onClick:function(e){return function(){return e.setState({renaming_album:!0})}}(this)},this.props.current_album.name),x.div({className:"album-header-count"},this.props.current_album.count),x.div({className:"album-actions"},p.button({className:"more-actions-button",importance:"tertiary",ref:"more-actions-button"},g({group:"web",name:"more-gray"})),this.props.current_album.num_items>0?p.button({className:"select-all-button",importance:"tertiary",onClick:this.select_all},T(this.state.num_selected===this.props.current_album.num_items?"Deselect all":"Select all")):void 0,this.render_more_actions_dropdown())))},render_more_actions_dropdown:function(){var e,t;return v({shown:this.state.more_actions_dropdown_shown,top:(null!=(e=this.state.more_actions_dropdown_position)?e.top:void 0)||0,left:(null!=(t=this.state.more_actions_dropdown_position)?t.left:void 0)||0,arrow_position:"top-right",ref:"more-actions-dropdown"},w({onClick:function(e){return function(){return e.setState({renaming_album:!0})}}(this),sprite_group:"web",sprite_name:"pencil"},T("Rename album")),w({onClick:this.delete_album,sprite_group:"web",sprite_name:"trash-can"},T("Delete album")),w({onClick:this.share_album,sprite_group:"web",sprite_name:"s-link-blue"},T("Share album")))},render:function(){var t;return 0===this.props.albums.length?this.render_empty_state():(null==this.props.current_album&&(this.props.current_album=this.props.albums[0]),x.div({className:"albums-page-content"},this.props.use_dropbox_chrome?void 0:r({ref:"albums-nav",className:"albums-nav",albums:this.props.albums,on_album_click:this.on_nav_click,selected_album:this.props.current_album}),0===this.props.current_album.num_items?x.div({className:"albums-grid"},this.render_empty_state(t=!0),this.render_album_header()):x.div({className:"albums-grid"},this.render_album_header(),new l({page:"album",bind_scroll:this.props.bind_scroll,container_el:e(".albums-page"),albums_allowed:!0,min_thumbs_per_row:3,include_faces:null,reduce_whitespace:null,resize_thumbs:null,round_thumb_size:null,prevent_small_merges:null,less_padding:null,event_header_height:0,indent_titles:null,show_heros:!1,app:null,item_store:this.props.current_album.item_store,event_store:{on:function(e){return function(t,i){e.update_timeline=i}}(this),off:function(){return function(){}}(this)},events:[this.props.current_album],on_click_item:this.props.open_lightbox_at_item,on_select_all:function(){},on_scrolling:this.on_scrolling,on_request_data_for_events:this.on_request_data_for_events,on_long_stopped_scrolling:function(){},show_context_menu_for_item:function(){},on_item_did_mount:function(){},scroll_perf:null,timeline_navigation:!1,min_page_margin:160,on_width_change:function(e){return function(t){return e.setState({header_width:t})}}(this),show_marquee:_().constants.show_marquee}))))}}),b=function(){function e(e,t){this.app=e,this.$container=t,this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),this.init_albums_page=__bind(this.init_albums_page,this),this.fetch_albums_list=__bind(this.fetch_albums_list,this),this.fetch_albums_list()}return e.prototype.fetch_albums_list=function(){return this.app.set_loading(!0),this.loading_list=!0,this.app.album_store.async_get_albums(function(e){return function(t,i){return e.albums=t,null==i&&(i=!1),e.shown&&(0===e.albums.length||e.albums[0].item_data_fetched)&&e.app.set_loading(!1),e.loading_list=i,e.init_albums_page()}}(this))},e.prototype.init_albums_page=function(){var e,t,s,o,n,r;if(s=this.albums[0],this.app.constants.initial_album_gid)for(r=this.albums,o=0,n=r.length;n>o;o++)e=r[o],e.collection_gid===this.app.constants.initial_album_gid&&(s=e);return t=new y({album_store:this.app.album_store,albums:this.albums,current_album:s,thumb_loading_manager:this.app.thumb_loading_manager,set_loading:function(e){return function(t){return e.shown&&!e.loading_list?e.app.set_loading(t):void 0}}(this),current_album_changed:function(e){return function(t){return t.item_store.deselect_all(),e.app.set_shared_item_store(t.item_store),_().current_album=t}}(this),open_lightbox_at_item:function(e){return function(t){return e.app.lightbox.open_at_item(t)}}(this),open_albums_grid:this.app.open_albums_grid,use_dropbox_chrome:this.app.constants.use_dropbox_chrome}),this.albums_page=i.render(t,this.$container[0])},e.prototype.bind_scroll=function(){var e;return this.shown&&null!=(e=this.albums_page)?e.setProps({bind_scroll:!0}):void 0},e.prototype.unbind_scroll=function(){var e;return this.shown&&null!=(e=this.albums_page)?e.setProps({bind_scroll:!1}):void 0},e.prototype.show=function(e){var t;return t=e.album,this.shown=!0,t&&(this.albums_page.setProps({current_album:t}),this.albums_page.update_timeline([t])),this.$container.show()},e.prototype.hide=function(){return this.shown=!1,this.$container.hide(),this.app.lightbox.close()},e}()}),define("modules/clean/photos/carousel_app/app_manager",["modules/clean/photos/carousel_app/event_dispatcher"],function(e){var t;return t=function(){function t(){return null!=i?i:(i=this,this.dispatcher=new e,i)}var i;return i=null,t.LIGHTBOX_CLOSED="LightboxEvent:closed",t}()}),define("modules/clean/photos/carousel_app/avatar",["external/react"],function(e){var t,i;return i=e.DOM,t=e.createClass({displayName:"Avatar",propTypes:{avatar_url:e.PropTypes.string,avatar_initials:e.PropTypes.string},render:function(){var e,t;return e=this.props.avatar_url?"":"avatar-border",t=this.props.avatar_url,this.props.avatar_url||this.props.avatar_initials||(t="/static/images/avatar/faceholder-64-vflHTEplh.png",e=""),i.div({className:"avatar "+e},t?i.img({className:"avatar-img",src:t}):this.props.avatar_initials)}})});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/carousel_album",["modules/core/i18n","modules/clean/ajax","modules/clean/viewer","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/carousel_app/count_text","modules/clean/photos/carousel_app/item_store","modules/clean/photos/carousel_app/store_event"],function(e,t,i,s,o,n,r){var _,a,l;return l=e._,a=e.ungettext,_=function(){function e(e){var t,i;t=e.gid,this.name=e.name,this.num_items=e.num_items,this.num_photos=e.num_photos,this.num_videos=e.num_videos,this.thumbnail_url_32=e.thumbnail_url_32,this.item_data_fetched=e.item_data_fetched,i=e.url,this.share=__bind(this.share,this),this["delete"]=__bind(this["delete"],this),this.rename=__bind(this.rename,this),this.remove_items=__bind(this.remove_items,this),this._add_items_to_item_store=__bind(this._add_items_to_item_store,this),this.add_items=__bind(this.add_items,this),this.fetch_item_data=__bind(this.fetch_item_data,this),this._update_item_counters=__bind(this._update_item_counters,this),this._recount_items=__bind(this._recount_items,this),this._get_count_text=__bind(this._get_count_text,this),this.url=null!=i?i.replace("/photos/","/app/"):void 0,null==this.num_items&&(this.num_items=0),null==this.num_photos&&(this.num_photos=0),null==this.num_videos&&(this.num_videos=0),this.collection_gid=t,this.item_store=new n,this.item_data=this.item_store.all_items,this.event_id="asdf",null==this.item_data_fetched&&(this.item_data_fetched=!1),this.count=this._get_count_text(),this.item_store.on(r.ITEMS_DELETED,this._recount_items)}return e.create_new_album=function(i,s){var o,n,r,_,a;for(o=new e({gid:"album~"+btoa(Math.random().toString(36)),name:i,thumbnail_url_32:s[0].image_data||s[0].thumbnail_url,item_data_fetched:!0}),_=0,a=s.length;a>_;_++)n=s[_],o._add_items_to_item_store(s);return r=function(){var e,t,i;for(i=[],e=0,t=s.length;t>e;e++)n=s[e],i.push(n.item_counter);return i}(),t.WebRequest({url:"/collection_create",data:{collection_name:i,item_counters:JSON.stringify(r),source_collection_gid:s[0].source_collection_gid},success:function(){return function(e){return e=JSON.parse(e),o.collection_gid=e.gid,o.thumbnail_url_32=e.thumbnail_url_32,o._update_item_counters(e.item_gid_to_new_item_counter),o.url=e.url.replace("/photos/","/app/")}}(this),error:function(){return function(){}}(this)}),o},e.prototype._get_count_text=function(){return o(this.num_photos,this.num_videos)},e.prototype._recount_items=function(){var e,t,i,s;if(this.item_data_fetched){for(this.num_photos=0,this.num_videos=0,s=this.item_store.all_items,t=0,i=s.length;i>t;t++)e=s[t],e.is_video?this.num_videos++:this.num_photos++;return this.num_items=this.num_photos+this.num_videos,this.count=this._get_count_text()}},e.prototype._update_item_counters=function(e){var t,i,s,o;o=[];for(s in e)i=e[s],t=this.item_store.get_item_by_gid(s),t.item_counter=i,o.push(t.source_collection_gid=this.collection_gid);return o},e.prototype.fetch_item_data=function(e,i){return this.on_success=e,!this.item_data_fetched||i?(this.item_data_fetched=!0,t.WebRequest({url:"/app/ajax/get_item_data_for_collection",data:{collection_gid:this.collection_gid,include_faces:"faces"in s().constants,limit:s().constants.album_limit||100,cursor:i},success:function(e){return function(t){var i,s,o,n,r;for(t=JSON.parse(t),r=t.item_data,o=0,n=r.length;n>o;o++)s=r[o],i=e.item_store.add_item_data_if_viewable(s),i.event=e,i.source_collection_gid=e.collection_gid;return t.more?e.fetch_item_data(e.on_success,t.cursor):e.item_store.all_items.length!==e.num_items&&e._recount_items(),e.on_success()}}(this)})):void 0},e.prototype.add_items=function(e){var i,s;return this._add_items_to_item_store(e),s=function(){var t,s,o;for(o=[],t=0,s=e.length;s>t;t++)i=e[t],o.push(i.item_counter);return o}(),t.WebRequest({url:"/collection_add",data:{collection_gid:this.collection_gid,item_counters:JSON.stringify(s),source_collection_gid:e[0].source_collection_gid},success:function(e){return function(t){return t=JSON.parse(t),e._update_item_counters(t.item_gid_to_new_item_counter)}}(this),error:function(){return function(){}}(this)}),this.album_store.move_to_front(this)},e.prototype._add_items_to_item_store=function(e){var t,i,s,o;for(s=0,o=e.length;o>s;s++)t=e[s],this.item_store.get_item_by_gid(t.item_gid)||(i=n.copy(t),i.event=this,this.item_store.add_item_if_viewable(i),t.is_video?this.num_videos++:this.num_photos++);return this.num_items=this.num_videos+this.num_photos,this.count=this._get_count_text(),this.thumbnail_url_32=this.item_store.all_items[0].image_data||this.item_store.all_items[0].thumbnail_url},e.prototype.remove_items=function(e){var i,s,o,n,r,_;for(o=0,n=e.length;n>o;o++)i=e[o],i.is_video?this.num_videos--:this.num_photos--;return this.num_items=this.num_videos+this.num_photos,this.count=this._get_count_text(),this.item_store.remove_items(e),this.thumbnail_url_32=(null!=(r=this.item_store.all_items[0])?r.image_data:void 0)||(null!=(_=this.item_store.all_items[0])?_.thumbnail_url:void 0),s=function(){var t,s,o;for(o=[],t=0,s=e.length;s>t;t++)i=e[t],o.push(i.item_counter);return o}(),t.WebRequest({url:"/collection_remove",data:{collection_gid:this.collection_gid,item_counters:JSON.stringify(s)},error:function(){return function(){}}(this)}),this.album_store.move_to_front(this)},e.prototype.rename=function(e,i){var s;return e!==this.name?(s=this.name,this.name=e,t.WebRequest({url:"/collection_rename",data:{collection_gid:this.collection_gid,new_collection_name:this.name},error:function(e){return function(){return e.name=s,"function"==typeof i?i():void 0}}(this)}),this.album_store.move_to_front(this)):void 0},e.prototype["delete"]=function(){return t.WebRequest({url:"/collection_delete",data:{collection_gid:this.collection_gid,version:1},subject_user:i.get_viewer().personal_user.id,error:function(){return function(){}}(this)})},e.prototype.share=function(e){return t.WebRequest({url:"/app/ajax/share_album",data:{collection_id:this.collection_gid},subject_user:i.get_viewer().personal_user,success:function(t){return t=JSON.parse(t),e(t.link)}})},e}()}),define("modules/clean/photos/carousel_app/carousel_event",[],function(){var e;return e=function(){function e(t){this.date=t.date,this.date_month=t.date_month,this.date_year=t.date_year,this.event_handle=t.event_handle,this.location=t.location,this.num_items=t.num_items,this.sort_key=t.sort_key,this.event_id=e.getEventId(this),this.event_data_received=!1,this.num_selected=0,this.item_data=[]}return e.MISSING_DATES_HANDLE="MISSING_DATES_HANDLE",e.getEventId=function(e){return e.event_handle instanceof Array?e.event_handle.join("_"):e.event_handle},e.prototype.is_missing_dates=function(){return this.event_handle===e.MISSING_DATES_HANDLE},e}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function i(){this.constructor=e}for(var s in t)__hasProp.call(t,s)&&(e[s]=t[s]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};define("modules/clean/photos/carousel_app/carousel_event_store",["modules/clean/photos/carousel_app/event_dispatcher","modules/clean/photos/carousel_app/carousel_event","modules/clean/photos/carousel_app/store_event"],function(e,t,i){var s;return s=function(e){function s(e){this.reverse_order=null!=e?e:!0,this.update_events=__bind(this.update_events,this),this.remove_event=__bind(this.remove_event,this),this.add_event=__bind(this.add_event,this),this.add_event_data=__bind(this.add_event_data,this),this.get_event_by_event_id=__bind(this.get_event_by_event_id,this),s.__super__.constructor.apply(this,arguments),this.event_by_event_id={},this.all_events=[]}return __extends(s,e),s.prototype.get_event_by_event_id=function(e){return this.event_by_event_id[e]},s.prototype.add_event_data=function(e){var i;return i=new t(e),this.add_event(i)},s.prototype.add_event=function(e){return null==this.event_by_event_id[e.event_id]?(this.reverse_order?this.all_events.push(e):this.all_events.unshift(e),this.event_by_event_id[e.event_id]=e,e):void 0},s.prototype.remove_event=function(e){var t;return delete this.event_by_event_id[e.event_id],t=this.all_events.indexOf(e),this.all_events.splice(t,1)},s.prototype.update_events=function(e){var s,o,n,r,_,a,l,u;for(o=[],l=0,u=e.length;u>l;l++){n=e[l],r=t.getEventId(n),_=this.event_by_event_id[r];for(s in n)a=n[s],null!=_&&(_[s]=a);0===n.num_items?this.remove_event(n):o.push(_)}return this.trigger(i.EVENTS_CHANGED,o),o},s}(e)});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/carousel_item",["modules/core/i18n"],function(e){var t,i,s,o,n;return n=e.i18n_default_project("carousel-web"),o=n._,s=n.ungettext,i=function(){return window.devicePixelRatio>1},t=function(){function e(e){var t;t=e.thumbnail_url,this.date=e.date,this.date_time=e.date_time,this.dimensions=e.dimensions,this.download_url=e.download_url,this.editor=e.editor,this.event=e.event,this.face_detections=e.face_detections,this.folder_url=e.folder_url,this.fq_path=e.fq_path,this.lightbox_url=e.lightbox_url,this.rgb_4x4_signature=e.rgb_4x4_signature,this.hidden=e.hidden,this.is_editable=e.is_editable,this.image_data=e.image_data,this.item_counter=e.item_counter,this.item_gid=e.item_gid,this.location=e.location,this.original_thumbnail_url=e.original_thumbnail_url,this.revision=e.revision,this.score=e.score,this.sort_key=e.sort_key,this.time=e.time,this.time_ms=e.time_ms,this.thumb_height=e.thumb_height,this.thumb_width=e.thumb_width,this.video_url=e.video_url,this.source_collection_gid=e.source_collection_gid,this.owner_is_user=e.owner_is_user,this.get_num_likes=__bind(this.get_num_likes,this),this.get_thumb_request_finished_time_ago=__bind(this.get_thumb_request_finished_time_ago,this),this.get_thumb_requested_time_ago=__bind(this.get_thumb_requested_time_ago,this),this.get_thumb_queued_time_ago=__bind(this.get_thumb_queued_time_ago,this),this.set_thumb_request_finished=__bind(this.set_thumb_request_finished,this),this.set_thumb_requested=__bind(this.set_thumb_requested,this),this.set_thumb_queued=__bind(this.set_thumb_queued,this),this.set_default_thumbnail_url_to_2x=__bind(this.set_default_thumbnail_url_to_2x,this),this.set_default_thumbnail_url_to_1x=__bind(this.set_default_thumbnail_url_to_1x,this),this.get_thumbnail_url_by_size=__bind(this.get_thumbnail_url_by_size,this),
this.get_2x_thumbnail_url=__bind(this.get_2x_thumbnail_url,this),this.get_1x_thumbnail_url=__bind(this.get_1x_thumbnail_url,this),this._get_average_rgb=__bind(this._get_average_rgb,this),null==this.original_thumbnail_url&&(this.original_thumbnail_url=t),this.set_default_thumbnail_url_to_1x(),this.image_data=this.image_data||"",this.is_video=!!this.video_url,this.is_selected=!1,this.like_status=!1,this.likee_ids=[],this.likees=[],this.wiggobble=0,this.last_wiggobble=0,this.prev_item=null,this.next_item=null,this.average_rgb=this._get_average_rgb(),this.requested_thumb_size=0}return e.DEFAULT_THUMB_SIZE=256,e.HERO_THUMB_SIZE=512,e.comparator_fn=function(e,t){return e.sort_key<t.sort_key?-1:e.sort_key>t.sort_key?1:0},e.prototype._get_average_rgb=function(){var e,t,i,s;if(null!=this.rgb_4x4_signature){for(i={r:0,g:0,b:0},s=this.rgb_4x4_signature,e=0,t=-3;(t+=3)<s.length;)i.r+=s[t],i.g+=s[t+1],i.b+=s[t+2],++e;return i.r=Math.floor(i.r/e),i.g=Math.floor(i.g/e),i.b=Math.floor(i.b/e),i}return null},e.prototype.get_1x_thumbnail_url=function(){return i()?this.original_thumbnail_url+("?size="+e.HERO_THUMB_SIZE+"x"+e.HERO_THUMB_SIZE):this.original_thumbnail_url},e.prototype.get_2x_thumbnail_url=function(){return i()?this.original_thumbnail_url+("?size="+2*e.HERO_THUMB_SIZE+"x"+2*e.HERO_THUMB_SIZE):this.original_thumbnail_url+("?size="+e.HERO_THUMB_SIZE+"x"+e.HERO_THUMB_SIZE)},e.prototype.get_thumbnail_url_by_size=function(t){return t=t<=e.DEFAULT_THUMB_SIZE?e.DEFAULT_THUMB_SIZE:e.HERO_THUMB_SIZE,this.requested_thumb_size=t,this.original_thumbnail_url+("?size="+t+"x"+t)},e.prototype.set_default_thumbnail_url_to_1x=function(){return this.thumbnail_url=this.get_1x_thumbnail_url()},e.prototype.set_default_thumbnail_url_to_2x=function(){return this.thumbnail_url=this.get_2x_thumbnail_url()},e.prototype.set_thumb_queued=function(){return this._thumb_queued_time=Math.floor((new Date).getTime()/1e3)},e.prototype.set_thumb_requested=function(){return this._thumb_requested_time=Math.floor((new Date).getTime()/1e3)},e.prototype.set_thumb_request_finished=function(){return this._thumb_request_finished_time=Math.floor((new Date).getTime()/1e3)},e.prototype.get_thumb_queued_time_ago=function(){var e;return this._thumb_queued_time?(e=Math.floor((new Date).getTime()/1e3),e-this._thumb_queued_time):null},e.prototype.get_thumb_requested_time_ago=function(){var e;return this._thumb_requested_time?(e=Math.floor((new Date).getTime()/1e3),e-this._thumb_requested_time):null},e.prototype.get_thumb_request_finished_time_ago=function(){var e;return this._thumb_request_finished_time?(e=Math.floor((new Date).getTime()/1e3),e-this._thumb_request_finished_time):null},e.prototype.get_num_likes=function(){var e;return e=this.likees.length,this.like_status&&e++,e},e}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function i(){this.constructor=e}for(var s in t)__hasProp.call(t,s)&&(e[s]=t[s]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},__indexOf=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/photos/carousel_app/carousel_room",["modules/core/i18n","modules/clean/ajax","modules/clean/photos/carousel_app/carousel_item","modules/clean/photos/carousel_app/event_dispatcher","modules/clean/photos/carousel_app/item_store","modules/clean/viewer","modules/core/notify","modules/clean/photos/carousel_app/store_event","modules/clean/photos/carousel_app/app_manager","modules/core/uri"],function(e,t,i,s,o,n,r,_,a,l){var u,h,c,p,d;return d=e.i18n_default_project("carousel-web")._,p=function(){var e,t,i,s;return t=new Date,t.setSeconds(0),t.setMilliseconds(0),s=t.toGMTString(),e=new Date(s.substring(0,s.lastIndexOf(" "))),i=(t-e)/36e5},c=function(){return"loc~"+btoa(Math.random().toString(36))},h=function(){function e(){}return e.ITEM_LIKE=2,e}(),u=function(e){function i(e,t){var s,n,r,_,a,l;if(this.room_gid=e.room_gid,this.link_token=e.link_token,this.contact_vectors=e.contact_vectors,this.get_permissions_text=__bind(this.get_permissions_text,this),this.get_link=__bind(this.get_link,this),this.on_items_fetched=__bind(this.on_items_fetched,this),this.update_item_likes=__bind(this.update_item_likes,this),this._update_single_item_like=__bind(this._update_single_item_like,this),this._add_post_items_to_store=__bind(this._add_post_items_to_store,this),this.on_posts_fetched=__bind(this.on_posts_fetched,this),this.item_like=__bind(this.item_like,this),this.rename=__bind(this.rename,this),this.mark_as_read=__bind(this.mark_as_read,this),this.send_post=__bind(this.send_post,this),this.send_comment=__bind(this.send_comment,this),this.post_items=__bind(this.post_items,this),this.fetch_items=__bind(this.fetch_items,this),this.fetch_posts=__bind(this.fetch_posts,this),this.pause_fetching_data=__bind(this.pause_fetching_data,this),this.start_fetching_data=__bind(this.start_fetching_data,this),this._contains_post=__bind(this._contains_post,this),this._init_room_data=__bind(this._init_room_data,this),i.__super__.constructor.apply(this,arguments),t&&this._init_room_data(t),this.has_more_posts=!0,this.has_more_items=!0,this.fetch_missing_dates=!1,this.post_cursor=void 0,this.post_item_store=new o,this.items_cursor=void 0,this.grid_item_store=new o(n=!1,s=!0),this.item_sort_key=0,this.posts=[],this.like_posts_by_item_gid={},this.unlike_posts_by_item_gid={},this.MAX_RETRIES=2,this.post_retries=0,this.items_retries=0,this.fallback_tz=p(),null==this.num_photos&&(this.num_photos=0),null==this.num_videos&&(this.num_videos=0),this.contact_vectors){for(this.room_name=this.contact_vectors[0][1],l=this.contact_vectors.slice(1,2),_=0,a=l.length;a>_;_++)r=l[_],this.room_name+=", "+r[1];this.contact_vectors.length>2&&(this.room_name+=", + "+(this.contact_vectors.length-2)),this.avatar_initials="@"}}return __extends(i,e),i.POSTS_CHANGED="carousel_room:posts_changed",i.ITEMS_CHANGED="carousel_room:items_changed",i.ROOM_METADATA_CHANGED="carousel_room:room_metadata_changed",i.PUBLIC_WRITEABLE="public_write",i.PUBLIC_VIEWABLE="public_read",i.PRIVATE="private",i.prototype._init_room_data=function(e){return this.sort_key=e.sort_key,this.room_name=e.room_name,this.unread_count=e.unread_count,this.last_updated_date=e.last_updated_date,this.avatar_initials=e.avatar_initials,this.avatar_url=e.avatar_url,this.members=e.members,this.num_items=e.num_items,this.num_photos=e.num_photos,this.num_videos=e.num_videos,this.permissions=e.permissions,this.link_token=e.link_token,this.cover_item_thumbnail_tmpl=e.cover_item_thumbnail_tmpl,this.url=e.url,this.room_initialized=!0,this.unread_count=0,this.url=l({path:l.parse(this.url).path}).toString()},i.prototype._contains_post=function(e){var t,i,s,o,n,r,_,a,l,u,c,p,d,m;for(d=this.posts,n=0,l=d.length;l>n;n++)if(s=d[n],e.local_post_id&&e.local_post_id===s.local_post_id)return!0;if(e.post_type===h.ITEM_LIKE)for(m=e.items,r=0,u=m.length;u>r;r++){if(t=m[r],o=this.unlike_posts_by_item_gid[t.item_gid],null!=o)for(_=0,c=o.length;c>_;_++)if(s=o[_],s.author_account_id===e.author_account_id)return!0;if(e.is_like&&(i=this.like_posts_by_item_gid[t.item_gid],null!=i))for(a=0,p=i.length;p>a;a++)if(s=i[a],s.author_account_id===e.author_account_id)return!0}return!1},i.prototype.start_fetching_data=function(e){return this.set_loading=e,this.room_gid||this.link_token?(this.has_more_posts||this.has_more_items?(this.fetch_posts(),this.fetch_items()):"function"==typeof this.set_loading&&this.set_loading(!1),this.should_be_fetching=!0):void 0},i.prototype.pause_fetching_data=function(){var e,t;return null!=(e=this.post_request)&&e.abort(),null!=(t=this.items_request)&&t.abort(),this.post_request=null,this.items_request=null,this.should_be_fetching=!1},i.prototype.fetch_posts=function(){return!this.post_request&&this.has_more_posts?this.post_request=t.WebRequest({url:"/app/ajax/get_posts",data:{room_gid:this.room_gid,link_token:this.link_token,cursor:JSON.stringify(this.post_cursor),include_room_info:!this.room_initialized},success:function(e){return function(t){var s;return s=JSON.parse(t),s.room&&(e._init_room_data(s.room),e.fetch_items(),e.trigger(i.ROOM_METADATA_CHANGED)),e.post_cursor=s.cursor,e.has_more_posts=s.has_more,s.posts&&e.on_posts_fetched(s.posts),"function"==typeof e.set_loading?e.set_loading(!1):void 0}}(this),error:function(e){return function(t){return-1===t.statusText.indexOf("abort")&&(e.post_retries++,e.post_retries>e.MAX_RETRIES)?e.has_more_posts=!1:void 0}}(this),complete:function(e){return function(){return e.post_request=null,e.has_more_posts&&e.should_be_fetching?e.fetch_posts():void 0}}(this)}):void 0},i.prototype.fetch_items=function(){var e,i;if(this.has_more_items&&!this.items_request)return e={cursor:JSON.stringify(this.items_cursor),is_room:!0,fallback_tz:this.fallback_tz,reverse_order:!0,limit:(null!=(i=a().constants)?i.room_limit:void 0)||100},null!=this.room_gid?e.collection_gid=this.room_gid:null!=this.link_token&&(e.link_token=this.link_token),this.items_request=t.WebRequest({url:"/app/ajax/get_item_data_for_collection",data:e,success:function(e){return function(t){var i;return i=JSON.parse(t),e.items_cursor=i.cursor,e.has_more_items=i.more,e.on_items_fetched(i),"function"==typeof e.set_loading?e.set_loading(!1):void 0}}(this),error:function(e){return function(t){return-1===t.statusText.indexOf("abort")&&(e.items_retries++,e.items_retries>e.MAX_RETRIES)?e.has_more_items=!1:void 0}}(this),complete:function(e){return function(){return e.items_request=null,e.has_more_items&&e.should_be_fetching?e.fetch_items():void 0}}(this)})},i.prototype.post_items=function(e,t,i){return this.send_post(e,"",t,i)},i.prototype.send_comment=function(e,t,i,s){return null==s&&(s=!1),this.send_post([],e,t,i,s)},i.prototype.send_post=function(e,s,n,r,_){var a,l,u,h,p,m,g,f,b,v,w,y;if(null==_&&(_=!1),this.room_initialized){for(m=[],v=0,w=e.length;w>v;v++)l=e[v],this.grid_item_store.get_item_by_gid(l.item_gid)||(h=o.copy(l),h.event=this,p=this.grid_item_store.add_item_if_viewable(h),m.push(p),l.is_video?this.num_videos++:this.num_photos++);this.num_items=this.num_photos+this.num_videos,this.trigger(i.ITEMS_CHANGED,m)}return b=(new Date).getTime(),u=c(),f={local_post_id:u,items:e,message:s,creation_time_utc_ms:b,is_own_post:!0,sort_key:null,time:d("Just now"),prev_post_time_ms:null!=(y=this.posts[this.posts.length-1])?y.creation_time_utc_ms:void 0,avatar_url:n,avatar_initials:r},a=this.room_gid?null:JSON.stringify(this.contact_vectors),this._add_post_items_to_store(f,e),_||t.WebRequest({url:"/app/ajax/send_post",data:{contact_vectors:a,room_gid:this.room_gid,local_post_id:u,message:s,item_gids:JSON.stringify(function(){var t,i,s;for(s=[],t=0,i=e.length;i>t;t++)l=e[t],s.push(l.item_gid);return s}())},success:function(e){return function(t){var i;return i=JSON.parse(t),e.room_gid=i.room_gid,e.room_initialized?void 0:e.start_fetching_data()}}(this)}),this.posts.push(f),this.sort_key=(new Date).getTime(),this.trigger(i.POSTS_CHANGED,g=!0)},i.prototype.mark_as_read=function(){var e,s,o,n;if(this.posts.length&&this.unread_count>0){for(s=null,e=o=n=this.posts.length-1;0>=n?0>=o:o>=0;e=0>=n?++o:--o)if(this.posts[e].post_gid){s=this.posts[e].post_gid;break}return s&&t.WebRequest({url:"/app/ajax/mark_room_as_read",data:{room_gid:this.room_gid,last_post_gid:s}}),this.unread_count=0,this.trigger(i.ROOM_METADATA_CHANGED)}},i.prototype.rename=function(e,i){var s;return e!==this.room_name?(s=this.room_name,this.room_name=e,t.WebRequest({url:"/app/ajax/rename_room",data:{room_gid:this.room_gid,new_room_name:this.room_name},error:function(e){return function(){return e.room_name=s,"function"==typeof i?i():void 0}}(this)})):void 0},i.prototype.item_like=function(e,s,o,a){var l,u,p,m,g,f,b,v,w,y,k,x,E,T,P,S;if(null==a&&(a=!1),u=e.like_status,e.like_status=!e.like_status,f=(new Date).getTime(),m=c(),e.like_status)g={local_post_id:m,items:[e],creation_time_utc_ms:f,is_metadata:!0,is_own_post:!0,is_like:!0,likee_display_name:e.editor,sort_key:null,time:d("Just now"),prev_post_time_ms:null!=(T=this.posts[this.posts.length-1])?T.creation_time_utc_ms:void 0,avatar_url:s,avatar_initials:o,post_type:h.ITEM_LIKE},null==(v=this.like_posts_by_item_gid)[E=e.item_gid]&&(v[E]=[]),this.like_posts_by_item_gid[e.item_gid].push(g),this.posts.push(g);else for(P=this.like_posts_by_item_gid[e.item_gid],l=w=0,k=P.length;k>w;l=++w){if(g=P[l],b=!1,g.is_own_post)for(S=g.items,y=0,x=S.length;x>y&&(p=S[y],p.item_gid===e.item_gid&&(this.posts.splice(this.posts.indexOf(g),1),this.like_posts_by_item_gid[e.item_gid].splice(l,1)),!b);y++);if(b)break}return this.update_item_likes(e),this.trigger(i.POSTS_CHANGED),this.grid_item_store.trigger(_.ITEMS_CHANGED,[e]),this.post_item_store.trigger(_.ITEMS_CHANGED,[e]),a?void 0:t.WebRequest({url:"/app/ajax/like_room_item",subject_user:n.get_viewer().personal_user,data:{item_id:e.item_gid,local_post_id:"loc~"+btoa(Math.random().toString(36)),room_id:this.room_gid,like_status:e.like_status},error:function(){return function(){return e.like_status=u,r.error(d("An error occurred while liking the photo."))}}(this)})},i.prototype.on_posts_fetched=function(e){var t,s,o,n,r,_,a,l,u,c,p,d,m;for(e.sort(function(e,t){return e.creation_time_utc_ms-t.creation_time_utc_ms}),n=0,s=[],a=0,u=e.length;u>a;a++)if(o=e[a],!this._contains_post(o)){if(o.creation_time_utc_ms-n<36e5&&(o.time=null),n=o.creation_time_utc_ms,this._add_post_items_to_store(o,o.items),o.post_type===h.ITEM_LIKE)for(m=o.items,l=0,c=m.length;c>l;l++)t=m[l],o.is_like?(null==(r=this.like_posts_by_item_gid)[p=t.item_gid]&&(r[p]=[]),this.like_posts_by_item_gid[t.item_gid].push(o)):(null==(_=this.unlike_posts_by_item_gid)[d=t.item_gid]&&(_[d]=[]),this.unlike_posts_by_item_gid[t.item_gid].push(o)),this.update_item_likes(t);s.push(o)}return this.posts=s.concat(this.posts),this.trigger(i.POSTS_CHANGED)},i.prototype._add_post_items_to_store=function(e,t){var i,s,o,n,r,_;if(null!=t){for(o=[],r=0,_=t.length;_>r;r++)i=t[r],i.image_data=i.thumbnail_url,i.sort_key=e.creation_time_utc_ms+" "+i.sort_key,s=this.post_item_store.add_item_data(i,n=!0),s.source_collection=this,s.source_collection_gid=this.room_gid,o.push(s);return o.sort(function(e,t){return e.sort_key<t.sort_key?-1:e.sort_key>t.sort_key?1:0}),e.items=o}return e.items=[]},i.prototype._update_single_item_like=function(e,t){var i;return e.is_own_post?t.like_status=!0:(i=e.author_account_id,__indexOf.call(t.likee_ids,i)<0?(t.likee_ids.push(e.author_account_id),t.likees.push({author_first_name:e.author_first_name,display_name:e.author_name,avatar_initials:e.avatar_initials,avatar_url:e.avatar_url})):void 0)},i.prototype.update_item_likes=function(e){var t,i,s,o,n,r,_;if(o=this.like_posts_by_item_gid[e.item_gid],null!=o){for(_=[],n=0,r=o.length;r>n;n++)i=o[n],_.push(function(){var o,n,r,_;for(r=i.items,_=[],o=0,n=r.length;n>o;o++)e=r[o],this._update_single_item_like(i,e),t=this.grid_item_store.get_item_by_gid(e.item_gid),null!=t&&this._update_single_item_like(i,t),s=this.post_item_store.get_item_by_gid(e.item_gid),_.push(null!=s?this._update_single_item_like(i,s):void 0);return _}.call(this));return _}},i.prototype.on_items_fetched=function(e){var t,s,o,n,r,_;for(o=[],_=e.item_data,n=0,r=_.length;r>n;n++)s=_[n],this.grid_item_store.get_item_by_gid(s.item_gid)||(t=this.grid_item_store.add_item_data_if_viewable(s),t.event=this,t.source_collection=this,t.source_collection_gid=this.room_gid,this.update_item_likes(t),o.push(t));return this.item_data=this.grid_item_store.all_items,this.num_items=this.grid_item_store.all_items.length,this.trigger(i.ITEMS_CHANGED,o)},i.prototype.get_link=function(){return l({scheme:"https",authority:Constants.WEBSERVER,path:"/photos/shared_space/"+this.link_token}).toString()},i.prototype.get_permissions_text=function(){return this.permissions===i.PUBLIC_WRITEABLE?d("Anyone with the link can reply"):this.permissions===i.PUBLIC_VIEWABLE?d("Anyone with the link can view"):this.permissions===i.PRIVATE?d("Only members can view & reply"):void 0},i}(s),{CarouselRoom:u,PostType:h}}),define("modules/clean/photos/carousel_app/conversation_header",["jquery","external/react","modules/core/i18n","modules/clean/react/button","modules/clean/react/sprite"],function(e,t,i,s){var o,n,r,_,a;return a=i.i18n_default_project("carousel-web"),_=a._,r=a.ungettext,n=t.DOM,o=t.createClass({displayName:"ConversationHeader",getDefaultProps:function(){return{current_view:"chat"}},propTypes:{data:t.PropTypes.object},_get_count_text:function(){var e,t;return t="",e="",null!=this.props.members&&(t=r("%(num)s member","%(num)s members",this.props.members.length).format({num:this.props.members.length})),0===this.props.num_photos?e=r("%(num)s video","%(num)s videos",this.props.num_videos).format({num:this.props.num_videos}):0===this.props.num_videos?e=r("%(num)s photo","%(num)s photos",this.props.num_photos).format({num:this.props.num_photos}):this.props.num_items>1&&(e=_("%(num)s photos and videos").format({num:this.props.num_items})),_("%(num_members_text)s %(num_items_text)s",{comment:"Displays number of members and number of items in number of photos and videos"}).format({num_members_text:t,num_items_text:e})},render:function(){var e,i,o;return i=t.addons.classSet,e=i({"chat-view":!0,active:"chat_view"===this.props.current_view}),o=i({"gallery-view":!0,active:"gallery_view"===this.props.current_view}),n.div({className:"conversation-header"},n.div({className:"conversation-header-container clearfix",style:{width:this.props.header_width}},n.div({className:"conversation-header-metadata"},n.div({className:"conversation-header-name"},this.props.room_name),n.div({className:"conversation-header-members"},this._get_count_text())),n.div({className:"conversation-header-buttons"},s.button({className:e,importance:"tertiary",onClick:this.props.on_show_list_view},_("Conversation")),s.button({className:o,importance:"tertiary",onClick:this.props.on_show_gallery_view},_("Gallery")))))}})});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/conversation_settings",["jquery","modules/core/i18n","modules/core/html","modules/clean/dbmodal","modules/clean/viewer"],function(e,t,i,s,o){var n,r,_;return _=t._,r=s.DBModal,n=function(){function e(e){this.app=e,this.show=__bind(this.show,this),this.modal=new r({element_id:"conversation-settings-modal",title:_("People in this conversation",{project:"carousel-web"})})}return e.prototype.show=function(e){var t,s,n,r,a,l,u;for(this.modal.show(),t=this.modal.$modal_window.find(".conversation-members"),t.empty(),u=e.members,a=0,l=u.length;l>a;a++)s=u[a],n={avatar_url:s.avatar_url,avatar_initials:s.avatar_initials,display_name:s.display_name,contact_data:s.contact_vector_data},t.append(i.tmpl("carousel_members_list_item_tmpl")(n).toHTML());return r={avatar_url:this.app.user_avatar_url,avatar_initials:this.app.user_initials,display_name:o.get_viewer().display_name+" "+_("(You)",{project:"carousel-web"}),contact_data:o.get_viewer().photos_user.email},t.append(i.tmpl("carousel_members_list_item_tmpl")(r).toHTML())},e}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/conversations_page",["jquery","external/react","external/jquery.mousewheel","modules/core/html","modules/core/i18n","modules/core/uri","modules/clean/ajax","modules/clean/dbmodal","modules/clean/photos/photos_engagement_logger","modules/clean/photos/carousel_app/carousel_room","modules/clean/photos/carousel_app/email_verification","modules/clean/photos/carousel_app/emoji","modules/clean/photos/carousel_app/item_store","modules/clean/photos/carousel_app/reply_composer","modules/clean/photos/carousel_app/conversation_settings","modules/clean/photos/carousel_app/conversation_header","modules/clean/photos/carousel_app/react_timeline","modules/clean/photos/carousel_app/shared_space_view","modules/clean/photos/carousel_app/carousel_event_store","modules/clean/photos/carousel_app/store_event","modules/clean/photos/stop_watch","modules/core/notify"],function(e,t,i,s,o,n,r,_,a,l,u,h,c,p,d,m,g,f,b,v,w,y){var k,x,E,T;return T=o._,E=_.DBModal,k=l.CarouselRoom,x=function(){function i(i,s,o){var n,r,_,a,l;this.app=i,this.$container=s,this.initial_room_gid=o.initial_room_gid,_=o.show_confirm_claim,l=o.show_invalid_link,a=o.show_email_verification,this.show_add_photos=o.show_add_photos,n=o.liked_own_item,this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),this.show_room=__bind(this.show_room,this),this.post_items_to_current_room=__bind(this.post_items_to_current_room,this),this._show_email_verification=__bind(this._show_email_verification,this),this._show_invalid_link_modal=__bind(this._show_invalid_link_modal,this),this._show_confirm_claim_modal=__bind(this._show_confirm_claim_modal,this),this.initial_room_gid||t.render(new f({lightbox:this.app.lightbox}),e(".shared-space-view-container")[0]),_&&this._show_confirm_claim_modal(),l&&this._show_invalid_link_modal(),a&&this._show_email_verification(),n&&y.error(T("You can’t like your own photos",r="carousel-web"))}return i.prototype.MIN_WIDTH_FOR_THREE_PER_ROW=1365,i.prototype.bind_scroll=function(){var e;return this.shown&&null!=(e=this.shared_space_view)?e.setProps({bind_scroll:!0}):void 0},i.prototype.unbind_scroll=function(){var e;return this.shown&&null!=(e=this.shared_space_view)?e.setProps({bind_scroll:!1}):void 0},i.prototype._show_confirm_claim_modal=function(){var e;return e=new E({element_id:"confirm-claim-modal",title:T("Is this you?",{project:"carousel-web"})}).show(),e.$modal_window.find(".cancel").click(function(){return function(){return e.hide()}}(this)),e.$modal_window.find(".confirm").click(function(){return function(){var e;return e=n.parse(location.href),e.setQuery({force_claim:1}),location.href=e.toString()}}(this))},i.prototype._show_invalid_link_modal=function(){return new E({element_id:"invalid-link-modal",title:T("Invalid Link",{project:"carousel-web"})}).show()},i.prototype._show_email_verification=function(){var e;return e=new u(this.app.email_verified),e.verify_email_or_do(function(){})},i.prototype.post_items_to_current_room=function(e){return this.current_room.post_items(e,this.app.user_avatar_url,this.app.user_initials)},i.prototype.show_room=function(i){var s;return null!=(s=this.current_room)&&s.pause_fetching_data(),this.current_room=i,this.current_room.start_fetching_data(this.app.set_loading),null==this.shared_space_view?this.shared_space_view=t.render(new f({room:this.current_room,lightbox:this.app.lightbox,add_photos:function(e){return function(){return e.app.open_gallery_in_reply_mode()}}(this),send_comment_to_room:function(e){return function(t,i){return t.send_comment(i,e.app.user_avatar_url,e.app.user_initials)}}(this),user_avatar_url:this.app.user_avatar_url,user_avatar_initials:this.app.user_initials,thumb_loading_manager:this.app.thumb_loading_manager,email_verified:this.app.email_verified,bind_scroll:!0,shown:this.shown}),e(".shared-space-view-container")[0]):this.shared_space_view.setProps({room:this.current_room}),this.app.set_shared_item_store(this.current_room.grid_item_store,{lightbox_options:{show_checkmark:!1,show_gallery_actions:!1,show_download_button:!0,show_more_actions_button:!1,show_like:!0,show_editing_toolbar:!1}})},i.prototype.show=function(){var e,t;return!this.shown&&(this.shown=!0,this.$container.show(),null!=(t=this.shared_space_view)&&t.setProps({shown:!0}),this.initial_room_gid&&!this.shown_once&&(this.shown_once=!0,e=new k({room_gid:this.initial_room_gid}),e.start_fetching_data(this.app.set_loading),this.show_room(e)),this.current_room)?this.app.set_shared_item_store(this.current_room.grid_item_store,{lightbox_options:{show_checkmark:!1,show_gallery_actions:!1,show_download_button:!0,show_more_actions_button:!1,show_like:!0,show_editing_toolbar:!1}}):void 0},i.prototype.hide=function(e){var t,i;return t=e.reply_mode,this.shown?(this.shown=!1,null!=(i=this.shared_space_view)&&i.setProps({shown:!1}),this.$container.hide()):void 0},i}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/duplicates_page",["jquery","external/react","modules/core/i18n","modules/clean/ajax","modules/clean/react/button","modules/clean/photos/carousel_app/carousel_item","modules/clean/photos/carousel_app/item_store","modules/clean/photos/carousel_app/react_item","modules/clean/photos/carousel_app/store_event"],function(e,t,i,s,o,n,r,_,a){var l,u,h,c,p;return p=i._,h=o.button,c=t.DOM,u=t.createClass({displayName:"ReactDuplicatePage",getDefaultProps:function(){return{thumb_size:256}},propTypes:{duplicates:t.PropTypes.array,item_store:t.PropTypes.object,thumb_size:t.PropTypes.number,container_width:t.PropTypes.number,has_more:t.PropTypes.bool,on_request_more:t.PropTypes.func},componentDidMount:function(){return e(window).bind("resize",this._on_window_resize),this._on_window_resize()},componentDidUnmount:function(){return e(window).unbind("resize",this._on_window_resize)},componentDidUpdate:function(){return this.props.has_more&&e(document).height()<=e(window).height()?this.props.on_request_more():void 0},_on_window_resize:function(){var t;return t=Math.floor(e(this.getDOMNode()).width()/this.props.thumb_size),this.setProps({container_width:t*this.props.thumb_size})},on_select_item:function(e){return e.is_selected?this.props.item_store.deselect_item(e):this.props.item_store.select_item(e)},render:function(){var e,t,i;return c.div({className:"duplicates-page"},c.div({className:"duplicates",style:{width:this.props.container_width}},function(){var s,o,n,r;for(n=this.props.duplicates,r=[],t=s=0,o=n.length;o>s;t=++s)e=n[t],r.push(c.div({key:"duplicates-row-"+t,className:"event-photos clearfix"},function(){var t,s,o;for(o=[],t=0,s=e.length;s>t;t++)i=e[t],i.image_data=i.thumbnail_url,o.push(new _({key:i.item_gid,item:i,width:i.thumb_width,height:i.thumb_height,on_click_item:this.props.on_click_item,on_select_item:this.on_select_item,is_selectable:!0}));return o}.call(this)));return r}.call(this)))}}),l=function(){function i(t,i){var s;this.app=t,this.$container=i,this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),this.item_store=new r(s=!0),this.$document=e(document),this.$window=e(window),this.no_more_duplicates=!1,this.request_in_flight=!1,this.fetch_duplicates(),this.item_store.on(a.SELECTED_CHANGED,function(e){return function(){var t;return e.shown&&null!=(t=e.duplicates_page)?t.forceUpdate():void 0}}(this)),this.item_store.on(a.ITEMS_DELETED,function(e){return function(t){var i,s,o,n,r,_,a,l,u;for(n=0,_=t.length;_>n;n++)for(o=t[n],l=e.duplicates,r=0,a=l.length;a>r;r++)i=l[r],s=i.indexOf(o),s>=0&&i.splice(s,1);return e.shown&&null!=(u=e.duplicates_page)?u.forceUpdate():void 0}}(this))}return i.prototype.fetch_duplicates=function(){return this.no_more_duplicates||this.request_in_flight?void 0:(this.app.set_loading(!0),this.request_in_flight=!0,s.WebRequest({url:"/app/ajax/get_image_duplicates",data:{cursor:JSON.stringify(this.cursor),similarity_threshold:this.app.constants.similarity_threshold,limit:100},success:function(e){return function(t){return e.app.set_loading(!1),e.request_in_flight=!1,e._on_duplicates_fetched(t)}}(this)}))},i.prototype._on_duplicates_fetched=function(e){var i,s,o,r,_,a,l,h,c,p;for(e=JSON.parse(e),e.more?this.cursor=e.cursor:this.no_more_duplicates=!0,!this.fetched_initial_duplicates&&e.dupe_list.length&&(this.initial_duplicates=!0),this.fetched_initial_duplicates||!e.more||e.dupe_list.length||this.fetch_duplicates(),null==this.duplicates&&(this.duplicates=[]),null==this.sort_key&&(this.sort_key=0),p=e.dupe_list,s=a=0,h=p.length;h>a;s=++a){for(_=p[s],i=[],l=0,c=_.length;c>l;l++)r=_[l],r.event={sort_key:this.sort_key,hero_gids:[]},o=this.item_store.add_item_data(r),i.push(o);i.sort(n.comparator_fn),this.duplicates.push(i),this.sort_key++}return null==this.duplicates_page?this.duplicates_page=t.render(new u({duplicates:this.duplicates,item_store:this.item_store,has_more:e.more,on_request_more:function(e){return function(){return e.fetch_duplicates()}}(this),on_click_item:function(e){return function(t){return e.app.lightbox.open_at_item(t)}}(this)}),this.$container[0]):this.duplicates_page.setProps({duplicates:this.duplicates,has_more:e.more})},i.prototype.bind_scroll=function(){return e(document).bind("scroll",function(e){return function(){return e._on_scroll()}}(this))},i.prototype.unbind_scroll=function(){return e(document).unbind("scroll",function(e){return function(){return e._on_scroll()}}(this))},i.prototype._on_scroll=function(){return this.$document.scrollTop()>Math.max(this.$document.height()-this.$window.height()-500,0)?this.fetch_duplicates():void 0},i.prototype.show=function(){return this.app.set_shared_item_store(this.item_store),this.$container.show(),e(document).scrollTop(0),this.shown=!0},i.prototype.hide=function(){return this.$container.hide(),this.app.lightbox.close(),this.shown=!1},i}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function i(){this.constructor=e}for(var s in t)__hasProp.call(t,s)&&(e[s]=t[s]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};define("modules/clean/photos/carousel_app/email_verification",["jquery","modules/core/i18n","modules/clean/ajax","modules/clean/dbmodal","modules/clean/viewer"],function(e,t,i,s,o){var n,r,_,a;return a=t._,n=s.DBModal,r=function(){function e(e,t){this.email_verified=e,this.verification_state_unknown=t,this._verify_email=__bind(this._verify_email,this),this._async_is_email_verified=__bind(this._async_is_email_verified,this),this.send_verification_email=__bind(this.send_verification_email,this),this.verify_email_or_do=__bind(this.verify_email_or_do,this),this.email_verification_sent=!1,this.modal=new _(this)}return e.REASON_CAROUSEL="carousel",e.prototype.verify_email_or_do=function(e){var t,i;return!this.email_verified||this.verification_state_unknown?this.email_verification_sent||this.verification_state_unknown?this._async_is_email_verified(i=e,t=this._verify_email):this._verify_email():void e()},e.prototype.send_verification_email=function(){return i.WebRequest({url:"/sendverifyemail",data:{reason:e.REASON_CAROUSEL,email:o.get_viewer().photos_user.email},subject_user:o.get_viewer().photos_user}),this.email_verification_sent=!0},e.prototype._async_is_email_verified=function(e,t){return i.WebRequest({url:"/isemailverified",data:{email:o.get_viewer().photos_user.email},subject_user:o.get_viewer().photos_user,success:function(i){return function(s){return"ok"===s?(i.email_verified=!0,"function"==typeof e&&e()):"function"==typeof t&&t(),i.verification_state_unknown=!1}}(this)})},e.prototype._verify_email=function(){return this.email_verification_sent||this.send_verification_email(),this.modal.show()},e}(),_=function(e){function t(e){this.controller=e,this.on_show=__bind(this.on_show,this),t.__super__.constructor.call(this,{element_id:"email-verification-modal",title:a("Verify your email",{project:"carousel-web"})})}return __extends(t,e),t.prototype.on_show=function(){return this.$modal_window.find(".done").click(function(e){return function(){return e.hide()}}(this)),this.$modal_window.find(".resend-email").click(function(e){return function(){return e.controller.send_verification_email(),e.hide()}}(this))},t}(n),r}),define("modules/clean/photos/carousel_app/emoji",["modules/core/exception"],function(e){var t,i;return i=e.assert,t=function(){function e(){}return e._range_to_regex_range=function(e,t){var s,o,n,r,_,a,l,u,h,c,p,d,m,g;for(e=e.toString(),t=t.toString(),i(e.length===t.length),h=e.length,c=function(e,t){var i,s,o,n;for(s="",i=o=n=e+1;h>=n?h>o:o>h;i=h>=n?++o:--o)s+="[0-9]";return t&&(s+="|"),s},p="",o=!1,r=m=0,g=e.length;g>m;r=++m)s=e[r],e.substring(0,r+1)!==t.substring(0,r+1)&&(a=r===h-1,l=parseInt(e[r]),n=parseInt(t[r]),u=a?l:l+1,
d=a?n:n-1,o?((d>=0||a)&&(p+=t.substring(0,r),p+="[0-"+d+"]",p+=c(r,_=!0)),(9>=u||a)&&(p+=e.substring(0,r),p+="["+u+"-9]",p+=c(r,_=!a))):(o=!0,(n-l>=2||a)&&(p+=t.substring(0,r),p+="["+u+"-"+d+"]",p+=c(r,_=!a))));return p},e._dec_surrogates_to_hex_string=function(e,t){var i;return i=1024*(e-55296)+(t-56320)+65536,i.toString(16).toUpperCase()},e.replace_emoji_text_with_spans=function(t){var i,s,o,n,r,_,a;for(o=["&#(55356);&#("+e._range_to_regex_range(57088,57343)+");","&#(55357);&#("+e._range_to_regex_range(56320,56911)+");","&#(55357);&#("+e._range_to_regex_range(56960,57087)+");"],n=new RegExp(o.join("|"),"g");s=n.exec(t);)s=s.filter(function(e){return!!e}),a=s[0],r=s[1],_=s[2],i=e._dec_surrogates_to_hex_string(r,_),t=t.replace(a,"<span class='emoji sprite sprite_emoji s_emoji_"+i+"'/></span>");return t},e}()}),define("modules/clean/photos/carousel_app/event_dispatcher",[],function(){var e;return e=function(){function e(){this.event_callbacks={}}return e.prototype.on=function(e,t){var i;return null==(i=this.event_callbacks)[e]&&(i[e]=[]),this.event_callbacks[e].push(t),this},e.prototype.off=function(e,t){var i,s,o,n,r,_;if(this.event_callbacks[e]){for(r=this.event_callbacks[e],_=[],s=o=0,n=r.length;n>o;s=++o){if(i=r[s],t===i){this.event_callbacks[e].splice(s,1);break}_.push(void 0)}return _}},e.prototype.trigger=function(e,t){var i,s,o,n,r;for(null==(s=this.event_callbacks)[e]&&(s[e]=[]),r=this.event_callbacks[e],o=0,n=r.length;n>o;o++)(i=r[o])(t);return this},e}()});var __indexOf=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/photos/carousel_app/exclude_modal",["external/purify","external/react","modules/core/i18n","modules/core/uri","modules/clean/browse_interface","modules/clean/filepath","modules/clean/viewer","modules/clean/react/button","modules/clean/react/modal","modules/clean/react/select","modules/clean/react/sprite_div","modules/constants/env"],function(e,t,i,s,o,n,r,_,a,l,u,h){var c,p,d,m,g,f,b,v,w;return v=e.sanitize,g=n.filename,b=n.parent_dir,f=_.link_button,d=a.Modal,m=t.DOM,w=i.i18n_default_project("carousel-web")._,p=t.createClass({propTypes:{folders:t.PropTypes.array.isRequired,defaultFolder:t.PropTypes.string.isRequired,changeCallback:t.PropTypes.func.isRequired,unexcludeableRoot:t.PropTypes.string.isRequired},getInitialState:function(){return{selectedFolder:this.props.defaultFolder}},render:function(){var e,t;return m.div({style:{padding:"20px 25px"}},m.p({},w("Would you like to exclude all photos in the Dropbox folder “%(folder_name)s” from Carousel, Dropbox Photos, and albums? These photos will still be safely stored in your Dropbox.").format({folder_name:g(this.props.defaultFolder)})),l.input({ref:"folder_select",defaultValue:this.state.selectedFolder,style:{width:"100%"},"disable-errors":!0,onChange:function(e){return function(t,i){return e.setState({selectedFolder:i}),e.props.changeCallback(i)}}(this)},l.option({disabled:!0,title:w("This folder isn’t excludable"),key:"UNEXCLUDABLE_ROOT/"},m.span({style:{textColor:"#bbb"}},w("Dropbox")+this.props.unexcludeableRoot)),function(){var i,s,o,n;for(o=this.props.folders,n=[],t=i=0,s=o.length;s>i;t=++i)e=o[t],n.push(l.option({value:e,key:e},m.div({style:{paddingLeft:10*t}},u({group:"web",name:"folder_32",text:g(e)}))));return n}.call(this)),m.a({href:String(o.browse_uri_for_fq_path(r.get_viewer().personal_user,this.state.selectedFolder)),style:{marginLeft:10},target:"_blank"},w("Show in folder")))}}),c=function(){function e(){}return e.show=function(e,t,i,o){var n,r,_,a,l;for(r=[],n=b(e.fq_path);__indexOf.call(["/"].concat(i),n)<0;)r.push(n),n=b(n);return a=n,l=r.reverse(),this.selected_folder=l[l.length-1],_=d.showInstance(d({width:530,title:w("Exclude folder from Carousel"),buttonComponent:m.div({className:"db-modal-buttons",style:{background:"#f7f7f7",borderTop:"1px solid #e5e5e5"}},m.p({style:{"float":"left",fontSize:"9pt",color:"#aaaaaa"},dangerouslySetInnerHTML:{__html:v(w("You can add folders that have been excluded in <a href='%(url)s'>settings</a>.").format({url:o?s({scheme:"https",authority:h.WEBSERVER,path:"/account",fragment:"profile"}):"/app/settings"}))}}),f({style:{display:"inline"},onClick:function(e){return function(){return t(e.selected_folder),d.close()}}(this)},w("Exclude")))},p({folders:r,defaultFolder:this.selected_folder,unexcludeableRoot:a,changeCallback:function(e){return function(t){return e.selected_folder=t}}(this)})))},e}()});var __slice=[].slice;define("modules/clean/photos/carousel_app/excluded_folders_modal",["external/react","modules/clean/ajax","modules/clean/browse_interface","modules/clean/css","modules/clean/react/button","modules/clean/react/modal","modules/clean/react/sprite","modules/clean/viewer","modules/core/i18n","modules/core/notify","jquery"],function(e,t,i,s,o,n,r,_,a,l,u){var h,c,p,d,m,g,f,b;return p=t.WebRequest,d=o.button,c=n.Modal,m=e.DOM,b=a.i18n_default_project("carousel-web")._,g=e.createClass({propTypes:{excludedPaths:e.PropTypes.array.isRequired,onUpdate:e.PropTypes.func.isRequired,useDropboxChrome:e.PropTypes.bool.isRequired},getInitialState:function(){return{foldersToReinclude:{}}},stageForReinclusion:function(e,t){return t?this.state.foldersToReinclude[e]=!0:delete this.state.foldersToReinclude[e],this.setState(this.state.foldersToReinclude)},hasStagedChanges:function(){var e;for(e in this.state.foldersToReinclude)return!0;return!1},render:function(){var e,t;return this.props.excludedPaths.sort(function(e,t){return e.fq_path>t.fq_path}),m.div({},m.div({className:"excluded-folders-list"},function(){var i,s,o,n,r;for(o=this.props.excludedPaths,r=[],i=0,s=o.length;s>i;i++)n=o[i],e=n.fq_path,t=n.in_shared_folder,r.push(f({fqPath:e,key:e,isSharedFolder:t,stageForReinclusion:this.stageForReinclusion,useDropboxChrome:this.props.useDropboxChrome}));return r}.call(this)),m.div({className:"clearfix",style:{paddingBottom:5}},this.hasStagedChanges()?m.div({style:{"float":"right"}},[d({key:"update",style:{marginRight:5},onClick:function(e){return function(){var t;return e.props.onUpdate(function(){var e;e=[];for(t in this.state.foldersToReinclude)e.push(t);return e}.call(e)),c.close()}}(this)},b("Update")),d({key:"cancel",importance:"tertiary",onClick:function(e){return function(){return l.error(b(e.props.useDropboxChrome?"No folders were added to your Timeline":"No folders were added to your Carousel")),c.close()}}(this)},b("Cancel"))]):d({style:{"float":"right"},onClick:function(){return c.close()}},b("Close"))))}}),f=e.createClass({propTypes:{fqPath:e.PropTypes.string.isRequired,isSharedFolder:e.PropTypes.bool,stageForReinclusion:e.PropTypes.func.isRequired,useDropboxChrome:e.PropTypes.bool.isRequired},getInitialState:function(){return{excluded:!0,hover:!1}},render:function(){var e,t,s,o,n,a;return e="Dropbox"+this.props.fqPath,a=e.split("/"),s=2<=a.length?__slice.call(a,0,n=a.length-1):(n=0,[]),t=a[n++],o=s.join("/")+"/",m.div({onMouseEnter:function(e){return function(){return e.setState({hover:!0})}}(this),onMouseLeave:function(e){return function(){return e.setState({hover:!1})}}(this),style:{clear:"both",backgroundColor:this.state.hover?"#f5fafe":void 0,padding:"1px 5px",overflowY:"auto"}},r({group:"web",name:this.props.isSharedFolder?"folder_user_32":"folder_32"}),m.div({style:{display:"inline-block",paddingLeft:"10px"}},m.span({style:{fontSize:"10pt"}},t),m.br({}),m.span({style:{fontSize:"10pt",color:"#ccc"}},o)),m.div({style:{"float":"right"}},this.state.hover||!this.state.excluded?m.a({href:String(i.browse_uri_for_fq_path(_.get_viewer().personal_user,this.props.fqPath)),target:"_blank",style:{margin:"0 20px"}},b(this.props.useDropboxChrome?"Show in folder":"Show in Dropbox")):void 0,this.state.excluded?this.state.hover?d({importance:"secondary",style:{marginTop:"5px"},onClick:function(e){return function(){return e.setState({excluded:!1}),e.props.stageForReinclusion(e.props.fqPath,!0)}}(this)},b(this.props.useDropboxChrome?"Add to Timeline":"Add to Carousel")):void 0:d({style:{marginTop:"5px"},onClick:function(e){return function(){return e.setState({excluded:!0}),e.props.stageForReinclusion(e.props.fqPath,!1)}}(this)},b("Added",{comment:"means the folder, which was previously removed from Carousel, has been added back to the user's Carousel"}))))}}),h=function(){function e(){}return e.show=function(e,t,i){var o;return s.require_css("/static/css/carousel/app/excluded_folders_modal-vflaUEgN8.css"),o=i?{marginBottom:-25}:{margin:"25px",marginBottom:"0"},c.showInstance(c({title:b(i?"Folders excluded from your Timeline":"Folders excluded from Carousel"),width:Math.min(u(window).width()-400,900),onDismiss:function(e){return e.preventDefault()},acceptButtonText:null,showX:!1},m.div({style:o},m.p({},b(i?"Photos and videos in these folders have been excluded from your Timeline":"Photos and videos in these folders have been excluded from Carousel")),g({excludedPaths:e,onUpdate:t,useDropboxChrome:i}))))},e}()}),define("modules/clean/photos/carousel_app/face_rec_utils",["jquery","modules/clean/ajax"],function(e,t){var i;return i=function(){function e(){}return e._format_name=function(e){var t;return t=e.split(" "),e=t[0],t.length>1&&(e+=" "+t[t.length-1][0]+"."),e},e.render_face_boxes=function(i,s,o,n,r){var _,a,l,u,h,c,p,d,m,g,f,b,v,w,y,k;if(_=20,f=""===r?-(1/0):parseFloat(r),null!=(y=i.face_detections)?y.length:void 0){for(n.css({width:s,height:o,position:"absolute",top:"0px",left:"0px","z-index":2}),n[0].width=s,n[0].height=o,u=n[0].getContext("2d"),u.strokeStyle="#0bacff",u.lineWidth=4,u.font=_+"px Gotham",m=[],d=[],h=[],k=i.face_detections,p=v=0,w=k.length;w>v;p=++v)c=k[p],g=s*c[0][0],b=o*c[0][1],l=s*c[0][2],a=o*c[0][3],h.push([g,b,l,a]),u.strokeRect(g,b,l,a),m.push(i.item_gid),d.push(p);return t.WebRequest({url:"/photos/ajax/list_identities_by_faces",data:{item_ids:m.join(","),face_indexes:d.join(",")},success:function(){return function(t){var i,s,o,n,r,a,l,c,p,d;for(n=JSON.parse(t),d=[],s=l=0,c=n.length;c>l;s=++l)o=n[s],o&&(p=[o.label,o.score,o.manual],o=p[0],a=p[1],r=p[2],!r&&f>a||(o=e._format_name(o),r||(o=o+" ("+a.toFixed(2)+")"),u.fillStyle="#0bacff",i=h[s],u.fillRect(i[0],i[1],u.measureText(o).width+3,_+5),u.fillStyle="#ffffff",d.push(u.fillText(o,i[0],i[1]+_))));return d}}(this)})}},e}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/flashback_page",["jquery","external/react","modules/core/exception","modules/core/i18n","modules/core/uri","modules/clean/ajax","modules/clean/react/button","modules/clean/react/sprite","modules/clean/photos/carousel_out_of_band_sharing_utils","modules/clean/photos/photos_engagement_logger","modules/clean/photos/survey_response_logger","modules/clean/photos/carousel_app/carousel_item","modules/clean/photos/carousel_app/item_store","modules/clean/photos/carousel_app/react_item","modules/clean/photos/carousel_app/store_event"],function(e,t,i,s,o,n,r,_,a,l,u,h,c,p,d){var m,g,f,b,v,w,y,k,x,E;return E=s._,k=r.button,x=t.DOM,v="multiple-choice",g="free-response",m="done",y=t.createClass({displayName:"SurveyOption",getInitialState:function(){return{clicked:!1}},propTypes:{value:t.PropTypes.string,on_click:t.PropTypes.func},on_click:function(){return l.log_carousel(l.WEBAPP_FLASHBACK_SURVEY_RESPONSE,{value:this.props.value}),this.setState({clicked:!0}),this.props.on_click(this.props.value)},render:function(){return x.div({className:"survey-option "+(this.state.clicked?"selected":""),onClick:this.on_click},x.div({className:"box"}),this.props.children)}}),b=t.createClass({displayName:"FlashbackRow",propTypes:{items:t.PropTypes.array,on_select_item:t.PropTypes.func,on_click_item:t.PropTypes.func,on_share_item_facebook:t.PropTypes.func,on_share_item_twitter:t.PropTypes.func,on_share_item_link:t.PropTypes.func,is_in_selection_mode:t.PropTypes.bool,experiment_share_per_photo:t.PropTypes.bool},renderIndividualShareButton:function(e,i,s,o){var n,r;return r=!this.props.is_in_selection_mode,n=t.addons.classSet({"row-share-button":!0,"row-share-button-visible":r,"row-share-button-hidden":!r}),n+=" "+s,x.div({className:n,onClick:function(){return function(){return r?o(e):void 0}}(this)},_({group:"carousel",name:i}))},renderAllShareButtons:function(){var e,t,s,o;return this.props.experiment_share_per_photo?(s=this.props.items,1!==s.length?(e="Flashback sharing buttons per photo experiment: Should have exactly 1 photo per row, got "+s.length,i.assert(!1,e,null,null,o=!1),null):(t=s[0],x.div({className:"row-share-buttons"},this.renderIndividualShareButton(t,"facebook_colored_background","oob-share-button-facebook",this.props.on_share_item_facebook),this.renderIndividualShareButton(t,"twitter_colored_background","oob-share-button-twitter",this.props.on_share_item_twitter),this.renderIndividualShareButton(t,"link_colored_background","oob-share-button-link",this.props.on_share_item_link)))):null},render:function(){var e;return x.div({className:"flashback-row clearfix"},x.div({className:"row-bullet-label"},function(){var t,i,s,o;for(s=this.props.items,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push(x.div({key:e.item_gid+"time",className:"item-time"},e.time));return o}.call(this)),x.div({className:"row-bullet"}),x.div({className:"items clearfix"},function(){var t,i,s,o;for(s=this.props.items,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push(p({key:e.item_gid,item:e,width:e.thumb_width,height:e.thumb_height,on_click_item:this.props.on_click_item,on_select_item:this.props.on_select_item,is_selectable:!0}));return o}.call(this)),this.renderAllShareButtons())}}),w=t.createClass({displayName:"ReactFlashbackPage",getInitialState:function(){return{survey_state:v}},getDefaultProps:function(){return{sections:[],show_feedback_tab:!0,show_survey:!1,is_mobile:!1}},propTypes:{item_store:t.PropTypes.object,sections:t.PropTypes.array,on_click_item:t.PropTypes.func,on_share_item_facebook:t.PropTypes.func,on_share_item_twitter:t.PropTypes.func,on_share_item_link:t.PropTypes.func,experiment_share_per_photo:t.PropTypes.bool},componentDidUpdate:function(){var t;return e(null!=(t=this.refs["survey-input"])?t.getDOMNode():void 0).focus()},getRowsForSection:function(t){var i,s,n,r,_,a,l,u,h,c,p,d,m;for(l=[],s=[],l.push(s),i=this.props.is_mobile?e(window).width()-50:800,a=1,r=p=0,d=t.length;d>p;r=++p)_=t[r],h=o.parse(_.original_thumbnail_url),1===a?null!=_.dimensions?(m=_.dimensions,c=m[0],n=m[1],h.updateQuery({size_mode:2}),_.image_data=String(n>c?h.updateQuery({size:"1280x960"}):h.updateQuery({size:"800x600"})),_.thumb_width=i,_.thumb_height=i*n/c):(_.thumb_width=i,_.thumb_height=i,_.image_data=String(h.updateQuery({size:"800x800"}))):(u=this.props.is_mobile?i/2:390,_.image_data=String(h.updateQuery({size:"512x512"})),_.thumb_width=u,_.thumb_height=u),s.push(_),s.length===a&&(a=this.props.experiment_share_per_photo?1:1===a?2:1,r===t.length-2&&(a=1),r<t.length-1&&(s=[],l.push(s)));return l},on_select_item:function(e){return e.is_selected?this.props.item_store.deselect_item(e):(this.props.item_store.select_item(e),l.log_carousel(l.WEBAPP_FLASHBACK_SELECT_ITEM))},select_all_fn:function(e){return function(t){return function(){var i,s,o,n,r,_,a,u;if(e.items.filter(function(e){return e.is_selected}).length===e.items.length){for(_=e.items,u=[],s=0,n=_.length;n>s;s++)i=_[s],u.push(t.props.item_store.deselect_item(i));return u}for(a=e.items,o=0,r=a.length;r>o;o++)i=a[o],t.props.item_store.select_item(i);return l.log_carousel(l.WEBAPP_FLASHBACK_SELECT_EVENT)}}(this)},move_to_next_survey_phase:function(e,t){return this.survey_value=t,setTimeout(function(t){return function(){return t.setState({survey_state:e})}}(this),500)},submit_free_response:function(){var t,i;return t=e(null!=(i=this.refs["survey-input"])?i.getDOMNode():void 0),t.val()?(l.log_carousel(l.WEBAPP_FLASHBACK_SURVEY_FREE_RESPONSE,{value:this.survey_value}),u.log(u.FLASHBACK_SURVEY_FREE_RESPONSE,{value:this.survey_value,response:t.val()}),this.setState({survey_state:m})):void 0},render_empty_state:function(){return x.div({className:"empty-state"},x.div({className:"empty-wrapper"},x.div({className:"empty-content"},x.img({src:"/static/images/carousel/carousel_app/image-pile-vflh-T-0z.png"}),x.div({className:"empty-content-header"},E("No Flashback this week",{project:"carousel-web"})),x.p({className:"empty-content-message"},E("Add more photos to Dropbox from your phone, tablet, or computer so we can show you more Flashbacks in the future.",{project:"carousel-web"})))))},render_survey:function(){return this.state.survey_state===v?x.div({className:"flashback-survey"},x.div({className:"survey-prompt"},E("What did you think of this week’s Flashback?")),x.div({className:"survey-options",ref:"survey-options"},y({value:"love",on_click:function(e){return function(){return e.move_to_next_survey_phase(m)}}(this)},E("I love these photos",{project:"carousel-web"})),y({value:"meh",on_click:function(e){return function(t){return e.move_to_next_survey_phase(g,t)}}(this)},E("These photos are OK",{project:"carousel-web"})),y({value:"bad",on_click:function(e){return function(t){return e.move_to_next_survey_phase(g,t)}}(this)},E("These are not photos that I want to see",{project:"carousel-web"})))):this.state.survey_state===g?x.div({className:"flashback-survey",style:{"text-align":"center"}},x.div({className:"survey-prompt"},E("What would make this Flashback better?",{project:"carousel-web"})),x.input({className:"survey-input",ref:"survey-input"}),k({onClick:this.submit_free_response},E("Submit",{project:"carousel-web"}))):this.state.survey_state===m?x.div({className:"flashback-survey"},x.div({className:"survey-prompt"},E("Thanks for your feedback!",{project:"carousel-web"}))):x.div()},render:function(){var e,t,i;return 0===this.props.sections.length?this.render_empty_state():x.div({className:"wrapper"},x.div({className:"flashback-page-content"},function(){var s,o,n,r;for(n=this.props.sections,r=[],s=0,o=n.length;o>s;s++)i=n[s],r.push(x.div({key:i.title,className:"flashback-section"},x.div({className:"timeline-bullet"}),x.div({className:"title"},i.title),x.div({className:"subtitle"},E("Highlights from this week in %(year)s",{project:"carousel-web"}).format({year:new Date(i.items[0].time_ms).getFullYear()})),x.div({className:"event-header"},i.items[0].date,i.location?" - "+i.location:void 0),k({className:"select-all-button",onClick:this.select_all_fn(i)},i.items.filter(function(e){return e.is_selected}).length===i.items.length?E("Deselect",{project:"carousel-web"}):E("Select",{project:"carousel-web"})),x.div({className:"section-photos clearfix"},function(){var s,o,n,r;for(n=this.getRowsForSection(i.items),r=[],e=s=0,o=n.length;o>s;e=++s)t=n[e],r.push(b({key:i.title+e,items:t,on_select_item:this.on_select_item,on_click_item:this.props.on_click_item,on_share_item_facebook:this.props.on_share_item_facebook,on_share_item_twitter:this.props.on_share_item_twitter,on_share_item_link:this.props.on_share_item_link,is_in_selection_mode:this.props.item_store.selected_items.length>0,experiment_share_per_photo:this.props.experiment_share_per_photo}));return r}.call(this))));return r}.call(this)),this.props.show_feedback_tab?x.a({id:"feedback-tab",target:"_blank",href:"/photos/carousel_help/submit"},E("FEEDBACK",{project:"carousel-web"})):void 0,this.props.show_survey?this.render_survey():void 0)}}),f=function(){function i(e,t,i,s,o,r,_){var a;this.app=e,this.$container=t,this.flashback_id=null!=i?i:void 0,this.show_feedback_tab=null!=s?s:!0,this.show_survey=null!=o?o:!1,this.out_of_band_share_utils=r,this.experiment_share_per_photo=null!=_?_:!1,this._share_item_link=__bind(this._share_item_link,this),this._share_item_facebook=__bind(this._share_item_facebook,this),this._share_item_twitter=__bind(this._share_item_twitter,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),this.loading=!0,this.item_store=new c(a=!0),this.item_store.on(d.SELECTED_CHANGED,function(e){return function(){var t;return e.shown&&null!=(t=e.flashback_page)?t.forceUpdate():void 0}}(this)),this.item_store.on(d.ITEMS_DELETED,function(e){return function(){var t;return e.shown&&null!=(t=e.flashback_page)?t.forceUpdate():void 0}}(this)),n.WebRequest({url:"/app/ajax/get_flashback_photos",data:{flashback_id:this.flashback_id},success:function(e){return function(t){var i,s,o,n,r,_,a,l,u,c,p;for(i=JSON.parse(t),e.flashback_id=i.flashback_id,e.sections=i.sections,c=e.sections,s=_=0,l=c.length;l>_;s=++_){for(r=c[s],r.items=[],p=r.item_data,a=0,u=p.length;u>a;a++)n=p[a],n.event={sort_key:s,hero_gids:[]},o=e.item_store.add_item_data_if_viewable(n),r.items.push(o),null!=o.location&&null==r.location&&(r.location=o.location);r.items.sort(h.comparator_fn)}return e.loading=!1,e.shown?(e.app.set_loading(!1),e.show()):void 0}}(this)})}return i.prototype.bind_scroll=function(){},i.prototype.unbind_scroll=function(){},i.prototype.show=function(){return this.app.set_loading(this.loading),this.app.set_shared_item_store(this.item_store,{lightbox_options:{show_more_actions_button:!1},share_cart_options:{show_more_actions_button:!1}}),null!=this.sections&&(this.flashback_page=t.render(new w({item_store:this.item_store,sections:this.sections,is_mobile:this.app.is_mobile,on_click_item:function(e){return function(t){var i;return null!=(i=e.app.lightbox)?i.open_at_item(t):void 0}}(this),on_share_item_facebook:this._share_item_facebook,on_share_item_twitter:this._share_item_twitter,on_share_item_link:this._share_item_link,show_feedback_tab:this.show_feedback_tab,show_survey:this.show_survey,experiment_share_per_photo:this.experiment_share_per_photo}),this.$container[0])),this.flashback_id&&n.WebRequest({url:"/app/ajax/mark_flashback_as_seen",data:{flashback_id:this.flashback_id}}),this.$container.show(),e(document).scrollTop(0),this.shown=!0},i.prototype.hide=function(){var e;return this.$container.hide(),null!=(e=this.app.lightbox)&&e.close(),t.unmountComponentAtNode(this.$container[0]),this.shown=!1},i.prototype._share_item_twitter=function(e){return this.out_of_band_share_utils.share_items_twitter([e]),l.log_carousel(l.WEBAPP_FLASHBACK_SHARE_SINGLE_ITEM_TWITTER)},i.prototype._share_item_facebook=function(e){return this.out_of_band_share_utils.share_items_facebook([e]),l.log_carousel(l.WEBAPP_FLASHBACK_SHARE_SINGLE_ITEM_FACEBOOK)},i.prototype._share_item_link=function(e){return this.out_of_band_share_utils.share_items_link([e]),l.log_carousel(l.WEBAPP_FLASHBACK_SHARE_SINGLE_ITEM_LINK)},i}()}),define("modules/clean/photos/carousel_app/gallery_context_menu",["jquery","external/react","modules/core/i18n","modules/clean/gandalf_util","modules/clean/react/context_menu","modules/clean/react/sprite","modules/clean/photos/carousel_app/item_actions"],function(e,t,i,s,o,n,r){var _,a,l,u,h,c,p,d;return _=o.ContextMenu,a=o.ContextMenuItem,c=t.DOM,d=i.i18n_default_project("carousel-web"),p=d._,h=d.N_,l=d.E_,u=t.createFactory(t.createClass({displayName:"GalleryContextMenu",getDefaultProps:function(){return{top:-1e3,left:-1e3,albums_allowed:!1,position_static:!1,shown:!1,logging_extras:{}}},propTypes:{top:t.PropTypes.number,left:t.PropTypes.number,item:t.PropTypes.object,albums_allowed:t.PropTypes.bool,position_static:t.PropTypes.bool,shown:t.PropTypes.bool,page:t.PropTypes.oneOf(["timeline","album","flashback","shared_album","duplicates"]),logging_extras:t.PropTypes.object,on_hide_context_menu:t.PropTypes.func},componentDidUpdate:function(t){return t.shown&&!this.props.shown?(e(document).unbind("contextmenu",this._hide_context_menu),e(document).unbind("click",this._hide_context_menu)):!t.shown&&this.props.shown?(e(document).bind("contextmenu",this._hide_context_menu),e(document).bind("click",this._hide_context_menu)):void 0},_hide_context_menu:function(e){var t;return 3!==e.which&&"function"==typeof(t=this.props).on_hide_context_menu?t.on_hide_context_menu():void 0},render:function(){var e,t,i,o,n,l;return this.props.item?(t=this.props.item.is_selected?this.props.item.item_store.selected_items:[this.props.item],i=t.length,l=r.get_num_photos_and_videos(t),o=l[0],n=l[1],e=s.getGandalfRule("carousel-image-editing"),_({className:"carousel-action-menu",shown:this.props.shown,position_static:this.props.position_static,top:this.props.top,left:this.props.left,ref:"context-menu"},this.props.albums_allowed?a({onClick:function(e){return function(){return r.add_to_album(e.props.item,e.props.logging_extras)}}(this),sprite_group:"web",sprite_name:"album_16"},r.get_add_to_album_text(o,n)):void 0,"album"===this.props.page?a({onClick:function(e){return function(){return r.remove_from_album(e.props.item,e.props.logging_extras)}}(this),sprite_group:"web",sprite_name:"album_delete_16"},r.get_remove_from_album_text(o,n)):void 0,a({onClick:function(e){return function(){return r.download(e.props.item,e.props.logging_extras)}}(this),sprite_group:"web",sprite_name:"download_arrow"},r.get_download_text(o,n)),1===i?a({onClick:function(e){return function(){return r.show_in_folder(e.props.item,e.props.logging_extras)}}(this),sprite_group:"web",sprite_name:"folder"},p("Show in folder")):void 0,1===i?a({onClick:function(e){return function(){return r.exclude_from_carousel_modal(e.props.item)}}(this),sprite_group:"web",sprite_name:"delete"},p("Exclude from Timeline...")):void 0,"timeline"===this.props.page||"duplicates"===this.props.page?a({onClick:function(e){return function(){return r["delete"](e.props.item,e.props.logging_extras)}}(this),sprite_group:"web",sprite_name:"trash-can"},r.get_delete_text(o,n)):void 0)):c.div()}}))}),define("modules/clean/photos/carousel_app/item_actions",["jquery","modules/core/i18n","modules/core/notify","modules/clean/ajax","modules/clean/escape","modules/clean/filepath","modules/clean/react/modal","modules/clean/photos/carousel_app/add_to_album_modal","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/carousel_app/exclude_modal","modules/clean/photos/carousel_app/image_edit","modules/clean/photos/carousel_app/store_event","modules/clean/photos/photos_engagement_logger","modules/clean/viewer"],function(e,t,i,s,o,n,r,_,a,l,u,h,c,p){var d,m,g,f,b,v,w;return w=t._,v=t.ungettext,g=o.escape_to_entity,f=n.filename,b=n.parent_dir,m=r.SimpleModal,d=function(){function t(){}return t.get_num_photos_and_videos=function(e){var t,i,s,o,n;for(i=0,s=0,o=0,n=e.length;n>o;o++)t=e[o],t.is_video?s++:i++;return[i,s]},t.get_share_text=function(e,t){var i,s;return e||t?0===t?i=v("Share %(num)s photo","Share %(num)s photos",e,{project:"carousel-web"}).format({num:e}):0===e?i=v("Share %(num)s video","Share %(num)s videos",t,{project:"carousel-web"}).format({num:t}):(s=e+t,i=w("Share %(num)s items",{project:"carousel-web"}).format({num:s})):w("Share",{project:"carousel-web"})},t.get_download_text=function(e,t){var i,s;return 0===t?i=v("Download","Download %(num)s photos",e,{project:"carousel-web"}).format({num:e}):0===e?i=v("Download","Download %(num)s videos",t,{project:"carousel-web"}).format({num:t}):(s=e+t,i=w("Download %(num)s items",{project:"carousel-web"}).format({num:s}))},t.get_delete_text=function(e,t){var i,s;return 0===t?i=v("Delete","Delete %(num)s photos",e,{project:"carousel-web"}).format({num:e}):0===e?i=v("Delete","Delete %(num)s videos",t,{project:"carousel-web"}).format({num:t}):(s=e+t,i=w("Delete %(num)s items",{project:"carousel-web"}).format({num:s}))},t.get_add_to_album_text=function(e,t){var i;return i=e+t,v("Add to album","Add %(num)s to album",i,{project:"carousel-web"}).format({num:i})},t.get_remove_from_album_text=function(e,t){var i;return i=e+t,v("Remove from album","Remove %(num)s from album",i,{project:"carousel-web"}).format({num:i})},t._get_item_list_from_item=function(e){return e.is_selected?function(){var t,i,s,o;for(s=e.item_store.selected_items,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push(e);return o}():[e]},t._extended_extras=function(t,i){return null==i&&(i={}),e.extend({},i,{num_items:t.length,is_selected:t[0].is_selected})},t._rotate=function(e,i){return t._rotate_call_server(e,i),e.image_data=u.rotate_image(e.image_data,i),null==e.rotation_angle&&(e.rotation_angle=0),e.rotation_angle+=i,e.rotation_angle%=360,a().dispatcher.trigger(h.GLOBAL_ITEM_EDITED,e)},t._rotate_call_server=function(e,o){var n;if(null!=e&&(null==e.outstanding_rotation_angle&&(e.outstanding_rotation_angle=0),e.outstanding_rotation_angle=(e.outstanding_rotation_angle+o)%360,!e.rotation_pending&&0!==e.outstanding_rotation_angle))return n=[],n.push({op:"rotate",angle:e.outstanding_rotation_angle}),e.outstanding_rotation_angle=0,e.rotation_pending=!0,s.WebRequest({url:"/app/ajax/apply_photo_edits",data:{item_id:e.item_gid,revision:e.revision,ops:JSON.stringify(n)},success:function(i){return e.rotation_pending=!1,i=JSON.parse(i),e.revision=i.new_rev,t._rotate_call_server(e,0)},error:function(){return i.error(w("Image Editing failed on server, either because file was modified elsewhere or operation failed, reloading the window to have up to date version of file")),setTimeout(window.location.reload.bind(window.location),3e3)}})},t.rotate_cw=function(e){return t._rotate(e,90)},t.rotate_counter_cw=function(e){return t._rotate(e,270)},t.add_to_album=function(e,i){var s;return s=t._get_item_list_from_item(e),_.show(s),c.log_carousel(c.WEBAPP_ACTION_ADD_TO_ALBUM,t._extended_extras(s,i))},t.remove_from_album=function(e,t){var i,s,o,n,r,_,l,u;return o=this._get_item_list_from_item(e),u=this.get_num_photos_and_videos(o),n=u[0],r=u[1],i=a().current_album,0===r?(_=v("Remove %(num)s photo","Remove %(num)s photos",n,{project:"carousel-web"}).format({num:n}),s=v("Are you sure you want to remove this photo from <strong>%(album_name)s</strong>?","Are you sure you want to remove %(num)s photos from <strong>%(album_name)s</strong>?",n,{project:"carousel-web"}).format({num:n,album_name:g(i.name)})):0===n?(_=v("Remove %(num)s video","Remove %(num)s videos",r,{project:"carousel-web"}).format({num:r}),s=v("Are you sure you want to remove this video from <strong>%(album_name)s</strong>?","Are you sure you want to remove %(num)s videos from <strong>%(album_name)s</strong>?",r,{project:"carousel-web"}).format({num:r,album_name:g(i.name)})):(l=n+r,_=w("Remove %(num)s photos and videos",{project:"carousel-web"}).format({num:l}),s=w("Are you sure you want to remove %(num)s photos and videos from <strong>%(album_name)s</strong>?",{project:"carousel-web"}).format({num:l,album_name:g(i.name)})),m.show({title_text:_,body_html:s,confirm_text:w("Remove",{project:"carousel-web"}),cancel_text:w("Cancel",{project:"carousel-web"}),cancel_callback:function(e){return function(){return c.log_carousel(c.WEBAPP_GALLERY_REMOVE_FROM_ALBUM_MODAL_CANCELED,e._extended_extras(o,t))}}(this),confirm_callback:function(s){return function(){return e.is_selected&&i.item_store.deselect_all(),i.remove_items(o),c.log_carousel(c.WEBAPP_GALLERY_REMOVE_FROM_ALBUM_MODAL_CONFIRMED,s._extended_extras(o,t))}}(this)}),c.log_carousel(c.WEBAPP_ACTION_REMOVE_FROM_ALBUM,this._extended_extras(o,t))},t.download=function(e,i){var s,o;return o=t._get_item_list_from_item(e),s=e.item_store,1===o.length?(window.open(e.download_url,"_self"),e.is_selected&&s.deselect_all()):s.download_selected_items(),c.log_carousel(c.WEBAPP_ACTION_DOWNLOAD,t._extended_extras(o,i))},t.show_in_folder=function(e,t){return window.open(e.folder_url,"_blank"),c.log_carousel(c.WEBAPP_ACTION_SHOW_IN_FOLDER,this._extended_extras([e],t))},t.exclude_from_carousel_modal=function(e){var s,o,n,r;return r=b(e.fq_path),o=a().constants.carousel_folder_path,n=a().constants.cu_folder_path,s=function(e,t){return r===e?(i.error(w("The ‘%(folder_name)s’ folder can’t be excluded from Carousel",{project:"carousel-web"}).format({folder_name:f(e)})),c.log_carousel(t),!0):!1},s("/",c.ATTEMPT_EXCLUDE_DROPBOX_ROOT)||s(o,c.ATTEMPT_EXCLUDE_CAROUSEL_FOLDER)||s(n,c.ATTEMPT_EXCLUDE_CU_FOLDER)?void 0:0===r.indexOf(o+"/")?(i.error(w("The ‘%(folder_name)s’ folder and any of it’s subfolders can’t be excluded from Carousel.",{project:"carousel-web"}).format({folder_name:f(o)})),void c.log_carousel(c.ATTEMPT_EXCLUDE_CAROUSEL_SUBFOLDER)):(l.show(e,t.exclude_folder,[n],a().constants.use_dropbox_chrome),
c.log_carousel(c.WEBAPP_SHOW_EXCLUDE_MODAL))},t.exclude_folder=function(e){return i.success(w("This folder is now excluded from your timeline. It may take several minutes for this change to be reflected in our mobile apps.",{project:"carousel-web"})),s.WebRequest({url:"/app/ajax/exclude_folder",data:{fq_path:e},subject_user:p.get_viewer().personal_user,error:function(){return i.error(w("Something went wrong - the selected folder wasn’t excluded",{project:"carousel-web"})),setTimeout(window.location.reload.bind(window.location),3e3)}}),a().dispatcher.trigger(h.GLOBAL_FOLDERS_EXCLUDED,[e])},t["delete"]=function(e,i){var s,o,n,r,_,a,l,u;return n=t._get_item_list_from_item(e),o=e.item_store,u=t.get_num_photos_and_videos(n),r=u[0],_=u[1],0===_?(a=v("Delete %(num)s photo","Delete %(num)s photos",r,{project:"carousel-web",comment:"title of the delete confirmation modal"}).format({num:r}),s=v("Are you sure you want to delete this photo? This will delete it from Carousel and Dropbox.","Are you sure you want to delete %(num)s photos? This will delete them from Carousel and Dropbox.",r,{project:"carousel-web"}).format({num:r})):0===r?(a=v("Delete %(num)s video","Delete %(num)s videos",_,{project:"carousel-web"}).format({num:_}),s=v("Are you sure you want to delete this video? This will delete it from Carousel and Dropbox.","Are you sure you want to delete %(num)s videos? This will delete them from Carousel and Dropbox.",_,{project:"carousel-web"}).format({num:_})):(l=r+_,a=w("Delete %(num)s photos and videos",{project:"carousel-web"}).format({num:l}),s=w("Are you sure you want to delete %(num)s photos and videos? This will delete them from Carousel and Dropbox.",{project:"carousel-web"}).format({num:l})),m.show({title_text:a,body_html:s,confirm_text:w("Delete",{project:"carousel-web",comment:"This text is the text on the confirm button of a modal that asks if you are sure you want to delete the selected photos"}),cancel_text:w("Cancel",{project:"carousel-web"}),cancel_callback:function(){return c.log_carousel(c.WEBAPP_GALLERY_DELETE_MODAL_CANCELED,t._extended_extras(n,i))},confirm_callback:function(){return e.is_selected?o.delete_selected_items():o.delete_item(e),c.log_carousel(c.WEBAPP_GALLERY_DELETE_MODAL_CONFIRMED,t._extended_extras(n,i))}}),c.log_carousel(c.WEBAPP_ACTION_DELETE,t._extended_extras(n,i))},t}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function i(){this.constructor=e}for(var s in t)__hasProp.call(t,s)&&(e[s]=t[s]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};define("modules/clean/photos/carousel_app/item_store",["modules/clean/ajax","modules/clean/binary_search","modules/clean/viewer","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/carousel_app/event_dispatcher","modules/clean/photos/carousel_app/carousel_item","modules/clean/photos/carousel_app/store_event","modules/core/browser"],function(e,t,i,s,o,n,r,_){var a;return a=function(o){function a(e,t){var i;null==e&&(e=!1),null==t&&(t=!1),this._remove_item=__bind(this._remove_item,this),this._insert_item_in_order=__bind(this._insert_item_in_order,this),this._delete_items=__bind(this._delete_items,this),this.delete_selected_items=__bind(this.delete_selected_items,this),this.download_selected_items=__bind(this.download_selected_items,this),this.delete_item=__bind(this.delete_item,this),this.remove_items=__bind(this.remove_items,this),this.exclude_paths=__bind(this.exclude_paths,this),this.is_path_excluded=__bind(this.is_path_excluded,this),this._trigger_items_deleted=__bind(this._trigger_items_deleted,this),this._trigger_items_added=__bind(this._trigger_items_added,this),this._trigger_selected_items_changed=__bind(this._trigger_selected_items_changed,this),this._deselect_item=__bind(this._deselect_item,this),this._select_item=__bind(this._select_item,this),this.deselect_item_gids=__bind(this.deselect_item_gids,this),this.deselect_item_gid=__bind(this.deselect_item_gid,this),this.deselect_items=__bind(this.deselect_items,this),this.deselect_item=__bind(this.deselect_item,this),this.deselect_all=__bind(this.deselect_all,this),this.select_item_gids=__bind(this.select_item_gids,this),this.select_item_gid=__bind(this.select_item_gid,this),this.select_all=__bind(this.select_all,this),this.select_items=__bind(this.select_items,this),this.select_item=__bind(this.select_item,this),this.get_num_photos_and_videos_selected=__bind(this.get_num_photos_and_videos_selected,this),this.is_item_gid_selected=__bind(this.is_item_gid_selected,this),this.add_item_if_viewable=__bind(this.add_item_if_viewable,this),this.add_item_data_if_viewable=__bind(this.add_item_data_if_viewable,this),this.add_item=__bind(this.add_item,this),this.add_item_data=__bind(this.add_item_data,this),this.get_item_by_gid=__bind(this.get_item_by_gid,this),this.item_edited=__bind(this.item_edited,this),a.__super__.constructor.apply(this,arguments),this.comparator_fn=function(i,s){if(e&&i.event&&s.event){if(i.event.sort_key<s.event.sort_key)return-1;if(i.event.sort_key>s.event.sort_key)return 1}if(t){if(i.sort_key>s.sort_key)return-1;if(i.sort_key<s.sort_key)return 1}else{if(i.sort_key<s.sort_key)return-1;if(i.sort_key>s.sort_key)return 1}return 0},this._item_gid_to_item={},this.all_items=[],this.selected_items=[],this.excluded_paths=(null!=(i=s().constants)?i.initial_excluded_paths:void 0)||[],s().dispatcher.on(r.GLOBAL_ITEMS_DELETED,this.remove_items),s().dispatcher.on(r.GLOBAL_FOLDERS_EXCLUDED,this.exclude_paths),s().dispatcher.on(r.GLOBAL_ITEM_EDITED,this.item_edited)}return __extends(a,o),a.copy=function(e){return new n(e)},a.prototype.item_edited=function(e){var t;return t=this._item_gid_to_item[e.item_gid],t?(t.image_data=e.image_data,t.lightbox_url=e.lightbox_url,this.trigger(r.ITEMS_CHANGED,[e])):void 0},a.prototype.get_item_by_gid=function(e){return this._item_gid_to_item[e]},a.prototype.add_item_data=function(e,t){var i;return i=new n(e),this.add_item(i,t)},a.prototype.add_item=function(e,t){var i,s;return this.get_item_by_gid(e.item_gid)?this.get_item_by_gid(e.item_gid):(s=this._insert_item_in_order(this.all_items,e,i=!0),s&&(this._item_gid_to_item[e.item_gid]=e,t||this._trigger_items_added([e])),e.item_store=this,e)},a.prototype.add_item_data_if_viewable=function(e,t){return this.add_item_if_viewable(new n(e),t)},a.prototype.add_item_if_viewable=function(e,t){return e.hidden||this.is_path_excluded(e.fq_path)?null:this.add_item(e,t)},a.prototype.is_item_gid_selected=function(e){var t;return t=this.get_item_by_gid(e),t.is_selected},a.prototype.get_num_photos_and_videos_selected=function(){var e,t,i,s,o,n;for(t=0,i=0,n=this.selected_items,s=0,o=n.length;o>s;s++)e=n[s],e.is_video?i++:t++;return[t,i]},a.prototype.select_item=function(e,t){return null==t&&(t=!1),this._select_item(e)&&!t?this._trigger_selected_items_changed([e]):void 0},a.prototype.select_items=function(e,t){var i,s,o,n;for(null==t&&(t=!1),i=[],o=0,n=e.length;n>o;o++)s=e[o],this._select_item(s)&&i.push(s);return i.length&&!t?this._trigger_selected_items_changed(i):void 0},a.prototype.select_all=function(){return this.select_items(this.all_items)},a.prototype.select_item_gid=function(e){var t;return t=this.get_item_by_gid(e),this.select_item(t)},a.prototype.select_item_gids=function(e){var t,i,s,o,n,r;for(t=!1,o=[],n=0,r=e.length;r>n;n++)s=e[n],i=this.get_item_by_gid(s),this._select_item(i)&&(t=!0,o.push(i));return t?this._trigger_selected_items_changed(o):void 0},a.prototype.deselect_all=function(){var e,t,i,s,o,n;if(t=[],this.selected_items.length){for(o=this.selected_items,i=0,s=o.length;s>i;i++)e=o[i],t.push(e),e.is_selected=!1,null!=(n=e.event)&&n.num_selected--;return this.selected_items.splice(0,this.selected_items.length),this._trigger_selected_items_changed(t)}},a.prototype.deselect_item=function(e,t){return null==t&&(t=!1),this._deselect_item(e)&&!t?this._trigger_selected_items_changed([e]):void 0},a.prototype.deselect_items=function(e,t){var i,s,o,n;for(null==t&&(t=!1),i=[],o=0,n=e.length;n>o;o++)s=e[o],this._deselect_item(s)&&i.push(s);return i.length&&!t?this._trigger_selected_items_changed(i):void 0},a.prototype.deselect_item_gid=function(e){var t;return t=this.get_item_by_gid(e),this.deselect_item(t)},a.prototype.deselect_item_gids=function(e){var t,i,s,o,n,r;for(t=!1,o=[],n=0,r=e.length;r>n;n++)s=e[n],i=this.get_item_by_gid(s),this._deselect_item(i)&&(t=!0,o.push(i));return t?this._trigger_selected_items_changed(o):void 0},a.prototype._select_item=function(e){var t;return this._insert_item_in_order(this.selected_items,e)?(e.is_selected=!0,null!=(t=e.event)&&t.num_selected++,!0):!1},a.prototype._deselect_item=function(e){var t;return this._remove_item(this.selected_items,e)?(e.is_selected=!1,null!=(t=e.event)&&t.num_selected--,!0):!1},a.prototype._trigger_selected_items_changed=function(e){return this.trigger(r.SELECTED_CHANGED,e)},a.prototype._trigger_items_added=function(e){return this.trigger(r.ITEMS_ADDED,e)},a.prototype._trigger_items_deleted=function(e){return this.trigger(r.ITEMS_DELETED,e)},a.prototype.is_path_excluded=function(e){var t,i,s,o;for(o=this.excluded_paths,i=0,s=o.length;s>i;i++)if(t=o[i],0===e.indexOf(t+"/"))return!0;return!1},a.prototype.exclude_paths=function(e){var t,i,s,o,n;for(this.excluded_paths=this.excluded_paths.concat(e),i=[],n=this.all_items,s=0,o=n.length;o>s;s++)t=n[s],this.is_path_excluded(t.fq_path)&&i.push(t);return this.remove_items(i)},a.prototype.remove_items=function(e){var t,i,s,o,n;for(t=[],o=0,n=e.length;n>o;o++)i=e[o],null!=this._item_gid_to_item[i.item_gid]&&(this._remove_item(this.all_items,i,s=!0),this._remove_item(this.selected_items,i,s=!0),delete this._item_gid_to_item[i.item_gid],t.push(i));return this.trigger(r.SELECTED_CHANGED,t),this.trigger(r.ITEMS_DELETED,t)},a.prototype.delete_item=function(e){return this._delete_items([e])},a.prototype.download_selected_items=function(){var t,i;return i=function(){var e,i,s,o;for(s=this.selected_items,o=[],e=0,i=s.length;i>e;e++)t=s[e],o.push(t.item_gid);return o}.call(this),e.WebRequest({url:"/app/ajax/get_batch_download_link",data:{item_ids:JSON.stringify(i)},success:function(e){return function(t){var i;return i=JSON.parse(t).link,_.unsafeRedirect(i),e.deselect_all()}}(this)})},a.prototype.delete_selected_items=function(){return this._delete_items(this.selected_items)},a.prototype._delete_items=function(t){var o,n,_;return _=function(){var e,i,s;for(s=[],e=0,i=t.length;i>e;e++)n=t[e],s.push(n);return s}(),o=function(){var e,t,i;for(i=[],e=0,t=_.length;t>e;e++)n=_[e],i.push(n.fq_path);return i}(),e.WebRequest({url:"/cmd/delete",data:{files:o},subject_user:i.get_viewer().photos_user,error:function(e){return function(){var t,i,s;for(i=0,s=_.length;s>i;i++)n=_[i],e.add_item(n,t=!0);return e._trigger_items_added(_)}}(this)}),s().dispatcher.trigger(r.GLOBAL_ITEMS_DELETED,_)},a.prototype._insert_item_in_order=function(e,i,s){var o,n,r,_,a;return null==s&&(s=!1),i?(a=t(e,function(e){return function(t){return e.comparator_fn(t,i)}}(this)),o=a[0],n=a[1],o?!1:(s&&(_=e[n-1],r=e[n],_&&(_.next_item=i),r&&(r.prev_item=i),i.prev_item=_,i.next_item=r),e.splice(n,0,i),!0)):!1},a.prototype._remove_item=function(e,i,s){var o,n,r,_,a;return null==s&&(s=!1),i?(a=t(e,function(e){return function(t){return e.comparator_fn(t,i)}}(this)),o=a[0],n=a[1],o?(s&&(_=e[n-1],r=e[n+1],_&&(_.next_item=r),r&&(r.prev_item=_)),e.splice(n,1),!0):!1):!1},a}(o)});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/lightbox",["jquery","external/react","modules/core/dom","modules/core/i18n","modules/clean/image_cache","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/photos_engagement_logger","modules/clean/photos/carousel_app/face_rec_utils","modules/clean/photos/carousel_app/carousel_item","modules/clean/photos/carousel_app/gallery_context_menu","modules/clean/photos/carousel_app/react_lightbox_actions_overlay","modules/clean/photos/carousel_app/selection_limit_modal","modules/clean/photos/carousel_app/store_event","modules/clean/video_util"],function(e,t,i,s,o,n,r,_,a,l,u,h,c,p){var d,m;return m=s._,d=function(){function s(t){this.$lightbox=t,this._remove_face_rec_overlay=__bind(this._remove_face_rec_overlay,this),this._add_face_rec_overlay=__bind(this._add_face_rec_overlay,this),this._close=__bind(this._close,this),this.close=__bind(this.close,this),this._clear_lightbox=__bind(this._clear_lightbox,this),this._on_fullscreen_change=__bind(this._on_fullscreen_change,this),this._add_fullscreen_change_listener=__bind(this._add_fullscreen_change_listener,this),this._exit_fullscreen=__bind(this._exit_fullscreen,this),this._on_enter_fullscreen=__bind(this._on_enter_fullscreen,this),this._is_fullscreen=__bind(this._is_fullscreen,this),this._preload_around_item=__bind(this._preload_around_item,this),this._on_lightbox_show_likers=__bind(this._on_lightbox_show_likers,this),this._on_lightbox_like=__bind(this._on_lightbox_like,this),this._toggle_lightbox_checkmark=__bind(this._toggle_lightbox_checkmark,this),this._prev=__bind(this._prev,this),this._next=__bind(this._next,this),this._resize_video=__bind(this._resize_video,this),this._resize_rotate_and_position_image=__bind(this._resize_rotate_and_position_image,this),this._resize_image_wrapper=__bind(this._resize_image_wrapper,this),this._on_video_player_error=__bind(this._on_video_player_error,this),this._attach_photo_or_video=__bind(this._attach_photo_or_video,this),this._enable_lightbox_navigation=__bind(this._enable_lightbox_navigation,this),this._disable_lightbox_navigation=__bind(this._disable_lightbox_navigation,this),this._toggle_lightbox_navigation=__bind(this._toggle_lightbox_navigation,this),this._open_lightbox_at_item=__bind(this._open_lightbox_at_item,this),this._update_action_menu=__bind(this._update_action_menu,this),this._push_history=__bind(this._push_history,this),this._share_current_item=__bind(this._share_current_item,this),this._render_actions_overlay=__bind(this._render_actions_overlay,this),this.set_on_share_item=__bind(this.set_on_share_item,this),this.on_lightbox_show_likers=__bind(this.on_lightbox_show_likers,this),this.on_lightbox_like=__bind(this.on_lightbox_like,this),this.open_at_item=__bind(this.open_at_item,this),this.set_logging_extra=__bind(this.set_logging_extra,this),this.set_display_options=__bind(this.set_display_options,this),this.set_item_store=__bind(this.set_item_store,this),this.set_page=__bind(this.set_page,this),this._resize=__bind(this._resize,this),this._on_key_down=__bind(this._on_key_down,this),this.unbind_keys=__bind(this.unbind_keys,this),this.bind_keys=__bind(this.bind_keys,this),this.logging_extras={},this.image_cache=new o,this.items=[],this.lightbox_like_callbacks=[],this.lightbox_show_likers_callbacks=[],this.$image_wrapper=this.$lightbox.find(".lightbox-image-wrapper"),this.$lightbox_share_cart_wrapper=this.$lightbox.closest(".share-cart-lightbox-wrapper"),this.$lightbox.find(".more-button, .download-link, .show-in-folder-button").click(function(){return function(e){return e.stopPropagation()}}(this)),this.$lightbox.find(".shaare-button").click(this._share_current_item),this.$lightbox.find(".lightbox-close-button").click(function(e){return function(){return e.close(),r.log_carousel(r.WEBAPP_LIGHTBOX_CLOSE_ICON)}}(this)),this.$lightbox.find(".download-button").click(function(){return function(e){return r.log_carousel(r.WEBAPP_LIGHTBOX_DOWNLOAD),e.stopPropagation()}}(this)),this.$lightbox.find(".fullscreen-exit-button").click(function(e){return function(t){return t.stopPropagation(),e._exit_fullscreen()}}(this)),this.$prev_button=this.$lightbox.find(".prev-button"),this.$next_button=this.$lightbox.find(".next-button"),this._enable_lightbox_navigation(),this.$lightbox.find(".video-error-message").click(function(){return function(e){return e.stopPropagation()}}(this)),this.bind_keys(),e(window).resize(function(e){return function(){return e._resize()}}(this)),e(window).on("popstate",function(e){return function(){return e.shown?(setTimeout(e._close,100),e.shown=!1):void 0}}(this)),this._add_fullscreen_change_listener()}return s.prototype.SHARE_CART_HEIGHT=76,s.prototype.bind_keys=function(){return e(document).bind("keydown",this._on_key_down)},s.prototype.unbind_keys=function(){return e(document).unbind("keydown",this._on_key_down)},s.prototype._on_key_down=function(e){return this.shown?37===e.keyCode?(this._prev(),!1):39===e.keyCode?(this._next(),!1):27===e.keyCode?(this.close(),r.log_carousel(r.WEBAPP_LIGHTBOX_CLOSE_KEY),!1):!this.show_checkmark||32!==e.keyCode&&88!==e.keyCode&&78!==e.keyCode?void 0:(this._toggle_lightbox_checkmark(),!1):void 0},s.prototype._resize=function(){var e,t,i,s;if(null!=this.current_item)return s=this._resize_image_wrapper(null,this.current_item),i=s[0],t=s[1],this.current_item.is_video?this._resize_video(i,t):(e=this.$image_wrapper.find(".lightbox-image"),this._resize_rotate_and_position_image(e,this.current_item.rotation_angle,i,t))},s.prototype.set_page=function(e){this.page=e},s.prototype.set_item_store=function(e){return this.item_store=e,this.items=this.item_store.all_items,this.item_store.on(c.ITEMS_CHANGED,function(e){return function(){return e.shown?e._open_lightbox_at_item(e.current_item):void 0}}(this)),this.item_store.on(c.SELECTED_CHANGED,function(e){return function(){return e._render_actions_overlay(),e._update_action_menu()}}(this)),this.item_store.on(c.ITEMS_DELETED,function(e){return function(){return e.shown?e.current_item.next_item?e._open_lightbox_at_item(e.current_item.next_item):e.current_item.prev_item?e._open_lightbox_at_item(e.current_item.prev_item):(e.current_item=null,e.close()):void 0}}(this))},s.prototype.set_display_options=function(e){var t,i,s,o,n,r,_,a;return i=e.show_checkmark,s=e.show_download_button,r=e.show_gallery_actions,a=e.show_more_actions_button,n=e.show_face_rec,t=e.show_album_actions,_=e.show_like,o=e.show_editing_toolbar,this.$lightbox.toggleClass("show-download-button",s),this.$lightbox.toggleClass("show-gallery-actions",r),this.$lightbox.toggleClass("show-more-actions-button",a),this.$lightbox.toggleClass("show-album-actions",t),this.albums_allowed=t,this.show_checkmark=i,this.show_like=_,this.show_editing_toolbar=o,this.show_face_rec=n,this._render_actions_overlay()},s.prototype.set_logging_extra=function(e,t){return this.logging_extras[e]=t},s.prototype.open_at_item=function(e){return e?this._open_lightbox_at_item(e):void 0},s.prototype.on_lightbox_like=function(e){return this.lightbox_like_callbacks.push(e)},s.prototype.on_lightbox_show_likers=function(e){return this.lightbox_show_likers_callbacks.push(e)},s.prototype.set_on_share_item=function(e){this.on_share_item=e},s.prototype._render_actions_overlay=function(){return this.react_actions_overlay=t.render(u({item:this.current_item,show_checkmark:this.show_checkmark,show_like:this.show_like,show_editing_toolbar:this.show_editing_toolbar,fullscreen:this._is_fullscreen(),on_click:this.shown?this._next:null,on_toggle_checkmark:this._toggle_lightbox_checkmark,on_like:this._on_lightbox_like,on_show_likers:this._on_lightbox_show_likers,on_enter_fullscreen:this._on_enter_fullscreen}),this.$lightbox.find(".react-lightbox-actions-overlay")[0])},s.prototype._share_current_item=function(){return"function"==typeof this.on_share_item&&this.on_share_item(this.current_item),r.log_carousel(r.WEBAPP_LIGHTBOX_SHARE),!1},s.prototype._push_history=function(){return history.replaceState({page_name:history.state.page_name,scrollTop:e(document).scrollTop()},document.title,window.location.pathname),history.pushState(null,document.title,""+window.location.pathname+"/lightbox")},s.prototype._update_action_menu=function(){var i;return i=t.render(l({page:this.page,shown:!0,position_static:!0,item:this.current_item,albums_allowed:this.albums_allowed,logging_extras:e.extend({},this.logging_extras,{which_menu:"lightbox menu"})}),this.$lightbox.find(".lightbox-more-menu")[0])},s.prototype._open_lightbox_at_item=function(t){var s,o;return this.current_item=t,this.current_item?(this._update_action_menu(),this.shown||this._push_history(),o=this.current_item.lightbox_url,this._clear_lightbox(),this._toggle_lightbox_navigation(),this.shown||(this._disable_lightbox_navigation(),setTimeout(this._enable_lightbox_navigation,500)),s=e(this.image_cache.get_image(o)),this.$lightbox.toggleClass("image-loaded",s[0].complete),this.$lightbox.find(".download-link").attr("href",this.current_item.download_url),this.$lightbox.find(".show-in-folder-button").attr("href",this.current_item.folder_url),this.$lightbox.find(".datetime").text(this.current_item.date_time),this.$lightbox.find(".editor").text(this.current_item.editor?m("Shared by %(name)s",{project:"carousel-web"}).format({name:this.current_item.editor}):""),s[0].complete?this._attach_photo_or_video(this.current_item,s):s.load(function(e){return function(t){return function(){return t===e.current_item?(e.$lightbox.addClass("image-loaded"),e._clear_lightbox(),e._attach_photo_or_video(t,s)):void 0}}}(this)(this.current_item)),this._render_actions_overlay(),this._preload_around_item(this.current_item),this.shown?void 0:(this.$lightbox.addClass("shown"),this.$lightbox_share_cart_wrapper.addClass("lightbox-shown"),i.scroll_lock_document(),this.shown=!0,r.log_carousel(r.WEBAPP_LIGHTBOX_OPEN,this.logging_extras))):void 0},s.prototype._toggle_lightbox_navigation=function(){return this.$prev_button.toggleClass("prev-button-show",null!=this.current_item.prev_item),this.$next_button.toggleClass("next-button-show",null!=this.current_item.next_item)},s.prototype._disable_lightbox_navigation=function(){var e;return this.$prev_button.unbind("click"),this.$next_button.unbind("click"),null!=(e=this.react_actions_overlay)?e.setProps({on_click:null}):void 0},s.prototype._enable_lightbox_navigation=function(){var e;return this.$prev_button.click(this._prev),this.$next_button.click(this._next),null!=(e=this.react_actions_overlay)?e.setProps({on_click:this._next}):void 0},s.prototype._attach_photo_or_video=function(e,t){var i,s,o,n;return n=this._resize_image_wrapper(t,e),o=n[0],s=n[1],e.is_video?(i=this.$image_wrapper.find(".lightbox-video"),this.player=p.embed(i[0],{src:e.video_url,type:"application/vnd.apple.mpegurl",width:o,height:s,controls:!0,poster:e.lightbox_url}),this.player.on("ended",this._on_ended),this.player.on("error",this._on_video_player_error),i.click(function(){return function(){return!1}}(this))):(t.addClass("lightbox-image"),this._resize_rotate_and_position_image(t,e.rotation_angle,o,s),this.$image_wrapper.prepend(t)),this._add_face_rec_overlay(e,o,s)},s.prototype._on_ended=function(){return e(".vjs-loading-spinner").hide()},s.prototype._on_video_player_error=function(e){return this._clear_lightbox(),this.$image_wrapper.addClass("preview-error"),"needflash"===e?this.$image_wrapper.find(".needflash-error").show():this.$image_wrapper.find(".default-error").show()},s.prototype._shutdown_video_player=function(){var e;if(this.player){try{this.player.trigger("shutdown"),this.player.dispose()}catch(t){e=t}return this.player=null}},s.prototype._resize_image_wrapper=function(t,i){var s,o,n,r,_,a,l;return(null!=t?t.length:void 0)||(t=e(this.image_cache.get_image(i.lightbox_url))),t.length?(r=window.innerWidth-160,n=.9*window.innerHeight-this.SHARE_CART_HEIGHT,a=t[0].naturalWidth,_=t[0].naturalHeight,(90===i.rotation_angle||270===i.rotation_angle)&&(l=[_,a],a=l[0],_=l[1]),o=a,s=_,o>r&&(o=r,s=r*(_/a)),s>n&&(s=n,o=n*(a/_)),this.$image_wrapper.width(o),this.$image_wrapper.height(s),[o,s]):void 0},s.prototype._resize_rotate_and_position_image=function(e,t,i,s){var o;return e.css("transform","rotate("+t+"deg)"),90===t||270===t?(o=(i-s)/2,e.css({height:""+i,width:""+s,left:""+o+"px",top:""+-o+"px",position:"absolute"})):e.css({left:"0",top:"0",height:""+s,width:""+i})},s.prototype._resize_video=function(e,t){var i;return i=this.$image_wrapper.find(".video-js"),i.length?(i.width(e),i.height(t)):void 0},s.prototype._next=function(){return this.current_item.next_item?(this._open_lightbox_at_item(this.current_item.next_item),r.log_carousel(r.WEBAPP_LIGHTBOX_FORWARD)):void 0},s.prototype._prev=function(){return this.current_item.prev_item?(this._open_lightbox_at_item(this.current_item.prev_item),r.log_carousel(r.WEBAPP_LIGHTBOX_BACK)):void 0},s.prototype._toggle_lightbox_checkmark=function(){return this.$lightbox.find(".more-dropdown").data("jscontroller").closeDropdown(),this.current_item.is_selected?(this.item_store.deselect_item(this.current_item),r.log_carousel(r.WEBAPP_LIGHTBOX_DESELECT_ITEM,this.logging_extras)):this.item_store.selected_items.length>=h.SELECTION_MAX_SIZE?void h.show():(this.item_store.select_item(this.current_item),r.log_carousel(r.WEBAPP_LIGHTBOX_SELECT_ITEM,this.logging_extras))},s.prototype._on_lightbox_like=function(){var e,t,i,s;for(s=this.lightbox_like_callbacks,t=0,i=s.length;i>t;t++)e=s[t],"function"==typeof e&&e(this.current_item);return this._render_actions_overlay()},s.prototype._on_lightbox_show_likers=function(){var e,t,i,s,o;for(s=this.lightbox_show_likers_callbacks,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push("function"==typeof e?e(this.current_item):void 0);return o},s.prototype._preload_around_item=function(e){var t,i,s,o,n;for(i=e,t=s=0;6>s;t=++s)i=null!=i?i.next_item:void 0,(null!=i?i.lightbox_url:void 0)&&this.image_cache.preload_image(i.lightbox_url);for(i=e,n=[],t=o=0;3>o;t=++o)i=null!=i?i.prev_item:void 0,n.push((null!=i?i.lightbox_url:void 0)?this.image_cache.preload_image(i.lightbox_url):void 0);return n},s.prototype._is_fullscreen=function(){return null!=document.fullScreen?document.fullScreen:null!=document.webkitIsFullScreen?document.webkitIsFullScreen:null!=document.mozFullScreen?document.mozFullScreen:null!=document.msFullscreenElement||null!=document.fullscreenElement},s.prototype._on_enter_fullscreen=function(){var e;return e=this.$lightbox.find(".image-container")[0],null!=e.requestFullscreen?e.requestFullscreen():null!=e.msRequestFullscreen?e.msRequestFullscreen():null!=e.mozRequestFullscreen?e.mozRequestFullscreen():null!=e.webkitRequestFullscreen?e.webkitRequestFullscreen():void 0},s.prototype._exit_fullscreen=function(){return null!=document.exitFullscreen?document.exitFullscreen():null!=document.msExitFullscreen?document.msExitFullscreen():null!=document.mozCancelFullscreen?document.mozCancelFullscreen():null!=document.webkitExitFullscreen?document.webkitExitFullscreen():void 0},s.prototype._add_fullscreen_change_listener=function(){return e(document).on("fullscreenchange",this._on_fullscreen_change),e(document).on("webkitfullscreenchange",this._on_fullscreen_change),e(document).on("msfullscreenchange",this._on_fullscreen_change),e(document).on("mozfullscreenchange",this._on_fullscreen_change)},s.prototype._on_fullscreen_change=function(){return this.shown?this._render_actions_overlay():void 0},s.prototype._clear_lightbox=function(){return this._shutdown_video_player(),this._remove_face_rec_overlay(),this.$image_wrapper.removeClass("preview-error"),this.$image_wrapper.find(".video-error-message").hide(),this.$image_wrapper.find(".lightbox-image").remove(),this.$image_wrapper.find(".lightbox-video").empty()},s.prototype.close=function(){return this.shown?history.go(-1):void 0},s.prototype._close=function(){return this._clear_lightbox(),this.$lightbox.removeClass("shown"),this.$lightbox_share_cart_wrapper.removeClass("lightbox-shown"),i.scroll_unlock_document(),n().dispatcher.trigger(n.LIGHTBOX_CLOSED,this.current_item)},s.prototype._add_face_rec_overlay=function(t,i,s){var o;return this.show_face_rec?(o=e('<canvas class="lightbox-face-overlay">'),this.$image_wrapper.append(o),_.render_face_boxes(t,i,s,o,this.show_face_rec)):void 0},s.prototype._remove_face_rec_overlay=function(){return this.show_face_rec?this.$image_wrapper.find(".lightbox-face-overlay").remove():void 0},s}(),{Lightbox:d}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/onboarding",["jquery","modules/core/dom"],function(e,t){var i;return i=function(){function i(){this.finish=__bind(this.finish,this),this.start=__bind(this.start,this),this.$container=e("#onboarding-container"),this.$container.find(".next-button").click(function(e){return function(){return e.$container.find(".first-panel").hide(),e.$container.find(".second-panel").show()}}(this)),this.$container.find(".done-button").click(this.finish)}return i.prototype.start=function(e){return this.on_finish=e,this.on_finish||t.scroll_lock_document(),this.$container.show()},i.prototype.finish=function(){return this.on_finish||t.scroll_unlock_document(),this.$container.hide(),"function"==typeof this.on_finish&&this.on_finish(),!1},i}()}),define("modules/clean/photos/carousel_app/photos_tab_deprecation_modals",["jquery","external/react","modules/core/browser","modules/core/i18n","modules/core/uri","modules/clean/ajax","modules/clean/storage","modules/clean/react/button","modules/clean/react/modal","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/photos/photos_engagement_logger"],function(e,t,i,s,o,n,r,_,a,l,u,h){var c,p,d,m,g,f,b,v,w,y,k,x,E,T,P,S,N,A;return m=r.LocalStorage,S=_.button,g=a.Modal,P=a.SimpleModal,E=l.R_,A=s.i18n_default_project("carousel-web")._,N=t.DOM,x=t.createClass({getInitialState:function(){return{shown:!1}},propTypes:{header_text:t.PropTypes.string,body_text:t.PropTypes.string,button_text:t.PropTypes.string,on_confirm:t.PropTypes.func},componentDidMount:function(){return setTimeout(function(e){return function(){return e.setState({shown:!0})}}(this),2e3),e(".pop-up-banner-confirm").click(function(e){return function(){return e.props.on_confirm(),e.setState({shown:!1})}}(this))},on_confirm:function(){return this.props.on_confirm(),this.setState({shown:!1})},render:function(){var e;return e=this.state.shown?"shown":"",N.div({className:"opt-in-banner "+e},N.img({className:"opt-in-banner-close",onClick:function(e){return function(){return e.setState({shown:!1})}}(this),src:"/static/images/carousel/carousel_app/close-vflDkf498.svg"}),N.div({className:"opt-in-banner-header"},this.props.header_text),N.div({className:"opt-in-banner-text"},this.props.body_text),this.props.button_text?S({onClick:this.on_confirm},this.props.button_text):void 0)}}),y=function(){function t(){}return t.show=function(){return t.shown_once?void 0:(t.shown_once=!0,e("#opt-out-hint .bubble-dropdown").fadeIn())},t}(),v=function(){function i(){}return i.show=function(s){var o,n,r;return r=Date.now(),n=m.get("opt-in-banner-last-shown-time"),o=864e5,n&&o>r-n||i.shown_once?void 0:(i.shown_once=!0,h.log_carousel(h.WEBAPP_OPT_IN_BANNER_SHOWN),m.set("opt-in-banner-last-shown-time",r),t.render(x({header_text:A("Thanks for using Carousel!",{project:"carousel-web"}),body_text:A("Would you like Carousel to be your default photos experience for Dropbox from now on?",{project:"carousel-web"}),button_text:A("Make Carousel default",{project:"carousel-web"}),on_confirm:function(){return h.log_carousel(h.WEBAPP_OPT_IN_BANNER_CONFIRM),s()}}),e("#pop-up-banner-container")[0]))},i}(),c=t.createClass({propTypes:{shown:t.PropTypes.bool},componentDidMount:function(){return this.resetTimer()},resetTimer:function(){return clearTimeout(this.timeout),this.props.shown?this.timeout=setTimeout(function(e){return function(){return e.setProps({shown:!1})}}(this),3e3):void 0},componentDidUpdate:function(){return this.resetTimer()},render:function(){var e;return e=this.props.shown?"shown":"",N.div({className:"scroll-bottom-banner "+e},u({className:"scroll-bottom-image",group:"carousel",name:"scroll_bottom_illustration"}),N.span({className:"scroll-bottom-banner-text"},A("Scroll up to see older photos. Up, up, and away!")))}}),T=function(){function i(){}return i.show=function(){return this.banner?this.banner.setProps({shown:!0}):this.banner=t.render(c({shown:!1}),e("#scroll-bottom-banner-container")[0])},i.hide=function(){
var e;return null!=(e=this.banner)?e.setProps({shown:!1}):void 0},i}(),w=function(){function e(){}return e.show=function(e){return n.WebRequest({url:"/app/ajax/make_carousel_default",data:{make_default:!0}}),g.showInstance(g({style:"clean"},N.div({className:"opt-in-modal"},N.img({className:"opt-in-image",src:"/static/images/carousel/thumbs_silly-face-adj-vflUmbv5f.png"}),N.div({className:"opt-in-header"},A("Welcome to Carousel!",{project:"carousel-web"})),N.div({className:"opt-in-text"},A("Carousel is now your default web photos experience for Dropbox.",{project:"carousel-web"}))))),e()},e}(),k=function(){function e(){}return e.show=function(t){return P.show({title_text:A("Are you sure?",{project:"carousel-web"}),body_html:A("Do you want to return to the old Dropbox web photos experience? Carousel has extra features like automatic organization and simpler sharing.",{project:"carousel-web"}),confirm_text:A("Switch back",{project:"carousel-web"}),cancel_text:A("I'll stick with Carousel",{project:"carousel-web"}),confirm_callback:function(){return n.WebRequest({url:"/app/ajax/make_carousel_default",data:{make_default:!1}}),h.log_carousel(h.WEBAPP_OPT_OUT_MODAL_CONFIRM),setTimeout(function(){return e.show_done(t)},0)}})},e.show_done=function(e){return g.showInstance(g({style:"clean",onAccept:function(){return i.redirect(o({scheme:"https",authority:Constants.WEBSERVER,path:"/photos"}).toString())},onDismiss:e},N.div({className:"opt-in-modal"},N.img({className:"opt-in-image",src:"/static/images/carousel/thumbs_dog-car-vflO3j2VD.png"}),N.div({className:"opt-in-header"},A("We'll miss you.",{project:"carousel-web"})),N.div({className:"opt-in-text"},E({},'Please <a target="_blank" href="/photos/carousel_help/submit">leave us some feedback</a> before you go. If you change your mind, you can always get back to this from carousel.com.'))))),e()},e}(),d=function(){function e(){}return e.show=function(){return g.showInstance(g({style:"clean",width:640,acceptButtonText:A("Next"),onAccept:function(){return setTimeout(function(){return e.show_page2()},0)}},N.div({className:"caro-user-modal"},N.div({className:"caro-user-header"},A("Carousel web has a fresh new design!")),N.div({className:"caro-user-text"},A("Access your albums and flashback in the sidebar.")),N.img({className:"caro-user-image",src:"/static/images/carousel/carousel_in_photos_onboarding_sidebar_sharing-vflzKVB_u.png"}))))},e.show_page2=function(){return g.showInstance(g({style:"clean",width:640,acceptButtonText:A("Awesome!")},N.div({className:"caro-user-modal"},N.div({className:"caro-user-header"},A("New scroll order")),N.div({className:"caro-user-text"},A("To make browsing your photos a little smoother, your newest events will now appear at the bottom of the page. Scroll up to go back in time!")),N.img({className:"caro-user-image caro-user-image-border",src:"/static/images/carousel/carousel_in_photos_onboarding_scroll_direction-vflXYTG5f.png"}))))},e}(),f=function(){function e(){}return e.show=function(){return g.showInstance(g({style:"clean",width:640,acceptButtonText:A("Next"),onAccept:function(){return setTimeout(function(){return b.show_page2()},0)}},N.div({className:"caro-user-modal"},N.div({className:"caro-user-header"},A("Welcome to Carousel Web")),N.div({className:"caro-user-text"},A("We’ll walk you through some of the new features that make browsing and sharing your photos even better.")),N.img({className:"caro-user-image caro-user-image-border",src:"/static/images/carousel/carousel_in_photos_onboarding_scroll_direction_sharing-vflMzQAzc.png"}))))},e.show_page2=function(){return g.showInstance(g({style:"clean",width:640,acceptButtonText:A("Next"),onAccept:function(){return setTimeout(function(){return b.show_page3()},0)}},N.div({className:"caro-user-modal"},N.div({className:"caro-user-header"},A("Effortless Organization")),N.div({className:"caro-user-text"},A("We’ve organized your photos into events by time and location - it’s never been easier to find exactly the shot you’re looking for.")),N.img({className:"caro-user-image",src:"/static/images/carousel/carousel_in_photos_onboarding_events-vfleAXBee.png"}))))},e.show_page3=function(){return g.showInstance(g({style:"clean",width:640,acceptButtonText:A("Awesome!")},N.div({className:"caro-user-modal"},N.div({className:"caro-user-header"},A("Flashback")),N.div({className:"caro-user-text"},A("To make it easier to rediscover old photos stored in your Dropbox, Flashback compiles a set of photos from this week in years past.")),N.img({className:"caro-user-image caro-user-image-border",src:"/static/images/carousel/carousel_in_photos_onboarding_flashback-vflDsqCKO.png"}))))},e}(),b=function(){function e(){}return e.show=function(){return g.showInstance(g({style:"clean",width:640,acceptButtonText:"Next",onAccept:function(){return setTimeout(function(){return e.show_page2()},0)}},N.div({className:"caro-user-modal"},N.div({className:"caro-user-header"},A("Welcome to the new Dropbox photo experience")),N.div({className:"caro-user-text"},A("We’ll walk you through some of the new features that make browsing and sharing your photos even better.")),N.img({className:"caro-user-image caro-user-image-border",src:"/static/images/carousel/carousel_in_photos_onboarding_scroll_direction-vflXYTG5f.png"}))))},e.show_page2=function(){return g.showInstance(g({style:"clean",width:640,acceptButtonText:A("Next"),onAccept:function(){return setTimeout(function(){return e.show_page3()},0)}},N.div({className:"caro-user-modal"},N.div({className:"caro-user-header"},A("New look and organization")),N.div({className:"caro-user-text"},A("We’ve organized your photos into events by time and location - it’s never been easier to find exactly the shot you’re looking for.")),N.img({className:"caro-user-image",src:"/static/images/carousel/carousel_in_photos_onboarding_events-vfleAXBee.png"}))))},e.show_page3=function(){return g.showInstance(g({style:"clean",width:640,acceptButtonText:A("Awesome!")},N.div({className:"caro-user-modal"},N.div({className:"caro-user-header"},A("Flashback")),N.div({className:"caro-user-text"},A("To make it easier to rediscover old photos stored in your Dropbox, Flashback compiles a set of photos from this week in years past.")),N.img({className:"caro-user-image caro-user-image-border",src:"/static/images/carousel/carousel_in_photos_onboarding_flashback-vflDsqCKO.png"}))))},e}(),p=function(){function e(){}return e.show=function(e){return e?d.show():f.show()},e}(),{OptInBanner:v,OptInModal:w,OptOutBanner:y,OptOutModal:k,CarouselOnboardingModal:p,ScrollBottomBanner:T}}),define("modules/clean/photos/carousel_app/react_event_to_merge_rows",["jquery","external/react","modules/core/i18n","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/carousel_app/react_item"],function(e,t,i,s){var o,n;return n=i._,o=t.DOM,t.createClass({displayName:"ReactEventToMergeRows",getDefaultProps:function(){return{eventData:{top:0,height:0,location:"",date:"",num_items:0,num_selected:0},indent_titles:!1,event_select_width:null,event_deselect_width:null,show_heros:!0,is_selectable:!0,show_event_header:!0}},propTypes:{show_heros:t.PropTypes.bool,is_selectable:t.PropTypes.bool,show_event_header:t.PropTypes.bool,eventData:t.PropTypes.object.isRequired,on_event_select_width_changed:t.PropTypes.func,on_event_deselect_width_changed:t.PropTypes.func,event_select_width:t.PropTypes.number,event_deselect_width:t.PropTypes.number,event_header_height:t.PropTypes.number.isRequired,on_event_header_mouse_enter:t.PropTypes.func,on_event_header_mouse_leave:t.PropTypes.func,on_select_all:t.PropTypes.func.isRequired,thumbs_per_hero:t.PropTypes.number.isRequired,thumbs_per_row:t.PropTypes.number.isRequired,thumb_size:t.PropTypes.number.isRequired,default_thumb_size:t.PropTypes.number.isRequired,indent_titles:t.PropTypes.bool},componentDidMount:function(){return this._adjust_header_width()},componentDidUpdate:function(){return this._adjust_header_width()},_adjust_header_width:function(){var t;if(this.props.show_event_header)if(t=e(this.refs["select-all"].getDOMNode()).outerWidth(!0),this.props.eventData.num_selected===this.props.eventData.num_items){if(null==this.props.event_deselect_width)return this.props.on_event_deselect_width_changed(t)}else if(null==this.props.event_select_width)return this.props.on_event_select_width_changed(t)},on_event_header_mouse_enter:function(){return this.props.is_selectable?this.props.on_event_header_mouse_enter(this.props.eventData):void 0},on_event_header_mouse_leave:function(){return this.props.is_selectable?this.props.on_event_header_mouse_leave(this.props.eventData):void 0},select_all:function(){return this.props.is_selectable?this.props.on_select_all(this.props.eventData):void 0},render:function(){var e,i,r,_,a,l,u,h,c,p,d,m,g,f,b,v,w,y,k,x,E,T;if(e=t.addons.classSet,a=e({"event-metadata":!0,clearfix:!0,"reduce-whitespace":!0,"less-padding":!0}),_=e({"event-header-wrapper":!0,"reduce-whitespace":!0,"is-selectable":this.props.is_selectable}),i=e({"event-header":!0,"reduce-whitespace":!0,"one-line-header":""===this.props.eventData.location,"indent-titles":this.props.indent_titles}),u=e({"event-subheader":!0,"reduce-whitespace":!0,"indent-titles":this.props.indent_titles}),k=this.props.is_selectable&&(this.props.eventData.show_select_all||this.props.eventData.num_selected>0),y=e({"select-all":!0,"button-tertiary":!0,"reduce-whitespace":!0,"indent-titles":this.props.indent_titles,"show-select-all":k}),p=0,this.props.show_heros&&!("function"==typeof(x=this.props.eventData).is_missing_dates?x.is_missing_dates():void 0)&&(p=Math.floor(this.props.eventData.num_items/this.props.thumbs_per_hero)),d=this.props.eventData.num_items+3*p,m=d%this.props.thumbs_per_row,f=null,m>0&&(g=this.props.thumbs_per_row-m,v=Math.floor(d/this.props.thumbs_per_row)*this.props.thumb_size,b=d%this.props.thumbs_per_row*this.props.thumb_size,w=g*this.props.thumb_size,f=new o.div({className:"overlay",style:{top:v,left:b,width:w}})),l="event-photos placeholders placeholders-"+this.props.eventData.thumb_size,this.props.thumb_size%this.props.default_thumb_size>0){for(f=[],c=E=0,T=this.props.eventData.num_items;T>=0?T>E:E>T;c=T>=0?++E:--E)f.push(new o.div({key:"event-thumb-"+c,className:"event-thumb",style:{top:Math.floor(c/this.props.thumbs_per_row)+this.props.event_header_height,left:c%this.props.thumbs_per_row*this.props.thumb_size,width:this.props.thumb_size,height:this.props.thumb_size,position:"absolute","float":"none"}}));l="event-photos"}return r=this.props.eventData.width,(this.props.eventData.show_select_all||this.props.eventData.num_selected>0)&&(r-=this.props.eventData.num_selected===this.props.eventData.num_items?this.props.event_deselect_width:this.props.event_select_width),h=""!==this.props.eventData.location,o.div({className:"gallery-event",style:{width:this.props.eventData.width,height:this.props.eventData.height,top:this.props.eventData.top,left:this.props.eventData.left,position:"absolute"}},this.props.show_event_header?o.div({className:a,onMouseEnter:this.on_event_header_mouse_enter,onMouseLeave:this.on_event_header_mouse_leave,style:{height:this.props.event_header_height}},o.div({onClick:this.select_all,className:_,style:{width:r}},h?o.div({className:i},this.props.eventData.location):void 0,o.div({className:h?u:i},this.props.eventData.date)),o.div({className:y,ref:"select-all",onClick:this.select_all},this.props.eventData.num_selected===this.props.eventData.num_items?n("Deselect",{project:"carousel-web"}):n("Select",{project:"carousel-web"}))):void 0,o.div({className:l,style:{height:this.props.eventData.height-this.props.event_header_height}},f,s().constants.debug_thumbs?o.div({style:{padding:"20px",position:"absolute",width:"100%",boxSizing:"border-box",color:"black"}},"No event data"):void 0))}})});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function i(){this.constructor=e}for(var s in t)__hasProp.call(t,s)&&(e[s]=t[s]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},__slice=[].slice,__indexOf=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/photos/carousel_app/react_gallery_page",["jquery","external/react","modules/core/i18n","modules/clean/ajax","modules/clean/binary_search","modules/clean/storage","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/carousel_app/carousel_event","modules/clean/photos/carousel_app/carousel_event_store","modules/clean/photos/carousel_app/carousel_item","modules/clean/photos/carousel_app/item_store","modules/clean/photos/carousel_app/photos_tab_deprecation_modals","modules/clean/photos/carousel_app/react_timeline","modules/clean/photos/carousel_app/react_timeline_navigation","modules/clean/photos/carousel_app/store_event","modules/clean/photos/photos_engagement_logger","modules/clean/photos/stop_watch","modules/core/dom"],function(e,t,i,s,o,n,r,_,a,l,u,h,c,p,d,m,g,f){var b,v,w,y,k,x,E;return E=i._,x=i.ungettext,v=n.LocalStorage,y=h.ScrollBottomBanner,b=function(){function e(e,t,i,s){var o;this.scroll_position=e,this.events=t,this.is_background_request=i,this.options=null!=s?s:{},this.cancel_request=__bind(this.cancel_request,this),this.retry=__bind(this.retry,this),this.send_request=__bind(this.send_request,this),this.set_callbacks=__bind(this.set_callbacks,this),null==this.scroll_position&&(this.scroll_position=0),this.event_handles=JSON.stringify(function(){var e,t,i,s;for(i=this.events,s=[],e=0,t=i.length;t>e;e++)o=i[e],s.push(o.event_handle);return s}.call(this)),this.num_attempts=0}return e.prototype.MAX_ATTEMPTS=2,e.prototype.set_callbacks=function(e){this.success=e.success,this.error=e.error,this.complete=e.complete},e.prototype.send_request=function(){var e,t;return r().constants.use_local_storage&&(t=!1,v.get("event_data_stored")||(t=!0,v.set("event_data_stored",!0)),e=v.get(this.event_handles))?(this.success(e,this),void this.complete(this)):(this.request=s.WebRequest({url:"/app/ajax/get_event_data",data:{event_handles_json:this.event_handles,include_faces:this.options.include_faces,is_background_request:this.is_background_request},success:function(i){return function(s){return e=JSON.parse(s),r().constants.use_local_storage&&t&&v.set(i.event_handles,e),i.success(e,i)}}(this),error:function(e){return function(t){return e.error(t,e)}}(this),complete:function(e){return function(){return"function"==typeof e.complete?e.complete(e):void 0}}(this)}),this.num_attempts++)},e.prototype.retry=function(){return this.num_attempts<this.MAX_ATTEMPTS?this.send_request():void 0},e.prototype.cancel_request=function(){var e;return null!=(e=this.request)&&e.abort(),delete this.request},e}(),w=function(e){function t(e,i,s,o){this.event=i,this.cursors_received=s,this.options=null!=o?o:{},this.send_request=__bind(this.send_request,this),t.__super__.constructor.call(this,e,[this.event],!0,this.options)}return __extends(t,e),t.prototype.send_request=function(){var e,t;return e=this.event.cursor||"",t={include_faces:this.options.include_faces,page_size:50},e.length&&(t.cursor=e),this.request=s.WebRequest({url:"/app/ajax/get_missing_date_data",data:t,success:function(t){return function(i){var s;return s=JSON.parse(i),s.event_handle=_.MISSING_DATES_HANDLE,s.gone=!1,t.cursors_received[e]?t.success([],t,t.event.more):(t.event.more=s.more,t.cursors_received[e]=!0,s.more&&(t.num_attempts=0,t.event.cursor=s.cursor,t.send_request()),t.success([s],t,s.more))}}(this),error:function(e){return function(t){return e.error(t,e)}}(this),complete:function(e){return function(){return"function"==typeof e.complete?e.complete(e):void 0}}(this)}),this.num_attempts++},t}(b),k=function(){function i(t,s,o){var n,r,_,l,u,h,c;if(this.app=t,this.$container=s,this.lightbox_closed_at_item=__bind(this.lightbox_closed_at_item,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),this._on_items_deleted=__bind(this._on_items_deleted,this),this._on_click_item=__bind(this._on_click_item,this),this._on_select_all=__bind(this._on_select_all,this),this._on_events_data_received=__bind(this._on_events_data_received,this),this._cancel_viewport_request=__bind(this._cancel_viewport_request,this),this._make_request_for_event_batch=__bind(this._make_request_for_event_batch,this),this._get_next_background_batch=__bind(this._get_next_background_batch,this),this._remove_background_request=__bind(this._remove_background_request,this),this._cancel_furthest_background_batch=__bind(this._cancel_furthest_background_batch,this),this._fetch_background_batch=__bind(this._fetch_background_batch,this),this._add_events_in_order=__bind(this._add_events_in_order,this),this._on_request_data_for_events_in_viewport=__bind(this._on_request_data_for_events_in_viewport,this),this._on_long_stopped_scrolling=__bind(this._on_long_stopped_scrolling,this),this._on_scroll_bottom=__bind(this._on_scroll_bottom,this),this._on_scrolling=__bind(this._on_scrolling,this),this._on_log_first_item=__bind(this._on_log_first_item,this),this._on_scrubbing_end=__bind(this._on_scrubbing_end,this),this._on_scrubbing_start=__bind(this._on_scrubbing_start,this),this._render_timeline_nav=__bind(this._render_timeline_nav,this),this._render_timeline=__bind(this._render_timeline,this),this._on_events_outline_received=__bind(this._on_events_outline_received,this),this._fetch_events_outline=__bind(this._fetch_events_outline,this),this.unbind_scroll=__bind(this.unbind_scroll,this),this.bind_scroll=__bind(this.bind_scroll,this),this._move_loader_to_top=__bind(this._move_loader_to_top,this),this._move_loader_to_bottom=__bind(this._move_loader_to_bottom,this),this._init_components=__bind(this._init_components,this),i.app=this.app,this.reverse_order=!this.app.constants.use_dropbox_chrome,this.event_store=new a(_=this.reverse_order),this.item_store=this.app.item_store,this.album_store=this.app.album_store,this.log_num_events=0,this.log_num_items=0,this.scroll_position=0,this.window_height=e(window).height(),this.remaining_events=[],this.BACKGROUND_BATCH_SIZE=this.app.constants.batch_size,this.MAX_BACKGROUND_REQUESTS=5,this.background_batch_requests=[],this.current_viewport_request=null,this.app.item_store.on(d.ITEMS_DELETED,this._on_items_deleted),this.logging_extras={gallery_mode:this.reply_mode?"add_photos":"gallery"},this.md_cursors={},this._init_components(),this.event_sort_key=0,o.length){for(r=[],l=0,h=o.length;h>l;l++)n=o[l],n.sort_key=this.reverse_order?this.event_sort_key++:this.event_sort_key--,r.push(this.event_store.add_event_data(n));for(this._render_timeline(),this._on_events_data_received(o),u=0,c=r.length;c>u;u++)n=r[u],n.event_data_received=!0;this._render_timeline()}this.reverse_order?this._move_loader_to_bottom(o):this._move_loader_to_top(o),this._fetch_events_outline()}return i.debug=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],"true"===(null!=(t=i.app.constants)?t.debug:void 0)?console.log.apply(console,e):void 0},i.event_comparator=function(e,t){return e.midpoint-t.midpoint},i.item_top_comparator=function(e,t){return e.top-t},i.prototype._init_components=function(){return this.lightbox=this.app.lightbox,r().dispatcher.on(r.LIGHTBOX_CLOSED,function(e){return function(t){return e.lightbox_closed_at_item(t),e.bind_scroll()}}(this))},i.prototype._move_loader_to_bottom=function(t){var i,s,o;return s=null!=t&&null!=(o=t[t.length-1])?o.item_data:void 0,s?(this.app.set_loading(!0),i=s[s.length-1].bottom,e("#more-loading").css("top",i+80)):void 0},i.prototype._move_loader_to_top=function(t){var i,s;return i=null!=t&&null!=(s=t[0])?s.item_data:void 0,i?(this.app.set_loading(!0),e("#more-loading").css("top",60)):void 0},i.prototype.bind_scroll=function(){var e;return null!=(e=this.react_timeline)?e.setProps({bind_scroll:!0}):void 0},i.prototype.unbind_scroll=function(){var e;return null!=(e=this.react_timeline)?e.setProps({bind_scroll:!1}):void 0},i.prototype._fetch_events_outline=function(){var e;return this.shown&&this.app.set_loading(!0),r().constants.use_local_storage&&(e=v.get("events_outline"))?void this._on_events_outline_received(e):(g.start(m.WEBAPP_GALLERY_TIME_EVENTS_OUTLINE),s.WebRequest({url:"/app/ajax/get_events_outline",success:function(t){return function(i){var s;return t.shown&&t.app.set_loading(!1),e=JSON.parse(i),r().constants.use_local_storage&&v.set("events_outline",e),t._on_events_outline_received(e),s=g.stop(m.WEBAPP_GALLERY_TIME_EVENTS_OUTLINE),m.log_carousel(m.WEBAPP_GALLERY_TIME_EVENTS_OUTLINE,{time:s,num_events:t.log_num_events,num_items:t.log_num_items})}}(this)}))},i.prototype._on_events_outline_received=function(e){var t,i,s;for(0===e.length&&(this.$container.toggleClass("empty-state",!0),this.shown&&this.app.set_loading(!1),m.log_carousel(m.WEBAPP_GALLERY_EMPTY,this.logging_extras)),i=0,s=e.length;s>i;i++)t=e[i],this.log_num_events++,this.log_num_items+=t.num_items,t.sort_key=this.reverse_order?this.event_sort_key++:this.event_sort_key--,t=this.event_store.add_event_data(t),t&&(this.reverse_order?this.remaining_events.push(t):this.remaining_events.unshift(t));return this._render_timeline(),this._render_timeline_nav()},i.prototype._render_timeline=function(){var i,s,o,n,r;return this.react_timeline&&(n=f.scroll_offsets().top,o=f.document_height(),t.unmountComponentAtNode(e("#react-timeline")[0])),s=this.app.constants.use_dropbox_chrome?160:this.app.constants.timeline_navigation?140:50,this.react_timeline=t.render(new c({page:"timeline",include_faces:"faces"in this.app.constants,resize_thumbs:this.app.constants.resize_thumbs,round_thumb_size:this.app.constants.round_thumb_size,prevent_small_merges:this.app.constants.prevent_small_merges,event_header_height:75,resize_thumbs_vertically:this.app.constants.resize_thumbs_vertically,indent_titles:this.app.constants.indent_titles,app:this.app,item_store:this.app.item_store,event_store:this.event_store,events:this.event_store.all_events,on_click_item:this._on_click_item,on_select_all:this._on_select_all,on_scrolling:this._on_scrolling,on_scroll_bottom:this._on_scroll_bottom,on_request_data_for_events:this._on_request_data_for_events_in_viewport,on_long_stopped_scrolling:this._on_long_stopped_scrolling,show_context_menu_for_item:this._show_context_menu_for_item,on_item_did_mount:this._on_log_first_item,scroll_perf:this.app.constants.scroll_perf,min_page_margin:s,show_timeline_label:this.app.constants.show_timeline_label,albums_allowed:this.app.constants.albums,min_thumbs_per_row:this.app.constants.min_thumbs_per_row,hide_thumb_by_hover:this.app.constants.hide_thumb_by_hover,show_colors_grid:this.app.constants.show_colors_grid,show_marquee:this.app.constants.show_marquee,reverse_order:this.reverse_order}),e("#react-timeline")[0]),null!=n?this.reverse_order?f.scroll_to(0,n):(i=f.document_height()-o,r=n+i,f.scroll_to(0,r)):void 0},i.prototype._render_timeline_nav=function(){return this.app.constants.timeline_navigation?this.react_timeline_navigation=t.render(new p({event_store:this.event_store,item_store:this.item_store,show_months_in_years:this.app.constants.show_months_in_years,on_show_navigation:this.app.hide_account_settings,on_hide_navigation:this.app.show_account_settings,reverse_markers:this.app.constants.reverse_markers,logging_extras:this.logging_extras,on_scrubbing_start:this._on_scrubbing_start,on_scrubbing_end:this._on_scrubbing_end}),e("#react-timeline-navigation")[0]):void 0},i.prototype._on_scrubbing_start=function(){return this.app.constants.show_marquee?this.react_timeline.setProps({show_marquee:!1}):void 0},i.prototype._on_scrubbing_end=function(){return this.app.constants.show_marquee?this.react_timeline.setProps({show_marquee:!0}):void 0},i.prototype._on_log_first_item=function(e){var t;return!this.logged_first_item&&window.performance&&window.performance.timing?(t=Date.now()-window.performance.timing.navigationStart,m.log_carousel(m.WEBAPP_GALLERY_TIME_FIRST_ITEM,{time:t,num_items_in_event:e.event.num_items,num_events:this.log_num_events,num_items:this.log_num_items}),this.logged_first_item=!0):void 0},i.prototype._on_scrolling=function(e){return this.window_width=e.window_width,this.window_height=e.window_height,this.scroll_top=e.scroll_top,this.scroll_position=this.scroll_top+this.window_height/2,this.app.thumb_loading_manager.set_viewport({window_height:this.window_height,scroll_position:this.scroll_position}),this.current_viewport_request&&Math.abs(this.scroll_position-this.current_viewport_request.scroll_position)>this.window_height&&this._cancel_viewport_request(),y.hide()},i.prototype._on_scroll_bottom=function(){return this.reverse_order?void 0:y.show()},i.prototype._on_long_stopped_scrolling=function(){return this._fetch_background_batch()},i.prototype._on_request_data_for_events_in_viewport=function(e){var t,s,n,r,_,a,l,u,h,c,p,d,m,g,f,b,v,w,y,k,x,E,T,P,S,N;for(_=function(){var t,i,s;for(s=[],t=0,i=e.length;i>t;t++)n=e[t],n.event_data_received||s.push(n);return s}(),a=[],g=0,w=_.length;w>g;g++){if(n=_[g],u=!1,null!=this.current_viewport_request)for(E=this.current_viewport_request.events,f=0,y=E.length;y>f;f++)r=E[f],n===r&&(u=!0);if(n.is_missing_dates())for(T=this.background_batch_requests,b=0,k=T.length;k>b;b++)m=T[b],m.events[0]===n&&(u=!0);u||a.push(n)}for(p=this.remaining_events.length,c=-1,s=!1,v=0,x=e.length;x>v;v++)n=e[v],P=o(this.remaining_events,function(){return function(e){return i.event_comparator(e,n)}}(this)),t=P[0],l=P[1],t&&(s=!0,p>l&&(p=l),l>c&&(c=l));return s&&this.remaining_events.splice(p,c-p+1),a.length&&(this.current_viewport_request=this._make_request_for_event_batch(a,h=!1,{prioritize_batch:!0}),i.debug("fetching viewport batch ...","scroll position:",null!=(S=this.current_viewport_request)?S.scroll_position:void 0,"events:",{events:null!=(N=this.current_viewport_request)?N.events:void 0})),this._fetch_background_batch(d=!0),this.app.thumb_loading_manager.fetch_thumbs_around_viewport(this.item_store)},i.prototype._add_events_in_order=function(e){return i._add_events_in_order_helper({events:e,remaining_events:this.remaining_events})},i._add_events_in_order_helper=function(e){var t,s,n,r,_,a,l,u,h,c,p;for(n=e.events,u=e.remaining_events,n.sort(i.event_comparator),a=null,r=[],h=0,c=n.length;c>h;h++)s=n[h],p=o(u,function(){return function(e){return i.event_comparator(e,s)}}(this)),t=p[0],_=p[1],t||(_===a?r.push(s):(null!=a?(l=r.length,i._insert_events(u,r,a),a=_+l):a=_,r=[s]));return r.length?i._insert_events(u,r,a):void 0},i._insert_events=function(e,t,i){return t.unshift(0),t.unshift(i),e.splice.apply(e,t)},i.prototype._fetch_background_batch=function(e){var t,s,o;return this.background_batch_requests.length>=this.MAX_BACKGROUND_REQUESTS&&e&&this._cancel_furthest_background_batch(),s=this._get_next_background_batch(),s?(o=this._make_request_for_event_batch(s,t=!0),i.debug("fetching background batch ...","scroll position:",null!=o?o.scroll_position:void 0,"events:",{events:null!=o?o.events:void 0})):void 0},i.prototype._cancel_furthest_background_batch=function(){var e,t,s,o,n,r,_;for(e=null,t=0,_=this.background_batch_requests,n=0,r=_.length;r>n;n++)s=_[n],o=Math.abs(this.scroll_position-s.scroll_position),o>t&&(t=o,e=s);return t>3*this.window_height?(i.debug("cancelling background batch ...","scroll position:",e.scroll_position,"events:",{events:e.events}),e.cancel_request(),this._add_events_in_order(e.events),this._remove_background_request(e)):void 0},i.prototype._remove_background_request=function(e){var t;return t=this.background_batch_requests.indexOf(e),t>=0?this.background_batch_requests.splice(t,1):void 0},i.prototype._get_next_background_batch=function(){return 0===this.remaining_events.length||this.background_batch_requests.length>=this.MAX_BACKGROUND_REQUESTS?void 0:i._get_next_background_batch_helper({max_batch_size:this.BACKGROUND_BATCH_SIZE,remaining_events:this.remaining_events,scroll_position:this.scroll_position})},i._get_next_background_batch_helper=function(e){var t,s,n,r,_,a,l,u,h,c,p,d,m,g,f;for(c=e.max_batch_size,p=e.remaining_events,d=e.scroll_position,null==d&&(d=0),m={midpoint:d},f=o(p,function(e){return i.event_comparator(e,m)}),s=f[0],a=f[1],_=[],t=0,h=a,g=a-1;c>t&&(n=p[h-1],l=p[g+1],n||l);)r=n&&Math.abs(d-n.midpoint),u=l&&Math.abs(d-l.midpoint),!l||u>r?(t+=p[h-1].num_items,h--):(t+=p[g+1].num_items,g++);return _=p.splice(h,g-h+1)},i.prototype._make_request_for_event_batch=function(e,t,s){var o,n,r,_,a,l,u,h,c,p,d,f,v,y,k,x,E;for(o=e.filter(function(e){return!e.is_missing_dates()}),a=null,p=0,y=e.length;y>p;p++)r=e[p],r.is_missing_dates()&&(a=r);_="faces"in this.app.constants,c=[],n=null,o.length>0&&(n=new b(this.scroll_position,o,t,{include_faces:_}),c.push(n)),a&&(l=new w(this.scroll_position,a,this.md_cursors,{include_faces:_}),c.push(l));for(d=0,k=c.length;k>d;d++)u=c[d],u.is_background_request&&this.background_batch_requests.push(u);for(this.logged_first_visible_events||t||g.start(m.WEBAPP_GALLERY_TIME_FIRST_VISIBLE_EVENTS),f=0,x=c.length;x>f;f++)h=c[f],h.set_callbacks({success:function(e){return function(o,n,_){var a,l,u,h,c,p,d,f,b;if(null==_&&(_=!1),!e.logged_first_visible_events){for(u=g.stop(m.WEBAPP_GALLERY_TIME_FIRST_VISIBLE_EVENTS),l=0,h=0,c=o.length;c>h;h++)a=o[h],l+=null!=(f=a.item_data)?f.length:void 0;m.log_carousel(m.WEBAPP_GALLERY_TIME_FIRST_VISIBLE_EVENTS,{time:u,num_events:o.length,num_items:l}),e.logged_first_visible_events=!0}if(i.debug("REQUEST SUCCESS:",t?"BACKGROUND ...":"VIEWPORT ...","scroll position:",n.scroll_position,"events:",{events:n.events}),e._on_events_data_received(o,s),!_)for(b=n.events,d=0,p=b.length;p>d;d++)r=b[d],r.event_data_received=!0;return n.is_background_request&&!_&&e._remove_background_request(n),e._fetch_background_batch()}}(this),error:function(e){return function(i,s){return-1!==i.statusText.indexOf("abort")||t||s.retry(),s.is_background_request&&e._remove_background_request(s),e._add_events_in_order(s.events)}}(this)});for(v=0,E=c.length;E>v;v++)h=c[v],h.send_request();return n},i.prototype._cancel_viewport_request=function(){return this.current_viewport_request?(this.current_viewport_request.cancel_request(),this._add_events_in_order(this.current_viewport_request.events),delete this.current_viewport_request,i.debug("cancelling viewport request")):void 0},i.prototype._on_events_data_received=function(e){var t,i,s,o,n,r,a,l,u,h,c,p,d,f,b,v,w,y;for(r=[],u=0,d=e.length;d>u;u++)if(t=e[u],!t.gone&&(i=_.getEventId(t),s=this.event_store.get_event_by_event_id(i),null!=s&&!s.event_data_received)){for(o=s.item_data||[],v=t.item_data,h=0,f=v.length;f>h;h++)a=v[h],a.event=s,a=this.app.item_store.add_item_data_if_viewable(a,l=!0),null!=a&&(this.app.constants.use_retina||(a.thumbnail_url=a.original_thumbnail_url),o.push(a));t.item_data=o,s.is_missing_dates()||(t.num_items=o.length),r.push(t)}for(n=this.event_store.update_events(r),c=n.length-1;c>=0;c+=-1)if(t=n[c],!t.event_data_received)for(w=t.item_data,p=0,b=w.length;b>p;p++)a=w[p],y=a.item_gid,a.thumbnail_url=__indexOf.call(t.hero_gids,y)>=0?a.get_2x_thumbnail_url():a.get_thumbnail_url_by_size(t.thumb_size);return this.app.thumb_loading_manager.fetch_thumbs_around_viewport(this.item_store),this.logged_first_visible_thumbs_batch?void 0:g.start(m.WEBAPP_GALLERY_TIME_FIRST_VISIBLE_THUMBS_BATCH)},i.prototype._on_select_all=function(e){var t,i;return t=this.event_store.get_event_by_event_id(e),null!=t?(i=t.num_items-t.num_selected,t.num_selected!==t.num_items?(this.item_store.select_items(t.item_data),m.log_carousel(m.WEBAPP_GALLERY_SELECT_EVENT,this.logging_extras)):(this.item_store.deselect_items(t.item_data),m.log_carousel(m.WEBAPP_GALLERY_DESELECT_EVENT,this.logging_extras))):void 0},i.prototype._on_click_item=function(e){return this.unbind_scroll(),this.lightbox.open_at_item(e)},i.prototype._on_items_deleted=function(e){var t,i,s,o,n,r;for(r=[],o=0,n=e.length;n>o;o++)s=e[o],t=s.event,i=_.getEventId(t),this.app.item_store._remove_item(t.item_data,s),t.num_items=t.item_data.length,r.push(0===t.num_items?this.event_store.remove_event(t):void 0);return r},i.prototype.show=function(e){var t,i;return t=e.reply_mode,
this.shown=!0,this.reply_mode=t,this.reply_mode?(this.$container.addClass("reply-mode"),this.lightbox.set_logging_extra("gallery_mode","add_photos")):(this.$container.removeClass("reply-mode"),this.lightbox.set_logging_extra("gallery_mode","gallery")),this.app.set_shared_item_store(this.item_store),this.app.share_cart.set_reply_mode(t),this.$container.show(),this.app.constants.timeline_navigation&&null!=(i=this.react_timeline_navigation)?i.setProps({update_markers:!0,bind_events:!0}):void 0},i.prototype.hide=function(){var e;return this.shown=!1,this.$container.hide(),this.lightbox.close(),this.app.constants.timeline_navigation&&null!=(e=this.react_timeline_navigation)?e.setProps({update_markers:!1,bind_events:!1}):void 0},i.prototype.lightbox_closed_at_item=function(e){return this.react_timeline.setProps({highlighted_item:e})},i}()});var __indexOf=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/photos/carousel_app/react_item",["jquery","external/react","modules/clean/css","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/carousel_app/carousel_item","modules/clean/react/sprite","modules/clean/react/image","modules/clean/photos/carousel_app/shared_space_text"],function(e,t,i,s,o,n,r,_){var a,l;return l=_.get_likees_text,a=t.DOM,t.createClass({displayName:"ReactPhoto",getDefaultProps:function(){return{show_checkmark_on_hover:!0}},getInitialState:function(){return{show_like:!1}},propTypes:{item:t.PropTypes.object,wiggobble_timeout_id:t.PropTypes.number,width:t.PropTypes.oneOfType([t.PropTypes.string,t.PropTypes.number]),height:t.PropTypes.oneOfType([t.PropTypes.string,t.PropTypes.number]),hide_thumb_by_hover:t.PropTypes.bool,show_colors_grid:t.PropTypes.bool,is_selectable:t.PropTypes.bool,on_click_item:t.PropTypes.func,on_select_item:t.PropTypes.func,show_context_menu_for_item:t.PropTypes.func,on_item_did_mount:t.PropTypes.func,allow_like:t.PropTypes.bool,on_like_item:t.PropTypes.func,on_item_mouse_enter:t.PropTypes.func,on_item_mouse_leave:t.PropTypes.func,always_show_checkmark:t.PropTypes.bool,show_checkmark_on_hover:t.PropTypes.bool},on_select_item:function(e){return e.stopPropagation(),this.props.on_select_item(this.props.item)},on_click_item:function(){return this.props.on_click_item(this.props.item)},on_like:function(e){return e.stopPropagation(),this.props.on_like_item(this.props.item)},on_item_mouse_enter:function(){var t;return this.props.hide_thumb_by_hover&&e(this.refs.img.getDOMNode()).hide(),this.props.allow_like&&this.setState({show_like:!0}),"function"==typeof(t=this.props).on_item_mouse_enter?t.on_item_mouse_enter(this.props.item):void 0},on_item_mouse_leave:function(){var t;return this.props.hide_thumb_by_hover&&e(this.refs.img.getDOMNode()).show(),this.props.allow_like&&this.setState({show_like:!1}),"function"==typeof(t=this.props).on_item_mouse_leave?t.on_item_mouse_leave(this.props.item):void 0},on_contextmenu:function(e){return this.props.show_context_menu_for_item({item:this.props.item,top:e.clientY,left:e.clientX}),!1},componentDidMount:function(){var t;return e(this.getDOMNode()).bind("contextmenu",this.on_contextmenu),"function"==typeof(t=this.props).on_item_did_mount?t.on_item_did_mount(this.props.item):void 0},componentWillUnmount:function(){var t,i;return e(this.getDOMNode()).unbind("contextmenu",this.on_contextmenu),this.props.wiggobble_timeout_id&&clearTimeout(this.props.wiggobble_timeout_id),null!=(t=this.props.item)?t.last_wiggobble=null!=(i=this.props.item)?i.wiggobble:void 0:void 0},render:function(){var e,n,_,u,h,c,p,d,m,g,f,b,v,w,y,k,x,E,T,P,S,N,A,C,D,O,M,I,R,q,L,B,$,j,W,z,H,U,G,F,V,X,Y,K,J,Z,Q,ee,te;return f=null!=(null!=(S=this.props.item)?S.event:void 0)&&(N=null!=($=this.props.item)?$.item_gid:void 0,__indexOf.call(null!=(Y=this.props.item)?Y.event.hero_gids:void 0,N)>=0),P=(null!=(K=this.props.item)?K.wiggobble:void 0)!==(null!=(J=this.props.item)?J.last_wiggobble:void 0),u="event-thumb",p=t.addons.classSet,h=p({"event-thumb":!0,selected:null!=(Z=this.props.item)?Z.is_selected:void 0,hero:f,dummy:null!=(Q=this.props.item)?Q.is_dummy:void 0,video:null!=(ee=this.props.item)?ee.is_video:void 0,"increase-saturation":!0,"has-likes":(null!=(te=this.props.item)?te.get_num_likes():void 0)>0,"show-checkmark-on-hover":this.props.show_checkmark_on_hover}),n=(null!=(A=this.props.item)?A.image_data:void 0)?i.css_url(null!=(C=this.props.item)?C.image_data:void 0):"",d=!!(null!=(D=this.props.item)?D.image_data:void 0),s().constants.use_batch_thumb_loader||(n=i.css_url(null!=(O=this.props.item)?O.thumbnail_url:void 0),d=!0),g=p({thumbnail:!0,wiggobble:P,"has-image-data":d}),_=p({checkmark:!0,"show-checkmark":this.props.is_selectable,"always-show-checkmark":this.props.always_show_checkmark}),w=p({"likes-wrapper":!0,"show-likes-wrapper":this.state.show_like}),v=p({"likes-counter":!0,"owner-is-user":null!=(M=this.props.item)?M.owner_is_user:void 0}),b=p({"like-icon":!0,liked:null!=(I=this.props.item)?I.like_status:void 0}),T=f?o.HERO_THUMB_SIZE:(null!=(R=this.props.item.event)?R.thumb_size:void 0)||o.DEFAULT_THUMB_SIZE,P&&(this.props.wiggobble_timeout_id&&clearTimeout(this.props.wiggobble_timeout_id),this.props.wiggobble_timeout_id=setTimeout(function(e){return function(){var t,i;return null!=(t=e.props.item)&&(t.last_wiggobble=null!=(i=e.props.item)?i.wiggobble:void 0),e.props.wiggobble_timeout_id=null}}(this),1e3)),a.div({className:h,style:{top:null!=(q=this.props.item)?q.top:void 0,left:null!=(L=this.props.item)?L.left:void 0,width:this.props.width||T,height:this.props.height||T,position:null!=(null!=(B=this.props.item)?B.top:void 0)&&null!=(null!=(j=this.props.item)?j.left:void 0)?"absolute":"relative"},onClick:this.on_click_item,onMouseEnter:this.on_item_mouse_enter,onMouseLeave:this.on_item_mouse_leave},this.props.show_colors_grid&&null!=(null!=(W=this.props.item)?W.rgb_4x4_signature:void 0)?(x=null!=(z=this.props.item)?z.rgb_4x4_signature:void 0,a.div({style:{width:"100%",height:"100%",position:"relative"}},function(){var e,t,i,s,o;for(s=null!=(i=this.props.item)?i.rgb_4x4_signature:void 0,o=[],m=e=0,t=s.length;t>e;m=e+=3)k=s[m],E=Math.floor(m/3/4),c=m/3%4,o.push(a.div({style:{position:"absolute",top:25*E+"%",left:25*c+"%",width:"25%",height:"25%",backgroundColor:"rgb("+x[m]+","+x[m+1]+","+x[m+2]+")"}}));return o}.call(this))):null!=(null!=(H=this.props.item)?H.average_rgb:void 0)?(e=null!=(U=this.props.item)?U.average_rgb:void 0,a.div({className:"color-saturate",style:{width:"100%",height:"100%",position:"absolute",backgroundColor:"rgb("+e.r+","+e.g+","+e.b+")"}})):void 0,a.div({className:g,ref:"img",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",backgroundImage:n,backgroundSize:""+(this.props.width||T)+"px "+(this.props.height||T)+"px",backgroundPosition:"center",WebkitTransform:"translateZ(0)"}}),s().constants.debug_thumbs?(y=1,null!=(null!=(G=this.props.item)?G.average_rgb:void 0)?(k=null!=(F=this.props.item)?F.average_rgb:void 0,y=(.2126*k.r+.7152*k.g+.0722*k.b)/255):void 0,a.div({style:{padding:"20px",position:"absolute",width:"100%",boxSizing:"border-box",color:y>.5?"black":"white"}},this.props.item?this.props.item.image_data?void 0:this.props.item.get_thumb_request_finished_time_ago()?"Request finished "+this.props.item.get_thumb_request_finished_time_ago()+" seconds ago":this.props.item.get_thumb_requested_time_ago()?"Requested "+this.props.item.get_thumb_requested_time_ago()+" seconds ago":this.props.item.get_thumb_queued_time_ago()?"Queued "+this.props.item.get_thumb_queued_time_ago()+" seconds ago":"Not queued":"No item")):void 0,a.div({className:_,onClick:this.on_select_item},a.img({className:"selected-checkmark",src:"/static/images/carousel/select_checked-vfl4QqD9g.png"}),a.img({className:"unselected-checkmark",src:"/static/images/carousel/select_unchecked-vflKGtIQO.png"})),this.props.allow_like?a.div({className:w},(null!=(V=this.props.item)?V.get_num_likes():void 0)>0?a.div({className:v},l(this.props.item)):void 0,(null!=(X=this.props.item)?X.owner_is_user:void 0)?void 0:a.div({className:b,onClick:this.on_like},r({src:"/images/carousel/like.png"}))):void 0)}})}),define("modules/clean/photos/carousel_app/react_lightbox_actions_overlay",["jquery","external/react","modules/clean/photos/carousel_app/shared_space_text","modules/clean/gandalf_util","modules/clean/photos/carousel_app/item_actions","modules/clean/react/sprite","modules/core/types","modules/core/i18n"],function(e,t,i,s,o,n,r,_){var a,l,u,h,c,p,d;return p=i.get_likees_text,a=r.Enum,c=t.DOM,d=_.i18n_default_project("carousel-web")._,h=new a("Visibility",{FADEIN:"fadein",FADEOUT:"fadeout",HIDE:"hide"}),u=new a("ToolbarEntryType",{ROTATE_CCW:"rotate-ccw",ROTATE_CW:"rotate-cw",FULLSCREEN:"fullscreen"}),l=t.createFactory(t.createClass({displayName:"ReactLightboxActionsOverlay",getInitialState:function(){return{visibility:h.HIDE,allow_image_editing:!1,fullscreen:!1}},getDefaultProps:function(){return{show_checkmark:!1,show_like:!1,show_editing_toolbar:!1,fullscreen:!1,on_click:null}},propTypes:{item:t.PropTypes.object,show_checkmark:t.PropTypes.bool,show_like:t.PropTypes.bool,show_editing_toolbar:t.PropTypes.bool,fullscreen:t.PropTypes.bool,on_click:t.PropTypes.func,on_toggle_checkmark:t.PropTypes.func,on_like:t.PropTypes.func,on_show_likers:t.PropTypes.func,on_enter_fullscreen:t.PropTypes.func},componentWillReceiveProps:function(e){var t;return e.item&&e.item!==this.props.item?(t=s.getGandalfRule("carousel-image-editing")&&e.item.is_editable,this.setState({allow_image_editing:t}),this.fadeIn()):void 0},componentWillUnmount:function(){return clearTimeout(this._fadeOutTimeoutId),clearTimeout(this._idleTimeoutId)},_FADE_TIME_MSEC:400,_IDLE_TIME_MSEC:1500,_fadeOutTimeoutId:null,_idleTimeoutId:null,fadeIn:function(){return clearTimeout(this._idleTimeoutId),clearTimeout(this._fadeOutTimeoutIds),this.props.fullscreen?void 0:(this.setState({visibility:h.FADEIN}),this._idleTimeoutId=setTimeout(function(e){return function(){return e.fadeOut()}}(this),this._IDLE_TIME_MSEC))},fadeOut:function(){return clearTimeout(this._fadeOutTimeoutId),this.setState({visibility:h.FADEOUT}),this._fadeOutTimeoutId=setTimeout(function(e){return function(){return e.setState({visibility:h.HIDE})}}(this),this._FADE_TIME_MSEC)},on_mouse_enter:function(){return this.fadeIn()},on_mouse_leave:function(){return clearTimeout(this._idleTimeoutId),this.fadeOut()},on_mouse_move:function(){return this.fadeIn()},on_mouse_enter_actions:function(e){return e.stopPropagation(),clearTimeout(this._idleTimeoutId)},on_toggle_checkmark:function(e){var t;return e.stopPropagation(),"function"==typeof(t=this.props).on_toggle_checkmark?t.on_toggle_checkmark():void 0},on_like:function(e){var t;return e.stopPropagation(),"function"==typeof(t=this.props).on_like?t.on_like():void 0},on_show_likers:function(e){var t;return e.stopPropagation(),"function"==typeof(t=this.props).on_show_likers?t.on_show_likers():void 0},on_mouse_click_toolbar_entry:function(e,t){var i;switch(e.stopPropagation(),t){case u.ROTATE_CCW:if(this.state.allow_image_editing)return o.rotate_counter_cw(this.props.item);break;case u.ROTATE_CW:if(this.state.allow_image_editing)return o.rotate_cw(this.props.item);break;case u.FULLSCREEN:return this.fadeOut(),"function"==typeof(i=this.props).on_enter_fullscreen?i.on_enter_fullscreen():void 0}},_render_toolbar_entry:function(e,t,i,s){var o;return o=!this.state.allow_image_editing&&(e===u.ROTATE_CCW||e===u.ROTATE_CW),c.div({className:""+e+" toolbar-entry",onClick:function(t){return function(i){return t.on_mouse_click_toolbar_entry(i,e)}}(this)},c.div({className:"toolbar-tooltip-container"},c.div({className:"tooltip-body"},s)),c.div({className:"toolbar-tooltip-container"},c.div({className:"tooltip-arrow"})),n({group:t,name:i,className:o?"disabled":""}))},render:function(){var e,i,s;return this.props.item?(i=t.addons.classSet,e=this.state.visibility+" "+i({"lightbox-checkmark":!0,selected:this.props.item.is_selected}),s=this.state.visibility+" "+i({"lightbox-like-wrapper":!0,liked:this.props.item.like_status}),c.div({className:"lightbox-actions-overlay-container",onMouseEnter:this.on_mouse_enter,onMouseMove:this.on_mouse_move,onMouseLeave:this.on_mouse_leave,onClick:this.props.on_click},this.props.show_checkmark?c.div({className:e,onMouseEnter:this.on_mouse_enter_actions,onMouseMove:this.on_mouse_enter_actions,onClick:this.on_toggle_checkmark},c.img({className:"selected-checkmark",src:"/static/images/carousel/select_checked-vfl4QqD9g.png"}),c.img({className:"unselected-checkmark",src:"/static/images/carousel/select_unchecked-vflKGtIQO.png"})):void 0,this.props.show_like?c.div({className:s,onMouseEnter:this.on_mouse_enter_actions,onMouseMove:this.on_mouse_enter_actions},this.props.item.get_num_likes()>0?c.div({className:"lightbox-like-counter"},c.span({className:"lightbox-like-counter-likers",onClick:this.on_show_likers},p(this.props.item))):void 0,c.div({className:"lightbox-like-icon",onClick:this.on_like},c.img({src:"/static/images/carousel/like-vfls3fVOj.png"}))):void 0,this.props.show_editing_toolbar?c.div({className:"lightbox-toolbar-wrapper "+this.state.visibility,onMouseEnter:this.on_mouse_enter_actions,onMouseMove:this.on_mouse_enter_actions},this._render_toolbar_entry(u.ROTATE_CCW,"carousel","editing_rotate_ccw_icon",d("Rotate counter clockwise")),this._render_toolbar_entry(u.ROTATE_CW,"carousel","editing_rotate_cw_icon",d("Rotate clockwise")),this._render_toolbar_entry(u.FULLSCREEN,"web","fullscreen",d("Fullscreen"))):void 0)):c.div()}}))}),define("modules/clean/photos/carousel_app/react_marquee",["jquery","external/react"],function(e,t){var i;return i=t.DOM,t.createClass({displayName:"ReactMarquee",getInitialState:function(){return{show:!1}},propTypes:{parent:t.PropTypes.object.isRequired,item_store:t.PropTypes.object.isRequired,visible_items:t.PropTypes.array},componentDidMount:function(){return this.pressed=!1,e(document).bind("mousedown",this._on_document_mouse_down),e(document).bind("mousemove",this._on_document_mouse_move),e(document).bind("mouseup",this._on_document_mouse_up)},componentDidUnmount:function(){return e(document).unbind("mousedown",this._on_document_mouse_down),e(document).unbind("mousemove",this._on_document_mouse_move),e(document).unbind("mouseup",this._on_document_mouse_up)},componentDidUpdate:function(){var t;return this.$marquee_div=e(this.refs["gallery-marquee"].getDOMNode()),t=e(this.props.parent.getDOMNode()).offset(),this.offset_left=t.left,this.offset_top=t.top},_on_document_mouse_down:function(e){return this.isMounted()?(this.setState({width:0,height:0,top:e.clientY,left:e.clientX,original_y:e.clientY,original_x:e.clientX}),this.pressed=!0):void 0},_on_document_mouse_move:function(e){var t,i,s,o,n;return this.isMounted()?(o=this.state.original_x,n=this.state.original_y,s=Math.abs(e.clientX-this.state.original_x),t=Math.abs(e.clientY-this.state.original_y),e.clientX<this.state.original_x&&(o=e.clientX),e.clientY<this.state.original_y&&(n=e.clientY),i=!1,(this.state.width>10||this.state.height>10)&&this.pressed&&(i=!0),this.setState({width:s,height:t,top:n,left:o,show:i}),this._check_collision()):void 0},_on_document_mouse_up:function(){var e;return this.isMounted()&&(this.setState({show:!1}),this.pressed=!1,(this.state.width>10||this.state.height>10)&&(null!=(e=this.items)?e.length:void 0))?this.props.item_store.select_items(this.items):void 0},_check_collision:function(){var t,i,s,o,n,r,_,a,l,u,h,c,p,d;if(r=e(document).scrollTop(),_=this.state.left-this.offset_left,a=_+this.state.width,l=this.state.top-this.offset_top+r,u=l+this.state.height,this.items=[],(a-_>100||u-l>100)&&this.props.visible_items.length){for(p=this.props.visible_items,d=[],h=0,c=p.length;c>h;h++)t=p[h],i=t.left,s=i+t.width,o=t.top,n=o+t.height,d.push(u>=o&&n>=l&&a>=i&&s>=_?this.items.push(t):void 0);return d}},render:function(){var e,s;return s=t.addons.classSet,e=s({"gallery-marquee":!0,"show-gallery-marquee":this.state.show}),i.div({className:e,ref:"gallery-marquee",style:{width:this.state.width,height:this.state.height,top:this.state.top,left:this.state.left}})}})});var __indexOf=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/photos/carousel_app/react_timeline",["jquery","modules/clean/ajax","external/react","modules/clean/react/modal","modules/clean/photos/carousel_app/gallery_context_menu","modules/clean/photos/carousel_app/react_event_to_merge_rows","modules/clean/photos/carousel_app/react_item","modules/clean/photos/carousel_app/selection_limit_modal","modules/clean/photos/carousel_app/store_event","modules/clean/photos/photos_engagement_logger","modules/clean/photos/carousel_app/react_marquee","modules/clean/photos/carousel_app/item_store","modules/core/dom"],function(e,t,i,s,o,n,r,_,a,l,u,h,c){var p,d;return p=s.SimpleModal,d=i.DOM,i.createClass({displayName:"ReactTimeline",getInitialState:function(){return{thumbs_per_row:0,thumbs_per_hero:0,visible_events:[],visible_items:[],current_event:{},is_scrolling:!1,show_timeline_bubble:!1,window_width:0,window_height:0,width:0,height:0,event_select_width:null,event_deselect_width:null}},getDefaultProps:function(){return{min_thumbs_per_row:4,resize_thumbs:!0,round_thumb_size:!1,prevent_small_merges:!1,indent_titles:!1,show_heros:!0,rows_per_hero:3,thumb_size:256,max_thumb_size:512,include_faces:!1,min_page_margin:50,events:[],event_store:{},event_header_height:114,share_cart_height:76,num_extra_rows:4,positions_index_size:1e3,on_select_all:null,on_click_item:null,on_scrolling:null,on_scroll_bottom:null,on_long_stopped_scrolling:null,on_request_data_for_events:null,highlighted_item:null,bind_scroll:!0,on_item_did_mount:null,scroll_perf:!1,logging_extras:{},show_timeline_label:!0,albums_allowed:!1,hide_thumb_by_hover:!1,show_colors_grid:!1,is_selectable:!0,show_marquee:!1,show_event_header:!0,allow_like:!1,reverse_order:!0}},propTypes:{page:i.PropTypes.oneOf(["timeline","album","shared_album"]),min_thumbs_per_row:i.PropTypes.number,resize_thumbs:i.PropTypes.bool,round_thumb_size:i.PropTypes.bool,prevent_small_merges:i.PropTypes.bool,indent_titles:i.PropTypes.bool,show_heros:i.PropTypes.bool,rows_per_hero:i.PropTypes.number,thumb_size:i.PropTypes.number,max_thumb_size:i.PropTypes.number,include_faces:i.PropTypes.bool,min_page_margin:i.PropTypes.number,events:i.PropTypes.arrayOf(i.PropTypes.object).isRequired,event_store:i.PropTypes.object,event_header_height:i.PropTypes.number,num_extra_rows:i.PropTypes.number,positions_index_size:i.PropTypes.number,on_select_all:i.PropTypes.func.isRequired,on_click_item:i.PropTypes.func.isRequired,on_scrolling:i.PropTypes.func,on_scroll_bottom:i.PropTypes.func,on_long_stopped_scrolling:i.PropTypes.func,on_request_data_for_events:i.PropTypes.func,highlighted_item:i.PropTypes.object,bind_scroll:i.PropTypes.bool,on_item_did_mount:i.PropTypes.func,scroll_perf:i.PropTypes.bool,show_timeline_label:i.PropTypes.bool,albums_allowed:i.PropTypes.bool,on_width_change:i.PropTypes.func,hide_thumb_by_hover:i.PropTypes.bool,show_colors_grid:i.PropTypes.bool,is_selectable:i.PropTypes.bool,show_marquee:i.PropTypes.bool,disable_context_menu:i.PropTypes.bool,show_event_header:i.PropTypes.bool,allow_like:i.PropTypes.bool,on_like_item:i.PropTypes.func,scroll_container_selector:i.PropTypes.string,item_store:i.PropTypes.instanceOf(h),share_cart_height:i.PropTypes.number,logging_extras:i.PropTypes.object,reverse_order:i.PropTypes.bool},_get_scroll_container:function(){return e(this.props.scroll_container_selector?this.props.scroll_container_selector:document)},componentDidMount:function(){return this.num_thumbs_pushed_per_hero=3,e(window).bind("resize",this._on_resize),this.props.bind_scroll&&(this._get_scroll_container().bind("mousewheel",this._on_mousewheel),this._get_scroll_container().bind("scroll",this._on_scroll)),this._reset(),e(document).bind("keydown",this._on_document_key_down),e(document).bind("keyup",this._on_document_key_up)},componentWillUnmount:function(){return e(window).unbind("resize",this._on_resize),this._get_scroll_container().unbind("mousewheel",this._on_mousewheel),this._get_scroll_container().unbind("scroll",this._on_scroll),e(document).unbind("keydown",this._on_document_key_down),e(document).unbind("keyup",this._on_document_key_up),this._clean_up(this.props)},componentDidUpdate:function(e){var t,i;return e.item_store!==this.props.item_store?(this._clean_up(e),this._reset()):(null!=(t=e.highlighted_item)?t.item_gid:void 0)!==(null!=(i=this.props.highlighted_item)?i.item_gid:void 0)&&this._highlight(this.props.highlighted_item),e.bind_scroll&&!this.props.bind_scroll?(this._get_scroll_container().unbind("mousewheel",this._on_mousewheel),this._get_scroll_container().unbind("scroll",this._on_scroll)):!e.bind_scroll&&this.props.bind_scroll?(this._get_scroll_container().bind("mousewheel",this._on_mousewheel),this._get_scroll_container().bind("scroll",this._on_scroll)):void 0},_reset:function(){var e,t,i,s,o;return this.positions_index={top:[],bottom:[]},this.initial_events_received=!1,this._reset_grid_params(),this._update_events(),this.props.reverse_order?this.scroll_top=c.scroll_offsets().top:(this.scroll_top=c.document_height()-c.viewport_dimensions().height,setTimeout(function(e){return function(){return e.scroll_top=c.document_height()-c.viewport_dimensions().height,c.scroll_to(0,e.scroll_top)}}(this),0),"function"==typeof(i=this.props).on_scrolling&&i.on_scrolling({window_width:this.max_width,window_height:this.window_height,scroll_top:this.scroll_top})),this._render_visible_items(t=!0,e=!1),null!=(o=this.props.event_store)&&o.on(a.EVENTS_CHANGED,this._on_event_store_changed),this.props.item_store.on(a.SELECTED_CHANGED,this._on_item_store_changed),this.props.item_store.on(a.ITEMS_CHANGED,this._on_item_store_changed),this.props.item_store.on(a.ITEMS_DELETED,this._on_items_deleted),"function"==typeof(s=this.props).on_request_data_for_events?s.on_request_data_for_events(this.state.visible_events):void 0},_reset_grid_params:function(){var t;return this.max_width=this._get_scroll_container().width(),this.window_height=e(window).height(),this.thumbs_per_row=Math.floor((this.max_width-2*this.props.min_page_margin)/this.props.thumb_size),this.thumbs_per_row<this.props.min_thumbs_per_row&&(this.thumbs_per_row=this.props.min_thumbs_per_row),this.thumbs_per_hero=this.props.rows_per_hero*this.thumbs_per_row-this.num_thumbs_pushed_per_hero,this.setState({width:this.thumbs_per_row*this.props.thumb_size}),"function"==typeof(t=this.props).on_width_change?t.on_width_change(this.thumbs_per_row*this.props.thumb_size):void 0},_clean_up:function(e){var t;return null!=(t=e.event_store)&&t.off(a.EVENTS_CHANGED,this._on_event_store_changed),e.item_store.off(a.SELECTED_CHANGED,this._on_item_store_changed),e.item_store.off(a.ITEMS_CHANGED,this._on_item_store_changed),e.item_store.off(a.ITEMS_DELETED,this._on_items_deleted),clearTimeout(this.slow_scroll_timeout_id),clearTimeout(this.timeline_bubble_timeout_id),clearTimeout(this.fetching_timeout_id)},_highlight:function(e){return e?(this._scroll_to_item(e),e.wiggobble++):void 0},_scroll_to_item:function(e){var t,i,s;return t=this.props.share_cart_height,s=this.scroll_top+this.props.share_cart_height,i=this.scroll_top+this.window_height,e.top+t+this.props.thumb_size/2>i?this._get_scroll_container().scrollTop(e.top-this.window_height+this.props.thumb_size+t):e.bottom+t-this.props.thumb_size/2<s?this._get_scroll_container().scrollTop(e.top-t):void 0},_on_resize:function(){var e;return this._reset_grid_params(),this._update_events(),this._render_visible_items(e=!0)},_on_mousewheel:function(){var t,i;return this.scroll_top>=e(document).height()-this.window_height-1&&"function"==typeof(i=this.props).on_scroll_bottom&&i.on_scroll_bottom(),this.props.scroll_container_selector?(t=this._get_scroll_container(),t.scrollTop(t.scrollTop()+event.deltaY),this._on_scroll(),!1):void 0},_on_scroll:function(){var e;return this.animation_frame_requested||requestAnimationFrame(this._on_animation_frame),this.animation_frame_requested=!0,this.scroll_top=this._get_scroll_container().scrollTop(),this.is_scrolling=!0,clearTimeout(this.slow_scroll_timeout_id),clearTimeout(this.timeline_bubble_timeout_id),clearTimeout(this.fetching_timeout_id),this.slow_scroll_timeout_id=setTimeout(function(e){return function(){var t;return e.is_scrolling=!1,e.setState({is_scrolling:!1}),"function"==typeof(t=e.props).on_request_data_for_events&&t.on_request_data_for_events(e.state.visible_events),e.timeline_bubble_timeout_id=setTimeout(function(){return e.setState({show_timeline_bubble:!1})},1200)}}(this),200),this.fetching_timeout_id=setTimeout(function(e){return function(){var t;return"function"==typeof(t=e.props).on_long_stopped_scrolling?t.on_long_stopped_scrolling():void 0}}(this),1e3),this.hide_context_menu(),"function"==typeof(e=this.props).on_scrolling?e.on_scrolling({window_width:this.max_width,window_height:this.window_height,scroll_top:this.scroll_top}):void 0},_on_document_key_down:function(e){switch(e.keyCode){case 16:return this.pressed_shift=!0}},_on_document_key_up:function(e){switch(e.keyCode){case 16:return this.pressed_shift=!1}},_on_event_store_changed:function(e){var t,i,s,o,n,r,_,a,l;if(this.isMounted()){if(this.props.scroll_perf)for(r=0,a=e.length;a>r;r++)i=e[r],null!=i.item_data&&this._update_heros(i);else this._update_events();for(o=!1,_=0,l=e.length;l>_;_++)if(i=e[_],__indexOf.call(this.state.visible_events,i)>=0){o=!0;break}return this.initial_events_received?this._render_visible_items(s=o):(this._render_visible_items(s=o,t=!1),this.initial_events_received=!0,"function"==typeof(n=this.props).on_request_data_for_events?n.on_request_data_for_events(this.state.visible_events):void 0)}},_on_item_store_changed:function(e){var t,i,s,o,n;for(this.props.scroll_perf||this._update_events(),i=!1,o=0,n=e.length;n>o;o++)if(s=e[o],__indexOf.call(this.state.visible_items,s)>=0){i=!0;break}return this._render_visible_items(t=i)},_on_items_deleted:function(){var e;return this._update_events(),this._render_visible_items(e=!0)},on_select_item:function(e){var t,i,s,o,n,r,a,u,h;if(a=e.is_selected?!1:!0){if(this.props.item_store.selected_items.length>=_.SELECTION_MAX_SIZE)return void _.show();if(this.pressed_shift&&null!=this.previous_selected_item){if(i=[e],n=this.props.item_store.all_items.indexOf(this.previous_selected_item),r=this.props.item_store.all_items.indexOf(e),r>n)for(s=this.previous_selected_item.next_item;s.item_gid!==e.item_gid;)i.push(s),s=s.next_item;else for(o=this.previous_selected_item.prev_item;o.item_gid!==e.item_gid;)i.push(o),o=o.prev_item;for(u=0,h=i.length;h>u;u++)e=i[u],e.is_selected=!0;this.props.item_store.select_items(i)}else e.is_selected=!0,this.props.item_store.select_item_gid(e.item_gid);l.log_carousel(l.WEBAPP_GALLERY_SELECT_ITEM,this.props.logging_extras),this.previous_selected_item=e}else e.is_selected=!1,this.props.item_store.deselect_item_gid(e.item_gid),l.log_carousel(l.WEBAPP_GALLERY_DESELECT_ITEM,this.props.logging_extras);return this._render_visible_items(t=!0)},on_item_mouse_enter:function(e){return this.on_event_header_mouse_enter(e.event)},on_item_mouse_leave:function(e){return this.on_event_header_mouse_leave(e.event)},show_context_menu_for_item:function(t){var i,s,o;return i=t.item,o=t.top,s=t.left,this.props.disable_context_menu?void 0:(this.setState({context_menu_item:i,context_menu_top:o,context_menu_left:s,show_context_menu:!0}),l.log_carousel(l.WEBAPP_GALLERY_CONTEXT_MENU_SHOWN,e.extend({},this.props.logging_extras,{is_selected:i.is_selected})))},hide_context_menu:function(){return this.state.show_context_menu?this.setState({show_context_menu:!1}):void 0},on_select_all:function(e){var t,i;return i=e.num_items-e.num_selected,this.props.item_store.selected_items.length+i>_.SELECTION_MAX_SIZE?void _.show():(this.props.on_select_all(e.event_id),e.show_select_all=!0,this._render_visible_items(t=!0))},on_event_header_mouse_enter:function(e){var t;return e?(e.show_select_all=!0,this._render_visible_items(t=!0)):void 0},on_event_header_mouse_leave:function(e){var t;return e&&e.num_selected!==e.num_items?(e.show_select_all=!1,this._render_visible_items(t=!0)):void 0},on_event_select_width_changed:function(e){return this.setState({event_select_width:e})},on_event_deselect_width_changed:function(e){return this.setState({event_deselect_width:e})},_update_events:function(){var e,t,i,s,o;for(this._update_events_positions_and_merge_rows(),this._update_positions_index(),s=this.props.events,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push(null!=e.item_data?this._update_heros(e):void 0);return o},_update_events_positions_and_merge_rows:function(){var e,t,i,s,o,n,r,_,a,l,u,h,c,p,d,m,g,f,b,v,w,y,k,x;for(s=0,p=[],d=0,k=this.props.events,f=0,w=k.length;w>f;f++){if(e=k[f],a=0,this.props.show_heros&&!("function"==typeof e.is_missing_dates?e.is_missing_dates():void 0)&&(a=Math.floor(e.num_items/this.thumbs_per_hero)),l=e.num_items+this.num_thumbs_pushed_per_hero*a,u=Math.ceil(l/this.thumbs_per_row),_=l>=this.thumbs_per_row?this.thumbs_per_row:l,g=this._get_thumb_size(_),i=_*g,t=u*g+this.props.event_header_height,e.top="undefined"!=typeof h&&null!==h?h.bottom:0,e.left=0,e.bottom=e.top+t,e.midpoint=(e.top+e.bottom)/2,e.width=i,e.height=t,e.thumb_size=g,e.thumbs_per_row=this.thumbs_per_row,r=d+e.num_items,n=!0,this.props.prevent_small_merges&&null!=p&&p.length)for(o=b=0,x=p.length;x>=0?x>b:b>x;o=x>=0?++b:--b)1!==p[o].num_items&&1!==e.num_items||this._get_thumb_size(r)!==this.props.thumb_size||(n=!1);if(r<=this.thumbs_per_row&&n)for(null!=p[p.length-1]&&(s-=p[p.length-1].height),p.push(e),g=this._get_thumb_size(r),m=g+this.props.event_header_height,s+=m,d+=e.num_items,o=v=0,y=p.length;y>v;o=++v)e=p[o],e.thumb_size=g,e.thumbs_per_row=e.num_items,c=p[o-1],null!=c&&(e.top=c.top,e.left=c.left+c.width),e.bottom=e.top+m,e.midpoint=(e.top+e.bottom)/2,e.width=e.num_items*g,e.height=m;else p=[e],d=e.num_items,s+=e.height;h=e}return this.setState({height:s})},_update_positions_index:function(){var e,t,i,s,o,n,r,_,a,l,u,h,c,p,d,m,g,f;for(l={},e={},a={},d=this.props.events,u=0,p=d.length;p>u;u++){if(t=d[u],_=Math.floor(t.top/this.props.positions_index_size)*this.props.positions_index_size,r=Math.ceil(t.bottom/this.props.positions_index_size)*this.props.positions_index_size,"undefined"!=typeof o&&null!==o){for(n=Math.floor(o.top/this.props.positions_index_size)*this.props.positions_index_size,s=Math.ceil(o.bottom/this.props.positions_index_size)*this.props.positions_index_size,i=h=m=n+this.props.positions_index_size,g=this.props.positions_index_size;g>0?s>=h:h>=s;i=h+=g)null==l[i]&&(l[i]=[]),l[i].push(o);for(i=c=n,f=this.props.positions_index_size;f>0?r>=c:c>=r;i=c+=f)null==e[i]&&(e[i]=[]),e[i].push(t)}null==l[_]&&(l[_]=[]),l[_].push(t),null==e[r]&&(e[r]=[]),e[r].push(t),o=t}return this.positions_index={top:l,bottom:e}},_update_heros:function(e){return e.hero_gids=[],e.hero_indices=[],e.illegal_indices=[],this.props.show_heros&&!("function"==typeof e.is_missing_dates?e.is_missing_dates():void 0)&&(this._choose_heros(e),e.hero_gids.length>0&&(this._rearrange_heros(e),this._set_illegal_indices(e))),this._update_thumbs_positions_and_merge_rows(e)},_choose_heros:function(e){var t,i,s,o,n,r,_,a,l,u;for(i=[],t=[],u=e.item_data,o=r=0,a=u.length;a>r;o=++r)if(n=u[o],t.push(n),t.length===this.thumbs_per_hero){for(s=t[0],_=0,l=t.length;l>_;_++)n=t[_],n.score>s.score&&(s=n);i.push(s.item_gid),s.thumbnail_url=s.get_2x_thumbnail_url(),t=[]}return e.hero_gids=i},_rearrange_heros:function(e){var t,i,s,o,n,r,_,a,l,u,h,c,p,d,m,g,f,b,v,w;for(s=[],v=e.item_data,o=m=0,f=v.length;f>m;o=++m)r=v[o],w=r.item_gid,__indexOf.call(e.hero_gids,w)>=0&&s.push(o);for(u=0,_=[],g=0,b=s.length;b>g;g++)o=s[g],a=o,t=a+u,(t+1)%this.thumbs_per_row===0&&(h=a,a-=1,p=e.item_data[a],e.item_data[a]=e.item_data[h],e.item_data[h]=p),l=Math.floor(o/this.thumbs_per_hero),i=l*this.thumbs_per_hero,n=o-i,c=Math.floor(n/this.thumbs_per_row)+1,c===this.props.rows_per_hero&&(a-=this.thumbs_per_row,
d=e.item_data.splice(a,this.thumbs_per_row),d.unshift(0),d.unshift(a+1),e.item_data.splice.apply(e.item_data,d)),_.push(a+u),u+=this.num_thumbs_pushed_per_hero;return e.hero_indices=_},_set_illegal_indices:function(e){var t,i,s,o,n,r,_,a;for(o={},a=e.hero_indices,r=0,_=a.length;_>r;r++)i=a[r],s=i+1,o[s]=!1,n=Math.floor(i/this.thumbs_per_row),t=i%this.thumbs_per_row,s=(n+1)*this.thumbs_per_row+t,o[s]=!1,o[s+1]=!1;return e.illegal_indices=o},_get_thumb_size:function(e){var t,i;return t=this.props.thumb_size*this.thumbs_per_row,i=Math.floor(t/e),this.props.round_thumb_size&&(i=Math.floor(i/this.props.thumb_size)*this.props.thumb_size),1===e&&(i=this.props.thumb_size),i>this.props.max_thumb_size&&(i=this.props.max_thumb_size),this.props.resize_thumbs||(i=this.props.thumb_size),i},_update_thumbs_positions_and_merge_rows:function(e){var t,i,s,o,n,r,_,a,l,u,h,c,p,d;for(n=[],p=e.item_data,d=[],i=h=0,c=p.length;c>h;i=++h){if(s=p[i],l=i,null!=e.illegal_indices){for(r=i;null!=e.illegal_indices[r]&&!e.illegal_indices[r];)r++;l=r,e.illegal_indices[r]=!1}a=Math.floor(l/this.thumbs_per_row),t=l%this.thumbs_per_row,u=a*e.thumb_size,o=t*e.thumb_size+e.left,s.top=e.top+this.props.event_header_height+u,s.bottom=s.top+e.thumb_size,s.left=o,s.width=e.thumb_size,s.height=e.thumb_size,d.push(_=l)}return d},_on_animation_frame:function(){return this.animation_frame_requested=!1,this._render_visible_items()},_render_visible_items:function(e,t){var i;return null==e&&(e=!1),null==t&&(t=!0),i=this._get_next_state(e,t),i?this.setState(i):void 0},_get_next_state:function(e,t){var i,s,o,n,r,_,a,l,u,h,c,p,d,m,g,f;if(null==e&&(e=!1),null==t&&(t=!0),n=0,t&&(n=this.props.num_extra_rows*this.props.thumb_size),l=Math.max(this.scroll_top-n,0),a=this.scroll_top+this.window_height+n,e=null!=e?e:void 0,null==this.previous_bottom&&(this.previous_bottom=a),e||Math.abs(a-this.previous_bottom)>=n){for(o=1===this.props.events.length?this.props.events:this._get_events_in_range(l,a),u=[],_=[],c=0,m=o.length;m>c;c++)s=o[c],s.top<=a&&s.bottom>=l&&(null!=s.item_data&&(_=_.concat(s.item_data)),u.push(s));for(h=[],p=0,g=_.length;g>p;p++)r=_[p],r.top<=a&&r.bottom>=l&&h.push(r);for(i=null,d=0,f=u.length;f>d;d++)if(s=u[d],!(s.bottom<l)){i=s;break}return this.previous_bottom=a,{visible_events:u,visible_items:h,current_event:i,viewport_top:l,viewport_bottom:a,is_scrolling:this.is_scrolling,show_timeline_bubble:this.is_scrolling||this.state.show_timeline_bubble}}},_get_events_in_range:function(e,t){var i,s,o,n,r,_,a,l,u,h;for(_=Math.floor(e/this.props.positions_index_size)*this.props.positions_index_size,r=Math.ceil(t/this.props.positions_index_size)*this.props.positions_index_size,o=[],n=a=r,h=-this.props.positions_index_size;h>0?_>=a:a>=_;n=a+=h)for(s=[],null!=this.positions_index.top[n]&&(s=s.concat(this.positions_index.top[n])),null!=this.positions_index.bottom[n]&&(s=s.concat(this.positions_index.bottom[n])),l=0,u=s.length;u>l;l++)i=s[l],!(__indexOf.call(o,i)>=0)&&i.num_items>0&&o.push(i);return o},render:function(){var t,s,_,a,l,h,c,p,m,g,f,b,v,w,y;for(_=[],t=i.addons.classSet,p=t({gallery:!0,scrolling:this.state.is_scrolling}),c=t({"gallery-timeline-bubble":!0,shown:this.state.show_timeline_bubble}),h=[],v=this.state.visible_items,m=0,f=v.length;f>m;m++)a=v[m],h.push(r({key:a.item_gid,item:a,on_select_item:this.on_select_item,on_click_item:this.props.on_click_item,show_context_menu_for_item:this.show_context_menu_for_item,on_item_did_mount:this.props.on_item_did_mount,on_item_mouse_enter:this.on_item_mouse_enter,on_item_mouse_leave:this.on_item_mouse_leave,hide_thumb_by_hover:this.props.hide_thumb_by_hover,show_colors_grid:this.props.show_colors_grid,is_selectable:this.props.is_selectable,allow_like:this.props.allow_like,on_like_item:this.props.on_like_item}));for(l=[],w=this.state.visible_events,g=0,b=w.length;b>g;g++)s=w[g],l.push(n({key:s.event_id,ref:s.event_id,eventData:s,show_heros:this.props.show_heros,on_select_all:this.on_select_all,event_header_height:this.props.event_header_height,show_event_header:this.props.show_event_header,thumbs_per_row:s.thumbs_per_row,thumb_size:s.thumb_size,default_thumb_size:this.props.thumb_size,thumbs_per_hero:this.thumbs_per_hero,indent_titles:this.props.indent_titles,on_event_header_mouse_enter:this.on_event_header_mouse_enter,on_event_header_mouse_leave:this.on_event_header_mouse_leave,on_event_select_width_changed:this.on_event_select_width_changed,on_event_deselect_width_changed:this.on_event_deselect_width_changed,event_select_width:this.state.event_select_width,event_deselect_width:this.state.event_deselect_width,is_selectable:this.props.is_selectable}));return d.div({className:p,style:{width:this.state.width,height:this.state.height,position:"relative"}},l,d.div({className:"event-photos",style:{width:"100%",height:"100%"}},h),new o({page:this.props.page,shown:this.state.show_context_menu,item:this.state.context_menu_item,top:this.state.context_menu_top,left:this.state.context_menu_left,albums_allowed:this.props.albums_allowed,logging_extras:e.extend({},this.props.logging_extras,{which_menu:"grid context menu"}),on_hide_context_menu:this.hide_context_menu}),this.props.show_timeline_label?d.div({className:c},null!=(y=this.state.current_event)?y.date:void 0):void 0,this.props.show_marquee?new u({parent:this,item_store:this.props.item_store,visible_items:this.state.visible_items}):void 0)}})});var __indexOf=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/photos/carousel_app/react_timeline_navigation",["jquery","external/react","external/underscore","modules/clean/binary_search","modules/clean/photos/carousel_app/react_timeline_navigation_marker","modules/clean/photos/carousel_app/store_event","modules/clean/photos/carousel_app/carousel_event","modules/clean/photos/photos_engagement_logger"],function(e,t,i,s,o,n,r,_){var a;return a=t.DOM,t.createClass({displayName:"ReactTimelineNavigation",getInitialState:function(){return{shown:!1,current_marker:null,magnified_marker:null}},getDefaultProps:function(){return{event_store:{},markers:[],all_markers:[],marker_label_height:19,magnifier_height:31,scrubber_height:31,thumb_size:256,show_months_in_years:!1,on_show_navigation:null,on_hide_navigation:null,reverse_markers:!0,update_markers:!0,bind_events:!0}},propTypes:{item_store:t.PropTypes.object,event_store:t.PropTypes.object.isRequired,markers:t.PropTypes.array,all_markers:t.PropTypes.array,marker_label_height:t.PropTypes.number,magnifier_height:t.PropTypes.number,scrubber_height:t.PropTypes.number,thumb_size:t.PropTypes.number,show_months_in_years:t.PropTypes.bool,on_show_navigation:t.PropTypes.func,on_hide_navigation:t.PropTypes.func,reverse_markers:t.PropTypes.bool,update_markers:t.PropTypes.bool,logging_extras:t.PropTypes.object,bind_events:t.PropTypes.bool,on_scrubbing_start:t.PropTypes.func,on_scrubbing_end:t.PropTypes.func},componentDidMount:function(){return this.mouse_left=!0,this.scrubber_mouse_down=!1,this.scrolling=!1,this.document_height=0,this.track_height=0,this._set_divs(),this._set_track_height(),this._update_markers(),this._bind_events()},componentDidUpdate:function(e){return!e.update_markers&&this.props.update_markers&&(this._set_track_height(),this._update_markers()),!e.bind_events&&this.props.bind_events?this._bind_events():e.bind_events&&!this.props.bind_events?this._unbind_events():void 0},componentDidUnmount:function(){return this._unbind_events(),null!=this.scroll_timer&&clearTimeout(this.scroll_timer),null!=this.scroll_stop_timer?clearTimeout(this.scroll_stop_timer):void 0},_bind_events:function(){return e(document).bind("scroll",this._on_document_scroll),e(window).bind("resize",this._on_window_resize),e(document).bind("mousemove",this._on_mouse_move),e(document).bind("mouseup",this._on_scrubber_mouse_up),this.$track_div.bind("mouseup",this.on_track_mouse_up),this.props.item_store.on(n.ITEMS_DELETED,this._on_items_deleted)},_unbind_events:function(){return e(document).unbind("scroll",this._on_document_scroll),e(window).unbind("resize",this._on_window_resize),e(document).unbind("mousemove",this._on_mouse_move),e(document).unbind("mouseup",this._on_scrubber_mouse_up),this.$track_div.unbind("mouseup",this.on_track_mouse_up),this.props.item_store.off(n.ITEMS_DELETED,this._on_items_deleted)},_on_items_deleted:function(){return this._update_markers(),this._set_current_marker()},_set_divs:function(){return this.$track_div=e(this.refs["timeline-navigation-track"].getDOMNode()),this.$marker_div=e(this.refs["timeline-navigation-magnifier"].getDOMNode()),this.$scrubber_div=e(this.refs["timeline-navigation-scrubber"].getDOMNode())},_set_track_height:function(){return this.document_height=e(document).height(),this.track_height=this.$track_div.height()},on_mouse_enter:function(){return this.mouse_left?(this.mouse_left=!1,this._request_animation_frame(),this._show()):void 0},on_mouse_leave:function(e){return e.pageX>=this.$track_div.position().left?void 0:this.mouse_left||(this.mouse_left=!0,this._request_animation_frame(),this.scrubber_mouse_down)?void 0:this._hide()},on_track_mouse_up:function(){var t;return this.scrubber_mouse_down||this.scrolling?void 0:(t=Math.floor(this.rel_mouse_top/this.track_height*this.document_height),e(document).scrollTop(t),_.log_carousel(_.WEBAPP_TIMELINE_NAVIGATION_TRACK_CLICKED,e.extend({},this.props.logging_extras,{scroll_top_in_perc:this._get_scroll_top_in_perc()})))},_get_scroll_top_in_perc:function(){return e(document).scrollTop()/this.document_height*100},_show:function(){var t;return this.state.shown?void 0:("function"==typeof(t=this.props).on_show_navigation&&t.on_show_navigation(),this.setState({shown:!0}),_.log_carousel(_.WEBAPP_TIMELINE_NAVIGATION_SHOWN,e.extend({},this.props.logging_extras,{by_scrolling:this.scrolling})))},_hide:function(){var e;return"function"==typeof(e=this.props).on_hide_navigation&&e.on_hide_navigation(),this.setState({shown:!1,magnified_marker:null})},_on_window_resize:function(){return this._set_track_height(),this._update_markers(),this._set_current_marker()},_on_scrubber_mouse_down:function(){var t;return this.scrubber_mouse_down=!0,e(document).unbind("scroll",this._on_document_scroll),"function"==typeof(t=this.props).on_scrubbing_start?t.on_scrubbing_start():void 0},_on_scrubber_mouse_up:function(t){var i;return this.scrubber_mouse_down?(t.stopPropagation(),this.scrubber_mouse_down=!1,e(document).bind("scroll",this._on_document_scroll),this.mouse_left&&this._hide(),_.log_carousel(_.WEBAPP_TIMELINE_NAVIGATION_SCRUBBER_DRAGGED,e.extend({},this.props.logging_extras,{scroll_top_in_perc:this._get_scroll_top_in_perc()})),"function"==typeof(i=this.props).on_scrubbing_end?i.on_scrubbing_end():void 0):void 0},_marker_top_comparator:function(e,t){return e.event.top-t},_on_mouse_move:function(e){var t;return!this.mouse_left||this.scrubber_mouse_down?(this.rel_mouse_top=Math.max(0,e.pageY-this.$track_div.offset().top),t=Math.floor(this.rel_mouse_top/this.track_height*this.document_height),this.$marker_div.css({top:this.rel_mouse_top-this.props.magnifier_height/2+"px"}),this.magnified_marker=this._find_closest_marker(t),this._request_animation_frame()):void 0},_on_document_scroll:function(){return this.scrolling=!0,this._request_animation_frame(),this._show(),clearTimeout(this.scroll_timer),this.scroll_timer=setTimeout(function(e){return function(){return e.mouse_left?e._hide():void 0}}(this),1e3),clearTimeout(this.scroll_stop_timer),this.scroll_stop_timer=setTimeout(function(e){return function(){return e.scrolling=!1}}(this),250)},_request_animation_frame:function(){return this.animation_frame_requested||requestAnimationFrame(this._on_animation_frame),this.animation_frame_requested=!0},_on_animation_frame:function(){var t,i,s;return this.setState(this.mouse_left||this.scrolling||this.scrubber_mouse_down?{magnified_marker:null}:{magnified_marker:this.magnified_marker}),this.scrubber_mouse_down?(i=this.rel_mouse_top,t=Math.floor(i/this.track_height*this.document_height),e(document).scrollTop(t)):i=Math.floor(e(document).scrollTop()/this.document_height*this.track_height),i-=this.props.scrubber_height/2,i=Math.max(0,Math.min(i,this.track_height-this.props.scrubber_height)),this.$scrubber_div.css({top:i+"px"}),this.scrolling?(s=e(document).scrollTop(),(null==this.previous_top||Math.abs(s-this.previous_top)>=this.props.thumb_size)&&(this._set_current_marker(),this.previous_top=s)):this._set_current_marker(),this.animation_frame_requested=!1},_set_current_marker:function(){var t,i;return i=e(document).scrollTop(),t=this._find_closest_marker(i),null!=t?this.setState({current_marker:t}):void 0},_find_closest_marker:function(e){var t,i,o,n,r,_;return _=s(this.props.all_markers,function(t){return function(i){return t._marker_top_comparator(i,e)}}(this)),t=_[0],n=_[1],r=null,null==this.props.all_markers[n]?r=this.props.all_markers[n-1]:null==this.props.all_markers[n-1]?r=this.props.all_markers[n]:(i=Math.abs(e-this.props.all_markers[n].event.top),o=Math.abs(e-this.props.all_markers[n-1].event.top),r=o>i?this.props.all_markers[n]:this.props.all_markers[n-1]),r},_update_markers:function(){var e,t,s,o,n,r,_,a,l,u,h,c,p,d,m,g,f,b;for(o=[],u={},l=[],r=null,e=[],f=this.props.event_store.all_events,h=0,d=f.length;d>h;h++)t=f[h],0===t.left&&(s={},s.event=t,s.is_year=!1,s.is_month=!1,s.top=Math.floor(t.top/this.document_height*this.track_height),s.top<=this.props.scrubber_height/2&&(s.top=this.props.scrubber_height/2),s.top>=this.track_height-this.props.scrubber_height/2&&(s.top=this.track_height-this.props.scrubber_height/2),e.push(s),t.is_missing_dates()||(null==u[t.date_year]&&(u[t.date_year]=i.clone(s),u[t.date_year].months=[],u[t.date_year].is_year=!0,l.push(u[t.date_year]),u[t.date_year].months[t.date_month]=i.clone(s),u[t.date_year].months[t.date_month].is_month=!0,u[t.date_year].months[t.date_month].is_year=!1,u[t.date_year].months.push(u[t.date_year].months[t.date_month])),null==u[t.date_year].months[t.date_month]&&(u[t.date_year].months[t.date_month]=i.clone(s),u[t.date_year].months[t.date_month].is_month=!0,u[t.date_year].months.push(u[t.date_year].months[t.date_month])),this.props.reverse_markers&&(u[t.date_year].top=s.top,u[t.date_year].event=s.event,u[t.date_year].months[t.date_month].top=s.top,u[t.date_year].months[t.date_month].event=s.event)));for(_=this.props.reverse_markers?-1:1,_>0?(c=0,m=l.length):c=l.length-1;_>0?m>c:c>=0;c+=_)if(a=l[c],o=this._add_marker(o,a),__indexOf.call(o,a)>=0&&this.props.show_months_in_years)for(b=a.months,_>0?(p=0,g=b.length):p=b.length-1;_>0?g>p:p>=0;p+=_)n=b[p],o=this._add_marker(o,n);return this.setProps({markers:o,all_markers:e})},_add_marker:function(e,t){var i,s,o,n,r,_,a,l,u,h,c;return e.length?(a=e[e.length-1],i=!1,this.props.reverse_markers?(r=t.top+this.props.marker_label_height/2,c=a.top-this.props.marker_label_height/2,r>=c&&(i=!0)):(_=t.top-this.props.marker_label_height/2,h=a.top+this.props.marker_label_height/2,h>=_&&(i=!0)),i?t.is_year&&a.is_year?(o=t.months[0],n=t.top-o.top,s=a.months[0],l=a.top-s.top,n>l&&(u=e.indexOf(a),e.splice(u,1),e.push(t))):t.is_year&&a.is_month&&(u=e.indexOf(a),e.splice(u,1),e.push(t)):e.push(t)):e.push(t),e},render:function(){var e,i,s,n,r,_,l,u,h;return i=t.addons.classSet,e=i({"timeline-navigation":!0,"show-timeline-navigation":this.state.shown}),n=i({"timeline-navigation-magnifier":!0,"show-timeline-navigation-magnifier":this.state.shown&&null!=this.state.magnified_marker}),l=i({"timeline-navigation-track":!0,"show-timeline-navigation-track":this.state.shown}),_=i({"timeline-navigation-magnifier":!0,"timeline-navigation-scrubber":!0,"show-timeline-navigation-scrubber":this.state.shown&&null!=this.state.current_marker}),a.div({className:e},a.div({className:"timeline-navigation-hover-area",onMouseEnter:this.on_mouse_enter}),a.div({ref:"timeline-navigation-track",className:l,onMouseEnter:this.on_mouse_enter,onMouseLeave:this.on_mouse_leave},function(){var e,t,i,n,_;for(i=this.props.markers,_=[],s=e=0,t=i.length;t>e;s=++e)r=i[s],_.push(o({key:"marker_"+s,data:r,current_event:null!=(n=this.state.current_marker)?n.event:void 0,marker_label_height:this.props.marker_label_height}));return _}.call(this)),a.div({ref:"timeline-navigation-magnifier",className:n},a.div({className:"timeline-navigation-magnifier-label"},null!=(u=this.state.magnified_marker)?u.event.date:void 0),a.div({className:"timeline-navigation-magnifier-arrow-border"}),a.div({className:"timeline-navigation-magnifier-arrow"})),a.div({ref:"timeline-navigation-scrubber",className:_,onMouseDown:this._on_scrubber_mouse_down,onMouseUp:this._on_scrubber_mouse_up,onMouseEnter:this.on_mouse_enter,onMouseLeave:this.on_mouse_leave},a.div({ref:"timeline-navigation-magnifier-label",className:"timeline-navigation-magnifier-label"},null!=(h=this.state.current_marker)?h.event.date:void 0),a.div({className:"timeline-navigation-magnifier-arrow-border"}),a.div({className:"timeline-navigation-magnifier-arrow"})))}})}),define("modules/clean/photos/carousel_app/react_timeline_navigation_marker",["jquery","external/react"],function(e,t){var i;return i=t.DOM,t.createClass({displayName:"ReactTimelineNavigationMarker",getDefaultProps:function(){return{marker_label_height:0,current_event:{}}},propTypes:{marker_label_height:t.PropTypes.number,current_event:t.PropTypes.object},render:function(){var e,s,o;return this.props.data.is_year&&(s=this.props.data.event.date_year),this.props.data.is_month&&(s=this.props.data.event.date_month),e=t.addons.classSet,o=e({"timeline-navigation-marker-label":!0,"timeline-navigation-marker-label-year":this.props.data.is_year}),i.div({className:"timeline-navigation-marker",style:{top:this.props.data.top-this.props.marker_label_height/2}},i.div({className:o,onClick:this.on_marker_click},s),i.div({className:"timeline-navigation-marker-pointer"}))}})});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/reply_composer",["jquery","external/expanding","external/jquery.mousewheel","modules/clean/photos/photos_engagement_logger","modules/clean/photos/carousel_app/email_verification","modules/clean/photos/carousel_app/store_event"],function(e){return function(t,i,s,o,n,r){var _;return _=function(){function i(t,i,s){var _;this.app=t,this.conversations_page=i,this.$container=s,e._refresh=__bind(e._refresh,this),e.update_margin=__bind(e.update_margin,this),e.clear=__bind(e.clear,this),e.hide=__bind(e.hide,this),e.show=__bind(e.show,this),e.init_expanding=__bind(e.init_expanding,this),e.set_room=__bind(e.set_room,this),e._on_submit=__bind(e._on_submit,this),this.old_height=this.$container.outerHeight(),this.$reply_input=this.$container.find(".reply-input"),this.$reply_placeholder=this.$container.find(".reply-placeholder"),this._refresh(),this.app.item_store.on(r.SELECTED_CHANGED,function(e){return function(){return e._refresh()}}(this)),_=this.$container.find(".reply-input-wrapper"),_.on("mousewheel",function(){return function(){return _.scrollTop(_.scrollTop()+event.deltaY),!1}}(this)),this.$reply_input.click(function(){return function(){return o.log_carousel(o.WEBAPP_REPLY_COMPOSER_CLICKED)}}(this)),this.$reply_input.keydown(function(e){return function(t){var i;return 8!==(i=t.keyCode)&&46!==i&&9!==i?e.$reply_placeholder.hide():void 0}}(this)),this.$reply_input.keyup(function(e){return function(){return e.$reply_input.val()?e.$reply_placeholder.hide():e.$reply_placeholder.show()}}(this)),this.$container.find(".add-photos-button").click(function(e){return function(){return e.app.open_gallery_in_reply_mode(),o.log_carousel(o.WEBAPP_REPLY_COMPOSER_ADD_PHOTOS)}}(this)),this.email_verification=new n(this.app.email_verified),this.$container.find(".reply-box").submit(function(e){return function(t){return t.preventDefault(),t.stopPropagation(),e.email_verification.verify_email_or_do(function(){return e._on_submit()}),!1}}(this))}return i.prototype._on_submit=function(){var e,t,i;return t=function(){var t,i,s,o;for(s=this.app.item_store.selected_items,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push(e);return o}.call(this),i=this.$reply_input.val(),t.length||i?(this.room.send_post({items:t,message:i}),o.log_carousel(o.WEBAPP_REPLY_COMPOSER_SEND,{num_items:t.length,message_length:i.length}),this.clear()):void 0},i.prototype.set_room=function(e){this.room=e},i.prototype.init_expanding=function(){return this.$reply_input.expanding("active")?void 0:this.$reply_input.expanding({update:function(e){return function(){return e.update_margin()}}(this)})},i.prototype.show=function(){return this.$container.show()},i.prototype.hide=function(){return this.$container.hide()},i.prototype.clear=function(){return this.app.item_store.deselect_all(),this.$reply_input.val("").change(),this.$reply_placeholder.show(),this.$reply_input.focus()},i.prototype.update_margin=function(){var e;return e=this.$container.outerHeight(),e!==this.old_height?(this.conversations_page.set_bottom_margin(e,e-this.old_height),this.old_height=e):void 0},i.prototype._refresh=function(){var e,i,s,o,n,r,_,a;if(i=this.$container.find(".thumbs-container"),e=i.empty(),e.empty(),this.app.item_store.selected_items.length){for(i.show(),_=this.app.item_store.selected_items,a=[],n=0,r=_.length;r>n;n++)o=_[n],s=new Image,s.src=o.image_data,t(s).addClass("reply-box-thumb"),a.push(e.append(s));return a}return i.hide()},i}()}}(this));var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/rooms_list",["jquery","external/react","modules/core/i18n","modules/clean/ajax","modules/clean/photos/carousel_app/avatar","modules/clean/photos/carousel_app/carousel_room","modules/clean/photos/photos_engagement_logger"],function(e,t,i,s,o,n,r){var _,a,l,u,h;return _=n.CarouselRoom,h=i.i18n_default_project("carousel-web")._,u=t.DOM,a=t.createClass({displayName:"ReactRoomsList",getDefaultProps:function(){return{rooms:null,shown:!1}},propTypes:{rooms:t.PropTypes.array,shown:t.PropTypes.bool,on_room_selected:t.PropTypes.func,left_offset:t.PropTypes.number},on_wheel:function(){var t;return t=this.refs.container.getDOMNode(),e(t).scrollTop(t.scrollTop+event.deltaY),!1},render:function(){var e,t,i;return e=300,(null!=(i=this.props.rooms)?i.length:void 0)&&this.props.rooms.sort(function(e,t){return t.sort_key-e.sort_key}),u.div({className:"rooms-list-dropdown",style:{left:this.props.left_offset-e/2,width:e,display:this.props.shown?"block":"none"}},null===this.props.rooms?u.div({className:"loading"},u.img({className:"loading-spinner",src:"/static/images/loading-big-vfl-qdOjG.gif"})):0===this.props.rooms.length?u.div({className:"empty-rooms"},u.img({className:"cupcake",src:"/static/images/cupcake-vflQp9omo.png",width:100}),u.div({},h("Share some photos with your friends, and your conversations will be here."))):u.div({className:"rooms-list-container",ref:"container",onWheel:this.on_wheel},u.div({className:"rooms-list"},function(){var e,i,s,n;for(s=this.props.rooms,n=[],e=0,i=s.length;i>e;e++)t=s[e],n.push(function(e){return function(t){return u.div({key:t.sort_key,className:"rooms-list-item",onClick:function(){return r.log_carousel(r.WEBAPP_CONVERSATIONS_ROOM_CLICKED),e.props.on_room_selected(t)}},o({avatar_url:t.avatar_url,avatar_initials:t.avatar_initials}),u.div({className:"room-info"},u.div({className:"members"},t.room_name),u.div({className:"last-post-time"},t.last_updated_date),t.unread_count>0?u.div({className:"unread-count"},t.unread_count):void 0))}}(this)(t));return n}.call(this))),u.div({className:"arrow-border"}),u.div({className:"arrow"}))}}),l=function(){function i(t,i,o){this.$nav_element=t,this.on_room_selected=i,this.on_rooms_unread_count_received=o,this.toggle=__bind(this.toggle,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),this.matches_contact_vectors=__bind(this.matches_contact_vectors,this),this._get_unread_counts_for_rooms=__bind(this._get_unread_counts_for_rooms,this),this.shown=!1,this.container=e(".rooms-list-dropdown-container")[0],this.rooms=null,s.WebRequest({url:"/app/ajax/get_rooms",data:{include_item_counts:!0},success:function(e){return function(t){var i,s,o,n,r;for(o=JSON.parse(t),o.sort(function(e,t){return t.sort_key-e.sort_key}),null==e.rooms&&(e.rooms=[]),n=0,r=o.length;r>n;n++)i=o[n],e.rooms.push(new _({room_gid:i.room_gid},i));return null!=e.rooms_list&&e.rooms_list.setProps({rooms:e.rooms}),s=function(){var e,t,s,o;for(s=this.rooms,o=[],e=0,t=s.length;t>e;e++)i=s[e],o.push(i.room_gid);return o}.call(e),e._get_unread_counts_for_rooms(s)}}(this)}),e(document).click(function(e){return function(){return setTimeout(e.hide,0)}}(this))}return i.prototype._get_unread_counts_for_rooms=function(e){return s.WebRequest({url:"/app/ajax/get_unread_counts_for_rooms",data:{room_ids:JSON.stringify(e)},success:function(e){return function(t){var i,s,o,n,r;for(s=JSON.parse(t),r=e.rooms,o=0,n=r.length;n>o;o++)i=r[o],i.unread_count=s[i.room_gid];return e.shown&&e.show(),e.on_rooms_unread_count_received(e.rooms)}}(this)})},i.prototype.matches_contact_vectors=function(e,t){var i,s,o,n,r,_;if(e.members.length===t.length){for(s=function(){var e,s,o;for(o=[],e=0,s=t.length;s>e;e++)i=t[e],o.push(i[1]);return o}(),_=e.members,n=0,r=_.length;r>n;n++)if(o=_[n],!s.contains(o.contact_vector_data))return!1;return!0}return!1},i.prototype.get_room_for_contact_vectors=function(e){var t,i,s,o,n,r,a,l;if(null!=this.rooms){for(t=[],l=this.rooms,o=0,r=l.length;r>o;o++)s=l[o],this.matches_contact_vectors(s,e)&&t.push(s);for(n=0,a=t.length;a>n;n++)if(s=t[n],s.permissions!==_.PUBLIC_WRITEABLE&&s.permissions!==_.PUBLIC_VIEWABLE)return s;if(t.length)return t[0]}return null==this.rooms&&(this.rooms=[]),i=new _({contact_vectors:e}),this.rooms.push(i),i},i.prototype.show=function(){return null==this.rooms_list?this.rooms_list=t.render(a({shown:!0,rooms:this.rooms,on_room_selected:this.on_room_selected,left_offset:this.$nav_element.offset().left+this.$nav_element.outerWidth()/2}),this.container):this.rooms_list.setProps({shown:!0}),this.shown=!0},i.prototype.hide=function(){return null!=this.rooms_list&&this.rooms_list.setProps({shown:!1}),this.shown=!1},i.prototype.toggle=function(){return this.shown?this.hide():this.show()},i}()}),define("modules/clean/photos/carousel_app/selection_limit_modal",["modules/core/i18n","modules/clean/react/modal"],function(e,t){var i,s,o;return o=e._,s=t.SimpleModal,i=function(){function e(){}return e.SELECTION_MAX_SIZE=500,e.show=function(){return s.show({title_text:o("Too many photos",{project:"carousel-web"}),body_html:o("Sorry, but you can&rsquo;t select more than %(num)s photos at once.").format({num:e.SELECTION_MAX_SIZE})})},e}()}),define("modules/clean/photos/carousel_app/settings_page",["external/react","modules/clean/ajax","modules/clean/react/button","modules/clean/react/image","modules/clean/photos/carousel_app/excluded_folders_modal","modules/clean/viewer","modules/core/i18n","modules/core/notify"],function(e,t,i,s,o,n,r,_){var a,l,u,h,c,p;return u=t.WebRequest,h=i.button,c=e.DOM,p=r.i18n_default_project("carousel-web")._,l=function(){function t(t){this.$container=t,this.react_settings_page=e.render(new a,this.$container[0])}return t.prototype.show=function(){return this.react_settings_page.setProps({shown:!0}),this.$container.show()},t.prototype.hide=function(){return this.react_settings_page.setProps({shown:!1}),this.$container.hide()},t}(),a=e.createClass({getDefaultProps:function(){return{shown:!1}},propTypes:{shown:e.PropTypes.bool},getInitialState:function(){return{loading:!0,error:!1,excluded_paths:null}},componentDidUpdate:function(e){return!e.shown&&this.props.shown?this.refreshExcludedPaths():void 0},refreshExcludedPaths:function(){return u({url:"/app/ajax/get_excluded_folders",type:"GET",subject_user:n.get_viewer().personal_user,success:function(e){return function(t){return t=JSON.parse(t),e.setState({loading:!1,excluded_paths:t.excluded_paths})}}(this),error:function(e){return function(){return e.setState({loading:!1,error:!0})}}(this)})},reincludeCallback:function(e){return this.setState({loading:!0,error:!1}),u({url:"/app/ajax/reinclude_folders",subject_user:n.get_viewer().personal_user,data:{fq_paths:JSON.stringify(e)},success:function(){return _.success(p("These folders will be added to your Carousel momentarily"))},error:function(){return _.error(p("Something went wrong - your changes weren’t successfully saved"))},complete:function(e){return function(){return e.refreshExcludedPaths()}}(this)})},render:function(){var e;return c.div({className:"settings-page"},c.h1({},p("Settings")),c.hr({}),c.h2({},p("Excluded folders")),this.state.loading?c.div({},s({src:"loading-big.gif",noHiRes:!0})):this.state.error?c.div({style:{textAlign:"center"}},p("Failed to load removed folders list")):(null!=(e=this.state.excluded_paths)?e.length:void 0)>0?(c.p({},p("View a list of folders in your Dropbox that have been removed from Carousel.")),h({style:{margin:"0 0 16px 0"},onClick:function(e){return function(){return o.show(e.state.excluded_paths,e.reincludeCallback,!1)}}(this)},p("Excluded Folders"))):c.p({},p('Right+click or control+click on an image in Carousel and select "Exclude from Carousel" to exclude the image and the Dropbox folder that the image is in from Carousel.')))}}),l});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/clean/photos/carousel_app/share_cart",["jquery","external/purify","external/react","modules/core/i18n","modules/clean/photos/carousel_app/gallery_context_menu","modules/clean/photos/carousel_app/item_actions","modules/clean/photos/carousel_app/store_event","modules/clean/photos/photos_engagement_logger","modules/clean/photos/carousel_app/email_verification"],function(e,t,i,s,o,n,r,_,a){var l,u;return u=s._,l=function(){function s(t,i,s){this.app=t,this.controller=i,this.$container=s,this._share_twitter=__bind(this._share_twitter,this),this._share_facebook=__bind(this._share_facebook,this),this._share_action=__bind(this._share_action,this),this._cancel=__bind(this._cancel,this),this._hide=__bind(this._hide,this),this._show=__bind(this._show,this),this._refresh=__bind(this._refresh,this),this._update_action_menu=__bind(this._update_action_menu,this),this.set_reply_mode=__bind(this.set_reply_mode,this),this.set_item_store=__bind(this.set_item_store,this),this.set_page=__bind(this.set_page,this),this.items=[],this.$thumbs=this.$container.find(".share-cart-thumbs"),this.$more_button=this.$container.find(".more-button"),this.$share_button=this.$container.find(".shaare-button"),this.$share_facebook=this.$container.find(".shaare-facebook"),this.$share_facebook_container=this.$container.find(".oob-share-button-facebook"),this.$share_twitter=this.$container.find(".shaare-twitter"),this.$share_twitter_container=this.$container.find(".oob-share-button-twitter"),this.$share_button.click(this._share_action),this.$share_facebook.click(this._share_facebook),this.$share_twitter.click(this._share_twitter),this.$container.find(".cancel-button").click(function(t){return function(){return _.log_carousel(_.WEBAPP_SHARE_CART_CANCEL,e.extend({},t.logging_extras,{num_items:t.item_store.selected_items.length})),t._cancel()}}(this)),e("#share-cart-more-dropdown .bubble-dropdown").on("click",function(){return e("#share-cart-more-dropdown").data("jscontroller")._hide_bubble(),!0}),this.email_verification=new a(this.app.email_verified),this.logging_extras={}}return s.prototype.set_page=function(e){this.page=e},s.prototype.set_item_store=function(e){var t;return null!=(t=this.item_store)&&t.off(r.SELECTED_CHANGED,this._refresh),this.item_store=e,this.item_store.on(r.SELECTED_CHANGED,this._refresh),this._refresh()},s.prototype.set_display_options=function(e){this.show_more_actions_button=e.show_more_actions_button,this.show_out_of_band_buttons=e.show_out_of_band_buttons},s.prototype.set_reply_mode=function(e){var t;return this.reply_mode=e,this.reply_mode?(t=u("Share",{project:"carousel-web"}),this.logging_extras.gallery_mode="add_photos"):(t=u("Share",{
project:"carousel-web"}),this.logging_extras.gallery_mode="gallery"),this.$share_button.text(t),this._refresh()},s.prototype._update_action_menu=function(){var t;return t=i.render(new o({page:this.page,shown:!0,position_static:!0,item:this.item_store.selected_items[0],albums_allowed:!0,logging_extras:e.extend({},this.logging_extras,{which_menu:"share cart menu"})}),this.$container.find(".share-cart-more-menu")[0])},s.prototype._refresh=function(){var i,s,o,r,_,a,l,u,h,c,p,d,m,g,f,b,v,w,y,k,x,E,T,P,S,N;for(this._update_action_menu(),S=n.get_num_photos_and_videos(this.item_store.selected_items),p=S[0],d=S[1],this.reply_mode||this.$share_button.text(n.get_share_text(p,d)),h=this.item_store.selected_items,b=[],N=this.$thumbs.children(".share-cart-thumb"),v=0,x=N.length;x>v;v++){for(r=N[v],u=e(r).attr("id").split("share-cart-")[1],_=!1,w=0,E=h.length;E>w;w++)l=h[w],l.item_gid===u&&(_=!0);_||b.push(r)}for(y=0,T=b.length;T>y;y++)f=b[y],e(f).remove();for(i=this.$thumbs.children(".share-cart-thumb").first(),o=function(e){return function(t,i){return e.item_store.comparator_fn(t,i)>0}}(this),k=0,P=h.length;P>k;k++)if(l=h[k],e("#share-cart-"+l.item_gid).length<=0){for(g=l.image_data||l.original_thumbnail_url,l.thumb_width!==l.thumb_height&&(g=l.original_thumbnail_url),s=e("<img />",{"class":"share-cart-thumb",src:g,id:"share-cart-"+l.item_gid}),m=e(t.sanitize(s[0].outerHTML)),m.data("item_gid",l.item_gid),a=!1;!a;)i.length>0?(c=this.item_store.get_item_by_gid(i.data("item_gid")),o(c,l)?(i.before(m),a=!0):i=i.next()):(this.$thumbs.append(m),a=!0);m.click(function(e){return function(t){return function(){return e.controller.share_cart_item_clicked(t)}}}(this)(l))}return this.reply_mode?(this.$thumbs.toggleClass("empty-cart",0===h.length),this.$more_button.hide(),this.$share_facebook_container.hide(),this.$share_twitter_container.hide(),this._show()):(this.$thumbs.removeClass("empty-cart"),this.show_more_actions_button?this.$more_button.show():this.$more_button.hide(),this.show_out_of_band_buttons?(this.$share_facebook_container.show(),this.$share_twitter_container.show()):(this.$share_facebook_container.hide(),this.$share_twitter_container.hide()),h.length>0?this._show():this._hide())},s.prototype._show=function(){return this.shown?void 0:(this.$container.parent().addClass("share-cart-shown"),this.shown=!0)},s.prototype._hide=function(){return this.shown?(this.$container.parent().removeClass("share-cart-shown"),this.shown=!1):void 0},s.prototype._cancel=function(){return this.reply_mode&&0===this.item_store.selected_items.length?void this.controller.share_cart_share_action():this.item_store.deselect_all()},s.prototype._share_action=function(){return this.logging_extras.num_items=this.item_store.selected_items.length,this.email_verification.verify_email_or_do(this.controller.share_cart_share_action),_.log_carousel(_.WEBAPP_SHARE_CART_SHARE,this.logging_extras)},s.prototype._share_facebook=function(){return this.controller.share_cart_share_to_facebook(),_.log_carousel(_.WEBAPP_SHARE_CART_SHARE_FACEBOOK,this.logging_extras)},s.prototype._share_twitter=function(){return this.controller.share_cart_share_to_twitter(),_.log_carousel(_.WEBAPP_SHARE_CART_SHARE_TWITTER,this.logging_extras)},s}()});var __indexOf=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define("modules/clean/photos/carousel_app/shared_space_view",["jquery","external/react","modules/clean/ajax","modules/core/i18n","modules/core/uri","modules/clean/viewer","modules/clean/react/button","modules/clean/react/modal","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/photos_engagement_logger","modules/clean/photos/carousel_app/avatar","modules/clean/photos/carousel_app/carousel_room","modules/clean/photos/carousel_app/react_timeline","modules/clean/photos/carousel_app/shared_space_comments","modules/clean/photos/carousel_app/store_event","modules/clean/photos/carousel_app/string_utils","modules/clean/photos/carousel_app/email_verification","modules/clean/photos/carousel_app/user_list_modal","modules/core/dom"],function(e,t,i,s,o,n,r,_,a,l,u,h,c,p,d,m,g,f,b){var v,w,y,k,x,E,T,P,S,N,A,C,D,O,M,I,R;return A=r.button,D=r.link_button,E=_.Modal,v=h.CarouselRoom,T=h.PostType,O=m.num_items_text,R=s.i18n_default_project("carousel-web"),I=R._,M=R.ungettext,C=t.DOM,S=t.createFactory(p),P=t.createFactory(c),x="expanded",k="collapsed",y=t.createClass({displayName:"CommentsPanel",getInitialState:function(){return{sticky_header_state:x}},getDefaultProps:function(){return{verify_email:!0}},propTypes:{room:t.PropTypes.object,add_photos:t.PropTypes.func,send_comment_to_room:t.PropTypes.func,user_avatar_url:t.PropTypes.string,user_avatar_initials:t.PropTypes.string,readonly:t.PropTypes.bool,user_is_member:t.PropTypes.bool,shown:t.PropTypes.bool,email_verified:t.PropTypes.bool,verify_email:t.PropTypes.bool,show_members_modal:t.PropTypes.func,open_lightbox_at_item:t.PropTypes.func},_get_scroll_container:function(){return e("body")[0]},componentDidMount:function(){var e;return this.props.room.on(v.POSTS_CHANGED,this.posts_changed),e=this._get_scroll_container(),e.scrollTop=e.scrollHeight},componentWillUpdate:function(){var e;return e=this._get_scroll_container(),null==this.last_scroll_height&&0!==e.scrollHeight?this.last_scroll_height=e.scrollHeight:void 0},componentDidUpdate:function(e){var t;return e.room!==this.props.room&&(e.room.off(v.POSTS_CHANGED,this.posts_changed),this.props.room.on(v.POSTS_CHANGED,this.posts_changed)),this.props.shown&&(t=this._get_scroll_container(),t.scrollHeight>this.last_scroll_height&&(this.scroll_to_bottom?setTimeout(function(e){return function(){return t.scrollTop=t.scrollHeight,e.scroll_to_bottom=!1,0!==t.scrollHeight?e.last_scroll_height=t.scrollHeight:void 0}}(this),100):t.scrollTop=t.scrollTop+(t.scrollHeight-this.last_scroll_height)),0!==t.scrollHeight)?this.last_scroll_height=t.scrollHeight:void 0},componentWillUnmount:function(){return this.props.room.off(v.POSTS_CHANGED,this.posts_changed)},posts_changed:function(e){return null==e&&(e=!1),this.scroll_to_bottom=e,this.props.room.mark_as_read(),this.forceUpdate()},send_comment:function(e,t){var i,s;l.log_and_send(l.WEBAPP_SHARING_COMMENT_SUBMIT,{},l.Platform.WEB_CAROUSEL),i=function(i){return function(){return e?(i.props.send_comment_to_room(i.props.room,e),t()):void 0}}(this),this.props.verify_email?(s=new g(this.props.email_verified),s.verify_email_or_do(i)):i()},get_num_members:function(){var e;return e=this.props.room.members?this.props.room.members.length:0,this.props.user_is_member&&(e+=1),e},get_room_subheader_text:function(){var e,t;return e=this.get_num_members(),t=M("%(num)s member","%(num)s members",e).format({num:e})},_adjust_input_height:function(){var t,i;for(t=e(this.refs["comment-input"].getDOMNode());t[0].rows>1&&t[0].scrollHeight<t[0].offsetHeight;)t[0].rows--;for(i=[];t[0].scrollHeight>t[0].offsetHeight;)i.push(t[0].rows++);return i},show_copy_link_modal:function(){var t;return l.log_carousel(l.WEBAPP_SHARING_COPY_LINK),t=this.props.room.get_link(),E.showInstance(E({title:I("Share link to photo page"),acceptButtonText:null,className:"carousel carousel-app"},C.div({className:"copy-link-modal"},C.div({className:"input-wrapper"},C.input({className:"link-input",readonly:!0,value:t})),C.div({className:"action-bar clearfix"},D({target:"_blank",importance:"tertiary",href:t,className:"go-to-link"},I("Go to link")),A({className:"done",onClick:function(){return E.close()}},I("Done")))))),e(".link-input").select()},renderMemberAvatars:function(){var e,t,i,s,o;return s=this.get_num_members(),t=6,e=t-1,C.div({className:"room-members"},this.props.user_is_member?(e-=1,u({avatar_url:this.props.user_avatar_url,avatar_initials:this.props.user_avatar_initials})):void 0,function(){var t,s,o,n;for(o=this.props.room.members.slice(0,e),n=[],t=0,s=o.length;s>t;t++)i=o[t],n.push(u({key:i.account_id,avatar_url:i.avatar_url,avatar_initials:i.avatar_initials}));return n}.call(this),s>t?(o=s-e,this.props.user_is_member?o-=1:void 0,u({key:"more-members",avatar_initials:"+"+o})):void 0)},render:function(){var e;return C.div({className:"comments-panel",ref:"container"},this.props.room.room_name?C.div({className:"sticky-header "+this.state.sticky_header_state,ref:"sticky-header"},C.div({className:"comments-panel-header"},null!=this.props.room.members?C.div({className:"members-section",onClick:function(e){return function(){return e.props.show_members_modal(e.props.room.members)}}(this)},this.renderMemberAvatars(),C.div({className:"room-subheader"},0===this.props.room.members.length?I("Just you"):this.get_room_subheader_text())):void 0),C.div({className:"action-items-wrapper"},C.div({className:"permissions"},this.props.room.get_permissions_text()),(e=this.props.room.permissions)===v.PUBLIC_WRITEABLE||e===v.PUBLIC_VIEWABLE?C.div({className:"action-items"},C.a({ref:"copy-link-button",onClick:this.show_copy_link_modal},I("Get link"))):void 0)):void 0,S({room:this.props.room,show_reply_input:this.props.room.room_name&&!this.props.readonly,user_avatar_url:this.props.user_avatar_url,user_avatar_initials:this.props.user_avatar_initials,send_comment:this.send_comment,open_lightbox_at_item:this.props.open_lightbox_at_item}))}}),w=t.createFactory(y),N=t.createClass({displayName:"SharedSpaceView",getInitialState:function(){return{renaming_room:!1}},getDefaultProps:function(){return{user_is_member:!0,verify_email:!0,allow_like:!0}},propTypes:{room:t.PropTypes.object,lightbox:t.PropTypes.object,add_photos:t.PropTypes.func,send_comment_to_room:t.PropTypes.func,user_avatar_url:t.PropTypes.string,user_avatar_initials:t.PropTypes.string,bind_scroll:t.PropTypes.bool,thumb_loading_manager:t.PropTypes.object,readonly:t.PropTypes.bool,shown:t.PropTypes.bool,highlighted_item:t.PropTypes.object,titleWidth:t.PropTypes.number,verify_email:t.PropTypes.bool,on_like_item:t.PropTypes.func,on_show_likers:t.PropTypes.func,allow_like:t.PropTypes.bool},componentDidMount:function(){return this.props.room&&this.set_current_room(),a().dispatcher.on(a.LIGHTBOX_CLOSED,this.on_lightbox_closed)},componentWillUnmount:function(){return a().dispatcher.off(a.LIGHTBOX_CLOSED,this.on_lightbox_closed)},componentDidUpdate:function(t){var i,s,o;return e(null!=(i=this.refs["room-title-input"])?i.getDOMNode():void 0).select(),t.room!==this.props.room&&(null!=(s=t.room)&&s.off(v.ITEMS_CHANGED,this.on_items_changed),null!=(o=t.room)&&o.off(v.ROOM_METADATA_CHANGED,this.refresh),this.props.room)?this.set_current_room():void 0},set_current_room:function(){return this.props.room.on(v.ITEMS_CHANGED,this.on_items_changed),this.props.room.on(v.ROOM_METADATA_CHANGED,this.refresh),this.props.thumb_loading_manager.set_viewport({window_height:b.viewport_dimensions().height,scroll_position:b.scroll_offsets().top})},on_lightbox_closed:function(e){return this.setProps({highlighted_item:e})},on_items_changed:function(e){var t,i,s,o;for(this.forceUpdate(),this.update_timeline([this.props.room]),i=0,s=e.length;s>i;i++)t=e[i],null!=this.props.room.hero_gids&&(o=t.item_gid,t.thumbnail_url=__indexOf.call(this.props.room.hero_gids,o)>=0?t.get_2x_thumbnail_url():t.get_thumbnail_url_by_size(this.props.room.thumb_size));return this.props.thumb_loading_manager.fetch_thumbs_around_viewport(this.props.room.grid_item_store)},refresh:function(){return this.forceUpdate()},on_request_data_for_events:function(){return this.props.thumb_loading_manager.fetch_thumbs_around_viewport(this.props.room.grid_item_store)},on_scrolling:function(e){var t,i,s,o;return o=e.window_width,s=e.window_height,i=e.scroll_top,t=i+s/2,this.props.thumb_loading_manager.set_viewport({window_height:s,scroll_position:t})},room_name_input_key_down:function(e){return 13===e.keyCode?this.save_room_name(e):27===e.keyCode?this.setState({renaming_room:!1}):void 0},save_room_name:function(e){return this.props.room.rename(e.target.value,this.save_room_name_failed),this.setState({renaming_room:!1})},save_room_name_failed:function(){return this.setState({renaming_room:!0})},on_like_item:function(e){var t,i;return l.log_carousel(e.like_status?l.WEBAPP_SHARING_UNLIKE_ITEM:l.WEBAPP_SHARING_LIKE_ITEM),this.props.verify_email&&(t=new g(this.props.email_verified),t.verify_email_or_do(function(t){return function(){return t.props.room.item_like(e,t.props.user_avatar_url,t.props.user_avatar_initials)}}(this))),"function"==typeof(i=this.props).on_like_item?i.on_like_item(e):void 0},show_members_modal:function(e){return f.show({title:I("Members"),members:e,user_avatar_url:this.props.user_avatar_url,user_avatar_initials:this.props.user_avatar_initials,include_me:this.props.user_is_member})},renderEmptyState:function(){return C.div({className:"empty-state"},C.div({className:"empty-wrapper"},C.div({className:"empty-content"},C.img({src:"/static/images/carousel/carousel_app/photos-vflrai3Bq.png"}),C.div({className:"empty-content-header"},I("You have no conversations")),C.p({},I("Your conversations will be here when you share with friends.")))))},render:function(){var e,i;return e=t.addons.classSet,i=e({"room-title":!0,editable:this.props.user_is_member}),this.props.room?C.div({className:"shared-space-view"},C.div({className:"gallery-container"},C.div({className:"room-header clearfix",style:{width:this.props.titleWidth}},this.props.room.room_name?C.div({className:"room-title-wrapper"},this.state.renaming_room?C.input({className:"room-title-input",type:"text",onBlur:this.save_room_name,onKeyDown:this.room_name_input_key_down,defaultValue:this.props.room.room_name,ref:"room-title-input"}):C.div({className:i,onClick:function(e){return function(){return e.props.user_is_member?e.setState({renaming_room:!0}):void 0}}(this)},this.props.room.room_name),C.div({className:"room-subtitle"},O(this.props.room.num_photos,this.props.room.num_videos))):void 0,this.props.room.room_name&&!this.props.readonly?C.a({className:"gallery-add-photos-button",onClick:function(e){return function(){var t;return e.props.verify_email?(t=new g(e.props.email_verified),t.verify_email_or_do(e.props.add_photos)):e.props.add_photos(),l.log_and_send(l.WEBAPP_SHARING_GALLERY_ADD_PHOTOS,{email_verified:e.props.email_verified},l.Platform.WEB_CAROUSEL)}}(this)},I("Add photos")):void 0),new P({page:"shared_album",key:"shared_space_view",event_store:{on:function(e){return function(t,i){e.update_timeline=i}}(this),off:function(){return function(){}}(this)},item_store:this.props.room.grid_item_store,events:[this.props.room],min_page_margin:20,prevent_small_merges:!0,on_click_item:function(e){return function(t){return e.props.lightbox.open_at_item(t)}}(this),on_select_all:function(e){return function(t){return"function"==typeof e.on_select_all?e.on_select_all(t):void 0}}(this),on_width_change:function(e){return function(t){return e.setProps({titleWidth:t})}}(this),on_scrolling:this.on_scrolling,on_request_data_for_events:this.on_request_data_for_events,scroll_container_selector:".gallery-container",min_thumbs_per_row:3,show_timeline_label:!1,is_selectable:!1,bind_scroll:this.props.bind_scroll,disable_context_menu:!0,highlighted_item:this.props.highlighted_item,show_event_header:!1,event_header_height:0,allow_like:this.props.allow_like,on_like_item:function(e){return function(t){return e.on_like_item(t)}}(this)})),new w({key:"commentspanel"+this.props.room.room_gid,room:this.props.room,add_photos:this.props.add_photos,send_comment_to_room:this.props.send_comment_to_room,user_avatar_url:this.props.user_avatar_url,user_avatar_initials:this.props.user_avatar_initials,readonly:this.props.readonly,user_is_member:this.props.user_is_member,shown:this.props.shown,email_verified:this.props.email_verified,verify_email:this.props.verify_email,show_members_modal:function(e){return function(t){return e.show_members_modal(t)}}(this),open_lightbox_at_item:function(e){return function(t){return e.props.lightbox.open_at_item(t)}}(this)})):this.renderEmptyState()}})}),define("modules/clean/photos/carousel_app/store_event",[],function(){var e;return e=function(){function e(){}return e.ITEMS_CHANGED="StoreEvent:items_changed",e.ITEMS_SELECTED_CHANGED="StoreEvent:items_selected_changed",e.EVENTS_CHANGED="StoreEvent:events_changed",e.SELECTED_CHANGED="StoreEvent:selectedChange",e.ITEMS_ADDED="StoreEvent:added",e.ITEMS_DELETED="StoreEvent:deleted",e.GLOBAL_ITEMS_DELETED="StoreEvent:global_items_deleted",e.GLOBAL_FOLDERS_EXCLUDED="StoreEvent:global_folders_excluded",e.GLOBAL_ITEM_EDITED="StoreEvent:global_item_edited",e}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__slice=[].slice;define("modules/clean/photos/carousel_app/thumb_loading_manager",["jquery","modules/clean/binary_search","modules/clean/photos/batch_thumb_loader","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/carousel_app/store_event"],function(e,t,i,s,o){var n,r;return n=function(){function e(e,t,i){this.scroll_position=e,this.items=t,this.item_store=i,this.cancel_request=__bind(this.cancel_request,this),this._send_request=__bind(this._send_request,this),this.is_complete=__bind(this.is_complete,this),null==this.scroll_position&&(this.scroll_position=0),this.request_ids=[],this._send_request()}return e.prototype.is_complete=function(){var e,t,i,s;for(s=this.items,t=0,i=s.length;i>t;t++)if(e=s[t],!e.image_data)return!1;return!0},e.prototype._send_request=function(){var e,t,i,s,o,n;for(o=this.items,n=[],i=0,s=o.length;s>i;i++)e=o[i],t=r.batch_thumb_loader.queue_thumb(e.thumbnail_url,function(){return function(e){return function(t){return e.image_data=t}}}(this)(e)),n.push(this.request_ids.push(t));return n},e.prototype.cancel_request=function(){var e,t,i,s,o;for(s=this.request_ids,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push(r.batch_thumb_loader.cancel_thumb(e));return o},e}(),r=function(){function r(t,s){this.on_batch_thumb_complete=s,this._on_batch=__bind(this._on_batch,this),this._on_batch_thumb_complete=__bind(this._on_batch_thumb_complete,this),this._cancel_furthest_thumb_request=__bind(this._cancel_furthest_thumb_request,this),this.fetch_thumbs_around_viewport=__bind(this.fetch_thumbs_around_viewport,this),this.set_viewport=__bind(this.set_viewport,this),r.app=t,this.scroll_position=0,this.window_height=e(window).height(),this.MAX_BATCH_THUMB_REQUESTS=5,this.BATCH_THUMB_SIZE=16,this.VIEWPORT_RANGE_FOR_THUMB_REQUESTS=2.5,this.pending_thumbs_by_item_gid={},this.batch_thumb_requests=[],this.thumbnail_url_to_items={},r.batch_thumb_loader=new i({on_batch:this._on_batch,on_batch_success:this._on_batch_thumb_complete})}return r.debug=function(){var e,t;return e=1<=arguments.length?__slice.call(arguments,0):[],"true"===(null!=(t=r.app.constants)?t.debug:void 0)?console.log.apply(console,e):void 0},r.prototype.set_viewport=function(e){this.window_height=e.window_height,this.scroll_position=e.scroll_position},r.prototype.fetch_thumbs_around_viewport=function(e){var i,o,_,a,l,u,h,c,p,d,m,g,f,b,v,w,y,k,x;if(s().constants.use_batch_thumb_loader){for(this.batch_thumb_requests=function(){var e,t,i,s;for(i=this.batch_thumb_requests,s=[],e=0,t=i.length;t>e;e++)b=i[e],b.is_complete()||s.push(b);return s}.call(this),f=this.VIEWPORT_RANGE_FOR_THUMB_REQUESTS*this.window_height,c=function(e,t){return e.top-t},x=t(e.all_items,function(e){return function(t){return c(t,e.scroll_position)}}(this)),o=x[0],l=x[1],g=l,v=l-1,h=function(e){return function(t){return t?Math.abs(e.scroll_position-t.top):1/0}}(this),d=function(e){return function(t){return t&&h(t)<f&&(t.image_data||e.pending_thumbs_by_item_gid[t.item_gid])}}(this),i=function(e){return function(t,i){return null!=e.thumbnail_url_to_items[i.thumbnail_url]?e.thumbnail_url_to_items[i.thumbnail_url].push(i):(e.thumbnail_url_to_items[i.thumbnail_url]=[i],t.push(i)),s().constants.debug_thumbs?i.set_thumb_queued():void 0}}(this),a=w=0;3>w;a=++w)if(this.batch_thumb_requests.length===this.MAX_BATCH_THUMB_REQUESTS&&this._cancel_furthest_thumb_request(),this.batch_thumb_requests.length<this.MAX_BATCH_THUMB_REQUESTS){for(p=[];p.length<this.BATCH_THUMB_SIZE;){for(;d(e.all_items[g-1]);)g--;for(;d(e.all_items[v+1]);)v++;if(_=e.all_items[g-1],m=e.all_items[v+1],!_&&!m)break;if(h(_)<h(m)){if(h(_)>f)break;i(p,_),g--}else{if(h(m)>f)break;i(p,m),v++}}if(!p.length)break;for(r.debug("queueing thumbs...","scroll_position:",this.scroll_position,"items:",{items:p}),y=0,k=p.length;k>y;y++)u=p[y],this.pending_thumbs_by_item_gid[u.item_gid]=!0;b=new n(this.scroll_position,p,e),this.batch_thumb_requests.push(b)}return r.batch_thumb_loader.flush()}},r.prototype._cancel_furthest_thumb_request=function(){var e,t,i,s,o,n;if(this.batch_thumb_requests.sort(function(e,t){var i,s;return i=Math.abs(e.scroll_position-this.scroll_position),s=Math.abs(t.scroll_position-this.scroll_position),i-s}),e=this.batch_thumb_requests[this.MAX_BATCH_THUMB_REQUESTS-1],Math.abs(e.scroll_position-this.scroll_position)>this.VIEWPORT_RANGE_FOR_THUMB_REQUESTS*this.window_height){for(r.debug("cancelling furthest thumb request...","scroll position:",e.scroll_position,"items:",{items:e.items}),e=this.batch_thumb_requests.pop(),e.cancel_request(),o=e.items,n=[],i=0,s=o.length;s>i;i++)t=o[i],n.push(delete this.pending_thumbs_by_item_gid[t.item_gid]);return n}},r.prototype._on_batch_thumb_complete=function(e){var t,i,n,r,_,a,l,u,h,c,p,d,m,g,f,b,v,w;for(h=[],t=[],p=0,f=e.length;f>p;p++){for(c=e[p],a=this.thumbnail_url_to_items[c],d=0,b=a.length;b>d;d++){for(r=a[d],s().constants.debug_thumbs&&r.set_thumb_request_finished(),delete this.pending_thumbs_by_item_gid[r.item_gid],t.push(r),_=r.item_store,n=!1,m=0,v=h.length;v>m;m++)l=h[m],u=l[0],i=l[1],_===u&&(i.push(r),n=!0);n||h.push([_,[r]])}delete this.thumbnail_url_to_items[c]}for(g=0,w=h.length;w>g;g++)l=h[g],u=l[0],i=l[1],u.trigger(o.ITEMS_CHANGED,i),this.fetch_thumbs_around_viewport(u);return"function"==typeof this.on_batch_thumb_complete?this.on_batch_thumb_complete(a):void 0},r.prototype._on_batch=function(e){var t,i,o,n,r;if(s().constants.debug_thumbs){for(r=[],o=0,n=e.length;n>o;o++)i=e[o],r.push(function(){var e,s,o,n;for(o=this.thumbnail_url_to_items[i],n=[],e=0,s=o.length;s>e;e++)t=o[e],n.push(t.set_thumb_requested());return n}.call(this));return r}},r}()}),define("modules/clean/photos/stop_watch",[],function(){var e;return e=function(){function e(){}return e.logged_times={},e.start=function(e){var t;return t=Date.now(),this.logged_times[e]=t},e.stop=function(e){var t,i,s;return i=Date.now(),t=this.logged_times[e],s=i-t},e}()}),define("modules/clean/photos/survey_response_logger",["modules/clean/ajax"],function(e){var t;return t=function(){function t(){}return t.FLASHBACK_SURVEY_FREE_RESPONSE="flashback_survey_free_response",t.log=function(t,i){return null==i&&(i={}),e.WebRequest({url:"/photos/survey_response_log",data:{event:t,extra:JSON.stringify(i)}})},t}()}),define("modules/clean/react/context_menu",["external/react","modules/clean/react/sprite"],function(e,t){var i,s,o;return o=e.DOM,s=e.createFactory(e.createClass({getDefaultProps:function(){return{href:void 0,target:"_blank",onClick:void 0,arrow_position:void 0,position_static:!1,shown:!1,sprite_group:"web",sprite_name:void 0}},propTypes:{href:e.PropTypes.string,target:e.PropTypes.string,onClick:e.PropTypes.func,arrow_position:e.PropTypes.oneOf(["top","top-left","top-right","bottom","bottom-left","bottom-right","right","right-top","right-bottom","left","left-top","left-bottom"]),position_static:e.PropTypes.bool,shown:e.PropTypes.bool,sprite_group:e.PropTypes.string,sprite_name:e.PropTypes.string,top:e.PropTypes.number,left:e.PropTypes.number},on_click:function(e){return this.props.onClick?(e.preventDefault(),this.props.onClick()):void 0},render:function(){var e;return e="context-menu-item",this.props.href?o.a({className:e,href:this.props.href,onClick:this.on_click,target:this.props.target},this.props.sprite_name?t({group:this.props.sprite_group,name:this.props.sprite_name}):void 0,this.props.sprite_name?o.div({className:"sprite-text"},this.props.children):this.props.children):o.div({className:e,onClick:this.on_click},this.props.sprite_name?t({group:this.props.sprite_group,name:this.props.sprite_name}):void 0,this.props.sprite_name?o.div({className:"sprite-text"},this.props.children):this.props.children)}})),i=e.createFactory(e.createClass({render:function(){return o.div({className:"context-menu no-padding bubble-dropdown "+this.props.arrow_position+" "+this.props.className,onClick:this.props.onClick,style:{position:this.props.position_static?"static":"fixed",top:this.props.top,left:this.props.left,display:"block",visibility:this.props.shown?"visible":"hidden",border:this.props.position_static?"none":void 0}},this.props.children,null!==this.props.arrow_position?o.div({className:"bubble-arrow-border"}):void 0,null!==this.props.arrow_position?o.div({className:"bubble-arrow",ref:"arrow"}):void 0)}})),{ContextMenu:i,ContextMenuItem:s}});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/dirty/photos/carousel_app/carousel_app",["jquery","modules/core/dom","modules/core/exception","modules/core/i18n","modules/clean/ajax","modules/clean/photos/carousel_out_of_band_sharing_utils","modules/clean/photos/photos_engagement_logger","modules/clean/photos/batch_thumb_loader","modules/clean/photos/carousel_app/albums_grid","modules/clean/photos/carousel_app/albums_page","modules/clean/photos/carousel_app/album_store","modules/clean/photos/carousel_app/app_manager","modules/clean/photos/carousel_app/email_verification","modules/clean/photos/carousel_app/flashback_page","modules/clean/photos/carousel_app/item_store","modules/clean/photos/carousel_app/onboarding","modules/clean/photos/carousel_app/photos_tab_deprecation_modals","modules/clean/photos/carousel_app/settings_page","modules/clean/photos/carousel_app/duplicates_page","modules/clean/photos/carousel_app/react_gallery_page","modules/clean/photos/carousel_app/conversations_page","modules/clean/photos/carousel_app/rooms_list","modules/clean/photos/carousel_app/rooms_store","modules/clean/photos/carousel_app/share_cart","modules/dirty/photos/carousel_app/share_composer","modules/clean/photos/carousel_app/carousel_item","modules/clean/photos/carousel_app/thumb_loading_manager","modules/clean/photos/stop_watch","modules/clean/photos/carousel_app/user_list_modal"],function(e,t,i,s,o,n,r,_,a,l,u,h,c,p,d,m,g,f,b,v,w,y,k,x,E,T,P,S,N){var A,C,D,O,M,I,R,q,L,B,$;return B=i.assert,A=a.AlbumsGrid,L=a.SharedAlbumsGrid,O=g.OptInBanner,M=g.OptInModal,I=g.OptOutBanner,R=g.OptOutModal,D=g.CarouselOnboardingModal,$=s.i18n_default_project("carousel-web")._,q=function(){function e(e){this.name=e.name,this.title=e.title,this.href=e.href,this.construct_page=e.construct_page,this.event=e.event,this.page_instance=e.page_instance,B(this.name),B(this.href),B(this.construct_page||this.page_instance),B(this.event),this._last_scroll_offsets_by_path={}}return e.prototype.setup_page=function(e,i){var s,o,n;null==this.page_instance&&(this.page_instance=this.construct_page(e)),this.page_instance.show(i),"function"==typeof(n=this.page_instance).bind_scroll&&n.bind_scroll(),e.current_page=this.page_instance,s=window.location.pathname,o=this._last_scroll_offsets_by_path[s]||{0:0,1:0,left:0,top:0},t.scroll_to(o.left,o.top),e._cleanup=function(e){return function(){var o;return e._last_scroll_offsets_by_path[s]=t.scroll_offsets(),"function"==typeof(o=e.page_instance).unbind_scroll&&o.unbind_scroll(),e.page_instance.hide(i)}}(this),r.log_carousel(this.event)},e}(),C=function(){function t(t,i,s,o,a,m,g,T,S,C,D){var O,I,j,W,z,H,U,G,F,V,X,Y,K;this.$timeline_container=i,this.$album_container=s,this.$albums_grid_container=o,this.$shared_album_container=a,this.$shared_albums_grid_container=m,this.$flashback_container=g,this.$settings_container=T,this.$duplicates_container=S,this.initial_timeline_events=C,I=D.email_verified,Y=D.user_avatar_url,K=D.user_initials,W=D.room_gid,z=D.show_confirm_claim,U=D.show_invalid_link,this.experiment_improved_out_of_band_sharing=D.experiment_improved_out_of_band_sharing,O=D.constants,X=D.title_by_page_name,this._set_page=__bind(this._set_page,this),this._update_url=__bind(this._update_url,this),this._update_url_and_page=__bind(this._update_url_and_page,this),this._init_history=__bind(this._init_history,this),this._do_or_queue_if_lightbox_open=__bind(this._do_or_queue_if_lightbox_open,this),this.on_rooms_unread_count_received=__bind(this.on_rooms_unread_count_received,this),this._init_navigation=__bind(this._init_navigation,this),this.set_loading=__bind(this.set_loading,this),this.open_albums_grid=__bind(this.open_albums_grid,this),this.open_albums_page_and_view_album=__bind(this.open_albums_page_and_view_album,this),this.post_to_room=__bind(this.post_to_room,this),this.open_conversations_at_room=__bind(this.open_conversations_at_room,this),this.hide_account_settings=__bind(this.hide_account_settings,this),this.show_account_settings=__bind(this.show_account_settings,this),this.close_gallery_in_reply_mode=__bind(this.close_gallery_in_reply_mode,this),this.open_gallery_in_reply_mode=__bind(this.open_gallery_in_reply_mode,this),this.set_shared_item_store=__bind(this.set_shared_item_store,this),this.on_batch_thumb_complete=__bind(this.on_batch_thumb_complete,this),this.share_cart_item_clicked=__bind(this.share_cart_item_clicked,this),this.share_cart_share_to_twitter=__bind(this.share_cart_share_to_twitter,this),this.share_cart_share_to_facebook=__bind(this.share_cart_share_to_facebook,this),this.share_cart_share_action=__bind(this.share_cart_share_action,this),this.share_one_item=__bind(this.share_one_item,this),null==this.initial_timeline_events&&(this.initial_timeline_events=[]),this.email_verified=I,this.user_avatar_url=Y,this.user_initials=K,this.constants=O,this.constants.batch_size=null!=O.batch_size?parseInt(O.batch_size):100,this.constants.use_retina=null!=O.retina?"false"!==O.retina:!0,this.constants.resize_thumbs=null!=O.resize_thumbs?"false"!==O.resize_thumbs:!0,this.constants.indent_titles=null!=O.indent_titles?"true"===O.indent_titles:!1,this.constants.round_thumb_size=null!=O.round_thumb_size?"true"===O.round_thumb_size:!1,this.constants.prevent_small_merges=null!=O.prevent_small_merges?"false"!==O.prevent_small_merges:!0,this.constants.scroll_perf=null!=O.scroll_perf?"true"===O.scroll_perf:!1,this.constants.timeline_navigation=null!=O.timeline_navigation?"true"===O.timeline_navigation:!1,this.constants.show_months_in_years=null!=O.show_months_in_years?"false"!==O.show_months_in_years:!0,this.constants.reverse_markers=null!=O.reverse_markers?"false"!==O.reverse_markers:!0,this.constants.show_timeline_label=this.constants.timeline_navigation?!1:void 0,this.constants.hide_thumb_by_hover=null!=(null!=O?O.hide_thumb_by_hover:void 0)?"true"===(null!=O?O.hide_thumb_by_hover:void 0):!1,this.constants.show_colors_grid=null!=(null!=O?O.show_colors_grid:void 0)?"true"===(null!=O?O.show_colors_grid:void 0):!1,this.constants.sharing_gallery=null!=O.sharing_gallery?O.sharing_gallery:!1,this.constants.show_marquee=null!=(null!=O?O.marquee:void 0)?null!=O?O.marquee:void 0:!1,this.constants.use_local_storage="true"===O.use_local_storage,this.constants.use_batch_thumb_loader=!0,this.constants.spdy_allowed&&1===Constants.IS_SPDY&&(this.constants.use_batch_thumb_loader=!1),h().constants=this.constants,this.item_store=new d(F=!0),this.album_store=new u,h().album_store=this.album_store,h().open_albums_page_and_view_album=this.open_albums_page_and_view_album,this.email_verification=new c(this.email_verified),this.lightbox=e("#gallery-lightbox").data("jscontroller"),this.lightbox.set_on_share_item(this.share_one_item),this.lightbox.on_lightbox_like(function(e){return function(t){var i;return r.log_carousel(t.like_status?r.WEBAPP_SHARING_UNLIKE_ITEM:r.WEBAPP_SHARING_LIKE_ITEM),i=new c(I),i.verify_email_or_do(function(){return t.source_collection.item_like(t,e.user_avatar_url,e.user_avatar_initials)})}}(this)),this.lightbox.on_lightbox_show_likers(function(e){return function(t){return N.show({
title:$("People who like this"),members:t.likees,user_avatar_url:e.user_avatar_url,user_avatar_initials:e.user_avatar_initials,include_me:t.like_status})}}(this)),this.share_composer=new E(this),this.share_cart=new x(this,this,e("#share-cart")),this.thumb_loading_manager=new P(this,this.on_batch_thumb_complete),this.batch_thumb_loader=new _({batch_size:this.batch_thumb_size}),this._init_navigation(),this.out_of_band_sharing_utils=new n({should_show_loading_dialog_before_link_sharing:!0,should_use_dropbox_branded_link:this.constants.use_dropbox_chrome}),this.constants.use_dropbox_chrome&&(this.rooms_store=new k,this.rooms_store.on(k.CHANGE_EVENT,function(e){return function(){var t,i,s,o,n;for(i=0,n=e.rooms_store.rooms,s=0,o=n.length;o>s;s++)t=n[s],i+=t.unread_count;return e._set_unread_badge_for_page(e.page_info.shared_albums_grid.name,i)}}(this))),this.conversations_page=new w(this,this.$shared_album_container,{initial_room_gid:W,show_confirm_claim:z,show_invalid_link:U,show_email_verification:this.constants.show_email_verification,show_add_photos:this.constants.add_photos,liked_own_item:this.constants.liked_own_item}),this.flashback_page=new p(this,this.$flashback_container,O.flashback_id,H=!this.constants.use_dropbox_chrome,G=null,this.out_of_band_sharing_utils,this.experiment_improved_out_of_band_sharing),this.page_info={timeline:new q({name:"timeline",href:"/app/timeline",construct_page:function(e){return new v(e,e.$timeline_container,e.initial_timeline_events)},event:r.WEBAPP_VIEW_TIMELINE}),album:new q({name:"album",href:"/app/albums",construct_page:function(e){return new l(e,e.$album_container)},event:r.WEBAPP_VIEW_ALBUM}),shared_album:new q({name:"shared_album",href:"/app/sharing",page_instance:this.conversations_page,event:r.WEBAPP_VIEW_SHARED_ALBUM}),flashback:new q({name:"flashback",href:"/app/flashback",page_instance:this.flashback_page,event:r.WEBAPP_VIEW_FLASHBACK})},this.constants.use_dropbox_chrome?(this.page_info.albums_grid=new q({name:"albums_grid",href:"/app/albums",construct_page:function(e){return new A(e,e.$albums_grid_container)},event:r.WEBAPP_VIEW_ALBUMS_GRID}),this.page_info.shared_albums_grid=new q({name:"shared_albums_grid",href:"/app/sharing",construct_page:function(e){return new L(e,e.$shared_albums_grid_container)},event:r.WEBAPP_VIEW_SHARED_ALBUMS_GRID})):this.page_info.settings=new q({name:"settings",href:"/app/settings",construct_page:function(e){return new f(e.$settings_container)},event:r.WEBAPP_VIEW_SETTINGS}),this.constants.duplicates&&(this.page_info.duplicates=new q({name:"duplicates",href:"/app/duplicates",construct_page:function(e){return new b(e,e.$duplicates_container)},event:r.WEBAPP_VIEW_DUPLICATES}));for(j in this.page_info)B(this.page_info[j].name===j,"invalid page name "+j),V=X[j],B(V,"missing title for page_name "+j),this.page_info[j].title=V;this._init_history(t),this._set_page(t),this.set_loading(!0),this.constants.use_dropbox_chrome||(this.rooms_list=new y(e(".carousel-app-nav-option[data-page-name="+this.page_info.shared_album.name+"]"),this.open_conversations_at_room,this.on_rooms_unread_count_received),this.$account_settings=e(".account-settings"),this.$account_settings.find(".avatar").click(function(){return function(){return r.log_carousel(r.WEBAPP_VIEW_USER_SETTINGS)}}(this)),this.$account_settings.find(".ios-link").click(function(){return function(){return r.log_carousel(r.WEBAPP_USER_SETTINGS_IOS)}}(this)),this.$account_settings.find(".android-link").click(function(){return function(){return r.log_carousel(r.WEBAPP_USER_SETTINGS_ANDROID)}}(this)),this.$account_settings.find(".help-link").click(function(){return function(){return r.log_carousel(r.WEBAPP_USER_SETTINGS_HELP)}}(this)),this.$account_settings.find(".legal-link").click(function(){return function(){return r.log_carousel(r.WEBAPP_USER_SETTINGS_LEGAL)}}(this)),this.$account_settings.find(".feedback-link").click(function(){return function(){return r.log_carousel(r.WEBAPP_USER_SETTINGS_FEEDBACK)}}(this)),this.$account_settings.find("#settings-link").click(function(e){return function(){return e._update_url_and_page(e.page_info.settings.name),e.$account_settings.data("jscontroller").closeDropdown(),!1}}(this)),this.$account_settings.find(".logout-link").click(function(){return function(){return r.log_carousel(r.WEBAPP_USER_SETTINGS_LOGOUT)}}(this)),this.$account_settings.find(".opt-in-link").click(function(e){return function(){return M.show(function(){return e.$account_settings.removeClass("opt-in")}),e.$account_settings.data("jscontroller").closeDropdown(),r.log_carousel(r.WEBAPP_USER_SETTINGS_OPT_IN)}}(this)),this.$account_settings.find(".opt-out-link").click(function(e){return function(){return R.show(function(){return e.$account_settings.addClass("opt-in")}),e.$account_settings.data("jscontroller").closeDropdown(),r.log_carousel(r.WEBAPP_USER_SETTINGS_OPT_OUT)}}(this))),e(document).bind("modalOpened",function(e){return function(){var t;return"function"==typeof(t=e.current_page).unbind_scroll&&t.unbind_scroll(),e.lightbox.unbind_keys()}}(this)),e(document).bind("modalClosed",function(e){return function(){var t;return"function"==typeof(t=e.current_page).bind_scroll&&t.bind_scroll(),e.lightbox.bind_keys()}}(this))}return t.prototype.share_one_item=function(e){return this.email_verification.verify_email_or_do(function(t){return function(){return t.share_cart_share_action(e)}}(this))},t.prototype.share_cart_share_action=function(e){return this.current_page.reply_mode?this.close_gallery_in_reply_mode():this.share_composer.show_sharing_modal(e)},t.prototype.share_cart_share_to_facebook=function(){return this.out_of_band_sharing_utils.share_items_facebook(this.shared_item_store.selected_items),this.shared_item_store.deselect_all()},t.prototype.share_cart_share_to_twitter=function(){return this.out_of_band_sharing_utils.share_items_twitter(this.shared_item_store.selected_items),this.shared_item_store.deselect_all()},t.prototype.share_cart_item_clicked=function(t){var i;return this.lightbox.shown?this.lightbox.open_at_item(t):null!=(i=this.current_page.react_timeline)&&i.setProps({highlighted_item:t}),r.log_carousel(r.WEBAPP_SHARE_CART_ITEM_CLICKED,e.extend({},this.logging_extras,{in_lightbox:this.lightbox.shown}))},t.prototype.on_batch_thumb_complete=function(e){var t,i,s,o,n,_;if(!this.logged_first_visible_thumbs_batch){for(o=S.stop(r.WEBAPP_GALLERY_TIME_FIRST_VISIBLE_THUMBS_BATCH),i=0,s=0,n=0,_=e.length;_>n;n++)t=e[n],t.requested_thumb_size===T.DEFAULT_THUMB_SIZE&&i++,t.requested_thumb_size===T.HERO_THUMB_SIZE&&s++;return r.log_carousel(r.WEBAPP_GALLERY_TIME_FIRST_VISIBLE_THUMBS_BATCH,{time:o,num_default_size:i,num_hero_size:s,num_items:i+s}),this.logged_first_visible_thumbs_batch=!0}},t.prototype.set_shared_item_store=function(t,i){var s,o,n,r;return null==i&&(i={}),o=i.lightbox_options,n=i.share_cart_options,s={show_checkmark:!0,show_gallery_actions:!0,show_more_actions_button:!0,show_download_button:!1,show_face_rec:this.constants.faces,show_album_actions:!0,show_like:!1,show_editing_toolbar:!0},s=e.extend(s,o),n=e.extend({show_more_actions_button:!0,show_out_of_band_buttons:this.experiment_improved_out_of_band_sharing},n),r={oob_show_only_link:this.experiment_improved_out_of_band_sharing},this.shared_item_store=t,this.share_cart.set_item_store(t),this.share_cart.set_display_options(n),this.share_composer.set_item_store(t),this.share_composer.set_display_options(r),this.lightbox.set_item_store(t),this.lightbox.set_logging_extra("page",this.current_page_name),this.lightbox.set_display_options(s),this.share_cart.set_page(this.current_page_name),this.lightbox.set_page(this.current_page_name)},t.prototype.open_gallery_in_reply_mode=function(){return this._update_url_and_page(this.page_info.timeline.name,{reply_mode:!0})},t.prototype.close_gallery_in_reply_mode=function(){var e,t;return this.item_store.selected_items.length&&(t=function(){var t,i,s,o;for(s=this.item_store.selected_items,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push(e);return o}.call(this),this.conversations_page.post_items_to_current_room(t),this.item_store.deselect_all()),this.share_cart.set_reply_mode(!1),"function"==typeof this._cleanup&&this._cleanup(),this._do_or_queue_if_lightbox_open(function(){return function(){return history.go(-1)}}(this))},t.prototype.show_account_settings=function(){return this.constants.use_dropbox_chrome||this.$account_settings.addClass("show-account-settings"),e("#opt-out-hint").show()},t.prototype.hide_account_settings=function(){return this.constants.use_dropbox_chrome||this.$account_settings.removeClass("show-account-settings"),e("#opt-out-hint").hide()},t.prototype.open_conversations_at_room=function(e){return this._update_url_and_page(this.page_info.shared_album.name,{},e.url),this.conversations_page.show_room(e)},t.prototype.post_to_room=function(e,t,i){var s,o,n;return o=function(){var e,t,o;for(o=[],e=0,t=i.length;t>e;e++)s=i[e],o.push(d.copy(s));return o}(),r.log_carousel(r.WEBAPP_SHARE_COMPOSER_SHARE,{num_items:o.length,message_length:t.length,num_recipients:e.length}),this.constants.use_dropbox_chrome?(n=this.rooms_store.get_room_for_contact_vectors(e),n.send_post(o,t,this.user_avatar_url,this.user_initials),this.conversations_page.show_room(n)):(n=this.rooms_list.get_room_for_contact_vectors(e),n.send_post(o,t,this.user_avatar_url,this.user_initials),this.conversations_page.show_room(n)),this.current_page_name!==this.page_info.shared_album.name?("function"==typeof this._cleanup&&this._cleanup(),this._do_or_queue_if_lightbox_open(function(e){return function(){return e._update_url_and_page(e.page_info.shared_album.name,{},n.url)}}(this))):void 0},t.prototype.open_albums_page_and_view_album=function(e){return"function"==typeof this._cleanup&&this._cleanup(),this._do_or_queue_if_lightbox_open(function(t){return function(){return t._update_url_and_page(t.page_info.album.name,{album:e},e.url),t.item_store.deselect_all()}}(this))},t.prototype.open_albums_grid=function(){return this._update_url_and_page(this.page_info.albums_grid.name)},t.prototype.set_loading=function(t){var i;return t!==this.loading?(this.loading=t,i=e("#more-loading"),t?i.show():i.hide()):void 0},t.prototype._set_unread_badge_for_page=function(t,i){return i>0&&this.current_page_name!==t?(e(".carousel-app-nav-option[data-page-name="+t+"]").addClass("show-unread-badge"),e(".carousel-app-nav-option[data-page-name="+t+"] .unread-badge").text(i)):e(".carousel-app-nav-option[data-page-name="+t+"]").removeClass("show-unread-badge")},t.prototype._init_navigation=function(){return e(".rooms-list-dropdown-arrow").show(),o.WebRequest({url:"/app/ajax/get_page_unread_counts",success:function(e){return function(t){var i,s,o,n;s=JSON.parse(t),n=[];for(o in s)i=s[o],n.push(e._set_unread_badge_for_page(o,i));return n}}(this)}),e(".carousel-app-nav-option").click(function(t){return function(i){var s,o;if(s=e(i.target).closest(".carousel-app-nav-option"),s.removeClass("show-unread-badge"),o=s.data("page-name"),!t.constants.use_dropbox_chrome){if(o===t.page_info.shared_album.name)return t.rooms_list.toggle(),!1;t.rooms_list.hide()}return o===t.current_page_name?!1:(t._update_url_and_page(o),!1)}}(this)),e(".carousel-app-header .carousel-logo").click(function(e){return function(){return e.current_page!==e.page_info.timeline.page_instance&&e._update_url_and_page(e.page_info.timeline.name),r.log_carousel(r.WEBAPP_LOGO_CLICKED)}}(this)),e(".dropbox-link").click(function(){return function(){return r.log_and_send(r.WEBAPP_BACK_TO_DROPBOX_CLICKED,null,r.Platform.WEB_CAROUSEL)}}(this)),e(window).on("popstate",function(e){return function(t){var i,s;return null!=e.do_on_next_popstate?(e.do_on_next_popstate(),e.do_on_next_popstate=null):(i=null!=(s=t.originalEvent)?s.state:void 0,null!=i&&i.page_name!==e.current_page_name?e._set_page(i.page_name):void 0)}}(this))},t.prototype.on_rooms_unread_count_received=function(e){var t,i,s,o;for(i=0,s=0,o=e.length;o>s;s++)t=e[s],i+=t.unread_count;return this._set_unread_badge_for_page(this.page_info.shared_album.name,i)},t.prototype._do_or_queue_if_lightbox_open=function(e){return window.location.pathname.match("lightbox")?this.do_on_next_popstate=e:e()},t.prototype._init_history=function(e){return history.replaceState({page_name:e},document.title,window.location.pathname)},t.prototype._update_url_and_page=function(e,t,i){return null==i&&(i=null),this._update_url(e,i),this._set_page(e,t)},t.prototype._update_url=function(e,t){return null==t&&(t=null),window.history&&window.history.pushState&&window.history.state.page_name&&(history.replaceState({page_name:history.state.page_name},document.title,window.location.pathname),history.pushState({page_name:e},this.page_info[e].title,t||this.page_info[e].href)),document.title=this.page_info[e].title},t.prototype._set_page=function(t,i){var s,o,n,r;if(B(t in this.page_info,""+t+" isn't a known page"),this.current_page_name!==t||i)if(this.current_page_name=t,n=this.page_info[t],null==i&&(i={}),o=e(".carousel-app-nav-option"),o.removeClass("selected"),o.filter("[data-page-name="+t+"]").addClass("selected"),s=e(".carousel-app-page-content"),s.attr("id","page-"+t),"function"==typeof this._cleanup&&this._cleanup(i),this._cleanup=null,n.setup_page(this,i),this.constants.use_dropbox_chrome){if(this.constants.show_new_onboarding)return D.show(this.constants.is_previous_carousel_web_user),this.constants.show_new_onboarding=!1;if(this.constants.show_opt_in_promos)return O.show(function(){return function(){return M.show(function(){})}}(this))}else{if(r=function(){return I.show(function(e){return function(){return R.show(function(){return e.$account_settings.addClass("opt-in")})}}(this))},this.constants.show_onboarding)return this.constants.show_opt_out_banner?(new m).start(r):(new m).start(),this.constants.show_onboarding=!1;if(this.constants.show_opt_in_promos)return O.show(function(e){return function(){return M.show(function(){return e.$account_settings.removeClass("opt-in")})}}(this));if(this.constants.show_opt_out_banner)return r()}},t}()});var __bind=function(e,t){return function(){return e.apply(t,arguments)}};define("modules/dirty/photos/carousel_app/share_composer",["dropbox","jquery","external/expanding","modules/core/notify","modules/core/uri","modules/core/i18n","modules/clean/ajax","modules/clean/dbmodal","modules/clean/photos/carousel_out_of_band_sharing_utils","modules/clean/photos/photos_engagement_logger","modules/clean/react/modal","modules/clean/viewer"],function(e,t,i,s,o,n,r,_,a,l,u,h){var c,p,d,m,g,f,b;return c=_.DBModal,m=u.SimpleModal,p=1,b=n.i18n_default_project("carousel-web"),f=b._,g=b.ungettext,d=function(){function e(e){this.app=e,this._init_tokenizer_listeners=__bind(this._init_tokenizer_listeners,this),this._init_tokenizer=__bind(this._init_tokenizer,this),this._clear_input=__bind(this._clear_input,this),this._close=__bind(this._close,this),this._share_facebook=__bind(this._share_facebook,this),this._share_twitter=__bind(this._share_twitter,this),this._share_link=__bind(this._share_link,this),this._set_loading=__bind(this._set_loading,this),this._init_out_of_band=__bind(this._init_out_of_band,this),this._init_message_input=__bind(this._init_message_input,this),this._add_thumbs=__bind(this._add_thumbs,this),this.show_sharing_modal=__bind(this.show_sharing_modal,this),this.set_display_options=__bind(this.set_display_options,this),this.set_item_store=__bind(this.set_item_store,this),this.modal=new c({element_id:"share-composer-modal",title:f("Share photos")}),this.out_of_band_share_utils=new a({should_show_loading_dialog_before_link_sharing:!1,on_pre_generate_link:function(e){return function(){return e._set_loading(!0)}}(this),on_post_generate_link:function(e){return function(){return e._set_loading(!1),e._close(),e.item_store.deselect_all()}}(this),should_use_dropbox_branded_link:this.app.constants.use_dropbox_branding}),this._init_tokenizer()}return e.prototype.set_item_store=function(e){this.item_store=e},e.prototype.set_display_options=function(e){this.oob_show_only_link=e.oob_show_only_link},e.prototype.show_sharing_modal=function(e){var t;return this.items=e?[e]:function(){var t,i,s,o;for(s=this.item_store.selected_items,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push(e);return o}.call(this),this.modal.show(),this._clear_input(),this._init_tokenizer_listeners(),this._add_thumbs(),this._init_message_input(),this._init_out_of_band(),t=this.modal.$modal_window.find(".share-composer"),t.on("keydown",function(){return function(e){return e.stopPropagation()}}(this)),t.submit(function(i){return function(o){var n,_,a,u,c,d,b,v,w,y,k,x;if(o.preventDefault(),o.stopPropagation(),_=[],c=t.find("input[name=carousel_rooms], input[name=emails]").closest(".token-error"),c.length)return!1;for(b=t.find("input[name=carousel_rooms]"),w=0,k=b.length;k>w;w++)n=b[w],_.push(JSON.parse(n.value));for(u=t.find("input[name=emails]"),y=0,x=u.length;x>y;y++)n=u[y],_.push([p,n.value]);return d=i.modal.$modal_window.find(".share-composer-message-input").val(),1===_.length&&_[0][1].toLowerCase()===h.get_viewer().personal_user.email.toLowerCase()?(i._close(),m.show({title_text:f("Sharing is better with friends"),body_html:f("You can’t share with your own account. Share your photos and videos with friends for a better time!"),confirm_text:f("Ok"),confirm_callback:function(){return i.show_sharing_modal()}}),l.log_carousel(l.WEBAPP_SHARE_WITH_SELF_ATTEMPT),!1):(!i.app.constants.debug_allowed||"lass"!==d&&"lass-readonly"!==d?_.length&&(i.item_store.deselect_all(),i.app.constants.use_dropbox_branding?r.WebRequest({url:"/app/ajax/send_collection_shmodel_link",data:{emails:JSON.stringify(function(){var e,t,i,s;for(s=[],e=0,t=_.length;t>e;e++)i=_[e],v=i[0],a=i[1],s.push(a);return s}()),item_counters:JSON.stringify(function(){var t,i,s,o;for(s=this.items,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push(e.item_counter);return o}.call(i)),message:d,source_collection_gid:i.items[0].source_collection_gid},subject_user:h.get_viewer().personal_user,success:function(){return s.success(g("Email sent!","Emails sent!",_.length))}}):i.app.post_to_room(_,d,i.items),i._close()):(i.modal.$modal_window.find(".share-composer-message-input").val("getting link..."),r.WebRequest({url:"/app/ajax/send_post",data:{item_gids:JSON.stringify(function(){var t,i,s,o;for(s=this.items,o=[],t=0,i=s.length;i>t;t++)e=s[t],o.push(e.item_gid);return o}.call(i)),lass_permissions:"lass"===d?"rw":"r"},success:function(e){var t;return t=JSON.parse(e),i.modal.$modal_window.find(".share-composer-message-input").val(t.url)}})),!1)}}(this))},e.prototype._add_thumbs=function(){var e,i,s,o,n,r,_,a;for(e=this.modal.$modal_window.find(".thumbs-container").empty(),_=this.items,a=[],n=0,r=_.length;r>n;n++)s=_[n],i=new Image,o=s.image_data||s.original_thumbnail_url,s.thumb_width!==s.thumb_height&&(o=s.original_thumbnail_url),i.src=o,t(i).addClass("share-modal-thumb"),a.push(e.append(i));return a},e.prototype._init_message_input=function(){var e,t;return e=this.modal.$modal_window.find(".share-composer-message-input"),t=this.modal.$modal_window.find(".share-composer-message-placeholder"),e.expanding("active")&&e.expanding("destroy"),e.expanding(),e.keydown(function(){return function(i){var s;return 8!==(s=i.keyCode)&&46!==s&&t.hide(),e.val()?void 0:l.log_carousel(l.WEBAPP_SHARE_COMPOSER_MESSAGE)}}(this)),e.keyup(function(){return function(){return e.val()?t.hide():t.show()}}(this))},e.prototype._init_out_of_band=function(){return this.oob_show_only_link?(this.modal.$modal_window.find(".oob-button-icon").hide(),this.modal.$modal_window.find(".oob-button-text").show()):(this.modal.$modal_window.find(".oob-button-icon").show(),this.modal.$modal_window.find(".oob-button-text").hide()),this.modal.$modal_window.find(".shaare-link").click(this._share_link),this.modal.$modal_window.find(".shaare-twitter").click(this._share_twitter),this.modal.$modal_window.find(".shaare-facebook").click(this._share_facebook)},e.prototype._set_loading=function(e){return this.modal.$modal_window.toggleClass("loading",e)},e.prototype._share_link=function(){return this.out_of_band_share_utils.share_items_link(this.items),l.log_carousel(l.WEBAPP_SHARE_COMPOSER_LINK,{num_items:this.items.length}),!1},e.prototype._share_twitter=function(){return this.out_of_band_share_utils.share_items_twitter(this.items),l.log_carousel(l.WEBAPP_SHARE_COMPOSER_TWITTER,{num_items:this.items.length}),!1},e.prototype._share_facebook=function(){return this.out_of_band_share_utils.share_items_facebook(this.items),l.log_carousel(l.WEBAPP_SHARE_COMPOSER_FACEBOOK,{num_items:this.items.length}),!1},e.prototype._close=function(){return this.modal.hide()},e.prototype._clear_input=function(){var e,t;return null!=(e=this.tokenizer)&&e.clearTokens(),null!=(t=this.tokenizer)&&t.hide(),this.modal.$modal_window.find(".share-composer-message-input").val(""),this.modal.$modal_window.find(".share-composer-message-placeholder").show(),this.modal.$modal_window.find("#carousel-share-composer-new-collab-input").val("")},e.prototype._init_tokenizer=function(){return this.modal.show(),this.tokenizer=new Autocompleter.ContactsTokenizer(h.get_viewer().personal_user,"carousel-share-composer-new-collab-input","carousel-share-composer-new-whobulk","carousel-share-composer-hidden-input",{tokens:[",",";"],include_rooms:!0}),this.modal.hide()},e.prototype._init_tokenizer_listeners=function(){var e;return e=t("#carousel-share-composer-new-collab-input"),e.focus(),e.keydown(function(){return function(){return e.val()?void 0:l.log_carousel(l.WEBAPP_SHARE_COMPOSER_RECIPIENT)}}(this)),this.modal.$modal_window.find(".share-composer-input-wrapper, .shaare-button").click(function(e){return function(){var t;return e.tokenizer.tokenize_emails_input(t=!0)}}(this))},e}()});