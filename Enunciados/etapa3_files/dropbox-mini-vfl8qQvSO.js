define("dropbox",["modules/clean/undo","modules/clean/react/modal","modules/core/controller_registry","modules/clean/contacts/list","modules/clean/job_progress","modules/clean/pagination_manager","modules/clean/browse_interface","modules/clean/search/search_helpers","modules/clean/contacts/cache","modules/clean/multiaccount_login","modules/clean/top_notif","modules/clean/datetime","modules/core/i18n","modules/clean/uirequest","modules/clean/em_string","modules/clean/base64","modules/core/dom","modules/clean/web_timing_logger","modules/clean/video_util","modules/clean/account/email","modules/clean/dbmodal","modules/clean/teams/team_folder_modal","modules/clean/sharing/share_inband","modules/clean/contacts/importer","modules/clean/payments/credit_card_util","modules/clean/contacts/types","external/react","modules/clean/profile_services/profile_services_constants","modules/clean/react/previews/preview_image","modules/core/uri","modules/clean/page_role_observer","modules/core/cookies","modules/clean/react/previews/preview_image_zoom","modules/clean/dbmodal_loading","modules/clean/display_format","modules/clean/payments/cash","modules/clean/event_load","modules/clean/contacts/facebook_modal","modules/clean/contacts/facebook_oauth","modules/clean/react/previews/preview_video","external/purify","modules/clean/account/email_verify_reasons","modules/clean/image_size","modules/clean/react/hierarchical_nav_bar","modules/clean/payments/dfb_util","modules/clean/components/ajax_form","modules/clean/viewer","modules/core/ordered_dictionary","modules/clean/events/rollback","libs","modules/clean/frame_messenger","jquery","modules/core/exception","modules/clean/components/bubble_picker","modules/clean/history","modules/clean/analytics","modules/clean/photos/legacy_thumb_loader","modules/core/browser","modules/clean/react/previews/preview_blank","modules/clean/ajax","modules/clean/react/previews/preview_linkfile","modules/clean/sso_login_checks","modules/clean/sprite","modules/clean/filepath","modules/core/notify","modules/clean/db_bubble","modules/clean/clipboard","modules/core/html"],function(U,cc,bJ,m,x,eS,eR,ak,d5,bB,ch,bR,a9,bl,bG,af,z,dX,bi,cH,cQ,dD,dv,X,eH,S,dg,cM,ck,D,aX,bk,cZ,co,az,dy,ah,dS,d7,aY,cK,d8,ac,aO,cN,b3,cy,aR,an,b7,ea,br,dQ,bn,ei,a0,bh,bO,cx,cp,bu,bT,cj,au,ab,aw,q,eP){var B={};var dt=cc.SimpleModal;var c1=x.Job;var eg=x.ModalProgress;var cu=d5.ContactsCache;var bN=d5.DefaultContactsCache;var eI=ch.TopNotificationBar;var et=ch.EUCookieNotificationBar;var o=ch.ExpiredIOSNotificationBar;var dV=ch.PackratUnlimitedOptInNotificationBar;var b4=ch.DfBAdminEarlyAccessSharingControlsBar;var b0=ch.DfBAdminEarlyAccessFtsBar;var aH=ch.LocaleSwitchBar;var a1=a9.ungettext;var ef=a9._;var dp=a9.N_;var C=a9.E_;var eJ=a9.render_sentences;var ap=cH.ChangeEmail;var dK=cH.EmailVerification;var dN=cQ.DBModal;var dH=cQ.DBModalStack;var c2=cQ.DBUserModal;var u=ck.PreviewImage;var aM=cZ.PreviewImageZoom;var a7=dy.Cash;var eN=dy.CashUtil;var d0=aY.PreviewVideo;var aA=ac.image_best_fit_size;var dq=aO.HierarchicalNavBar;var eO=cN.DfBTransitionInfoFetcher;var bV=dQ.alertd;var cw=dQ.assert;var eq=dQ.reportException;var er=dQ.stackTrace;var E=cx.PreviewBlank;var P=bu.PreviewLinkfile;var dY,eF,cV;INLINE_JS.$=$;INLINE_JS.$u=$u;Function.prototype.defer=Function.prototype.defer.wrap(function(eT){var T;T=$A(arguments).slice(1);this.__tb__=er();return eT.apply(this,T)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(eT){var T,eU;T=$A(arguments).slice(1);try{return eT.apply(this,T)}catch(eV){eU=eV;return cw(0,eU.toString())}});dY=B.Jcached={cache:{},set:function(eT,eU,T){var eV;eV=dY.cache[eT];if(eV==null){eV=dY.cache[eT]={}}eV.value=eU;return eV.expires=T?new Date().getTime()+T:0},get:function(T){var eT;eT=dY.cache[T];if((eT==null)||new Date().getTime()>eT.expires){delete dY.cache[T];return false}return eT.value}};Function.prototype.cached=function(T){var eU,eT;eT=Math.random();eU=this;return function(){var eV;eV=dY.get(eT);if(eV!==false){return eV}eV=eU();dY.set(eT,eV,T);return eV}};Array.prototype.sort_by_key=function(eT,eU){var T;if(eU==null){eU=false}T=eU?-1:1;return this.sort(function(eV,eW){eV=eT(eV);eW=eT(eW);if(eV<eW){return T*-1}else{if(eV>eW){return T*1}else{return 0}}})};Array.prototype.contains=function(T){return this.indexOf(T)!==-1};Array.prototype.remove=function(eT,T){T=T||eT+1;return this.splice(eT,T-eT)};Array.prototype.removeItem=function(eT){var T;T=this.indexOf(eT);if(T>=0){return this.remove(T)}else{return false}};Array.prototype.dict_by=function(T){var eV,eW,eU,eX,eT;eU={};for(eV=eX=0,eT=this.length;eX<eT;eV=++eX){eW=this[eV];eU[this[eV][T]]=this[eV]}return eU};Array.prototype.unique=function(){var eW,eU,eV,eT,T;eW={};for(eV=0,eT=this.length;eV<eT;eV++){eU=this[eV];if(typeof eU!=="string"){return this}eW[eU]=0}T=[];for(eU in eW){T.push(eU)}return T};String.prototype.widthSplit=function(eV){var T,eU,eT,eW;if(eV==null){eV=15}T=[];eU=this;eW=0;eT=eU.substring(eW,eW+eV);while(eT!==""){T.push(eT);eW+=eV;eT=eU.substring(eW,eW+eV)}return T};Object.extend(Effect.Transitions,{EaseIn:function(T){return Math.pow(T,2)},EaseOut:function(T){return Math.pow(T,0.5)}});(function(eU){var eT,T;eT=function(eZ){var eW,e3,e2,e0,e4,eY,eX,e1,eV;if(eZ){if(Object.isArray(eZ)){eW=[];for(eY=0,e1=eZ.length;eY<e1;eY++){e3=eZ[eY];eW.push(eP.escape(e3).toHTML())}eZ=new eP(eW.join(""))}else{if(eZ.top||eZ.bottom||eZ.before||eZ.after){e0=["top","bottom","before","after"];for(eX=0,eV=e0.length;eX<eV;eX++){e2=e0[eX];e4=eZ[e2];if(e4){eZ[e2]=arguments.callee(e4)}}}else{if(dL.isElm(eZ)||eZ.toElement||eZ.toHTML){}else{eZ=eP.escape(eZ)}}}}return eZ};return Element.addMethods({db_observe:function(eW,eV,eX){return eW.observe(eV,function(eY){return eX(eY,eW)})},smoothScrollIntoView:function(eY,eX){var e2,eW,eV,e1,e0,eZ;if(eX==null){eX={}}e2={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};eX=Object.extend(e2,eX);eV=eY.viewportOffset(eY);eW=eY.getDimensions();eZ=document.viewport.getDimensions();e0=eX.padding||0;if(eV.top>e0&&(eV.top+eW.height)<(eZ.height-e0)){return}e1=eV.top<e0?-1*Math.floor(eZ.height/4):-1*Math.floor(3*eZ.height/4);eX.offset=eX.offset||e1;return new Effect.ScrollTo(eY,eX)},__sert:function(eV,eW){return Element.insert(eV,eT(eW))},__date:function(eV,eW){return Element.update(eV,eT(eW))},replace:T=function(eV,eW){return eU(eV,eT(eW))}})})(Element.replace);eF=function(T){if(T!=null?T.target:void 0){try{return document.activeElement=T.target===document?null:T.target}catch(eT){}}};cV=function(T){try{return document.activeElement=null}catch(eT){}};if(document.addEventListener){document.addEventListener("focus",eF,true);document.addEventListener("blur",cV,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(eT,T){var eU;if(T==null){T="0"}eU=this;while(eU.length<eT){eU=T+eU}return eU.toString()};String.prototype.reverse=function(){var eU,eT,T;T=this.split("");eT=T.reverse();eU=eT.join("");return eU};String.prototype.count=function(T){return(this.length-this.gsub(T,"").length)/T.length};String.prototype.repeat=function(T){return(new Array(T+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,e0,eY){var e4,e3,e8,eU,T,e5,e1,eZ,eV,eT,e6,e7,e2,eX,eW;if(eY==null){eY={}}this.orig_req={url:e0,options:eY};this.start_time=bR.time();eY.method=eY.method||"post";eY.evalJS=false;eY.suppress_nonstandard_headers=true;eY.parameters=eY.parameters||{};eY.parameters.t=bk.read(Constants.JS_CSRF_COOKIE);eY.parameters.is_xhr=true;if(eY.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){eY.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){eY.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.PUBLIC_MODE_OVERRIDE){eY.parameters.public_mode_override="1"}if(Constants.COUNTRY_OVERRIDE){eY.parameters.public_mode_override=Constants.COUNTRY_OVERRIDE}if(Constants.GANDALF_PANEL&&e0.indexOf("/")===0){eY.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){eY.parameters.restrict=Ajax.DBRequest.restrict}e3=eY.cleanUp||(function(){});this.subject_user=eY.subject_user||eY.job_user;if(eY.job){this.job_id=dL.nonce();eY.parameters.job_id=this.job_id;dR.watch(this,eY.dont_hide_progress_on_complete)}if(!eY.no_watch){am.watch(this,!!eY.job)}e5=eY.onFailure;e1=eY.onSuccess;T=eY.onComplete;eU=(function(e9){return function(fa){var fc,fb;if(eY.parameters.xhr_retry||!eY.allow_retries){return false}if((fb=fa.status)===0||fb===500||fb===502||fb===503){e9.orig_req.options.parameters.xhr_retry=true;e9.orig_req.options.onFailure=e5;e9.orig_req.options.onSuccess=e1;fc=new Ajax.DBRequest(e9.orig_req.url,e9.orig_req.options);return true}return false}})(this);eY.onFailure=function(fa){var fc,e9,fb;if(c1.handled(fa.request.job_id)){return}if(eU(fa)){return}if(!eY.noAutonotify){if(!Constants.IS_PROD&&fa.status===500&&fa.getHeader("X-Debug-Url")){e0=fa.getHeader("X-Debug-Url");fc=ef("There was a problem completing this request.")+(' <a href="'+e0+'" target="_blank">View debug</a>');ab.error(new eP(fc))}else{ab.error()}}e3(false);if(e5){e5(fa)}if(fa.status===403){e9=dL.session_storage_get("reload-timestamp");if(!e9||bR.time()-e9>30*1000){dL.session_storage_set("reload-timestamp",bR.time());location.reload(true)}}return cw(eY.noAutonotify||((fb=fa.status)===403||fb===404||fb===502),"Ajax "+fa.status+" on "+fa.request.url)};eY.onComplete=(function(e9){return function(fa){if(fa.responseText.length&&T){if(fa.responseText.indexOf("async_task_started:")!==0){return T(fa)}}}})(this);eY.onSuccess=(function(e9){return function(fa){var fm,fs,fk,fp,fi,fe,fl,fn,ff,fd,fo,fq,fh,fg,fb,fr,fj,fc;fg=bR.time()-fa.request.start_time;if(c1.handled(fa.request.job_id)){return}if(!fa.responseText.length){if(!eY.job){if(eU(fa)){return}if(!eY.noAutonotify){if(!fa||fa.status!==0){ab.error()}}if(e5){e5(fa)}}}else{if(fa.responseText.indexOf("err:")===0){if(!eY.noAutonotify){fe=fa.responseText.substr(4);if(eY.html_in_error_msg){fe=new eP(fe)}ab.error(fe)}if(e5){e5(fa)}}else{if(fa.responseText.indexOf("async_task_started:")===0){e9.async_task_id=fa.responseText.split(":")[1];dR.watch(e9)}else{if(e1){if(fa.responseText.indexOf("ok:")===0){ab.success(fa.responseText.substr(3))}e1(fa)}}fh=fa.getHeader("X-Server-Response-Time")||"-1";if(eY.log_timing){dX.log_ajax_transition.defer(fg,void 0,void 0,void 0,fh,e0=a2.absolutize(e9.url))}fm=br("#cprofile");if(!eY.no_watch&&fm.length){ff=""+Constants.REQUEST_ID+"-"+(fa.getHeader("X-Dropbox-Request-Id"));e0=fa.request.url.replace(/[^/]*\/\/[^/]+/,"").replace(/\?.*$/,"");fi="Ajax: "+e0+" ("+fh+"ms)";fl="/profile/cprofile?request_id="+ff;fn=fa.request.url;if(fn.indexOf(Constants.BLOCK_CLUSTER)!==-1){fl+="&block=1"}else{fj=Constants.BATCH_THUMB_ENDPOINTS;for(fb=0,fr=fj.length;fb<fr;fb++){fk=fj[fb];if(fn.indexOf(fk)!==-1){fl+="&block=1";break}}}fp=fl.replace("/cprofile?","/ioprofile?");fd=br('<a target="_new" />').attr("href",fl).text("CG ");fq=br('<a target="_new" />').attr("href",fp).text("IO ");fo=br('<div class="ajax">').text("Ajax: "+e0+" ("+fh+"ms)").prepend(fd,fq);fs=fm.find(".ajax");if(fs.length>=10){fs.last().remove()}fm.prepend(fo)}if(br("#gandalf_panel").length&&fa.request.url.substring(0,14)!=="/gandalf_panel"){if((fc=window.gandalf_panel)!=null){fc.add(fa.request.url,fa.getHeader("X-Dropbox-Request-Id"))}}}}return e3(true)}})(this);eY.onException=function(fa,fb){var fc,e9;if(window.console){throw fb}fc=("Error with AJAX callback for: "+e0+" :::: ")+fb.toString();e9=er();e9.pop();return eq(fc,bO.get_href(),"",e9.join("\n"))};if(eY.job){e0+=(e0.indexOf("?")===-1?"?":"&")+"long_running=1"}if(eY.subject_user&&!((e2=eY.parameters)!=null?e2[Constants.UID_PARAM_NAME]:void 0)){e0=D.parse(e0).updateQuery(Constants.UID_PARAM_NAME,eY.subject_user).toString()}e4=$H({url:e0});if(eY.parameters){e4.update(eY.parameters);eX=e4.keys();for(eV=0,e6=eX.length;eV<e6;eV++){e8=eX[eV];eW=["passwd","password","oauth","ccn","host_id"];for(eT=0,e7=eW.length;eT<e7;eT++){eZ=eW[eT];if(e8.indexOf(eZ)!==-1){e4.unset(e8)}}}e4.unset("t")}eY.onSuccess.__tb_ajax_info__=eY.onFailure.__tb_ajax_info__=Object.toJSON(e4);return $super(e0,eY)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(dL.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())});var cO=[].slice;if(!window.$j){window.$j=window.jQuery}INLINE_JS.$j=br;if(!Function.prototype.bind){Function.prototype.bind=function(T){var eW,eV,eT,eU;if(typeof monkey_check==="function"){monkey_check()}if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}eW=Array.prototype.slice.call(arguments,1);eU=this;eT=function(){};eV=function(){return eU.apply((this instanceof eT&&T?this:T),eW.concat(Array.prototype.slice.call(arguments)))};eT.prototype=this.prototype;eV.prototype=new eT();return eV}}jQuery.fn.curry=function(){var T,eU,eT;eU=arguments[0],eT=arguments[1],T=3<=arguments.length?cO.call(arguments,2):[];if(eT==null){eT=window}if(typeof monkey_check==="function"){monkey_check()}return function(){var eV;eV=1<=arguments.length?cO.call(arguments,0):[];return eU.apply(eT,cO.call(T).concat(cO.call(eV)))}};jQuery.fn.stripTags=function(T){if(typeof monkey_check==="function"){monkey_check()}return T.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.controller=function(T){if(typeof monkey_check==="function"){monkey_check()}if(T!=null){return this.data("jscontroller",T)}else{return this.data("jscontroller")}};jQuery.fn.hasScrollBar=function(){if(typeof monkey_check==="function"){monkey_check()}return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(){if(typeof monkey_check==="function"){monkey_check()}return z.viewport_offset(this)};jQuery.fn.visible=function(){if(typeof monkey_check==="function"){monkey_check()}return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(eT,T){if(typeof monkey_check==="function"){monkey_check()}z.clone_position(this,eT,T);return this};jQuery.format=function(eT,T){if(typeof monkey_check==="function"){monkey_check()}return eT.replace(/\{([^}]+)\}/g,function(eV,eU){if(eU in T){return T[eU]}else{return eV}})};jQuery.cachedScript=function(eT,T){if(typeof monkey_check==="function"){monkey_check()}T=br.extend(T||{},{dataType:"script",cache:true,url:eT});return jQuery.ajax(T)};jQuery.browser=bO;jQuery.addSubjectParam=function(eU,T){var eT;if(typeof monkey_check==="function"){monkey_check()}if(eU.subject_user&&!((eT=eU.data)!=null?eT[Constants.UID_PARAM_NAME]:void 0)){return T[Constants.UID_PARAM_NAME]=String(eU.subject_user)}};jQuery.ajaxPrefilter(function(T,eV,eU){var eT;if(!eV.noDropboxDefaults){eT={t:bk.read(Constants.JS_CSRF_COOKIE),is_xhr:true};jQuery.addSubjectParam(eV,eT);if(jQuery.ajaxSettings.restrict!=null){eT.restrict=jQuery.ajaxSettings.restrict}T.data=br.param(br.extend(eV.data,eT),true);return false}});jQuery.ajax.retryOnce=function(eV,T,eT){var eU;if(typeof monkey_check==="function"){monkey_check()}if(T!=="abort"&&((eU=eV.status)===0||eU===500||eU===502||eU===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var em,c0,dC,a2,dL,df,db=function(T,eT){return function(){return T.apply(eT,arguments)}};dL=INLINE_JS.Util=B.Util={set_min_body_height_to_viewport_height:function(){var T;T=$(document.body);if(T!=null?T.style:void 0){return T.style.minHeight=z.viewport_dimensions().height+"px"}},scroll_to_thumb:function(T){var eW,eV,eU,eT;eV=T.cumulativeOffset().top;eW=T.getHeight();eT=z.scroll_offsets().top;eU=z.viewport_dimensions().height;if(eV<eT||eV+eW>eT+eU){return z.scroll_to(0,eV-eU/2)}},decode_sort_key:function(eU){var eW,eV,eT,T;T=[];for(eV=0,eT=eU.length;eV<eT;eV++){eW=eU[eV];if(typeof eW==="string"){T.push(af.decode(eW))}else{T.push(eW)}}return T},sort_by_rank_or_key:function(T,eT){if((T.sort_rank!=null)&&(eT.sort_rank!=null)){return T.sort_rank-eT.sort_rank}cw((T.sort_key!=null)&&(eT.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(T,eT)},sort_by_key:function(T,eT){return this._sort_by_key(T,eT)},_sort_by_key:function(eT,eY){var eV,T,eU,eX,eW;T=eT.sort_key;eU=eY.sort_key;for(eV=eX=0,eW=T.length;0<=eW?eX<eW:eX>eW;eV=0<=eW?++eX:--eX){if(eU[eV]==null){return 1}if(typeof T[eV]!==typeof eU[eV]){if(typeof T[eV]==="string"){return 1}else{return -1}}else{if(T[eV]!==eU[eV]){if(T[eV]>eU[eV]){return 1}else{return -1}}}}if(eU.length>T.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(T,eW,eU,eT){var eZ,eX,e0,eY,eV;eY=$$(eU);eV=[];for(eX=0,e0=eY.length;eX<e0;eX++){eZ=eY[eX];eV.push((function(e1){var e2;if(T!==e1){cj.src(e1.down("img"),"web","downtick-spacer");return e1.removeClassName("bolded")}else{e1.addClassName("bolded");if(e1.hasClassName("noarrow")){return}e2=eW?"arrow-up-gray":"arrow-down-gray";return cj.src(e1.down("img"),"web",e2)}})(eZ))}return eV},add_sort_arrow_mouseover_j:function(T,eW,eU,eT){var eZ,eX,e0,eY,eV;eY=br(eU);eV=[];for(eX=0,e0=eY.length;eX<e0;eX++){eZ=eY[eX];eV.push((function(e1){var e2;if(T.attr("data-sort")!==br(e1).attr("data-sort")){cj.src(br(e1).find("img")[0],"web","downtick-spacer");return br(e1).removeClass("bolded")}else{br(e1).addClass("bolded");if(br(e1).hasClass("noarrow")){return}e2=eW?"arrow-up-gray":"arrow-down-gray";return cj.src(br(e1).find("img")[0],"web",e2)}})(eZ))}return eV},one_line_fit:function(T){var eU,eT;eU=$$(T);if(eU.length<2){return}eT=(function(eV){return function(){var e4,e1,e0,eY,e3,eZ,eW,eX,e2;e0=eU[0];e3=eU[eU.length-1];eY=e0.cumulativeOffset().top;eZ=e3.cumulativeOffset().top;if(eY!==eZ){e4=parseInt(e0.getStyle("font-size"),10);eW=e4-1;if(eW<8){return}for(eX=0,e2=eU.length;eX<e2;eX++){e1=eU[eX];e1.style.fontSize=eW+"px"}return eT()}}})(this);return eT()},nice_list:function(eT){var eX,eW,eV,T,eU;if(!eT){return""}else{if(eT.length===1){return eT[0]}else{if(eT.length===2){return ef("%(x)s and %(y)s").format({x:eT[0],y:eT[1]})}}}eU=ef("%(x)s, %(y)s, and %(z)s").split(/%\(x\)s|%\(y\)s|%\(z\)s/);cw(eU.length===4,"bad item list format %(x)s, %(y)s, and %(z)s");eW=eU[0];eV=eU[1];T=eU[2];eX=eU[3];return[eW,eT.slice(0,-1).join(eV),T,eT[eT.length-1],eX].join("")},list_em_snippet:function(eT,T){var eX,eV,eU,eW,eZ,eY;eU="";T-=new bG("...").length;for(eV=eZ=0,eY=eT.length;0<=eY?eZ<eY:eZ>eY;eV=0<=eY?++eZ:--eZ){eW=eT[eV];if(eV!==0){eW=", "+eW}eX=new bG(eW).length;if(eX>T){break}T-=eX;eU+=eW}return{str:eU,snipped:eT.length-eV}},start_of_day:function(T){var eT;eT=new Date();eT.setTime(T.getTime());eT.setHours(0);eT.setMinutes(0);eT.setSeconds(0);eT.setMilliseconds(0);return eT},to_iso8601_date:function(eV,eT,eU){var T;if(eT==null){eT=false}if(eU==null){eU=false}if(eT){T=eV.getUTCFullYear().toString()+"-"+(eV.getUTCMonth()+1).toString().lpad(2)+"-"+eV.getUTCDate().toString().lpad(2);if(eU){T+=" "+eV.getUTCHours().toString().lpad(2)+":"+eV.getUTCMinutes().toString().lpad(2)+":"+eV.getUTCSeconds().toString().lpad(2)}}else{T=eV.getFullYear().toString()+"-"+(eV.getMonth()+1).toString().lpad(2)+"-"+eV.getDate().toString().lpad(2);if(eU){T+=" "+eV.getHours().toString().lpad(2)+":"+eV.getMinutes().toString().lpad(2)+":"+eV.getSeconds().toString().lpad(2)}}return T},to_mysql_date:function(eW,T,eU){var eT,eX,eV;eT=eW.getFullYear().toString()+"-"+(eW.getMonth()+1).toString().lpad(2)+"-"+eW.getDate().toString().lpad(2);eV=eW.getHours().toString().lpad(2)+":"+eW.getMinutes().toString().lpad(2)+":"+eW.getSeconds().toString().lpad(2);eX="."+eW.getMilliseconds().toString().lpad(3);if(!T){return eT}if(!eU){return eT+" "+eV}return eT+" "+eV+eX},from_mysql_date:function(eT){var eV,eX,eU,eZ,T,eY,eW;eZ=eT.split(" ");eV=eZ[0];eY=eZ.length>1?eZ[1]:false;eX=eV.split("-");cw(eX.length===3,"weird date format on "+this+", expected yyyy-mm-dd");eU=new Date(eX[0],parseInt(eX[1],10)-1,eX[2]);if(eY){eW=eY.split(":");cw(eW.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");eU.setHours(eW[0]);eU.setMinutes(eW[1]);T=eW[2].split(".");eU.setSeconds(T[0]);if(T.length>1){eU.setMilliseconds(T[1])}}return eU},make_table:function(T,eZ){var eU,eY,e0,eT,eW,eV,eX;e0=new Element("table",eZ);eT=new Element("tbody");e0.__sert(eT);for(eY in T){eX=T[eY];eV=new Element("tr");eW=new Element("td").insert(eY);eU=new Element("td").insert(eX);eV.__sert(eW);eV.__sert(eU);eT.__sert(eV)}return e0},validate_email:function(T){var eT;eT=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,15}$","i");return eT.test(T)},scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(eU){var eT,T;T=this.scried;eT=T[eU];if(!eT){eT=$(eU);T[eU]=eT}return eT},urlquote:function(T){return T.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var eT,T;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(eT=$("ieconsole"))!=null?eT.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(T=console.log)!=null?T.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(eU,eT){var T;T=this.childElementWithIndex(eU,eT);return T[0]},childElementWithIndex:function(eZ,eU){var eW,eY,eV,eT,eX,T;eW=0;eT=eZ.childNodes;for(eV=eX=0,T=eT.length;eX<T;eV=++eX){eY=eT[eV];if(eY.nodeType===1&&eW++===eU){return[eY,eV]}}return[false,false]},disableSelection:function(T){T.onselectstart=function(){return false};T.unselectable="on";T.style.MozUserSelect="none";return T.style.cursor="default"},enableSelection:function(T){T.onselectstart=function(){return true};T.unselectable="off";T.style.MozUserSelect="";return T.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(T,eZ,eX,eW){var eU,eV,eT,eY;if(!eX){eX=function(e0,e1){return e0-e1}}eU=T.length;eV=0;while(eU>eV){eT=Math.floor(eU/2+eV/2);eY=eX(T[eT],eZ);if(eY>0){eU=eT}else{if(eY<0){eV=eT+1}else{return eT}}}if(eW){return eV}else{return -1}},nonce:function(){var eU,T,eT;eU=new Date();eT=eU.getTime().toString();T=Math.floor(Math.random()*1000000).toString().lpad(6);return eT+T},focus:function(eT){if(eT){eT=$(eT);try{return eT.focus()}catch(T){}}},sumStyles:function(eV,eW){var T,eU,eX,eT;eU=0;if(eV){for(eX=0,eT=eW.length;eX<eT;eX++){T=eW[eX];eU+=parseInt(eV.getStyle(T),10)||0}}return eU},async_load_script:function(eT){var T;T=function(){var eV,eU;eU=document.createElement("script");eU.src=eT;eU.type="text/javascript";eU.async=true;eV=document.getElementsByTagName("script")[0];return eV.parentNode.insertBefore(eU,eV)};if(document.readyState==="complete"){return T()}else{if(window.attachEvent!=null){return window.attachEvent("onload",T)}else{return window.addEventListener("load",T,false)}}},smart_window_load:function(T){if(document.readyState==="complete"){return T.defer()}else{return Event.observe(window,"load",T)}},isNumber:function(T){return !isNaN(Number(T,10))},shorten_url:function(T,eT){return new Ajax.DBRequest("/shorten_url",{parameters:{url:T},onSuccess:function(eU){return eT(eU.responseText)}})},falsy_to_empty:function(T){return T||""},preloaded_images:{},preload_image:function(eV,eU,eT){var T;if(this.preloaded_images[eV]){return}T=new Image();if(eU!=null){Element.extend(T).observe("error",eU)}if(eT!=null){Element.extend(T).observe("load",eT)}T.src=eV;return this.preloaded_images[eV]=T},get_preloaded_image:function(T){if(this.preloaded_images[T]){return this.preloaded_images[T].clone()}else{return new Element("img",{src:T})}},clear_selected:function(){var T;if(window.getSelection){T=window.getSelection();if(T.removeAllRanges){return T.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(T){var eU,eT;eU=20;eT=z.viewport_dimensions();return T>eT.width-eU},freshbutton_overlay:function(eT,T){var eV,eU;eU=eT instanceof jQuery&&eT||br(eT);eV=T instanceof jQuery&&T||br(T);eU.on("mouseover",(function(eW){return function(){return eV.addClass("hovered")}})(this));eU.on("mouseout",(function(eW){return function(){eV.removeClass("hovered");return eV.removeClass("pressed")}})(this));eU.on("mousedown",(function(eW){return function(){eV.removeClass("hovered");return eV.addClass("pressed")}})(this));return eU.on("mouseup",(function(eW){return function(){return eV.removeClass("pressed")}})(this))},isElm:function(T){if(typeof HTMLElement==="object"){return T instanceof HTMLElement}else{return T&&typeof T==="object"&&T.nodeType===1&&typeof T.nodeName==="string"}},_track_twitter_chars_left:function(eT,eU){var T;clearInterval(this.chars_left_interval);T=(function(eV){return function(){var eW,eX;eW=$("twitter-chars");eX=eU-$F(eT).strip().length;if(eX<0){eW.addClassName("too-long")}else{eW.removeClassName("too-long")}return eW.__date(eX)}})(this);return this.chars_left_interval=setInterval(T,250)},session_storage_set:function(T,eT){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(T,JSON.stringify(eT))},session_storage_get:function(T){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(T))}},pdf_plugins:function(){var eU,eT,T;T=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return eU=(function(){var eY,eW,eX,eV;eX=window.navigator.plugins;eV=[];for(eY=0,eW=eX.length;eY<eW;eY++){eT=eX[eY];if(T.test(eT.name)){eV.push(eT)}}return eV})()},get_window_location:function(){return window.location}};dL.scrollLeft=dL.scrollLeft.cached(50);dL.scrollTop=dL.scrollTop.cached(50);dC=B.UIButton=(function(){T.prototype.selector=function(){return".ui-button"};T.prototype.over=function(eT,eU){return eU.addClassName("over")};T.prototype.out=function(eT,eU){return eU.removeClassName("over")};T.prototype.down=function(eT,eU){return eU.addClassName("down")};T.prototype.up=function(eT){return $$(this.selector()+".down").invoke("removeClassName","down")};function T(){this.clear=db(this.clear,this);this.up=db(this.up,this);this.listen()}T.prototype.active=function(eU,eV){var eT;eT=br(eV);if(eT.hasClass("ui-button-dropdown")){if(eT.hasClass("active")){br(document).trigger("dropdownClosed",[1])}else{br(document).trigger("dropdownOpened",[1])}}return eT.toggleClass("active")};T.prototype.clear=function(eZ){var eU,eT,eY,e1,e0,eX,eV,e2,eW;e0=$(eZ.target);eT=this.selector()+".active";eX=e0.match(eT)&&e0||e0.up(eT);eY=0;eW=$$(eT);for(eV=0,e2=eW.length;eV<e2;eV++){e1=eW[eV];eU=br(e1);if(eX!==e1){if(eU.hasClass("active")&&eU.hasClass("ui-button-dropdown")){eY+=1}eU.removeClass("active")}}return br(document).trigger("dropdownClosed",[eY])};T.prototype.listen=function(){$(document.body).on("mouseover",this.selector(),this.over);$(document.body).on("mouseout",this.selector(),this.out);$(document.body).on("mousedown",this.selector(),this.down);document.on("mouseup",this.up);$(document.body).on("click",this.selector(),this.active);return document.on("click",this.clear)};return T})();if(window.console==null){window.console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var eU,eW,eT,eV,T;new dC();if(dL.ie8){eV=$$("#page-header a, #page-footer a");T=[];for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];if(eU.target==="_blank"){T.push(eU.target="")}else{T.push(void 0)}}return T}});c0=__CONDITIONAL_JS__.Trace=B.Trace=(function(){var T;T=[];return{log:function(){var eT;eT=bR.time()+": "+$A(arguments).join(" ");return T.push(eT)},get:function(){return T.join("\n")}}})();em=B.T=function(){return c0.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var T;em("dom:loaded");T=function(){var eV,eT,eU,eW;eU=$("page-content");if(eU){eW=z.viewport_dimensions();eT=$(document.body);eV="absolutize";if(eW.width<eU.getWidth()){return eT.addClassName(eV)}else{return eT.removeClassName(eV)}}};Event.observe(window,"resize",$u.debounce(T,150));return T()});Event.observe(window,"load",function(){return em("window:load")});a2=B.URLUtil={absolutize:function(T){if(T.startsWith("https://")||T.startsWith("http://")){return T}else{if(T.charAt(0)==="/"){return""+window.location.protocol+"//"+window.location.host+T}else{return cw(0,"absolutize is confused by "+T)}}}};df=B.Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var T,eT;if(this.old_y==null){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:z.scroll_offsets().top;return}if(this.max_delta_y==null){this.max_delta_y=0;return}eT=this.scroll_container!=null?this.scroll_container.scrollTop:z.scroll_offsets().top;T=Math.abs(this.max_delta_y)<Math.abs(eT-this.old_y);if(T){this.max_delta_y=eT-this.old_y;return this.old_y=eT}},start_capture:function(T){this.scroll_container=T;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(T){if(T==null){T=false}cw(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(T){return this.last_nonzero_velocity}return this.velocity}};var c9;c9=B.DomUtil={fromElm:function(T){return $(T).innerHTML},updateFromElm:function(eT,T){eT=$(eT);T=$(T);return eT.update(this.fromElm(T))},fillVal:function(eZ,eW){var eT,eY,eV,eX,T,eU;eX=$$("."+eW);eU=[];for(eY=0,eV=eX.length;eY<eV;eY++){eT=eX[eY];eT=$(eT);if(eT.tagName==="INPUT"){eT.value=eZ;eU.push(eT.defaultValue=eZ)}else{if(eT.innerHTML===""&&((T=eT.tagName)==="A"||T==="B"||T==="INPUT"||T==="I"||T==="LABEL"||T==="SELECT"||T==="SPAN"||T==="TEXTAREA")){dL.log("Filling an empty value; this may look broken in IE7",eT)}eU.push(eT.innerHTML=eZ)}}return eU},copy_to_clipboard:function(e0,eX,e1){var eV,eU,T,eT,eY,eW;eV=$("hold_clipboard");eV.value=e0;if(eV.createTextRange){eW=eV.createTextRange();if(eW&&((typeof BodyLoaded==="undefined"||BodyLoaded===null)||BodyLoaded===1)){try{return eW.execCommand("Copy")}catch(eZ){eY=eZ;e1=e1||ef("Please copy the text below:");eX=eX||ef("Copy text");this.fillVal(e0,"text-to-copy");this.fillVal(e1,"copy-modal-body");eM.show(eX,this.fromElm("copy-modal"),{wit_group:"copy_to_clipboard"});return $("text-to-copy").select()}}}else{if(!$("flashcb")){T=document.createElement("div");T.id="flashcb";document.body.appendChild(T)}$("flashcb").innerHTML="";eU=encodeURIComponent(eV.value);eT='<embed src="/static/swf/_clipboard.swf" FlashVars="clipboard=#{clipboard}" width="0" height="0" type="application/x-shockwave-flash"></embed>';return $("flashcb").innerHTML=eT}}};var am;am=B.RequestWatcher={reqs:[],working_msg:ef("Still working...",{comment:"Comment about waiting for a process to complete"}),last_notification:null,TIMEOUT:10,watch:function(eT,eU){var T;T=this.reqs;if(!T.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(eU){eT.skip_message=true}return T.push([eT,bR.time()])},check_up:function(){return this.scan(false)},remove:function(T){return this.scan(T)},scan:function(eX){var e1,eT,eV,T,eZ,eY,eU,e0,eW;eT=bR.time();eV=[];eW=this.reqs;for(eU=0,e0=eW.length;eU<e0;eU++){T=eW[eU];eZ=T[0];eY=T[1];e1=eT-eY;if(eZ.transport.readyState===4){this.clearWorkingMessage();continue}if(e1>4000&&!eZ.skip_message){eZ.skip_message=true;if(ab.isShown()&&ab.current()===!U.undo_notification){this.last_notification=ab.success(this.working_msg)}}if(e1>this.TIMEOUT*1000&&eZ.job){eZ.transport.abort()}if(eZ!==eX){eV.push([eZ,eY])}else{eZ.transport.abort()}}this.reqs=eV;if(!eV.length){return clearInterval(this.int_id)}},clearWorkingMessage:function(){if(ab.isShown()&&ab.current()===this.last_notification){return ab.clear()}}};br(function(){var eU,eT,eV,T;eV=Prototype.Browser;T=[];for(eU in eV){eT=eV[eU];if(eT===true){T.push(br(document.body).addClass(eU.toLowerCase()))}}return T});var ds,aU,cO=[].slice;ds=B.HTML5_HISTORY=Modernizr.history;br((function(T){return function(){return ei.init()}})(this));aU=B.HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",_get_location:function(){return window.location.href},_set_location:function(T){return window.location.href=T},_replace_location:function(T){return window.location.replace(T)},init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(T,eT){this.callback_map[T]=eT;if(!this.watch_timer){return this.init()}},check_hash:function(){var eT,eU,eV,eX,eW,T;eX=this._get_location().split("#")[1];if(eX!=null){eX=eX.replace(/%27/g,"'")}if(this.last_hash===eX){return}this.last_hash=eX;if(this.last_prefix&&eX===""){eX=this.last_prefix+":"}else{if(!eX){return}}T=eX.split(":");eW=T.first();this.last_prefix=eW;eV=this.callback_map[eW];if(eV!=null){eU=(function(){var e1,eZ,e0,eY;e0=T.slice(1);eY=[];for(e1=0,eZ=e0.length;e1<eZ;e1++){eT=e0[e1];eY.push(decodeURIComponent(eT))}return eY})();eV.apply(null,eU)}return $(document).fire("db:hash_change",{hash:eX})},_prepare_hash:function(eU){var eT,T;T=$A(eU).map(dL.falsy_to_empty);eT=T.map(encodeURIComponent);return eT.join(":")},set_hash:function(){var T,eT;T=1<=arguments.length?cO.call(arguments,0):[];eT=this._prepare_hash(T);return this._set_hash(eT)},replace_hash:function(){var T,eT;T=1<=arguments.length?cO.call(arguments,0):[];eT=this._prepare_hash(T);return this._set_hash(eT,true)},_set_hash:function(eT,T){if(eT===""){eT="/"}this.last_hash=eT;if(!T){return this._set_location("#"+eT)}else{return this._replace_location("#"+eT)}}};var dk;dk=B.SharingState=(function(){function T(){}T.set_role=function(eT){br(".shared-folder-role-param").val(eT);return this.role=eT};T.set_is_merged=function(eT){return this.is_merged=eT};T.set_team_name=function(eT){return this.team_name=eT};T.set_team_permissions=function(eU,eT){if(eU==null){eU=false}if(eT==null){eT=false}this.team_only=eU;return this.show_groups=eT};T.set_not_logged_in_role_and_email=function(eU,eT){this.not_logged_in_role=eU;return this.not_logged_in_email=eT};T.set_show_inbox=function(eT){return this.show_inbox=eT};return T})();var aP;aP=B.SharingUtil=(function(){function T(){}T.success_string_for_recipients=function(eT){var eU;if(eT.length===1){if(eT[0].indexOf("@")===-1){eU=ef("Sent to %(recipient)s.",{comment:"Recipient is a user's name"}).format({recipient:eT[0]})}else{eU=ef("Sent to %(recipient)s.",{comment:"Recipient is an email address"}).format({recipient:eT[0]})}}else{if(eT.length===2){if(eT[0].indexOf("@")===-1){if(eT[1].indexOf("@")===-1){eU=ef("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are users' names."}).format({recipient_first:eT[0],recipient_second:eT[1]})}else{eU=ef("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is a user's name, second is an email address"}).format({recipient_first:eT[0],recipient_second:eT[1]})}}else{if(eT[1].indexOf("@")===-1){eU=ef("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is an email address, second is a user's name"}).format({recipient_first:eT[0],recipient_second:eT[1]})}else{eU=ef("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are email addresses"}).format({recipient_first:eT[0],recipient_second:eT[1]})}}}else{if(eT[0].indexOf("@")===-1){eU=ef("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:eT[0],num_others:eT.length-1})}else{eU=ef("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:eT[0],num_others:eT.length-1})}}}return eU};return T})();var ba,cd;ba=B.SharingApi=(function(){T.REQUEST_SUCCEEDED_EVENT="db:sharing_api:request_succeeded";function T(eT){this.user=eT}T.prototype.invite_more_to_folder=function(eU,eT,eW,eY,eV,eX){var eZ;eZ={ns_id:eU,emails:eT.emails||[],fb_ids:eT.fb_ids||[],group_ids:eT.group_ids||[],new_style_group_ids:eT.new_style_group_ids||[],custom_message:eW||"",access_type:eY};return this._make_request("/share_ajax/invite_more",eZ,eV,eX,true)};T.prototype.update_member_access_type=function(eT,eY,eW,eU,eV){var eX;eX={ns_id:eT,member_uid:eY,access_type:eW};return this._make_request("/share_ajax/update_member_access_type",eX,eU,eV)};T.prototype.update_group_access_type=function(eU,eX,eT,eV,eW){var eY;eY={ns_id:eU,group_gid:eX,can_edit:eT};return this._make_request("/share_ajax/update_group_access_type",eY,eV,eW)};T.prototype.update_invite_access_type=function(eX,eV,eT,eU){var eW;eW={invite_id:eX,access_type:eV};return this._make_request("/share_ajax/update_invite_access_type",eW,eT,eU)};T.prototype.share_folder=function(e2,eW,eV,e1,e0,eU,e3,eT,eY,e4,eX){var eZ,e5;eZ={emails:eV.emails||[],fb_ids:eV.fb_ids||[],group_ids:eV.group_ids||[],new_style_group_ids:eV.new_style_group_ids||[],custom_message:e1||"",audience:e0,inviter:eU,shared_link_policy:e3,access_type:eT,folder_settings:1};if(e2){eZ.folder_name=eW;e5="/share_ajax/new"}else{eZ.path=eW;e5=eY?"/share_ajax/existing_no_recipient":"/share_ajax/existing"}if(e0||eU){eZ.custom_folder_settings=1}return this._make_request(e5,eZ,e4,eX,true)};T.prototype.share_path=function(e4,eV,e0,eZ,eU,e1,eT,eX,e2,eW){var eY,e3;eY={emails:eV.emails||[],fb_ids:eV.fb_ids||[],group_ids:eV.group_ids||[],new_style_group_ids:eV.new_style_group_ids||[],custom_message:e0||"",audience:eZ,inviter:eU,shared_link_policy:e1,access_type:eT,folder_settings:1,path:e4};e3="/share_ajax/new_path";if(eZ||eU){eY.custom_folder_settings=1}return this._make_request(e3,eY,e2,eW,true)};T.prototype.share_file=function(eX,e1,eV,e0,eZ,eU,e2,eT,e3,eW){var eY,e4;eY={emails:eV.emails||[],fb_ids:eV.fb_ids||[],group_ids:eV.group_ids||[],new_style_group_ids:eV.new_style_group_ids||[],custom_message:e0||"",audience:eZ,inviter:eU,shared_link_policy:e2,access_type:eT,folder_settings:1,path:eX,file_path:e1};e4="/share_ajax/share_file";if(eZ||eU){eY.custom_folder_settings=1}return this._make_request(e4,eY,e3,eW,true)};T.prototype.unshare_folder=function(eU,eT,eV){var eW;eW={ns_id:eU,async:true};if(eT){eW.keep_files=true}return this._make_request("/share_ajax/unshare?long_running",eW,eV)};T.prototype.leave_folder=function(eU,eT,eV){var eW;eW={ns_id:eU};if(eT){eW.keep_files=true}return this._make_request("/share_ajax/leave?long_running",eW,eV)};T.prototype.transfer_ownership=function(eT,eV,eU){var eW;eW={ns_id:eT,user_id:eV};return this._make_request("/share_ajax/change_sf_owner",eW,eU)};T.prototype.cancel_invite=function(eT,eW,eU){var eV;eV={ns_id:eT,invite_id:eW};return this._make_request("/share_ajax/cancel_invite",eV,eU)};T.prototype.kick=function(eU,eW,eT,eV){var eX;eX={ns_id:eU,user_id:eW};if(eT){eX.keep_files=true}return this._make_request("/share_ajax/kick_user",eX,eV)};T.prototype.kick_group=function(eT,eV,eU){return ab.error("This feature has been removed.")};T.prototype.reinvite_user=function(eT,eW,eU){var eV;eV={ns_id:eT,invite_id:eW};return this._make_request("/share_ajax/reinvite_user",eV,eU)};T.prototype.update_sf_permissions=function(eT,eW,eU,eV){var eX;eX={ns_id:eT,new_permissions:eW};return this._make_request("/share_ajax/change_sf_perm",eX,eU,eV)};T.prototype.update_sf_team_permissions=function(eT,eW,eX,eV,eZ,eU){var eY;eY={ns_id:eT,audience:eW,inviter:eX,shared_link_policy:eV};if(!(eZ===void 0)){eY.activity_feed_enabled=eZ}return this._make_request("/share_ajax/save_folder_settings",eY,eU)};T.prototype.validate_new_sf_path=function(eW,eT,eU){var eV;eV={share_type:"new",folder_name:eW};return this._make_request("/share_ajax/validate_folder",eV,eT,eU,true)};T.prototype.validate_existing_sf_path=function(eW,eT,eU){var eV;eV={share_type:"existing",path:eW};return this._make_request("/share_ajax/validate_folder",eV,eT,eU,true)};T.prototype._make_request=function(eU,eY,eT,eV,eX){var eW;if(eX==null){eX=false}eY[Constants.UID_PARAM_NAME]=this.user.id;if((eW=this.loading_elem)!=null){eW.addClass("ajax-loading")}return new Ajax.DBRequest(eU,{parameters:eY,onSuccess:function(eZ){if(typeof eT==="function"){eT(eZ)}return br(document).trigger(T.REQUEST_SUCCEEDED_EVENT,{request_url:eU,ns_id:eY.ns_id||null})},onFailure:eV,onComplete:(function(eZ){return function(){var e0;return(e0=eZ.loading_elem)!=null?e0.removeClass("ajax-loading"):void 0}})(this),noAutonotify:eX})};return T})();cd=B.UserlessSharingApi=(function(){function T(){}T.prototype.get_inbox_counts=function(eT){return new Ajax.DBRequest("/inbox_count",{onSuccess:(function(eU){return function(eW){var eV;eV=JSON.parse(eW.responseText);cw(typeof eV==="object","bad inbox_count");return eT(eV)}})(this)})};T.prototype.get_folder_info=function(eT,eU){return new Ajax.DBRequest("/share_ajax/list_folders",{onSuccess:eT,onFailure:eU})};return T})();var p;p=INLINE_JS.SharingModals=B.SharingModals=(function(){function T(){}T.show_shared_folder_options_modal=function(eW,eT,eU,eV){if(eU==null){eU=true}if(eV==null){eV=true}return dH.push(new cX(eT,eW,eU,eV))};T.show_share_inband_modal=function(eV,eU,eT,eW){return ek.createAndShowInbandModal(eU,eV,true,eT,true,false,eW)};T.show_shared_folder_wizard=function(eT){return new d6(eT,{element_id:"share-a-folder-wizard-modal"}).show()};T.get_select_role_modal=function(){return new cs({element_id:"select-role-modal"})};T.start_wizard_without_user=function(){if(cy.get_viewer().is_paired){if(this.select_role_modal==null){this.select_role_modal=T.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(cy.get_viewer().get_users()[0])}};T.start_wizard_for_user=function(eT){if(dK.get_for_user(eT).verified_or_show(d8.SHARE_FOLDER)){return T.show_shared_folder_wizard(eT)}};T.show_share_existing_modal=function(eV,eT){var eU;if(dK.get_for_user(eT).verified_or_show()){eU=new cb(eT,{folder_name:eV,element_id:"invite-to-new-sf-wizard-modal-"+eT.id});return eU.show()}};T.show_shmodel_or_invite_modal=function(eU,eW,eT,eV){if(dK.get_for_user(eT).verified_or_show()){return new dF(eT,{path:eU,existing_sf:eW,element_id:"create-link-or-invite-wizard-modal",target_item:eV}).show()}};T.show_unshare_team_sf_modal=function(eU,eT,eW){var eV;eV=new bQ(eU,{element_id:"unshare-confirm-modal",team_shared_folder:true,ns_id:eT,folder_path:eW});return eV.show()};T.show_ignore_modal=function(eU,eX,eT){var eW,eV,eY;cw(eT,"Share ignore did not get an ns_id");eY=ef("Permanently remove '%(folder_name)s'").format({folder_name:bG.em_snippet(au.filename(eX),15)});eW={path:eX,ns_id:eT};eV=new c2(eU,{element_id:"ignore-confirm",title:eY});eV.on_confirm_button_click=function(e1){var e0,eZ,e2;e1.preventDefault();e0=br(e1.target);eZ=e0.closest("form");e2=function(e3){ab.success(ef("Removed shared folder successfully."));document.fire(aB.SF_IGNORE,{target_ns_id:eT,user_id:eU.id});return eV.hide()};return bF.ajax_submit(eZ[0],false,e2,void 0,e0[0],eW)};return eV.show()};T.show_rejoin_modal=function(eU,eX,eT){var eW,eV,eY;cw(eT,"Rejoin didn't get an ns_id");eY=ef("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:bG.em_snippet(au.filename(eX),13)});eW={path:eX,ns_id:eT};eV=new c2(eU,{element_id:"rejoin-confirm",title:eY});eV.on_confirm_button_click=function(e1){var e0,eZ,e2;e1.preventDefault();e0=br(e1.target);eZ=e0.closest("form");e2=function(e5){var e3,e4;e4=e5.responseText;e3=au.filename(e4);ab.success(ef("Rejoined shared folder successfully."));document.fire(aB.SF_REJOIN,{target_ns_id:eT,user_id:eU.id,filename:e3,mount_point:e4});return eV.hide()};return bF.ajax_submit(eZ[0],false,e2,void 0,e0[0],eW)};return eV.show()};T.show_invites=function(){return dH.push(new co({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};T.show_shared_subfolder_modal=function(eU,eW){var eZ,eX,eY,eT,eV;eY=bG.em_snippet(au.filename(eU),14);eX=ef("Can't share folder");eT="'%(parent_shared_folder)s' ".format({parent_shared_folder:eY});c9.fillVal(eT.escapeHTML(),"parent_shared_folder_name");eZ=ef("Share '%(parent_shared_folder)s' folder");eV=eZ.format({parent_shared_folder:eY});($("share_parent_folder_button")).value=eV;eM.show(ef("Loading shared folder options..."),"<p style='margin: 3em 0; text-align: center;'> <img src='/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif' alt=''/></p>");br("#share_parent_folder_button").on("click",(function(e0){return function(e1){eM.hide();return e0.show_shared_folder_options_modal(eU,eW)}})(this));return eM.show(eX,$("share_subfolder"))};return T})();var cW;cW=B.InviteFormController=(function(){function T(eV,eU,eT,e0,eZ,eY){var eX,eW;this.user=eV;this.$form=eU;this.members=eT;this.invitees=e0;this.new_style_groups=eZ;this.team_only=this.$form.data("team-only");eW={tokens:[",",";"],include_fb:true,members:this.members,invitees:this.invitees,new_style_groups:this.new_style_groups,contacts_only:true};if(this.user.role==="work"){eX=Autocompleter.TeamTokenizer;eW.team_only=this.team_only}else{eX=Autocompleter.ContactsTokenizer;eW.include_team=true}if(this.user.role==="work"&&(__CIRCULAR_DEPENDENCY__.GroupsApi!=null)){eW.include_new_style_groups=true}this.sharing_options_auto_completer=new eX(this.user,eY+"-new-collab-input",eY+"-new-whobulk",eY+"-hidden-input",eW);b5._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new i(this.$form)}}T.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};T.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};T.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};T.prototype.reset_options=function(){return br(this.sharing_options_auto_completer.get_entry_container()).hide()};T.prototype.set_team_only=function(eT){this.team_only=eT;return this.sharing_options_auto_completer.setTeamOnly(eT)};T.prototype.extract_invitees=function(){var eW,eV,eU,eZ,eY,eT,eX;eZ={};eX=["emails","fb_ids","group_ids","new_style_group_ids"];for(eY=0,eT=eX.length;eY<eT;eY++){eV=eX[eY];eU=this.$form.find("input[name="+eV+"]");eZ[eV]=[(function(){var e2,e1,e0;e0=[];for(e2=0,e1=eU.length;e2<e1;e2++){eW=eU[e2];e0.push(br(eW).val())}return e0})()]}return eZ};T.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};T.prototype.get_access_type=function(){return this.$form.find(".can-edit-dropdown").data("selected-value")};return T})();var aF,cX,N,ed,aL,eu,da,ci,dx,bz,aC,bQ,ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV},db=function(T,eT){return function(){return T.apply(eT,arguments)}};dx=B.SharedFolderBaseModal=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;T.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new ba(this.user)}T.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return T})(dN);cX=B.ExistingSharedFolderOptionsModal=(function(eT){cA(T,eT);function T(eV,eX,eW,eY,eU){var e0,eZ;this.user=eV;if(eW==null){eW=true}if(eY==null){eY=true}this.restore_modal=eU;this.__show_modal=db(this.__show_modal,this);this.__x_click_handler=db(this.__x_click_handler,this);cw(eX!=null,"Missing folder path");this.path=au.normalize(eX);eZ=ef("Shared folder options for '%(folder)s'");eZ=eZ.format({folder:bG.em_snippet(au.filename(eX),13)});e0={};e0[Constants.UID_PARAM_NAME]=this.user.id;e0.max_results=20;e0.show_invite_form=eW;e0.show_folder_settings=eY;dH.register(aF.MODAL_DONE_VIEWING_EVENT,(function(e1){return function(){return typeof e1.restore_modal==="function"?e1.restore_modal():void 0}})(this));T.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:eZ,endpoint_url:D({path:"/share_options"+this.path}).toString(),parameters:e0})}T.prototype.__x_click_handler=function(eV){var eU;T.__super__.__x_click_handler.apply(this,arguments);eU={path:this.path};a0.SharedFolderActivityLogger.log("web","invite_modal_x_button",this.user,eU);return typeof this.restore_modal==="function"?this.restore_modal():void 0};T.prototype.__show_modal=function(eV){var eU;T.__super__.__show_modal.apply(this,arguments);eU={path:this.path};return a0.SharedFolderActivityLogger.log("web","invite_modal_displayed",this.user,eU)};return T})(co);aF=B.ExistingSharedFolderOptionsContent=(function(){T.CONTENT_LOADED_EVENT="db:sharing_options:content_loaded";T.MODAL_DONE_VIEWING_EVENT="db:sharing_options:modal_done_viewing_event";function T(eX,eV,eW,eT,eU){this.$root=eX;this.options=eT;this.show_invite_form=eU;this.show_email_verification=db(this.show_email_verification,this);this.show_folder_settings=db(this.show_folder_settings,this);this.toggle_from_invite_mode=db(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=db(this.toggle_to_invite_mode,this);this.show_leave_folder_modal=db(this.show_leave_folder_modal,this);this.show_owner_leave_folder_warning=db(this.show_owner_leave_folder_warning,this);this.show_access_request_link_modal=db(this.show_access_request_link_modal,this);this.show_unshare_folder_modal=db(this.show_unshare_folder_modal,this);this.show_uninvite_modal=db(this.show_uninvite_modal,this);this.show_transfer_user_modal=db(this.show_transfer_user_modal,this);this.show_kick_group_modal=db(this.show_kick_group_modal,this);this.show_kick_user_modal=db(this.show_kick_user_modal,this);this.update_tf_access=db(this.update_tf_access,this);this.update_sf_perms=db(this.update_sf_perms,this);this.reinvite_user=db(this.reinvite_user,this);this.submit_invitations=db(this.submit_invitations,this);this.maybe_load_more=db(this.maybe_load_more,this);this.extract_user_data_and_call=db(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=db(this.extract_invitee_data_and_call,this);this._disable_token_for_sf=db(this._disable_token_for_sf,this);this.user=cy.get_viewer().get_user_by_id(eV);this.path=au.normalize(eW);if(this.options){this.members=this.options.folder_members;this.invitees=this.options.folder_invitees;this.new_style_groups=this.options.new_style_groups;this.num_total=this.options.num_total}this.$root.find(".bubble-dropdown").click(function(eY){z.controller(br(eY.target).closest(".sf-action-dropdown")).closeDropdown();return true});this.start=20;this.max_results=100;this.maybe_load_more();this.sharing_api=new ba(this.user);this.sharing_api.loading_elem=this.$root;a3.register_all();cP.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");this.log_extras={path:this.path,ns_id:this.ns_id};this.sf_access_type.hide();this.listen();dH.trigger(T.CONTENT_LOADED_EVENT)}T.prototype.listen=function(){var eW,eV,eU,eY,eT,eX;this.$root.find(".confirm-button").click((function(eZ){return function(e0){e0.preventDefault();return eZ.submit_invitations()}})(this));this.$root.find(".cancel-button").click((function(eZ){return function(e0){e0.preventDefault();return eZ.toggle_from_invite_mode()}})(this));if(this.show_invite_form){eW=this.$root.find("#sharing-options-new-collab-input");eX=["focus","keypress","contextmenu"];for(eY=0,eT=eX.length;eY<eT;eY++){eU=eX[eY];eW.off(eU);eW.on(eU,this.toggle_to_invite_mode)}eV=this.$root.find("#custom-message-wizard");eV.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new cW(this.user,this.$invite_form,this.members,this.invitees,this.new_style_groups,"sharing-options")}}this.$root.on("click","a.leave-folder",(function(eZ){return function(e0){e0.preventDefault();a0.SharedFolderActivityLogger.log("web","invite_modal_leave_button",eZ.user,eZ.log_extras);return eZ.show_leave_folder_modal()}})(this));this.$root.on("click","a.owner-leave-folder",(function(eZ){return function(e0){e0.preventDefault();a0.SharedFolderActivityLogger.log("web","invite_modal_owner_leave_button",eZ.user,eZ.log_extras);return eZ.show_owner_leave_folder_warning()}})(this));this.$root.on("click","a.kick-user",(function(eZ){return function(e0){return eZ.extract_user_data_and_call(e0,eZ.show_kick_user_modal)}})(this));this.$root.on("click","a.kick-group",(function(eZ){return function(e2){var e0,e1,e3;e2.preventDefault();e0=br(e2.currentTarget);e3=e0.data("group-name");e1=e0.data("group-gid");return eZ.show_kick_group_modal(e3,e1)}})(this));this.$root.on("click","a.make-owner",(function(eZ){return function(e0){return eZ.extract_user_data_and_call(e0,eZ.show_transfer_user_modal)}})(this));this.$root.on("click","a.send-email",(function(eZ){return function(e1){var e0,e2;e1.preventDefault();e0=br(e1.currentTarget);e2=e0.data("email");return window.location=D({scheme:"mailto",path:e2}).toString()}})(this));this.$root.on("click","a.reinvite-user",(function(eZ){return function(e0){return eZ.extract_invitee_data_and_call(e0,eZ.reinvite_user)}})(this));this.$root.on("click","a.uninvite-user",(function(eZ){return function(e0){return eZ.extract_invitee_data_and_call(e0,eZ.show_uninvite_modal)}})(this));this.$root.on("click","input.sf-action-leave",(function(eZ){return function(e0){e0.preventDefault();a0.SharedFolderActivityLogger.log("web","invite_modal_leave_button",eZ.user,eZ.log_extras);return eZ.show_leave_folder_modal()}})(this));this.$root.on("click","input.sf-action-unshare",(function(eZ){return function(e0){e0.preventDefault();a0.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",eZ.user,eZ.log_extras);return eZ.show_unshare_folder_modal()}})(this));this.$root.on("click","input.simple-sharing-remove-link",(function(eZ){return function(e0){e0.preventDefault();return eZ._disable_token_for_sf(function(){return dH.pop()})}})(this));this.$root.on("click","a.remove-link",(function(eZ){return function(e0){var e1;e0.preventDefault();e1=function(){var e2;e2=dN.get_containing_modal(eZ.$root);if(e2&&e2 instanceof co){return e2.fetch()}};return eZ._disable_token_for_sf(e1)}})(this));this.$root.on("click","input.sf-action-get-link",(function(eZ){return function(e0){e0.preventDefault();return eZ.show_access_request_link_modal()}})(this));this.$root.on("click","input.sf-action-done",(function(eZ){return function(e0){e0.preventDefault();a0.SharedFolderActivityLogger.log("web","invite_modal_done_button",eZ.user,eZ.log_extras);dH.trigger(T.MODAL_DONE_VIEWING_EVENT);return dH.pop()}})(this));this.$root.on("click","input#change-sf-perm-checkbox",(function(eZ){return function(e1){var e0;e0=br(e1.currentTarget);return eZ.update_sf_perms(e0.prop("checked"))}})(this));return this.$root.on("click","input#change-tf-access-checkbox",(function(eZ){return function(e1){var e0;e0=br(e1.currentTarget);return eZ.update_tf_access(!e0.prop("checked"))}})(this))};T.prototype._disable_token_for_sf=function(eT){return cp.WebRequest({url:D({path:"/sm/disable_token_at_path"+au.normalize(this.path)}),subject_user:this.user.id,type:"POST",success:(function(eU){return function(){br(document).trigger("db:browse:update");ab.success(ef("Link removed"));a0.SimpleSharingLogger.log(eU.user.id,25);return typeof eT==="function"?eT():void 0}})(this),error:(function(eU){return function(){return ab.error(ef("An error occurred when removing link"))}})(this)})};T.prototype.extract_invitee_data_and_call=function(eW,eV){var eT,eX,eU;eW.preventDefault();eT=br(eW.currentTarget);eU=eT.data("email-or-fbname");eX=eT.data("invite-id");return eV(eU,this.ns_id,eX)};T.prototype.extract_user_data_and_call=function(eY,eX){var eU,eW,eV,eT;eY.preventDefault();eU=br(eY.currentTarget);eV=eU.data("display-name");eW=eU.data("email");eT=eU.data("user-id");return eX(eV,eW,eT)};T.prototype.maybe_load_more=function(){var eU,eT,eV;eT=this.$root.closest("body").length;if(!eT){return}if((this.num_total==null)||(this.start>=this.num_total)){br("#more-members-spinner").hide();return}br("#more-members-spinner").show();eV={};eV[Constants.UID_PARAM_NAME]=this.user.id;eV.start=this.start;eV.max_results=this.max_results;eU=D({path:"/share_options"+this.path}).toString();this.$root.removeClass("ajax-loading");new bl(this.$root,eU,{data:eV,success:(function(eW){return function(e0,eX,e1){var eY,eZ;if(((eZ=e0.data)!=null?eZ.options:void 0)!=null){eY=e0.data.options;if((eW.members!=null)&&(eY.folder_members!=null)){Array.prototype.push.apply(eW.members,eY.folder_members)}if((eW.invitees!=null)&&(eY.folder_invitees!=null)){Array.prototype.push.apply(eW.invitees,eY.folder_invitees)}if((eW.new_style_groups!=null)&&(eY.new_style_groups!=null)){Array.prototype.push.apply(eW.new_style_groups,eY.new_style_groups)}}return eW.maybe_load_more()}})(this),error:(function(eW){return function(eZ,eX,eY){return ab.error("Unable to load all members of this folder.")}})(this)});return this.start=this.start+this.max_results};T.prototype.submit_invitations=function(){var eW,eV,eY,eU,eX,eT;this.invite_form_controller.tokenize();eY=this.invite_form_controller.extract_invitees();eX=this.invite_form_controller.get_custom_message();eW=this.invite_form_controller.get_access_type();eU=$u.clone(this.log_extras);eU.access_type=eW;a0.SharedFolderActivityLogger.log("web","invite_modal_send_invites_button",this.user,eU);eT=(function(eZ){return function(e1){var e0;e0=dN.get_containing_modal(eZ.$root);if(e0&&e0 instanceof co){e0.fetch()}else{dH.pop()}ab.success(e1.responseText);return document.fire(aB.SF_INVITE,{target_ns_id:eZ.ns_id,user_id:eZ.user.id})}})(this);eV=(function(eZ){return function(e0){return eo.show_validation_error(e0,eZ.$root.find(".tokenized_autocompleter_container"))}})(this);return this.sharing_api.invite_more_to_folder(this.ns_id,eY,eX,eW,eT,eV)};T.prototype.reinvite_user=function(eV,eT,eU){return this.sharing_api.reinvite_user(eT,eU,(function(eW){return function(e3){var e0,e1,e2,eZ,eX,eY;eZ=JSON.parse(e3.responseText);eX=eZ.status;if(eX==="OK"){eY=ef("%(email_or_fbname)s was reinvited successfully");eY=eY.format({email_or_fbname:eV});return ab.success(eY)}else{e2=eZ.reason;if(e2==="ACCEPTED"){e0=ef("That invitation has already been accepted.")}else{if(e2==="DECLINED"){e0=ef("That invitation has already been declined.")}else{e0=ef("You no longer have permission to perform this action.")}}ab.error(e0);if(eZ.reload){e1=dN.get_containing_modal(eW.$root);if(e1&&e1 instanceof co){return e1.fetch()}}}}})(this))};T.prototype.update_sf_perms=function(eU){var eV,eW,eT;this.$root.find("#change-sf-perm-saving").show();eV=(eU?1:0);eT=(function(eX){return function(eY){if(eU){ab.success(ef("Editors can now manage membership of this folder."))}else{ab.success(ef("Editors can no longer manage membership of this folder."))}return eX.$root.find("#change-sf-perm-saving").hide()}})(this);eW=(function(eX){return function(eY){if(eY.responseText.indexOf("err:")===0){ab.error(eY.responseText.substr(4))}else{ab.error(ef("Error updating your preference! Please try again."))}return eX.$root.find("#change-sf-perm-saving").hide()}})(this);return this.sharing_api.update_sf_permissions(this.ns_id,eV,eT,eW)};T.prototype.update_tf_access=function(eU){var eV,eT;eT=(function(eW){return function(eX){if(eU){return ab.success(ef("Team members can now change folder contents."))}else{return ab.success(ef("Team members can no longer change folder contents."))}}})(this);eV=(function(eW){return function(eX){return ab.error(ef("Error updating your preference! Please try again."))}})(this);return this.sharing_api.update_group_access_type(this.ns_id,this.$root.data("group-gid"),eU,eT,eV)};T.prototype.show_kick_user_modal=function(eV,eU,eT){return dH.push(new eu(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:eV,folder_path:this.path,user_id:eT}))};T.prototype.show_kick_group_modal=function(eT,eU){return dH.push(new aL(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:eT,folder_path:this.path,group_id:eU}))};T.prototype.show_transfer_user_modal=function(eV,eU,eT){return dH.push(new bz(this.user,{element_id:"transfer-confirm-modal",user_id:eT,user_name:eV,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.show_uninvite_modal=function(eV,eT,eU){return dH.push(new aC(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:eV,ns_id:eT,invite_id:eU,folder_path:this.path}))};T.prototype.show_unshare_folder_modal=function(){return dH.push(new bQ(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.show_access_request_link_modal=function(){return dH.push(new cY(this.user.id,this.path,void 0,true))};T.prototype.show_owner_leave_folder_warning=function(){return ab.error(ef("You can't leave this folder because you're the owner. You must transfer ownership to another member before you can leave."))};T.prototype.show_leave_folder_modal=function(){return dH.push(new da(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.toggle_to_invite_mode=function(){var eT;this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");return(eT=this.sf_access_type)!=null?eT.show():void 0};T.prototype.toggle_from_invite_mode=function(){var eU,eT;this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if((eU=this.sf_access_type)!=null){eU.hide()}return(eT=this.invite_form_controller)!=null?eT.reset_autocompleter():void 0};T.prototype.show_folder_settings=function(eT){a0.SharedFolderActivityLogger.log("web","invite_modal_change_settings",this.user,this.log_extras);eT.preventDefault();dH.register(ed.SAVED_PERMISSIONS,(function(eU){return function(eW,eV){if(eV!=null){return eU.set_team_only(eV)}}})(this));return dH.push(new ed(this.user,this.path,this.ns_id))};T.prototype.show_email_verification=function(eT){dH.pop();return dK.get_for_user(this.user).show()};T.prototype.set_team_only=function(eT){var eU;this.invite_form_controller.set_team_only(eT);eU=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(eT){return eU.addClass("team-only")}else{return eU.removeClass("team-only")}};return T})();da=B.LeaveFolderModal=(function(T){cA(eT,T);function eT(){this.before_show=db(this.before_show,this);this.on_show=db(this.on_show,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);return eT.__super__.constructor.apply(this,arguments)}eT.prototype.on_confirm_button_click=function(eV){var eU;eV.preventDefault();eU=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,eU,(function(eW){return function(){var eX;eX=ef("You removed yourself from '%(msg)s'.").format({msg:bG.em_snippet(au.filename(eW.path),25)});ab.success(eX);document.fire(aB.SF_LEAVE,{target_ns_id:eW.ns_id,folder_deleted:!eU,user_id:eW.user.id});return dH.clear()}})(this))};eT.prototype.on_show=function(){eT.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};eT.prototype.before_show=function(){var eU;eU=ef("Leave the shared folder '%(folder_name)s'");eU=eU.format({folder_name:bG.em_snippet(au.filename(this.path),14)});return this.format({".db-modal-title-text":eU})};return eT})(dx);bQ=B.UnshareFolderModal=(function(eT){cA(T,eT);function T(){this.before_show=db(this.before_show,this);this.on_show=db(this.on_show,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);return T.__super__.constructor.apply(this,arguments)}T.prototype.on_confirm_button_click=function(eV){var eU;eV.preventDefault();eU=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,eU,(function(eW){return function(){var eX;eX=ef("Unshared folder '%(folder_name)s'");eX=eX.format({folder_name:bG.em_snippet(au.filename(eW.path),25)});ab.success(eX);document.fire(aB.SF_UNSHARE,{target_ns_id:eW.ns_id,user_id:eW.user.id});return dH.clear()}})(this))};T.prototype.on_show=function(){T.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".tsf_unshare_desc").show();return this.$modal_window.find(".regular_unshare_desc").hide()}else{this.$modal_window.find(".tsf_unshare_desc").hide();return this.$modal_window.find(".regular_unshare_desc").show()}};T.prototype.before_show=function(){var eU;eU=ef("Unshare '%(folder_name)s'");eU=eU.format({folder_name:bG.em_snippet(au.filename(this.path),21)});return this.format({".db-modal-title-text":eU})};return T})(dx);aC=B.UninviteModal=(function(eT){cA(T,eT);function T(eU,eV){this.before_show=db(this.before_show,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);this.email_or_fbname=eV.email_or_fbname;this.ns_id=eV.ns_id;this.invite_id=eV.invite_id;T.__super__.constructor.call(this,eU,eV)}T.prototype.on_confirm_button_click=function(eU){eU.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,(function(eV){return function(e1){var eZ,e0,eY,eW,eX;eY=JSON.parse(e1.responseText);eW=eY.status;if(eW==="OK"){eX=ef("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:eV.email_or_fbname});ab.success(eX)}else{e0=eY.reason;if(e0==="ACCEPTED"){eZ=ef("That invitation has already been accepted.")}else{if(e0==="DECLINED"){eZ=ef("That invitation has already been declined.")}}ab.error(eZ)}return dH.pop()}})(this))};T.prototype.before_show=function(eU){var eV;eV=ef("Uninvite %(email_or_fbname)s?").format({email_or_fbname:bG.em_snippet(this.email_or_fbname,20)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":au.filename(this.path),".db-modal-title-text":eV})};return T})(dx);eu=B.KickUserModal=(function(T){cA(eT,T);function eT(eU,eV){this.user=eU;this.options=eV;this.before_show=db(this.before_show,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);this.user_id=eV.user_id;this.user_name=eV.user_name;eT.__super__.constructor.call(this,eU,eV)}eT.prototype.on_confirm_button_click=function(eW){var eU,eV;eW.preventDefault();eU=this.$modal_window.find("#keep-files-check").prop("checked");this.sharing_api.kick(this.ns_id,this.user_id,eU,(function(eX){return function(){ab.success(ef("User removed successfully."));bM.reload_folder_info_if_two_account();return dH.pop()}})(this));eV={ns_id:this.ns_id,kick_user_id:this.user_id,keep_files:eU};return a0.SharedFolderActivityLogger.log("web","invite_modal_kick_collaborator",this.user,eV)};eT.prototype.before_show=function(eU){var eV;eV=ef("Remove %(person_name)s from this folder?");eV=eV.format({person_name:this.user_name});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":eV})};return eT})(dx);aL=B.KickGroupModal=(function(T){cA(eT,T);function eT(eU,eV){this.user=eU;this.options=eV;this.before_show=db(this.before_show,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);this.group_id=eV.group_id;this.group_name=eV.group_name;eT.__super__.constructor.call(this,eU,eV)}eT.prototype.on_confirm_button_click=function(eU){eU.preventDefault();return __CIRCULAR_DEPENDENCY__.GroupsApi.remove_namespace_from_group({group_id:this.group_id,ns_id:this.ns_id},(function(eV){return function(){ab.success(ef("Group removed successfully."));bM.reload_folder_info_if_two_account();return dH.pop()}})(this))};eT.prototype.before_show=function(){var eU;eU=ef("Remove %(group_name)s from this folder?");eU=eU.format({group_name:this.group_name});return this.format({".kick-confirm-nickname":this.group_name,".db-modal-title-text":eU})};return eT})(dx);ci=B.MakeOwnerModal=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;this.before_show=db(this.before_show,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);this.member_uid=eV.member_uid;this.member_name=eV.member_name;this.ns_id=eV.ns_id;this.access_type=eV.access_type;T.__super__.constructor.call(this,eU,eV)}T.prototype.on_confirm_button_click=function(eU){eU.preventDefault();return this.sharing_api.update_member_access_type(this.ns_id,this.member_uid,this.access_type,(function(eV){return function(){ab.success(ef("%(name)s now is the owner.").format({name:eV.member_name}));return dH.pop()}})(this))};T.prototype.before_show=function(){var eU;eU=ef("Make %(name)s the owner of this folder?");eU=eU.format({name:bG.em_snippet(this.member_name,14)});return this.format({".make-owner-confirm-nickname":this.member_name,".db-modal-title-text":eU})};return T})(dx);bz=B.TransferOwnershipModal=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;this.before_show=db(this.before_show,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);this.user_id=eV.user_id;this.user_name=eV.user_name;T.__super__.constructor.call(this,eU,eV)}T.prototype.on_confirm_button_click=function(eU){eU.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,(function(eV){return function(eW){ab.success(ef("Ownership changed successfully"));return dH.pop()}})(this))};T.prototype.before_show=function(){var eU;eU=ef("Make %(person_name)s the owner of this folder?");eU=eU.format({person_name:bG.em_snippet(this.user_name,14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":eU})};return T})(dx);ed=B.ExistingSharedFolderPermissionsModal=(function(eT){cA(T,eT);T.SAVED_PERMISSIONS="existing_sf_permissions:saved";function T(eV,eW,eU,eZ){var eY,eX;this.user=eV;this.path=eW;this.ns_id=eU;this.on_hide=eZ;eY={ns_id:this.ns_id,folder_name:this.path};eY[Constants.UID_PARAM_NAME]=this.user.id;eX=ef("'%(folder_name)s' settings");eX=eX.format({folder_name:bG.em_snippet(au.filename(this.path),13)});T.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:eX,endpoint_url:"/share_ajax/folder_settings",parameters:eY})}return T})(co);N=B.ExistingSharedFolderPermissionsContent=(function(){function T(eU,eV,eT){this.$form=eU;this.ns_id=eT;this._submit=db(this._submit,this);this.user=cy.get_viewer().get_user_by_id(eV);this.sharing_api=new ba(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(){return dH.pop()};T.prototype._submit=function(eY){var eZ,eT,eW,eV,eU,eX;eY.preventDefault();eT=this.$form.find("input[name=audience]:checked").val();eW=this.$form.find("input[name=inviter]:checked").val();eU=this.$form.find("input[name=shared_link_policy]:checked").val();eZ=(eX=this.$form.find("input[name=activity_feed_enabled]:checked"))!=null?eX.val():void 0;this.sharing_api.update_sf_team_permissions(this.ns_id,eT,eW,eU,eZ,(function(e0){return function(e2){var e1,e3;e1=JSON.parse(e2.responseText);e3=e1.team_only_invite;ab.success(e1.message);dH.trigger(ed.SAVED_PERMISSIONS,e3);return dH.pop()}})(this));false;eV={ns_id:this.ns_id,audience:eT,inviter:eW};return a0.SharedFolderActivityLogger.log("web","settings_modal_save",this.user,eV)};return T})();var aS,dM,ey,dF,aT,eo,cb,cm,d6,cS,b1,bE,cJ,cI,cG,cE,ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV},db=function(T,eT){return function(){return T.apply(eT,arguments)}};aS=B.BaseShareAFolderWizardModal=(function(T){cA(eT,T);eT.prototype.base_title=null;eT.prototype.personal_title=null;eT.prototype.work_title=null;function eT(eU,eV){this.user=eU;this.options=eV;eT.__super__.constructor.call(this,this.options);this.sharing_api=new ba(this.user)}eT.prototype.before_show=function(){var eU;this.sharing_api.loading_elem=this.$modal_window;eU=this.base_title;if(cy.get_viewer().is_paired){if(this.user.role==="personal"){eU=this.personal_title}else{eU=this.work_title.format({team_name:cy.get_viewer().team_name})}}return this.format({".db-modal-title-text":eU})};return eT})(dN);d6=B.ShareAFolderWizardModal=(function(T){cA(eT,T);function eT(eU,eV){this.user=eU;this.options=eV;eT.__super__.constructor.call(this,this.user,this.options);this.base_title=ef("Share a folder");this.personal_title=ef("Share a folder from your personal Dropbox");this.work_title=ef("Share a folder from your %(team_name)s Dropbox")}eT.prototype.on_show=function(){this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(eU){return function(eV){eV.preventDefault();p.start_wizard_without_user();return eU.hide()}})(this));return this.$modal_window.find("#new-or-existing-sf li").on("click",(function(eU){return function(eV){br(eV.currentTarget).find('input[name="sf_type"]').prop("checked",true);if(eU.$modal_window.find("input#create-new-sf").is(":checked")){return a0.SharedFolderActivityLogger.log("web","new_or_existing_modal_new_folder",eU.user)}else{return a0.SharedFolderActivityLogger.log("web","new_or_existing_modal_existing_folder",eU.user)}}})(this))};eT.prototype.on_confirm_button_click=function(e0){var eX,eZ,eU,eW,eY,eV;e0.preventDefault();eZ=this.$modal_window.find("input#create-new-sf").is(":checked");if(eZ){eW=null;if(this.user.role==="work"){eY="shared-folder-type-wizard-modal";eV=dN.get_template(eY);if(eV.length){eW=new bE(this.user,{element_id:eY})}}if(eW===null){eW=new b1(this.user,{element_id:"share-new-folder-wizard-modal"})}this.hide();eU={selection:"new_folder"};a0.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,eU);return eW.show()}eX=this.$modal_window.find(".ajax-loading-indicator").show();return br.ajax({url:"/share_ajax/account_has_existing_folders",type:"post",subject_user:this.user,success:(function(e1){return function(e2){var e3;e2=JSON.parse(e2);if(e2===true){eW=new cS(e1.user,{element_id:"share-existing-folder-wizard-modal"});eU.has_existing_folder=true}else{e3=ef("You don't have any existing folders. Please create and share a new folder.");eW=new b1(e1.user,{element_id:"share-new-folder-wizard-modal",error_msg:e3});eU.has_existing_folder=false}e1.hide();return eW.show()}})(this),error:(function(e1){return function(){return ab.error()}})(this),complete:(function(e1){return function(){return eX.hide()}})(this)},eU={selection:"existing_folder"},a0.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,eU))};return eT})(aS);bE=B.SharedFolderTypeWizardModal=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;T.__super__.constructor.call(this,this.user,this.options);this.work_title=ef("Share a folder from your %(team_name)s Dropbox")}T.prototype.on_show=function(){this.$modal_window.find("input#team-folder-option").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(eU){return function(eV){eV.preventDefault();p.start_wizard_for_user(eU.user);return eU.hide()}})(this));return this.$modal_window.find("#shared-folder-type li").on("click",(function(eU){return function(eV){br(eV.currentTarget).find('input[name="shared_folder_type"]').prop("checked",true);if(eU.$modal_window.find("input#team-folder-option").is(":checked")){return a0.SharedFolderActivityLogger.log("web","shared_folder_type_team_folder",eU.user)}else{return a0.SharedFolderActivityLogger.log("web","shared_folder_type_shared_folder",eU.user)}}})(this))};T.prototype.on_confirm_button_click=function(eY){var eU,eW,eX,eV;eY.preventDefault();eU=(function(eZ){return function(e2,e0){var e1;e2.preventDefault();e0.hide();e1=new eZ.constructor(eZ.user,eZ.options);return e1.show()}})(this);eW=this.$modal_window.find("input#team-folder-option").is(":checked");if(eW){eX=new dD({element_id:"new-team-folder-modal",open_created_folder:true,back_fn:eU});eV="team_folder"}else{eX=new b1(this.user,{element_id:"share-new-folder-wizard-modal",back_fn:eU});eV="shared_folder"}a0.SharedFolderActivityLogger.log("web","shared_folder_type_next_button",this.user,{selection:eV});this.hide();return eX.show()};return T})(aS);eo=B.InlineModalValidationError=(function(){function T(){}T.show_validation_error=function(e0,eW){var eX,eY,eV,eU,eZ,eT;if(e0.responseText.indexOf("err:{")===0){eT=e0.responseText.substr(4);eZ=JSON.parse(eT);for(eY in eZ){eX=eZ[eY];if("message_text" in eX){eU=eW.find("span.error-message");if(eU.length===0){eU=br("<span/>").addClass("error-message");eW.prepend(eU)}eU.text(eX.message_text);return}}eW.find("span.error-message").remove();return ab.error()}else{eW.find("span.error-message").remove();if(e0.responseText.indexOf("err:")===0){eV=e0.responseText.substr(4);return ab.error(eV)}else{return ab.error()}}};return T})();cJ=B.TeamSharedFolderWizardModalPage1=(function(T){cA(eT,T);function eT(eU,eV){this.user=eU;this.options=eV;this.__fix_position=db(this.__fix_position,this);eT.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page1 input[type=text]";this.base_title=ef("Now, let's set up your team");this.options.vertical_offset=5}eT.prototype.on_show=function(){var eV,eX,eU,eW;eW=this.$modal_window.find(".suggestion-input");for(eX=0,eU=eW.length;eX<eU;eX++){eV=eW[eX];cP.register($(eV))}this.$modal_window.find("#validate-team-name").submit((function(eY){return function(eZ){eZ.preventDefault();return eY.on_confirm_button_click(eZ)}})(this));if(this.options.error_msg){ab.error(this.options.error_msg)}return a0.SharedFolderActivityLogger.log("web","team_shared_group_name_land",this.user)};eT.prototype.on_confirm_button_click=function(eX){var eV,eU,eW;eX.preventDefault();eW=this.$modal_window.find("#new-team-shared-folder-name-input").val();eU=(function(eY){return function(){var eZ;eZ=new cI(eY.user,{team_name:eW,element_id:"team-shared-folder-wizard-modal-page2"});eY.hide();return eZ.show()}})(this);eV=(function(eY){return function(eZ){a0.SharedFolderActivityLogger.log("web","team_shared_group_name_folder_exists",eY.user);return eo.show_validation_error(eZ,eY.$modal_window.find("#validate-team-name"))}})(this);return this.sharing_api.validate_new_sf_path(eW,eU,eV)};eT.prototype.__fix_position=function(eV){var eU;eU=this.$modal_window.find(".db-modal");return eU.css({margin:"0",position:"fixed"})};return eT})(aS);cI=B.TeamSharedFolderWizardModalPage2=(function(T){cA(eT,T);function eT(eU,eV){this.user=eU;this.options=eV;this.__fix_position=db(this.__fix_position,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);eT.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-email1 input[type=text]";this.base_title=ef("Invite teammates");this.folder_name=this.options.team_name}eT.prototype.before_show=function(){var eU;eU=ef("Add people to %(folder_name)s").format({folder_name:this.folder_name});return this.format({"#figcaption_headline":eU})};eT.prototype.on_show=function(){a0.SharedFolderActivityLogger.log("web","team_shared_group_emails_land",this.user);return this.$modal_window.find("#enter-email-invites").submit((function(eU){return function(eV){eV.preventDefault();return eU.on_confirm_button_click(eV)}})(this))};eT.prototype.on_confirm_button_click=function(eY){var eW,eV,e0,eU,eZ,eX;eY.preventDefault();e0={emails:[]};a0.SharedFolderActivityLogger.log("web","team_shared_group_emails_submit",this.user);for(eU=eX=1;eX<=10;eU=++eX){eW=this.$modal_window.find("#new-team-shared-folder-email"+eU).val();if(eW){e0.emails.push(eW)}}eV=dK.getForRole(cf.active_user.role);if(!eV.verified_or_show()){a0.SharedFolderActivityLogger.log("web","team_shared_group_not_email_verified",this.user);return eV.send_email("share_folder",(function(e1){return function(){var e2;e2=new cG(e1.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:e1.folder_name,invitees:e0,from_email_verification:true});e1.hide();return e2.show()}})(this))}else{a0.SharedFolderActivityLogger.log("web","team_shared_group_email_verified",this.user);eZ=new cG(this.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:this.folder_name,invitees:e0,from_email_verification:true});this.hide();return eZ.show()}};eT.prototype.__fix_position=function(eV){var eU;eU=this.$modal_window.find(".db-modal");eU.css;return{margin:"0",position:"fixed"}};return eT})(aS);cG=B.TeamSharedFolderWizardModalPage3=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;this.__fix_position=db(this.__fix_position,this);T.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page3 input[type=text]";this.base_title=ef("Creating %(folder_name)s team and sending invites!").format({folder_name:this.options.folder_name})}T.prototype.on_show=function(){var eZ,eX,eW,eV,e1,e0,eY,eU;a0.SharedFolderActivityLogger.log("web","team_shared_group_interstitial",this.user);this.$modal_window.find("#db-modal-close-x").click((function(e2){return function(e3){e3.preventDefault();return e2.on_close_button_click(e3)}})(this));e1="";e0=true;eX=false;eV="all";eY=false;eZ=null;eU=(function(e2){return function(e5){var e3,e4;e3=JSON.parse(e5.responseText);ab.success(e3.success_msg);e4=new cE(e2.user,{element_id:"team-shared-folder-wizard-modal-page4",folder_name:e2.options.folder_name,invitees:e2.options.invitees,from_email_verification:true});e2.hide();return e4.show()}})(this);eW=(function(e2){return function(e3){return e2.hide()}})(this);return this.sharing_api.share_folder(e0,this.options.folder_name,this.options.invitees,e1,eX,eV,eY,eZ,false,eU,eW)};T.prototype.on_confirm_button_click=function(eU){eU.preventDefault();return this.hide()};T.prototype.__fix_position=function(eV){var eU;eU=this.$modal_window.find(".db-modal");return eU.css({margin:"0",position:"fixed"})};return T})(aS);cE=B.TeamSharedFolderWizardModalPage4=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;this.__fix_position=db(this.__fix_position,this);T.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page4 input[type=text]";this.base_title=ef("%(folder_name)s created and invites sent!").format({folder_name:this.options.folder_name})}T.prototype.before_show=function(){var eU;eU=this.$modal_window.find("#back_to_home");eU.attr("href","/home/"+this.options.folder_name);return this.format({"#figcaption_headline":this.base_title})};T.prototype.on_show=function(){return a0.SharedFolderActivityLogger.log("web","team_shared_group_final",this.user)};T.prototype.__fix_position=function(eV){var eU;eU=this.$modal_window.find(".db-modal");return eU.css({margin:"0",position:"fixed"})};return T})(aS);b1=B.ShareNewFolderWizardModal=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;this.options.focus="#new-shared-folder-wizard input[type=text]";T.__super__.constructor.call(this,this.user,this.options);this.base_title=ef("Create a new shared folder");this.personal_title=ef("Create a shared folder in your personal Dropbox");this.work_title=ef("Create a shared folder in your %(team_name)s Dropbox")}T.prototype.on_show=function(){var eV,eX,eU,eW;eW=this.$modal_window.find(".suggestion-input");for(eX=0,eU=eW.length;eX<eU;eX++){eV=eW[eX];cP.register($(eV))}this.$modal_window.find("#validate-folder-name").submit((function(eY){return function(eZ){eZ.preventDefault();return eY.on_confirm_button_click(eZ)}})(this));if(this.options.error_msg){ab.error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",(function(eY){return function(eZ){if(eY.options.back_fn){return eY.options.back_fn(eZ,eY)}else{eZ.preventDefault();eY.hide();return p.start_wizard_for_user(eY.user)}}})(this))};T.prototype.on_confirm_button_click=function(eX){var eW,eY,eV,eU;eX.preventDefault();eY=this.$modal_window.find("#new-shared-folder-name-input").val();eV={folder_name:eY};a0.SharedFolderActivityLogger.log("web","name_new_folder_modal_next_button",this.user,eV);br(document).trigger("db:share_new_folder:next");eU=(function(eZ){return function(){var e0;e0=new cb(eZ.user,{folder_name:eY,element_id:"invite-to-new-sf-wizard-modal-"+eZ.user.id});eZ.hide();e0.new_folder=true;e0.show();return a0.SharedFolderActivityLogger.log("web","name_new_folder_modal_success",eZ.user,eV)}})(this);eW=(function(eZ){return function(e0){var e1;e1=b3.extract_errors(e0.responseText);a0.SharedFolderActivityLogger.log("web","name_new_folder_modal_fail",eZ.user,eV);if(e1===false){}else{if(typeof e1==="string"){return ab.error(e1)}else{br("#new-shared-folder-name-input .error-message").remove();return b3.fill_errors(br("#validate-folder-name"),e1)}}}})(this);return this.sharing_api.validate_new_sf_path(eY,eU,eW)};return T})(aS);cS=B.ShareExistingFolderWizardModal=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;this._hide=db(this._hide,this);this.on_show=db(this.on_show,this);T.__super__.constructor.call(this,this.user,this.options);this.base_title=ef("Choose folder to share");this.personal_title=ef("Choose a folder from your personal Dropbox");this.work_title=ef("Choose a folder from your %(team_name)s Dropbox")}T.prototype.on_show=function(){this.treeview_id="copy-move-treeview";this.treeview_parent_id=br("#"+this.treeview_id).parent().attr("id");bP.schedule_reset();bP.move(this.treeview_id,"share-existing-treeview",{onSuccess:((function(eU){return function(){var eV;br(document).on("db:treeview_selected",function(eX,eW){return eU.folder_name=eW});eV=br(".first-treeview-link");if(!dL.ie){return eV.click()}}})(this)),user:this.user});return this.$modal_window.find("a.back").on("click",(function(eU){return function(eV){eV.preventDefault();eU.hide();return p.start_wizard_for_user(eU.user)}})(this))};T.prototype._hide=function(){bP.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return T.__super__._hide.apply(this,arguments)};T.prototype.on_hide=function(){return br(document).off("db:treeview_selected")};T.prototype.on_confirm_button_click=function(eX){var eW,eV,eU;eV={folder_name:this.folder_name};eX.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();a0.SharedFolderActivityLogger.log("web","choose_folder_modal_shared_next",this.user,eV);return p.show_shared_folder_options_modal(this.folder_name,this.user)}else{eU=(function(eY){return function(){var eZ;eZ=new cb(eY.user,{folder_name:eY.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+eY.user.id});eY.hide();a0.SharedFolderActivityLogger.log("web","choose_folder_modal_not_shared_next",eY.user,eV);eZ.new_folder=false;return eZ.show()}})(this);eW=(function(eY){return function(eZ){return eo.show_validation_error(eZ,eY.$modal_window.find("#choose-existing-folder"))}})(this);return this.sharing_api.validate_existing_sf_path(this.folder_name,eU,eW)}};return T})(aS);aT=B.CreateOrShareNewFolderWizardModal=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;this.on_confirm_button_click=db(this.on_confirm_button_click,this);this._extract_invitees=db(this._extract_invitees,this);this._toggle_send_button_state=db(this._toggle_send_button_state,this);T.__super__.constructor.call(this,this.options);this.destination_dir=this.options.destination_dir;this.sharing_api=new ba(this.user);this.state="Create"}T.prototype.on_show=function(){var eV,eW,eY,eX,eU;this.$send_button=this.$modal_window.find(".confirm-button");this.$cancel_button=this.$modal_window.find(".cancel-button");eY="create-and-share-new-folder-invite-wizard-"+this.user.id;this.file_name_input=this.$modal_window.find("#create-and-share-new-folder-name-input");this.file_name_input.focus();eW=eY+"-new-collab-input";this.collab_input=this.$modal_window.find("#"+eW);eV={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:this.user.id,max_textbox_height:30};this.autocompleter=new Autocompleter.ContactsTokenizer(this.user,eW,eY+"-new-whobulk",eY+"-hidden-input",eV);if((eX=this.file_name_input)!=null){eX.keyup(this._toggle_send_button_state)}if((eU=this.collab_input)!=null){eU.keyup(this._toggle_send_button_state)}if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_send_button_state);this.collab_input[0].on("token:add",this._toggle_send_button_state)}return this._toggle_send_button_state()};T.prototype._toggle_send_button_state=function(){var eW,eV,eU,eX;eU=((eX=this.autocompleter)!=null?eX.token_manager.tokens.length:void 0)===0;eU=eU&&this.collab_input.val()==="";eW=this.file_name_input.val();eV=eW==="";this.$send_button.prop("disabled",eV);if(eU){this.$send_button.text(ef("Create folder"));return this.state="Create"}else{this.$send_button.text(ef("Share folder"));return this.state="Share"}};T.prototype._extract_invitees=function(){var eY,eW,eX,eV,e1,e0,eU,eZ;eX=this.$modal_window.find(".tokenized_autocompleter_container");e1={};eZ=["emails","fb_ids","group_ids","new_style_group_ids"];for(e0=0,eU=eZ.length;e0<eU;e0++){eW=eZ[e0];eV=eX.find("input[name="+eW+"]");e1[eW]=(function(){var e4,e3,e2;e2=[];for(e4=0,e3=eV.length;e4<e3;e4++){eY=eV[e4];e2.push(br(eY).val())}return e2})()}return e1};T.prototype.on_confirm_button_click=function(e5){var eW,e2,eZ,e7,e0,e3,eX,eY,eU,e1,e4,e6,eV;e5.preventDefault();eU=this.file_name_input.val();e7=ef("We can\u2019t create folder '%(folder_name)s'");e7=e7.format({folder_name:eU});eZ=function(){return ab.error(e7)};if(this.state==="Create"){eV="/cmd/new"+dL.urlquote(this.destination_dir);e1={to_path:eU};e1[Constants.UID_PARAM_NAME]=this.user.id;e6=function(){var e8;e8=ef("Created new folder '%(folder_name)s'");e8=e8.format({folder_name:eU});return ab.success(e8)};new cp.WebRequest({url:eV,data:e1,success:e6,error:eZ})}else{this.autocompleter.tokenize_emails_input(true);e3=this._extract_invitees();e6=function(){var e8;e8=ef("Shared new folder '%(folder_name)s'");e8=e8.format({folder_name:eU});return ab.success(e8)};eY="";e2=false;eX="all";e4=false;eW=null;e0=this.destination_dir+"/"+eU;this.sharing_api.share_path(e0,e3,eY,e2,eX,e4,eW,false,e6,eZ)}return this.hide()};return T})(dN);dF=B.CreateLinkOrInviteToFolderWizardModal=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;T.__super__.constructor.call(this,this.options);this.sharing_api=new ba(this.user)}T.prototype.before_show=function(){var eU;this.sharing_api.loading_elem=this.$modal_window;eU=ef("Share '%(folder_name)s' with others");eU=eU.format({folder_name:bG.em_snippet(au.filename(this.options.path),16)});return this.format({".db-modal-title-text":eU})};T.prototype.on_show=function(){var eU,eW,eV;eU="edu_modal";eW=(eV=this.options.target_item)!=null?eV:null;a0.ShmodelUILogger.log("view",eU,eW);this.$modal_window.find(".option-to-share-folder").on("click",(function(eX){return function(eZ){var eY;if(eX.options.existing_sf){a0.ShmodelUILogger.log("sf_options",eU,eW);eY=new cX(cf.active_user,eX.options.path)}else{a0.ShmodelUILogger.log("sf_invite",eU,eW);eY=new cb(eX.user,{folder_name:eX.options.path,element_id:"invite-to-new-sf-wizard-modal-"+eX.user.id})}eX.hide();return eY.show()}})(this));this.$modal_window.find(".option-to-share-link").on("click",(function(eX){return function(eY){a0.ShmodelUILogger.log("token_share",eU,eW);dc.shmodel(eX.options.path,"create_link_or_invite_to_folder_modal");return eX.hide()}})(this));return this.$modal_window.find(".learn-more").on("click",(function(eX){return function(eY){eY.preventDefault();a0.ShmodelUILogger.log("clicked_learn_more",eU,eW);return window.open("/help/274","_blank")}})(this))};return T})(dN);cb=B.InviteToNewSharedFolderWizardModal=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;this.insert_folder_settings=db(this.insert_folder_settings,this);this.share_folder=db(this.share_folder,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);this.show_settings_modal=db(this.show_settings_modal,this);this.options.focus=".new-collab-input";T.__super__.constructor.call(this,this.options);this.sharing_api=new ba(this.user);this.folder_name=this.options.folder_name;this.is_file=this.options.is_file;this.must_check_verified=(this.options.must_check_verified!=null)||false;this.progress_ever_blocked_by_verify=false}T.prototype.before_show=function(){var eU;this.sharing_api.loading_elem=this.$modal_window;eU=ef("Share '%(folder_name)s' with others");eU=eU.format({folder_name:bG.em_snippet(au.filename(this.folder_name),16)});return this.format({".db-modal-title-text":eU})};T.prototype.on_show=function(){var eV,eW,eZ,eY,eU,eX;eX=this.$modal_window.find(".suggestion-input");for(eY=0,eU=eX.length;eY<eU;eY++){eW=eX[eY];cP.register($(eW))}eV=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){eZ="invite-wizard-"+this.user.id;this.invite_form_controller=new cW(this.user,eV,[],[],[],eZ);if(this.invite_form_controller.team_only){this.insert_folder_settings("team")}}else{this.invite_form_controller.listen()}this.$modal_window.find(".new-collab-input").focus();this.$modal_window.find(".change-new-folder-settings").on("click",(function(e0){return function(e1){e1.preventDefault();return e0.show_settings_modal()}})(this));this.log_extras={path:this.folder_name};a0.SharedFolderActivityLogger.log("web","share_folder_modal_displayed",this.user,this.log_extras);if(this.is_file){return a0.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_displayed",this.user,this.log_extras)}};T.prototype.show_settings_modal=function(){var eV,eU;eU=ef("'%(folder_name)s' settings");eU=eU.format({folder_name:bG.em_snippet(au.filename(this.folder_name),13)});eV={folder_name:this.folder_name};if(this.audience_restriction){eV.audience=this.audience_restriction}if(this.inviter_restriction){eV.inviter=this.inviter_restriction}if(this.shared_link_policy_restriction){eV.shared_link_policy=this.shared_link_policy_restriction}eV[Constants.UID_PARAM_NAME]=this.user.id;if(this.is_file){eV.is_file=this.is_file}dH.register(cm.SAVED_PERMISSIONS,(function(eW){return function(eY,eX){eW.insert_folder_settings(eX.audience,eX.inviter,eX.shared_link_policy);return eW.invite_form_controller.reset_options()}})(this));return dH.push(new co({element_id:"folder-permissions-modal",title:eU,endpoint_url:"/share_ajax/default_folder_settings",parameters:eV}))};T.prototype.on_confirm_button_click=function(eX){var eW,eV,eZ,eU,eY;eX.preventDefault();this.invite_form_controller.tokenize();eZ=this.invite_form_controller.extract_invitees();eY=this.invite_form_controller.get_custom_message();eW=this.invite_form_controller.get_access_type();eU=this.$modal_window.find("input#allow_other_members_to_share");if(eU.length>0){this.inviter_restriction=eU.is(":checked")?"all":"me"}if(this.is_file){eV=new ey(this.user,{element_id:"confirm-share-new-file-wizard-modal",invitees:eZ,msg:eY,access_type:eW,audience_restriction:this.audience_restriction,inviter_restriction:this.inviter_restriction,shared_link_policy_restriction:this.shared_link_policy_restriction,file_path:this.folder_name});this.hide();eV.show();return a0.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_continued",this.user,this.log_extras)}else{return this.share_folder(eZ,eY,eW,true,false)}};T.prototype.share_folder=function(eZ,eW,eU,e0,eY,eV){var e4,eX,e1,e3,e2;if(e0==null){e0=true}if(eY==null){eY=false}if(eV==null){eV=false}eX=(function(e5){return function(e6){return eo.show_validation_error(e6,e5.$modal_window.find(".tokenized_autocompleter_container"))}})(this);e3=(function(e5){return function(e8){var e7,e6;e6=JSON.parse(e8.responseText);ab.success(e6.success_msg);if(e5.progress_ever_blocked_by_verify){a0.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_share_succeess",e5.user,e1)}document.fire(aB.SF_NEW,{sf_info:bM.decode_sort_key(e6.sf_info)});if(e0){e5.hide()}if(eV){e7=new cX(e5.user,au.normalize(e5.folder_name));return e7.show()}}})(this);if(this.must_check_verified&&!this.user.is_email_verified){this.progress_ever_blocked_by_verify=true;a0.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_blocked_on_verify",this.user,e1);this.$modal_window.find(".confirm-button").prop("disabled",true);e2=ef("Verification email sent to %(email)s").format({email:this.user.email});e4=dK.get_for_user(this.user);e4.send_email("share_folder",function(){return ab.success(e2)});br("#resend-email-verification-link").click(function(){return e4.send_email("share_folder",function(){return ab.success(e2)})});this.$modal_window.find(".email-verify-message").show();return e4.ensure_polling((function(e5){return function(){a0.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_unblocked",e5.user,e1);ab.success(ef("Email verified. Try sharing your folder again."));e5.$modal_window.find(".confirm-button").prop("disabled",false);return e5.$modal_window.find(".email-verify-message").hide()}})(this))}else{this.sharing_api.share_folder(this.new_folder,this.folder_name,eZ,eW,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,eU,eY,e3,eX);e1={path:this.folder_name,access_type:eU};a0.SharedFolderActivityLogger.log("web","invite_modal_share_folder_button",this.user,e1);return br(document).trigger("db:invite_to_new_folder:share")}};T.prototype.insert_folder_settings=function(eV,eU,eX){var eW;this.audience_restriction=eV;this.inviter_restriction=eU;this.shared_link_policy_restriction=eX;eW=this.$modal_window.find(".invite-more-form, .external-invite-message,.folder-settings");if(this.audience_restriction==="team"){this.invite_form_controller.set_team_only(true);return eW.addClass("team-only")}else{this.invite_form_controller.set_team_only(false);return eW.removeClass("team-only")}};return T})(dN);ey=B.ConfirmShareNewFileWizardModal=(function(T){cA(eT,T);function eT(eU,eV){this.user=eU;this.options=eV;eT.__super__.constructor.call(this,this.options);this.file_path=this.options.file_path;this.file_name=au.filename(this.file_path);this.folder_name=au.filename_without_extension(this.file_name);this.folder_path=au.parent_dir(this.file_path)+"/"+this.folder_name;this.invitees=this.options.invitees;this.msg=this.options.msg;this.audience_restriction=this.options.audience_restriction;this.inviter_restriction=this.options.inviter_restriction;this.shared_link_policy_restriction=this.options.shared_link_policy_restriction;this.access_type=this.options.access_type;this.sharing_api=new ba(this.user);this.log_extras={path:this.file_path}}eT.prototype.before_show=function(){this.format({".confirm-share-file-invitees":this.format_invitees(),".confirm-share-file-name":this.file_name,".confirm-share-folder-name":this.folder_name});return a0.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_displayed",this.user,this.log_extras)};eT.prototype.on_confirm_button_click=function(eW){var eV,eU;eV=(function(eX){return function(e0){var eY,eZ,e1;a0.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_failed",eX.user,eX.log_extras);e1=b3.extract_errors(e0.responseText);if(e1===false){return}else{if(typeof e1==="string"){ab.error(e1)}else{if(typeof e1==="object"){for(eZ in e1){eY=e1[eZ];if("message_text" in eY){ab.error(eY.message_text);break}}}}}return eX.hide()}})(this);eU=(function(eX){return function(){var eY;a0.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_succeeded",eX.user,eX.log_extras);eY=ef("%(folder_name)s was shared successfully.").format({folder_name:eX.folder_name});ab.success(eY);return eX.hide()}})(this);this.sharing_api.share_file(this.folder_path,this.file_path,this.invitees,this.msg,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,this.access_type,eU,eV);return a0.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_confirmed",this.user,this.log_extras)};eT.prototype.format_invitees=function(){var eZ,eY,eW,eV,eU,eX;if(!this.invitees){return ef("others")}eZ=this.invitees.emails[0];eY=this.invitees.fb_ids[0];eW=this.invitees.group_ids[0];eV=this.invitees.new_style_group_ids[0];if(!eZ.length){return ef("others")}eU=eZ[0];eX=eZ.length+eY.length+eW.length+eV.length;if(eX>1){eU=eU+ef(" and others")}return eU};return eT})(dN);dM=B.ConfirmShareExistingFileWizardModal=(function(eT){cA(T,eT);function T(eU,eV){this.user=eU;this.options=eV;T.__super__.constructor.call(this,this.options);this.folder_name=this.options.folder_name;this.folder_path=this.options.folder_path;this.log_extras={path:this.folder_name}}T.prototype.before_show=function(){this.format({".confirm-share-existing-folder-name":this.folder_name});return a0.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_displayed",this.user,this.log_extras)};T.prototype.on_confirm_button_click=function(eV){var eU;a0.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_confirmed",this.user,this.log_extras);eU=new cX(this.user,this.folder_path);this.hide();return eU.show()};return T})(dN);cm=B.NewSharedFolderPermissionsContent=(function(){T.SAVED_PERMISSIONS="new_sf_permissions:saved";function T(eT){this.$form=eT;this._submit=db(this._submit,this);this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(){return dH.pop()};T.prototype._submit=function(eW){var eU,eV,eT;eW.preventDefault();eU=this.$form.find("input[name=audience]:checked").val();eV=this.$form.find("input[name=inviter]:checked").val();eT=this.$form.find("input[name=shared_link_policy]:checked").val();dH.trigger(T.SAVED_PERMISSIONS,{audience:eU,inviter:eV,shared_link_policy:eT});return dH.pop()};return T})();var dc;dc=B.SharingShmodel=(function(){function T(){}T.shmodel=function(eU,eT){return new cY(cf.active_user.id,eU,eT).show()};return T})();var bM;bM=INLINE_JS.Sharing=B.Sharing={init:function(eZ,eT,eY,eV,eX,eW,eU,T){this.is_merged=eY;this.simple_sharing_enabled=T;if(!eT){this._decode_sort_keys(eZ)}this._state={sf_info:eZ,cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{},sf_loading:eT,delay_reload_folder:false,pending_new_folders:[]};if(eY){this.role_picker=br("#role-selector").controller();this.role_picker.on_state_change=this._render.bind(this);bB.set_during_login_callback((function(e0){return function(e2,e1){dk.set_not_logged_in_role_and_email(null,null);return e0._reload_folder_info(function(){return e1()},function(e3){e1(ef("Error displaying shared folders"));return window.location.reload()})}})(this))}dk.set_is_merged(eY);dk.set_not_logged_in_role_and_email(eV,eX);dk.set_team_name(eW);dk.set_show_inbox(eU);this._listen();this._tmpl=eP.tmpl("sf_list_item_tmpl");if(!eT){this._render()}else{this._display_spinner();cp.WebRequest({url:"/share_ajax/list_folders",dataType:"json",success:(function(e0){return function(e1){return e0._load_and_render_sf_list(e1)}})(this),error:(function(e0){return function(e1){return e0._sf_list_error()}})(this)})}this.refresh_inbox_counts(true);return this._display_view()},_load_and_render_sf_list:function(T){this._decode_sort_keys(T);this._state.sf_info=T;this._state.sf_loading=false;this._hide_spinner();if(this._state.pending_new_folders.length>0){this._state.sf_info.current.push.apply(this._state.sf_info.current,this._state.pending_new_folders);this._state.pending_new_folders=[]}this._render();if(this._state.delay_reload_folder){this._state.delay_reload_folder=false;return this._reload_folder_info()}},_sf_list_error:function(){this._hide_spinner();return ab.error(ef("We weren\u2019t able to load the list of shared folders. Please refresh the page to try again."))},is_share_page:function(){return this._state!=null},_decode_sort_keys:function(T){return[T.current,T.past].each((function(eT){return function(eU){return eU.each(function(eV){return eT.decode_sort_key(eV)})}})(this))},decode_sort_key:function(T){cw((T.encoded_sort_key!=null)&&(T.sort_key==null),"expected encoded sort keys on each elm");T.sort_key=dL.decode_sort_key(T.encoded_sort_key);delete T.encoded_sort_key;return T},reload_folder_info_if_two_account:function(){if(this._showing_two_accounts()){return this._reload_folder_info()}},_reload_folder_info:function(eU,T){var eT;if(!this.is_share_page()){return}eT=(function(eV){return function(eW){var eX;eX=JSON.parse(eW.responseText);eV._decode_sort_keys(eX);eV._state.sf_info=eX;eV._render();return typeof eU==="function"?eU():void 0}})(this);if(this._state.sf_loading){return this._state.delay_reload_folder=true}else{return new cd().get_folder_info(eT,T)}},refresh_inbox_counts:function(T){return new cd().get_inbox_counts((function(eT){return function(eU){return eT._update_inbox_counts(eU,T)}})(this))},_update_inbox_counts:function(eT,eW){var eZ,eU,T,eY,eX,eV;eV=0;for(eY in eT){eZ=eT[eY];eV+=eZ}br("#inbox-count").text(eV);br("#inbox-count").toggleClass("show",eV>0);if(!this.is_share_page()){return}eU=function(e1,e0){var e2;for(eY in e1){e2=e1[eY];if(e0[eY]!==e1[eY]){return false}}return true};if((!eW)&&this._state&&eU(this._state.inbox_counts,eT)){return}this._state.inbox_counts=eT;if(eV){T=new Element("a",{id:"new-invites-link",href:"#"});T.__sert(cj.make("web","email_32",{"class":"link-img"}));eX=a1("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",eV);eX+=" \n";eX=eX.format({total_count:eV});T.__sert(eX);T.observe("click",(function(e0){return function(e1){Event.stop(e1);return e0.show_invites()}})(this));$("invites-box").show();$("invites-box").__date(T)}else{$("invites-box").hide()}if(eV>0&&dk.show_inbox){dk.set_show_inbox(false);return this.show_invites()}},register_accept:function(T){br(T).closest(".sf-invite-action").addClass("loading");new bl(br(T),T.action,{data:bF.collect_form_vars(T),complete:(function(eT){return function(eV,eU){br(T).closest(".sf-invite-action").removeClass("loading");eT.refresh_inbox_counts();return eT._reload_folder_info()}})(this),success:(function(eT){return function(eY,eU,e0){var eV,eX,eZ,eW;eY=(eW=JSON.parse(e0.responseText))!=null?eW.data:void 0;eV=br(T).closest(".sf-invite-action");eV.addClass("sf-accepted");if(eY!=null?eY.redirect:void 0){if(eT._state&&eT._state.current_total_count>1){eX=eV.find(".view-folder-button");return eX.click(function(){return window.location.href=eY!=null?eY.redirect:void 0})}else{return window.location.href=eY!=null?eY.redirect:void 0}}else{eZ=br(T).closest(".invitation-row").attr("data-invite-id");return eT._remove_invite_row(eZ)}}})(this)});return false},register_decline:function(eT,eV,eW){var T,eU;T=br(eT).closest("form");if((eU=T.closest(".sf-invite-action"))!=null){eU.addClass("loading")}if(T.length){new bl(T,T[0].action,{data:bF.collect_form_vars(T[0]),complete:(function(eX){return function(e0,eZ){var eY;if((eY=T.closest(".sf-invite-action"))!=null){eY.removeClass("loading")}eX._remove_invite_row(eV);eX.refresh_inbox_counts();eX._reload_folder_info();if(eW){return eW()}}})(this)})}return false},_remove_invite_row:function(eW){var T,eV,eU,eT;T=br("#invites-container");eV=T.find('[data-invite-id="'+eW+'"]');if(eV){eT=eV.parent("tbody");eV.remove();if(eT.children().length===0){T.find(".invitation-table-container").hide();T.find(".message-bottom").removeClass("message-bottom");T.find(".message-top").removeClass("message-top");if(T.find(".invites-message").length===0){eU=dN.get_containing_modal(T);return eU!=null?eU.hide():void 0}}}},_listen:function(){var eU,eT,T;this.listen_modals();eU=(function(eV){return function(eX,e5,e0){var e1,eW,e4,e3,e2,e7,eY,e6,eZ;eZ=eV._get_current_sf_list_info(e0),e3=eZ[0],e4=eZ[1];cw(e5,"SF _transfer w/o target_ns_id");for(e1=eY=0,e6=e3.length;eY<e6;e1=++eY){eW=e3[e1];if(eW.target_ns_id===e5&&eW.user_id===eX){e2=eW;e7=e1;break}}cw(e7!=null,"SF _transfer w/o js obj");return[e2,e7]}})(this);T=(function(eV){return function(e1,e6,e3){var e4,e2,e7,e5,e0,eX,eZ,eY,eW;eZ=eV._get_current_sf_list_info(e6),e4=eZ[0],eX=eZ[1];eY=eV._get_current_sf_list_info(e3),e5=eY[0],e0=eY[1];eW=eU(e1.memo.user_id,e1.memo.target_ns_id,e6),e2=eW[0],e7=eW[1];e4.splice(e7,1);eV._empty_check(e6);if(e1.memo.filename!=null){e2.filename=e1.memo.filename}if(e1.memo.mount_point!=null){e2.mount_point=e1.memo.mount_point}e5.push(e2);return eV._render()}})(this);eT=(function(eV){return function(e1,eY){var e3,e0,e2,eX,eZ,eW;eZ=eV._get_current_sf_list_info(eY),e3=eZ[0],eX=eZ[1];eW=eU(e1.memo.user_id,e1.memo.target_ns_id,eY),e0=eW[0],e2=eW[1];e3.splice(e2,1);return eV._render()}})(this);document.observe(aB.SF_UNSHARE,(function(eV){return function(eW){return eT(eW,"#sf-current")}})(this));document.observe(aB.SF_LEAVE,(function(eV){return function(eW){return T(eW,"#sf-current","#sf-past")}})(this));document.observe(aB.SF_REJOIN,(function(eV){return function(eW){return T(eW,"#sf-past","#sf-current")}})(this));document.observe(aB.SF_IGNORE,(function(eV){return function(eW){return eT(eW,"#sf-past")}})(this));document.observe(aB.SF_NEW,(function(eV){return function(eX){var eW;eW=eX.memo.sf_info;cw(eW,"SF_NEW without info");if(eV._state.sf_loading){return eV._state.pending_new_folders.push(eW)}else{eV._state.sf_info.current.push(eW);return eV._render()}}})(this));$("create-share").observe("click",(function(eV){return function(eW){a0.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);if(!$("create-share").hasClassName("disabled")){Event.stop(eW);return p.start_wizard_without_user()}}})(this));br("#learn-more-link").click((function(eV){return function(eW){return a0.SharedFolderActivityLogger.log("web","sharing_view_learn_more",null,{},true)}})(this));if($("new-invites-link")){$("new-invites-link").observe("click",(function(eV){return function(eW){Event.stop(eW);return eV.show_invites()}})(this))}br("#sf-current, #sf-past").each((function(eV){return function(eW,eX){var eY;eY=["#sf-current","#sf-past"][eW];br(".sf-list",eX).on("click","a.options-link",function(e0){var e4,e2,e6,e1,e7,e5,e3,eZ;e0.preventDefault();e4=br(e0.target).closest("a.options-link");e1=e4.attr("data-type");e6=e4.attr("data-mount");e3=parseInt(e4.attr("data-nsid"),10);eZ=cy.get_viewer().get_user_by_id(e4.attr("data-user_id"));e5=br(e0.target).closest("li.sf-folder").data("role");e7=e4.attr("data-sf-perm-role");if(e5!=null){dk.set_role(e5)}if(e1==="normal"){if(eV.simple_sharing_enabled){if(dK.get_for_user(eZ).verified_or_show()){ek.createAndShowInbandModal(eZ,e6,true,e3,true,false,e7)}}else{p.show_shared_folder_options_modal(e6,eZ)}}else{if(e1==="remove"){p.show_ignore_modal(eZ,e6,e3)}else{if(e1==="rejoin"){p.show_rejoin_modal(eZ,e6,e3)}}}e2={option_type:e1};if(e3){e2.ns_id=e3}if(e6){e2.path=e6}return a0.SharedFolderActivityLogger.log("web","sharing_view_share_existing",eZ.id,e2,true)});br(".sf-sort",eX).on("click","a.sort-option",function(e1){var e0,eZ,e2;e1.preventDefault();e0=br(e1.target).closest("a.sort-option");e2={SF_BY_NAME:eV._name_cmp,SF_BY_MODIFIED:eV._modified_cmp};eZ=e2[e0.attr("data-sort")];if(eV._state.cmp[eY]===eZ){eV._state.is_ascending[eY]=!eV._state.is_ascending[eY]}else{eV._state.cmp[eY]=eZ;eV._state.is_ascending[eY]=true}dL.add_sort_arrow_mouseover_j(e0,eV._state.is_ascending[eY],eY+" .sf-sort a.sort-option",true);return eV._render_list_id(eY)});return dL.add_sort_arrow_mouseover_j(br(".modified-sorter",eX),eV._state.is_ascending[eY],eY+" .sf-sort a.sort-option",false)}})(this));return br(".empty-share-button").click((function(eV){return function(eW){eW.preventDefault();a0.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);return p.start_wizard_without_user()}})(this))},listen_modals:function(){return br("#new-or-existing-sf li").click((function(T){return function(eU){var eT;br("#new-or-existing-sf li").removeClass("active");eT=br(eU.target).closest("li");eT.find("input").prop("checked",true);return eT.addClass("active")}})(this))},_showing_two_accounts:function(){var T;return this.is_merged&&((T=this.role_picker)!=null?T.get_state():void 0)===dI.ALL},_render:function(){cw(!this._state.sf_loading);this._render_list_id("#sf-current");this._render_list_id("#sf-past");if(br("#sf-current").hasClass("empty-list")&&br("#sf-past").hasClass("empty-list")){br("#page-content").addClass("no-shares");return br("#empty-content").show()}else{br("#page-content").removeClass("no-shares");return br("#empty-content").hide()}},_render_list_id:function(eU){var e1,eY,eZ,eW,eX,eV,e0,T,e2,eT;eT=this._get_current_sf_list_info(eU),eW=eT[0],eZ=eT[1];e0=this._showing_two_accounts();e1=(function(e3){return function(e4,e6){var e5;e5=e3._state.is_ascending[eU]?1:-1;return e5*e3._state.cmp[eU](e4,e6,e0)}})(this);eW.sort(e1);eX=br(".sf-list",eU);eX.empty();for(T=0,e2=eW.length;T<e2;T++){eV=eW[T];if(this._should_render(eV)){eY=this._tmpl({options_str:ef("Options"),remove_str:ef("Remove"),rejoin_str:ef("Rejoin"),is_past:eZ,sf:eV,Sprite:cj,Emstring:bG,Util:dL,_:ef});eX.append(eY.toHTML())}}return this._empty_check(eU)},_should_render:function(T){if(this.role_picker!=null){return this.role_picker.is_role_visible(T.role)}else{return true}},_empty_check:function(eV){var eU,T,eT;eT=this._get_current_sf_list_info(eV),eU=eT[0],T=eT[1];if(br(".sf-list",eV).children().length){return br(eV).removeClass("empty-list")}else{return br(eV).addClass("empty-list")}},_get_current_sf_list_info:function(T){switch(T){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return cw(false,"invalid sf list id")}},_name_cmp:function(eT,eU,T){if(T){return dL.sort_by_key(eT,eU)}else{return dL.sort_by_rank_or_key(eT,eU)}},_modified_cmp:function(eT,eU,T){return eT.modified_ts-eU.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){var eU,T,eT;this._state.current_total_count=0;eT=this._state.inbox_counts;for(T in eT){eU=eT[T];this._state.current_total_count+=eU}if(this._state.current_total_count>0){return p.show_invites()}},_display_view:(function(T){return function(){return br("#sf-view").show()}})(this),_hide_view:(function(T){return function(){return br("#sf-view").hide()}})(this),_display_spinner:function(){this._hide_view();return br(".sf-spinner").show()},_hide_spinner:function(){return br(".sf-spinner").hide()}};var bg;Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(eW,eX,eV,e2){var e1,eU,eZ,e0,T,eT,eY;this.user=eW;this.baseInitialize(eX,eV,e2);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;eU=this.options.include_fb===true;if(this.options.include_team==null){this.options.include_team=true}eY=this.options.include_team===true;eZ=this.options.include_groups===true;T=this.options.include_new_style_groups===true;e0=this.options.include_me===true;eT=this.options.include_rooms===true;this.contacts_importer=X.get_contacts_importer({user:this.user,on_update_services:this.update_import_contacts_link.bind(this),hide_containing_modal:this.hide_containing_modal.bind(this),show_containing_modal:this.show_containing_modal.bind(this)});this.update_import_contacts_link();this.contacts_importer.on_open_auth_popup=this.contact_importer_unshow.bind(this);this._autocompleter_contact_import_item_tmpl=eP.tmpl("autocompleter_item_tmpl");this.listen();this.possible_email_pattern=/[.@_-]/;e1=(function(e3){return function(e4){if(e3.options.include_from_linked_accounts&&e3.options.viewer){e4=e4.includeForViewer(e3.options.viewer)}else{e4=e4.includeForUser(e3.user.id)}if(e3.options.contact_filter){e4=e3.options.contact_filter(e4)}else{if(!eU){e4=e4.excludeFacebook()}if(!eZ){e4=e4.excludeGroups()}if(!T){e4=e4.excludeNewStyleGroups()}if(!eY){e4=e4.excludeTeamMembers()}if(!e0){e4=e4.excludeMe()}if(!eT){e4=e4.excludeRooms()}}return e3.setContacts(e4)}})(this);((function(e3){return function(){var e4;return bN.load_contacts(e4=false,eT=eT,(function(e5){e1(e5);return bN.register_for_updates("autocompleter_contacts",e1)}))}})(this)).defer();return this.options.onShow=function(e3,e4){if(!e4.style.position||e4.style.position==="absolute"){e4.style.position="absolute";br(e4).clonePosition(br(e3),{setHeight:false,setTop:false,setLeft:false})}return br(e4).fadeTo(150,1)}},getToken:function(){var T;T=this.getTokenBounds();return this.element.value.substring(T[0],T[1])},listen:function(){var T;this.install_contact_importer_listener();T=(function(eT){return function(eU){if(eT.contacts_importer.has_connected_services()){return}if(br(eT.element).val()){return}eT.activate();setTimeout(function(){var eV;return(eV=eT.get_entry_container())!=null?eV.show():void 0},300);return true}})(this);return br(this.element).click(T)},install_contact_importer_listener:function(){var T;Event.stopObserving(this.element,"blur");T=(function(eT){return function(eU){var eV;if(!br(eU.target).closest("li").hasClass("contacts-importer")){if(eT.contact_importer_currently_showing()){eT.contact_importer_unshow()}return(eV=eT.get_entry_container())!=null?eV.hide():void 0}}})(this);br(this.element).closest(".db-modal-box").click(T);return br(this.element).closest("#modal-box").click(T)},get_entry_container:function(){var T;return(T=this.element.up(".tokenized_autocompleter_container"))!=null?T.down(".autocomplete"):void 0},contact_importer_currently_showing:function(){var eT,T;eT=this.get_entry_container();if((eT!=null)&&eT.style.display!=="none"){if(((T=eT.firstChild.firstChild)!=null?T.value:void 0)===0){if(eT.firstChild.children.length>1){return true}}}return false},contact_importer_show:function(){var eU,eT,T,eV;eU=this.get_entry_container();if(((eT=eU.firstChild)!=null?(T=eT.firstChild)!=null?T.value:void 0:void 0)>0){this.old_display=eU.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.contact_importer_render_buttons();if((eV=$("flash_copy_container"))!=null){eV.hide()}return this.element.focus()},contact_importer_unshow:function(){var T;this.hasFocus=true;this.changed=false;this.updateChoices(this.old_contents);this.get_entry_container().style.display=this.old_display;return(T=$("flash_copy_container"))!=null?T.show():void 0},contact_importer_render_buttons:function(){var T;T=this.get_contact_importer_button_list();this.hasFocus=true;return this.updateChoices("<ul>"+(T.join(""))+"</ul>")},get_contact_importer_button_list:function(){var eW,eT,eV,T,eU;eT=[];eU=cM.contact_services();for(eV=0,T=eU.length;eV<T;eV++){eW=eU[eV];cw(this.contacts_importer.connected_services!=null,"connected_services has not been set");eT.push(this._autocompleter_contact_import_item_tmpl({email_provider_num:eW,email_provider_img:cM.to_img(eW),email_provider_name:cM.to_name(eW),bottom_text:this.contacts_importer.connected_services[eW]?ef("Connected"):"",is_suggestion:0}).toHTML())}return eT},update_import_contacts_link:function(){if(this.contacts_importer.has_unconnected_services()){return br(this.element).closest("form").find(".import-contacts-link").show()}else{return br(this.element).closest("form").find(".import-contacts-link").hide()}},hide_containing_modal:function(){this.$hidden_modals=br(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=br("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(T){this.options.array=T.contacts;this.options.larray=T.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){this.updateChoices(this.options.selector());br(".autocomplete-item-cancel-button").off();return br(".autocomplete-item-cancel-button").on("click",((function(T){return function(eT){eT.stopPropagation();T.contacts_importer.suggestions_enabled=false;T.getUpdatedChoices();return new Ajax.DBRequest("/contacts/turn_off_importer_suggestions",{subject_user:T.user})}})(this)))},selectEntry:function(){var eU,eT,T;eT=this.getCurrentEntry();eU=this.options.array[eT.value];if(eU.type===S.FB||eU.type===S.NEW_STYLE_GROUP){eT.innerHTML=eU.name}else{eT.innerHTML=eU.email}if(this.options.tokens.length>1){T=this.options.tokens[0]+" "}else{T=""}eT.innerHTML+=T;this.active=false;this.updateElement(eT);return br(this.element).trigger("db:autocompleted")}},bg=function(T,eT){var eU;eU=br("<div>");eU.addClass(T);if(typeof eT==="string"||eT instanceof String){eU.text(eT)}else{eU.append(eT)}return eU},{setOptions:function(eT){var T;if(eT==null){eT={}}T={choices:5,selector:(function(eU){return function(){var eY,ff,fe,e7,e9,fr,e0,fI,fJ,e3,fp,fE,fj,fb,e8,fq,fo,e6,fA,eZ,fn,fH,fk,ft,fl,fs,fy,eV,fx,fF,e5,fc,fm,eW,fv,fg,fi,fw,eX,fd,fG,fh,fD,fC,fB,fz,fa,e4,e2,e1,fu;fg=[];fp=eU.getToken().toLowerCase();fA=eU.options.array.length;e9=eU.options.array;ft=eU.options.larray;fv=[];if(fp.indexOf(" ")===-1){fv.push("\\s+")}if(fp.indexOf("+")===-1){fv.push("\\+")}if(fp.indexOf("@")===-1){fv.push("@")}if(fp.indexOf(".")===-1){fv.push("\\.")}if(fp.indexOf("&lt;")===-1){fv.push("&lt;")}eW=RegExp("("+fv.join("|")+")");fq=0;while(fp.length>0&&fq<fA){e7=e9[fq];fk=ft[fq];fE=-1;e3=[];fs=[];e8="";switch(e7.type){case S.EMAIL:e3.push(e7.name,e7.email_snippet);fs.push(fk.name,fk.email);e8="/static/images/icons/mail28-vflHfHPJ0.png";break;case S.FB:e3.push(e7.name);fs.push(fk.name);if(bM.use_fb_profile_pics){e8="https://graph.facebook.com/"+fk.fb_id+"/picture"}else{e8="/static/images/icons/fb24-vflGnjfAv.png"}break;case S.USER_GROUP:e3.push(e7.name,e7.members);fs.push(fk.name,"");e8="";fj=e7.group_avatar;break;case S.NEW_STYLE_GROUP:e3.push(e7.name,e7.members);fs.push(fk.name,"");e8="";if(__CIRCULAR_DEPENDENCY__.GroupsListController!=null){ff=__CIRCULAR_DEPENDENCY__.GroupsListController.string_to_hsl(e7.name);fe=__CIRCULAR_DEPENDENCY__.GroupsListController.get_initials(e7.name);fj=br("<span class='group-icon'>").css("border-color",ff).css("color",ff).text(fe)}break;case S.CAROUSEL_ROOM:e3.push("",e7.name);fd=fk.name;fu=e7.members;for(fD=0,fa=fu.length;fD<fa;fD++){fy=fu[fD];fd+="."+fy.contact_vector_data.toLowerCase();fd+="."+fy.display_name.toLowerCase()}fs.push("",fd);e8=e7.avatar_url||"/static/images/carousel/icon-57px-vfluuaZ5j.png";break;default:cw(false,"should never get here due to type: "+(""+e7.type+", "+e7.name+", "+e7.email+", "+e7))}for(e6=fC=0,e4=fs.length;fC<e4;e6=++fC){fl=fs[e6];fF=fv.length?fl.split(eW):[fl];e0=0;for(fB=0,e2=fF.length;fB<e2;fB++){fx=fF[fB];if(!fx){continue}if(fx.indexOf(fp)===0){fE=e0;break}e0+=fx.length}if(fE!==-1){fm=((fp.length/fx.length)*9.4).toFixed(0);if(e7.sort_key!=null){fm+=e7.sort_key}eZ=document.createTextNode(e3[e6].substr(0,fE));eV=br("<strong>").text(e3[e6].substr(fE,fp.length));fw=document.createTextNode(e3[e6].substr(fE+fp.length));e3[e6]=[eZ,eV,fw];break}}if(e7.type===S.FB){e3.push(ef("Facebook message"))}if(fE!==-1){if(e8){fb=br('<img width="28px" height="28px">').attr("src",e8)}else{if(fj){fb=fj}}e5=bg("autocomplete-line",e3[0]);fh=bg("autocomplete-line autocomplete-secondary",e3[1]);fn=bg("autocomplete-left",fb);eX=bg(null,[e5,fh]);fH=br("<li>").attr("value",fq).append(fn,eX);fg.push([fm,fH])}fq++}fg.sort(function(fL,fK){if(fL[0]<fK[0]){return 1}else{if(fL[0]>fK[0]){return -1}else{return 0}}});fg=fg.slice(0,eU.options.choices);fi=br("<ul>");for(fz=0,e1=fg.length;fz<e1;fz++){fG=fg[fz];fi.append(fG[1])}if(!br(eU.element).hasClass("no-contacts-importer")){if(eU.contacts_importer.has_unconnected_services()){fr=br(eU.element).closest(".tokenized_autocompleter_container");fc=fr.attr("data-provider");fo=fc===cM.GOOGLE?ef("Select from your Gmail contacts"):fc===cM.YAHOO?ef("Select from your Yahoo contacts"):ef("Select from your contacts");fI=false;if((fc===cM.GOOGLE||fc===cM.YAHOO)&&!eU.contacts_importer.connected_services[fc]){fI=true}else{if(eU.contacts_importer.has_connected_services()){fI=false;fo=ef("Import Contacts")}}if(fI){fJ=eU._autocompleter_contact_import_item_tmpl({email_provider_num:fc,email_provider_img:cM.to_img(fc),email_provider_name:fo,bottom_text:"",is_suggestion:0}).toHTML();fi.append(fJ)}else{fb=cj.make("web","user_add");e5=bg("autocomplete-line autocomplete-line-center",fo);fn=bg("autocomplete-left",fb);eX=bg(null,[e5]);fH=br("<li>").addClass("contacts-importer").append(fn,eX);fi.append(fH)}}}eY=fi.wrap("<span>").parent().html();eU.old_contents=eY;return eY}})(this)};return this.options=Object.extend(T,eT)}});var cz;cz=B.Token=Class.create({initialize:function(eT,T,eU,eV){this.element=$(eT);this.token_manager=eU;this.hidden_input=T;this.element.token=this;this.selected=false;this.info=eV;return br(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var T;this.token_manager.token=this;if((T=this.hidden_input)!=null){T.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(T){if(T&&T.preventDefault){T.preventDefault()}if(this.detect(T)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(T){return this.token_manager.remove(this)},detect:function(eV){var eT,eU,T;eU=eV.target?eV.target:eV.srcElement;T=eU.token;eT=eU;while((T==null)&&eT.parentNode){eT=eT.parentNode;T=eT.token}return(T!=null)&&T.element===this.element}});var M;M=B.TokenManager=Class.create({initialize:function(eT,eU,T){this.shift_boundary_right_func=eU;this.shift_boundary_left_func=T;this.element=eT;this.tokens=[];return this.token=null},add:function(T){this.tokens.push(T);return this.element.fire("token:add",T.info)},populate:function(){var eY,eU,eW,eV,eX,eT,T;eV=this.element.select(".token");T=[];for(eX=0,eT=eV.length;eX<eT;eX++){eW=eV[eX];eY=eW.hasClassName("token-warn");eU=new cz(eW,null,this,{external:eY});T.push(this.add(eU))}return T},remove:function(eT){var T;if(eT==null){eT=this.token}if(eT!=null){T=this.tokens.indexOf(eT);this.tokens.splice(T,1);eT.element.remove();if(this.token===eT&&T<this.tokens.length){this.tokens[T].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",eT.info)}},removeAll:function(){var eT,eV,T,eU;eU=this.tokens;for(eV=0,T=eU.length;eV<T;eV++){eT=eU[eV];eT.element.remove();this.element.fire("token:remove",eT.info)}return this.tokens.clear()},shift_left:function(){var T;T=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(T>0){if(this.token){this.token.deselect()}return this.tokens[T-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var T;T=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(T+1<this.tokens.length){return this.tokens[T+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var dP;dP=B.HiddenInput=Class.create({initialize:function(T,eU,eT){this.element=$(T);this.auto_complete_element=eU;this.token_manager=eT;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(T){switch(T.keyCode){case Event.KEY_LEFT:T.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:T.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:T.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,T,eV,eX,eU,eT){var eW;this.user=T;$super(T,eV,eX,eT);this.token_manager=new M(this.element,this.generate_shift_boundary_right_func());this.hidden_input=new dP(eU,this.element,this.token_manager);this.textbox_height=0;if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){br(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(eY,eZ){br(eZ).clonePosition(br(eY.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return eZ.show()};this.options.onHide=function(eY,eZ){return eZ.hide()};this.max_textbox_height=270;if(eT.max_textbox_height!=null){this.max_textbox_height=eT.max_textbox_height}this.members=[];if(eT.members!=null){this.members=eT.members}this.invitees=[];if(eT.invitees!=null){this.invitees=eT.invitees}this.new_style_groups=[];if(eT.new_style_groups!=null){this.new_style_groups=eT.new_style_groups}this.contacts_only=false;if(eT.contacts_only!=null){this.contacts_only=eT.contacts_only}if(ei.get_url().indexOf("/referrals")!==-1){eW=br("#retrieve-contacts-button")}else{eW=br(this.element).closest("form").find(".tokenizer-submit-button")[0]}br(eW).on("mousedown",this.beforeSubmit.bindAsEventListener(this));br(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!eT.hide_import_contacts){this.import_links=br(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onClick:function(eT){var T,eU;T=eT.findElement("li");this.index=T.autocompleteIndex;eU=this.selectEntry();if(!eU){return this.hide()}},onBlur:function($super,T){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(T)},onFocus:function(T){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(T){return this.tokenize_emails_input(true)},clearTokens:function(T){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getTokenCount:function(){return this.token_manager.tokens.length},getEmails:function(){var eT,T;eT=br(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var eW,eV,eU;eU=[];for(eW=0,eV=eT.length;eW<eV;eW++){T=eT[eW];eU.push(br(T).val())}return eU})()).join(", ")},check_populated:function(){var eT,T;eT=$(this.element.parentNode);T=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(eT.hasClassName("populated")&&T){return eT.removeClassName("populated")}else{if(!eT.hasClassName("populated")&&!T){return eT.addClassName("populated")}}},clean_email_addr:function(eW,eU){var eT,eV,T;for(eV=0,T=eW.length;eV<T;eV++){eT=eW[eV];eU=eU.sub(eT,"")}return eU.strip()},get_regexp_from_delimiters:function(eW){var eT,eV,eU,T;eV="";for(eU=0,T=eW.length;eU<T;eU++){eT=eW[eU];eV+=eT+"|"}return new RegExp("["+eV+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(eV,eU,T){var eW,eT;eT=true;eW=eU;if(T===S.FB){eW=eV}if(T===S.EMAIL&&!dL.validate_email(eU)){eT=false}else{if(bx.call(this.members,eU)>=0){eT=false;eW=ef("Already member")}else{if(bx.call(this.invitees,eU)>=0){eT=false;eW=ef("Already invited")}else{if(T===S.NEW_STYLE_GROUP){if(bx.call(this.new_style_groups,eU)>=0){eT=false;eW=ef("Already member group")}else{eT=true;eW=ef("Group")}}}}}if(eU===this.user.email||eU===this.user.id){eW=ef("You");eT=!this.contacts_only}if(!eV&&eU){eV=eU.toString()}return{display:eV,value:eU,type:T,valid:eT,bubble_title:eW}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(eT){var T,eU;T=eT.match(this.COMPOUND_EMAIL_REGEX);if(T){eU=this.createTokenInfo(T[0],T[2],S.EMAIL);return eU}return null},tokenize_emails_input:function(e1,eW){var e6,e0,eX,e5,eU,e7,e4,e3,eY,fb,eZ,eV,eT,T,e8,fa,e9,e2;e0=this.options.tokens;e3=this.get_regexp_from_delimiters(e0);if(this.options.single_token){e5=[this.element.value]}else{e5=this.element.value.split(e3)}fb="";if(!e1){fb=e5[e5.length-1];e4=this.clean_email_addr(e0,fb);e5=e5.slice(0,e5.length-1);if((e2=fb[fb.length-1])===" "||e2===">"){if(e4.match(this.COMPOUND_EMAIL_REGEX)||dL.validate_email(e4)){e5.push(e4);fb=""}}}e6=false;eZ=[];if(e5.length>0){for(eV=0,e8=e5.length;eV<e8;eV++){eX=e5[eV];eY=this.parse_compound_email(eX);if(eY!=null?eY.valid:void 0){e6=true;this.set_input_size(1);this.addContact(eY)}else{eZ.push(eX)}}}e5=eZ;if(!this.options.single_token){e7=[];for(eT=0,fa=e5.length;eT<fa;eT++){eX=e5[eT];e7.push.apply(e7,eX.split(" "))}e5=e7}if(e5.length>0){for(T=0,e9=e5.length;T<e9;T++){eX=e5[T];eX=this.clean_email_addr(e0,eX);if(eX){eY=this.createTokenInfo(eX,eX,S.EMAIL);if(eY.valid){e6=true}else{if(eW){continue}}this.set_input_size(1);this.addContact(eY)}}}if(this.element.value!==fb){this.element.value=fb}eU=this.element.up("form");if(e6){bF.clear_errors(eU)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var eT,T;eT=this.element;T=function(){return eT.focus()};return T},set_input_size:function(T){if((T==null)||T<0){T=20}return this.element.setStyle({width:""+T+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var e4,e8,eY,eW,fb,eZ,e5,e7,e3,eV,e1,eX,e2,e6,eU,T,e9,fa,e0,eT;e3=$(this.element.parentNode.parentNode);e1=parseInt(e3.getStyle("width"),10)-15;eV=parseInt(e3.getStyle("height"),10);if(eV!==this.textbox_height){this.textbox_height=eV;if(eV>=this.max_textbox_height){e3.setStyle({"overflow-y":"auto"})}else{e3.setStyle({"overflow-y":"hidden"})}}fb=e1;e4=br(".tokenizer-link",e3.parentNode);if(e4.length>0){fb-=e4.width()}e2=this.token_manager.tokens;eZ=false;e6=0;for(eU=0,e9=e2.length;eU<e9;eU++){eX=e2[eU];eW=eX.element;eY=parseInt(eW.getStyle("width"),10)+parseInt(eW.getStyle("margin-right"),10);e7=e6+eY;if(e7>e1){e6=eY;eZ=true}else{if(eY>e1){e6=0;eZ=true}else{e6=e7}}}e5=fb-e6;e8=this.element.value.length*7;if(e8>e5){e5=e1}this.set_input_size(e5);if(this.import_links.length&&this.import_links_visible){if(eZ||e1-e6-e8<1.25*this.import_links_width){this.import_links_visible=false;e0=this.import_links;eT=[];for(T=0,fa=e0.length;T<fa;T++){eW=e0[T];eT.push(br(eW).fadeOut(100))}return eT}}},onKeyPress:function(eT){var eU,T;this.dynamically_resize_input();if(this.active){switch(eT.keyCode){case 44:case 188:case 59:case 186:if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true)}this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true);this.hide();Event.stop(eT);return}this.selectEntry();this.hide();this.active=false;Event.stop(eT);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(eT);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(eT);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(eT);return}}else{this.tokenize_emails_input(false);if(eT.keyCode===Event.KEY_TAB||eT.keyCode===Event.KEY_RETURN){if(this.element.value&&eT.preventDefault){eT.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((eU=eT.keyCode)===Event.KEY_LEFT||eU===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((T=eT.keyCode)===Event.KEY_LEFT||T===Event.KEY_RIGHT||T===Event.KEY_UP||T===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var eT,eU,eX,eW,T,eV;if(this.active){eX=this.element.value;eV=this.options.tokens;for(eW=0,T=eV.length;eW<T;eW++){eT=eV[eW];eU=eX.indexOf(eT);if(eU!==-1){if(this.has_selected_contact_importer_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=eX.substr(0,eU);this.selectEntry();this.hide();this.active=false;this.element.value=eX.substr(eU+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},has_selected_contact_importer:function(T){if(T==null){T=this.getCurrentEntry()}return br(T).hasClass("contacts-importer")},has_selected_contact_importer_entry:function(T){var eT;if(T==null){T=this.getCurrentEntry()}return T.value===0&&((eT=T.id)!=null?eT.length:void 0)!==0},selectEntry:function(){var eU,eT,eX,T,eV,eW;eT=this.getCurrentEntry();if(this.has_selected_contact_importer(eT)){a0.SharedFolderActivityLogger.log("web","import_contacts_button_clicked",this.user);this.contact_importer_show();return true}else{if(this.has_selected_contact_importer_entry(eT)){eX=eT.id.split("_")[0];cw((bx.call(cM.contact_services(),eX)>=0),"The 'id-value' of an autocompleter-entry is not a valid Third Party contact import service");eV=cM.to_name(eX);if(this.contacts_importer.connected_services[eX]){ab.success(ef("You're already connected to %(service_name)s").format({service_name:eV}));return}if(bx.call(cM.contact_services(),eX)>=0){if(br(eT).attr("suggestion")==="1"){return this.contacts_importer.auth_import(eX,"suggestion")}else{return this.contacts_importer.auth_import(eX)}}else{return cw(false,"Should never get here. entry_value: "+eX)}}else{eU=this.options.array[eT.value];T=eU.type===S.FB?eU.fb_id:eU.type===S.USER_GROUP?eU.group_id:eU.type===S.NEW_STYLE_GROUP?eU.group_id:eU.type===S.CAROUSEL_ROOM?eU.members:eU.email;this.set_input_size(1);eW=this.createTokenInfo(eU.name.strip(),T,eU.type);this.addContact(eW);bF.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}}},addContact:function(e2){var fc,e7,fd,e3,ff,eZ,fa,eT,e4,e8,fe,fi,eU,e0,e6,e9,e1,fb,eW,eV,T,fg,fj,fh,e5,eY,eX;if(e2.type===S.CAROUSEL_ROOM&&!e2.processed){e5=e2.value;for(eW=0,fg=e5.length;eW<fg;eW++){fc=e5[eW];eT=this.createTokenInfo(fd=fc.display_name,fb=JSON.stringify([fc.contact_vector_type,fc.contact_vector_data]),e1=S.CAROUSEL_ROOM);eT.processed=true;eT.bubble_title=fc.contact_vector_data;this.addContact(eT)}return}e9=this.token_manager.tokens;for(eV=0,fj=e9.length;eV<fj;eV++){e4=e9[eV];if(e2.value===e4.info.value){return}}this.element.value="";switch(e2.type){case S.FB:fa="fb_ids";ff=new Element("img",{src:"/static/images/icons/fb_16-vflbiYTkC.png"});break;case S.EMAIL:fa="emails";ff=new Element("img",{src:"/static/images/icons/email_16-vflcFyDTl.png"});break;case S.USER_GROUP:fa="group_ids";ff=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case S.NEW_STYLE_GROUP:fa="new_style_group_ids";ff=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case S.CAROUSEL_ROOM:fa="carousel_rooms";ff=new Element("img",{src:"/static/images/carousel/icon-57px-vfluuaZ5j.png"});break;case S.INVALID:fa="invalids";ff=new Element("span",{"class":"hidden"});break;default:cw(false,"should never get here due to type: "+e2.type)}e8=this.getTokenClass(e2);e6=br("<span class='x'>").addClass(e8);e6.on("click",function(fk){this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(fk);return false});fi=new Element("input",{type:"hidden",name:fa,value:e2.value.toString()});e4=new Element("a",{"class":"title_bubble token "+e8,href:"#",tabindex:"-1",title:e2.bubble_title});eZ=new Element("span");if(this.options.wrap_name){eU=new Element("div",{"class":"token-display-text"});eU.__sert(e2.display);fe=eU;e7=1}else{fe=e2.display;e7=0}eY=[fi,ff,fe];for(T=0,fh=eY.length;T<fh;T++){e3=eY[T];eZ.__sert(e3)}br(eZ).append(e6);e4.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(eZ))));if((eX=$(e4).down(5).next(e7))!=null){eX.innerHTML="&nbsp;"}e0=new cz(e4,this.hidden_input,this.token_manager,e2);this.token_manager.add(e0);return this.element.up().__sert({before:e4})},getTokenClass:function(T){if(!T.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});var bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1};Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,T,eV,eW,eU,eT){$super(T,eV,eW,eU,eT);this.warn_only=!eT.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));this.element.observe("token:add",this.notifyExternal.bind(this));this.team_contacts={};return this.suspended_contacts={}},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(T){this.warn_only=!T;return this.reloadContacts()},reloadContacts:function(){var eT,T;return bN.load_contacts(eT=false,T=false,(function(eU){return function(eV){return eU.setContacts(eV)}})(this))},setContacts:function($super,eW){var T,eV,eT,eU;this.team_contacts={};this.team_contacts[cy.get_viewer().work_email]=1;eW=eW.sortByTeamFirst();eU=eW.contacts;for(eV=0,eT=eU.length;eV<eT;eV++){T=eU[eV];if(T.team&&T.join_state==="active"){this.team_contacts[T.email]=1}if(T.team&&T.join_state==="suspended"){this.suspended_contacts[T.email]=1}}if(this.options.autocomplete_filter){return $super(this.options.autocomplete_filter(eW))}else{return $super(eW)}},createTokenInfo:function(eW,eU,T){var eY,eX,eV,eT;eT=true;eX=false;eY=eU;if(T===S.FB){eY=eW}if(T===S.EMAIL&&!dL.validate_email(eU)){eT=false}else{if(bx.call(this.members,eU)>=0){eT=false;eY=ef("Already member")}else{if(bx.call(this.invitees,eU)>=0){eT=false;eY=ef("Already invited")}else{if(T===S.EMAIL&&!this.team_contacts[eU]){eT=this.warn_only;eX=true}else{if(T===S.FB){eT=this.warn_only;eX=true}else{if(T===S.NEW_STYLE_GROUP){if(bx.call(this.new_style_groups,eU)>=0){eT=false;eY=ef("Already member group")}else{eT=true;eY=ef("Group")}}}}}}}if(eU===this.user.email||eU===this.user.id){eY=ef("You");eT=!this.contacts_only}if(!eW&&eU){eW=eU.toString()}return eV={display:eW,value:eU,type:T,valid:eT,external:eX,bubble_title:eY}},getTokenClass:function(T){if(!T.valid){return"token-error"}if(T.external){return"token-warn"}return"token-valid"},notifyExternal:function(eT){var T,eU,eV;eV=eT.memo;if(eV.external){eU=this.token_manager.tokens.filter(function(eW){return eW.info.external});T=eU?eU.length:0;return this.element.fire("sf:token:external",{count:T})}}});var i;i=B.TeamSharedFolderInviteController=(function(){function T(eT){var eU;this.element=$(eT[0]);eU=this.element.down(".new-collab-input");eU.observe("sf:token:external",this.handle_external.bind(this))}T.prototype.handle_external=function(eU){var eT,eV;eT=eU.memo.count;eV=this.element.down(".external-invite-message");if(eT>1){c9.fillVal(eT,"external-invite-num");if(eV!=null){eV.removeClassName("single")}return eV!=null?eV.show():void 0}else{if(eT===1){if(eV!=null){eV.addClassName("single")}return eV!=null?eV.show():void 0}else{return eV!=null?eV.hide():void 0}}};return T})();var ag;ag=INLINE_JS.SharingModel=B.SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,init:function(eT,T,eU){this.filename=eT;this.c2d_vars=T;this.c2d_url=eU!=null?eU:"/sm/c2d";this.init_logger();return on_script_loaded((function(eV){return function(){var e0,eZ,eY,eX,eW;eZ=$("login-create-an-account");if(eZ){eZ.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);br("#c2d-register-form").on("submit",eV.c2d_register.bind(eV));br("#c2d-login-form").on("submit",eV.c2d_login.bind(eV));br("#c2d-twofactor-login-form").on("submit",eV.c2d_twofactor_login.bind(eV));br("#download_button_link[data-dl-link]").on("click",eV.download_zip);eV.set_viewport_size();e0=function(e2,e1){return eV.do_c2d(e1.id)};br("#c2d-modal .login-form").on((eX=__CONDITIONAL_JS__.LoginForm)!=null?eX.LOGIN_SUCCESS:void 0,e0);br("#c2d-modal .register-form").on((eW=__CIRCULAR_DEPENDENCY__.RegisterForm)!=null?eW.REGISTER_SUCCESS:void 0,e0);eY=D.parse(window.location.href);if(eY.getQuery()["force_dl"]){eY.updateQuery({force_dl:0,dl:1});return window.location=eY.toString()}}})(this))},init_folder:function(T,eU,eT){this.gallery_enabled=T;this.gallery_showing=eU;this.is_folder=true;this.init_lightbox(eT);return on_script_loaded((function(eV){return function(){return eV.load_thumbs()}})(this))},init_album:function(){this.is_album=true;this._resize_album_view();return Event.observe(window,"resize",this._resize_album_view.bind(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&(this.c2d_vars.item_id==null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},get_thumbnail_for_file:function(eT){var eU,T;T=eT.icon.split("_");T.pop();eU=T.join("_");return"/static/images/icons128/"+eU+".png"},init_logger:function(){on_script_loaded((function(T){return function(){var eT;eT=$("login-hover-link");if(eT){eT.observe("click",function(){return aG.log(aG.CLICK_SIGN_IN)});eT.observe("click",function(){return dr.log("click_sign_in")})}if($("download_button_link")){aG.attachLogListener(aG.CLICK_DOWNLOAD,$("download_button_link"))}eT=$("add_to_my_dropbox_link");if(eT){aG.attachLogListener(aG.CLICK_ADD_TO_MY_DROPBOX,eT);dr.attachLogListener("click_add_to_my_dropbox",eT)}if($$(".remove-link").length){aG.attachLogListener(aG.REMOVE_LINK,$$(".remove-link")[0])}if($$(".shmodel-filename").length){aG.attachLogListener(aG.CLICK_FILENAME,$$(".shmodel-filename")[0])}eT=$("default_content_download_button");if(eT){aG.attachLogListener(aG.CLICK_DOWNLOAD,eT)}eT=$("default_content_a2md");if(eT){aG.attachLogListener(aG.CLICK_ADD_TO_MY_DROPBOX,eT)}eT=br("#login-create-an-account")[0];aG.attachLogListener(aG.CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN,eT);eT=br("#login-hover-cont .login-form")[0];aG.attachLogListener(aG.LOGIN_THRU_DEFAULT_DROPDOWN,eT);return br("#share-button").click(function(eU){return aG.log(aG.CLICK_SHARE)})}})(this));return document.observe(aD.ACTIONS_ADDED,(function(T){return function(){var eW,eV,eT,eU;eU=$("view_original");if(eU){aG.attachLogListener("shmodel_lightbox_click_vieworiginal",eU)}eV=$("lightbox_share_link");if(eV){aG.attachLogListener("shmodel_lightbox_click_getlink",eV)}eT=br("lightbox-share-link");if(eT[0]){aG.attachLogListener("shmodel_lightbox_click_getlink",eT[0])}eW=$("lightbox_download_link");if(eW){return aG.attachLogListener("shmodel_lightbox_click_download",eW)}}})(this))},set_team_only_shmodel:function(eT,T){this.team_only_shmodel=eT;return this.owner_name=T},_resize_album_view:function(){var T;T=Math.floor((z.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:""+T+"px"})},init_lightbox:function(T){return aD.init_from_preview_objs(T,"#gallery-view-media li")},load_thumbs:function(){var eT,T;T=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");eT=function(eU){if(!eU.src.endsWith(cj.SPACER)){return eU.addClassName("thumbnail")}};return bh.batch_load_thumbs(T,this.THUMBS_BATCH_SIZE,eT)},switch_mode:function(eY){var eU,eZ,eX,T,eW,eT,eV;eV=$A(["gallery","list"]);for(eW=0,eT=eV.length;eW<eT;eW++){T=eV[eW];eZ=$(T+"-view-container");eU=$(T+"-toggle");if(eY===T){eZ.show();eU.addClassName("selected")}else{eZ.hide();eU.removeClassName("selected")}}if(history.replaceState){eX=window.location.pathname;if(eY==="list"){eX+="?lst"}history.replaceState({},"",eX)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var T;if($(document.body).hasClassName("mobile")){T=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(T)}},toggle_dropdown:function(eV,eW,eU){var T,eT;if(eV){Event.extend(eV).preventDefault()}if(!eW.visible()){if(this.is_album){return ex.show(eW,eU,null,true)}else{eT=$$(".nav-header").first().getHeight();T=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(T<0&&dL.ie8){T=4}return ex.show(eW,eU,eT-T,true)}}},prepare_confirm_remove_modal:function(eT,eV,T,eX,e2,eY,e1,eZ){var eU,eW,e0;if(T){e0=eX?ef("Unshare?"):ef("Unshare album?");eU=br("#album-disable-token-modal")[0];c9.fillVal(eT.escapeHTML(),"album_unshare_name")}else{if(eY){e0=ef("Remove link created by %(name)s").format({name:e1});if(eV){eW=ef('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this folder.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}else{eW=ef('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this file.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}eW=eW.format({fname:bG.em_snippet(eT,17),owner:e1,owner_email:eZ})}else{e0=ef("Remove link to '%(name)s'").format({name:bG.em_snippet(eT,17)});if(eV){eW=ef("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{eW=ef("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}}eU=br("#disable-token-modal")[0];c9.fillVal(eW,"disable-token-desc")}return{title:e0,contents:eU}},confirm_remove:function(eT,eX,eU,T,eV,e1,eY,e0,eZ){var eW;if(eU==null){eU=false}if(T==null){T=false}if(eV==null){eV=false}if(e1==null){e1=null}if(eY==null){eY=false}if(e0==null){e0=null}if(eZ==null){eZ=null}cw(eX,"confirm_remove missing tkey");cw(eT,"confirm_remove missing name");cw(e1,"confirm_remove missing user_id");cw(!eY||!T,"admin removal of collections not supported");cw(!eY||e0,"missing link owner name for admin removal");cw(!eY||eZ,"missing link owner email for admin removal");if(!cy.get_viewer().is_uid_signed_in(e1)){bB.show_modal({user_id:e1,on_success:(function(e2){return function(){return e2.confirm_remove(eT,eX,eU,T,eV,e1,eY,e0,eZ)}})(this)});return}eW=ag.prepare_confirm_remove_modal(eT,eU,T,eV,e1,eY,e0,eZ);return eM.show(eW.title,eW.contents,{token:eX,name:eT,is_album:T,user_id:e1})},confirm_remove_from_event_gid:function(T,e0,eU,eZ,eW,eY,eX,eT){var eV;if(eW==null){eW=false}if(eY==null){eY=null}if(eX==null){eX=null}if(eT==null){eT=null}cw(e0,"confirm_remove missing event gid");cw(T,"confirm_remove missing name");cw(eZ,"confirm_remove missing user_id");cw(cy.get_viewer().is_uid_signed_in(eZ),"user not logged in");cw(!eW||eY,"missing link owner name for admin removal");cw(!eW||eX,"missing link owner email for admin removal");eV=ag.prepare_confirm_remove_modal(T,eU,false,false,eZ,eW,eY,eX);return eM.show(eV.title,eV.contents,{name:T,user_id:eZ,activity_log_event_gid_dbase64:e0,redirect_to_member_id:eT})},do_remove:function(eV){var T,eU,eT;cw(eV.token||eV.activity_log_event_gid_dbase64,"missing token or event gid_dbase64");T=br("#modal-content input").first();T.attr("disabled",true);br("#modal-content").addClass("ajax-loading");eT=window.location.pathname;if((eT==="/links"||eT==="/links/your_links")||eT.match("^/home|^/work|^/personal")){return new Ajax.DBRequest("/sm/disable/"+eV.token,{subject_user:eV.user_id,onSuccess:(function(eW){return function(){var eX;eM.hide();if(eV.is_album){eX=ef("Unshared '%(name)s'")}else{eX=ef("Removed link for '%(name)s'")}eX=eX.format({name:eV.name});ab.success(eX);return document.fire(aB.LINKS_REMOVE,{token:eV.token})}})(this),onComplete:(function(eW){return function(){T.attr("disabled",false);return br("#modal-content").removeClass("ajax-loading")}})(this)})}else{if(eV.token){eU=D({path:"/sm/disable/"+eV.token})}else{eU=D({path:"/sm/disable_by_event_gid/"+eV.activity_log_event_gid_dbase64});eU.updateQuery("redirect_to_member_id",eV.redirect_to_member_id).toString()}return bF.postRequest(eU.updateQuery(Constants.UID_PARAM_NAME,eV.user_id).toString())}},show_shmodal_onload:function(eU,eV,eT,T){if(T==null){T=null}return br((function(eW){return function(){ei.remove_query_param("m");if(!cy.get_viewer().is_uid_signed_in(T)){bB.show_modal({user_id:T,on_success:function(){return eW.show_shmodal_onload(eU,eV,eT,T)}});return}if((T!=null)&&dK.get_for_user(cy.get_viewer().get_user_by_id(T)).verified_or_show()){return eW.show_shmodal(eU,eV,eT,T)}else{if(T==null){cw(cy.get_viewer().is_paired,"Expected viewer to be paired.");return eW.show_share_shmodel_role_chooser(eU,eV,eT)}}}})(this))},show_shmodal:function(eT,eZ,T,e5){var e4,e1,e3,e0,eX,eY,eV,eU,e2,eW;this.url=eT;this.short_url=eZ;if(!cy.get_viewer().is_uid_signed_in(e5)){bB.show_modal({user_id:e5,on_success:(function(e6){return function(){return e6.show_shmodal(eT,eZ,T,e5)}})(this)});return}eV=cy.get_viewer().get_user_by_id(e5);if(dK.get_for_user(eV).verified_or_show()){eY="shmodal-user-"+e5;eM.show(this._get_shmodal_title(eV.is_team),c9.fromElm($(eY)));eX={};eX[Constants.UID_PARAM_NAME]=e5;bF.add_vars("shmodal-send-form",eX);if(this._get_thumbnail_type()){eW=$$(".shmodal-image");for(eU=0,e2=eW.length;eU<e2;eU++){e0=eW[eU];e0.addClassName("thumbnail")}}if(T==="contacts"){e3=Autocompleter.ContactsTokenizer}else{e3=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new e3(eV,eY+"-new-collab-input",eY+"-new-whobulk",eY+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:T==="team_only",user_id:e5});this.configure_dropdown();if(!this.disabled){if(FlashDetect.installed){e4=q.clipboard_overlay(eT,br("#"+eY+"-copy-link"),ag.copied_to_clipboard);e4.css({position:"fixed",zIndex:1001});e4.children().height(e4.height());clearInterval(this.follow_freshbutton);e1=(function(e6){return function(){return e4.clonePosition(br("#"+eY+"-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);this.follow_freshbutton=setInterval(e1,500)}else{$(eY+"-copy-link").hide()}}b5._create($("modal").down(".custom-message-container"));b5._create($("modal").down(".fb-post-sickinput"));b5._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(eZ,e5);$(eY+"-new-collab-input").focus();return aG.log("shmodal_show")}},configure_dropdown:function(){var eW,eT,eV,T,eU;eU=$$(".dropdown-menu-container");for(eV=0,T=eU.length;eV<T;eV++){eW=eU[eV];eT=eW.down(".dropdown-menu-trigger");if(eT!=null){eT.observe("click",(function(eX){return function(eZ){var eY;eY=eZ.target.up(".dropdown-menu-container");return eY.toggleClassName("dropdown-shown")}})(this))}}return document.on("click",(function(eX){return function(e3){var e1,e2,e0,eY,eZ;if(e3.target.hasClassName("dropdown-menu-trigger")||e3.target.up(".dropdown-menu-trigger")){return}eY=$$(".dropdown-shown");eZ=[];for(e2=0,e0=eY.length;e2<e0;e2++){e1=eY[e2];eZ.push(e1.removeClassName("dropdown-shown"))}return eZ}})(this))},copied_to_clipboard:function(){ab.success(ef("Link copied to clipboard"));eM.hide();aG.log("shmodal_copy_link");return a0.ViralLogger.log(cy.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:ag.is_album?"collection":ag.is_folder?"folder":ag.filename.indexOf(".")===-1?"file":cD.EXTENSION_TO_CATEGORY[au.file_extension(ag.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(eU){var eV,e3,e0,e4,e5,eY,e1,T,eX,eW,e2,eT,eZ;cw(eU,"Must pass the shmodal send form into get_shmodel_send_recipients");eV=eU.select('input[name="emails"]');e3=eU.select('input[name="fb_ids"]');e0=eU.select('input[name="group_ids"]');eY=eU.select('input[name="new_style_group_ids"]');T=[];eZ=[eV,e3,e0,eY];for(eX=0,e2=eZ.length;eX<e2;eX++){e5=eZ[eX];for(eW=0,eT=e5.length;eW<eT;eW++){e4=e5[eW];e1=e4.up().innerHTML.stripTags().escapeHTML();T.push(e1.substring(0,e1.indexOf("&")))}}return T},send_shmodel_link:function(eV){var eU,eT,eW,T;eU=$("shmodal-send-form");cw(eU,"Couldn't find the shmodal send form.");T=this.get_shmodel_send_recipients(eU);eW=(function(eX){return function(eY){var eZ;eZ=aP.success_string_for_recipients(T);ab.success(eZ);eM.hide();return aG.log("shmodal_send")}})(this);eT=(function(eX){return function(eY){return bF.remove_loading()}})(this);return bF.ajax_submit(eU,"/sm/share",eW,eT,eU.down(".tokenizer-submit-button"))},show_content:function(eT){var eW,eV,T,eU;$("shmodal-title-text").__date(c5.to_title_str(eT));eU=c5.list;for(eV=0,T=eU.length;eV<T;eV++){eW=eU[eV];if(eW!==eT){$(c5.to_toggle_str(eW)).removeClassName("toggled");$(c5.to_content_str(eW)).hide()}}$(c5.to_content_str(eT)).show();$(c5.to_toggle_str(eT)).addClassName("toggled");return br("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(c5.SEND)},show_fb_content:function(){return this.show_content(c5.FB)},show_twitter_content:function(){return this.show_content(c5.TWITTER)},start_fb_post:function(eW,eT){var eX,eU,T,eV;eU=(function(eY){return function(){return d7.do_auth(eY.do_fb_post.curry(eW,eT),eT)}})(this);eX=br("#modal:visible, #modal-overlay:visible");T=function(){return eX.show()};if(d7.authed_user_id===eT){return this.do_fb_post(eW,eT)}else{if(cy.get_viewer().is_uid_associated(d7.authed_user_id)){eX.hide();eV=new dS(cy.get_viewer().get_user_by_id(eT),T,eU.bind(this));return eV.show()}else{return eU()}}},start_twitter_post:function(T){if(cq.is_authed(T)){return this.do_twitter_post(T)}else{return cq.do_auth(this.do_twitter_post,T)}},do_fb_post:function(eT,T){d7.custom_show_posting=function(){return bF.add_loading($("shmodal-fb-post-submit"))};d7.custom_show_complete=function(){eM.hide();ab.success(ef("Successfully posted to Facebook"));aG.log("shmodal_fb_post");return a0.ViralLogger.log(cy.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:ag.is_album?"collection":ag.is_folder?"folder":ag.filename.indexOf(".")===-1?"file":cD.EXTENSION_TO_CATEGORY[au.file_extension(ag.filename).toLowerCase()]||"file"})};return d7.post($F("shmodal-fb-post-input"),eT,null,null,null,function(){return eM.hide()},T)},do_twitter_post:function(T){var eT;eT=$F("shmodal-twitter-post-input");if(!eT){ab.error(ef("Please enter a Twitter post"));return}else{if(eT.length>140){ab.error(ef("Your post must be 140 characters or less"));return}}cq.custom_show_posting=function(){$("twitter-chars").hide();return bF.add_loading($("shmodal-twitter-post-submit"))};return cq.custom_post(eT,(function(eU){return function(){eM.hide();ab.success(ef("Successfully posted to Twitter"));aG.log("shmodal_tweet");return a0.ViralLogger.log(cy.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:ag.is_album?"collection":ag.is_folder?"folder":ag.filename.indexOf(".")===-1?"file":cD.EXTENSION_TO_CATEGORY[au.file_extension(ag.filename).toLowerCase()]||"file"})}})(this),T)},_get_shmodal_title:function(T){if(T==null){T=false}return this.generate_title_content(this._get_shmodal_title_text(),((function(eT){return function(){return eT.show_send_content()}})(this)),((function(eT){return function(){return eT.show_fb_content()}})(this)),((function(eT){return function(){return eT.show_twitter_content()}})(this)),T)},generate_title_content:function(eT,e0,eX,e2,eV){var eW,eY,T,e1,eU,eZ;if(eV==null){eV=false}e1=br("<div/>",{id:"shmodal-title"});eU=br("<div/>",{id:"shmodal-title-text",text:eT});e1.append(eU);if(!eV){T=br("<a/>",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});T.html(cj.make("web","email_20"));T.on("click",e0);eY=br("<a/>",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});eY.html(cj.make("web","fb_20"));eY.on("click",eX);eZ=br("<a/>",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});eZ.html(cj.make("web","twitter_20"));eZ.on("click",e2);e1.append([T,eY,eZ])}eW=br("<div/>",{"class":"clear"});e1.append(eW);return e1[0]},_get_shmodal_title_text:function(){var eT,T;if(this.is_folder){eT=ef("Share link to \u2018%(folder_name)s\u2019");return eT=eT.format({folder_name:bG.em_snippet(this.filename,15)})}else{T=this._get_thumbnail_type();if(T===cD.CATEGORY_TO_TRANSLATION.IMAGE){return ef("Share this image")}else{if(T===cD.CATEGORY_TO_TRANSLATION.VIDEO){return ef("Share this video")}else{return ef("Share '%(filename)s'").format({filename:bG.em_snippet(this.filename,18)})}}}},_get_thumbnail_type:function(){var eT,T;if(this.filename.indexOf(".")===-1){return false}T=au.file_extension(this.filename).toLowerCase();eT=cD.EXTENSION_TO_CATEGORY[T];if(eT&&(eT==="IMAGE"||eT==="VIDEO")){return cD.CATEGORY_TO_TRANSLATION[eT]}return false},_populate_twitter_info:function(eU,T){var eV,eT;eV=this.is_folder?ef("Just shared some files using @Dropbox"):(eT=this._get_thumbnail_type(),eT&&eT===cD.CATEGORY_TO_TRANSLATION.IMAGE?ef("Just shared an image using @Dropbox"):ef("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(eV+" "+eU);dL._track_twitter_chars_left("shmodal-twitter-post-input",140);if(cq.is_authed(T)){return cq.get_user_info(function(eW){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:eW.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(eW.name);$("shmodal-twitter-profile").down(".username").__date("@"+eW.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},T)}},download_zip:function(eV){var eT,eU,eW,T,eX;eT=br("#download_button_link").attr("data-dl-link");eX=br("#download_button_link").attr("data-test-link");T=br("#download_button_link").attr("data-owner")==="true";eW=(function(eY){return function(eZ){var e0;if(eZ==="OK"){window.location=eT}else{if(eZ.indexOf("err:")===0){if(T){e0=ef("The zip file is too large.")}else{e0=ef("The zip file is too large. Please add it to your Dropbox.")}ab.error(e0)}else{ab.error(ef("Failed to download zip file."))}}return false}})(this);eU=(function(eY){return function(eZ){ab.error(ef("Failed to download zip file."));return false}})(this);if(eX&&br.support.cors===true){br.ajax({url:eX,type:"POST",success:eW,error:eU})}else{window.location=eT}return false},show_share_shmodel_role_chooser:function(eT,eU,T){if(this.shmodel_select_role_modal==null){this.shmodel_select_role_modal=new de({element_id:"share-shmodel-select-role-modal",link_url:eT,short_url:eU,tokenizer_type:T})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(eT,eU,T,eW){var eV;eV=(function(eX){return function(){var eY;eM.hide();br("#role-selector option").removeClass("disabled");eY=cy.get_viewer().get_uid_by_role(eW);cy.get_viewer().sign_in_user_by_id(eY);a0.ShmodelUILogger.log("via-shmodel-viewer");return ag.show_shmodal(eT,eU,T,eY)}})(this);if(!cy.get_viewer().is_role_signed_in(eW)){dk.not_logged_in_role=eW;return bB.show_modal({role:eW,on_success:eV})}else{return eV()}},show_c2d_modal:function(eY,eT){var eX,T,eW,eU,eV;if(eY==null){eY=""}if(eT==null){eT=false}if(eY){if(eY===Constants.ROLE_PERSONAL){cw(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!cy.get_viewer().is_role_signed_in(eY)){bB.show_modal({role:eY,on_success:(function(eZ){return function(){return eZ.show_c2d_modal(eY)}})(this)});return}}else{if(cy.get_viewer().is_paired){new aJ({element_id:"select-role-modal"}).show();return}}if(eY){eU="#c2d-modal-"+eY}else{eU="#c2d-modal"}eV=this._c2d_modal_msg(eY,cy.get_viewer().team_name);eX=this._c2d_modal_button_msg(eY,cy.get_viewer().team_name);T=this._c2d_modal_desc(eY,cy.get_viewer().team_name);if(eT){T=this._c2d_modal_team_only_desc(cy.get_viewer().team_name)+"<br/><br/>"+T}eW=this._c2d_modal_login_desc(eY,cy.get_viewer().team_name);c9.fillVal(T,"c2d-desc");c9.fillVal(eW,"c2d-login-desc");br(".c2d-submit-button").val(eX);br(".c2d-login-register-desc").hide();if(this.is_album){br(".c2d-login-register-album-desc").show()}else{if(this.is_folder){br(".c2d-login-register-folder-desc").show()}else{br(".c2d-login-register-file-desc").show()}}return eM.show(eV,br(eU)[0],false,false,false,false)},_c2d_modal_msg:function(eV,eT){var T,eU;if(eV==null){eV=""}if(eT==null){eT=""}if(this.c2d_vars.title){return eU=this.c2d_vars.title}else{if(eV===Constants.ROLE_PERSONAL){eU=ef("Save '%(filename)s' to my personal Dropbox");return eU.format({filename:bG.em_snippet(this.filename,10)})}else{if(eV===Constants.ROLE_WORK){eU=ef("Save '%(filename)s' to my %(team_name)s Dropbox");T=Math.max(10,15-new bG(eT).length);return eU.format({filename:bG.em_snippet(this.filename,T),team_name:eT})}else{eU=ef("Save '%(filename)s' to my Dropbox");return eU.format({filename:bG.em_snippet(this.filename,15)})}}}},_c2d_modal_button_msg:function(eU,T){var eT;if(eU==null){eU=""}if(T==null){T=""}if(eU===Constants.ROLE_PERSONAL){return eT=ef("Save to my personal Dropbox")}else{if(eU===Constants.ROLE_WORK){eT=ef("Save to my %(team_name)s Dropbox");return eT.format({team_name:T})}else{return ef("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(T){var eT;if(this.is_album){eT=ef("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){eT=ef("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{eT=ef("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return eT.format({owner_name:this.owner_name,team_name:T})},_c2d_modal_desc:function(eU,T){var eT;if(eU==null){eU=""}if(T==null){T=""}if(eU===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){eT=ef("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return eT.format({owner_name:this.owner_name,team_name:T})}else{return eT=ef("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){eT=ef("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return eT.format({owner_name:this.owner_name,team_name:T})}else{return eT=ef("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){eT=ef("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return eT.format({owner_name:this.owner_name,team_name:T})}else{return eT=ef("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(eU===Constants.ROLE_WORK){if(this.is_album){eT=ef("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){eT=ef("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{eT=ef("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return eT.format({team_name:T})}else{if(this.is_album){return ef("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return ef("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return ef("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_login_desc:function(eU,T){var eT;if(eU==null){eU=""}if(T==null){T=""}if(eU===Constants.ROLE_PERSONAL){if(this.is_album){return eT=ef("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return eT=ef("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return eT=ef("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(eU===Constants.ROLE_WORK){if(this.is_album){eT=ef("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){eT=ef("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{eT=ef("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return eT.format({team_name:T})}}},c2d_register:function(eT){var T,eU;eT.preventDefault();T=$("c2d-register-form");eU=(function(eV){return function(eX){var eW;eW=JSON.parse(eX.responseText);return eV.do_c2d(eW.id)}})(this);return bF.ajax_submit(T,"/ajax_register",eU,false,$(T).down("input[type=submit]"))},c2d_login:function(eV,T){var eU,eT,eW;if(T==null){T="c2d-login-form"}eV.preventDefault();eU=$(T);eW=(function(eX){return function(eZ){var eY;eY=JSON.parse(eZ.responseText);switch(eY.status){case"OK":return eX.do_c2d(eY.id);case"TWOFACTOR":return eX.show_c2d_twofactor(eY.last_four_digits);case"SSO":return window.location=eY.sso_url}}})(this);eT=this.c2d_show_twofactor_error500.bind(this);return bF.ajax_submit(eU,"/ajax_login",eW,eT,$(eU).down("input[type=submit]"))},show_c2d_twofactor:function(T){$("c2d-login").hide();if(T){$("c2d-twofactor-login").addClassName("sms");c9.fillVal(T,"last-four-digits")}else{$("c2d-twofactor-login").removeClassName("sms")}$("c2d-resend-link").observe("click",this.c2d_resend_phone_code.bind(this));return $("c2d-twofactor-login").show()},hide_c2d_twofactor:function(){$("c2d-twofactor-login").hide();return $("c2d-login").show()},c2d_resend_phone_code:function(){if(this.c2d_is_resending()){return}this.c2d_show_resending();return new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(T){return function(eT){switch(eT.responseText.strip()){case"OK":return ab.success(ef("We sent you another code. It may take a few minutes to arrive."));case"UNREACHABLE":return T.c2d_show_twofactor_error_unreachable();case"BADCARRIER":return T.c2d_show_twofactor_error_bad_carrier();case"INVALIDNUMBER":return T.c2d_show_twofactor_error_invalid_number();case"NOTAMOBILE":return T.c2d_show_twofactor_error_not_a_mobile();case"EXPIRED":T.hide_c2d_twofactor();return ab.error(ef("Sorry, your phone code has expired. Please log in again."))}}})(this),onFailure:this.c2d_show_twofactor_error500.bind(this),cleanUp:this.c2d_hide_resending_with_delay.bind(this)})},c2d_twofactor_login:function(eU){var eT,T,eV;eU.preventDefault();if(!$("c2d-twofactor-code").getValue()){this.c2d_show_twofactor_error_invalid();return}eT=$("c2d-twofactor-login-form");eV=(function(eW){return function(eY){var eX;eX=JSON.parse(eY.responseText);switch(eX.status){case"OK":return eW.do_c2d(eX.id);case"INVALID":return eW.c2d_show_twofactor_error_invalid();case"EXPIRED":eW.hide_c2d_twofactor();return ab.error(ef("Sorry, your phone code has expired. Please log in again."))}}})(this);T=this.c2d_show_twofactor_error500.bind(this);return bF.ajax_submit(eT,"/ajax_verify_code",eV,T)},do_c2d:function(T){var eT;cw(T,"Must specify a user_id for saving to Dropbox.");eT=ef("Saving to your Dropbox...");if(cy.get_viewer().is_paired){if(cy.get_viewer().get_user_by_id(T).is_team){eT=ef("Saving to your %(team_name)s Dropbox...");eT=eT.format({team_name:cy.get_viewer().team_name})}else{eT=ef("Saving to your personal Dropbox...")}}ab.success(eT);eM.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:eT,subject_user:T,onSuccess:(function(eU){return function(eV){if(eV.responseText){return bO.redirect(eV.responseText)}}})(this)})},c2d_show_twofactor_error:function(eT){var T;T=$("c2d-twofactor-error");T.__date(eT);return T.show()},c2d_hide_twofactor_error:function(T){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(ef("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(ef("Unfortunately, your carrier is not supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(ef("That is not a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(ef("That phone number does not appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(ef("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(ef("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var c5;c5=B.ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",ef("Share on Facebook"),ef("Share on Twitter")],to_content_str:function(T){return this._content_str[T]},to_toggle_str:function(T){return this._toggle_str[T]},to_title_str:function(T){if(T===0){return ag._get_shmodal_title_text()}return this._title_str[T]},to_focus_str:function(T){return this._focus_str[T]}};var W,bK,cY,by,db=function(T,eT){return function(){return T.apply(eT,arguments)}},ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV};cY=INLINE_JS.ShareLinkModal=B.ShareLinkModal=(function(T){cA(eT,T);function eT(eU,eX,eV,eZ,eY){var eW,e0;this.user_id=eU;if(eZ==null){eZ=false}if(eY==null){eY=void 0}this.before_show=db(this.before_show,this);this.show=db(this.show,this);this.prompt_login_then_show=db(this.prompt_login_then_show,this);e0={origin:eV};e0[Constants.UID_PARAM_NAME]=this.user_id;if(eY){eW=D({path:"/sm/get_link_modal_content/"+eY}).toString()}else{eW=D({path:"/sm/share_link"+eX}).toString()}eT.__super__.constructor.call(this,{element_id:"share-link-modal",endpoint_url:eW,parameters:e0})}eT.prototype.prompt_login_then_show=function(){var eU;eU=(function(eV){return function(){eM.hide();br("#role-selector option").removeClass("disabled");cy.get_viewer().sign_in_user_by_id(eV.user_id);a0.ShmodelUILogger.log("via-shmodel-viewer");return eV.show()}})(this);if(!cy.get_viewer().is_uid_signed_in(this.user_id)){return bB.show_modal({user_id:this.user_id,on_success:eU})}else{return eU()}};eT.prototype.show=function(){var eU;eU=cy.get_viewer().get_user_by_id(this.user_id);if(dK.get_for_user(eU).verified_or_show(d8.SHMODAL)){return eT.__super__.show.call(this)}};eT.prototype.before_show=function(){var eX,eW,eU,eV;eV=this.$modal_window.find(".share-link-modal-content").length;if(eV){eX={"class":"ajax-loading-indicator",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"};eU=br("<img />",eX);eW=br("<div />",{"class":"loading-spinner"}).append(eU);return this.$modal_window.find(".dynamic-content").html(eW)}};return eT})(co);by=B.ShareLinkModalContent=(function(){function T(eX,eY,eZ,e0,eT,eU,e3,eW,e1,e4){var e2,eV;this.owner_id=eX;this.tkey=eY;this.fq_path=eZ;this.link=e0;this.filename=eT;this.tokenizer_type=eU;this.tokenizer_ctx_str=e3;this.fq_path_of_restricting_sf=e1;this.read_receipts_variant=e4;this._send_link=db(this._send_link,this);this._show_shared_link_settings_modal=db(this._show_shared_link_settings_modal,this);this._show_shared_folder_settings_modal=db(this._show_shared_folder_settings_modal,this);this._select_all_text=db(this._select_all_text,this);this._toggle_send_link_button=db(this._toggle_send_link_button,this);this._toggle_recipients_outside_team_warning=db(this._toggle_recipients_outside_team_warning,this);this._toggle_close_button_text=db(this._toggle_close_button_text,this);this._listen=db(this._listen,this);this._init_autocompleter=db(this._init_autocompleter,this);this.$content=br(".share-link-modal-content");this.modal=dN.get_containing_modal(this.$content);if(!this.modal){return}if(this.tokenizer_type==="shared_folder"){this.shared_folder_members=m.create_contacts_list(eW)}e2={filename:this.filename,fq_path:this.fq_path,tkey:this.tkey,user_id:this.owner_id};document.fire(aB.LINKS_ADD,e2);this.modal.set_title(ef("Share link to \u2018%(filename)s\u2019").format({filename:bG.em_snippet(this.filename,15)}));this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);this.$send_link_button=this.$content.find(".confirm-button");this.$share_link_url_input=this.$content.find(".copy-link-input-container input[type='text']");this.$cancel_button=this.$content.find(".cancel-button");this._init_autocompleter();this._listen();if((eV=this.$share_link_url_input[0])!=null){eV.select()}}T.prototype._init_autocompleter=function(){var eT;eT={tokens:[",",";"],include_fb:true,include_team:true,team_only:this.tokenizer_type==="team_only",user_id:this.owner_id};if(this.tokenizer_type==="shared_folder"){this.autocompleter=new Autocompleter.SharedFolderTokenizer(cy.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",eT,this.shared_folder_members)}else{if(this.tokenizer_type==="contacts"){this.autocompleter=new Autocompleter.ContactsTokenizer(cy.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",eT)}else{this.autocompleter=new Autocompleter.TeamTokenizer(cy.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",eT)}}b5.init();return this.$collab_input.focus()};T.prototype._listen=function(){var eU,eT,eX,eW,eV;this.$send_link_button.on("click",this._send_link);this.$share_link_url_input.on("click",this._select_all_text);this.$cancel_button.on("click",(function(eY){return function(eZ){return dH.pop()}})(this));this.$content.find("#shared-link-permissions-link").on("click",this._show_shared_link_settings_modal);this.$content.find("#shared-folder-options-link").on("click",this._show_shared_folder_settings_modal);if((eU=this.$collab_input)!=null){eU.keyup(this._toggle_send_link_button)}if((eT=this.$collab_input[0])!=null){eT.observe("token:remove",this._toggle_send_link_button)}if((eX=this.$collab_input[0])!=null){eX.observe("token:add",this._toggle_close_button_text)}if((eW=this.$collab_input[0])!=null){eW.observe("token:remove",this._toggle_close_button_text)}return(eV=this.$collab_input[0])!=null?eV.observe("sf:token:external",this._toggle_recipients_outside_team_warning):void 0};T.prototype._toggle_close_button_text=function(eV){var eT,eU;eT=((eU=this.autocompleter)!=null?eU.token_manager.tokens.length:void 0)===0;if(eT){return this.$cancel_button.text(ef("Close"))}else{return this.$cancel_button.text(ef("Cancel"))}};T.prototype._toggle_recipients_outside_team_warning=function(eV){var eT,eU;eT=br(".external-recipient-warning-message");if(eT.length){eU=eV.memo.count;if(eV.memo.shared_folder_warning){if(eU>0){return eT.show()}else{return eT.hide()}}else{if(eU>1){eT.find(".external-recpient-num").text(eU);return eT.removeClass("single").show()}else{if(eU===1){return eT.addClass("single").show()}else{return eT.hide()}}}}};T.prototype._toggle_send_link_button=function(eV){var eT,eU;eT=((eU=this.autocompleter)!=null?eU.token_manager.tokens.length:void 0)===0;eT=eT&&br.trim(this.$collab_input.val())==="";return this.$send_link_button.prop("disabled",eT)};T.prototype._select_all_text=function(eT){return br(eT.currentTarget)[0].select()};T.prototype._show_shared_folder_settings_modal=function(eU){var eT;eU.preventDefault();eT=cy.get_viewer().get_user_by_id(this.owner_id);return p.show_shared_folder_options_modal(this.fq_path_of_restricting_sf,eT)};T.prototype._show_shared_link_settings_modal=function(eU){var eT;eU.preventDefault();eT=new dE(this.owner_id,this.tkey);return dH.push(eT)};T.prototype._send_link=function(eX){var eV,eU,eW,eT,eY;eW=this.$content.find(".share-link-modal-send-form")[0];eT=this.get_shmodel_send_recipients(eW);eY=(function(eZ){return function(e0){var e1;e1=aP.success_string_for_recipients(eT);ab.success(e1);dH.pop();aG.log("shmodal_send");if(eZ.read_receipts_variant==="READ_RECEIPTS_SHOW_INTERESTS"){eZ.read_receipts_modal=new bK({element_id:"read_receipts_show_interests_modal",recipients:eT});return eZ.read_receipts_modal.show()}}})(this);eU=(function(eZ){return function(e0){return bF.remove_loading()}})(this);eV=this.$content.find(".tokenizer-submit-button")[0];return bF.ajax_submit(eW,"/sm/share",eY,eU,eV)};T.prototype.get_shmodel_send_recipients=function(eV){var eW,e4,e1,e5,e6,eZ,e2,eT,eY,eX,e3,eU,e0;cw(eV,"Must pass the shmodal send form into get_shmodel_send_recipients");eW=eV.select('input[name="emails"]');e4=eV.select('input[name="fb_ids"]');e1=eV.select('input[name="group_ids"]');eZ=eV.select('input[name="new_style_group_ids"]');eT=[];e0=[eW,e4,e1,eZ];for(eY=0,e3=e0.length;eY<e3;eY++){e6=e0[eY];for(eX=0,eU=e6.length;eX<eU;eX++){e5=e6[eX];e2=e5.up().innerHTML.stripTags().escapeHTML();eT.push(e2.substring(0,e2.indexOf("&")))}}return eT};return T})();bK=B.ReadReceiptsShowInterestsModal=(function(eT){cA(T,eT);function T(){return T.__super__.constructor.apply(this,arguments)}T.prototype.before_show=function(){var eU;eU=this._show_interests_title_for_recipients(this.options.recipients);this.format({".db-modal-title-text":eU});this.$modal_window.find(".read-receipts-confirm-interests-button").click((function(eV){return function(){return eV._confirm_interests()}})(this));this.$modal_window.find(".read-receipts-skip").click((function(eV){return function(){return eV._skip_interests()}})(this));return a0.ShmodelUILogger.log("read_receipts_view_interests")};T.prototype.on_hide=function(){return a0.ShmodelUILogger.log("read_receipts_dismiss_interests")};T.prototype._confirm_interests=function(){a0.ShmodelUILogger.log("read_receipts_confirm_interests");dH.pop();this.thanks_modal=new dN({element_id:"read_receipts_thank_you_modal"});this.thanks_modal.before_show=(function(eU){return function(eV){return eV.find(".read-receipts-thank-you-done-button").on("click",function(eW){return dH.pop()})}})(this);return this.thanks_modal.show()};T.prototype._skip_interests=function(){a0.ShmodelUILogger.log("read_receipts_skip_interests");return dH.pop()};T.prototype._show_interests_title_for_recipients=function(eU){var eX,eY,eW,eZ,eV;for(eZ=0,eV=eU.length;eZ<eV;eZ++){eY=eU[eZ];if(eY.indexOf("@")===-1){eW=eY;break}}if(!eW){return ef("Want to know when others view the file you shared?")}eX=eW.split(" ")[0];if(eU.length===1){return ef("Want to know when %(name)s views the file you shared?").format({name:eX})}return ef("Want to know when %(name)s and others view the file you shared?").format({name:eX})};return T})(dN);W=INLINE_JS.QuickSend=B.QuickSend={_files:{},_uploading_fileids:{},init:function(T,eT,eV){var eU;this.owner_id=T;this.tokenizer_ctx_str=eT;this.keep_visible=eV;this.$content=br("#browse-root-quick-send");this.$content[0].writeAttribute("dropzone","copy move");this.$content[0].writeAttribute("quicksend","true");this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);if((eU=this.$collab_input)!=null){eU.keyup(this._toggle_send_button_state)}if(this.$collab_input[0]){this.$collab_input[0].on("token:remove",this._toggle_send_button_state);this.$collab_input[0].on("token:add",this._toggle_send_button_state)}this.$send_button=this.$content.find("#quick-send-submit");this.$send_button.on("click",this._send_link);this.$cancel_button=this.$content.find("#quick-send-cancel");this.$cancel_button.on("click",this._cancel_button_clicked);this.$import_services=this.$content.find(".autocomplete");br("#browse-files").addClass("quicksend-collapsed");W._update_location();this.has_autocompleter_inited=false;a0.SharedFolderActivityLogger.log("web","quick_send_displayed",cf.active_user,{});this.$collab_input.on("blur",function(){return setTimeout(function(){var eW;return(eW=W.$import_services)!=null?eW.hide():void 0},100)});br("#quick-send-top-choose-button-send").click(function(){return br("#quick-send-file-box").click()});br("#quick-send-choose-button").click(function(){return br("#quick-send-file-box").click()});br(".quick-send-choose-file-link").click(function(){return br("#quick-send-file-box").click()});br("#quick-send-file-box").on("change",function(){var eX,eW;eW=br("#quick-send-file-box")[0].files;eX=function(){if(!cf.active_user){cf.active_user=cy.get_viewer().get_user_by_id(W.owner_id)}return be.upload(W.DEST_FOLDER+"/",eW)};return W.get_folder_name(eX)});document.on(cn.COMPLETE_EVT,W._file_upload_completed);document.on(cn.ERROR_EVT,W._file_upload_errored);return document.on(cf.UPDATE_EVT,W._update_location)},_cancel_button_clicked:function(T){a0.SharedFolderActivityLogger.log("web","quick_send_cancel_button_clicked",cf.active_user,{});return W._reset()},_init_autocompleter:function(){var T;if(W.has_autocompleter_inited){return}W.has_autocompleter_inited=true;T={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:W.owner_id,max_textbox_height:30,viewer:cy.get_viewer(),include_from_linked_accounts:true};return W.autocompleter=new Autocompleter.ContactsTokenizer(cy.get_viewer().get_user_by_id(W.owner_id),W.collab_input_id,W.tokenizer_ctx_str+"-new-whobulk",W.tokenizer_ctx_str+"-hidden-input",T)},_send_link:function(eZ){var eW,eV,eX,eU,eT,e0,e1,T,eY;a0.SharedFolderActivityLogger.log("web","quick_send_send_button_clicked",cf.active_user,{});W.autocompleter.tokenize_emails_input(true);T=W.autocompleter.getTokenCount();eU=br(".quick-send-left-form")[0];eT=[];e1=0;for(eX in W._files){e1+=1;eV=W._files[eX];eT.push(eV.fq_path)}e0={num_recipients:T,num_files:e1};a0.SharedFolderActivityLogger.log("web","quick_send_send_attempted",cf.active_user,e0);eY=(function(e2){return function(e3){W._reset();W._toggle_top_area_view();return a0.SharedFolderActivityLogger.log("web","quick_send_send_succeeded",cf.active_user,{})}})(this);eW=(function(e2){return function(e3){return a0.SharedFolderActivityLogger.log("web","quick_send_send_failed",cf.active_user,{})}})(this);return bF.ajax_submit(eU,"/sm/quick_send",eY,eW,null,{fq_paths:eT.join(",")})},_update_file_area_view:function(){if(Object.keys(W._files).length){br("#quick-send-drop-area").hide();br("#quick-send-files-area").show()}else{br("#quick-send-drop-area").show();br("#quick-send-files-area").hide()}return W._toggle_send_button_state()},_toggle_top_area_view:function(){br("#quick-send-top-part-send").hide();br("#quick-send-top-part-confirm").show();return setTimeout(function(){br("#quick-send-top-part-send").show();return br("#quick-send-top-part-confirm").hide()},3000)},_update_location:function(){var T;T=W.keep_visible||!!cf.inside_root_folder;return W._toggle_quick_send_module(T)},_toggle_quick_send_module:function(eU){var T,eT;if(W._visible===eU){return}eT=W.$content;if(eU){W._visible=true;eT.show();return W._update_collapsed_state()}else{W._visible=false;eT.hide();eT.removeClass("collapsed expanded");T=br("#browse-files");return T.removeClass("quicksend-collapsed quicksend-expanded")}},_update_collapsed_view:function(eW){var eT,eV,T,eU;eV=W.$content;eU=eW?"collapsed":"expanded";if(eV.hasClass(eU)){return}T=eW?"expanded":"collapsed";eV.removeClass(T);eV.addClass(eU);eT=br("#browse-files");eU=eW?"quicksend-collapsed":"quicksend-expanded";T=eW?"quicksend-expanded":"quicksend-collpased";eT.removeClass(T);eT.addClass(eU);if(!eW){return W._init_autocompleter()}},_update_collapsed_state:function(){var T;T=Object.keys(W._files).length;return W._update_collapsed_view(T===0)},_remove_file:function(eT,T){var eU;eU=false;if(eT in W._uploading_fileids){eU=true;document.fire(cn.CANCEL_EVT,{file:T});br(document).trigger(cn.CANCEL_EVT,{file:T});delete W._uploading_fileids[eT]}if(eT in W._files){$(eT).remove();delete W._files[eT];W._update_upload_list_scroll();W._update_file_area_view();return W._update_collapsed_state()}},_reset:function(){var eT,eV,eU,T;W.autocompleter.clearTokens();eU=br(".quick-send-left-form")[0];eU.reset();T=[];for(eV in W._files){eT=W._files[eV];T.push(W._remove_file(eV,eT.file_obj))}return T},_has_added_fq_path:function(eU){var T,eT;for(eT in W._files){T=W._files[eT];if(T.fq_path===eU){return true}}return false},_update_upload_list_scroll:function(){var eT,T;eT=Object.keys(W._files).length;T=br("#quick-send-upload-files-list");if(eT<3){return T.removeClass("scroll")}else{T.addClass("scroll");return T.scrollTop=T.scrollHeight}},_add_file:function(eV,T){var e2,eU,e1,eZ,e0,eW,eT,e3,eY,eX;e0={size:eV.bytes,source:T};a0.SharedFolderActivityLogger.log("web","quick_send_file_added",cf.active_user,e0);e2=eV.dest||W.DEST_FOLDER;e3=az.format_bytes(eV.bytes||0);eX=eP.tmpl("upload_list_item_tmpl");eU=eX({file:eV,icon:au.file_icon(eV.name),filename_snippet:bG.em_snippet(eV.name,dJ.FILENAME_SNIPPET_LENGTH),size:e3,dest:e2,dest_snippet:bG.em_snippet(ef("Dropbox")+e2,dJ.DEST_SNIPPET_LENGTH,0),Sprite:cj});eT=cK.sanitize(eU.toHTML());br("#quick-send-upload-files-list").append(eT);e1=br("#"+eV.id);W._update_upload_list_scroll();e1.find(".dest-col").hide();e1.find(".time-col").hide();eY=e1.find(".status-col").find("a.small-x-button");eZ=eV.id;eY.on("click",function(e4){return W._remove_file(eZ,eV)});eW=e1.find(".remove-link");eW.on("click",function(e4){return W._remove_file(eZ,eV)});e1.on("mouseenter",(function(e4){return function(e5){e1.find(".status-col").hide();return eW.show()}})(this));e1.on("mouseleave",(function(e4){return function(e5){e1.find(".status-col").show();return eW.hide()}})(this));W._files[eV.id]={file_div:eU,fq_path:eV.fq_path,bytes:eV.size,file_obj:eV};W._update_file_area_view();return W._update_collapsed_state()},_toggle_send_button_state:function(){var eU,T,eT;T=((eT=W.autocompleter)!=null?eT.token_manager.tokens.length:void 0)===0;T=T&&W.$collab_input.val()==="";eU=Object.keys(W._files).length===0||Object.keys(W._uploading_fileids).length>0;return W.$send_button.prop("disabled",T||eU)},_file_upload_errored:function(eU){var eT,T;eT=eU.memo.file;if(eT.id in W._uploading_fileids){T={message:eU.memo.message};a0.SharedFolderActivityLogger.log("web","quick_send_file_errored",cf.active_user,T);return delete W._uploading_fileids[eT.id]}},_file_upload_completed:function(eT){var T;T=eT.memo.file;if(T.id in W._uploading_fileids){a0.SharedFolderActivityLogger.log("web","quick_send_file_uploaded",cf.active_user,{});delete W._uploading_fileids[T.id];return W._toggle_send_button_state()}},get_folder_name:function(eV){var eT,eU,T;if(W.DEST_FOLDER){eV();return}T=function(eX){var eW;eW=JSON.parse(eX);W.DEST_FOLDER=eW.folder_name;return eV()};eT=function(){return ab.error(ef("We couldn\u2019t upload your file. Please try again."))};eU={};eU[Constants.UID_PARAM_NAME]=W.owner_id;return new cp.WebRequest({url:"/share/quick_send_folder_name",data:eU,success:T,error:eT})},is_quicksend_dest:function(T){var eT;eT=au.normalize(T);return eT===W.DEST_FOLDER},add_external_file:function(T){var eU,eT;eT=T.dest+T.name;if(W._has_added_fq_path(eT)){ab.success(ef("You\u2019ve already added this file."));document.fire(cn.CANCEL_EVT,{file:T});br(document).trigger(cn.CANCEL_EVT,{file:T});return}T.fq_path=eT;T.bytes=T.size;W._uploading_fileids[T.id]=true;W._add_file(T,"external");eU=br("#"+T.id);return eU.find(".upload-progress-bar").css({width:"0"})},add_dropbox_file:function(T){var eT;if(T.dir){ab.error(ef("Please select files instead of folders."));return}if(W._has_added_fq_path(T.fq_path)){ab.success(ef("You\u2019ve already added this file."));return}T.name=T.filename;W._add_file(T,"dropbox");eT=br("#"+T.id);eT.find(".upload-progress-bar").css({width:"100%"});eT.addClass("complete");return setTimeout(function(){var eU;eU=eT.find(".status-col");eU.empty();return eU.append(cj.make("web","s_check"))},0)}};var dE,cg,ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV},db=function(T,eT){return function(){return T.apply(eT,arguments)}};dE=B.SharedLinkSettingsModal=(function(eT){cA(T,eT);function T(eU,eV){var eW;this.owner_id=eU;this.tkey=eV;eW={tkey:this.tkey};eW[Constants.UID_PARAM_NAME]=this.owner_id;T.__super__.constructor.call(this,{element_id:"shared-link-settings-modal",endpoint_url:"/sm/shared_link_settings",parameters:eW})}return T})(co);cg=B.SharedLinkSettingsModalContent=(function(){function T(eU,eV,eT,eX){var eY,eW;this.owner_id=eU;this.tkey=eV;this.filename=eT;this.saved_password_placeholder_value=eX;this._save_settings=db(this._save_settings,this);this._toggle_password_input=db(this._toggle_password_input,this);this._enable_password_input_for_editing=db(this._enable_password_input_for_editing,this);this._date_change_callback=db(this._date_change_callback,this);this._show_calendar=db(this._show_calendar,this);this._hide_calendar=db(this._hide_calendar,this);this._future_date=db(this._future_date,this);this._enable_save_button=db(this._enable_save_button,this);this._custom_expiry_click_handler=db(this._custom_expiry_click_handler,this);this._hide_custom_expiry_label=db(this._hide_custom_expiry_label,this);this._show_custom_expiry_label=db(this._show_custom_expiry_label,this);this._toggle_expiration=db(this._toggle_expiration,this);this._expiry_picker_callback=db(this._expiry_picker_callback,this);this._listen=db(this._listen,this);this._detect_and_handle_blur_when_password_empty=db(this._detect_and_handle_blur_when_password_empty,this);this._is_clicked=db(this._is_clicked,this);this._change_password_click=db(this._change_password_click,this);this._init_expiration_section=db(this._init_expiration_section,this);this.MS_PER_DAY=1000*60*60*24;this.$content=br(".sharing-settings-modal-content");this.modal=dN.get_containing_modal(this.$content);if(!this.modal){return}eW=ef("'%(filename)s' permissions").format({filename:bG.em_snippet(this.filename,18)});this.modal.set_title(eW);this.$form=this.$content.find(".shared-link-settings-modal-form");this.$save_button=this.$form.find(".confirm-button");this.$password_field_container=this.$form.find(".password-field-container");this.$password=this.$form.find(".link-password-container");this.$password_input=this.$password.find("input[name='password']");this.$password_label=this.$password.find("label");this.$change_password=this.$form.find(".change-link-password-container");this.$selected_expiry=this.$form.find(".selected-expiration");this.$unselected_expiry=this.$form.find(".unselected-expiration");this.$custom_expiry=this.$form.find(".custom-expiration");this.$selected_date_box=this.$form.find(".selected-date");this.$selected_date=this.$form.find(".selected-date-text");this.$calendar=this.$form.find("#expiration-calendar-container");this.$expiry_posix=this.$form.find("#expiration-posix");this.loaded_with_saved_password=this.$password_input.data("is-saved-password")==="yes";if(this.loaded_with_saved_password){this._show_password_input(eY=true)}this._init_expiration_section();this._listen()}T.prototype._init_expiration_section=function(){var eT;this.$form.find(".expiration-selection").show();if(this.$expiry_posix.val()){br("#expiration-yes").prop("checked",true);eT=this._posix_time_to_date(parseInt(this.$expiry_posix.val()));this._set_selected_date_text(eT);return this._show_custom_expiry_label()}else{this.$selected_expiry.hide();this._hide_custom_expiry_label();return this.$unselected_expiry.show()}};T.prototype._change_password_click=function(eT){eT.preventDefault();return this._enable_password_input_for_editing()};T.prototype._is_clicked=function(eT,eU){return eT.is(eU.target)||eT.has(eU.target).length};T.prototype._detect_and_handle_blur_when_password_empty=function(eT){if(!this.$password.is(":visible")||this.$password_input.val()||this._is_clicked(this.$password_field_container,eT)){return}return this._show_password_input(true)};T.prototype._listen=function(){if(this.loaded_with_saved_password){br(window).on("click",this._detect_and_handle_blur_when_password_empty);this.$change_password.find(".change-link-password").on("click",this._change_password_click)}this.$form.on("change",this._enable_save_button);this.$form.on("submit",this._save_settings);this.$save_button.on("click",this._save_settings);this.$content.find(".cancel-button").on("click",(function(eT){return function(eU){return dH.pop()}})(this));this.$content.find(".audience-selection input[type=radio]").on("change",this._toggle_password_input);this.$content.find(".expiration-selection input[type=radio]").on("change",this._toggle_expiration);return br(window).on(bn.CHANGED,this._expiry_picker_callback)};T.prototype._expiry_picker_callback=function(eW,eV){var eT,eU;eT=eV.clicked_val;if(eT!=="custom"){eU=this._future_date(parseInt(eT));return this._set_expiration(eU)}else{this.$selected_expiry.hide();this._show_custom_expiry_label();this._set_selected_date_text(this._future_date(30));return this._show_calendar()}};T.prototype._toggle_expiration=function(eV){var eU,eT;if(br(eV.currentTarget).attr("id")==="expiration-yes"){this.$selected_expiry.show();this._hide_custom_expiry_label();this.$unselected_expiry.hide();br(".expiration-picker").controller().set_value(30);eT=30;eU=this._future_date(eT);this._set_expiration(eU);return this._set_selected_date_text(eU)}else{this.$expiry_posix.val("");this.$unselected_expiry.show();this.$selected_expiry.hide();this._hide_custom_expiry_label();return this._hide_calendar()}};T.prototype._show_custom_expiry_label=function(){this.$custom_expiry.show();this.$selected_expiry.hide();this.$unselected_expiry.hide();return br(window).on("click",this._custom_expiry_click_handler)};T.prototype._hide_custom_expiry_label=function(){this.$custom_expiry.hide();return br(window).off("click",this._custom_expiry_click_handler)};T.prototype._custom_expiry_click_handler=function(eT){if(this._is_clicked(this.$calendar,eT)){return}if(this.$selected_date_box.is(eT.target)||this.$selected_date_box.has(eT.target).length){if(this.$calendar.is(":visible")){return this.$calendar.hide()}else{return this._show_calendar()}}else{if(this.$calendar.is(":visible")){return this.$calendar.hide()}}};T.prototype._enable_save_button=function(eT){return this.$save_button.removeAttr("disabled")};T.prototype._future_date=function(eT){var eU;eU=dL.start_of_day(new Date());eU.setDate(eU.getDate()+eT);return eU};T.prototype._hide_calendar=function(){return this.$calendar.hide()};T.prototype._show_calendar=function(){var eV,eU,eT;br(".selected-date").off("click");if(!this.calendar){if(this.$expiry_posix.val()){eT=this._posix_time_to_date(parseInt(this.$expiry_posix.val()))}else{eT=this._future_date(30)}eU={disable_past:true,first_day:this._future_date(1),last_day:this._future_date(365),selected_date:eT,onDateChange:br.proxy(this._date_change_callback,this)};this.calendar=new F("expiration-calendar-container",eU)}else{this.$calendar.show()}eV=this.$selected_date_box.offset().left;return this.$calendar.show().offset({left:eV})};T.prototype._posix_time_to_date=function(eT){return new Date(eT*1000)};T.prototype._set_selected_date_text=function(eT){return this.$selected_date.text(K.localize(eT))};T.prototype._set_expiration=function(eU){var eT,eV;cw(eU.getMilliseconds()===0);cw(eU.getSeconds()===0);cw(eU.getMinutes()===0);cw(eU.getHours()===0);eV=(eU.getTime()+this.MS_PER_DAY)/1000;eT=eV-1;return this.$expiry_posix.val(eT)};T.prototype._date_change_callback=function(eT){this._set_selected_date_text(eT);this._set_expiration(eT);this._enable_save_button();return this._hide_calendar()};T.prototype._show_password_input=function(eY){var eX,eV,eU,eW,eT;if(eY==null){eY=false}eX=this.$content.find("label[for=audience-password]").position().left;eW=this.$content.find("#audience-password").position().left;eV=eX-eW+10;this.$password.show().css({left:eV});this.$password_input.val("");if(eY){this.$password_input.addClass("disabled").attr("readonly","true");this.$password_input.data("is-saved-password","yes");eT="\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf";this.$password_label.text(eT).show();eU=this.$password.position();return this.$change_password.css({left:eU.left,top:eU.top}).show()}else{return this._enable_password_input_for_editing()}};T.prototype._enable_password_input_for_editing=function(){this.$change_password.hide();this.$password_input.removeAttr("readonly").removeClass("disabled");this.$password_input.data("is-saved-password","no");this.$password_label.text(ef("Set password")).show();this.$password_input.focus();return this._enable_save_button()};T.prototype._toggle_password_input=function(eT){var eU;if(br(eT.currentTarget).attr("id")==="audience-password"){return this._show_password_input(eU=this.loaded_with_saved_password)}else{this.$password.hide();this.$change_password.hide();return this.$password_input.data("is-saved-password","no")}};T.prototype._save_settings=function(eW){var eU,eT,eV,eX;if(this.$password_input.data("is-saved-password")==="yes"){eV={type:"hidden",name:"password",value:this.saved_password_placeholder_value};eU=br("<input />",eV);this.$form.append(eU);this.$password_input.attr("name","inoperative_password")}eX=(function(eY){return function(eZ){dH.pop();return ab.success(ef("Settings saved."))}})(this);eT=(function(eY){return function(eZ){if(eY.$password.length&&eY.$password.is(":visible")){eY.$password_input.focus()}return bF.remove_loading()}})(this);return bF.ajax_submit(this.$form[0],"/sm/change_shared_link_settings",eX,eT,this.$save_button[0])};return T})();var ek;ek=B.SimpleSharing=(function(){function T(){}T.createAndShowInbandModalFromBrowseFile=function(eT,eU){return T.createAndShowInbandModal(eT,eU.fq_path,eU.dir,eU.target_ns,eU.is_shared_folder(),eU.could_be_shared_folder(),parseInt(eU.sf_perm_role))};T.createAndShowInbandModal=function(eT,eW,eX,eV,eU,eZ,e0){var eY;eY=function(e2,e3,e1){return window.INLINE_JS.DBModalStack.push(new cX(e2,e3,false,false,e1))};return dv.createAndShowModal(eT,eW,eY,eX,eV,eU,eZ,parseInt(e0))};return T})();var ee,eb;eb=B.FoshmodalPanes=Object.clone(c5);eb.to_title_str=function(){var T,eT,eX,eV,eW,eU;if(ee.sharing_collection){eV=bG.em_snippet(ee.collection_to_share.name,18,1);return ef("Share '%(snippeted_name)s'").format({snippeted_name:eV})}else{T=ee._selection;eU=cR.categorize_files(T),eT=eU[0],eX=eU[1];if(eT&&eX){eW=a1("Share %(file_count)s item","Share %(file_count)s items",T.length)}else{if(eT){eW=a1("Share %(file_count)s photo","Share %(file_count)s photos",T.length)}else{eW=a1("Share %(file_count)s video","Share %(file_count)s videos",T.length)}}eW=eW.format({file_count:T.length});return eW}};ee=INLINE_JS.Foshmodal=B.Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:eb.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=eb.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;ez.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();br(".link-image").attr("src","static/images/empty_album_big.png");bF.remove_loading(br("#modal").find(".tokenizer-submit-button")[0]);bF.remove_loading(br("#modal").find(".foshmodal-copy-link")[0]);bF.remove_loading(br("#shmodal-twitter-post-submit")[0]);return bF.remove_loading(br("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(T){var eT;cw(this._selection.length,"This should never be called with an empty selection");cw(this.current_tkey!=null,"Missing tkey");cw(this.current_shmodel_url!=null,"Missing shmodel url");cw(this.current_short_url!=null,"Missing short url");cw(T!=null,"Missing collection info");T.is_anonymous=this.creating_anonymous_collection();T.share_tkey=this.current_tkey;T.shmodel_url=this.current_shmodel_url;T.short_url=this.current_short_url;return eT=new Z(T)},set_shmodel_url:function(eT,T){if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof eT==="function"?eT():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:(function(eU){return function(eW){var eV;eV=JSON.parse(eW.responseText);eU.current_shmodel_url=eV.token_link;eU.current_short_url=eV.short_link;eU.current_tkey=eV.tkey;if(typeof eT==="function"){eT()}return typeof eU.callback_for_when_we_have_shmodel_url==="function"?eU.callback_for_when_we_have_shmodel_url():void 0}})(this),onFailure:function(){return typeof T==="function"?T():void 0}})}},attach_collection_to_token:function(eT,T){cw(this.collection_to_share!=null,"Should get called only when there is an existing collection");cw(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof eT==="function"){eT(this.collection_to_share.gid)}return}cw(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,eT,T)},create_collection_and_attach_to_token:function(eX,T){var eU,eW,eV,eT;cw(this.sharing_collection===false,"Should not get called when we already have a collection");cw(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");eW=(function(eY){return function(eZ){var e0;e0=JSON.parse(eZ.responseText);eY.create_album_from_selected_photos(e0);return typeof eX==="function"?eX(e0.gid):void 0}})(this);eU=function(eY){return typeof T==="function"?T(eY):void 0};eV={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var e1,eZ,e0,eY;e0=this._selection;eY=[];for(e1=0,eZ=e0.length;e1<eZ;e1++){eT=e0[e1];eY.push(eT.item_counter)}return eY}).call(this))};if(bC.in_single_collection_view()){eV.source_collection_gid=bC.get_current_collection().gid}return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:eW,onFailure:eU,parameters:eV})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){ab.error(ef("Please enter a name for this album"));this.unlock();return true}if(ct.collection_name_in_use(this.current_album_name)){ab.error(ef("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(eU){var eT,T;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}eT=$("shmodal-send-form");cw(eT,"Couldn't find the shmodal send form.");if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}T=(function(eV){return function(eW){eV.unlock();if(!eW.responseText.startsWith("err:")){ab.error(ef("We couldn't send this album. Please try again."));eM.hide();return eV.refresh()}}})(this);if(this.sharing_collection){this.send_collection(eT,T)}else{this.send_selection(eT,T)}return h.log_interaction(d2.SEND,cT.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var eV,eT,eU,T,eW;eV=this.get_current_display_name();T=ag.get_shmodel_send_recipients($("shmodal-send-form"));eT=T[0].split(" ")[0];if(T.length===1){eW=ef("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:eV,first_name_of_recipient:eT})}else{if(T.length===2){eU=T[1].split(" ")[0];eW=ef("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:eV,first_name_of_recipient:eT,first_name_of_second_recipient:eU})}else{eW=ef("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:eV,first_name_of_recipient:eT,num_other_recipients:T.length-1})}}return eW},send_selection:function(eU,eT){var eW,eV,T;eW=(function(eX){return function(eY){var eZ;eZ=JSON.parse(eY.responseText);eX.create_album_from_selected_photos(eZ);ab.success(eX.get_send_success_text());eX.refresh();return eM.hide()}})(this);eV={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var e0,eY,eZ,eX;eZ=this._selection;eX=[];for(e0=0,eY=eZ.length;e0<eY;e0++){T=eZ[e0];eX.push(T.item_counter)}return eX}).call(this))};if(bC.in_single_collection_view()){eV.source_collection_gid=bC.get_current_collection().gid}if(this.creating_anonymous_collection()){eV.collection_name=""}else{if(this.current_album_name.trim().length===0){eV.collection_name=ct.get_default_album_name()}}return bF.ajax_submit(eU,"/collection_create_and_send_link",eW,eT,eU.down(".tokenizer-submit-button"),eV)},send_collection:function(eT,T){var eU;cw(this.current_tkey!=null,"tkey should be set");cw(this.current_shmodel_url!=null,"shmodel url should be set");eU=(function(eV){return function(){ab.success(eV.get_send_success_text());eM.hide();return eV.refresh()}})(this);return this.collection_to_share.send_link(eT,this.current_tkey,this.current_shmodel_url,this.current_short_url,eU,T)},get_link_button_onclick:function(){var T,eU,eT;if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}eT=$("modal").down(".tokenizer-submit-button");eU=(function(eV){return function(eX){var eW;eW=eV.get_current_display_name();if(FlashDetect.installed){ab.success(ef("The link to %(album_name)s was copied to your clipboard",{comment:"name of a photo/video album"}).format({album_name:eW}))}eV.show_get_link_modal(eV.current_shmodel_url,eW,eX);a0.ViralLogger.log(cy.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(eV.collection_to_share!=null){cl.log_share("share_link",eX,eV.num_photos_to_share,eV.creating_anonymous_collection(),!eV.sharing_collection)}return eV.refresh()}})(this);T=(function(eV){return function(eW){eV.unlock();bF.remove_loading(eT);if(!eW.responseText.startsWith("err")){ab.error(ef("We couldn't create a link to this album. Please try again."));eM.hide();return eV.refresh()}}})(this);if(this.sharing_collection){bF.add_loading(eT);this.attach_collection_to_token(eU,T)}else{if(this.alert_if_album_name_invalid()){return}bF.add_loading(eT);this.create_collection_and_attach_to_token(eU,T)}return h.log_interaction(d2.GET_LINK,cT.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var T,eT;if(FlashDetect.installed){T=q.clipboard_overlay(this.current_shmodel_url,br("#foshmodal-copy-link"),ee.get_link_button_onclick.bind(this));T.css({position:"fixed",zIndex:1001});clearInterval(this.follow_freshbutton);eT=(function(eU){return function(){return T.clonePosition(br("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);return this.follow_freshbutton=setInterval(eT,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(eX,eT){var eW,eU,T,eV;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(eX,eT);return}eW=br("#modal:visible, #modal-overlay:visible");T=function(){return eW.show()};eU=(function(eY){return function(){eY.lock();setTimeout(eY.unlock.bind(eY),750);return d7.do_auth((function(){return eY.do_fb_post(eT)}),eT)}})(this);if(d7.authed_user_id===eT){this.do_fb_post(eT)}else{if(cy.get_viewer().is_uid_associated(d7.authed_user_id)){this.unlock();eW.hide();eV=new dS(cy.get_viewer().get_user_by_id(eT),T,eU.bind(this));eV.show()}else{eU()}}return h.log_interaction(d2.FB_SHARE,cT.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(eT,T){if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(eT,T);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(cq.is_authed(T)){this.do_twitter_post(T)}else{setTimeout(this.unlock.bind(this),750);cq.do_auth(((function(eU){return function(){return eU.do_twitter_post(T)}})(this)),T)}return h.log_interaction(d2.TWITTER_SHARE,cT.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(T){var eT,eU;eT=(function(eV){return function(){ab.error(ef("We couldn't share this album on Facebook. Please try again."));eM.hide();return eV.refresh()}})(this);eU=(function(eV){return function(eX){var eW;d7.custom_show_posting=function(){return bF.add_loading($("shmodal-fb-post-submit"))};d7.progress_container=$("modal").down(".modal-buttons");eW=eV.get_current_display_name();d7.custom_show_complete=function(){eM.hide();ab.success(ef("Shared %(album_name)s on Facebook!",{comment:"name of a photo/video album"}).format({album_name:eW}));return eV.refresh()};d7.post($F("shmodal-fb-post-input"),eV.current_shmodel_url,null,null,null,eT,T);a0.ViralLogger.log(cy.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return cl.log_share("share_facebook",eX,eV.num_photos_to_share,eV.creating_anonymous_collection(),!eV.sharing_collection)}})(this);if(this.sharing_collection){return this.attach_collection_to_token(eU,eT)}else{return this.create_collection_and_attach_to_token(eU,eT)}},do_twitter_post:function(T){var eV,eT,eU;eV=$F("shmodal-twitter-post-input");if(!eV){ab.error(ef("Please enter a tweet"));this.unlock();return}if(eV.length>140){ab.error(ef("Your tweet must be 140 characters or less"));this.unlock();return}eU=(function(eW){return function(eX){cq.custom_show_posting=function(){$("twitter-chars").hide();return bF.add_loading($("shmodal-twitter-post-submit"))};cq.custom_post(eV,function(){eM.hide();ab.success(ef("Your tweet has been posted!"));return eW.refresh()},T);a0.ViralLogger.log(cy.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return cl.log_share("share_twitter",eX,eW.num_photos_to_share,eW.creating_anonymous_collection(),!eW.sharing_collection)}})(this);eT=(function(eW){return function(){ab.error(ef("We couldn't share this album on Twitter. Please try again."));eM.hide();return eW.refresh()}})(this);if(this.sharing_collection){return this.attach_collection_to_token(eU,eT)}else{return this.create_collection_and_attach_to_token(eU,eT)}},show_get_link_modal:function(eT,T,eU){var eV;eM.show(ef("Link to %(album_name)s").format({album_name:T.escapeHTML()}),$("get-link-modal"));eV=$("get-link-modal").down(".link-input");eV.setValue(eT);eV.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(eT,"_blank");return eM.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(eU!=null){ct.flash_sidebar_album(eU)}return eM.hide()}},update_current_album_name_text:function(T){this.current_album_name=$(eb.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===eb.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(eW){var eT,eV,eU,T;T=this.sharing_collection?bC.get_timeline().get_photos():this._selection;if(eW){if(this.num_photos_to_share===1){eT=eW}else{eT=ef("%(album_name_text)s (%(album_desc)s)",{comment:'e.g. album_desc is "5 photos and 1 video" and album_name_text is "my_album"'}).format({album_name_text:eW,album_desc:cR.file_desc(T)})}}else{if(T.length===1){eU=T[0];if(eU.preview_type==="photo"){eV=ef("Photo from %(date_taken)s")}else{eV=ef("Video from %(date_taken)s")}eT=eV.format({date_taken:bR.nice_date_with_month_name(new Date(eU.time_taken),true,true,true)})}else{eT=cR.file_desc(T)}}return $(eb.to_content_str(eb.FB)).down(".link-name").__date(eT)},set_current_album_name_text:function(eT,T){$(eb.to_content_str(eT)).down(".album-name-input").value=T;if(eT===eb.FB){return this.set_fb_post_title(T)}},show_content:function(eW){var eT,eV,T,eU;if(this.working){return}$("shmodal-title-text").__date(eb.to_title_str());eU=eb.list;for(eV=0,T=eU.length;eV<T;eV++){eT=eU[eV];if(eT!==eW){$(eb.to_toggle_str(eT)).removeClassName("toggled");$(eb.to_content_str(eT)).hide()}}$(eb.to_content_str(eW)).show();$(eb.to_toggle_str(eW)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(eW,this.current_album_name)}switch(eW){case eb.FB:$("shmodal-fb-post-input").focus();break;case eb.TWITTER:$("shmodal-twitter-post-input").focus();break;case eb.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=eW},_get_foshmodal_title:function(){return ag.generate_title_content(eb.to_title_str(),((function(T){return function(){return T.show_content(eb.SEND)}})(this)),((function(T){return function(){return T.show_content(eb.FB)}})(this)),((function(T){return function(){return T.show_content(eb.TWITTER)}})(this)))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return cR.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var T,eU,eT,eW,eV;T=this.sharing_collection?bC.get_timeline().get_photos():this._selection;if(T.length===1){eV=cR.categorize_files(T),eT=eV[0],eW=eV[1];if(eT){eU=ef("Just shared a photo using @Dropbox")}else{if(eW){eU=ef("Just shared a video using @Dropbox")}else{cw(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{eU=ef("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(""+eU+" "+this.current_short_url)},update_shmodal_image_text:function(){var eZ,e2,e1,eX,eW,e0,T,eY,eV,eU,eT;if(this.sharing_collection){e2=this.collection_to_share.num_items;e1=cR.album_desc(this.collection_to_share,false,true)}else{e2=this._selection.length;e1=cR.file_desc(this._selection,false,true)}if(e2>1){eY=$$(".shmodal-image");eU=[];for(eX=0,e0=eY.length;eX<e0;eX++){eZ=eY[eX];eZ.down("span").__date(e1);eU.push(eZ.down(".share-file-count").show())}return eU}else{eV=$$(".shmodal-image");eT=[];for(eW=0,T=eV.length;eW<T;eW++){eZ=eV[eW];eT.push(eZ.down(".share-file-count").hide())}return eT}},show:function(e0,e7){var e1,e4,e5,e2,e6,eY,eX,eV,e3,eT,T,eZ,eW,eU;this.unlock();eM.onHide=(function(e8){return function(){var fa,e9;if((fa=$("flash_copy_container"))!=null){fa.remove()}if((e9=e8.send_link_autocompleter)!=null){e9.hide()}br("#modal").find(".new-collab-input").val("");clearInterval(e8.follow_freshbutton);bC.disable_selection();delete eM.onHide;return eM.hide()}})(this);this.sharing_collection=e7;e6=this.sharing_collection?e0.thumbnail_url_256:e0[0].thumbnail_url;eZ=$$(".link_image");for(eY=0,e3=eZ.length;eY<e3;eY++){e4=eZ[eY];if(e6!=null){e4.src=e6}else{e4.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=eb.SEND;this.have_real_tkey=this.sharing_collection&&(e0.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=e0;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=e0.sort(function(e9,e8){return e9.time_taken-e8.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");eW=$$(".save-as-album-checkbox");for(eX=0,eT=eW.length;eX<eT;eX++){e1=eW[eX];e1.checked=false;e2=(function(e8){return function(fh){var fi,fe,fc,fa,e9,fd,fb,fg,ff;if(fh.target.checked){$("shmodal").addClassName("saving-as-album");e8.current_album_name=e8.previous_album_name||ct.get_default_album_name();e8.set_current_album_name_text(e8.current_foshmodal_pane,e8.current_album_name);fi=$(eb.to_content_str(e8.current_foshmodal_pane)).down(".album-name-input");fi.focus();fi.select();fd=$$(".save-as-album-checkbox");fg=[];for(fe=0,fa=fd.length;fe<fa;fe++){e1=fd[fe];fg.push(e1.checked=true)}return fg}else{$("shmodal").removeClassName("saving-as-album");e8.previous_album_name=e8.current_album_name;e8.current_album_name="";e8.set_current_album_name_text(e8.current_foshmodal_pane,e8.current_album_name);fb=$$(".save-as-album-checkbox");ff=[];for(fc=0,e9=fb.length;fc<e9;fc++){e1=fb[fc];ff.push(e1.checked=false)}return ff}}})(this);e1.observe("change",e2);if(bO.msie_version_at_most(8)){e1.observe("click",e2)}}eU=$$(".album-name-input");for(eV=0,T=eU.length;eV<T;eV++){e5=eU[eV];e5.observe("keyup",this.update_current_album_name_text.bind(this))}}bC.enable_selection();eM.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url(((function(e8){return function(){e8.initialize_get_link_button();return e8.set_twitter_message()}})(this)),(function(){ab.error(ef("This request could not be completed.  Please try again."));return eM.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(cy.get_viewer().get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();R.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return dL._track_twitter_chars_left("shmodal-twitter-post-input",140)}};(function(eT,eY){var eV={};function eU(e3,e4){var e2,e0=[];for(var e1=0;e1<e3.length;++e1){e2=eV[e3[e1]]||eW(e3[e1]);if(!e2){throw"module definition dependecy not found: "+e3[e1]}e0.push(e2)}e4.apply(null,e0)}function eZ(e2,e1,e0){if(typeof e2!=="string"){throw"invalid module definition, module id must be defined and be a string"}if(e1===eY){throw"invalid module definition, dependencies must be specified"}if(e0===eY){throw"invalid module definition, definition function must be specified"}eU(e1,function(){eV[e2]=e0.apply(null,arguments)})}function eX(e0){return !!eV[e0]}function eW(e3){var e1=eT;var e0=e3.split(/[.\/]/);for(var e2=0;e2<e0.length;++e2){if(!e1[e0[e2]]){return}e1=e1[e0[e2]]}return e1}function T(e2){for(var e1=0;e1<e2.length;e1++){var e3=eT;var e5=e2[e1];var e0=e5.split(/[.\/]/);for(var e4=0;e4<e0.length-1;++e4){if(e3[e0[e4]]===eY){e3[e0[e4]]={}}e3=e3[e0[e4]]}e3[e0[e0.length-1]]=eV[e5]}}eZ("moxie/core/utils/Basic",[],function(){var e8=function(fd){var fc;if(fd===fc){return"undefined"}else{if(fd===null){return"null"}else{if(fd.nodeType){return"node"}}}return({}).toString.call(fd).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()};var e4=function(fd){var fc;e6(arguments,function(fe,ff){if(ff>0){e6(fe,function(fh,fg){if(fh!==fc){if(e8(fd[fg])===e8(fh)&&!!~fa(e8(fh),["array","object"])){e4(fd[fg],fh)}else{fd[fg]=fh}}})}});return fd};var e6=function(fh,fi){var fg,fe,fd,ff;if(fh){try{fg=fh.length}catch(fc){fg=ff}if(fg===ff){for(fe in fh){if(fh.hasOwnProperty(fe)){if(fi(fh[fe],fe)===false){return}}}}else{for(fd=0;fd<fg;fd++){if(fi(fh[fd],fd)===false){return}}}}};var e9=function(fc){var fd;if(!fc||e8(fc)!=="object"){return true}for(fd in fc){return false}return true};var e2=function(fd,fc){var fe=0,ff=fd.length;if(e8(fc)!=="function"){fc=function(){}}if(!fd||!fd.length){fc()}function fg(fh){if(e8(fd[fh])==="function"){fd[fh](function(fi){++fh<ff&&!fi?fg(fh):fc(fi)})}}fg(fe)};var fa=function(fe,ff){if(ff){if(Array.prototype.indexOf){return Array.prototype.indexOf.call(ff,fe)}for(var fc=0,fd=ff.length;fc<fd;fc++){if(ff[fc]===fe){return fc}}}return -1};var e7=function(fd,ff){var fe=[];if(e8(fd)!=="array"){fd=[fd]}if(e8(ff)!=="array"){ff=[ff]}for(var fc in fd){if(fa(fd[fc],ff)===-1){fe.push(fd[fc])}}return fe.length?fe:false};var fb=function(fe,fd){var fc=[];e6(fe,function(ff){if(fa(ff,fd)!==-1){fc.push(ff)}});return fc.length?fc:null};var e3=function(fe){var fd,fc=[];for(fd=0;fd<fe.length;fd++){fc[fd]=fe[fd]}return fc};var e5=(function(){var fc=0;return function(ff){var fd=new Date().getTime().toString(32),fe;for(fe=0;fe<5;fe++){fd+=Math.floor(Math.random()*65535).toString(32)}return(ff||"o_")+fd+(fc++).toString(32)}}());var e0=function(fc){if(!fc){return fc}return String.prototype.trim?String.prototype.trim.call(fc):fc.toString().replace(/^\s*/,"").replace(/\s*$/,"")};var e1=function(fc){if(typeof(fc)!=="string"){return fc}var fe={t:1099511627776,g:1073741824,m:1048576,k:1024},fd;fc=/^([0-9]+)([mgk]?)$/.exec(fc.toLowerCase().replace(/[^0-9mkg]/g,""));fd=fc[2];fc=+fc[1];if(fe.hasOwnProperty(fd)){fc*=fe[fd]}return fc};return{guid:e5,typeOf:e8,extend:e4,each:e6,isEmptyObj:e9,inSeries:e2,inArray:fa,arrayDiff:e7,arrayIntersect:fb,toArray:e3,trim:e0,parseSizeStr:e1}});eZ("moxie/core/I18n",["moxie/core/utils/Basic"],function(e1){var e0={};return{addI18n:function(e2){return e1.extend(e0,e2)},translate:function(e2){return e0[e2]||e2},_:function(e2){return this.translate(e2)},sprintf:function(e4){var e3=[].slice.call(arguments,1),e2="";e1.each(e4.split(/%[a-z]/),function(e5){e2+=e5;if(e3.length){e2+=e3.shift()}});return e2}}});eZ("moxie/core/utils/Mime",["moxie/core/utils/Basic","moxie/core/I18n"],function(e3,e2){var e0="application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/vnd.openxmlformats-officedocument.wordprocessingml.document,docx,application/vnd.openxmlformats-officedocument.wordprocessingml.template,dotx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,xlsx,application/vnd.openxmlformats-officedocument.presentationml.presentation,pptx,application/vnd.openxmlformats-officedocument.presentationml.template,potx,application/vnd.openxmlformats-officedocument.presentationml.slideshow,ppsx,application/x-javascript,js,application/json,json,audio/mpeg,mp3 mpga mpega mp2,audio/x-wav,wav,audio/mp4,m4a,audio/ogg,oga ogg,audio/aiff,aiff aif,audio/flac,flac,audio/aac,aac,audio/ac3,ac3,audio/x-ms-wma,wma,image/bmp,bmp,image/gif,gif,image/jpeg,jpg jpeg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe m2v,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/3gpp,3gpp 3gp,video/3gpp2,3g2,video/vnd.rn-realvideo,rv,video/ogg,ogv,video/x-matroska,mkv,application/vnd.oasis.opendocument.formula-template,otf,application/octet-stream,exe";var e1={mimes:{},extensions:{},addMimeType:function(e4){var e5=e4.split(/,/),e6,e8,e7;for(e6=0;e6<e5.length;e6+=2){e7=e5[e6+1].split(/ /);for(e8=0;e8<e7.length;e8++){this.mimes[e7[e8]]=e5[e6]}this.extensions[e5[e6]]=e7}},extList2mimes:function(fa,fb){var e5=this,e9,e6,e8,e7,e4=[];for(e6=0;e6<fa.length;e6++){e9=fa[e6].extensions.split(/\s*,\s*/);for(e8=0;e8<e9.length;e8++){if(e9[e8]==="*"){return[]}e7=e5.mimes[e9[e8]];if(!e7){if(fb&&/^\w+$/.test(e9[e8])){e4.push("."+e9[e8])}else{return[]}}else{if(e3.inArray(e7,e4)===-1){e4.push(e7)}}}}return e4},mimes2exts:function(e4){var e5=this,e6=[];e3.each(e4,function(e8){if(e8==="*"){e6=[];return false}var e7=e8.match(/^(\w+)\/(\*|\w+)$/);if(e7){if(e7[2]==="*"){e3.each(e5.extensions,function(e9,fa){if((new RegExp("^"+e7[1]+"/")).test(fa)){[].push.apply(e6,e5.extensions[fa])}})}else{if(e5.extensions[e8]){[].push.apply(e6,e5.extensions[e8])}}}});return e6},mimes2extList:function(e4){var e6=[],e5=[];if(e3.typeOf(e4)==="string"){e4=e3.trim(e4).split(/\s*,\s*/)}e5=this.mimes2exts(e4);e6.push({title:e2.translate("Files"),extensions:e5.length?e5.join(","):"*"});e6.mimes=e4;return e6},getFileExtension:function(e5){var e4=e5&&e5.match(/\.([^.]+)$/);if(e4){return e4[1].toLowerCase()}return""},getFileMime:function(e4){return this.mimes[this.getFileExtension(e4)]||""}};e1.addMimeType(e0);return e1});eZ("moxie/core/utils/Env",["moxie/core/utils/Basic"],function(e6){var e2=[{s1:navigator.userAgent,s2:"Android",id:"Android Browser",sv:"Version"},{s1:navigator.userAgent,s2:"Chrome",id:"Chrome"},{s1:navigator.vendor,s2:"Apple",id:"Safari",sv:"Version"},{prop:window.opera&&window.opera.buildNumber,id:"Opera",sv:"Version"},{s1:navigator.vendor,s2:"KDE",id:"Konqueror"},{s1:navigator.userAgent,s2:"Firefox",id:"Firefox"},{s1:navigator.vendor,s2:"Camino",id:"Camino"},{s1:navigator.userAgent,s2:"Netscape",id:"Netscape"},{s1:navigator.userAgent,s2:"MSIE",id:"IE",sv:"MSIE"},{s1:navigator.userAgent,s2:"Trident",id:"IE",sv:"rv"},{s1:navigator.userAgent,s2:"Gecko",id:"Mozilla",sv:"rv"}],e4=[{s1:navigator.platform,s2:"Win",id:"Windows"},{s1:navigator.platform,s2:"Mac",id:"Mac"},{s1:navigator.userAgent,s2:"iPhone",id:"iOS"},{s1:navigator.userAgent,s2:"iPad",id:"iOS"},{s1:navigator.userAgent,s2:"Android",id:"Android"},{s1:navigator.platform,s2:"Linux",id:"Linux"}],e1;function e5(e9){var fa,fb;for(var e8=0;e8<e9.length;e8++){fa=e9[e8].s1;fb=e9[e8].prop;e1=e9[e8].sv||e9[e8].id;if(fa){if(fa.indexOf(e9[e8].s2)!=-1){return e9[e8].id}}else{if(fb){return e9[e8].id}}}}function e7(e9){var e8=e9.indexOf(e1);if(e8==-1){return}return parseFloat(e9.substring(e8+e1.length+1))}var e3=(function(){var e8={define_property:(function(){return false}()),create_canvas:(function(){var e9=document.createElement("canvas");return !!(e9.getContext&&e9.getContext("2d"))}()),return_response_type:function(e9){try{if(e6.inArray(e9,["","text","document"])!==-1){return true}else{if(window.XMLHttpRequest){var fb=new XMLHttpRequest();fb.open("get","/");if("responseType" in fb){fb.responseType=e9;if(fb.responseType!==e9){return false}return true}}}}catch(fa){}return false},use_data_uri:(function(){var e9=new Image();e9.onload=function(){e8.use_data_uri=(e9.width===1&&e9.height===1)};setTimeout(function(){e9.src="data:image/gif;base64,R0lGODlhAQABAIAAAP8AAAAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw=="},1);return false}()),use_data_uri_over32kb:function(){return e8.use_data_uri&&(e0.browser!=="IE"||e0.version>=9)},use_data_uri_of:function(e9){return(e8.use_data_uri&&e9<33000||e8.use_data_uri_over32kb())},use_fileinput:function(){var e9=document.createElement("input");e9.setAttribute("type","file");return !e9.disabled}};return function(fa){var e9=[].slice.call(arguments);e9.shift();return e6.typeOf(e8[fa])==="function"?e8[fa].apply(this,e9):!!e8[fa]}}());var e0={can:e3,browser:e5(e2),version:e7(navigator.userAgent)||e7(navigator.appVersion),OS:e5(e4),swf_url:"../flash/Moxie.swf",xap_url:"../silverlight/Moxie.xap",global_event_dispatcher:"moxie.core.EventTarget.instance.dispatchEvent"};return e0});eZ("moxie/core/utils/Dom",["moxie/core/utils/Env"],function(e1){var e2=function(e8){if(typeof e8!=="string"){return e8}return document.getElementById(e8)};var e3=function(fa,e9){var e8;if(fa.className===""){return false}e8=new RegExp("(^|\\s+)"+e9+"(\\s+|$)");return e8.test(fa.className)};var e4=function(e9,e8){if(!e3(e9,e8)){e9.className=e9.className===""?e8:e9.className.replace(/\s+$/,"")+" "+e8}};var e7=function(fa,e9){var e8=new RegExp("(^|\\s+)"+e9+"(\\s+|$)");fa.className=fa.className.replace(e8,function(fc,fb,fd){return fb===" "&&fd===" "?" ":""})};var e0=function(e9,e8){if(e9.currentStyle){return e9.currentStyle[e8]}else{if(window.getComputedStyle){return window.getComputedStyle(e9,null)[e8]}}};var e6=function(e9,fd){var fe=0,fc=0,fg,ff=document,fa,fb;e9=e9;fd=fd||ff.body;function e8(fk){var fi,fj,fh=0,fl=0;if(fk){fj=fk.getBoundingClientRect();fi=ff.compatMode==="CSS1Compat"?ff.documentElement:ff.body;fh=fj.left+fi.scrollLeft;fl=fj.top+fi.scrollTop}return{x:fh,y:fl}}if(e9&&e9.getBoundingClientRect&&e1.browser==="IE"&&(!ff.documentMode||ff.documentMode<8)){fa=e8(e9);fb=e8(fd);return{x:fa.x-fb.x,y:fa.y-fb.y}}fg=e9;while(fg&&fg!=fd&&fg.nodeType){fe+=fg.offsetLeft||0;fc+=fg.offsetTop||0;fg=fg.offsetParent}fg=e9.parentNode;while(fg&&fg!=fd&&fg.nodeType){fe-=fg.scrollLeft||0;fc-=fg.scrollTop||0;fg=fg.parentNode}return{x:fe,y:fc}};var e5=function(e8){return{w:e8.offsetWidth||e8.clientWidth,h:e8.offsetHeight||e8.clientHeight}};return{get:e2,hasClass:e3,addClass:e4,removeClass:e7,getStyle:e0,getPos:e6,getSize:e5}});eZ("moxie/core/Exceptions",["moxie/core/utils/Basic"],function(e1){function e0(e4,e3){var e2;for(e2 in e4){if(e4[e2]===e3){return e2}}return null}return{RuntimeError:(function(){var e2={NOT_INIT_ERR:1,NOT_SUPPORTED_ERR:9,JS_ERR:4};function e3(e4){this.code=e4;this.name=e0(e2,e4);this.message=this.name+": RuntimeError "+this.code}e1.extend(e3,e2);e3.prototype=Error.prototype;return e3}()),OperationNotAllowedException:(function(){function e2(e3){this.code=e3;this.name="OperationNotAllowedException"}e1.extend(e2,{NOT_ALLOWED_ERR:1});e2.prototype=Error.prototype;return e2}()),ImageError:(function(){var e2={WRONG_FORMAT:1,MAX_RESOLUTION_ERR:2};function e3(e4){this.code=e4;this.name=e0(e2,e4);this.message=this.name+": ImageError "+this.code}e1.extend(e3,e2);e3.prototype=Error.prototype;return e3}()),FileException:(function(){var e2={NOT_FOUND_ERR:1,SECURITY_ERR:2,ABORT_ERR:3,NOT_READABLE_ERR:4,ENCODING_ERR:5,NO_MODIFICATION_ALLOWED_ERR:6,INVALID_STATE_ERR:7,SYNTAX_ERR:8};function e3(e4){this.code=e4;this.name=e0(e2,e4);this.message=this.name+": FileException "+this.code}e1.extend(e3,e2);e3.prototype=Error.prototype;return e3}()),DOMException:(function(){var e2={INDEX_SIZE_ERR:1,DOMSTRING_SIZE_ERR:2,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,INVALID_CHARACTER_ERR:5,NO_DATA_ALLOWED_ERR:6,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INUSE_ATTRIBUTE_ERR:10,INVALID_STATE_ERR:11,SYNTAX_ERR:12,INVALID_MODIFICATION_ERR:13,NAMESPACE_ERR:14,INVALID_ACCESS_ERR:15,VALIDATION_ERR:16,TYPE_MISMATCH_ERR:17,SECURITY_ERR:18,NETWORK_ERR:19,ABORT_ERR:20,URL_MISMATCH_ERR:21,QUOTA_EXCEEDED_ERR:22,TIMEOUT_ERR:23,INVALID_NODE_TYPE_ERR:24,DATA_CLONE_ERR:25};function e3(e4){this.code=e4;this.name=e0(e2,e4);this.message=this.name+": DOMException "+this.code}e1.extend(e3,e2);e3.prototype=Error.prototype;return e3}()),EventException:(function(){function e2(e3){this.code=e3;this.name="EventException"}e1.extend(e2,{UNSPECIFIED_EVENT_TYPE_ERR:0});e2.prototype=Error.prototype;return e2}())}});eZ("moxie/core/EventTarget",["moxie/core/Exceptions","moxie/core/utils/Basic"],function(e0,e1){function e2(){var e3={};e1.extend(this,{uid:null,init:function(){if(!this.uid){this.uid=e1.guid("uid_")}},addEventListener:function(e8,e7,e5,e6){var e4=this,e9;e8=e1.trim(e8);if(/\s/.test(e8)){e1.each(e8.split(/\s+/),function(fa){e4.addEventListener(fa,e7,e5,e6)});return}e8=e8.toLowerCase();e5=parseInt(e5,10)||0;e9=e3[this.uid]&&e3[this.uid][e8]||[];e9.push({fn:e7,priority:e5,scope:e6||this});if(!e3[this.uid]){e3[this.uid]={}}e3[this.uid][e8]=e9},hasEventListener:function(e4){return e4?!!(e3[this.uid]&&e3[this.uid][e4]):!!e3[this.uid]},removeEventListener:function(e6,e5){e6=e6.toLowerCase();var e7=e3[this.uid]&&e3[this.uid][e6],e4;if(e7){if(e5){for(e4=e7.length-1;e4>=0;e4--){if(e7[e4].fn===e5){e7.splice(e4,1);break}}}else{e7=[]}if(!e7.length){delete e3[this.uid][e6];if(e1.isEmptyObj(e3[this.uid])){delete e3[this.uid]}}}},removeAllEventListeners:function(){if(e3[this.uid]){delete e3[this.uid]}},dispatchEvent:function(fa){var e9,fb,e8,e7,e6={},e5=true;if(e1.typeOf(fa)!=="string"){e7=fa;if(e1.typeOf(e7.type)==="string"){fa=e7.type;if(e7.total&&e7.loaded){e6.total=e7.total;e6.loaded=e7.loaded}e6.async=e7.async||false}else{throw new e0.EventException(e0.EventException.UNSPECIFIED_EVENT_TYPE_ERR)}}if(fa.indexOf("::")!==-1){(function(fc){e9=fc[0];fa=fc[1]}(fa.split("::")))}else{e9=this.uid}fa=fa.toLowerCase();fb=e3[e9]&&e3[e9][fa];if(fb){fb.sort(function(fd,fc){return fc.priority-fd.priority});e8=[].slice.call(arguments);e8.shift();e6.type=fa;e8.unshift(e6);var e4=[];e1.each(fb,function(fc){e8[0].target=fc.scope;if(e6.async){e4.push(function(fd){setTimeout(function(){fd(fc.fn.apply(fc.scope,e8)===false)},1)})}else{e4.push(function(fd){fd(fc.fn.apply(fc.scope,e8)===false)})}});if(e4.length){e1.inSeries(e4,function(fc){e5=!fc})}}return e5},bind:function(){this.addEventListener.apply(this,arguments)},unbind:function(){this.removeEventListener.apply(this,arguments)},unbindAll:function(){this.removeAllEventListeners.apply(this,arguments)},trigger:function(){return this.dispatchEvent.apply(this,arguments)},convertEventPropsToHandlers:function(e4){var e6;if(e1.typeOf(e4)!=="array"){e4=[e4]}for(var e5=0;e5<e4.length;e5++){e6="on"+e4[e5];if(e1.typeOf(this[e6])==="function"){this.addEventListener(e4[e5],this[e6])}else{if(e1.typeOf(this[e6])==="undefined"){this[e6]=null}}}}})}e2.instance=new e2();return e2});eZ("moxie/core/utils/Encode",[],function(){var e2=function(e4){return unescape(encodeURIComponent(e4))};var e3=function(e4){return decodeURIComponent(escape(e4))};var e1=function(fb,fg){if(typeof(window.atob)==="function"){return fg?e3(window.atob(fb)):window.atob(fb)}var e7="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var e6,e5,e4,ff,fe,fd,fc,fh,fa=0,fi=0,e8="",e9=[];if(!fb){return fb}fb+="";do{ff=e7.indexOf(fb.charAt(fa++));fe=e7.indexOf(fb.charAt(fa++));fd=e7.indexOf(fb.charAt(fa++));fc=e7.indexOf(fb.charAt(fa++));fh=ff<<18|fe<<12|fd<<6|fc;e6=fh>>16&255;e5=fh>>8&255;e4=fh&255;if(fd==64){e9[fi++]=String.fromCharCode(e6)}else{if(fc==64){e9[fi++]=String.fromCharCode(e6,e5)}else{e9[fi++]=String.fromCharCode(e6,e5,e4)}}}while(fa<fb.length);e8=e9.join("");return fg?e3(e8):e8};var e0=function(fc,fh){if(fh){e2(fc)}if(typeof(window.btoa)==="function"){return window.btoa(fc)}var e8="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var e7,e6,e5,fg,ff,fe,fd,fi,fb=0,fj=0,fa="",e9=[];if(!fc){return fc}do{e7=fc.charCodeAt(fb++);e6=fc.charCodeAt(fb++);e5=fc.charCodeAt(fb++);fi=e7<<16|e6<<8|e5;fg=fi>>18&63;ff=fi>>12&63;fe=fi>>6&63;fd=fi&63;e9[fj++]=e8.charAt(fg)+e8.charAt(ff)+e8.charAt(fe)+e8.charAt(fd)}while(fb<fc.length);fa=e9.join("");var e4=fc.length%3;return(e4?fa.slice(0,e4-3):fa)+"===".slice(e4||3)};return{utf8_encode:e2,utf8_decode:e3,atob:e1,btoa:e0}});eZ("moxie/runtime/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/EventTarget"],function(e4,e3,e5){var e0={},e1={};function e2(fe,fb,e9,e7,fa){var fd=this,e6,fc=e4.guid(fb+"_");function e8(ff,fg){var fi=null,fh=fe&&fe.required_caps;fg=fg||"browser";if(this.mode!==null){return this.mode}if(fh&&!e4.isEmptyObj(ff)){e4.each(fh,function(fl,fj){if(ff.hasOwnProperty(fj)){var fk=ff[fj](fl);if(typeof(fk)==="string"){fk=[fk]}if(!fi){fi=fk}else{if(!(fi=e4.arrayIntersect(fi,fk))){return(fi=false)}}}});if(fi){this.mode=e4.inArray(fg,fi)!==-1?fg:fi[0]}else{if(fi===false){this.mode=false}}}if(this.mode===null){this.mode=fg}if(this.mode&&fh&&!this.can(fh)){this.mode=false}}e1[fc]=this;e9=e4.extend({access_binary:false,access_image_binary:false,display_media:false,do_cors:false,drag_and_drop:false,filter_by_extension:true,resize_image:false,report_upload_progress:false,return_response_headers:false,return_response_type:false,return_status_code:true,send_custom_headers:false,select_file:false,select_folder:false,select_multiple:true,send_binary_string:false,send_browser_cookies:true,send_multipart:true,slice_blob:false,stream_upload:false,summon_file_dialog:false,upload_filesize:true,use_http_method:true},e9);e6=(function(){var ff={};return{exec:function(fi,fg,fj,fh){if(e6[fg]){if(!ff[fi]){ff[fi]={context:this,instance:new e6[fg]()}}if(ff[fi].instance[fj]){return ff[fi].instance[fj].apply(this,fh)}}},removeInstance:function(fg){delete ff[fg]},removeAllInstances:function(){var fg=this;e4.each(ff,function(fi,fh){if(e4.typeOf(fi.instance.destroy)==="function"){fi.instance.destroy.call(fi.context)}fg.removeInstance(fh)})}}}());e4.extend(this,{initialized:false,uid:fc,type:fb,mode:null,shimid:fc+"_container",clients:0,options:fe,can:function(fh,fi){var ff=arguments[2]||e9;if(e4.typeOf(fh)==="string"&&e4.typeOf(fi)==="undefined"){fh=e2.parseCaps(fh)}if(e4.typeOf(fh)==="object"){for(var fg in fh){if(!this.can(fg,fh[fg],ff)){return false}}return true}if(e4.typeOf(ff[fh])==="function"){return ff[fh].call(this,fi)}else{return(fi===ff[fh])}},getShimContainer:function(){var ff,fg=e3.get(this.shimid);if(!fg){ff=this.options.container?e3.get(this.options.container):document.body;fg=document.createElement("div");fg.id=this.shimid;fg.className="moxie-shim moxie-shim-"+this.type;e4.extend(fg.style,{position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"});ff.appendChild(fg);ff=null}return fg},getShim:function(){return e6},shimExec:function(fg,fh){var ff=[].slice.call(arguments,2);return fd.getShim().exec.call(this,this.uid,fg,fh,ff)},exec:function(fg,fh){var ff=[].slice.call(arguments,2);if(fd[fg]&&fd[fg][fh]){return fd[fg][fh].apply(this,ff)}return fd.shimExec.apply(this,arguments)},destroy:function(){if(!fd){return}var ff=e3.get(this.shimid);if(ff){ff.parentNode.removeChild(ff)}if(e6){e6.removeAllInstances()}this.unbindAll();delete e1[this.uid];this.uid=null;fc=fd=e6=ff=null}});e8.call(this,e7,fa)}e2.order="html5,flash,silverlight,html4";e2.getRuntime=function(e6){return e1[e6]?e1[e6]:false};e2.addConstructor=function(e7,e6){e6.prototype=e5.instance;e0[e7]=e6};e2.getConstructor=function(e6){return e0[e6]||null};e2.getInfo=function(e6){var e7=e2.getRuntime(e6);if(e7){return{uid:e7.uid,type:e7.type,can:function(){return e7.can.apply(e7,arguments)}}}return null};e2.parseCaps=function(e6){var e7={};if(e4.typeOf(e6)!=="string"){return e6||{}}e4.each(e6.split(","),function(e8){e7[e8]=true});return e7};e2.can=function(e7,e9){var e8,e6=e2.getConstructor(e7),fa;if(e6){e8=new e6({required_caps:e9});fa=e8.mode;e8.destroy();return !!fa}return false};e2.thatCan=function(e8,e9){var e7=(e9||e2.order).split(/\s*,\s*/);for(var e6 in e7){if(e2.can(e7[e6],e8)){return e7[e6]}}return null};e2.capTrue=function(){return true};e2.capFalse=function(){return false};e2.capTest=function(e6){return function(){return !!e6}};return e2});eZ("moxie/runtime/RuntimeClient",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/Runtime"],function(e0,e3,e2){return function e1(){var e4;e3.extend(this,{connectRuntime:function(e8){var e6=this,e7;function e5(e9){var fb,fa;if(!e9.length){e6.trigger("RuntimeError",new e0.RuntimeError(e0.RuntimeError.NOT_INIT_ERR));e4=null;return}fb=e9.shift();fa=e2.getConstructor(fb);if(!fa){e5(e9);return}e4=new fa(e8);e4.bind("Init",function(){e4.initialized=true;setTimeout(function(){e4.clients++;e6.trigger("RuntimeInit",e4)},1)});e4.bind("Error",function(){e4.destroy();e5(e9)});if(!e4.mode){e4.trigger("Error");return}e4.init()}if(e3.typeOf(e8)==="string"){e7=e8}else{if(e3.typeOf(e8.ruid)==="string"){e7=e8.ruid}}if(e7){e4=e2.getRuntime(e7);if(e4){e4.clients++;return e4}else{throw new e0.RuntimeError(e0.RuntimeError.NOT_INIT_ERR)}}e5((e8.runtime_order||e2.order).split(/\s*,\s*/))},getRuntime:function(){if(e4&&e4.uid){return e4}e4=null;return null},disconnectRuntime:function(){if(e4&&--e4.clients<=0){e4.destroy();e4=null}}})}});eZ("moxie/file/Blob",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient"],function(e3,e1,e2){var e0={};function e4(e7,e6){function e5(fc,e8,fa){var e9,fb=e0[this.uid];if(e3.typeOf(fb)!=="string"||!fb.length){return null}e9=new e4(null,{type:fa,size:e8-fc});e9.detach(fb.substr(fc,e9.size));return e9}e2.call(this);if(e7){this.connectRuntime(e7)}if(!e6){e6={}}else{if(e3.typeOf(e6)==="string"){e6={data:e6}}}e3.extend(this,{uid:e6.uid||e3.guid("uid_"),ruid:e7,size:e6.size||0,type:e6.type||"",slice:function(fa,e8,e9){if(this.isDetached()){return e5.apply(this,arguments)}return this.getRuntime().exec.call(this,"Blob","slice",this.getSource(),fa,e8,e9)},getSource:function(){if(!e0[this.uid]){return null}return e0[this.uid]},detach:function(e9){if(this.ruid){this.getRuntime().exec.call(this,"Blob","destroy",e0[this.uid]);this.disconnectRuntime();this.ruid=null}e9=e9||"";var e8=e9.match(/^data:([^;]*);base64,/);if(e8){this.type=e8[1];e9=e1.atob(e9.substring(e9.indexOf("base64,")+7))}this.size=e9.length;e0[this.uid]=e9},isDetached:function(){return !this.ruid&&e3.typeOf(e0[this.uid])==="string"},destroy:function(){this.detach();delete e0[this.uid]}});if(e6.data){this.detach(e6.data)}else{e0[this.uid]=e6}}return e4});eZ("moxie/file/File",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/file/Blob"],function(e2,e1,e3){function e0(e5,e6){var e4,e7;if(!e6){e6={}}if(e6.type&&e6.type!==""){e7=e6.type}else{e7=e1.getFileMime(e6.name)}if(e6.name){e4=e6.name.replace(/\\/g,"/");e4=e4.substr(e4.lastIndexOf("/")+1)}else{var e8=e7.split("/")[0];e4=e2.guid((e8!==""?e8:"file")+"_");if(e1.extensions[e7]){e4+="."+e1.extensions[e7][0]}}e3.apply(this,arguments);e2.extend(this,{type:e7||"",name:e4||e2.guid("file_"),lastModifiedDate:e6.lastModifiedDate||(new Date()).toLocaleString()})}e0.prototype=e3.prototype;return e0});eZ("moxie/file/FileInput",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/I18n","moxie/file/File","moxie/runtime/Runtime","moxie/runtime/RuntimeClient"],function(e1,e4,e3,e8,fa,e2,e6,e0,e7){var e9=["ready","change","cancel","mouseenter","mouseleave","mousedown","mouseup"];function e5(fe){var fc=this,fb,fd,ff;if(e1.inArray(e1.typeOf(fe),["string","node"])!==-1){fe={browse_button:fe}}fd=e3.get(fe.browse_button);if(!fd){throw new e8.DOMException(e8.DOMException.NOT_FOUND_ERR)}ff={accept:[{title:e2.translate("All Files"),extensions:"*"}],name:"file",multiple:false,required_caps:false,container:fd.parentNode||document.body};fe=e1.extend({},ff,fe);if(typeof(fe.required_caps)==="string"){fe.required_caps=e0.parseCaps(fe.required_caps)}if(typeof(fe.accept)==="string"){fe.accept=e4.mimes2extList(fe.accept)}fb=e3.get(fe.container);if(!fb){fb=document.body}if(e3.getStyle(fb,"position")==="static"){fb.style.position="relative"}fb=fd=null;e7.call(fc);e1.extend(fc,{uid:e1.guid("uid_"),ruid:null,files:null,init:function(){fc.convertEventPropsToHandlers(e9);fc.bind("RuntimeInit",function(fh,fg){fc.ruid=fg.uid;fc.bind("Ready",function(){fc.trigger("Refresh")},999);fc.bind("Change",function(){var fi=fg.exec.call(fc,"FileInput","getFiles");fc.files=[];e1.each(fi,function(fj){if(fj.size===0){return true}fc.files.push(new e6(fc.ruid,fj))})},999);fc.bind("Refresh",function(){var fl,fk,fj,fi;fj=e3.get(fe.browse_button);fi=e3.get(fg.shimid);if(fj){fl=e3.getPos(fj,e3.get(fe.container));fk=e3.getSize(fj);if(fi){e1.extend(fi.style,{top:fl.y+"px",left:fl.x+"px",width:fk.w+"px",height:fk.h+"px"})}}fi=fj=null});fg.exec.call(fc,"FileInput","init",fe)});fc.connectRuntime(e1.extend({},fe,{required_caps:{select_file:true}}))},disable:function(fh){var fg=this.getRuntime();if(fg){fg.exec.call(this,"FileInput","disable",e1.typeOf(fh)==="undefined"?true:fh)}},refresh:function(){fc.trigger("Refresh")},destroy:function(){var fg=this.getRuntime();if(fg){fg.exec.call(this,"FileInput","destroy");this.disconnectRuntime()}if(e1.typeOf(this.files)==="array"){e1.each(this.files,function(fh){fh.destroy()})}this.files=null}})}e5.prototype=fa.instance;return e5});eZ("moxie/file/FileDrop",["moxie/core/I18n","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/File","moxie/runtime/RuntimeClient","moxie/core/EventTarget","moxie/core/utils/Mime"],function(e2,e3,e7,e0,e5,e6,e9,e4){var e8=["ready","dragenter","dragleave","drop","error"];function e1(fb){var fa=this,fc;if(typeof(fb)==="string"){fb={drop_zone:fb}}fc={accept:[{title:e2.translate("All Files"),extensions:"*"}],required_caps:{drag_and_drop:true}};fb=typeof(fb)==="object"?e0.extend({},fc,fb):fc;fb.container=e3.get(fb.drop_zone)||document.body;if(e3.getStyle(fb.container,"position")==="static"){fb.container.style.position="relative"}if(typeof(fb.accept)==="string"){fb.accept=e4.mimes2extList(fb.accept)}e6.call(fa);e0.extend(fa,{uid:e0.guid("uid_"),ruid:null,files:null,init:function(){fa.convertEventPropsToHandlers(e8);fa.bind("RuntimeInit",function(fe,fd){fa.ruid=fd.uid;fa.bind("Drop",function(){var ff=fd.exec.call(fa,"FileDrop","getFiles");fa.files=[];e0.each(ff,function(fg){fa.files.push(new e5(fa.ruid,fg))})},999);fd.exec.call(fa,"FileDrop","init",fb);fa.dispatchEvent("ready")});fa.connectRuntime(fb)},destroy:function(){var fd=this.getRuntime();if(fd){fd.exec.call(this,"FileDrop","destroy");this.disconnectRuntime()}this.files=null}})}e1.prototype=e9.instance;return e1});eZ("moxie/runtime/RuntimeTarget",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(e2,e1,e3){function e0(){this.uid=e2.guid("uid_");e1.call(this);this.destroy=function(){this.disconnectRuntime();this.unbindAll()}}e0.prototype=e3.instance;return e0});eZ("moxie/file/FileReader",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/core/Exceptions","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/runtime/RuntimeTarget"],function(e0,e4,e6,e8,e3,e5,e2){var e7=["loadstart","progress","load","abort","error","loadend"];function e1(){var e9=this,fb;e0.extend(this,{uid:e0.guid("uid_"),readyState:e1.EMPTY,result:null,error:null,readAsBinaryString:function(fc){fa.call(this,"readAsBinaryString",fc)},readAsDataURL:function(fc){fa.call(this,"readAsDataURL",fc)},readAsText:function(fc){fa.call(this,"readAsText",fc)},abort:function(){this.result=null;if(e0.inArray(this.readyState,[e1.EMPTY,e1.DONE])!==-1){return}else{if(this.readyState===e1.LOADING){this.readyState=e1.DONE}}if(fb){fb.getRuntime().exec.call(this,"FileReader","abort")}this.trigger("abort");this.trigger("loadend")},destroy:function(){this.abort();if(fb){fb.getRuntime().exec.call(this,"FileReader","destroy");fb.disconnectRuntime()}e9=fb=null}});function fa(fh,fd){fb=new e2();function ff(fi){e9.readyState=e1.DONE;e9.error=fi;e9.trigger("error");fe()}function fe(){fb.destroy();fb=null;e9.trigger("loadend")}function fc(fi){fb.bind("Error",function(fk,fj){ff(fj)});fb.bind("Progress",function(fj){e9.result=fi.exec.call(fb,"FileReader","getResult");e9.trigger(fj)});fb.bind("Load",function(fj){e9.readyState=e1.DONE;e9.result=fi.exec.call(fb,"FileReader","getResult");e9.trigger(fj);fe()});fi.exec.call(fb,"FileReader","read",fh,fd)}this.convertEventPropsToHandlers(e7);if(this.readyState===e1.LOADING){return ff(new e6.DOMException(e6.DOMException.INVALID_STATE_ERR))}this.readyState=e1.LOADING;this.trigger("loadstart");if(fd instanceof e3){if(fd.isDetached()){var fg=fd.getSource();switch(fh){case"readAsText":case"readAsBinaryString":this.result=fg;break;case"readAsDataURL":this.result="data:"+fd.type+";base64,"+e4.btoa(fg);break}this.readyState=e1.DONE;this.trigger("load");fe()}else{fc(fb.connectRuntime(fd.ruid))}}else{ff(new e6.DOMException(e6.DOMException.NOT_FOUND_ERR))}}}e1.EMPTY=0;e1.LOADING=1;e1.DONE=2;e1.prototype=e8.instance;return e1});eZ("moxie/core/utils/Url",[],function(){var e0=function(e9){var e5=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],e4=e5.length,fa={http:80,https:443},e7={},e6=/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\\?([^#]*))?(?:#(.*))?)/,e3=e6.exec(e9||"");while(e4--){if(e3[e4]){e7[e5[e4]]=e3[e4]}}if(/^[^\/]/.test(e7.path)&&!e7.scheme){var e8=document.location.pathname;if(!/(\/|\/[^\.]+)$/.test(e8)){e8=e8.replace(/[^\/]+$/,"")}e7.host=document.location.hostname;e7.path=e8+(e7.path||"")}if(!e7.scheme){e7.scheme=document.location.protocol.replace(/:$/,"")}if(!e7.host){e7.host=document.location.hostname}if(!e7.port){e7.port=document.location.port||fa[e7.scheme]||80}e7.port=parseInt(e7.port,10);if(!e7.path){e7.path="/"}delete e7.source;return e7};var e2=function(e4){var e5={http:80,https:443},e3=e0(e4);return e3.scheme+"://"+e3.host+(e3.port!==e5[e3.scheme]?":"+e3.port:"")+e3.path+(e3.query?e3.query:"")};var e1=function(e4){function e3(e5){return[e5.scheme,e5.host,e5.port].join("/")}if(typeof e4==="string"){e4=e0(e4)}return e3(e0())===e3(e4)};return{parseUrl:e0,resolveUrl:e2,hasSameOrigin:e1}});eZ("moxie/file/FileReaderSync",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/utils/Encode"],function(e2,e1,e0){return function(){e1.call(this);e2.extend(this,{uid:e2.guid("uid_"),readAsBinaryString:function(e4){return e3.call(this,"readAsBinaryString",e4)},readAsDataURL:function(e4){return e3.call(this,"readAsDataURL",e4)},readAsText:function(e4){return e3.call(this,"readAsText",e4)}});function e3(fa,e6){if(e6.isDetached()){var e9=e6.getSource();switch(fa){case"readAsBinaryString":return e9;case"readAsDataURL":return"data:"+e6.type+";base64,"+e0.btoa(e9);case"readAsText":var e5="";for(var e7=0,e8=e9.length;e7<e8;e7++){e5+=String.fromCharCode(e9[e7])}return e5}}else{var e4=this.connectRuntime(e6.ruid).exec.call(this,"FileReaderSync","read",fa,e6);this.disconnectRuntime();return e4}}}});eZ("moxie/xhr/FormData",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/Blob"],function(e0,e1,e3){function e2(){var e5,e6={},e4="";e1.extend(this,{append:function(e8,e9){var e7=this,fa=e1.typeOf(e9);if(e9 instanceof e3){if(e5){delete e6[e5]}e5=e8;e6[e8]=[e9]}else{if("array"===fa){e8+="[]";e1.each(e9,function(fb){e7.append.call(e7,e8,fb)})}else{if("object"===fa){e1.each(e9,function(fc,fb){e7.append.call(e7,e8+"["+fb+"]",fc)})}else{e9=e9.toString();if(!e6[e8]){e6[e8]=[]}e6[e8].push(e9)}}}},hasBlob:function(){return !!e5},getBlob:function(){return e6[e5]&&e6[e5][0]||null},getBlobName:function(){return e5||null},each:function(e7){e1.each(e6,function(e9,e8){e1.each(e9,function(fa){e7(fa,e8)})})},destroy:function(){e5=null;e4="";e6={}}})}return e2});eZ("moxie/xhr/XMLHttpRequest",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/core/utils/Url","moxie/runtime/Runtime","moxie/runtime/RuntimeTarget","moxie/file/Blob","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/core/utils/Env","moxie/core/utils/Mime"],function(e8,e9,e7,ff,fc,e6,fa,e5,fe,fg,e0,fb){var e1={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Reserved",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",426:"Upgrade Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",510:"Not Extended"};function e4(){this.uid=e8.guid("uid_")}e4.prototype=e7.instance;var e3=["loadstart","progress","abort","error","load","timeout","loadend"];var e2=1,fh=2;function fd(){var fz=this,fm={timeout:0,readyState:fd.UNSENT,withCredentials:false,status:0,statusText:"",responseType:"",responseXML:null,responseText:null,response:null},fF=true,fr,fx,fy={},fA,fo,fq=null,fs=null,fI=false,fj=false,fi=false,ft=false,fl=false,fp=false,fv,fE,fD=null,fG=null,fB={},fw,fC="",fk;e8.extend(this,fm,{uid:e8.guid("uid_"),upload:new e4(),open:function(fO,fM,fN,fK,fL){var fJ;if(!fO||!fM){throw new e9.DOMException(e9.DOMException.SYNTAX_ERR)}if(/[\u0100-\uffff]/.test(fO)||ff.utf8_encode(fO)!==fO){throw new e9.DOMException(e9.DOMException.SYNTAX_ERR)}if(!!~e8.inArray(fO.toUpperCase(),["CONNECT","DELETE","GET","HEAD","OPTIONS","POST","PUT","TRACE","TRACK"])){fx=fO.toUpperCase()}if(!!~e8.inArray(fx,["CONNECT","TRACE","TRACK"])){throw new e9.DOMException(e9.DOMException.SECURITY_ERR)}fM=ff.utf8_encode(fM);fJ=fc.parseUrl(fM);fp=fc.hasSameOrigin(fJ);fr=fc.resolveUrl(fM);if((fK||fL)&&!fp){throw new e9.DOMException(e9.DOMException.INVALID_ACCESS_ERR)}fA=fK||fJ.user;fo=fL||fJ.pass;fF=fN||true;if(fF===false&&(fH("timeout")||fH("withCredentials")||fH("responseType")!=="")){throw new e9.DOMException(e9.DOMException.INVALID_ACCESS_ERR)}fI=!fF;fj=false;fy={};fu.call(this);fH("readyState",fd.OPENED);this.convertEventPropsToHandlers(["readystatechange"]);this.dispatchEvent("readystatechange")},setRequestHeader:function(fL,fK){var fJ=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","content-transfer-encoding","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","user-agent","via"];if(fH("readyState")!==fd.OPENED||fj){throw new e9.DOMException(e9.DOMException.INVALID_STATE_ERR)}if(/[\u0100-\uffff]/.test(fL)||ff.utf8_encode(fL)!==fL){throw new e9.DOMException(e9.DOMException.SYNTAX_ERR)}fL=e8.trim(fL).toLowerCase();if(!!~e8.inArray(fL,fJ)||/^(proxy\-|sec\-)/.test(fL)){return false}if(!fy[fL]){fy[fL]=fK}else{fy[fL]+=", "+fK}return true},getAllResponseHeaders:function(){return fC||""},getResponseHeader:function(fJ){fJ=fJ.toLowerCase();if(fl||!!~e8.inArray(fJ,["set-cookie","set-cookie2"])){return null}if(fC&&fC!==""){if(!fk){fk={};e8.each(fC.split(/\r\n/),function(fK){var fL=fK.split(/:\s+/);if(fL.length===2){fL[0]=e8.trim(fL[0]);fk[fL[0].toLowerCase()]={header:fL[0],value:e8.trim(fL[1])}}})}if(fk.hasOwnProperty(fJ)){return fk[fJ].header+": "+fk[fJ].value}}return null},overrideMimeType:function(fK){var fJ,fL;if(!!~e8.inArray(fH("readyState"),[fd.LOADING,fd.DONE])){throw new e9.DOMException(e9.DOMException.INVALID_STATE_ERR)}fK=e8.trim(fK.toLowerCase());if(/;/.test(fK)&&(fJ=fK.match(/^([^;]+)(?:;\scharset\=)?(.*)$/))){fK=fJ[1];if(fJ[2]){fL=fJ[2]}}if(!fb.mimes[fK]){throw new e9.DOMException(e9.DOMException.SYNTAX_ERR)}fD=fK;fG=fL},send:function(fL,fK){if(e8.typeOf(fK)==="string"){fB={ruid:fK}}else{if(!fK){fB={}}else{fB=fK}}this.convertEventPropsToHandlers(e3);this.upload.convertEventPropsToHandlers(e3);if(this.readyState!==fd.OPENED||fj){throw new e9.DOMException(e9.DOMException.INVALID_STATE_ERR)}if(fL instanceof e5){fB.ruid=fL.ruid;fs=fL.type||"application/octet-stream"}else{if(fL instanceof fg){if(fL.hasBlob()){var fJ=fL.getBlob();fB.ruid=fJ.ruid;fs=fJ.type||"application/octet-stream"}}else{if(typeof fL==="string"){fq="UTF-8";fs="text/plain;charset=UTF-8";fL=ff.utf8_encode(fL)}}}if(!this.withCredentials){this.withCredentials=(fB.required_caps&&fB.required_caps.send_browser_cookies)&&!fp}fi=(!fI&&this.upload.hasEventListener());fl=false;ft=!fL;if(!fI){fj=true;if(!ft){}}fn.call(this,fL)},abort:function(){fl=true;fI=false;if(!~e8.inArray(fH("readyState"),[fd.UNSENT,fd.OPENED,fd.DONE])){fH("readyState",fd.DONE);fj=false;if(fw){fw.getRuntime().exec.call(fw,"XMLHttpRequest","abort",ft)}else{throw new e9.DOMException(e9.DOMException.INVALID_STATE_ERR)}ft=true}else{fH("readyState",fd.UNSENT)}},destroy:function(){if(fw){if(e8.typeOf(fw.destroy)==="function"){fw.destroy()}fw=null}this.unbindAll();if(this.upload){this.upload.unbindAll();this.upload=null}}});function fH(fK,fJ){if(!fm.hasOwnProperty(fK)){return}if(arguments.length===1){return e0.can("define_property")?fm[fK]:fz[fK]}else{if(e0.can("define_property")){fm[fK]=fJ}else{fz[fK]=fJ}}}function fn(fM){var fK=this;fv=new Date().getTime();fw=new fa();function fL(){fw.destroy();fw=null;fK.dispatchEvent("loadend");fK=null}function fJ(fN){fw.bind("LoadStart",function(fO){fH("readyState",fd.LOADING);fK.dispatchEvent("readystatechange");fK.dispatchEvent(fO);if(fi){fK.upload.dispatchEvent(fO)}});fw.bind("Progress",function(fO){if(fH("readyState")!==fd.LOADING){fH("readyState",fd.LOADING);fK.dispatchEvent("readystatechange")}fK.dispatchEvent(fO)});fw.bind("UploadProgress",function(fO){if(fi){fK.upload.dispatchEvent({type:"progress",lengthComputable:false,total:fO.total,loaded:fO.loaded})}});fw.bind("Load",function(fO){fH("readyState",fd.DONE);fH("status",Number(fN.exec.call(fw,"XMLHttpRequest","getStatus")||0));fH("statusText",e1[fH("status")]||"");fH("response",fN.exec.call(fw,"XMLHttpRequest","getResponse",fH("responseType")));if(!!~e8.inArray(fH("responseType"),["text",""])){fH("responseText",fH("response"))}else{if(fH("responseType")==="document"){fH("responseXML",fH("response"))}}fC=fN.exec.call(fw,"XMLHttpRequest","getAllResponseHeaders");fK.dispatchEvent("readystatechange");if(fH("status")>0){if(fi){fK.upload.dispatchEvent(fO)}fK.dispatchEvent(fO)}else{fl=true;fK.dispatchEvent("error")}fL()});fw.bind("Abort",function(fO){fK.dispatchEvent(fO);fL()});fw.bind("Error",function(fO){fl=true;fH("readyState",fd.DONE);fK.dispatchEvent("readystatechange");ft=true;fK.dispatchEvent(fO);fL()});fN.exec.call(fw,"XMLHttpRequest","send",{url:fr,method:fx,async:fF,user:fA,password:fo,headers:fy,mimeType:fs,encoding:fq,responseType:fK.responseType,withCredentials:fK.withCredentials,options:fB},fM)}if(typeof(fB.required_caps)==="string"){fB.required_caps=e6.parseCaps(fB.required_caps)}fB.required_caps=e8.extend({},fB.required_caps,{return_response_type:fK.responseType});if(fM instanceof fg){fB.required_caps.send_multipart=true}if(!fp){fB.required_caps.do_cors=true}if(fB.ruid){fJ(fw.connectRuntime(fB))}else{fw.bind("RuntimeInit",function(fO,fN){fJ(fN)});fw.bind("RuntimeError",function(fO,fN){fK.dispatchEvent("RuntimeError",fN)});fw.connectRuntime(fB)}}function fu(){fH("responseText","");fH("responseXML",null);fH("response",null);fH("status",0);fH("statusText","");fv=fE=null}}fd.UNSENT=0;fd.OPENED=1;fd.HEADERS_RECEIVED=2;fd.LOADING=3;fd.DONE=4;fd.prototype=e7.instance;return fd});eZ("moxie/runtime/Transporter",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(e3,e0,e1,e4){function e2(){var e9,e7,e5,fa,fd,fc;e1.call(this);e3.extend(this,{uid:e3.guid("uid_"),state:e2.IDLE,result:null,transport:function(fi,fh,fg){var ff=this;fg=e3.extend({chunk_size:204798},fg);if((e9=fg.chunk_size%3)){fg.chunk_size+=3-e9}fc=fg.chunk_size;fb.call(this);e5=fi;fa=fi.length;if(e3.typeOf(fg)==="string"||fg.ruid){e8.call(ff,fh,this.connectRuntime(fg))}else{var fe=function(fk,fj){ff.unbind("RuntimeInit",fe);e8.call(ff,fh,fj)};this.bind("RuntimeInit",fe);this.connectRuntime(fg)}},abort:function(){var fe=this;fe.state=e2.IDLE;if(e7){e7.exec.call(fe,"Transporter","clear");fe.trigger("TransportingAborted")}fb.call(fe)},destroy:function(){this.unbindAll();e7=null;this.disconnectRuntime();fb.call(this)}});function fb(){fa=fd=0;e5=this.result=null}function e8(ff,fg){var fe=this;e7=fg;fe.bind("TransportingProgress",function(fh){fd=fh.loaded;if(fd<fa&&e3.inArray(fe.state,[e2.IDLE,e2.DONE])===-1){e6.call(fe)}},999);fe.bind("TransportingComplete",function(){fd=fa;fe.state=e2.DONE;e5=null;fe.result=e7.exec.call(fe,"Transporter","getAsBlob",ff||"")},999);fe.state=e2.BUSY;fe.trigger("TransportingStarted");e6.call(fe)}function e6(){var fe=this,ff,fg=fa-fd;if(fc>fg){fc=fg}ff=e0.btoa(e5.substr(fd,fc));e7.exec.call(fe,"Transporter","receive",ff,fa)}}e2.IDLE=0;e2.BUSY=1;e2.DONE=2;e2.prototype=e4.instance;return e2});eZ("moxie/core/JSON",[],function(){return !!window.JSON&&JSON.parse||(function(){var e3,e1,e0={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},fc,fa=function(fd){throw {name:"SyntaxError",message:fd,at:e3,text:fc}},e6=function(fd){if(fd&&fd!==e1){fa("Expected '"+fd+"' instead of '"+e1+"'")}e1=fc.charAt(e3);e3+=1;return e1},e5=function(){var fe,fd="";if(e1==="-"){fd="-";e6("-")}while(e1>="0"&&e1<="9"){fd+=e1;e6()}if(e1==="."){fd+=".";while(e6()&&e1>="0"&&e1<="9"){fd+=e1}}if(e1==="e"||e1==="E"){fd+=e1;e6();if(e1==="-"||e1==="+"){fd+=e1;e6()}while(e1>="0"&&e1<="9"){fd+=e1;e6()}}fe=+fd;if(!isFinite(fe)){fa("Bad number")}else{return fe}},e7=function(){var fg,ff,fe="",fd;if(e1==='"'){while(e6()){if(e1==='"'){e6();return fe}else{if(e1==="\\"){e6();if(e1==="u"){fd=0;for(ff=0;ff<4;ff+=1){fg=parseInt(e6(),16);if(!isFinite(fg)){break}fd=fd*16+fg}fe+=String.fromCharCode(fd)}else{if(typeof e0[e1]==="string"){fe+=e0[e1]}else{break}}}else{fe+=e1}}}}fa("Bad string")},e9=function(){while(e1&&e1<=" "){e6()}},e2=function(){switch(e1){case"t":e6("t");e6("r");e6("u");e6("e");return true;case"f":e6("f");e6("a");e6("l");e6("s");e6("e");return false;case"n":e6("n");e6("u");e6("l");e6("l");return null}fa("Unexpected '"+e1+"'")},fb,e8=function(){var fd=[];if(e1==="["){e6("[");e9();if(e1==="]"){e6("]");return fd}while(e1){fd.push(fb());e9();if(e1==="]"){e6("]");return fd}e6(",");e9()}}fa("Bad array")},e4=function(){var fe,fd={};if(e1==="{"){e6("{");e9();if(e1==="}"){e6("}");return fd}while(e1){fe=e7();e9();e6(":");if(Object.hasOwnProperty.call(fd,fe)){fa('Duplicate key "'+fe+'"')}fd[fe]=fb();e9();if(e1==="}"){e6("}");return fd}e6(",");e9()}}fa("Bad object")};fb=function(){e9();switch(e1){case"{":return e4();case"[":return e8();case'"':return e7();case"-":return e5();default:return e1>="0"&&e1<="9"?e5():e2()}};return function(fg,fe){var fd;fc=fg;e3=0;e1=" ";fd=fb();e9();if(e1){fa("Syntax error")}return typeof fe==="function"?(function ff(fk,fj){var fi,fh,fl=fk[fj];if(fl&&typeof fl==="object"){for(fi in fl){if(Object.prototype.hasOwnProperty.call(fl,fi)){fh=ff(fl,fi);if(fh!==eY){fl[fi]=fh}else{delete fl[fi]}}}}return fe.call(fk,fj,fl)}({"":fd},"")):fd}}())});eZ("moxie/image/Image",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/file/FileReaderSync","moxie/xhr/XMLHttpRequest","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/runtime/Transporter","moxie/core/utils/Env","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/core/utils/Encode","moxie/core/JSON"],function(e2,e6,fc,fa,fd,e1,fb,e5,e9,ff,e4,e8,e7,e3){var fe=["progress","load","error","resize","embedded"];function e0(){fb.call(this);e2.extend(this,{uid:e2.guid("uid_"),ruid:null,name:"",size:0,width:0,height:0,type:"",meta:{},clone:function(){this.load.apply(this,arguments)},load:function(){this.bind("Load Resize",function(){fh.call(this)},999);this.convertEventPropsToHandlers(fe);fi.apply(this,arguments)},downsize:function(fp,fl,fo,fm){try{if(!this.size){throw new fc.DOMException(fc.DOMException.INVALID_STATE_ERR)}if(this.width>e0.MAX_RESIZE_WIDTH||this.height>e0.MAX_RESIZE_HEIGHT){throw new fc.ImageError(fc.ImageError.MAX_RESOLUTION_ERR)}if(!fp&&!fl||e2.typeOf(fo)==="undefined"){fo=false}fp=fp||this.width;fl=fl||this.height;fm=(e2.typeOf(fm)==="undefined"?true:!!fm);this.getRuntime().exec.call(this,"Image","downsize",fp,fl,fo,fm)}catch(fn){this.trigger("error",fn)}},crop:function(fn,fl,fm){this.downsize(fn,fl,true,fm)},getAsCanvas:function(){if(!e9.can("create_canvas")){throw new fc.RuntimeError(fc.RuntimeError.NOT_SUPPORTED_ERR)}var fl=this.connectRuntime(this.ruid);return fl.exec.call(this,"Image","getAsCanvas")},getAsBlob:function(fl,fm){if(!this.size){throw new fc.DOMException(fc.DOMException.INVALID_STATE_ERR)}if(!fl){fl="image/jpeg"}if(fl==="image/jpeg"&&!fm){fm=90}return this.getRuntime().exec.call(this,"Image","getAsBlob",fl,fm)},getAsDataURL:function(fl,fm){if(!this.size){throw new fc.DOMException(fc.DOMException.INVALID_STATE_ERR)}return this.getRuntime().exec.call(this,"Image","getAsDataURL",fl,fm)},getAsBinaryString:function(fl,fn){var fm=this.getAsDataURL(fl,fn);return e7.atob(fm.substring(fm.indexOf("base64,")+7))},embed:function(fo){var fw=this,ft,fs,fu,fq,fx=arguments[1]||{},fn=this.width,fv=this.height,fp;function fm(){if(e9.can("create_canvas")){var fy=ft.getAsCanvas();if(fy){fo.appendChild(fy);fy=null;ft.destroy();fw.trigger("embedded");return}}var fA=ft.getAsDataURL(fs,fu);if(!fA){throw new fc.ImageError(fc.ImageError.WRONG_FORMAT)}if(e9.can("use_data_uri_of",fA.length)){fo.innerHTML='<img src="'+fA+'" width="'+ft.width+'" height="'+ft.height+'" />';ft.destroy();fw.trigger("embedded")}else{var fz=new e5();fz.bind("TransportingComplete",function(){fp=fw.connectRuntime(this.result.ruid);fw.bind("Embedded",function(){e2.extend(fp.getShimContainer().style,{top:"0px",left:"0px",width:ft.width+"px",height:ft.height+"px"});fp=null},999);fp.exec.call(fw,"ImageView","display",this.result.uid,fn,fv);ft.destroy()});fz.transport(e7.atob(fA.substring(fA.indexOf("base64,")+7)),fs,e2.extend({},fx,{required_caps:{display_media:true},runtime_order:"flash,silverlight",container:fo}))}}try{if(!(fo=e6.get(fo))){throw new fc.DOMException(fc.DOMException.INVALID_NODE_TYPE_ERR)}if(!this.size){throw new fc.DOMException(fc.DOMException.INVALID_STATE_ERR)}if(this.width>e0.MAX_RESIZE_WIDTH||this.height>e0.MAX_RESIZE_HEIGHT){throw new fc.ImageError(fc.ImageError.MAX_RESOLUTION_ERR)}fs=fx.type||this.type||"image/jpeg";fu=fx.quality||90;fq=e2.typeOf(fx.crop)!=="undefined"?fx.crop:false;if(fx.width){fn=fx.width;fv=fx.height||fn}else{var fl=e6.getSize(fo);if(fl.w&&fl.h){fn=fl.w;fv=fl.h}}ft=new e0();ft.bind("Resize",function(){fm.call(fw)});ft.bind("Load",function(){ft.downsize(fn,fv,fq,false)});ft.clone(this,false);return ft}catch(fr){this.trigger("error",fr)}},destroy:function(){if(this.ruid){this.getRuntime().exec.call(this,"Image","destroy");this.disconnectRuntime()}this.unbindAll()}});function fh(fm){if(!fm){fm=this.getRuntime().exec.call(this,"Image","getInfo")}if(fm){if(e2.typeOf(fm.meta)==="string"){try{this.meta=e3(fm.meta)}catch(fl){}}else{this.meta=fm.meta}}e2.extend(this,{size:parseInt(fm.size,10),width:parseInt(fm.width,10),height:parseInt(fm.height,10),type:fm.type});if(this.name===""){this.name=fm.name}}function fi(fn){var fm=e2.typeOf(fn);try{if(fn instanceof e0){if(!fn.size){throw new fc.DOMException(fc.DOMException.INVALID_STATE_ERR)}fg.apply(this,arguments)}else{if(fn instanceof e4){if(!~e2.inArray(fn.type,["image/jpeg","image/png"])){throw new fc.ImageError(fc.ImageError.WRONG_FORMAT)}fj.apply(this,arguments)}else{if(e2.inArray(fm,["blob","file"])!==-1){fi.call(this,new e8(null,fn),arguments[1])}else{if(fm==="string"){if(/^data:[^;]*;base64,/.test(fn)){fi.call(this,new e4(null,{data:fn}),arguments[1])}else{fk.apply(this,arguments)}}else{if(fm==="node"&&fn.nodeName.toLowerCase()==="img"){fi.call(this,fn.src,arguments[1])}else{throw new fc.DOMException(fc.DOMException.TYPE_MISMATCH_ERR)}}}}}}catch(fl){this.trigger("error",fl)}}function fg(fl,fm){var fn=this.connectRuntime(fl.ruid);this.ruid=fn.uid;fn.exec.call(this,"Image","loadFromImage",fl,(e2.typeOf(fm)==="undefined"?true:fm))}function fj(fn,fo){var fm=this;fm.name=fn.name||"";function fl(fp){fm.ruid=fp.uid;fp.exec.call(fm,"Image","loadFromBlob",fn)}if(fn.isDetached()){this.bind("RuntimeInit",function(fq,fp){fl(fp)});if(fo&&typeof(fo.required_caps)==="string"){fo.required_caps=e1.parseCaps(fo.required_caps)}this.connectRuntime(e2.extend({required_caps:{access_image_binary:true,resize_image:true}},fo))}else{fl(this.connectRuntime(fn.ruid))}}function fk(fn,fm){var fl=this,fo;fo=new fd();fo.open("get",fn);fo.responseType="blob";fo.onprogress=function(fp){fl.trigger(fp)};fo.onload=function(){fj.call(fl,fo.response,true)};fo.onerror=function(fp){fl.trigger(fp)};fo.onloadend=function(){fo.destroy()};fo.bind("RuntimeError",function(fq,fp){fl.trigger("RuntimeError",fp)});fo.send(null,fm)}}e0.MAX_RESIZE_WIDTH=6500;e0.MAX_RESIZE_HEIGHT=6500;e0.prototype=ff.instance;return e0});eZ("moxie/runtime/html5/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(e5,e0,e2,e1){var e4="html5",e3={};function e6(e8){var e7=this,fb=e2.capTest,fa=e2.capTrue;var e9=e5.extend({access_binary:fb(window.FileReader||window.File&&window.File.getAsDataURL),access_image_binary:function(){return e7.can("access_binary")&&!!e3.Image},display_media:fb(e1.can("create_canvas")||e1.can("use_data_uri_over32kb")),do_cors:fb(window.XMLHttpRequest&&"withCredentials" in new XMLHttpRequest()),drag_and_drop:fb(function(){var fc=document.createElement("div");return(("draggable" in fc)||("ondragstart" in fc&&"ondrop" in fc))&&(e1.browser!=="IE"||e1.version>9)}()),filter_by_extension:fb(function(){return(e1.browser==="Chrome"&&e1.version>=28)||(e1.browser==="IE"&&e1.version>=10)}()),return_response_headers:fa,return_response_type:function(fc){if(fc==="json"){return true}else{return e1.can("return_response_type",fc)}},return_status_code:fa,report_upload_progress:fb(window.XMLHttpRequest&&new XMLHttpRequest().upload),resize_image:function(){return e7.can("access_binary")&&e1.can("create_canvas")},select_file:function(){return e1.can("use_fileinput")&&window.File},select_folder:function(){return e7.can("select_file")&&e1.browser==="Chrome"&&e1.version>=21},select_multiple:function(){return e7.can("select_file")&&!(e1.browser==="Safari"&&e1.OS==="Windows")},send_binary_string:fb(window.XMLHttpRequest&&(new XMLHttpRequest().sendAsBinary||(window.Uint8Array&&window.ArrayBuffer))),send_custom_headers:fb(window.XMLHttpRequest),send_multipart:function(){return !!(window.XMLHttpRequest&&new XMLHttpRequest().upload&&window.FormData)||e7.can("send_binary_string")},slice_blob:fb(window.File&&(File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice)),stream_upload:function(){return e7.can("slice_blob")&&e7.can("send_multipart")},summon_file_dialog:fb(function(){return(e1.browser==="Firefox"&&e1.version>=4)||(e1.browser==="Opera"&&e1.version>=12)||(e1.browser==="IE"&&e1.version>=10)||!!~e5.inArray(e1.browser,["Chrome","Safari"])}()),upload_filesize:fa},arguments[2]);e2.call(this,e8,(arguments[1]||e4),e9);e5.extend(this,{init:function(){this.trigger("Init")},destroy:(function(fc){return function(){fc.call(e7);fc=e7=null}}(this.destroy))});e5.extend(this.getShim(),e3)}e2.addConstructor(e4,e6);return e3});eZ("moxie/runtime/html5/file/Blob",["moxie/runtime/html5/Runtime","moxie/file/Blob"],function(e1,e2){function e0(){function e3(e5,e8,e4){var e6;if(window.File.prototype.slice){try{e5.slice();return e5.slice(e8,e4)}catch(e7){return e5.slice(e8,e4-e8)}}else{if((e6=window.File.prototype.webkitSlice||window.File.prototype.mozSlice)){return e6.call(e5,e8,e4)}else{return null}}}this.slice=function(){return new e2(this.getRuntime().uid,e3.apply(this,arguments))}}return(e1.Blob=e0)});eZ("moxie/core/utils/Events",["moxie/core/utils/Basic"],function(e6){var e7={},e3="moxie_"+e6.guid();function e2(){this.returnValue=false}function e1(){this.cancelBubble=true}var e4=function(fc,e8,fd,fa){var fb,e9;e8=e8.toLowerCase();if(fc.addEventListener){fb=fd;fc.addEventListener(e8,fb,false)}else{if(fc.attachEvent){fb=function(){var fe=window.event;if(!fe.target){fe.target=fe.srcElement}fe.preventDefault=e2;fe.stopPropagation=e1;fd(fe)};fc.attachEvent("on"+e8,fb)}}if(!fc[e3]){fc[e3]=e6.guid()}if(!e7.hasOwnProperty(fc[e3])){e7[fc[e3]]={}}e9=e7[fc[e3]];if(!e9.hasOwnProperty(e8)){e9[e8]=[]}e9[e8].push({func:fb,orig:fd,key:fa})};var e5=function(fd,e8,fe){var fb,fa;e8=e8.toLowerCase();if(fd[e3]&&e7[fd[e3]]&&e7[fd[e3]][e8]){fb=e7[fd[e3]][e8]}else{return}for(var e9=fb.length-1;e9>=0;e9--){if(fb[e9].orig===fe||fb[e9].key===fe){if(fd.removeEventListener){fd.removeEventListener(e8,fb[e9].func,false)}else{if(fd.detachEvent){fd.detachEvent("on"+e8,fb[e9].func)}}fb[e9].orig=null;fb[e9].func=null;fb.splice(e9,1);if(fe!==fa){break}}}if(!fb.length){delete e7[fd[e3]][e8]}if(e6.isEmptyObj(e7[fd[e3]])){delete e7[fd[e3]];try{delete fd[e3]}catch(fc){fd[e3]=fa}}};var e0=function(e9,e8){if(!e9||!e9[e3]){return}e6.each(e7[e9[e3]],function(fb,fa){e5(e9,fa,e8)})};return{addEvent:e4,removeEvent:e5,removeAllEvents:e0}});eZ("moxie/runtime/html5/file/FileInput",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(e4,e6,e3,e1,e2,e0){function e5(){var e8=[],e7;e6.extend(this,{init:function(fi){var e9=this,fg=e9.getRuntime(),ff,fb,fc,fh,fe,fd;e7=fi;e8=[];fc=e7.accept.mimes||e2.extList2mimes(e7.accept,fg.can("filter_by_extension"));fb=fg.getShimContainer();fb.innerHTML='<input id="'+fg.uid+'" type="file" style="font-size:999px;opacity:0;"'+(e7.multiple&&fg.can("select_multiple")?"multiple":"")+(e7.directory&&fg.can("select_folder")?"webkitdirectory directory":"")+(fc?' accept="'+fc.join(",")+'"':"")+" />";ff=e3.get(fg.uid);e6.extend(ff.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});fh=e3.get(e7.browse_button);if(fg.can("summon_file_dialog")){if(e3.getStyle(fh,"position")==="static"){fh.style.position="relative"}fe=parseInt(e3.getStyle(fh,"z-index"),10)||1;fh.style.zIndex=fe;fb.style.zIndex=fe-1;e1.addEvent(fh,"click",function(fk){var fj=e3.get(fg.uid);if(fj&&!fj.disabled){fj.click()}fk.preventDefault()},e9.uid)}fd=fg.can("summon_file_dialog")?fh:fb;e1.addEvent(fd,"mouseover",function(){e9.trigger("mouseenter")},e9.uid);e1.addEvent(fd,"mouseout",function(){e9.trigger("mouseleave")},e9.uid);e1.addEvent(fd,"mousedown",function(){e9.trigger("mousedown")},e9.uid);e1.addEvent(e3.get(e7.container),"mouseup",function(){e9.trigger("mouseup")},e9.uid);ff.onchange=function fa(){e8=[];if(e7.directory){e6.each(this.files,function(fk){if(fk.name!=="."){e8.push(fk)}})}else{e8=[].slice.call(this.files)}if(e0.browser!=="IE"){this.value=""}else{var fj=this.cloneNode(true);this.parentNode.replaceChild(fj,this);fj.onchange=fa}e9.trigger("change")};e9.trigger({type:"ready",async:true});fb=null},getFiles:function(){return e8},disable:function(fb){var fa=this.getRuntime(),e9;if((e9=e3.get(fa.uid))){e9.disabled=!!fb}},destroy:function(){var fa=this.getRuntime(),e9=fa.getShimContainer();e1.removeAllEvents(e9,this.uid);e1.removeAllEvents(e7&&e3.get(e7.container),this.uid);e1.removeAllEvents(e7&&e3.get(e7.browse_button),this.uid);if(e9){e9.innerHTML=""}e8=e7=null}})}return(e4.FileInput=e5)});eZ("moxie/runtime/html5/file/FileDrop",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime"],function(e3,e4,e2,e0,e1){function e5(){var e8=[],fb=[],e7;e4.extend(this,{init:function(ff){var fe=this,fg;e7=ff;fb=e9(e7.accept);fg=e7.container;e0.addEvent(fg,"dragover",function(fh){fh.preventDefault();fh.stopPropagation();fh.dataTransfer.dropEffect="copy"},fe.uid);e0.addEvent(fg,"drop",function(fi){fi.preventDefault();fi.stopPropagation();e8=[];if(fi.dataTransfer.items&&fi.dataTransfer.items[0].webkitGetAsEntry){var fh=[];e4.each(fi.dataTransfer.items,function(fj){fh.push(fj.webkitGetAsEntry())});fc(fh,function(){fe.trigger("drop")})}else{e4.each(fi.dataTransfer.files,function(fj){if(e6(fj)){e8.push(fj)}});fe.trigger("drop")}},fe.uid);e0.addEvent(fg,"dragenter",function(fh){fh.preventDefault();fh.stopPropagation();fe.trigger("dragenter")},fe.uid);e0.addEvent(fg,"dragleave",function(fh){fh.preventDefault();fh.stopPropagation();fe.trigger("dragleave")},fe.uid)},getFiles:function(){return e8},destroy:function(){e0.removeAllEvents(e7&&e2.get(e7.container),this.uid);e8=fb=e7=null}});function e9(fg){var ff=[];for(var fe=0;fe<fg.length;fe++){[].push.apply(ff,fg[fe].extensions.split(/\s*,\s*/))}return e4.inArray("*",ff)===-1?ff:[]}function e6(fe){var ff=e1.getFileExtension(fe.name);return !ff||!fb.length||e4.inArray(ff,fb)!==-1}function fc(fg,ff){var fe=[];e4.each(fg,function(fh){fe.push(function(fi){fa(fh,fi)})});e4.inSeries(fe,function(){ff()})}function fa(ff,fe){if(ff.isFile){ff.file(function(fg){if(e6(fg)){e8.push(fg)}fe()},function(){fe()})}else{if(ff.isDirectory){fd(ff,fe)}else{fe()}}}function fd(fi,ff){var fe=[],fh=fi.createReader();function fg(fj){fh.readEntries(function(fk){if(fk.length){[].push.apply(fe,fk);fg(fj)}else{fj()}},fj)}fg(function(){fc(fe,ff)})}}return(e3.FileDrop=e5)});eZ("moxie/runtime/html5/file/FileReader",["moxie/runtime/html5/Runtime","moxie/core/utils/Encode","moxie/core/utils/Basic"],function(e1,e0,e3){function e2(){var e5,e6=false;e3.extend(this,{read:function(e9,e7){var e8=this;e5=new window.FileReader();e5.addEventListener("progress",function(fa){e8.trigger(fa)});e5.addEventListener("load",function(fa){e8.trigger(fa)});e5.addEventListener("error",function(fa){e8.trigger(fa,e5.error)});e5.addEventListener("loadend",function(){e5=null});if(e3.typeOf(e5[e9])==="function"){e6=false;e5[e9](e7.getSource())}else{if(e9==="readAsBinaryString"){e6=true;e5.readAsDataURL(e7.getSource())}}},getResult:function(){return e5&&e5.result?(e6?e4(e5.result):e5.result):null},abort:function(){if(e5){e5.abort()}},destroy:function(){e5=null}});function e4(e7){return e0.atob(e7.substring(e7.indexOf("base64,")+7))}}return(e1.FileReader=e2)});eZ("moxie/runtime/html5/xhr/XMLHttpRequest",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Url","moxie/file/File","moxie/file/Blob","moxie/xhr/FormData","moxie/core/Exceptions","moxie/core/utils/Env","moxie/core/JSON"],function(e7,e1,e4,e0,e6,e3,fa,e8,e5,e2){function e9(){var fg,fe;e1.extend(this,{send:function(fo,fl){var fn=this,fk=(e5.browser==="Mozilla"&&e5.version>=4&&e5.version<7),fh=e5.browser==="Android Browser",fm=false;fe=fo.url.replace(/^.+?\/([\w\-\.]+)$/,"$1").toLowerCase();fg=ff();fg.open(fo.method,fo.url,fo.async,fo.user,fo.password);if(fl instanceof e3){if(fl.isDetached()){fm=true}fl=fl.getSource()}else{if(fl instanceof fa){if(fl.hasBlob()){if(fl.getBlob().isDetached()){fl=fd.call(fn,fl);fm=true}else{if((fk||fh)&&e1.typeOf(fl.getBlob().getSource())==="blob"&&window.FileReader){fb.call(fn,fo,fl);return}}}if(fl instanceof fa){var fj=new window.FormData();fl.each(function(fq,fp){if(fq instanceof e3){fj.append(fp,fq.getSource())}else{fj.append(fp,fq)}});fl=fj}}}if(fg.upload){if(fo.withCredentials){fg.withCredentials=true}fg.addEventListener("load",function(fp){fn.trigger(fp)});fg.addEventListener("error",function(fp){fn.trigger(fp)});fg.addEventListener("progress",function(fp){fn.trigger(fp)});fg.upload.addEventListener("progress",function(fp){fn.trigger({type:"UploadProgress",loaded:fp.loaded,total:fp.total})})}else{fg.onreadystatechange=function fi(){switch(fg.readyState){case 1:break;case 2:break;case 3:var fr,fp;try{if(e0.hasSameOrigin(fo.url)){fr=fg.getResponseHeader("Content-Length")||0}if(fg.responseText){fp=fg.responseText.length}}catch(fq){fr=fp=0}fn.trigger({type:"progress",lengthComputable:!!fr,total:parseInt(fr,10),loaded:fp});break;case 4:fg.onreadystatechange=function(){};if(fg.status===0){fn.trigger("error")}else{fn.trigger("load")}break}}}if(!e1.isEmptyObj(fo.headers)){e1.each(fo.headers,function(fp,fq){fg.setRequestHeader(fq,fp)})}if(""!==fo.responseType&&"responseType" in fg){if("json"===fo.responseType&&!e5.can("return_response_type","json")){fg.responseType="text"}else{fg.responseType=fo.responseType}}if(!fm){fg.send(fl)}else{if(fg.sendAsBinary){fg.sendAsBinary(fl)}else{(function(){var fp=new Uint8Array(fl.length);for(var fq=0;fq<fl.length;fq++){fp[fq]=(fl.charCodeAt(fq)&255)}fg.send(fp.buffer)}())}}fn.trigger("loadstart")},getStatus:function(){try{if(fg){return fg.status}}catch(fh){}return 0},getResponse:function(fj){var fi=this.getRuntime();try{switch(fj){case"blob":var fl=new e6(fi.uid,fg.response);var fm=fg.getResponseHeader("Content-Disposition");if(fm){var fh=fm.match(/filename=([\'\"'])([^\1]+)\1/);if(fh){fe=fh[2]}}fl.name=fe;if(!fl.type){fl.type=e4.getFileMime(fe)}return fl;case"json":if(!e5.can("return_response_type","json")){return fg.status===200?e2(fg.responseText):null}return fg.response;case"document":return fc(fg);default:return fg.responseText!==""?fg.responseText:null}}catch(fk){return null}},getAllResponseHeaders:function(){try{return fg.getAllResponseHeaders()}catch(fh){}return""},abort:function(){if(fg){fg.abort()}},destroy:function(){self=fe=null}});function fb(fl,fj){var fk=this,fi,fh;fi=fj.getBlob().getSource();fh=new window.FileReader();fh.onload=function(){fj.append(fj.getBlobName(),new e3(null,{type:fi.type,data:fh.result}));self.send.call(fk,fl,fj)};fh.readAsBinaryString(fi)}function ff(){if(window.XMLHttpRequest&&!(e5.browser==="IE"&&e5.version<8)){return new window.XMLHttpRequest()}else{return(function(){var fh=["Msxml2.XMLHTTP.6.0","Microsoft.XMLHTTP"];for(var fj=0;fj<fh.length;fj++){try{return new ActiveXObject(fh[fj])}catch(fi){}}})()}}function fc(fi){var fj=fi.responseXML;var fh=fi.responseText;if(e5.browser==="IE"&&fh&&fj&&!fj.documentElement&&/[^\/]+\/[^\+]+\+xml/.test(fi.getResponseHeader("Content-Type"))){fj=new window.ActiveXObject("Microsoft.XMLDOM");fj.async=false;fj.validateOnParse=false;fj.loadXML(fh)}if(fj){if((e5.browser==="IE"&&fj.parseError!==0)||!fj.documentElement||fj.documentElement.tagName==="parsererror"){return null}}return fj}function fd(fj){var fm="----moxieboundary"+new Date().getTime(),fk="--",fl="\r\n",fh="",fi=this.getRuntime();if(!fi.can("send_binary_string")){throw new e8.RuntimeError(e8.RuntimeError.NOT_SUPPORTED_ERR)}fg.setRequestHeader("Content-Type","multipart/form-data; boundary="+fm);fj.each(function(fo,fn){if(fo instanceof e3){fh+=fk+fm+fl+'Content-Disposition: form-data; name="'+fn+'"; filename="'+unescape(encodeURIComponent(fo.name||"blob"))+'"'+fl+"Content-Type: "+fo.type+fl+fl+fo.getSource()+fl}else{fh+=fk+fm+fl+'Content-Disposition: form-data; name="'+fn+'"'+fl+fl+unescape(encodeURIComponent(fo))+fl}});fh+=fk+fm+fk+fl;return fh}}return(e7.XMLHttpRequest=e9)});eZ("moxie/runtime/html5/utils/BinaryReader",[],function(){return function(){var e3=false,e1;function e4(e6,e8){var e5=e3?0:-8*(e8-1),e9=0,e7;for(e7=0;e7<e8;e7++){e9|=(e1.charCodeAt(e6+e7)<<Math.abs(e5+e7*8))}return e9}function e0(e7,e5,e6){e6=arguments.length===3?e6:e1.length-e5-1;e1=e1.substr(0,e5)+e7+e1.substr(e6+e5)}function e2(e6,e7,e9){var fa="",e5=e3?0:-8*(e9-1),e8;for(e8=0;e8<e9;e8++){fa+=String.fromCharCode((e7>>Math.abs(e5+e8*8))&255)}e0(fa,e6,e9)}return{II:function(e5){if(e5===eY){return e3}else{e3=e5}},init:function(e5){e3=false;e1=e5},SEGMENT:function(e5,e7,e6){switch(arguments.length){case 1:return e1.substr(e5,e1.length-e5-1);case 2:return e1.substr(e5,e7);case 3:e0(e6,e5,e7);break;default:return e1}},BYTE:function(e5){return e4(e5,1)},SHORT:function(e5){return e4(e5,2)},LONG:function(e5,e6){if(e6===eY){return e4(e5,4)}else{e2(e5,e6,4)}},SLONG:function(e5){var e6=e4(e5,4);return(e6>2147483647?e6-4294967296:e6)},STRING:function(e5,e6){var e7="";for(e6+=e5;e5<e6;e5++){e7+=String.fromCharCode(e4(e5,1))}return e7}}}});eZ("moxie/runtime/html5/image/JPEGHeaders",["moxie/runtime/html5/utils/BinaryReader"],function(e1){return function e0(e6){var e7=[],e5,e2,e3,e4=0;e5=new e1();e5.init(e6);if(e5.SHORT(0)!==65496){return}e2=2;while(e2<=e6.length){e3=e5.SHORT(e2);if(e3>=65488&&e3<=65495){e2+=2;continue}if(e3===65498||e3===65497){break}e4=e5.SHORT(e2+2)+2;if(e3>=65505&&e3<=65519){e7.push({hex:e3,name:"APP"+(e3&15),start:e2,length:e4,segment:e5.SEGMENT(e2,e4)})}e2+=e4}e5.init(null);return{headers:e7,restore:function(fa){var e8,e9;e5.init(fa);e2=e5.SHORT(2)==65504?4+e5.SHORT(4):2;for(e9=0,e8=e7.length;e9<e8;e9++){e5.SEGMENT(e2,0,e7[e9].segment);e2+=e7[e9].length}fa=e5.SEGMENT();e5.init(null);return fa},strip:function(fa){var fb,e8,e9;e8=new e0(fa);fb=e8.headers;e8.purge();e5.init(fa);e9=fb.length;while(e9--){e5.SEGMENT(fb[e9].start,fb[e9].length,"")}fa=e5.SEGMENT();e5.init(null);return fa},get:function(e9){var fb=[];for(var fa=0,e8=e7.length;fa<e8;fa++){if(e7[fa].name===e9.toUpperCase()){fb.push(e7[fa].segment)}}return fb},set:function(e9,fc){var fd=[],fa,fb,e8;if(typeof(fc)==="string"){fd.push(fc)}else{fd=fc}for(fa=fb=0,e8=e7.length;fa<e8;fa++){if(e7[fa].name===e9.toUpperCase()){e7[fa].segment=fd[fb];e7[fa].length=fd[fb].length;fb++}if(fb>=fd.length){break}}},purge:function(){e7=[];e5.init(null);e5=null}}}});eZ("moxie/runtime/html5/image/ExifParser",["moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(e2,e1){return function e0(){var e7,e4,e3,e5={},fa;e7=new e1();e4={tiff:{274:"Orientation",270:"ImageDescription",271:"Make",272:"Model",305:"Software",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer"},exif:{36864:"ExifVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",36867:"DateTimeOriginal",33434:"ExposureTime",33437:"FNumber",34855:"ISOSpeedRatings",37377:"ShutterSpeedValue",37378:"ApertureValue",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",41986:"ExposureMode",41987:"WhiteBalance",41990:"SceneCaptureType",41988:"DigitalZoomRatio",41992:"Contrast",41993:"Saturation",41994:"Sharpness"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude"}};fa={ColorSpace:{1:"sRGB",0:"Uncalibrated"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{1:"Daylight",2:"Fliorescent",3:"Tungsten",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 -5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire.",1:"Flash fired.",5:"Strobe return light not detected.",7:"Strobe return light detected.",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},ExposureMode:{0:"Auto exposure",1:"Manual exposure",2:"Auto bracket"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},GPSLatitudeRef:{N:"North latitude",S:"South latitude"},GPSLongitudeRef:{E:"East longitude",W:"West longitude"}};function e6(fb,fj){var fd=e7.SHORT(fb),fg,fm,fn,fi,fh,fc,fe,fk,fl=[],ff={};for(fg=0;fg<fd;fg++){fe=fc=fb+12*fg+2;fn=fj[e7.SHORT(fe)];if(fn===eY){continue}fi=e7.SHORT(fe+=2);fh=e7.LONG(fe+=2);fe+=4;fl=[];switch(fi){case 1:case 7:if(fh>4){fe=e7.LONG(fe)+e5.tiffHeader}for(fm=0;fm<fh;fm++){fl[fm]=e7.BYTE(fe+fm)}break;case 2:if(fh>4){fe=e7.LONG(fe)+e5.tiffHeader}ff[fn]=e7.STRING(fe,fh-1);continue;case 3:if(fh>2){fe=e7.LONG(fe)+e5.tiffHeader}for(fm=0;fm<fh;fm++){fl[fm]=e7.SHORT(fe+fm*2)}break;case 4:if(fh>1){fe=e7.LONG(fe)+e5.tiffHeader}for(fm=0;fm<fh;fm++){fl[fm]=e7.LONG(fe+fm*4)}break;case 5:fe=e7.LONG(fe)+e5.tiffHeader;for(fm=0;fm<fh;fm++){fl[fm]=e7.LONG(fe+fm*4)/e7.LONG(fe+fm*4+4)}break;case 9:fe=e7.LONG(fe)+e5.tiffHeader;for(fm=0;fm<fh;fm++){fl[fm]=e7.SLONG(fe+fm*4)}break;case 10:fe=e7.LONG(fe)+e5.tiffHeader;for(fm=0;fm<fh;fm++){fl[fm]=e7.SLONG(fe+fm*4)/e7.SLONG(fe+fm*4+4)}break;default:continue}fk=(fh==1?fl[0]:fl);if(fa.hasOwnProperty(fn)&&typeof fk!="object"){ff[fn]=fa[fn][fk]}else{ff[fn]=fk}}return ff}function e9(){var fb=e5.tiffHeader;e7.II(e7.SHORT(fb)==18761);if(e7.SHORT(fb+=2)!==42){return false}e5.IFD0=e5.tiffHeader+e7.LONG(fb+=2);e3=e6(e5.IFD0,e4.tiff);if("ExifIFDPointer" in e3){e5.exifIFD=e5.tiffHeader+e3.ExifIFDPointer;delete e3.ExifIFDPointer}if("GPSInfoIFDPointer" in e3){e5.gpsIFD=e5.tiffHeader+e3.GPSInfoIFDPointer;delete e3.GPSInfoIFDPointer}return true}function e8(fi,fk,fh){var ff,fd,fc,fb=0;if(typeof(fk)==="string"){var fj=e4[fi.toLowerCase()];for(var fe in fj){if(fj[fe]===fk){fk=fe;break}}}ff=e5[fi.toLowerCase()+"IFD"];fd=e7.SHORT(ff);for(var fg=0;fg<fd;fg++){fc=ff+12*fg+2;if(e7.SHORT(fc)==fk){fb=fc+8;break}}if(!fb){return false}e7.LONG(fb,fh);return true}return{init:function(fb){e5={tiffHeader:10};if(fb===eY||!fb.length){return false}e7.init(fb);if(e7.SHORT(0)===65505&&e7.STRING(4,5).toUpperCase()==="EXIF\0"){return e9()}return false},TIFF:function(){return e3},EXIF:function(){var fc;fc=e6(e5.exifIFD,e4.exif);if(fc.ExifVersion&&e2.typeOf(fc.ExifVersion)==="array"){for(var fd=0,fb="";fd<fc.ExifVersion.length;fd++){fb+=String.fromCharCode(fc.ExifVersion[fd])}fc.ExifVersion=fb}return fc},GPS:function(){var fb;fb=e6(e5.gpsIFD,e4.gps);if(fb.GPSVersionID&&e2.typeOf(fb.GPSVersionID)==="array"){fb.GPSVersionID=fb.GPSVersionID.join(".")}return fb},setExif:function(fb,fc){if(fb!=="PixelXDimension"&&fb!=="PixelYDimension"){return false}return e8("exif",fb,fc)},getBinary:function(){return e7.SEGMENT()},purge:function(){e7.init(null);e7=e3=null;e5={}}}}});eZ("moxie/runtime/html5/image/JPEG",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEGHeaders","moxie/runtime/html5/utils/BinaryReader","moxie/runtime/html5/image/ExifParser"],function(e5,e0,e2,e4,e1){function e3(fe){var e7,e9,fb,fa,fd,e6;function fc(){var ff=0,fg,fh;while(ff<=e7.length){fg=e9.SHORT(ff+=2);if(fg>=65472&&fg<=65475){ff+=5;return{height:e9.SHORT(ff),width:e9.SHORT(ff+=2)}}fh=e9.SHORT(ff+=2);ff+=fh-2}return null}e7=fe;e9=new e4();e9.init(e7);if(e9.SHORT(0)!==65496){throw new e0.ImageError(e0.ImageError.WRONG_FORMAT)}fb=new e2(fe);fa=new e1();e6=!!fa.init(fb.get("app1")[0]);fd=fc.call(this);e5.extend(this,{type:"image/jpeg",size:e7.length,width:fd&&fd.width||0,height:fd&&fd.height||0,setExif:function(ff,fg){if(!e6){return false}if(e5.typeOf(ff)==="object"){e5.each(ff,function(fi,fh){fa.setExif(fh,fi)})}else{fa.setExif(ff,fg)}fb.set("app1",fa.getBinary())},writeHeaders:function(){if(!arguments.length){return(e7=fb.restore(e7))}return fb.restore(arguments[0])},stripHeaders:function(ff){return fb.strip(ff)},purge:function(){e8.call(this)}});if(e6){this.meta={tiff:fa.TIFF(),exif:fa.EXIF(),gps:fa.GPS()}}function e8(){if(!fa||!fb||!e9){return}fa.purge();fb.purge();e9.init(null);e7=fd=fb=fa=e9=null}}return e3});eZ("moxie/runtime/html5/image/PNG",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(e0,e3,e2){function e1(fc){var e5,e7,e9,e8,fb;e5=fc;e7=new e2();e7.init(e5);(function(){var fd=0,ff=0,fe=[35152,20039,3338,6666];for(ff=0;ff<fe.length;ff++,fd+=2){if(fe[ff]!=e7.SHORT(fd)){throw new e0.ImageError(e0.ImageError.WRONG_FORMAT)}}}());function fa(){var fe,fd;fe=e4.call(this,8);if(fe.type=="IHDR"){fd=fe.start;return{width:e7.LONG(fd),height:e7.LONG(fd+=4)}}return null}function e6(){if(!e7){return}e7.init(null);e5=fb=e9=e8=e7=null}fb=fa.call(this);e3.extend(this,{type:"image/png",size:e5.length,width:fb.width,height:fb.height,purge:function(){e6.call(this)}});e6.call(this);function e4(fd){var fg,ff,fh,fe;fg=e7.LONG(fd);ff=e7.STRING(fd+=4,4);fh=fd+=4;fe=e7.LONG(fd+fg);return{length:fg,type:ff,start:fh,CRC:fe}}}return e1});eZ("moxie/runtime/html5/image/ImageInfo",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEG","moxie/runtime/html5/image/PNG"],function(e3,e0,e2,e1){return function(e5){var e6=[e2,e1],e4;e4=(function(){for(var e8=0;e8<e6.length;e8++){try{return new e6[e8](e5)}catch(e7){}}throw new e0.ImageError(e0.ImageError.WRONG_FORMAT)}());e3.extend(this,{type:"",size:0,width:0,height:0,setExif:function(){},writeHeaders:function(e7){return e7},stripHeaders:function(e7){return e7},purge:function(){}});e3.extend(this,e4);this.purge=function(){e4.purge();e4=null}}});eZ("moxie/runtime/html5/image/MegaPixel",[],function(){function e0(fo,e4,e5){var e7=fo.naturalWidth,fd=fo.naturalHeight;var fi=e5.width,ff=e5.height;var e9=e5.x||0,e8=e5.y||0;var fj=e4.getContext("2d");if(e1(fo)){e7/=2;fd/=2}var fm=1024;var e3=document.createElement("canvas");e3.width=e3.height=fm;var e6=e3.getContext("2d");var fk=e2(fo,e7,fd);var fe=0;while(fe<fd){var fn=fe+fm>fd?fd-fe:fm;var fg=0;while(fg<e7){var fh=fg+fm>e7?e7-fg:fm;e6.clearRect(0,0,fm,fm);e6.drawImage(fo,-fg,-fe);var fb=(fg*fi/e7+e9)<<0;var fc=Math.ceil(fh*fi/e7);var fa=(fe*ff/fd/fk+e8)<<0;var fl=Math.ceil(fn*ff/fd/fk);fj.drawImage(e3,0,0,fh,fn,fb,fa,fc,fl);fg+=fm}fe+=fm}e3=e6=null}function e1(e5){var e4=e5.naturalWidth,e7=e5.naturalHeight;if(e4*e7>1024*1024){var e6=document.createElement("canvas");e6.width=e6.height=1;var e3=e6.getContext("2d");e3.drawImage(e5,-e4+1,0);return e3.getImageData(0,0,1,1).data[3]===0}else{return false}}function e2(e7,e4,fc){var e3=document.createElement("canvas");e3.width=1;e3.height=fc;var fd=e3.getContext("2d");fd.drawImage(e7,0,0);var e6=fd.getImageData(0,0,1,fc).data;var fa=0;var e8=fc;var fb=fc;while(fb>fa){var e5=e6[(fb-1)*4+3];if(e5===0){e8=fb}else{fa=fb}fb=(e8+fa)>>1}e3=null;var e9=(fb/fc);return(e9===0)?1:e9}return{isSubsampled:e1,renderTo:e0}});eZ("moxie/runtime/html5/image/Image",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/utils/Encode","moxie/file/Blob","moxie/runtime/html5/image/ImageInfo","moxie/runtime/html5/image/MegaPixel","moxie/core/utils/Mime","moxie/core/utils/Env"],function(e6,e0,e7,e3,e1,e9,e8,e2,e4){function e5(){var fk=this,fj,fo,fi,fe,fm,fq=false,fb=true;e0.extend(this,{loadFromBlob:function(ft){var fs=this,fu=fs.getRuntime(),fr=arguments.length>1?arguments[1]:true;if(!fu.can("access_binary")){throw new e7.RuntimeError(e7.RuntimeError.NOT_SUPPORTED_ERR)}fm=ft;if(ft.isDetached()){fe=ft.getSource();fh.call(this,fe);return}else{fn.call(this,ft.getSource(),function(fv){if(fr){fe=fp(fv)}fh.call(fs,fv)})}},loadFromImage:function(fr,fs){this.meta=fr.meta;fm=new e1(null,{name:fr.name,size:fr.size,type:fr.type});fh.call(this,fs?(fe=fr.getAsBinaryString()):fr.getAsDataURL())},getInfo:function(){var fr=this.getRuntime(),fs;if(!fo&&fe&&fr.can("access_image_binary")){fo=new e9(fe)}fs={width:ff().width||0,height:ff().height||0,type:fm.type||e2.getFileMime(fm.name),size:fe&&fe.length||fm.size||0,name:fm.name||"",meta:fo&&fo.meta||this.meta||{}};return fs},downsize:function(){fa.apply(this,arguments)},getAsCanvas:function(){if(fi){fi.id=this.uid+"_canvas"}return fi},getAsBlob:function(fr,fs){if(fr!==this.type){fa.call(this,this.width,this.height,false)}return new e1(null,{type:fr,data:fk.getAsBinaryString.call(this,fr,fs)})},getAsDataURL:function(fs){var ft=arguments[1]||90;if(!fq){return fj.src}if("image/jpeg"!==fs){return fi.toDataURL("image/png")}else{try{return fi.toDataURL("image/jpeg",ft/100)}catch(fr){return fi.toDataURL("image/jpeg")}}},getAsBinaryString:function(fs,fu){if(!fq){if(!fe){fe=fp(fk.getAsDataURL(fs,fu))}return fe}if("image/jpeg"!==fs){fe=fp(fk.getAsDataURL(fs,fu))}else{var ft;if(!fu){fu=90}try{ft=fi.toDataURL("image/jpeg",fu/100)}catch(fr){ft=fi.toDataURL("image/jpeg")}fe=fp(ft);if(fo){fe=fo.stripHeaders(fe);if(fb){if(fo.meta&&fo.meta.exif){fo.setExif({PixelXDimension:this.width,PixelYDimension:this.height})}fe=fo.writeHeaders(fe)}fo.purge();fo=null}}fq=false;return fe},destroy:function(){fk=null;fc.call(this);this.getRuntime().getShim().removeInstance(this.uid)}});function ff(){if(!fi&&!fj){throw new e7.ImageError(e7.DOMException.INVALID_STATE_ERR)}return fi||fj}function fp(fr){return e3.atob(fr.substring(fr.indexOf("base64,")+7))}function fl(fs,fr){return"data:"+(fr||"")+";base64,"+e3.btoa(fs)}function fh(fs){var fr=this;fj=new Image();fj.onerror=function(){fc.call(this);fr.trigger("error",new e7.ImageError(e7.ImageError.WRONG_FORMAT))};fj.onload=function(){fr.trigger("load")};fj.src=/^data:[^;]*;base64,/.test(fs)?fs:fl(fs,fm.type)}function fn(fu,fv){var ft=this,fs;if(window.FileReader){fs=new FileReader();fs.onload=function(){fv(this.result)};fs.onerror=function(){ft.trigger("error",new e7.FileException(e7.FileException.NOT_READABLE_ERR))};fs.readAsDataURL(fu)}else{return fv(fu.getAsDataURL())}}function fa(fs,fD,fw,fB){var fE=this,fF,fu,ft,fA,fz,fv,fy,fx,fr;fb=fB;fr=(this.meta&&this.meta.tiff&&this.meta.tiff.Orientation)||1;if(e0.inArray(fr,[5,6,7,8])!==-1){var fC=fs;fs=fD;fD=fC}fv=ff();ft=!fw?Math.min:Math.max;fu=ft(fs/fv.width,fD/fv.height);if(fu>1&&(!fw||fB)){this.trigger("Resize");return}fy=Math.round(fv.width*fu);fx=Math.round(fv.height*fu);if(!fi){fi=document.createElement("canvas")}fF=fi.getContext("2d");if(fw){fi.width=fs;fi.height=fD}else{fi.width=fy;fi.height=fx}fA=fy>fi.width?Math.round((fy-fi.width)/2):0;fz=fx>fi.height?Math.round((fx-fi.height)/2):0;if(!fb){fg(fi.width,fi.height,fr)}fd.call(this,fv,fi,-fA,-fz,fy,fx);this.width=fi.width;this.height=fi.height;fq=true;fE.trigger("Resize")}function fd(fu,fv,fr,fx,ft,fw){if(e4.OS==="iOS"){e8.renderTo(fu,fv,{width:ft,height:fw,x:fr,y:fx})}else{var fs=fv.getContext("2d");fs.drawImage(fu,fr,fx,ft,fw)}}function fg(fu,fr,ft){switch(ft){case 5:case 6:case 7:case 8:fi.width=fr;fi.height=fu;break;default:fi.width=fu;fi.height=fr}var fs=fi.getContext("2d");switch(ft){case 2:fs.translate(fu,0);fs.scale(-1,1);break;case 3:fs.translate(fu,fr);fs.rotate(Math.PI);break;case 4:fs.translate(0,fr);fs.scale(1,-1);break;case 5:fs.rotate(0.5*Math.PI);fs.scale(1,-1);break;case 6:fs.rotate(0.5*Math.PI);fs.translate(0,-fr);break;case 7:fs.rotate(0.5*Math.PI);fs.translate(fu,-fr);fs.scale(-1,1);break;case 8:fs.rotate(-0.5*Math.PI);fs.translate(-fu,0);break}}function fc(){if(fo){fo.purge();fo=null}fe=fj=fi=fm=null;fq=false}}return(e6.Image=e5)});eZ("moxie/runtime/flash/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(e1,e4,e2,e7,e0){var e5="flash",e6={};function e3(){var e9;try{e9=navigator.plugins["Shockwave Flash"];e9=e9.description}catch(fb){try{e9=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(fa){e9="0.0"}}e9=e9.match(/\d+/g);return parseFloat(e9[0]+"."+e9[1])}function e8(fa){var e9=this,fb;fa=e1.extend({swf_url:e4.swf_url},fa);e0.call(this,fa,e5,{access_binary:function(fc){return fc&&e9.mode==="browser"},access_image_binary:function(fc){return fc&&e9.mode==="browser"},display_media:e0.capTrue,do_cors:e0.capTrue,drag_and_drop:false,report_upload_progress:function(){return e9.mode==="client"},resize_image:e0.capTrue,return_response_headers:false,return_response_type:function(fc){return !e1.arrayDiff(fc,["","text","json","document"])||e9.mode==="browser"},return_status_code:function(fc){return e9.mode==="browser"||!e1.arrayDiff(fc,[200,404])},select_file:e0.capTrue,select_multiple:e0.capTrue,send_binary_string:function(fc){return fc&&e9.mode==="browser"},send_browser_cookies:function(fc){return fc&&e9.mode==="browser"},send_custom_headers:function(fc){return fc&&e9.mode==="browser"},send_multipart:e0.capTrue,slice_blob:e0.capTrue,stream_upload:function(fc){return fc&&e9.mode==="browser"},summon_file_dialog:false,upload_filesize:function(fc){return e1.parseSizeStr(fc)<=2097152||e9.mode==="client"},use_http_method:function(fc){return !e1.arrayDiff(fc,["GET","POST"])}},{access_binary:function(fc){return fc?"browser":"client"},access_image_binary:function(fc){return fc?"browser":"client"},report_upload_progress:function(fc){return fc?"browser":"client"},return_response_type:function(fc){return e1.arrayDiff(fc,["","text","json","document"])?"browser":["client","browser"]},return_status_code:function(fc){return e1.arrayDiff(fc,[200,404])?"browser":["client","browser"]},send_binary_string:function(fc){return fc?"browser":"client"},send_browser_cookies:function(fc){return fc?"browser":"client"},send_custom_headers:function(fc){return fc?"browser":"client"},stream_upload:function(fc){return fc?"client":"browser"},upload_filesize:function(fc){return e1.parseSizeStr(fc)>=2097152?"client":"browser"}},"client");if(e3()<10){this.mode=false}e1.extend(this,{getShim:function(){return e2.get(this.uid)},shimExec:function(fd,fe){var fc=[].slice.call(arguments,2);return e9.getShim().exec(this.uid,fd,fe,fc)},init:function(){var fd,fe,fc;fc=this.getShimContainer();e1.extend(fc.style,{position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});fd='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+fa.swf_url+'" ';if(e4.browser==="IE"){fd+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}fd+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+fa.swf_url+'" /><param name="flashvars" value="uid='+escape(this.uid)+"&target="+e4.global_event_dispatcher+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';if(e4.browser==="IE"){fe=document.createElement("div");fc.appendChild(fe);fe.outerHTML=fd;fe=fc=null}else{fc.innerHTML=fd}fb=setTimeout(function(){if(e9&&!e9.initialized){e9.trigger("Error",new e7.RuntimeError(e7.RuntimeError.NOT_INIT_ERR))}},5000)},destroy:(function(fc){return function(){fc.call(e9);clearTimeout(fb);fa=fb=fc=e9=null}}(this.destroy))},e6)}e0.addConstructor(e5,e8);return e6});eZ("moxie/runtime/flash/file/Blob",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(e1,e2){var e0={slice:function(e5,e7,e3,e6){var e4=this.getRuntime();if(e7<0){e7=Math.max(e5.size+e7,0)}else{if(e7>0){e7=Math.min(e7,e5.size)}}if(e3<0){e3=Math.max(e5.size+e3,0)}else{if(e3>0){e3=Math.min(e3,e5.size)}}e5=e4.shimExec.call(this,"Blob","slice",e7,e3,e6||"");if(e5){e5=new e2(e4.uid,e5)}return e5}};return(e1.Blob=e0)});eZ("moxie/runtime/flash/file/FileInput",["moxie/runtime/flash/Runtime"],function(e0){var e1={init:function(e2){this.getRuntime().shimExec.call(this,"FileInput","init",{name:e2.name,accept:e2.accept,multiple:e2.multiple});this.trigger("ready")}};return(e0.FileInput=e1)});eZ("moxie/runtime/flash/file/FileReader",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(e3,e0){var e1="";function e2(e5,e6){switch(e6){case"readAsText":return e0.atob(e5,"utf8");case"readAsBinaryString":return e0.atob(e5);case"readAsDataURL":return e5}return null}var e4={read:function(e8,e6){var e7=this,e5=e7.getRuntime();if(e8==="readAsDataURL"){e1="data:"+(e6.type||"")+";base64,"}e7.bind("Progress",function(fa,e9){if(e9){e1+=e2(e9,e8)}});return e5.shimExec.call(this,"FileReader","readAsBase64",e6.uid)},getResult:function(){return e1},destroy:function(){e1=null}};return(e3.FileReader=e4)});eZ("moxie/runtime/flash/file/FileReaderSync",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(e2,e0){function e1(e4,e5){switch(e5){case"readAsText":return e0.atob(e4,"utf8");case"readAsBinaryString":return e0.atob(e4);case"readAsDataURL":return e4}return null}var e3={read:function(e7,e6){var e4,e5=this.getRuntime();e4=e5.shimExec.call(this,"FileReaderSync","readAsBase64",e6.uid);if(!e4){return null}if(e7==="readAsDataURL"){e4="data:"+(e6.type||"")+";base64,"+e4}return e1(e4,e7,e6.type)}};return(e2.FileReaderSync=e3)});eZ("moxie/runtime/flash/xhr/XMLHttpRequest",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/file/Blob","moxie/file/File","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/runtime/Transporter","moxie/core/JSON"],function(e6,e0,e2,e5,e4,e8,e3,e1){var e7={send:function(fg,fb){var fd=this,fh=fd.getRuntime();function fa(){fg.transport=fh.mode;fh.shimExec.call(fd,"XMLHttpRequest","send",fg,fb)}function fc(fj,fi){fh.shimExec.call(fd,"XMLHttpRequest","appendBlob",fj,fi.uid);fb=null;fa()}function fe(fj,fi){var fk=new e3();fk.bind("TransportingComplete",function(){fi(this.result)});fk.transport(fj.getSource(),fj.type,{ruid:fh.uid})}if(!e0.isEmptyObj(fg.headers)){e0.each(fg.headers,function(fi,fj){fh.shimExec.call(fd,"XMLHttpRequest","setRequestHeader",fj,fi.toString())})}if(fb instanceof e8){var ff;fb.each(function(fj,fi){if(fj instanceof e2){ff=fi}else{fh.shimExec.call(fd,"XMLHttpRequest","append",fi,fj)}});if(!fb.hasBlob()){fb=null;fa()}else{var e9=fb.getBlob();if(e9.isDetached()){fe(e9,function(fi){e9.destroy();fc(ff,fi)})}else{fc(ff,e9)}}}else{if(fb instanceof e2){if(fb.isDetached()){fe(fb,function(fi){fb.destroy();fb=fi.uid;fa()})}else{fb=fb.uid;fa()}}else{fa()}}},getResponse:function(fc){var e9,fb,fa=this.getRuntime();fb=fa.shimExec.call(this,"XMLHttpRequest","getResponseAsBlob");if(fb){fb=new e5(fa.uid,fb);if("blob"===fc){return fb}else{if(!!~e0.inArray(fc,["","text"])){e9=new e4();return e9.readAsText(fb)}else{if("arraybuffer"===fc){}else{if("json"===fc){e9=new e4();try{return e1(e9.readAsText(fb))}catch(fd){return null}}}}}}return null},abort:function(fa){var e9=this.getRuntime();e9.shimExec.call(this,"XMLHttpRequest","abort");this.dispatchEvent("readystatechange");this.dispatchEvent("abort");if(!fa){}}};return(e6.XMLHttpRequest=e7)});eZ("moxie/runtime/flash/runtime/Transporter",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(e0,e2){var e1={getAsBlob:function(e5){var e4=this.getRuntime(),e3=e4.shimExec.call(this,"Transporter","getAsBlob",e5);if(e3){return new e2(e4.uid,e3)}return null}};return(e0.Transporter=e1)});eZ("moxie/runtime/flash/image/Image",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/runtime/Transporter","moxie/file/Blob","moxie/file/FileReaderSync"],function(e1,e3,e2,e5,e4){var e0={loadFromBlob:function(e9){var e8=this,e7=e8.getRuntime();function e6(fb){e7.shimExec.call(e8,"Image","loadFromBlob",fb.uid);e8=e7=null}if(e9.isDetached()){var fa=new e2();fa.bind("TransportingComplete",function(){e6(fa.result.getSource())});fa.transport(e9.getSource(),e9.type,{ruid:e7.uid})}else{e6(e9.getSource())}},loadFromImage:function(e7){var e6=this.getRuntime();return e6.shimExec.call(this,"Image","loadFromImage",e7.uid)},getAsBlob:function(e8,e9){var e7=this.getRuntime(),e6=e7.shimExec.call(this,"Image","getAsBlob",e8,e9);if(e6){return new e5(e7.uid,e6)}return null},getAsDataURL:function(){var e8=this.getRuntime(),e7=e8.Image.getAsBlob.apply(this,arguments),e6;if(!e7){return null}e6=new e4();return e6.readAsDataURL(e7)}};return(e1.Image=e0)});eZ("moxie/runtime/silverlight/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(e1,e4,e3,e7,e0){var e5="silverlight",e6={};function e8(fh){var fk=false,fd=null,e9,fa,fb,fj,fc,ff=0;try{try{fd=new ActiveXObject("AgControl.AgControl");if(fd.IsVersionSupported(fh)){fk=true}fd=null}catch(fg){var fe=navigator.plugins["Silverlight Plug-In"];if(fe){e9=fe.description;if(e9==="1.0.30226.2"){e9="2.0.30226.2"}fa=e9.split(".");while(fa.length>3){fa.pop()}while(fa.length<4){fa.push(0)}fb=fh.split(".");while(fb.length>4){fb.pop()}do{fj=parseInt(fb[ff],10);fc=parseInt(fa[ff],10);ff++}while(ff<fb.length&&fj===fc);if(fj<=fc&&!isNaN(fj)){fk=true}}}}catch(fi){fk=false}return fk}function e2(fa){var e9=this,fb;fa=e1.extend({xap_url:e4.xap_url},fa);e0.call(this,fa,e5,{access_binary:e0.capTrue,access_image_binary:e0.capTrue,display_media:e0.capTrue,do_cors:e0.capTrue,drag_and_drop:false,report_upload_progress:e0.capTrue,resize_image:e0.capTrue,return_response_headers:function(fc){return fc&&e9.mode==="client"},return_response_type:e0.capTrue,return_status_code:function(fc){return e9.mode==="client"||!e1.arrayDiff(fc,[200,404])},select_file:e0.capTrue,select_multiple:e0.capTrue,send_binary_string:e0.capTrue,send_browser_cookies:function(fc){return fc&&e9.mode==="browser"},send_custom_headers:function(fc){return fc&&e9.mode==="client"},send_multipart:e0.capTrue,slice_blob:e0.capTrue,stream_upload:true,summon_file_dialog:false,upload_filesize:e0.capTrue,use_http_method:function(fc){return e9.mode==="client"||!e1.arrayDiff(fc,["GET","POST"])}},{return_response_headers:function(fc){return fc?"client":"browser"},return_status_code:function(fc){return e1.arrayDiff(fc,[200,404])?"client":["client","browser"]},send_browser_cookies:function(fc){return fc?"browser":"client"},send_custom_headers:function(fc){return fc?"client":"browser"},use_http_method:function(fc){return e1.arrayDiff(fc,["GET","POST"])?"client":["client","browser"]}});if(!e8("2.0.31005.0")||e4.browser==="Opera"){this.mode=false}e1.extend(this,{getShim:function(){return e3.get(this.uid).content.Moxie},shimExec:function(fd,fe){var fc=[].slice.call(arguments,2);return e9.getShim().exec(this.uid,fd,fe,fc)},init:function(){var fc;fc=this.getShimContainer();fc.innerHTML='<object id="'+this.uid+'" data="data:application/x-silverlight," type="application/x-silverlight-2" width="100%" height="100%" style="outline:none;"><param name="source" value="'+fa.xap_url+'"/><param name="background" value="Transparent"/><param name="windowless" value="true"/><param name="enablehtmlaccess" value="true"/><param name="initParams" value="uid='+this.uid+",target="+e4.global_event_dispatcher+'"/></object>';fb=setTimeout(function(){if(e9&&!e9.initialized){e9.trigger("Error",new e7.RuntimeError(e7.RuntimeError.NOT_INIT_ERR))}},e4.OS!=="Windows"?10000:5000)},destroy:(function(fc){return function(){fc.call(e9);clearTimeout(fb);fa=fb=fc=e9=null}}(this.destroy))},e6)}e0.addConstructor(e5,e2);return e6});eZ("moxie/runtime/silverlight/file/Blob",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/Blob"],function(e0,e1,e2){return(e0.Blob=e1.extend({},e2))});eZ("moxie/runtime/silverlight/file/FileInput",["moxie/runtime/silverlight/Runtime"],function(e0){var e1={init:function(e3){function e2(e5){var e6="";for(var e4=0;e4<e5.length;e4++){e6+=(e6!==""?"|":"")+e5[e4].title+" | *."+e5[e4].extensions.replace(/,/g,";*.")}return e6}this.getRuntime().shimExec.call(this,"FileInput","init",e2(e3.accept),e3.name,e3.multiple);this.trigger("ready")}};return(e0.FileInput=e1)});eZ("moxie/runtime/silverlight/file/FileDrop",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Dom","moxie/core/utils/Events"],function(e2,e1,e0){var e3={init:function(){var e5=this,e4=e5.getRuntime(),e6;e6=e4.getShimContainer();e0.addEvent(e6,"dragover",function(e7){e7.preventDefault();e7.stopPropagation();e7.dataTransfer.dropEffect="copy"},e5.uid);e0.addEvent(e6,"dragenter",function(e8){e8.preventDefault();var e7=e1.get(e4.uid).dragEnter(e8);if(e7){e8.stopPropagation()}},e5.uid);e0.addEvent(e6,"drop",function(e8){e8.preventDefault();var e7=e1.get(e4.uid).dragDrop(e8);if(e7){e8.stopPropagation()}},e5.uid);return e4.shimExec.call(this,"FileDrop","init")}};return(e2.FileDrop=e3)});eZ("moxie/runtime/silverlight/file/FileReader",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReader"],function(e0,e2,e1){return(e0.FileReader=e2.extend({},e1))});eZ("moxie/runtime/silverlight/file/FileReaderSync",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReaderSync"],function(e0,e1,e2){return(e0.FileReaderSync=e1.extend({},e2))});eZ("moxie/runtime/silverlight/xhr/XMLHttpRequest",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/xhr/XMLHttpRequest"],function(e0,e2,e1){return(e0.XMLHttpRequest=e2.extend({},e1))});eZ("moxie/runtime/silverlight/runtime/Transporter",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/runtime/Transporter"],function(e0,e2,e1){return(e0.Transporter=e2.extend({},e1))});eZ("moxie/runtime/silverlight/image/Image",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/image/Image"],function(e1,e2,e0){return(e1.Image=e2.extend({},e0))});eZ("moxie/runtime/html4/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(e6,e0,e3,e2){var e5="html4",e4={};function e1(e8){var e7=this,fa=e3.capTest,e9=e3.capTrue;e3.call(this,e8,e5,{access_binary:fa(window.FileReader||window.File&&File.getAsDataURL),access_image_binary:false,display_media:fa(e4.Image&&(e2.can("create_canvas")||e2.can("use_data_uri_over32kb"))),do_cors:false,drag_and_drop:false,filter_by_extension:fa(function(){return(e2.browser==="Chrome"&&e2.version>=28)||(e2.browser==="IE"&&e2.version>=10)}()),resize_image:function(){return e4.Image&&e7.can("access_binary")&&e2.can("create_canvas")},report_upload_progress:false,return_response_headers:false,return_response_type:function(fb){return !!~e6.inArray(fb,["json","text","document",""])},return_status_code:function(fb){return !e6.arrayDiff(fb,[200,404])},select_file:function(){return e2.can("use_fileinput")},select_multiple:false,send_binary_string:false,send_custom_headers:false,send_multipart:true,slice_blob:false,stream_upload:function(){return e7.can("select_file")},summon_file_dialog:fa(function(){return(e2.browser==="Firefox"&&e2.version>=4)||(e2.browser==="Opera"&&e2.version>=12)||(e2.browser==="IE"&&e2.version>=10)||!!~e6.inArray(e2.browser,["Chrome","Safari"])}()),upload_filesize:e9,use_http_method:function(fb){return !e6.arrayDiff(fb,["GET","POST"])}});e6.extend(this,{init:function(){this.trigger("Init")},destroy:(function(fb){return function(){fb.call(e7);fb=e7=null}}(this.destroy))});e6.extend(this.getShim(),e4)}e3.addConstructor(e5,e1);return e4});eZ("moxie/runtime/html4/file/FileInput",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(e4,e6,e3,e1,e2,e0){function e5(){var fa,e8=[],fb=[],e7;function e9(){var fe=this,fh=fe.getRuntime(),fg,ff,fc,fj,fd,fi;fi=e6.guid("uid_");fg=fh.getShimContainer();if(fa){fc=e3.get(fa+"_form");if(fc){e6.extend(fc.style,{top:"100%"})}}fj=document.createElement("form");fj.setAttribute("id",fi+"_form");fj.setAttribute("method","post");fj.setAttribute("enctype","multipart/form-data");fj.setAttribute("encoding","multipart/form-data");e6.extend(fj.style,{overflow:"hidden",position:"absolute",top:0,left:0,width:"100%",height:"100%"});fd=document.createElement("input");fd.setAttribute("id",fi);fd.setAttribute("type","file");fd.setAttribute("name","Filedata");fd.setAttribute("accept",fb.join(","));e6.extend(fd.style,{fontSize:"999px",opacity:0});fj.appendChild(fd);fg.appendChild(fj);e6.extend(fd.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});if(e0.browser==="IE"&&e0.version<10){e6.extend(fd.style,{filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0)"})}fd.onchange=function(){var fk;if(!this.value){return}if(this.files){fk=this.files[0]}else{fk={name:this.value}}e8=[fk];this.onchange=function(){};e9.call(fe);fe.bind("change",function(){var fl=e3.get(fi),fn=e3.get(fi+"_form"),fm;if(fe.files.length&&fl&&fn){fm=fe.files[0];fl.setAttribute("id",fm.uid);fn.setAttribute("id",fm.uid+"_form");fn.setAttribute("target",fm.uid+"_iframe")}fl=fn=null},998);fd=fj=null;fe.trigger("change")};if(fh.can("summon_file_dialog")){ff=e3.get(e7.browse_button);e1.removeEvent(ff,"click",fe.uid);e1.addEvent(ff,"click",function(fk){if(fd&&!fd.disabled){fd.click()}fk.preventDefault()},fe.uid)}fa=fi;fg=fc=ff=null;fe.trigger({type:"ready",async:true})}e6.extend(this,{init:function(ff){var fc=this,fe=fc.getRuntime(),fd;e7=ff;fb=ff.accept.mimes||e2.extList2mimes(ff.accept,fe.can("filter_by_extension"));fd=fe.getShimContainer();(function(){var fg,fi,fh;fg=e3.get(ff.browse_button);if(fe.can("summon_file_dialog")){if(e3.getStyle(fg,"position")==="static"){fg.style.position="relative"}fi=parseInt(e3.getStyle(fg,"z-index"),10)||1;fg.style.zIndex=fi;fd.style.zIndex=fi-1}fh=fe.can("summon_file_dialog")?fg:fd;e1.addEvent(fh,"mouseover",function(){fc.trigger("mouseenter")},fc.uid);e1.addEvent(fh,"mouseout",function(){fc.trigger("mouseleave")},fc.uid);e1.addEvent(fh,"mousedown",function(){fc.trigger("mousedown")},fc.uid);e1.addEvent(e3.get(ff.container),"mouseup",function(){fc.trigger("mouseup")},fc.uid);fg=null}());e9.call(this);fd=null},getFiles:function(){return e8},disable:function(fd){var fc;if((fc=e3.get(fa))){fc.disabled=!!fd}},destroy:function(){var fd=this.getRuntime(),fc=fd.getShimContainer();e1.removeAllEvents(fc,this.uid);e1.removeAllEvents(e7&&e3.get(e7.container),this.uid);e1.removeAllEvents(e7&&e3.get(e7.browse_button),this.uid);if(fc){fc.innerHTML=""}fa=e8=fb=e7=null}})}return(e4.FileInput=e5)});eZ("moxie/runtime/html4/file/FileReader",["moxie/runtime/html4/Runtime","moxie/runtime/html5/file/FileReader"],function(e0,e1){return(e0.FileReader=e1)});eZ("moxie/runtime/html4/xhr/XMLHttpRequest",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Url","moxie/core/Exceptions","moxie/core/utils/Events","moxie/file/Blob","moxie/xhr/FormData","moxie/core/JSON"],function(e5,e1,e4,e0,e6,e8,e3,e9,e2){function e7(){var fc,fa,fd;function fb(fe){var fj=this,fh,fi,ff,fg,fk=false;if(!fd){return}fh=fd.id.replace(/_iframe$/,"");fi=e4.get(fh+"_form");if(fi){ff=fi.getElementsByTagName("input");fg=ff.length;while(fg--){switch(ff[fg].getAttribute("type")){case"hidden":ff[fg].parentNode.removeChild(ff[fg]);break;case"file":fk=true;break}}ff=[];if(!fk){fi.parentNode.removeChild(fi)}fi=null}setTimeout(function(){e8.removeEvent(fd,"load",fj.uid);if(fd.parentNode){fd.parentNode.removeChild(fd)}var fl=fj.getRuntime().getShimContainer();if(!fl.children.length){fl.parentNode.removeChild(fl)}fl=fd=null;fe()},1)}e1.extend(this,{send:function(fm,fg){var fi=this,fl=fi.getRuntime(),fh,ff,fk,fe;fc=fa=null;function fj(){var fn=fl.getShimContainer()||document.body,fo=document.createElement("div");fo.innerHTML='<iframe id="'+fh+'_iframe" name="'+fh+'_iframe" src="javascript:&quot;&quot;" style="display:none"></iframe>';fd=fo.firstChild;fn.appendChild(fd);e8.addEvent(fd,"load",function(){var fq;try{fq=fd.contentWindow.document||fd.contentDocument||window.frames[fd.id].document;if(/^4\d{2}\s/.test(fq.title)&&fq.getElementsByTagName("address").length){fc=fq.title.replace(/^(\d+).*$/,"$1")}else{fc=200;fa=e1.trim(fq.body.innerHTML);fi.trigger({type:"progress",loaded:fa.length,total:fa.length});if(fe){fi.trigger({type:"uploadprogress",loaded:fe.size||1025,total:fe.size||1025})}}}catch(fp){if(e0.hasSameOrigin(fm.url)){fc=404}else{fb.call(fi,function(){fi.trigger("error")});return}}fb.call(fi,function(){fi.trigger("load")})},fi.uid)}if(fg instanceof e9&&fg.hasBlob()){fe=fg.getBlob();fh=fe.uid;fk=e4.get(fh);ff=e4.get(fh+"_form");if(!ff){throw new e6.DOMException(e6.DOMException.NOT_FOUND_ERR)}}else{fh=e1.guid("uid_");ff=document.createElement("form");ff.setAttribute("id",fh+"_form");ff.setAttribute("method",fm.method);ff.setAttribute("enctype","multipart/form-data");ff.setAttribute("encoding","multipart/form-data");ff.setAttribute("target",fh+"_iframe");fl.getShimContainer().appendChild(ff)}if(fg instanceof e9){fg.each(function(fp,fn){if(fp instanceof e3){if(fk){fk.setAttribute("name",fn)}}else{var fo=document.createElement("input");e1.extend(fo,{type:"hidden",name:fn,value:fp});ff.appendChild(fo)}})}ff.setAttribute("action",fm.url);fj();ff.submit();fi.trigger("loadstart")},getStatus:function(){return fc},getResponse:function(fe){if("json"===fe){if(e1.typeOf(fa)==="string"){try{return e2(fa.replace(/^\s*<pre[^>]*>/,"").replace(/<\/pre>\s*$/,""))}catch(ff){return null}}}else{if("document"===fe){}}return fa},abort:function(){var fe=this;if(fd&&fd.contentWindow){if(fd.contentWindow.stop){fd.contentWindow.stop()}else{if(fd.contentWindow.document.execCommand){fd.contentWindow.document.execCommand("Stop")}else{fd.src="about:blank"}}}fb.call(this,function(){fe.dispatchEvent("abort")})}})}return(e5.XMLHttpRequest=e7)});eZ("moxie/runtime/html4/image/Image",["moxie/runtime/html4/Runtime","moxie/runtime/html5/image/Image"],function(e1,e0){return(e1.Image=e0)});T(["moxie/core/utils/Basic","moxie/core/I18n","moxie/core/utils/Mime","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/file/Blob","moxie/file/File","moxie/file/FileInput","moxie/file/FileDrop","moxie/runtime/RuntimeTarget","moxie/file/FileReader","moxie/core/utils/Url","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/xhr/XMLHttpRequest","moxie/runtime/Transporter","moxie/core/JSON","moxie/image/Image","moxie/core/utils/Events"])})(this);(function(){var eU={},eT=moxie.core.utils.Basic.inArray;(function T(eW){var eV,eX;for(eV in eW){eX=typeof(eW[eV]);if(eX==="object"&&!~eT(eV,["Exceptions","Env","Mime"])){T(eW[eV])}else{if(eX==="function"){eU[eV]=eW[eV]}}}})(window.moxie);eU.Env=window.moxie.core.utils.Env;eU.Mime=window.moxie.core.utils.Mime;eU.Exceptions=window.moxie.core.Exceptions;window.mOxie=eU;if(!window.o){window.o=eU}return eU})();(function(eW,eY,eV){var eU=eW.setTimeout,eX={};function T(e0){var eZ=e0.required_features,e1={};function e2(e4,e5,e3){var e6={chunks:"slice_blob",resize:"send_binary_string",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",max_file_size:"access_binary",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};if(e6[e4]){e1[e6[e4]]=e5}else{if(!e3){e1[e4]=e5}}}if(typeof(eZ)==="string"){eT.each(eZ.split(/\s*,\s*/),function(e3){e2(e3,true)})}else{if(typeof(eZ)==="object"){eT.each(eZ,function(e4,e3){e2(e3,e4)})}else{if(eZ===true){if(!e0.multipart){e1.send_binary_string=true}if(e0.chunk_size>0){e1.slice_blob=true}eT.each(e0,function(e4,e3){e2(e3,!!e4,true)})}}}return e1}var eT={VERSION:"2.0.0beta",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:eY.mimes,ua:eY.ua,typeOf:eY.typeOf,extend:eY.extend,guid:eY.guid,each:eY.each,getPos:eY.getPos,getSize:eY.getSize,xmlEncode:function(e0){var e1={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},eZ=/[<>&\"\']/g;return e0?(""+e0).replace(eZ,function(e2){return e1[e2]?"&"+e1[e2]+";":e2}):e0},toArray:eY.toArray,inArray:eY.inArray,addI18n:eY.addI18n,translate:eY.translate,isEmptyObj:eY.isEmptyObj,hasClass:eY.hasClass,addClass:eY.addClass,removeClass:eY.removeClass,getStyle:eY.getStyle,addEvent:eY.addEvent,removeEvent:eY.removeEvent,removeAllEvents:eY.removeAllEvents,cleanName:function(eZ){var e0,e1;e1=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(e0=0;e0<e1.length;e0+=2){eZ=eZ.replace(e1[e0],e1[e0+1])}eZ=eZ.replace(/\s+/g,"_");eZ=eZ.replace(/[^a-z0-9_\-\.]+/gi,"");return eZ},buildUrl:function(e0,eZ){var e1="";eT.each(eZ,function(e3,e2){e1+=(e1?"&":"")+encodeURIComponent(e2)+"="+encodeURIComponent(e3)});if(e1){e0+=(e0.indexOf("?")>0?"&":"?")+e1}return e0},formatSize:function(eZ){if(eZ===eV||/\D/.test(eZ)){return eT.translate("N/A")}if(eZ>1099511627776){return Math.round(eZ/1099511627776,1)+" "+eT.translate("tb")}if(eZ>1073741824){return Math.round(eZ/1073741824,1)+" "+eT.translate("gb")}if(eZ>1048576){return Math.round(eZ/1048576,1)+" "+eT.translate("mb")}if(eZ>1024){return Math.round(eZ/1024,1)+" "+eT.translate("kb")}return eZ+" "+eT.translate("b")},parseSize:eY.parseSizeStr,predictRuntime:function(e1,e0){var eZ,e2;if(e0){e1.runtimes=e0}eZ=new eT.Uploader(e1);e2=eZ.runtime;eZ.destroy();return e2},addFileFilter:function(e0,eZ){eX[e0]=eZ}};eT.addFileFilter("mime_types",(function(){var e0,e1;function eZ(e2){var e3=[];eT.each(e2,function(e4){eT.each(e4.extensions.split(/,/),function(e5){if(/^\s*\*\s*$/.test(e5)){e3.push("\\.*")}else{e3.push("\\."+e5.replace(new RegExp("["+("/^$.*+?|()[]{}\\".replace(/./g,"\\$&"))+"]","g"),"\\$&"))}})});return new RegExp("("+e3.join("|")+")$","i")}return function(e4,e3,e2){if(!e1||e4!=e0){e1=eZ(e4);e0=[].slice.call(e4)}if(!e1.test(e3.name)){this.trigger("Error",{code:eT.FILE_EXTENSION_ERROR,message:eT.translate("File extension error."),file:e3});e2(false)}else{e2(true)}}}()));eT.addFileFilter("max_file_size",function(e2,e0,eZ){var e1;if(e0.size!==e1&&e2&&e0.size>e2){this.trigger("Error",{code:eT.FILE_SIZE_ERROR,message:eT.translate("File size error."),file:e0});eZ(false)}else{eZ(true)}});eT.addFileFilter("prevent_duplicates",function(e2,e0,eZ){if(e2){var e1=this.files.length;while(e1--){if(e0.name===this.files[e1].name&&e0.size===this.files[e1].size){this.trigger("Error",{code:eT.FILE_DUPLICATE_ERROR,message:eT.translate("Duplicate file error."),file:e0});eZ(false);return}}}eZ(true)});eT.Uploader=function(e3){var e0=[],fd={},fa={},e2,e8,e5=false,e6,e7,fc;function e1(){var fg,fh=0,ff;if(this.state==eT.STARTED){for(ff=0;ff<e0.length;ff++){if(!fg&&e0[ff].status==eT.QUEUED){fg=e0[ff];if(this.trigger("BeforeUpload",fg)){fg.status=eT.UPLOADING;this.trigger("UploadFile",fg)}}else{fh++}}if(fh==e0.length){if(this.state!==eT.STOPPED){this.state=eT.STOPPED;this.trigger("StateChanged")}this.trigger("UploadComplete",e0)}}}function fb(ff){ff.percent=ff.size>0?Math.ceil(ff.loaded/ff.size*100):100;e4()}function e4(){var fg,ff;e8.reset();for(fg=0;fg<e0.length;fg++){ff=e0[fg];if(ff.size!==eV){e8.size+=ff.origSize;e8.loaded+=ff.loaded*ff.origSize/ff.size}else{e8.size=eV}if(ff.status==eT.DONE){e8.uploaded++}else{if(ff.status==eT.FAILED){e8.failed++}else{e8.queued++}}}if(e8.size===eV){e8.percent=e0.length>0?Math.ceil(e8.uploaded/e0.length*100):0}else{e8.bytesPerSec=Math.ceil(e8.loaded/((+new Date()-e2||1)/1000));e8.percent=e8.size>0?Math.ceil(e8.loaded/e8.size*100):0}}function eZ(){var ff=this,fh=0;var fg={accept:e3.filters.mime_types,runtime_order:e3.runtimes,required_caps:fa,swf_url:e3.flash_swf_url,xap_url:e3.silverlight_xap_url};eT.each(e3.runtimes.split(/\s*,\s*/),function(fi){if(e3[fi]){fg[fi]=e3[fi]}});eY.inSeries([function(fi){if(e3.browse_button){e6=new eY.FileInput(eT.extend({},fg,{name:e3.file_data_name,multiple:e3.multi_selection,container:e3.container,browse_button:e3.browse_button}));e6.onready=function(){var fj=eY.Runtime.getInfo(this.ruid);eY.extend(ff.features,{chunks:fj.can("slice_blob"),multipart:fj.can("send_multipart"),multi_selection:fj.can("select_multiple")});fh++;fi()};e6.onchange=function(){ff.addFile(this.files)};e6.bind("mouseenter mouseleave mousedown mouseup",function(fk){if(!e5){var fj=eY.get(e3.browse_button);if(fj){if(e3.browse_button_hover){if("mouseenter"===fk.type){eY.addClass(fj,e3.browse_button_hover)}else{if("mouseleave"===fk.type){eY.removeClass(fj,e3.browse_button_hover)}}}if(e3.browse_button_active){if("mousedown"===fk.type){eY.addClass(fj,e3.browse_button_active)}else{if("mouseup"===fk.type){eY.removeClass(fj,e3.browse_button_active)}}}fj=null}}});e6.bind("error runtimeerror",function(){e6=null;fi()});e6.init()}else{fi()}},function(fi){if(e3.drop_element){e7=new eY.FileDrop(eT.extend({},fg,{drop_zone:e3.drop_element}));e7.onready=function(){var fj=eY.Runtime.getInfo(this.ruid);ff.features.dragdrop=fj.can("drag_and_drop");fh++;fi()};e7.ondrop=function(){ff.addFile(this.files)};e7.bind("error runtimeerror",function(){e7=null;fi()});e7.init()}else{fi()}}],function(){if(typeof(e3.init)=="function"){e3.init(ff)}else{eT.each(e3.init,function(fj,fi){ff.bind(fi,fj)})}if(fh){ff.trigger("PostInit")}else{ff.trigger("Error",{code:eT.INIT_ERROR,message:eT.translate("Init error.")})}})}function fe(fg,ff){if(fg.ruid){var fh=eY.Runtime.getInfo(fg.ruid);if(fh){return fh.can(ff)}}return false}function e9(fh,fj,ff){var fg=new eY.Image();try{fg.onload=function(){fg.downsize(fj.width,fj.height,fj.crop,fj.preserve_headers)};fg.onresize=function(){ff(this.getAsBlob(fh.type,fj.quality));this.destroy()};fg.onerror=function(){ff(fh)};fg.load(fh)}catch(fi){ff(fh)}}e8=new eT.QueueProgress();e3=eT.extend({runtimes:eY.Runtime.order,max_retries:0,multipart:true,multi_selection:true,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",send_chunk_number:true},e3);if(e3.resize){e3.resize=eT.extend({preserve_headers:true,crop:false},e3.resize)}if(eT.typeOf(e3.filters)==="array"){e3.filters={mime_types:e3.filters}}e3.filters=eT.extend({mime_types:[],prevent_duplicates:!!e3.prevent_duplicates,max_file_size:e3.max_file_size},e3.filters);e3.filters.max_file_size=eT.parseSize(e3.filters.max_file_size)||0;e3.chunk_size=eT.parseSize(e3.chunk_size)||0;e3.required_features=fa=T(eT.extend({},e3));eT.extend(this,{id:eT.guid(),state:eT.STOPPED,features:{},runtime:eY.Runtime.thatCan(fa,e3.runtimes),files:e0,settings:e3,total:e8,init:function(){var ff=this;e3.browse_button=eY.get(e3.browse_button);e3.drop_element=eY.get(e3.drop_element);if(typeof(e3.preinit)=="function"){e3.preinit(ff)}else{eT.each(e3.preinit,function(fh,fg){ff.bind(fg,fh)})}if(!e3.browse_button||!e3.url){this.trigger("Error",{code:eT.INIT_ERROR,message:eT.translate("Init error.")});return}ff.bind("FilesAdded",function(fh,fg){[].push.apply(e0,fg);eU(function(){ff.trigger("QueueChanged");ff.refresh()},1)});ff.bind("CancelUpload",function(){if(fc){fc.abort()}});if(e3.unique_names){ff.bind("BeforeUpload",function(fg,fh){var fj=fh.name.match(/\.([^.]+)$/),fi="part";if(fj){fi=fj[1]}fh.target_name=fh.id+"."+fi})}ff.bind("UploadFile",function(fo,fl){var fi=fo.settings.url,fj=fo.features,fm=e3.chunk_size,fp=e3.max_retries,fg,fn=0;if(fl.loaded){fn=fl.loaded=fm*Math.floor(fl.loaded/fm)}function fk(){if(fp-->0){eU(fh,1)}else{fl.loaded=fn;fo.trigger("Error",{code:eT.HTTP_ERROR,message:eT.translate("HTTP Error."),file:fl,response:fc.responseText,status:fc.status,responseHeaders:fc.getAllResponseHeaders()})}}function fh(){var fs,fr,fq,ft;if(fl.status==eT.DONE||fl.status==eT.FAILED||fo.state==eT.STOPPED){return}fq={name:fl.target_name||fl.name};if(fm&&fj.chunks&&fg.size>fm){ft=Math.min(fm,fg.size-fn);fs=fg.slice(fn,fn+ft)}else{ft=fg.size;fs=fg}if(fm&&fj.chunks){if(e3.send_chunk_number){fq.chunk=Math.ceil(fn/fm);fq.chunks=Math.ceil(fg.size/fm)}else{fq.offset=fn;fq.total=fg.size}}else{fq.chunk=0;fq.chunks=1}fc=new eY.XMLHttpRequest();fc.withCredentials=true;if(fc.upload){fc.upload.onprogress=function(fu){fl.loaded=Math.min(fl.size,fn+fu.loaded);fo.trigger("UploadProgress",fl)}}fc.onload=function(){if(fc.status>=400){fk();return}if(ft<fg.size){fs.destroy();fn+=ft;fl.loaded=Math.min(fn,fg.size);fo.trigger("ChunkUploaded",fl,{offset:fl.loaded,total:fg.size,response:fc.responseText,status:fc.status,responseHeaders:fc.getAllResponseHeaders()});if(eY.Env.browser==="Android Browser"){fo.trigger("UploadProgress",fl)}}else{fl.loaded=fl.size}fs=fr=null;if(!fn||fn>=fg.size){if(fl.size!=fl.origSize){fg.destroy();fg=null}fo.trigger("UploadProgress",fl);fl.status=eT.DONE;fo.trigger("FileUploaded",fl,{response:fc.responseText,status:fc.status,responseHeaders:fc.getAllResponseHeaders()})}else{fp=e3.max_retries;eU(fh,1)}};fc.onerror=function(){fk()};fc.onloadend=function(){this.destroy();fc=null};if(fo.settings.multipart&&fj.multipart){fq.name=fl.target_name||fl.name;fc.open("post",fi,true);eT.each(fo.settings.headers,function(fv,fu){fc.setRequestHeader(fu,fv)});fr=new eY.FormData();eT.each(eT.extend(fq,fo.settings.multipart_params),function(fv,fu){fr.append(fu,fv)});fr.append(fo.settings.file_data_name,fs);fc.send(fr,{runtime_order:fo.settings.runtimes,required_caps:fa,swf_url:fo.settings.flash_swf_url,xap_url:fo.settings.silverlight_xap_url})}else{fi=eT.buildUrl(fo.settings.url,eT.extend(fq,fo.settings.multipart_params));fc.open("post",fi,true);fc.setRequestHeader("Content-Type","application/octet-stream");eT.each(fo.settings.headers,function(fv,fu){fc.setRequestHeader(fu,fv)});fc.send(fs,{runtime_order:fo.settings.runtimes,required_caps:fa,swf_url:fo.settings.flash_swf_url,xap_url:fo.settings.silverlight_xap_url})}}fg=fl.getSource();if(!eY.isEmptyObj(fo.settings.resize)&&fe(fg,"send_binary_string")&&!!~eY.inArray(fg.type,["image/jpeg","image/png"])){e9.call(this,fg,fo.settings.resize,function(fq){fg=fq;fl.size=fq.size;fh()})}else{fh()}});ff.bind("UploadProgress",function(fg,fh){fb(fh)});ff.bind("StateChanged",function(fg){if(fg.state==eT.STARTED){e2=(+new Date())}else{if(fg.state==eT.STOPPED){for(var fh=fg.files.length-1;fh>=0;fh--){if(fg.files[fh].status==eT.UPLOADING){fg.files[fh].status=eT.QUEUED;e4()}}}}});ff.bind("QueueChanged",e4);ff.bind("Error",function(fg,fh){if(fh.file){fh.file.status=eT.FAILED;fb(fh.file);if(fg.state==eT.STARTED){eU(function(){e1.call(ff)},1)}}});ff.bind("FileUploaded",function(){e4();eU(function(){e1.call(ff)},1)});ff.trigger("Init",{runtime:this.runtime});eZ.call(this)},refresh:function(){if(e6){e6.trigger("Refresh")}this.trigger("Refresh")},start:function(){if(this.state!=eT.STARTED){this.state=eT.STARTED;this.trigger("StateChanged");e1.call(this)}},stop:function(){if(this.state!=eT.STOPPED){this.state=eT.STOPPED;this.trigger("StateChanged");this.trigger("CancelUpload")}},disableBrowse:function(){e5=arguments[0]!==eV?arguments[0]:true;if(e6){e6.disable(e5)}this.trigger("DisableBrowse",e5)},getFile:function(fg){var ff;for(ff=e0.length-1;ff>=0;ff--){if(e0[ff].id===fg){return e0[ff]}}},addFile:function(fg,fh){var fm=this,fj=[],ff=[],fl;function fi(){var fo=e7||e6;if(fo){return fo.getRuntime().uid}return false}function fk(fq,fp){var fo=[];eY.each(fm.settings.filters,function(fs,fr){if(eX[fr]){fo.push(function(ft){eX[fr].call(fm,fs,fq,function(fu){ft(!fu)})})}});eY.inSeries(fo,fp)}function fn(fo){var fp=eY.typeOf(fo);if(fo instanceof eY.File){if(!fo.ruid&&!fo.isDetached()){if(!fl){return false}fo.ruid=fl;fo.connectRuntime(fl)}fn(new eT.File(fo))}else{if(fo instanceof eY.Blob){fn(fo.getSource());fo.destroy()}else{if(fo instanceof eT.File){if(fh){fo.name=fh}fj.push(function(fq){fk(fo,function(fr){if(!fr){ff.push(fo)}fq()})})}else{if(eY.inArray(fp,["file","blob"])!==-1){fn(new eY.File(null,fo))}else{if(fp==="node"&&eY.typeOf(fo.files)==="filelist"){eY.each(fo.files,fn)}else{if(fp==="array"){fh=null;eY.each(fo,fn)}}}}}}}fl=fi();fn(fg);if(fj.length){eY.inSeries(fj,function(){if(ff.length){fm.trigger("FilesAdded",ff)}})}},removeFile:function(fg){var fh=typeof(fg)==="string"?fg:fg.id;for(var ff=e0.length-1;ff>=0;ff--){if(e0[ff].id===fh){return this.splice(ff,1)[0]}}},splice:function(fh,ff){var fg=e0.splice(fh===eV?0:fh,ff===eV?e0.length:ff);this.trigger("FilesRemoved",fg);this.trigger("QueueChanged");eT.each(fg,function(fi){fi.destroy()});return fg},trigger:function(fg){var fi=fd[fg.toLowerCase()],fh,ff;if(fi){ff=Array.prototype.slice.call(arguments);ff[0]=this;for(fh=0;fh<fi.length;fh++){if(fi[fh].func.apply(fi[fh].scope,ff)===false){return false}}}return true},hasEventListener:function(ff){return !!fd[ff.toLowerCase()]},bind:function(ff,fh,fg){var fi;ff=ff.toLowerCase();fi=fd[ff]||[];fi.push({func:fh,scope:fg||this});fd[ff]=fi},unbind:function(ff){ff=ff.toLowerCase();var fi=fd[ff],fg,fh=arguments[1];if(fi){if(fh!==eV){for(fg=fi.length-1;fg>=0;fg--){if(fi[fg].func===fh){fi.splice(fg,1);break}}}else{fi=[]}if(!fi.length){delete fd[ff]}}},unbindAll:function(){var ff=this;eT.each(fd,function(fh,fg){ff.unbind(fg)})},destroy:function(){this.stop();eT.each(e0,function(ff){ff.destroy()});e0=[];if(e6){e6.destroy();e6=null}if(e7){e7.destroy();e7=null}fa={};e2=e8=e5=fc=null;this.trigger("Destroy");this.unbindAll();fd={}}})};eT.File=(function(){var e0={};function eZ(e1){eT.extend(this,{id:eT.guid(),name:e1.name||e1.fileName,type:e1.type||"",size:e1.size||e1.fileSize,origSize:e1.size||e1.fileSize,loaded:0,percent:0,status:eT.QUEUED,lastModifiedDate:e1.lastModifiedDate||(new Date()).toLocaleString(),getNative:function(){var e2=this.getSource().getSource();return eY.inArray(eY.typeOf(e2),["blob","file"])!==-1?e2:null},getSource:function(){if(!e0[this.id]){return null}return e0[this.id]},destroy:function(){var e2=this.getSource();if(e2){e2.destroy();delete e0[this.id]}}});e0[this.id]=e1}return eZ}());eT.QueueProgress=function(){var eZ=this;eZ.size=0;eZ.loaded=0;eZ.uploaded=0;eZ.failed=0;eZ.queued=0;eZ.percent=0;eZ.bytesPerSec=0;eZ.reset=function(){eZ.size=eZ.loaded=eZ.uploaded=eZ.failed=eZ.queued=eZ.percent=eZ.bytesPerSec=0}};eW.plupload=eT}(window,mOxie));var ej,al,cL,dz,cn,dJ,be,bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1};cn=INLINE_JS.Upload=B.Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",CHOOSE_FILE_BASIC:"db:upload:choose_file_basic",APPLE_PACKAGE_EXTENSIONS:["pages","key","app","numbers","band","photolibrary","rcproject","rtfd","graffle","logic","logicx","lpdf","sketch","screenflow","scriv","dvdproj","mindnode","cmproj","xcodeproj","imovielibrary","mpkg","imovieproject","1password","agilekeychain","fcpbundle","abbu","mindnode","theater","gameproj","aplibrary","itlp","lrdata","ydevice","bundle","framework","plugin","kext","pkg"],APPLE_PACKAGE_ERROR:-54321,current_dest:"",runtimes:(function(){var eU,eT,eV,T;eV={"MSIE 8.0":"flash","MSIE 9.0":"flash"};eT="html5";for(eU in eV){T=eV[eU];if(navigator.userAgent.indexOf(eU)!==-1){eT=T}}return eT})(),choose_button_id:"choose-button",set_dest:function(T){c9.fillVal(T,"dest-folder");return this.current_dest=T},init:function(eU,eV,eW,eT){var T;this.set_dest(eU);T=this.initPLU(eW,eT);if(!eV){ah.window_load(T)}else{T()}br("#flash-upload-container > .moxie-shim").each(function(eX){if(eX.observe){dL.freshbutton_overlay(eX,$("choose-button"));return dL.freshbutton_overlay(eX,$("add-button"))}});return al.clear()},init_basic:function(){dL.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("file-box").observe("click",function(T){return document.fire(cn.CHOOSE_FILE_BASIC)});$("basic-choose-button").observe("mousemove",function(eU){var eT,T,eV;eT=$("modal").cumulativeOffset();eV=eU.clientY-eT.top-3;T=eU.clientX-eT.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:eV+"px",left:T+"px"})});return $("file-box").observe("change",function(){var eW,eU,eX,eV,T,eT;eM.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();eU=$("file-box").getValue().split("\\").pop();eV=cj.make("web",au.file_icon(eU));$("basic-upload-status").down(".icon").__date(eV);eW=ef("Uploading %(filename)s").format({filename:bG.em_snippet(eU,25)});$("basic-upload-status").down(".file-desc").__date(eW);$("basic-upload-status").show();$("basic-uploading-message").show();eX=$("file-box").files;eT=0;if(eX){T=eX[0].lastModifiedDate;if(T){eT=Math.round(Date.parse(T)/1000)||0}}if(!eT){eT=Math.round(Date.parse(new Date)/1000)}$("mtime-utc").value=eT;return $("basic-upload-form").submit()})},initPLU:function(eT,T){return(function(eU){return function(){var eW,eV;eW={url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:eU.runtimes,multipart_params:{},multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:eU.choose_button_id,container:"flash-upload-container",preinit:{PostInit:function(){if(eT){eT()}return eU.uploaderLoaded()},Error:eU.uploadError.bind(eU)},init:{FilesAdded:eU.fileQueued.bind(eU),UploadProgress:eU.uploadProgress.bind(eU),FileUploaded:eU.uploadSuccess.bind(eU),BeforeUpload:eU.prepareFileForUploading.bind(eU),ChunkUploaded:eU.chunkUploaded.bind(eU),UploadComplete:al.finished.bind(al),Refresh:function(){if(eU.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){br("#flash-upload-container").clonePosition(br("#add-button"));br("#flash-upload-container > .moxie-shim")[0].style.width="100%";return br("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:Constants.static_url_moxie_swf};if(T!=null){br.extend(eW,T)}eV=new plupload.Uploader(eW);eU.PLU=eV;return eU.PLU.init()}})(this)},reset:function(){if(al.uploading&&al.current_file){this.PLU.removeFile(al.current_file)}return cL.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return cL.show()}},updatePostParams:function(eU){var eT,T;T=this.PLU.settings.multipart_params;for(eT in eU){if(eU.hasOwnProperty(eT)){T[eT]=eU[eT]}}return this.PLU.settings.multipart_params=T},fileQueued:function(eT,eX){var eW,eV,T,eU;for(eV=0,T=eX.length;eV<T;eV++){eW=eX[eV];if((typeof eW.getNative==="function"?(eU=eW.getNative())!=null?eU.dest:void 0:void 0)===void 0){eW.dest=cn.current_dest}else{eW.dest=eW.getNative().dest}}document.fire(this.QUEUE_EVT,{files:eX});br(document).trigger(this.QUEUE_EVT,{files:eX});if(W.is_quicksend_dest(eW.dest)){return}return this.show_upload()},uploadNext:function(){var eU,T,eT,eV;eT=al.next();T=($u.contains(cn.APPLE_PACKAGE_EXTENSIONS,au.file_extension_for_logging(eT.name))&&eT.size%34===0)||(au.file_extension_for_logging(eT.name)===""&&eT.size%34===0&&eT.size<=3400);if(T){eT.status=plupload.FAILED;eU={file:eT,code:cn.APPLE_PACKAGE_ERROR,message:ef("Can\u2019t Upload"),tooltip_text:ef('To upload a package file via the web, try zipping it first, or <a href="https://www.dropbox.com/help/6691" target="_blank">learn more</a>.'),response:"",responseHeaders:"",status:400};this.uploadError(this.PLU,eU);return false}eV={dest:al.next().dest,t:bk.read(Constants.JS_CSRF_COOKIE)};eV[Constants.UID_PARAM_NAME]=cf.active_user;cn.updatePostParams(eV);this.PLU.start();al.last_update_time=0;al.last_update_size=0;return true},pause:function(){return cn.PLU.stop()},uploadProgress:function(eT,T){if(!al.cancelled_files[T.id]){document.fire(this.UPDATE_EVT,{file:T,percent_complete:T.loaded/T.size});return br(document).trigger(this.UPDATE_EVT,{file:T,percent_complete:T.loaded/T.size})}},generateUploadId:function(){var T,eT,eV,eU;T="";for(eT=eU=0;eU<=15;eT=++eU){T+=String.fromCharCode(Math.floor(Math.random()*256))}eV=af.encode(T);eV=eV.replace(/\+/g,"-");eV=eV.replace(/\//g,"_");eV=eV.replace(/\=*$/,"");return eV},chunkUploaded:function(eT,eU,eV){var T;T=JSON.parse(eV.response||"");return this.updatePostParams({offset:T.offset})},prepareFileForUploading:function(){var T;T=al.next();return this.updatePostParams({reported_total_size:T.size,dest:T.dest,t:bk.read(Constants.JS_CSRF_COOKIE),upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(eW,eV,eU){var eT,T;try{T=JSON.parse(eU.response)}catch(eX){eT=eX;T=null}if(eU.response==="{'error': 'quota'}"){document.fire(this.ERROR_EVT,{file:eV,message:ef("Quota exceeded"),tooltip_text:ef("Your upload failed because you are over quota.")});return br(document).trigger(this.ERROR_EVT,{file:eV,message:ef("Quota exceeded"),tooltip_text:ef("Your upload failed because you are over quota.")})}else{if(eU.response==="{'error': 'empty'}"){document.fire(this.CANCEL_EVT,{file:eV,message:ef("Empty File")});return br(document).trigger(this.CANCEL_EVT,{file:eV,message:ef("Empty File")})}else{if(eU.response==="{'error': 'ignored'}"){document.fire(this.CANCEL_EVT,{file:eV,message:ef("File Ignored")});return br(document).trigger(this.CANCEL_EVT,{file:eV,message:ef("File Ignored")})}else{if((T!=null?T.status:void 0)==="complete"){document.fire(this.COMPLETE_EVT,{file:eV});return br(document).trigger(this.COMPLETE_EVT,{file:eV})}else{document.fire(this.ERROR_EVT,{file:eV});return br(document).trigger(this.ERROR_EVT,{file:eV})}}}}},uploadComplete:function(eT,T){document.fire(this.COMPLETE_EVT,{file:T});return br(document).trigger(this.COMPLETE_EVT,{file:T})},uploadError:function(eW,T){var eV,eT,eU;if((eU=T.file.id,bx.call(al.file_ids(),eU)<0)&&T.code!==cn.APPLE_PACKAGE_ERROR){document.fire(this.QUEUE_EVT,{files:[T.file]});br(document).trigger(this.QUEUE_EVT,{files:[T.file]})}eT=(function(){switch(T.code){case plupload.FILE_SIZE_ERROR:return ef("File too large");default:return ef("Upload Error")}})();this.show_upload();eV={file:T.file,error_code:T.code,message:eT};if(T!=null?T.tooltip_text:void 0){eV.tooltip_text=T.tooltip_text}document.fire(this.ERROR_EVT,eV);return br(document).trigger(this.ERROR_EVT,eV)},grabURL:function(){var T;T=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(T)){$("url").value=T}return true},treeview_handler:function(eT,T){var eU;c9.fillVal(eT,"dest-folder");eU=$("basic-uploader-url");if(eU){eU.href=eU.href.replace(/(\/upload)(.*)(\?basic=1)/,function(eX,eW,eY,eV){return eW+dL.urlquote(eT)+eV})}return al.clear()},new_folder:function(){bP.hide();eM.show(ef("Create new folder..."),c9.fromElm("create-folder"),{action:this.do_new_folder.bind(this,cf.active_user),wit_group:"new-folder-confirm"});if(!dL.ie){return br("#first-treeview-link").trigger("click")}},do_new_folder:function(T){var eU,eT;if(!eM.vars.selected_path){ab.error(ef("Please select a parent folder."));return}eT=$F("entered-name");eU=eM.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+dL.urlquote(eU)+"?to_path="+dL.urlquote(eT),{subject_user:T,onSuccess:(function(eV){return function(eW){eV.treeview_handler(au.normalize(eU)+"/"+eT);return bP.schedule_reset()}})(this),cleanUp:function(){}})},uploaderLoaded:function(){$("upload-loading").hide();$("choose-button").show();if(cn.PLU.runtime==="flash"){br("#flash-upload-container").clonePosition(br("#choose-button"));br("#flash-upload-container > .moxie-shim")[0].style.top="0px";br("#flash-upload-container > .moxie-shim")[0].style.left="0px";br("#flash-upload-container > .moxie-shim")[0].style.width="100%";return br("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{br("#"+this.choose_button_id).click((function(T){return function(eT){return br("#"+T.PLU.id+"_html5").click()}})(this));return br("#add-button").click((function(T){return function(eT){return br("#choose-button").click()}})(this))}}};al=B.FileQueue={init:function(){return al._listen()},_listen:function(){document.observe(cn.QUEUE_EVT,al._file_queued.bind(this));document.observe(cn.QUEUE_ERROR_EVT,al._file_queue_errored.bind(this));document.observe(cn.UPDATE_EVT,al._file_updated.bind(this));document.observe(cn.COMPLETE_EVT,al._file_completed.bind(this));document.observe(cn.ERROR_EVT,al._file_errored.bind(this));return document.observe(cn.CANCEL_EVT,al._file_cancelled.bind(this))},_file_queued:function(eX){var eU,eW,eT,eV,T;eV=eX.memo.files;T=[];for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];this.files[eU.id]=eU;if(!al.uploading){this._start_uploading()}this.current_file=eU;T.push(em("File queued:",eU.name))}return T},_file_queue_errored:function(T){this._file_queued(T);return setTimeout(((function(eT){return function(){return eT._file_errored(T)}})(this)),250)},_file_updated:function(e0){var eV,T,eT,eU,eY,eX,eW,eZ,e1;eU=e0.memo.file;eX=e0.memo.percent_complete;eY=eX*eU.size;e1=eY+this.completed_size();eT=new Date().getTime();if(this.last_update_time){eW=(eT-this.last_update_time)/1000;if(cn.PLU.total.bytesPerSec){this.average_bps=cn.PLU.total.bytesPerSec}else{T=eY-this.last_update_size;eV=T/eW;this.average_bps=((e1-T)*this.average_bps+T*eV)/e1}eZ=(this.queue_size()-e1)/this.average_bps;this.formatted_time=bR.format_time(eZ+this.num_left())}this.current_file=eU;this.last_update_time=new Date().getTime();return this.last_update_size=eY},_file_completed:function(eT){var T;T=eT.memo.file;this.completed_files[T.id]=true;em("File completed:",T.name);return this._check_if_finished(T)},_file_errored:function(eT){var T;T=eT.memo.file;this.errored_files[T.id]=true;ej.update_errors();cL.update_errors();em("File errored:",T.name);return this._check_if_finished(T)},_file_cancelled:function(eT){var T;T=eT.memo.file;this.cancelled_files[T.id]=true;if(T.status===plupload.UPLOADING){cn.PLU.stop();cn.PLU.removeFile(T);cn.PLU.start()}else{cn.PLU.removeFile(T)}em("File cancelled:",T.name);return this._check_if_finished(T)},_start_uploading:function(){var T;this.uploading=cn.uploadNext();if(this.uploading){this.all_cancelled=false;return window.onbeforeunload=T=(function(eT){return function(){return ef("Leaving this page will cancel your uploads.")}})(this)}},finished:function(){return this._finished_uploading()},_check_if_finished:function(T){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return cn.uploadNext()}},_finished_uploading:function(){var eT,eU,eV,T;this.uploading=false;if(!this.num_files()){ej.cancelled()}else{if(this.errors()){ej.errored();cL.errored()}else{ej.completed();cL.completed()}}T=$("inline-upload-status").visible();cf.select_fq_paths=[];if(cf.inside_dir){for(eV in this.completed_files){eU=this.files[eV];eT=au.normalize(eU.dest);cf.select_fq_paths.push(""+eT+"/"+eU.name)}cf.force_reload()}else{if(cf.in_search_mode()){bW.force_reload()}}if(T){cL.show()}eM.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){return $u(this.files).filter((function(T){return function(eT){return !(T.cancelled_files[eT.id]||T.errored_files[eT.id]||T.completed_files[eT.id])}})(this))[0]},cancels:function(){return $u(this.cancelled_files).keys().length},errors:function(){return $u(this.errored_files).keys().length},queue_size:function(){var eT,eX,eU,eW,T,eV;eU=0;eV=this.file_ids();for(eW=0,T=eV.length;eW<T;eW++){eX=eV[eW];eT=this.files[eX];if(!this.errored_files[eX]&&!this.cancelled_files[eX]&&typeof eT.size!=="undefined"){eU+=eT.size}}return eU},completed_size:function(){var eW,eT,eV,T,eU;eT=0;eU=$u(this.completed_files).keys();for(eV=0,T=eU.length;eV<T;eV++){eW=eU[eV];if(typeof this.files[eW].size!=="undefined"){eT+=this.files[eW].size}}return eT},file_ids:function(){return $u(this.files).map((function(T){return function(eT,eU){return eU}})(this))},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){return $u(this.file_ids()).filter((function(T){return function(eT){return !(T.cancelled_files[eT]||T.errored_files[eT]||T.completed_files[eT])}})(this)).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof eM!=="undefined"&&eM!==null){return eM.onHide=null}}};al.clear();dJ=B.UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){dJ._tmpl=eP.tmpl("upload_list_item_tmpl");return dJ._listen()},_listen:function(){document.observe(cn.QUEUE_EVT,dJ._file_queued);document.observe(cn.QUEUE_ERROR_EVT,dJ._file_queue_errored);document.observe(cn.UPDATE_EVT,dJ._file_updated);document.observe(cn.COMPLETE_EVT,dJ._file_completed);document.observe(cn.ERROR_EVT,dJ._file_errored);return document.observe(cn.CANCEL_EVT,dJ._file_cancelled)},_file_queued:function(eX){var eU,eW,eT,eV,T;eV=eX.memo.files;T=[];for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];T.push((function(eZ){var e5,eY,e2,e4,e3,e6,e0,e1;e5=eZ.dest;if(W.is_quicksend_dest(e5)){W.add_external_file(eZ);return}e6=az.format_bytes(eZ.size||0);eY=dJ._tmpl({file:eZ,icon:au.file_icon(eZ.name),filename_snippet:bG.em_snippet(eZ.name,dJ.FILENAME_SNIPPET_LENGTH),size:e6,dest:e5,dest_snippet:bG.em_snippet(ef("Dropbox")+e5,dJ.DEST_SNIPPET_LENGTH,0),Sprite:cj});$("upload-files-list").__sert(eY);e4=$(eZ.id);e3=al.num_files();if(dc.show_share_button_in_file_uploader){e2=br("#"+eZ.id);e2.find(".dest-col").hide()}e0=$("upload-files-list");if(e3<=6){e0.removeClassName("scroll")}else{e0.addClassName("scroll")}e0.scrollTop=e0.scrollHeight;e4.down(".dest").observe("click",function(){cf.reload_fqpath(e4.readAttribute("data-dest"),true);return eM.hide()});e1=e4.down(".status-col").down("a.small-x-button");e1.stopObserving("click");e1.observe("click",function(e7){document.fire(cn.CANCEL_EVT,{file:eZ});return br(document).trigger(cn.CANCEL_EVT,{file:eZ})});return e4.down(".upload-progress-bar").setStyle({width:"0"})})(eU))}return T},_file_queue_errored:function(T){dJ._file_queued(T);return dJ._file_errored(T)},_file_updated:function(eV){var eU,eW,eT,T;eU=eV.memo.file;eW=$(eU.id);if(al.num_files()===1){T=ef("%(time_left)s left").format({time_left:al.formatted_time});eW.down(".time-col").__date(T)}eT=parseInt(eU.percent,10)+"%";if(eT==="100%"){eW.down(".time-col").__date();eW.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))}return eW.down(".upload-progress-bar").setStyle({width:eT})},_file_completed:function(eT){var T,eU,eV;T=eT.memo.file;T.completed=true;eV=$(T.id);eV.addClassName("complete");if(dc.show_share_button_in_file_uploader&&!W.is_quicksend_dest(T.dest)){eU=br("#"+T.id);eU.find(".share-link").show();a0.SharedFolderActivityLogger.log("web","share_button_in_uploader_impression",cf.active_user,{});eU.on("click",function(eY){var eX,eW;eM.hide();a0.SharedFolderActivityLogger.log("web","share_button_in_uploader_click",cf.active_user,{});eX=T.dest+"/"+T.name;eW="file_uploader";return dc.shmodel(eX,eW)})}setTimeout(function(){return eV.down(".status-col").__date(cj.make("web","s_check"))},0);return eV.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(eT){var T,eU;T=eT.memo.file;eU=$(T.id);if(eU){return dJ._actual_file_errored(eT)}else{return setTimeout((function(eV){return function(){return dJ._actual_file_errored(eT)}})(this),0)}},_actual_file_errored:function(eW){var T,eU,eT,eX,eV;eT=eW.memo.file;eX=$(eT.id);eX.addClassName("error");eX.down(".dest-col").hide();eX.down(".time-col").__date();eX.down(".status-col").__date(cj.make("web","nosync"));eX.down(".upload-progress-bar").setStyle({width:"100%"});if(W.is_quicksend_dest(eT.dest)){return}eU=eW.memo.message||ef("Upload Error");T=void 0;if(eW.memo.tooltip_text){T=eW.memo.tooltip_text}else{T=ef('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website.');br(document).on("click","a#basic_link",function(){di.show_basic_upload();return false})}eX.down(".error-msg").__date(eU);eV=eX.down(".error-details");eV.observe("mouseover",function(){return dZ.show(eV,T)});return eX.down(".error-col").show()},_file_cancelled:function(eT){var T,eU;T=eT.memo.file;eU=$(T.id);eU.addClassName("cancelled");eU.down(".dest-col").__date(ef(eT.memo.message||"Canceled"));eU.down(".time-col").__date();eU.down(".status-col").__date(cj.make("web","cancelsync"));return eU.down(".upload-progress-bar").setStyle({width:"100%"})}};ej=B.BulkUpload={init:function(){this.elem=$("bulk-upload-status");return ej._listen()},_listen:function(){document.observe(cn.QUEUE_EVT,ej._file_queued.bind(this));return document.observe(cn.UPDATE_EVT,ej._file_updated.bind(this))},_file_queued:function(eT){var T;T=new Element("a",{"class":"small-x-button"});T.observe("click",function(){var eW,eY,eX,eV,eU;al.all_cancelled=true;eW=al.file_ids().slice(0);eU=[];for(eX=0,eV=eW.length;eX<eV;eX++){eY=eW[eX];if(!al.completed_files[eY]&&!al.errored_files[eY]){document.fire(cn.CANCEL_EVT,{file:al.files[eY]});eU.push(br(document).trigger(cn.CANCEL_EVT,{file:al.files[eY]}))}else{eU.push(void 0)}}return eU});return this.elem.down(".status").__date(T)},_file_updated:function(eV){var eU,eT,T;if(al.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");eU=a1("%d file","%d files",al.num_non_cancelled_files()).format(al.num_non_cancelled_files());this.elem.down(".num-files").__date(eU);eT=ef("- %(size)s").format({size:az.format_bytes(cn.PLU.total.size)});this.elem.down(".size").__date(eT);if(al.formatted_time){T=ef("%(time_left)s left").format({time_left:al.formatted_time});this.elem.down(".time-left").__date(T)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(al.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(cn.PLU.runtime==="flash"){return br("#flash-upload-container").clonePosition(br("#add-button"))}}},update_errors:function(){var T;T=a1("- %d error","- %d errors",al.errors()).format(al.errors());return $("bulk-upload-status").down(".num-errors").__date(T)},completed:function(){var eT,T;$("hide-button").hide();$("done-button").show();if(al.num_files()>1){this.elem.addClassName("complete");eT=a1("Uploaded %d file","Uploaded %d files",al.num_non_cancelled_files()).format(al.num_non_cancelled_files());this.elem.down(".num-files").__date(eT);T=ef("- %(size)s").format({size:az.format_bytes(al.completed_size())});this.elem.down(".size").__date(T);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cj.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var T;$("hide-button").hide();$("done-button").show();this.completed();T=a1("- %d error","- %d errors",al.errors()).format(al.errors());return this.elem.down(".num-errors").__date(T)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(al.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(ef("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cj.make("web","cancelsync"));return this.elem.down(".upload-progress-bar").style.width="100%"}}};cL=B.InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(cn.QUEUE_EVT,cL._file_queued.bind(this));return document.observe(cn.UPDATE_EVT,cL._file_updated.bind(this))},_file_queued:function(eU){var eT,T;eT=$("inline-upload-status");eT.removeClassName("error");eT.removeClassName("complete");eT.down(".icon").__date(cj.make("web","s_sync"));eT.down(".file-desc").__date(ef("Starting upload..."));eT.down(".num-errors").__date();T=a1("%d file","%d files",al.num_left()).format(al.num_left());eT.down(".view-details").__date(T);eT.down(".status").__date();return eT.down(".inline-upload-progress").style.width="0%"},_file_updated:function(eY){var eX,eU,eV,eW,eT,T;eX=$("inline-upload-status");eU=eY.memo.file;eX.down(".icon").__date(cj.make("web","s_sync"));eV=ef("Uploading %(filename)s").format({filename:bG.em_snippet(eU.name,this.FILENAME_SNIPPET_LENGTH)});eX.down(".file-desc").__date(eV);if(al.num_left()>1){T=a1("%d file left","%d files left",al.num_left()-1).format(al.num_left()-1);eX.down(".view-details").__date(T)}else{eX.down(".view-details").__date(ef("View details"))}if(al.formatted_time){eT=ef("%(time_left)s left").format({time_left:al.formatted_time});eX.down(".status").__date(eT)}eW=eU.percent+"%";return eX.down(".inline-upload-progress").style.width=eW},update_errors:function(){var T,eT;T=$("inline-upload-status");eT=a1("- %d error","- %d errors",al.errors()).format(al.errors());return T.down(".num-errors").__date(eT)},add_x_button:function(){var T,eT;eT=new Element("a",{"class":"small-x-button"});eT.observe("click",function(){cL.hide();return cn.reset()});T=$("inline-upload-status");return T.down(".status").__date(eT)},completed:function(){var eT,T;eT=$("inline-upload-status");eT.addClassName("complete");eT.removeClassName("error");eT.down(".icon").__date(cj.make("web","s_check"));if(al.num_files()>1){T=ef("Uploaded %(num_files)d files").format({num_files:al.num_non_cancelled_files()})}else{T=ef("Uploaded %(filename)s").format({filename:bG.em_snippet(al.current_file.name,this.FILENAME_SNIPPET_LENGTH)})}eT.down(".file-desc").__date(T);eT.down(".num-errors").__date();eT.down(".view-details").__date(ef("View details"));this.add_x_button();return eT.down(".inline-upload-progress").style.width="100%"},errored:function(){var eU,eT,T,eV;eU=$("inline-upload-status");eU.addClassName("error");eU.removeClassName("complete");eU.down(".icon").__date(cj.make("web","nosync"));eT=void 0;if(al.num_files()>1){eT=ef("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:al.num_non_cancelled_files()-al.errors(),num_files:al.num_non_cancelled_files()});eU.down(".file-desc").__date(eT);eV=a1("- %d error","- %d errors",al.errors()).format(al.errors());eU.down(".num-errors").__date(eV)}else{if(al.current_file!=null){T=bG.em_snippet(al.current_file.name,this.FILENAME_SNIPPET_LENGTH)}eT=T?ef("Unable to upload %(filename)s").format({filename:T}):ef("Unable to upload file");eU.down(".file-desc").__date(eT);eU.down(".num-errors").__date()}eU.down(".view-details").__date(ef("View details"));this.add_x_button();return eU.down(".inline-upload-progress").style.width="100%"},show:function(T){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};be=B.UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return be.supported()&&cf.inside_dir&&!(cf.in_search_mode()&&bW.fulltext_search_enabled)},browse_indicators_enabled:function(){var eV,eT,eU,T;if(!be.enabled()){return false}eT=["file-preview-modal","modal-overlay"];if(cn.choose_button_id.startsWith("wizard-")){eT.push("wizard-overlay")}for(eU=0,T=eT.length;eU<T;eU++){eV=eT[eU];if($(eV).visible()){return false}}return true},modal_indicators_enabled:function(){var T;return be.enabled()&&br("#modal #upload-modal-dropzone").length&&br("#modal").visible()&&((T=br("#modal").offset())!=null?T.left:void 0)>0},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(T){return br(T).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(eT){var T;if(!be._drop_indicators){if(be.modal_indicators_enabled()){T=$("upload-modal-dropzone");br(T).clonePosition(br("#modal"),{setLeft:false,setTop:false});br(T).fadeIn(500);be._show_border_drop_indicators()}else{if(be.browse_indicators_enabled()){bD._add_drop_indicators(eT)}else{return}}$("drag-status").removeClassName("active");return be._drop_indicators=true}},hide_drop_indicators:function(){if(be._drop_indicators){be._hide_border_drop_indicators();bD._remove_drop_indicators();if(!be._notifications_cleared){ab.clear()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){be._drop_indicators=false;be._drop_dest_folder=null;return be._notifications_cleared=false}),500)}return be._notifications_cleared=true},folder_dragover:function(T){var eT;if(be.browse_indicators_enabled()&&be._drop_indicators){if(dz.disabled){if(be._drop_dest_folder==null){eT=ef("You can't upload files because you're out of space.");ab.error(eT,60);be._notifications_cleared=false;be._show_border_drop_indicators()}}else{if(T!==be._drop_dest_folder){if(T===cf.containing_fq_path()){if(cf.inside_read_only_shared_folder){eT=ef("You don't have permission to add to this folder.");ab.error(eT,60)}else{eT=ef("Drop your file to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:di.upload_plain_snippet()});ab.success(new eP(eT),60);be._show_border_drop_indicators()}be._notifications_cleared=false}else{ab.clear();be._hide_border_drop_indicators()}}}return be._drop_dest_folder=T}},supports_recursive_upload:function(T){var eT;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(T!=null?(eT=T[0])!=null?eT.webkitGetAsEntry:void 0:void 0)},upload:function(eU,eW,eT){var eV,eY,eX,T;if(eT==null){eT=null}if(cf.inside_read_only_shared_folder){return}if(dz.disabled){eY=ef("You can't upload files because you're out of space.");return ab.error(eY)}else{if(be.supports_recursive_upload(eT)){return be._recursive_upload(eU,eT)}else{for(eX=0,T=eW.length;eX<T;eX++){eV=eW[eX];eV.dest=eU}return be._upload(eW,eT)}}},_recursive_upload:function(e3,e0){var e5,eU,eV,e2,eY,e6,eT,e4,eX,eZ,T,eW,e1;eT=[];eX=[];eZ=function(e7,e8){e7.dest=e3+au.parent_dir(e8.fullPath);return eT.push(e7)};for(eW=0,e1=e0.length;eW<e1;eW++){e4=e0[eW];e2=e4.webkitGetAsEntry();if(e2!==null){if(e2.isDirectory){if(W.is_quicksend_dest(e3)){ab.error(ef("Please select files instead of folders."))}else{eX.push(e2)}}else{eZ(e4.getAsFile(),e2)}}}eV=0;e6=0;T=function(e7,e9){var e8;e8=ef('The drag and drop uploader can\'t upload %(name)s because it contains Unicode characters. Use the <a id="use-advanced-uploader"> advanced uploader</a> instead.').format({name:e9.name});ab.error(new eP(e8));return br("#use-advanced-uploader").on("click",function(fa){fa.preventDefault();return di.show_upload()})};e5=3000;eY=0;eU=function(){var e7;while(eX.length){e2=eX.pop();if(e2!==null){if(e2.isDirectory){(function(e9){var e8;e8=e9.createReader();eV+=1;return e8.readEntries(function(fa){var fd,fc,fb;if(fa.length!==0){for(fc=0,fb=fa.length;fc<fb;fc++){fd=fa[fc];eX.push(fd)}return e8.readEntries(arguments.callee)}else{return eV-=1}},function(fa){eV-=1;return T(fa,e9)})})(e2)}else{e6+=1;e7=function(e8){return function(e9){eZ(e9,e8);return e6-=1}};e2.file(e7(e2),function(e8){e6-=1;return T(e8,e2)})}}}if(eT.length>e5&&!eY){eY=1;ab.error(ef("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:e5}));return}if(eV||e6){return eU.defer()}else{if(eT.length){return be._upload(eT)}}};return eU()},_upload:function(eV,eT){var T,eU;if(eT==null){eT=null}if(eT){T=this._parse_upload_items(eT)}eU=function(){var eY,e0,eX,eZ,eW;eW=[];for(e0=0,eX=eV.length;e0<eX;e0++){eY=eV[e0];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(T!=null?(eZ=T[eY.name])!=null?eZ.isDirectory:void 0:void 0)){eY.is_directory=true}eY.id=plupload.guid();eW.push(cn.PLU.addFile(eY))}return eW};if($("modal").visible()){return eU()}else{di.show_upload(eU);return eM.hide(null,true)}},_parse_upload_items:function(eT){var eU,eV,eW,T;eU={};for(eW=0,T=eT.length;eW<T;eW++){eV=eT[eW];if(eV.getAsEntry){eV=eV.getAsEntry()}else{if(eV.webkitGetAsEntry){eV=eV.webkitGetAsEntry()}}eU[eV.name]=eV}return eU}};dz=B.OverQuotaUploads={disabled:false,init:function(T){this.disabled=T;if(this.disabled){return br("body").addClass("uploads-disabled")}}};var di;di=INLINE_JS.FileOps=B.FileOps={NOTIFICATION_SNIPPET_LEN:40,SHOW_UPLOAD_EVT:"db:fileops:show_upload",_find_app_by_id:function(eT){var eW,eV,T,eU;eU=eM.vars.apps;for(eV=0,T=eU.length;eV<T;eV++){eW=eU[eV];if(eW.app_id!==eT){continue}return eW}return null},create_album_from_folder:function(eT,T){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:eT,album_name:T},job:true,job_user:cy.get_viewer().photos_user,dont_hide_progress_on_complete:true,progress_text:ef("Creating album..."),onSuccess:function(eU){var eV;eV=JSON.parse(eU.responseText);return window.location.href=eV.url}})},dir_handler:function(eV,eU){var eT,T;if(typeof eU==="string"){eU=$(eU)}eT=$$(".treeview .highlight")[0];if(eT){eT.removeClassName("highlight")}T=eU.up("div");T.addClassName("highlight");eM.selected_div=T;if(eM.shown()){eU.blur()}document.fire("db:dir_click",{path:eV});return eM.vars.selected_path=eV},show_folder_pick:function(eX,eV,eU,eW,T){var eT;c9.fillVal(au.filename(eV).escapeHTML(),"folder-pick-file");bP.move("copy-move-treeview","folder-pick-treeview",{user:cf.active_user});eT=(T?ef("Move"):ef("Copy"));c9.fillVal(eT,"folder-pick-action-text");eM.show(eX,$("folder-pick"),{fq_path:eV,action:eU,folder:eW});return br("#first-treeview-link").trigger("click")},show_bulk_folder_pick:function(eY,eX,eV,eW){var eT,T,eU;eU=aW.profile_files(eV);T=aW.profile_summary(eU);c9.fillVal(T,"bulk-folder-pick-file");bP.move("copy-move-treeview","bulk-folder-pick-treeview",{user:cf.active_user});if(eX==="move"){eT=ef("Move")}else{if(eX==="copy"){eT=ef("Copy")}else{eT=ef("Restore")}}c9.fillVal(eT,"bulk-folder-pick-action-text");eM.show(eY,$("bulk-folder-pick"),{files:eV,action:eW});return br("#first-treeview-link").trigger("click")},show_copy:function(T,eT){var eU;eU=(eT?ef("Copy folder to..."):ef("Copy file to..."));bP.set_params({disable_read_only:true});return di.show_folder_pick(eU,T,di.do_copy,eT,false)},show_copy_bulk:function(T){var eT;eT=a1("Copy %(item_count)s item to...","Copy %(item_count)s items to...",T.length).format({item_count:T.length});bP.set_params({disable_read_only:true});return di.show_bulk_folder_pick(eT,"copy",T,di.do_bulk_copy)},show_move_bulk:function(T){var eT;eT=a1("Move %(item_count)s item to...","Move %(item_count)s items to...",T.length).format({item_count:T.length});bP.set_params({disable_read_only:true});return di.show_bulk_folder_pick(eT,"move",T,di.do_bulk_move)},show_move:function(T,eT){var eU;eU=(eT?ef("Move folder to..."):ef("Move file to..."));bP.set_params({disable_read_only:true});return di.show_folder_pick(eU,T,di.do_move,eT,true)},show_delete:function(T,eU,eV,eT){return dt.show({title_text:eV?ef("Delete folder?"):ef("Delete file?"),body_html:ef("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:au.filename(eU).escapeHTML()}),confirm_text:ef("Delete"),cancel_text:ef("Cancel"),confirm_callback:(function(eW){return function(){if(eT){return di.do_nonbrowse_delete(T,[eU])}else{return di.do_delete(T,eU)}}})(this)})},show_bulk_delete:function(T,eT){return dt.show({title_text:a1("Delete %(item_count)s item?","Delete %(item_count)s items?",eT.length).format({item_count:eT.length}),body_html:a1("Are you sure you want to delete %(item_count)s item from your Dropbox?","Are you sure you want to delete %(item_count)s items from your Dropbox?",eT.length).format({item_count:eT.length}),confirm_text:ef("Delete"),cancel_text:ef("Cancel"),confirm_callback:(function(eU){return function(){return di.do_bulk_delete(T,eT)}})(this)})},show_purge:function(T,eT){return dt.show({title_text:eT?ef("Permanently delete folder?"):ef("Permanently delete file?"),body_html:ef("Are you sure you want to permanently delete <strong>%(items)s</strong> from your Dropbox?").format({items:au.filename(T).escapeHTML()}),confirm_text:ef("Permanently delete"),cancel_text:ef("Cancel"),confirm_callback:(function(eU){return function(){return di.do_purge(cf.find_file(T))}})(this)})},show_bulk_purge:function(T){return dt.show({title_text:a1("Permanently delete %d item?","Permanently delete %d items?",T.length).format(T.length),body_html:a1("Are you sure you want to permanently delete %(item_count)s item from your Dropbox?","Are you sure you want to permanently delete %(item_count)s items from your Dropbox?",T.length).format({item_count:T.length}),confirm_text:ef("Permanently delete"),cancel_text:ef("Cancel"),confirm_callback:(function(eT){return function(){return di.do_bulk_purge(T)}})(this)})},show_bulk_restore:function(eT,T){return dt.show({title_text:a1("Restore %d item...","Restore %d items...",eT.length).format(eT.length),body_html:a1("Are you sure you want to restore %(item_count)s item?","Are you sure you want to restore %(item_count)s items?",eT.length).format({item_count:eT.length}),confirm_text:ef("Restore"),cancel_text:ef("Cancel"),confirm_callback:(function(eU){return function(){return di.do_bulk_restore(eT)}})(this)})},wrap_strong:function(T){if(cf.containing_fq_path()===""){return T.escapeHTML()}else{return"<strong>"+T.escapeHTML()+"</strong>"}},upload_snippet:function(eU){var T,eT;if(eU==null){eU=1000}if(cy.get_viewer().is_paired&&cf.active_user.is_team){eT=bG.em_snippet(cy.get_viewer().team_name,eU).escapeHTML()}if(cf.containing_fq_path()===""){if(cy.get_viewer().is_paired){if(cf.active_user.is_team){return ef(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({team_name:eT})}else{return ef(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"})}}else{return ef(" upload to your Dropbox")}}else{T=bG.em_snippet(au.filename(cf.containing_fq_path()),eU).escapeHTML();if(cy.get_viewer().is_paired){if(cf.active_user.is_team){return ef(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T,team_name:eT})}else{return ef(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T})}}else{return ef(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T})}}},upload_short_snippet:function(eU){var eT,T;if(eU==null){eU=1000}T=cf.containing_fq_path();if(!T){return ef("Upload to Dropbox",{comment:"Upload a file to the root Dropbox folder"})}eT=bG.em_snippet(au.filename(T),eU);return ef("Upload to '%(folder_name)s'",{comment:"Upload a file to some folder on the website"}).format({folder_name:eT})},upload_plain_snippet:function(T){if(T==null){T=1000}return this.upload_snippet(T).replace("<strong>","'").replace("</strong>","'")},show_upload:function(e0,T,eX){var eU,eY,eT,eV,eZ,eW;eU=cf.containing_fq_path();if(dz.disabled){c9.fillVal(this.wrap_strong(au.filename(eU)),"disabled-upload-foldername");eT=this.upload_short_snippet(20);eM.show(eT,$("disabled-upload-modal"),{},false);return}br(document).trigger(this.SHOW_UPLOAD_EVT,{source:T,has_callback:e0!=null});if((!FlashDetect.versionAtLeast(9))&&cn.runtimes==="flash"){di.show_basic_upload();$("enhanced-upload-toggle").hide();return}c9.fillVal(this.upload_snippet(20),"upload-foldername");c9.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&be.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}eT=this.upload_short_snippet(20);eM.show(eT,c9.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,al.num_files());eW=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(eV=0,eZ=eW.length;eV<eZ;eV++){eY=eW[eV];if(eY!=null){eY.observe("click",function(){di.show_basic_upload();return false})}}if(!al.num_files()){cn.init(au.normalize(eU),true,e0,eX)}else{cn.set_dest(au.normalize(eU))}return cL.hide()},show_basic_upload:function(){c9.fillVal(this.upload_snippet(20),"basic-upload-foldername");eM.show(this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){di.show_upload();return false});cn.set_dest(au.normalize(cf.containing_fq_path()));return cn.init_basic()},show_undelete:function(T){var eT,eU,eV;c9.fillVal(T.filename.escapeHTML(),"undelete_filename");eT=cj.make("web",T.icon,{});eT.addClassName("link-img");eT.style.backgroundColor="transparent";eU=di.build_revisions_uri(T.fq_path,cf.active_user,{undelete:1});$$(".undelete-icon").invoke("update",eT);$$(".undelete-other-versions")[0].href=eU;$$(".undelete-link")[0].href=eU;eV=ef("Restore file?");return eM.show(eV,$("undelete-modal"),{file:T})},do_undelete:function(eT){var T,eU;T=eM.vars.file;eU=ef("Restored '%(file_name)s'").format({file_name:T.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[T.fq_path]},subject_user:cf.active_user,job:true,html_in_error_msg:true,progress_text:ef("Restoring..."),onSuccess:function(eV){eM.hide();ab.success(eU);return document.fire(aB.RESTORE,{files:[T]})}});return false},do_copy:function(eU,eT){var T;eU=eU||eM.vars.fq_path;eT=eT||eM.vars.selected_path;T=cf.find_file(eU);cw(T,"Trying to copy a file we couldn't find.");return di.do_bulk_copy([T],eT)},do_bulk_copy:function(eX,eT){var eV,eW,eU,eY,T;cf.pre_action_selection=eA.get_selected_fq_paths();eX=eX||eM.vars.files;cw(eX.length>0,"Tried to copy 0 files");if(typeof eT==="undefined"){if(typeof eM.vars.selected_path==="undefined"){ab.error(ef("You need to select a destination for the file."));return}else{eT=eM.vars.selected_path}}eT=au.normalize(eT);eU=0;for(eY=0,T=eX.length;eY<T;eY++){eV=eX[eY];if(eV.dir){if((eT+"/").indexOf(eV.fq_path+"/")===0){ab.error(ef("You cannot copy a folder into itself."));return}}}eW=eX.pluck("fq_path");ab.clear();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:eW,to_path:eT},subject_user:cf.active_user,job:true,html_in_error_msg:true,progress_text:ef("Copying..."),onSuccess:function(e6){var e2,e5,eZ,e7,e1,e3,e0,e4;e2=e6.responseText.evalJSON().changesets;e5=eW.length;e7=bG.em_snippet(au.filename(eT),di.NOTIFICATION_SNIPPET_LEN).escapeHTML();e1=a1("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",e5);e1=e1.format({count:e5,location:e7});U.notifyWithUndo(new eP(e1),e2,di.do_rollback);eZ=[];e4=e6.responseText.evalJSON().new_browse_files;for(e3=0,e0=e4.length;e3<e0;e3++){eV=e4[e3];eZ.push(eV.fq_path)}cf.select_fq_paths=eZ;$("reload-link").observe("click",function(){return aV.set_path_url(null,eT)});bP.schedule_reset();return document.fire(aB.COPY,{files:eX,to_fq_path:eT})}})},bulk_move_error:function(T,e0){var eY,eV,e1,eW,e2,eX,eT,eU,eZ;e1=cf.find_file(e0);eW=aW.profile_files(T);eU=void 0;eX=void 0;eZ=void 0;if(e1){eX=e1.dir;eU=e1.fq_path;eZ=e1.target_ns||e1.ns_id}else{if(cf.inside_dir&&cf.can_get_details_from_fq_path(e0)){eV=cf.details_from_fq_path(e0);eX=true;eU=eV.fq_path;eZ=eV.ns_id}else{eX=true;eU=e0;eZ=void 0}}e2=T.pluck("fq_path").collect(au.normalize);if(-1!==e2.indexOf(au.normalize(eU))){return ef("You cannot copy a folder into itself.")}eY=eT=function(e3){var e4;e4=au.parent_dir(e3.fq_path);return e4===(eU||"/")};if(T.all(eY)){return a1("That file already exists in that folder.","Those files already exist in that folder.",T.length)}if(!eX){return ef("You cannot put files inside one another.")}if(eW.target_namespaces>0&&eZ&&eZ!==Constants.root_ns){if(eW.sandboxes>0){if(e1.is_sandbox()){return ef("You're not allowed to put an application folder inside another application folder.")}else{if(e1.is_shared_folder()){return ef("You're not allowed to put an application folder inside a shared folder.")}}}else{if(eW.shared_folders>0){if(e1.is_sandbox()){return ef("You're not allowed to put a shared folder inside an application folder.")}else{if(e1.is_shared_folder()){return ef("You're not allowed to put a shared folder inside another shared folder.")}}}}return ef("You're not allowed to nest special folders.")}if(cf.public_folder_enabled){if(eU==="/Public"&&eW.target_namespaces>0){return ef("You're not allowed to move shared folders to your Public folder.")}}if(eW.public_folder>0){return ef("You're not allowed to move your Public folder.")}if(eW.deleted>0){return ef("Moving deleted folders or files is not allowed.")}},do_move:function(eU,eT){var T;eU=eU||eM.vars.fq_path;eT=eT||eM.vars.selected_path;T=cf.find_file(eU);cw(T,"Trying to move a file we couldn't find.");return di.do_bulk_move([T],eT)},do_bulk_move:function(eW,eX){var eU,eV,T,eT;cf.pre_action_selection=eA.get_selected_fq_paths();eW=eW||eM.vars.files;if(!eW){return}cw(eW.length>0,"Tried to move 0 files");T=eX||eM.vars.selected_path||"";T=au.normalize(T);eU=di.bulk_move_error(eW,T);if(eU){ab.error(eU);return}eV=eW.pluck("fq_path");ab.clear();eT="/cmd/move";return new Ajax.DBRequest(eT,{parameters:{files:eV,to_path:T},subject_user:cf.active_user,job:true,html_in_error_msg:true,progress_text:ef("Moving..."),onSuccess:function(e1){var e0,eZ,eY,e2;e0=e1.responseText.evalJSON().changesets;eZ=eV.length;eY=bG.em_snippet(au.filename(T),di.NOTIFICATION_SNIPPET_LEN).escapeHTML();e2=a1("Moved %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Moved %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",eZ);e2=e2.format({count:eZ,location:eY});U.notifyWithUndo(new eP(e2),e0,di.do_rollback);$("reload-link").observe("click",function(){return aV.set_path_url(null,T)});bP.schedule_reset();return document.fire(aB.MOVE,{files:eW,to_fq_path:T})}})},do_rollback:function(T){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(T)},subject_user:cf.active_user,job:true,html_in_error_msg:true,progress_text:ef("Undoing..."),onSuccess:function(eT){var eU;eU=ef("Undo complete.");ab.success(eU);cw(cf.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(cf.in_search_mode()){bW.select_fq_paths=cf.pre_action_selection;bW.force_reload()}else{if(aD.shown){cf.select_fq_paths=cf.pre_action_selection}else{cf.select_fq_paths=cf.pre_action_selection;cf.force_reload()}}return cf.pre_action_selection=false}})},do_bulk_delete:function(T,eV){var eT,eU;cf.pre_action_selection=eA.get_selected_fq_paths();eV=eV||eM.vars.files;cw(eV.length>0,"Tried to delete 0 files");eU=(function(){var eY,eX,eW;eW=[];for(eY=0,eX=eV.length;eY<eX;eY++){eT=eV[eY];eW.push(eT.fq_path)}return eW})();ab.clear();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:eU},subject_user:T,job:true,html_in_error_msg:true,progress_text:ef("Deleting..."),onSuccess:function(eW){var eY,eX;eX=eW.responseText.evalJSON();eY=a1("Deleted %d item.","Deleted %d items.",eU.length).format(eU.length);U.notifyWithUndo(eY,eX.changesets,di.do_rollback);bP.schedule_reset();return document.fire(aB.DELETE,{files:eV})}})},do_delete:function(T,eU){var eT;eT=cf.find_file(eU||eM.vars.fq_path);cw(eT,"Trying to delete a file we couldn't find.");return di.do_bulk_delete(T,[eT])},do_nonbrowse_delete:function(T,eT){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:eT},subject_user:T,html_in_error_msg:true,onSuccess:function(eU){var eV;eV=a1("Deleted %(file_count)s item","Deleted %(file_count)s items",eT.length);eV=eV.format({file_count:eT.length});ab.success(eV);return document.fire(aB.DELETE,{fq_paths:eT})}})},do_purge:function(T){cw(T,"Trying to purge a file we couldn't find.");return di.do_bulk_purge([T])},do_bulk_purge:function(eT){var T,eU;cw(eT.length>0,"Tried to purge 0 files");T=eT.collect(function(eV){return eV.fq_path});eU=a1("Permanently deleted %d item","Permanently deleted %d items",T.length).format(T.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:T},subject_user:cf.active_user,job:true,html_in_error_msg:true,progress_text:ef("Deleting..."),onSuccess:function(eV){ab.success(eU);bP.schedule_reset();return document.fire(aB.PURGE,{files:eT})}})},do_bulk_restore:function(eU){var eT,eV,T;eU=eU||eM.vars.files;T=eM.vars.user;cw(eU.length>0,"Tried to restore 0 files");eT=eU.collect(function(eW){return eW.fq_path});eV=a1("Restored %d item","Restored %d items",eT.length,{comment:"meaning, successfully restored x files and folders"}).format(eT.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:eT},subject_user:cf.active_user,job:true,html_in_error_msg:true,progress_text:ef("Restoring..."),onSuccess:function(eW){ab.success(eV);bP.schedule_reset();return document.fire(aB.RESTORE,{files:eU})}})},do_folder_restore:function(eT,T){var eU;eU=function(eV){var eX,eW;eX=ef("Restoring '%(folder_name)s'").format({folder_name:au.filename(eT)});eW=eV.responseText;if(eW.startsWith("err:")){eW=eW.substring(4);br("#async-result").html(eW);ab.error(new eP(eW),60)}else{eX=ef("Restored '%(folder_name)s'").format({folder_name:au.filename(eT)});br("#status-of-files").text(ef("Restored files"));ab.success(eX,60)}br("#restore-done-heading").text(eX);br(".pre-restore").hide();return br(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[eT]},job:true,html_in_error_msg:true,progress_text:ef("Restoring..."),onSuccess:eU,onFailure:eU,subject_user:T})},do_bulk_download:function(eU){var eW,eT,eV,T;eW=new Element("form",{action:D({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(Constants.UID_PARAM_NAME,cf.active_user.id).toString(),method:"post"});for(eV=0,T=eU.length;eV<T;eV++){eT=eU[eV];bF.add_vars(eW,{files:eT.fq_path})}bF.add_vars(eW,{parent_path:cf.block_hash_param||"/",w:cf.block_hash});$(document.body).__sert(eW);return eW.submit()},do_bulk_photo_view:function(eT){var eU,T;eU=new Element("form",{action:"https://"+Constants.WEBSERVER+"/photos",method:"post"});bF.add_vars(eU,{t:bk.read(Constants.JS_CSRF_COOKIE),ns_ids:JSON.stringify((function(){var eX,eW,eV;eV=[];for(eX=0,eW=eT.length;eX<eW;eX++){T=eT[eX];eV.push(T.ns_id)}return eV})()),ns_paths:JSON.stringify((function(){var eX,eW,eV;eV=[];for(eX=0,eW=eT.length;eX<eW;eX++){T=eT[eX];eV.push(T.ns_path)}return eV})())});$(document.body).__sert(eU);return eU.submit()},build_revisions_uri:function(eU,T,eT){if(eT==null){eT={}}eT[Constants.UID_PARAM_NAME]=String(T);return D({path:"/revisions"+eU}).updateQuery(eT)}};var bF,ar={}.hasOwnProperty;bF=__CONDITIONAL_JS__.Forms=INLINE_JS.Forms=B.Forms={submitOnlyOnce:function(){var T;T=bF.submitted!==true;bF.submitted=true;return T},disable:function(T){if(T){return setTimeout((function(){return T.disabled=true}),0)}},enable:function(T){if(T){return setTimeout((function(){return T.disabled=false}),0)}},show_button_on_change:function(T,eV){var eU,eW,eX,eT;eU=br(T);eU.hide();if(eV==null){eV=eU.closest("form")}eW=eV[0];if(this.next_id==null){this.next_id=0}eX=this.next_id++;if(this.initial_vars==null){this.initial_vars={}}this.initial_vars[eX]=this.collect_form_vars(eW);eU.attr("data-id",eX);eV.data("button-id",eX);eT=(function(eY){return function(){var e1,e0,eZ;eU.hide();e0=eY.collect_form_vars(eW);if(Object.keys(e0).length!==Object.keys(eY.initial_vars[eX]).length){eU.show()}eZ=[];for(e1 in e0){if(e0[e1]!==eY.initial_vars[eX][e1]){eZ.push(eU.show())}else{eZ.push(void 0)}}return eZ}})(this);eV.change(eT);eV.find("input").filter(":text").on("input",eT);return eV.find("textarea").on("input",eT)},add_vars:function(eU,eV){var eW,eT,T;eU=$(eU);T=[];for(eT in eV){if(!ar.call(eV,eT)){continue}eW=new Element("input",{type:"hidden",name:eT});eW.setValue(eV[eT]);T.push(eU.__sert(eW))}return T},collect_form_vars:function(eW,eV){var eZ,eU,eT,eY,eX,T;if(eV==null){eV=false}eW=eW||$(document.body);eU=eW.select("input").concat(eW.select("textarea")).concat(eW.select("select"));eT={};for(eX=0,T=eU.length;eX<T;eX++){eZ=eU[eX];if(eZ.name&&eZ.name!=="t"){eY=eZ.getValue();if(eY||eV){if(typeof eY!=="string"){eY=eY.join(",")}if(eT[eZ.name]!=null){if(typeof eT[eZ.name]==="string"){eT[eZ.name]=[eT[eZ.name],eY]}else{eT[eZ.name].push(eY)}}else{eT[eZ.name]=eY}}}}return eT},add_loading:function(eU,T){var eT;if(eU){eU=$(eU);eT=new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});eT.addClassName("text-img ajax_submit_loading");if(T==="after"){return br(eU).after(eT)}else{return br(eU).before(eT)}}},remove_loading:function(T){return br(".ajax_submit_loading").remove()},ui_form_submit:function(eT,T){T=T||eT.action;if(eT.ajax_submitted){return false}eT.ajax_submitted=true;return new bl(br(eT),T,{data:bF.collect_form_vars(eT),success:(function(eU){return function(eY,eV,eZ){var eX,eW;eW=br(eT).data("button-id");if(eW!=null){eX=br(eT).find("*[type='submit'][data-id='"+eW+"']");eU.initial_vars[eW]=eU.collect_form_vars(eT);return eX.hide()}}})(this),complete:(function(eU){return function(eW,eV){return eT.ajax_submitted=false}})(this)})},ajax_submit_obj:function(eX){var e1,e3,eU,eV,eT,eW,eZ,e0,eY,e2,T;eV=eX.form,T=eX.url,e2=eX.success_callback,eU=eX.fail_callback,e1=eX.button,eZ=eX.more_vars,e0=eX.position,eW=eX.job,eT=eX.html_response,e3=eX.complete_callback,eY=eX.progress_text;return bF.ajax_submit(eV,T,e2,eU,e1,eZ,e0,eW,eT,e3,eY)},ajax_submit:function(eV,eT,e4,eU,e2,eZ,e3,eW,T,e7,eX){var e5,eY,e0,e6,e1;if(T==null){T=false}if(eV.ajax_submitted){return false}eV.ajax_submitted=true;e1=br(eV).find(".suggestion-input");for(e0=0,e6=e1.length;e0<e6;e0++){e5=e1[e0];cP.blank(e5.identify())()}if(e2){bF.add_loading(e2,e3)}eY=bF.collect_form_vars(eV);if(eZ){Object.extend(eY,eZ)}new Ajax.DBRequest(eT||eV.action,{noAutonotify:true,parameters:eY,job:eW,progress_text:eX,evalJSON:false,onSuccess:function(e8){bF.remove_loading();if(e4&&typeof e4==="function"){return e4(e8)}},onFailure:function(fa){var e8,e9;if(fa){if(fa.responseText.indexOf("err:")===0){e8=fa.responseText.substr(4);if(e8.indexOf("{")===0){e9=e8.evalJSON(true);bF.fill_errors(eV,e9)}else{if(T){e8=new eP(e8)}ab.error(e8)}}else{ab.error()}bF.remove_loading();if(eU&&typeof eU==="function"){return eU(fa)}}},onComplete:function(fb){var fa,e9,e8;e8=eV.select(".suggestion-input");for(fa=0,e9=e8.length;fa<e9;fa++){e5=e8[fa];cP.blur_elm(e5)}eV.ajax_submitted=false;if(e7&&typeof e7==="function"){return e7(fb)}}});return false},clear_errors:function(T){T=T||$(document.body);this.hide_errors(T);return T.select(".error-removable").invoke("remove")},fill_errors:function(eX,eW){var eU,eZ,eT,eV,eY,T;eW=eW||{};eX=eX||$(document.body);bF.clear_errors(eX);for(eY in eW){if(!ar.call(eW,eY)){continue}eZ=eX.down("[data-error-field-name='"+eY+"']")||eX.down("[name='"+eY+"']");if(eZ){eU=new Element("br",{"class":"error-removable"});eT=new Element("span",{"class":"error-message error-removable"});eV=eW[eY];cw(eV.message_html||eV.message_text,"Error message must have a message_html or message_text property");if(eV.message_html){eT.update(eV.message_html)}else{eT.__date(eV.message_text)}br(eZ).before(eT);br(eZ).before(eU);T=br(eX).find("input[name='"+eY+"'], textarea[name='"+eY+"']");if(T){T.addClass("input-error")}}}return this.show_errors(eX)},value:function(eV){var eU,eT,eX,eW,T;eT=$$('input[name="'+eV+'"]');eX=null;for(eW=0,T=eT.length;eW<T;eW++){eU=eT[eW];eX=$(eU).getValue()||eX}return eX},postRequest:function(eU,eV,T){var eT;if(eV==null){eV={}}if(T==null){T={}}cw(eU!=null,"postRequest missing action");eV.t=bk.read(Constants.JS_CSRF_COOKIE);eT=new Element("form",{action:eU,method:"POST"});if(T.target){eT.target=T.target}document.body.appendChild(eT);bF.add_vars(eT,eV);return eT.submit()},hide_errors:function(eU){var eX,eW,eV,eT,T;eX=this.get_errors(eU);T=[];for(eV=0,eT=eX.length;eV<eT;eV++){eW=eX[eV];if(eW.down("span.error-message")){T.push(eW.hide())}else{T.push(void 0)}}return T},show_errors:function(eT){var eW,eV,eU,T;eW=this.get_errors(eT);for(eU=0,T=eW.length;eU<T;eU++){eV=eW[eU];if(eV.down("span.error-message")){eV.show()}}return br(".sick-input").find("label").css("top","")},get_errors:function(eT){var eU,T;T=".error-bubble, .error-plain-text";eU=eT?eT.select(T):$$(T);return eU}};br(function(){return bF.show_errors()});var R;R=B.ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(eW,eX){var eV,eT,eU,T;if(eX==null){eX=document.body}eU=$(eX).getElementsByClassName("act_as_block");T=[];for(eV=0,eT=eU.length;eV<eT;eV++){eW=eU[eV];T.push(this.resize(eW))}return T},resize:function(eW){var T,eU,eV,eT;eW=$(eW);eU=eW.up();T=dL.sumStyles(eW,this.elm_list);eV=dL.sumStyles(eU,this.parent_list);eW.style.width="1px";eT=eU.getWidth()-T-eV;if(eT>0){return eW.style.width=eT+"px"}}};var a3;a3=B.BrowseStyleRows={register_all:function(){var eV,eU,T,eT;eT=$$(".bs-row");for(eU=0,T=eT.length;eU<T;eU++){eV=eT[eU];this.register(eV)}Event.observe(document,"click",this.kill_current.bind(this));return br(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(eT){var T;eT=$(eT);eT.db_observe("mouseover",this.mouseover.bind(this));eT.db_observe("mouseout",this.mouseout.bind(this));T=eT.down(".action-button");if(T){return T.db_observe("click",this.click.bind(this))}},mouseover:function(eT,T){if(!T.hasClassName("no-hover")){return T.addClassName("hover")}},mouseout:function(eT,T){return T.removeClassName("hover")},click:function(eV,eT){var T,eW,eU;if(eV.target.tagName==="A"){return}eW=eT.up(".bs-row");Event.stop(eV);if(eW.hasClassName("selected")){this.kill_current(false);return}br(document).trigger("dropdown-opened");this.kill_current(false);eU=$(eV.target);if(!eU.match(".bs-actions-list *")){eW.addClassName("selected")}T=(eU.hasClassName("bs-row")?eU:eU.up(".bs-row"));return T.style.zIndex=9},kill_current:function(eW){var eX,eV,eT,eU,T;eU=$$(".bs-row.selected");T=[];for(eV=0,eT=eU.length;eV<eT;eV++){eX=eU[eV];eX.removeClassName("selected");T.push(eX.style.zIndex="")}return T}};var d3;d3=B.Bubble={make:function(e5,fg,e8,e3,eZ){var eW,e6,fd,eV,eU,ff,fa,e4,e2,eX,e1,e7,fc,e0,T,eY,eT,fe,fb,e9;if(fg==null){fg="left"}eZ=eZ!=null?eZ:{};if(["left","right"].contains(fg)){e8=e8||"middle";cw(["top","middle","bottom"].contains(e8),"expected tail position ['top', 'middle', 'bottom'], got "+e8)}else{if(["bottom","top"].contains(fg)){e8=e8||"center";cw(["left","center","right"].contains(e8),"expected tail position ['left', 'center', 'right'], got "+e8)}else{if(!["none"].contains(fg)){cw(false,"unexpected tail side, got "+fg)}}}e7=new Element("table");if(eZ.style==="titled"){e7.addClassName("bluebubble");fc="bluebubble"}else{e7.addClassName("bubble");fc="bubble"}if(e3){e7.style.width=e3+"px"}T=new Element("tbody");fe=new Element("tr");eY=new Element("td");eY.addClassName("tl");e1=new Element("td");e1.addClassName("t");if(eZ.style==="titled"){if(e3){e1.style.width=(e3-42)+"px"}}eT=new Element("td");eT.addClassName("tr");if(fg==="top"){e0=new Element("img",{src:"/static/images/"+fc+"_arrow_top.png"});e0.addClassName("tarrow");if(eZ.style==="titled"){e0.addClassName("arrow-"+e8);e6=new Element("div");e6.addClassName("arrow-container");if(e3){e6.style.width=(e3-42)+"px"}e6.__sert(e0);e1.__sert(e6)}else{e1.style.textAlign=e8;e1.__sert(e0)}}fe.__sert(eY);fe.__sert(e1);fe.__sert(eT);T.__sert(fe);fb=new Element("tr");e4=new Element("td");e4.addClassName("l");if(fg==="left"){if(eZ.style==="titled"){eW=new Element("img",{src:"/static/images/bluebubble_arrow_left-vfl8zzy_-.png"})}else{eW=new Element("img",{src:"/static/images/bubble_arrow-vfl8m7tk-.png"})}eW.addClassName("arrow");e4.__sert(eW);e4.vAlign=e8}fa=new Element("td");fa.addClassName("c");fa.update(e5);e2=new Element("td");e2.addClassName("r");if(fg==="right"){eX=new Element("img",{src:"/static/images/bubble_arrow_right-vflmW3_2s.png"});eX.addClassName("rarrow");e2.__sert(eX);e2.vAlign=e8}fb.__sert(e4);fb.__sert(fa);fb.__sert(e2);T.__sert(fb);e9=new Element("tr");eU=new Element("td");eU.addClassName("bl");fd=new Element("td");fd.addClassName("b");if(fg==="bottom"){eV=new Element("img",{src:"/static/images/"+fc+"_arrow_bottom.png"});eV.addClassName("barrow");if(eZ.style==="titled"){eV.addClassName("arrow-"+e8);e6=new Element("div");e6.addClassName("arrow-container");if(e3){e6.style.width=(e3-42)+"px"}e6.__sert(eV);fd.__sert(e6)}else{fd.style.textAlign=e8;fd.__sert(eV)}}ff=new Element("td");ff.addClassName("br");e9.__sert(eU);e9.__sert(fd);e9.__sert(ff);T.__sert(e9);e7.__sert(T);return e7}};var ex;ex=INLINE_JS.FreshDropdown=B.FreshDropdown={show:function(eY,eV,eU,eT){var eX,eW,eZ,T;if(eT==null){eT=false}br(document).trigger("dropdownOpened",[1]);eX=br(eV);if(!eU){eU=eX[0].offsetHeight+10}this.hide_all();eW=br(eY).show();T=eW[0].offsetWidth;eZ=eX[0].offsetWidth;eW.clonePosition(eX,{setHeight:false,setWidth:false,offsetLeft:-1*(T-eZ)+22,offsetTop:eU});if(eT){eW.width(T)}eX.addClass("pressed");return((function(e0){return function(){return document.observe("click",ex.hide_all)}})(this)).defer()},hide_all:function(eU){var eT,T;T=br(".freshdropdown-menu");eT=0;T.each(function(){if(br(this).is(":visible")){return eT+=1}});T.hide();br(document).trigger("dropdownClosed",[eT]);$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",ex.hide_all)}};var Y;Y=B.JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&Y.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=D.parse(window.location.href).fragment}},report:function(){clearInterval(Y.interval);return cw(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash+". You may have an onclick handler that isn't firing, or you are not preventing the default action (eg. by returning false in your handler)")}};var eG,bb,ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV};eG=B.LocaleSelectorModal=(function(eT){cA(T,eT);function T(){return T.__super__.constructor.apply(this,arguments)}T.prototype.action="https://"+Constants.WEBSERVER+"/set_locale";T.prototype.on_show=function(){return this.$modal_window.on("click",".locale-option",(function(eU){return function(eV){eV.preventDefault();eU.hide();return eU.set_locale(br(eV.target).attr("data-locale"))}})(this))};T.prototype.on_hide=function(){return this.$modal_window.off("click")};T.prototype.set_locale=function(eU,eW){var eV;if(eW==null){eW=false}eV=br("<form />",{action:this.action,method:"post"});bF.add_vars(eV[0],{locale:eU,locale_cont:eW||window.location.href,t:bk.read(Constants.JS_CSRF_COOKIE)});br(document.body).append(eV);return eV.submit()};return T})(dN);bb=B.TeamLocaleSelectorModal=(function(T){cA(eT,T);function eT(){return eT.__super__.constructor.apply(this,arguments)}eT.prototype.action="https://"+Constants.WEBSERVER+"/team/admin/set_locale";return eT})(eG);var du;du=B.LoginDropdown={init:function(){var T;T=br("#login-hover-link");if(!(T.length>0)){return}this.login_link=T;return this.register()},register:function(T){this.login_link.on("click",this.click.bind(this));this.login_link.on("mousedown",this.mousedown.bind(this));this.login_link.on("focus",this.click.bind(this));return $(document.body).on("click",this.unclick.bind(this))},mousedown:function(T){return this.clicking=true},click:function(T){T.preventDefault();if(this.clicking&&T.type==="focus"){return}this.clicking=false;if(this.down){return this.unclick()}br(document).trigger("dropdownOpened",[1]);this.down=true;this.login_link.parent().addClass("down");return br("input[name='login_email']").focus()},unclick:function(eT){var T;if(eT){T=br(eT.target);if(T[0].match("#top-login-wrapper, #top-login-wrapper *")){return}}if(this.down){br(document).trigger("dropdownClosed",[1])}this.down=false;return this.login_link.parent().removeClass("down")}};var eM;eM=__CONDITIONAL_JS__.Modal=INLINE_JS.Modal=B.Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(e4,e0,e1,e6,eU,e2,eY,eZ,e5){var eT,eW,e3,T,eV,eX;if(e1==null){e1=false}if(e6==null){e6=false}if(eU==null){eU=false}if(e2==null){e2=false}if(eY==null){eY=""}if(eZ==null){eZ=true}if(e5==null){e5=false}if(eM.shown()){eM._cleanup()}eU=eU||this.width;eW="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(eW).invoke("hide");if(al.uploading&&!e2){bV(ef("You can't do this while uploading."));return false}cw(e0,"Missing modal content!");eV=this.vars._prev_scope;this.vars=e1||{};this.vars._prev_scope=eV;$("modal").setStyle({width:""+eU+"px",margin:"0 0 0 "+(Math.floor(-eU/2).toString())+"px"});this.vars.extra_class="";if(eY){$("modal").addClassName(eY);this.vars.extra_class=eY}if(!e2){if(al.num_files()){cn.reset();al.clear()}T=dL.childElement($("modal-content"),0);if(T&&T!==e0){$("grave-yard").__sert(T)}eT=new Element("div");eT.update(e0);$("modal-content").__sert(eT);if(e0.show){e0.show()}Element.show("modal")}br("#modal-overlay").off("click");if(eZ){br("#modal-overlay").on("click",function(e7){eM.hide(null,false,true);e7.preventDefault();return e7.stopPropagation()})}else{br("#modal-overlay").on("click",function(e7){e7.preventDefault();return e7.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:""+(eU+20)+"px",margin:"0 0 0 "+(Math.floor(-eU/2-10).toString())+"px"});br("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(e6){$("modal-content").select("#"+e6.id).first().focus()}else{if(!dL.ie){e3=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(e3){e3.focus()}}}if(!this.track_id){this.track_resizes()}if(e4){if(dL.isElm(e4)){br("#modal-title").html(e4)}else{br("#modal-title").text(e4)}br("#modal-title").show();eX=br("#modal-title").text();em("Modal.show:",eX)}else{br("#modal-title").hide();em("Modal.show")}R.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=e5;br("#modal").find("input").filter(":visible:first").focus();if(this.in_viewport()){this.scroll_locked=true;z.scroll_lock_document()}br(document).trigger("modalOpened",[1]);return false},in_viewport:function(){var eU,T,eT,eW,eV;eU=br("#modal");T=eU.height();eV=eU.width();eT=z.viewport_dimensions();eW=z.viewport_offset(eU);return eW.left>0&&eW.top>0&&eW.left+eV<eT.width&&eW.top+T<eT.height},fix_position:function(eU){var eT,T;T=document.viewport.getScrollOffsets().top+this.vertical_offset;eT=parseInt($("modal").getStyle("height"),10);if(eT+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(eT+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:T+"px"});return $("modal-behind").setStyle({position:"absolute",height:(eT+20)+"px",top:(T-10)+"px"})}},keydown:function(eV){var eW,T,eU,eT;eU=eV.keyCode||eV.which||eV.charCode;if(eU===27||(eU===8&&!z.focus_in_input())){eV.preventDefault();this.hide(null,false,true)}if(eU===9&&!z.focus_in_input()){T=$("modal").down("input[type=text], input[type=email]");eT=$("modal").down(".modal-tabs");eW=eT;while(eW&&eW.next()){eW=eW.next();if(eW.visible()){T=eW.down("input[type=text], input[type=email]");break}}if(T){eV.preventDefault();return T.focus()}}},shown:function(){return $("modal").visible()},hide:function(eU,T,eT){if(eU){Event.stop(eU)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(eT);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!T&&!al.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(al.uploading){cL.show()}}eM._cleanup();if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return em("Modal.hide")},_cleanup:function(){br(document).trigger("modalClosed",[1]);if(this.scroll_locked){return z.scroll_unlock_document()}},should_prevent_hide:function(){return this.prevent_hide_if_loading&&$u.some(br("#modal form"),function(T){return T.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var T;T=$("modal").getHeight();if(this.old_height!==T||$("modal-behind").getHeight()<T){this.old_height=T;return this.fix_position()}},vars:{}};var eE,eC,dI,dW,db=function(T,eT){return function(){return T.apply(eT,arguments)}},bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1},ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV};dI=B.RolePickerState={ALL:"all",PERSONAL:Constants.ROLE_PERSONAL,WORK:Constants.ROLE_WORK};eC=B.RolePicker=(function(){function T(eW){var eX,eT,eV,eU,eZ,eY;if(eW==null){eW={}}this._actually_set_state=db(this._actually_set_state,this);this._do_login=db(this._do_login,this);this.is_user_visible=db(this.is_user_visible,this);this.is_role_visible=db(this.is_role_visible,this);this.ensure_role_is_visible=db(this.ensure_role_is_visible,this);this.update_picker_ui=db(this.update_picker_ui,this);this.set_state=db(this.set_state,this);this.get_state=db(this.get_state,this);this._allow_merged_state=eW.allow_merged_state!=null?eW.allow_merged_state:true;this._limit_to_role=eW.limit_to_role!=null?eW.limit_to_role:null;eZ=cy.get_viewer();eT=eZ.is_role_signed_in(dI.PERSONAL)&&eZ.is_role_signed_in(dI.WORK);if(eW.initial_state){eV=$u.values(dI);cw((eY=eW.initial_state,bx.call(eV,eY)>=0),"RolePicker requires initial_state to be one of: "+eV);this.set_state(eW.initial_state)}else{if(this._allow_merged_state&&eT){this.set_state(dI.ALL)}else{eX=eZ.get_users();cw(eX.length,"tried to use RolePicker on a page with no users");eU=eX[0];this.set_state(eU.role)}}}T.prototype.get_state=function(){return this._state};T.prototype.set_state=function(eU){var eX,eW,eT,eV;cw(this._allow_merged_state||(eU!==dI.ALL),"tried to set merged state in non-merged picker");if(this._limit_to_role!=null){cw((eU===dI.ALL)||(eU===this._limit_to_role))}if(eU===dI.ALL){eV=[Constants.ROLE_PERSONAL,Constants.ROLE_WORK,Constants.ROLE_PHOTOS];for(eW=0,eT=eV.length;eW<eT;eW++){eX=eV[eW];if(!cy.get_viewer().is_role_signed_in(eX)){this._do_login(eX,eU);return}}}else{eX=eU;if(!cy.get_viewer().is_role_signed_in(eX)){this._do_login(eX,eU);return}}return this._actually_set_state(eU)};T.prototype.update_picker_ui=function(){};T.prototype.ensure_role_is_visible=function(eT){if(!this.is_role_visible(eT)){if(this._allow_merged_state){return this.set_state(dI.ALL)}else{return this.set_state(eT)}}};T.prototype.is_role_visible=function(eT){return this._state===dI.ALL||this._state===eT};T.prototype.is_user_visible=function(eT){return this.is_role_visible(eT.role)};T.prototype._do_login=function(eT,eU){return bB.show_modal({role:eT,on_success:(function(eV){return function(){return eV._actually_set_state(eU)}})(this)})};T.prototype._actually_set_state=function(eT){if(eT===this._state){return}this._state=eT;this.update_picker_ui();return typeof this.on_state_change==="function"?this.on_state_change(eT):void 0};return T})();dW=B.RoleSelect=(function(eT){cA(T,eT);function T(eV,eU){if(eU==null){eU={}}this.limit_to_role=db(this.limit_to_role,this);this.update_picker_ui=db(this.update_picker_ui,this);this.on_ui_change=db(this.on_ui_change,this);this.$container=eV;this.$bubble_picker=this.$container.find(".bubble-picker");this.$bubble_picker.on(bn.CHANGED,this.on_ui_change);T.__super__.constructor.call(this,eU)}T.prototype.on_ui_change=function(eU,eW){var eV;eV=eW.clicked_val;if(eV!==this._state){this.$bubble_picker.controller().set_value(this._state);return this.set_state(eV)}};T.prototype.update_picker_ui=function(){this.$bubble_picker.controller().set_value(this._state);return this.$bubble_picker.find(".bubble-picker-label .role-option").addClass("title_bubble")};T.prototype.limit_to_role=function(eX,eV){var eU,eW;if(eX!=null){this.ensure_role_is_visible(eX);for(eU in dI){eW=dI[eU];if(eW===eX||eW===dI.ALL){continue}this.$bubble_picker.controller().disable_option(eW,eV)}}else{for(eU in dI){eW=dI[eU];this.$bubble_picker.controller().enable_option(eW)}}return this._limit_to_role=eX};return T})(eC);eE=B.PageRoleSelect=(function(eT){cA(T,eT);function T(eV,eU){if(eU==null){eU={}}eU.allow_merged_state=false;T.__super__.constructor.call(this,eV,eU)}T.prototype.on_state_change=function(eV){var eU;eU=(function(){switch(eV){case dI.PERSONAL:return Constants.ROLE_PERSONAL;case dI.WORK:return Constants.ROLE_WORK}})();return aX.emit(eU)};return T})(dW);var b5;b5=B.SickInput={init:function(){var eW,eV,eT,eU,T;eU=$$(".sick-input");T=[];for(eV=0,eT=eU.length;eV<eT;eV++){eW=eU[eV];if(!eW.hasClassName("sickified")){T.push(this._create(eW))}}return T},_create:function(eV){var eU,T,eT;if(eV==null){return}eU=eV.identify();T=eV.down("input")||eV.down("textarea")||eV.down("select");T.observe("focus",function(){return eV.addClassName("focused")});T.observe("blur",function(){return eV.removeClassName("focused")});eT=function(){if(eV.hasClassName("populated")&&T.getValue()===""){eV.removeClassName("populated")}else{if(!eV.hasClassName("populated")&&T.getValue()!==""){eV.addClassName("populated")}}if(eU in b5._handler_map){return b5._handler_map[eU]()}};bF.show_errors();eT();return setInterval(eT,100)},_handler_map:{},add_interval_handler:function(eT,T){var eU;eU=eT.identify();return this._handler_map[eU]=T},remove_interval_handler:function(eT,T){var eU;eU=eT.identify();if(this._handler_map[eU]===T){return delete this._handler_map[eU]}}};var cP;cP=B.SuggestionInput={register:function(eT){var T;eT=$(eT);T=eT.up("form");if(cP.defaulted(eT)||eT.getValue()===""){eT.setValue(eT.title)}else{eT.addClassName("suggestion-input-unfaded")}eT.observe("blur",this.blur.bind(this));eT.observe("focus",this.focus.bind(this));eT.observe("db:value_change",this.focus.bind(this));if(T){if(!eT.id){eT.id="r_elm_id_"+(Math.random().toString())}return T.observe("submit",cP.blank(eT.id).bind(this))}},register_all:function(){var eU,eW,eT,eV,T;eV=$$(".suggestion-input");T=[];for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];T.push(this.register(eU))}return T},blank:function(T){return(function(eT){return function(){var eU;eU=$(T);if(!eU){return}if(eT.defaulted(eU)){return eU.setValue("")}}})(this)},defaulted:function(T){T=$(T);return T.getValue()===T.title},do_blank:function(T){return this.blank(T)()},clear:function(T){var eT;eT={target:T};return this.focus(eT)},focus:function(T){var eT;eT=$(T.target);if(!eT){return}if(this.defaulted(eT)){eT.addClassName("suggestion-input-unfaded");return eT.setValue("")}},blur_elm:function(T){if(T.getValue()===""){T.removeClassName("suggestion-input-unfaded");T.setValue(T.title)}return T.blur()},blur:function(T){var eT;eT=$(T.target);if(!eT){return}return this.blur_elm(eT)},reset:function(eT){var T;T=$(eT);if(!T){return}T.removeClassName("suggestion-input-unfaded");T.setValue(T.title);T.defaulted=true;return T.blur()},setValue:function(T,eT){var eU;eU=$(T);if(!eU){return}eU.addClassName("suggestion-input-unfaded");eU.setValue(eT);return eU.defaulted=false}};var bd;bd=B.TitleBubble=(function(){var eU,eT,eY,eV,eW,T,eX;eX=0;eU=0;T=function(eZ){return eX=eZ};eW=function(e5){var fa,e8,e2,e6,e1,eZ,e7,e4,e0,e3,e9;e6=br(e5.currentTarget);e9=e6.attr("title");if(e9!=null?e9.length:void 0){e6.attr("data-title",e9);e6.removeAttr("title")}e2=parseInt(e6.data("title-delay"));e8="title-bubble-"+(eU++);e6.data("bubble-id",e8);fa=br("<div/>",{id:e8,"class":"title_bubble_container"});if(!e2){fa.css({opacity:0});fa.addClass("has-transition")}if(e6.hasClass("white")){fa.addClass("white")}if(e6.hasClass("black")){fa.addClass("black")}fa.text(e6.attr("data-title"));e7=e6.attr("data-title-html");fa.html(e7);e0=e6.attr("data-title-hide-tail")!=="yes";if(e0){e3=br("<div/>",{"class":"tail"});fa.append(e3)}br(document.body).append(fa);eZ=eY(e6[0],fa[0]);e1=eT(eZ,fa[0],e6[0]);fa.clonePosition(e6,{setWidth:false,setHeight:false,offsetTop:e1.top-eX,offsetLeft:e1.left});fa.addClass("position-"+eZ);if(e0){e3.clonePosition(e6,{setWidth:false,setHeight:false,setTop:false,offsetLeft:e1.left+e1.tail_offset_left+(br(fa).outerWidth()/2)})}e4=function(){var fb;if(!((fa.data("pending-delay"))&&(e6.data("bubble-id")===e8))){return}fb=(parseInt(e6.data("title-fade-time")))||400;return fa.fadeIn(fb)};if(e2){fa.hide();fa.data("pending-delay",true);return setTimeout(e4,e2)}else{return fa.css({opacity:""})}};eY=function(e3,eZ){var e2,e1,e0;e3=$(e3);e0=e3.getAttribute("data-title-position");e2=document.viewport.getDimensions();e1=e3.viewportOffset();if(!(e0==="above"||e0==="below"||e0==="right"||e0==="left")){e0="above"}if(e0==="left"){if(e1.left<eZ.width){return"right"}}else{if(e0==="right"){if(e2.width-(e1.left+e3.getWidth())<eZ.width){return"left"}}else{if(e0==="below"){if(e2.height-(e1.top+e3.getHeight())<eZ.height){return"above"}}else{if(e0==="above"){if(e1.top<eZ.height){return"below"}}}}}return e0};eT=function(e1,e8,e4){var e6,e2,e9,e5,e7,e3,eZ,fb,fa,e0;e8=$(e8);e4=$(e4);e9=document.viewport.getDimensions();e6=e8.getDimensions();e5=e4.viewportOffset();e2=6;e7=0;e3=0;fa=0;e0=0;if(e1==="below"||e1==="above"){if(e1==="below"){e3=e4.getHeight()+e2}else{e3=(-1*e6.height)-e2}eZ=e4.getWidth()/2-e6.width/2;if(e5.left+eZ+e6.width>e9.width){e7=e9.width-e5.left-e6.width;fa=eZ-e7-5}else{e7=eZ;fa=-5}}if(e1==="left"||e1==="right"){if(e1==="right"){e7=e4.getWidth()+e2}else{e7=(-1*e6.width)-e2}fb=e4.getHeight()/2-e6.height/2;if(e5.top+fb+e6.height>e9.height){e3=e9.height-e5.top-e6.height;e0=fb-e3-5}else{e3=fb;e0=-5}}return{left:e7,top:e3,tail_offset_left:fa,tail_offset_top:e0}};eV=function(e0){var eZ,e1,e2;e2=br(e0!=null?e0.currentTarget:void 0);eZ=br("#"+e2.data("bubble-id"));if(eZ.data("pending-delay")){eZ.removeData("pending-delay");e1=(parseInt(e2.data("title-fade-time")))||400;return eZ.fadeOut(e1,function(){return eZ.remove()})}else{return eZ.remove()}};return{init:function(){br(document).on("mouseenter",".title_bubble",eW);br(document).on("mouseleave",".title_bubble",eV).on("mouseup",".title_bubble",eV);br(document).on("mouseenter",".title_bubble_sticky",eW);return br(document).on("mouseleave",".title_bubble_sticky",eV)},set_vertical_space:T,hide_all:function(){return br(".title_bubble_container").remove()}}})();var dZ;dZ=INLINE_JS.Tooltip=B.Tooltip={attach:function(eX,eU,T,eT){var eW,eV;if(eT==null){eT={}}eX=$(eX);T=(T?$(T):null);eW=d3.make(eU,eX.tail_position,eT.tail_position,eT.width,eT);eW.setStyle({display:"none",position:"absolute"});$("floaters").__sert(eW);if(eX.match("#modal-content *")||eX.match(".db-modal-content *")){eW.style.zIndex="13001"}else{eW.style.zIndex=""}if(eX.tail_position==="right"){eV=(dL.ie?32:12);eW.style.marginLeft=-(eW.getWidth()+eX.getWidth()+eV)+"px"}eX.tooltip=eW;eX.out_target=(T?true:false);eX.observe("mouseout",this.mouseout("target",eX));eX.observe("mouseover",this.mouseover("target",eX));eX.out_trigger=(T?false:true);if(T){T.observe("mouseout",this.mouseout("trigger",eX));T.observe("mouseover",this.mouseover("trigger",eX))}eX.out_tooltip=true;eW.observe("mouseout",this.mouseout("tooltip",eX));return eW.observe("mouseover",this.mouseover("tooltip",eX))},update:function(eT,T){if(eT.tooltip){return $(eT.tooltip).update(T)}},mouseover:function(T,eT){return function(){return eT["out_"+T]=false}},mouseout:function(T,eT){return function(){eT["out_"+T]=true;return dZ.hide_if_out.defer(eT)}},show_by:function(eT){var eU,T;eU=br(eT.tooltip);eT=br(eT);eU.show();T=Math.floor(eU[0].offsetHeight/2);return eU.clonePosition(eT,{setWidth:false,setHeight:false,offsetTop:Math.floor(eT[0].offsetHeight/2)-T,offsetLeft:eT[0].offsetWidth+1})},hide_if_out:function(T){var eT;if(!T.out_target||!T.out_trigger||!T.out_tooltip){return}eT=$(T.tooltip);return eT.hide()},show:function(eW,eV,eT,T,eU){if(T==null){T="left"}eW=$(eW);if(!eW.tail_position){eW.tail_position=T}eT=(eT?$(eT):null);if(!eW.tooltip){this.attach(eW,eV,eT,eU)}return this.show_by(eW)}};var bP;bP=INLINE_JS.TreeView=B.TreeView={tv:{},loaded:false,user:null,role_icon:"",set_params:function(T){return this.ajax_params=T},init:function(eU,T,eV){var eT;if(eV==null){eV="treeview"}this.tv[eV]={};eT=this.tv[eV];eT.autohide=(T===null?true:T);eT.handler=eU;eT.viewdiv=$(eV);eT.hidefunc=this.hide.bindAsEventListener(this);this.ajax_params={};document.observe(bq.ADD,(function(eW){return function(eX){return eW.schedule_reset()}})(this));document.observe(bq.REMOVE,(function(eW){return function(eX){return eW.schedule_reset()}})(this));return document.observe(bq.MOVE,(function(eW){return function(eX){return eW.schedule_reset()}})(this))},schedule_reset:function(){return this.loaded=false},reset:function(eX){var eU,eV,eT,eZ,T,eW,eY;eU={url:"/ajax_subtreeview",type:"post",data:br.extend({},this.ajax_params),success:(function(e0){return function(e2){var e3,e1;e1=[];for(e3 in e0.tv){if(e0.tv.hasOwnProperty(e3)){e0.tv[e3].viewdiv.down(".treeview-folders").update(e2);if(eX&&eX.onSuccess){e1.push(eX.onSuccess(e2))}else{e1.push(void 0)}}else{e1.push(void 0)}}return e1}})(this)};if(eX!=null?eX.user:void 0){if(eX.user.id!==((eY=this.user)!=null?eY.id:void 0)){eZ=br("<p />",{id:"treeview-loading"});T=br("<img />",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});eZ.append(T);eW=" "+ef("Loading your folders");eZ.append(eW);br("#dest-treeview .treeview-folders").html(eZ);this.user=eX.user}eU.subject_user=eX.user;eT=cy.get_role_title(eX.user);if(cy.get_viewer().is_paired){if(eX.user.is_team){eV="s_briefcase"}else{eV="s_house"}}else{eV="dropbox"}if(!eT){eT=ef("Dropbox")}br("#first-treeview-link span").text(eT);cj.replace(br("#root-img")[0],"web",this.role_icon,eV);this.role_icon=eV}else{br("#first-treeview-link span").text(ef("Dropbox"))}return br.ajax(eU)},toggle:function(eU,eT){var T;Event.stop(eU);T=this.tv[eT||"treeview"];if(T.shown){T.shown=false;this.hide(eU,eT)}else{T.shown=true;this.show(eU.target,eT)}return false},hide:function(eU,eT){var T;T=this.tv[eT||"treeview"];if(!eU||!$(eU.target).descendantOf(T.viewdiv)){T.viewdiv.hide();Event.stopObserving(window,"click",T.hidefunc);return T.shown=false}},show:function(eU,eT){var eV,T;T=this.tv[eT||"treeview"];eU=$(eU);eU.blur();eV=eU.cumulativeOffset();T.viewdiv.setStyle({top:(eV.top+eU.getHeight())+"px",left:(eV.left-4)+"px"});T.viewdiv.show();return Event.observe(window,"click",T.hidefunc)},toggleNode:function(eT){var T;eT=$(eT);T=eT.down("img");if(T.className.match("bullet_plus")){cj.replace(T,"web","bullet_plus","bullet_minus")}else{cj.replace(T,"web","bullet_minus","bullet_plus")}eT.up().next("div").toggle();eT.blur();return false},toggleNodeAjax:function(eV,T,eT){var eU,eW;if(eV.fetched_children){return this.toggleNode(eV)}eV=$(eV);eU=eV.down("img");eW=cj._get(eU);eU.src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif";br.ajax({url:"/ajax_subtreeview"+T,type:"post",data:br.extend({},this.ajax_params),subject_user:eT,success:(function(eX){return function(eY){var eZ;eZ=new Element("div",{style:"display: none;"}).update(eY);eV.up().__sert({after:eZ});eV.fetched_children=true;cj._set(eU,eW);return eX.toggleNode(eV)}})(this),complete:function(){if(/loading/.match(eU.src)){return cj._set(eU,eW)}}});return false},handle:function(eU,eT){var eV,T;eV=$H(this.tv).keys();T=$(eT).ancestors().find(function(eW){return eV.include(eW.id)});if(!T){return}T=this.tv[T.id];br(document).trigger("db:treeview_selected",[eU]);if(T.handler){T.handler(eU,eT)}if(T.autohide){this.hide(T.id)}return false},move:function(eU,eV,eT){var T;T=$(eU);if(!this.loaded){this.reset({onSuccess:(function(eW){return function(){eW.loaded=1;return eW.move(eU,eV,eT)}})(this),user:eT!=null?eT.user:void 0})}else{if(eT&&eT.onSuccess){eT.onSuccess()}}cw(T,"Couldn't find tree_id");cw($(eV),"Couldn't find location_id");$(eV).appendChild(T);return T.show()}};var aI;aI=B.ULSelectMenu=(function(){var eV,eZ,eU,e0,e1,eW,eY,T,eX,eT,e2;eV=function(e3){return e3.removeClassName("shown")};e2=function(e3){return e3.toggleClassName("shown")};eY=function(){return this.removeClassName("hover")};eW=function(){return this.addClassName("hover")};T=function(e7,e6){var e3,e8,e5,e4;e4=[];for(e8=0,e5=e6.length;e8<e5;e8++){e3=e6[e8];e4.push(e7.insert(e3))}return e4};e0=function(e5,e3,e4){T(e5,e4);if(e5.firstChild!==e3){return e5.__sert({top:e3})}};eX=function(e4,e5){var e3;e3="selected";br(e4).find("."+e3).removeClass(e3);return br(e5).addClass(e3)};eT=function(e5,e8){var e9,e7,e4,e6,e3;e6=e5.select("li");e3=[];for(e7=0,e4=e6.length;e7<e4;e7++){e9=e6[e7];if(e9.getAttribute("data-value")===e8){e3.push(eX(e5,e9))}else{e3.push(void 0)}}return e3};e1=function(e3,e5,e4){return function(e6){if(!e3.hasClassName("selected")){eX(e5,e3);e5.fire("db:change",e3.getAttribute("data-value"));return eV(e5)}else{e0(e5,e3,e4);return e2(e5)}}};eZ=function(e5){var e8,fb,e7,e4,fa,e3,e6,e9;fb=e5.select("li");cw(fb.length,"Empty list of options "+e5.identify());e7=void 0;if(fb.length===1){e5.addClassName("one")}else{for(e6=0,e9=fb.length;e6<e9;e6++){e8=fb[e6];fa=e8.getAttribute("data-value");cw(fa,e8.identify()+" missing data value");e8.observe("click",e1(e8,e5,fb));e8.observe("mouseenter",eW);e8.observe("mouseleave",eY);if(e8.hasClassName("selected")){e7=e8}}$(document.body).observe("click",function(fc){if($(fc.target).up(".ul_select_menu")===e5){return}return eV(e5)})}if(!e7){e7=fb[0]}e7.addClassName("selected");e3=new Element("span");e4=e7.getDimensions();e3.setStyle({width:e4.width+"px",height:e4.height+"px",position:"relative",display:"inline-block"});return e5.wrap(e3)};eU=function(){var e7,e6,e4,e5,e3;e5=$$(".ul_select_menu");e3=[];for(e6=0,e4=e5.length;e6<e4;e6++){e7=e5[e6];e3.push(eZ(e7))}return e3};br(eU);return{init:function(e3){return eZ(e3)},set_selected_by_value:eT}})();var F;F=B.DBCalendar=Class.create({initialize:function(eT,T){this.options=T||{};this.container=$(eT);cw(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=dL.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=dL.start_of_day(this.options.first_day||this.today)}this.view_date=dL.start_of_day(this.options.selected_date||this.today);this.selected_date=dL.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(eT,T){Event.stop(eT);this.view_date.setMonth(T);return this.render()},is_valid_date:function(eV,eX,eW,eU,T){var eT;eV=parseInt(eV,10);eX=parseInt(eX,10);eW=parseInt(eW,10);eU=parseInt(eU,10);T=parseInt(T,10);eU=eU||1970;T=T||(new Date()).getFullYear()+1;eX+=1;if(eW<eU){return false}if(eW>T){return false}if(eX<1||eX>12){return false}if(eV<=0){return false}if(eX===2){eT=((eW%4)===0)&&(((eW%100)!==0)||((eW%400)===0));if(eT){return eV<=29}else{return eV<=28}}else{if(eX===4||eX===6||eX===9||eX===11){return eV<=30}else{return eV<=31}}},change_date:function(T,eV,eT){var eU;if(!this.is_valid_date(T,eV,eT)){return}eU=eT!==this.view_date.getFullYear()||eV!==this.view_date.getMonth();this.selected_date=new Date(eT,eV,T);if(eU){this.view_date.setMonth(eV);this.view_date.setFullYear(eT);this.render()}else{br(this.container).find(".selected").removeClass("selected");br(this.container).find("a#day"+T+"-"+eV).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var eV,e1,eZ,eX,eW,eT,eY,eU,e0,T;e1=this.render_days();eX=br(".current-month",e1);eY=eX.first().data("date");eT=eX.last().data("date");T=eY<=this.options.first_day;e0=eT>=this.options.last_day;eV=new Element("div");eV.addClassName("calendar clearfix");if(!e0){this._next_month=(function(e2){return this._change_month(e2,this.view_date.getMonth()+1)}).bind(this);eW=new Element("a");eW.addClassName("changemonth next");eW.update(cj.make("web","arrowright",{}));Event.observe(eW,"click",this._next_month);eV.__sert(eW)}if(!T){this._prev_month=(function(e2){return this._change_month(e2,this.view_date.getMonth()-1)}).bind(this);eU=new Element("a");eU.addClassName("changemonth prev");eU.update(cj.make("web","arrowleft",{}));Event.observe(eU,"click",this._prev_month);eV.__sert(eU)}eZ=new Element("h5");eZ.update(ef("%(month)s %(year)s",{comment:"For example 'January 2010'. This is used as part of a calendar."}).format({month:bR.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));eV.__sert(eZ);eV.__sert(e1);return this.container.__date(eV)},render_days:function(){var eZ,eY,T,eX,eT,eW,eV,eU;eY=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);eV=eY.getDay();eZ=new Element("div");eZ.addClassName("days");for(T=eU=eV;eV<=0?eU<0:eU>0;T=eV<=0?++eU:--eU){eW=new Date(eY.getFullYear(),eY.getMonth(),eY.getDate());eW.setDate(eW.getDate()-T);eZ.__sert(this.render_day(eW,true))}eX=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(eX.getMonth()===this.view_date.getMonth()){eZ.__sert(this.render_day(eX));eX=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),eX.getDate()+1)}eT=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(eT.getDay()!==6){eT=new Date(eT.getFullYear(),eT.getMonth(),eT.getDate()+1);eZ.__sert(this.render_day(eT,true))}return eZ},render_day:function(eT,eV){var T,eU;eU=!eV;if(this.options.last_day){eV=eV||eT>this.options.last_day}if(this.options.first_day){eV=eV||eT<this.options.first_day}T=new Element(eV?"span":"a");br(T).data("date",eT);if(eU){T.addClassName("current-month")}T.update(eT.getDate());T.addClassName("date");T.writeAttribute("id","day"+eT.getDate()+"-"+eT.getMonth());if(this.selected_date.getDate()===eT.getDate()&&this.selected_date.getMonth()===eT.getMonth()&&this.selected_date.getFullYear()===eT.getFullYear()){T.addClassName("selected")}if(eV){T.addClassName("inactive")}else{this._handler=(function(eX){var eW;eW=eX.target.identify().substr(3).split("-");return this.change_date(eW[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(T,"click",this._handler)}return T}});var aK;aK=B.DatePickerInput=Class.create({initialize:function(T,eU){var eX,eV,eW,eT;this.container=T;this.options={};Object.extend(this.options,eU||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");eT=(this.input.value?dL.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){eW=dL.from_mysql_date(this.container.getAttribute("data-first"))}eX=this.options.disable_future!=null?this.options.disable_future:true;eV=this.options.disable_past!=null?this.options.disable_past:true;this.cal_container=this.container.down(".cal-container");this.calendar=new F(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:eW,disable_future:eX,disable_past:eV,selected_date:eT});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(eT)},show_cal:function(eT){var T;if(eT){Event.stop(eT)}T=$(eT.target);if(T.match(".cal-container")||T.up(".cal-container")){return}br(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(T){this.input.value=dL.to_mysql_date(T,false);this.display.update(K.localize(T));return this.hide_cal()}});var eQ;eQ=B.TextInputDatePicker=Class.create({initialize:function(eV,eU){var eX,eW,eT,T;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,eU||{});this.input=$(eV);cw(this.input,"Couldn't find the element "+eV.toString());eT=new Date();T=(this.input.value?dL.from_mysql_date(this.input.value):false);eW=new Date(eT.getUTCFullYear(),eT.getUTCMonth(),eT.getUTCDate());this.cal_icon=cj.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+eV,style:"display: none; position: absolute; z-index: 1"});this.calendar=new F(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:eW,selected_date:T});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));eX=br(this.input);br(this.cal_container).clonePosition(eX,{setWidth:false,setHeight:false,offsetTop:eX[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(T){if(T){Event.stop(T)}return this.cal_container.toggle()},hide_cal:function(T){if(T){Event.stop(T)}return this.cal_container.hide()},onDateChange:function(T){if(this.options.choose_eod){T.setTime(dL.start_of_day(T).getTime()+86399999)}this.input.value=dL.to_mysql_date(T,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});ah.window_load(R.register.bind(R));br(b5.init.bind(b5));br(cP.register_all.bind(cP));Event.observe(window,"scroll",function(){return bd.hide_all()});br(function(){Y.interval=setInterval(Y.check.bind(Y),500);du.init();return bd.init()});var aN;aN=B.LocaleSelector={init:function(){br(document).on("click",".modal-locale-link",(function(T){return function(eT){eT.preventDefault();return T.show()}})(this));br(document).on("click",".modal-locale-link-index-page",(function(T){return function(eT){eT.preventDefault();T.logShow();return T.show()}})(this));return br(document).on("click",".modal-team-locale-link",(function(T){return function(eT){eT.preventDefault();return T.show_team_modal()}})(this))},show:function(){if(!this.modal){this.modal=new eG({element_id:"locale-selector-modal"})}return this.modal.show()},logShow:function(){return br.ajax({url:"https://"+Constants.WEBSERVER+"/log_user_opened_locale_selector",type:"POST"})},show_team_modal:function(){if(!this.team_modal){this.team_modal=new bb({element_id:"locale-selector-modal"})}return this.team_modal.show()}};br(function(){return aN.init()});var a4,ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV};a4=INLINE_JS.ChangeNameModal=B.ChangeNameModal=(function(T){cA(eT,T);function eT(){eT.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=(function(eU){return function(eY){var eX,eV,eW;eY.preventDefault();eX=br(eY.target);eV=eX.closest("form");eW=function(){eU.hide();return location.reload()};return bF.ajax_submit(eV[0],false,eW,null,eX[0])}})(this)}return eT})(dN);var bI,d9,db=function(T,eT){return function(){return T.apply(eT,arguments)}},ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV};d9=B.ManageAliasModal=(function(eT){cA(T,eT);function T(eU){this.options=eU;this._poll_until_verified=db(this._poll_until_verified,this);this._get_params_from_target=db(this._get_params_from_target,this);this._on_load=db(this._on_load,this);this._show_action_panel=db(this._show_action_panel,this);this._input_enter_handler=db(this._input_enter_handler,this);this.resend_verify=db(this.resend_verify,this);this.remove_alias=db(this.remove_alias,this);this.add_alias=db(this.add_alias,this);this.refresh_alias=db(this.refresh_alias,this);this.on_show=db(this.on_show,this);T.__super__.constructor.call(this,this.options)}T.prototype.before_show=function(eU){T.__super__.before_show.call(this,eU);this.polling=0;eU.find(".alias-action").on("click",this._show_action_panel);eU.find(".alias-action-submit").on("click",this.add_alias);eU.find("form").submit(function(){return false});return eU.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};T.prototype.on_show=function(){return this.refresh_alias(true,this._poll_until_verified)};T.prototype.refresh_alias=function(eV,eU){if(eV==null){eV=true}if(eV){bF.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:(function(eW){return function(eX){eW.$modal_window.find(".dynamic-content").html(eX.responseText);eW._on_load(eX);if(typeof eU==="function"){return eU()}}})(this),onFailure:(function(eW){return function(eX){return eW.hide()}})(this)})};T.prototype.add_alias=function(eX){var eW,eU,eV,eY;eX.preventDefault();eU=br(eX.currentTarget).closest("form");eW=eU.find(".alias-action-submit");eY={};eY[Constants.UID_PARAM_NAME]=this.options.subject_user.id;eV=(function(eZ){return function(){var e0;eZ.$modal_window.find(".alias-action-inputs input").val("");eZ.polling=0;e0=eZ.polling?null:eZ._poll_until_verified;return eZ.refresh_alias(true,e0)}})(this);return bF.ajax_submit(eU[0],false,eV,false,eW[0],eY,"before")};T.prototype.remove_alias=function(eU){var eV;eU.preventDefault();eV=this._get_params_from_target(eU.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:eV,onSuccess:(function(eW){return function(eX){return eW.refresh_alias()}})(this)})};T.prototype.resend_verify=function(eU){var eV;eU.preventDefault();eV=this._get_params_from_target(eU.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:eV,onSuccess:(function(eW){return function(eX){return eW.refresh_alias()}})(this)})};T.prototype._input_enter_handler=function(eU){eU.preventDefault();eU.stopPropagation();if(eU.which===13){return this.add_alias(eU)}};T.prototype._show_action_panel=function(eW){var eV,eU;eW.preventDefault();eU=br(eW.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();eV=this.$modal_window.find("#"+eU).show();return eV.find("input:visible:enabled:first").focus()};T.prototype._on_load=function(eU){a3.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",(function(eV){return function(eW){return eV.remove_alias(eW)}})(this));return this.$dynamic.on("click",".alias-verify",(function(eV){return function(eW){return eV.resend_verify(eW)}})(this))};T.prototype._get_params_from_target=function(eW){var eU,eV,eX;eU=br(eW);eX=eU.data("alias-type");eV=eU.closest(".alias-row").find(".alias-text").text();return{alias:eV,alias_type:eX}};T.prototype._poll_until_verified=function(){var eW,eX,eV,eU;eX=5;eW=60;eV=(function(eY){return function(){return eY.refresh_alias(false,eY._poll_until_verified)}})(this);eU=this.$dynamic.find(".alias-verify").length;if(eU&&this.polling<eW){this.polling++;return setTimeout(eV,eX*1000)}else{return this.polling=0}};return T})(dN);bI=INLINE_JS.AliasManager=B.AliasManager={show:function(eW){var eU,eV,eT,T;T=cy.get_viewer().get_user_by_role(eW);if(T==null){return}if(!T.is_email_verified){if(eW===Constants.ROLE_PERSONAL){personal_email_verification.verified_or_show()}else{work_email_verification.verified_or_show()}return}eT=cy.get_viewer().is_paired?eW:"";eV=ef("Manage your %(role_show)s contact methods").format({role_show:eT});eU=new d9({element_id:"manage-alias",title:eV,subject_user:T,role:T.role});eU.show()}};var dd;dd=INLINE_JS.BonusTable=B.BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(T){this.user_id=T;if(dd._inited){return}dd._inited=true;$("bonus-loading").show();dd._tmpl=eP.tmpl("bonus_row_tmpl");dd.listen();return dd.get_next_page()},_render:function(eV){var eT,eW,eU,T;eT=[];for(eU=0,T=eV.length;eU<T;eU++){eW=eV[eU];eT.push(dd._tmpl({row:eW,Sprite:cj}))}return $("bonus-table").__sert(eT)},get_next_page:function(){if(dd._fetching_page){return}dd._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+dd._next_page,{onSuccess:function(eT){var eV,T,eU;eV=eT.responseText.evalJSON();eU=eV.rows;T=eV.has_more;dd._render(eU);$("bonus-loading").hide();if(T){dd._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return dd._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(eT){var T,eV,eU;eV=br(eT.currentTarget);eU=ef("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");T=br(d3.make(eU,"right","middle"));Element.absolutize(T[0]);eV.append(T);T.clonePosition(eV,{setWidth:false,setHeight:false});return T.css({width:"200px",left:(parseInt(T.css("left"),10)-210)+"px",top:(parseInt(T.css("top"),10)-55)+"px"})},_max_referral_out:function(eX){var T,eW,eU,eV,eT;eV=br(".reached-max-referral-bonus .bubble");eT=[];for(eW=0,eU=eV.length;eW<eU;eW++){T=eV[eW];eT.push(T.remove())}return eT},listen:function(){br("#load-more-bonus").on("click",dd.get_next_page.bind(dd));br(document).on("mouseenter",".reached-max-referral-bonus",dd._max_referral_over);return br(document).on("mouseleave",".reached-max-referral-bonus",dd._max_referral_out)},toggle:function(){if(br("#bonus-list").is(":visible")){this.hide();return br("#space-earned-link").text(ef("View all space earned"))}else{this.show();return br("#space-earned-link").text(ef("Hide space earned"))}},show:function(){return br("#bonus-list").slideDown(150)},hide:function(){return br("#bonus-list").slideUp(150)}};var A,s,c;A=INLINE_JS.DowngradeReasons=B.DowngradeReasons={reasons:{},addReason:function(T){return this.reasons[T]=true},addReasons:function(T){var eV,eW,eU,eT;eT=[];for(eW=0,eU=T.length;eW<eU;eW++){eV=T[eW];eT.push(this.addReason(eV))}return eT},change:function(eX,eU,T){var eY,e0,eZ,eV,eT,eW;eX=parseInt(eX,10);e0=$(eU);cw(e0,"Couldn't find container for DowngradeReason");eY=false;eW=this.reasons;for(eV in eW){eZ=eW[eV];eT=$(T+eV);cw(eT,"Couldn't find container for ",T+eV);if(eZ&&parseInt(eV,10)===eX){eT.show();eY=true}else{eT.hide()}}if(eY){return e0.show()}else{return e0.hide()}}};s=B.DowngradeReasons2={init:function(){var eT,eV,T,eU;eU=["input[name=downgrade_reason_id]","input[name=other_reason_id]"];for(eV=0,T=eU.length;eV<T;eV++){eT=eU[eV];br(eT).change(function(eX){var eW;eW=eX.target.id.indexOf("other")>=0;return s.change(eW,eX.target.getValue())})}return br(".shared-additional-info").attr("name","shared_additional_info")},change:function(eU,T){var eT;br(".downgrade-other-reason .error-message").hide();if(eU){return}eT="#downgrade-info-"+T;br(".downgrade-info").hide();br(eT).show();br(".downgrade-info textarea").removeAttr("name");br(eT+" textarea").attr("name","additional_info");return br("input[name=other_reason_id]").removeAttr("checked")}};c=B.DowngradeSurvey={init:function(){var T;T="#downgrade-survey-form";return br(""+T).on("submit",(function(eT){return function(eW){var eV,eU;eU=br(""+T+" input[name=other_reason_id]:checked").length;eV=br(""+T+" input[id=downgrade-radio-8]");if(eV.is(":checked")&&eU===0){br(".downgrade-other-reason .error-message").show();return eW.preventDefault()}}})(this))}};var bY;bY=INLINE_JS.GetSpace=B.GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(eU,eT,eV){var T;bY._current_space=eU;bY._why_msg=eT;bY._twitter_url=eV;$("space-actions").on("click",".space-action",bY.perform_action);T=D.parse(window.location.href).fragment;if(T){return bY.highlight_offer(T)}},highlight_offer:function(eT){var T,eU;T=br("#"+eT);eU=T.css("background-color");return T.css("background-color",bY.offer_highlight_color).delay(2000).animate({"background-color":eU}).queue(function(){return T.css("background-color","")})},perform_action:function(eT){var eU,T;T={contact_sales:bY._contact_sales,contact_support:bY._contact_support,teams:bY._teams,upgrade:bY._upgrade,plans:bY._plans,refer:bY._refer,get_started:bY._get_started,fb_link:bY._fb_link,twitter_link:bY._twitter_link,twitter_follow:bY._twitter_follow,why_like:bY._why_like,mailbox_link:bY._mailbox_link};eU=$(eT.target);if(!eU.hasClassName("space-action")){eU=eU.up(".space-action")}return T[eU.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return d7.do_auth(function(){bY._refresh_link_bonuses();return bY._completed($("fb_link"))},cy.get_viewer().personal_user.id)},_twitter_link:function(){return cq.do_auth(function(){bY._refresh_link_bonuses();cq.set_is_authed(cy.get_viewer().personal_user.id,true);return bY._completed($("twitter_link"))},cy.get_viewer().personal_user.id)},_twitter_follow:function(){if(cq.is_authed(cy.get_viewer().personal_user.id)){return bY.follow_dropbox()}else{return cq.do_auth(bY.follow_dropbox,cy.get_viewer().personal_user.id)}},_why_like:function(){eM.show(ef("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return dL._track_twitter_chars_left("why-i-like-input",90)},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!cq.is_authed(cy.get_viewer().personal_user.id)){bY._refresh_link_bonuses();cq.set_is_authed(cy.get_viewer().personal_user.id,true)}return cq.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(ef("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(ef("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){bY._completed($("twitter_link"))}return bY._completed($("twitter_follow"))}},cy.get_viewer().personal_user.id)},submit_why:function(){bY._why_msg=$F("why-i-like-input");return bF.ajax_submit($("why-i-like-form"),false,(function(){eM.hide();return bY._completed($("why_like"))}),false,$("why-i-like-submit"))},_completed:function(eT){var T;eT.addClassName("completed");eT.down(".icon-col").__date(cj.make("web","check_36"));br(eT).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return br(eT).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);T=parseInt(eT.down(".space").readAttribute("data-space"),10);bY._current_space+=T;$("current-space").__date(az.format_bytes(bY._current_space));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var bm;bm=B.Help={toggle_more_help:false,show_os:function(eT,eU,T){eU=$(eU);$$(".os-filter").invoke("removeClassName","selected");eU.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+T).invoke("show");return Event.stop(eT)},vote:function(T,eT){new Ajax.DBRequest("/help/"+T+"/vote/"+eT);br("#help-vote-cont").fadeOut();return ab.success(ef("Thanks for your feedback!"))}};var ec,dB,aa,r,db=function(T,eT){return function(){return T.apply(eT,arguments)}},ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV};dB=INLINE_JS.Hosts=B.Hosts={attach_host_listener:function(eW,eU){var eT,eV,eX,T;eT=br("#"+eW);eX=eT.data("host-ids");eV=eT.data("display-name");T=function(){return new aa(eX,eV,eU,null,null).show()};return br(".unlink-host-link",eT).on("click",T)},edit:function(eX,eU){var eT,eY,eZ,eW,eV,T;eZ=br("#host-device-row-"+eU+" .host-item .sprite-text");if(eZ.data("editing")==="true"){return false}eZ.data("editing","true");eY=eZ.text();eZ.data("previous",eY);eX=$u.values(eX);eW=br('<input type="text" class="name-input skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" />').val(eY);T=br('<input type="button" class="button">').val(ef("Save"));T.on("click",function(){return dB.doneEditing(eX,eU)});eT=br('<input type="button" class="button grayed">').val(ef("Cancel"));eT.on("click",function(){return dB.cancelEditing(eU)});eZ.empty();eZ.append(eW,"&nbsp;",T,"&nbsp;",eT);eV=br("input",eZ);eV.on("keydown",function(){return dB.checkKey(eX,eU)});return eV.focus()},doneEditing:function(eU,eT){var eV,T;eV=br("#host-device-row-"+eT+" .host-item .sprite-text");T=br("input",eV).val();return br.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(eU),name:T},type:"POST"}).success(function(eW){return dB.unedit(eV,JSON.parse(eW).display_name)})},cancelEditing:function(T){var eT;eT=br("#host-device-row-"+T+" .host-item .sprite-text");return dB.unedit(eT,eT.data("previous"))},unedit:function(eT,T){eT.data("editing","false");return eT.text(T)},dismiss:function(eU,eT,eV,T,eW){new br.ajax("/account/dismiss_unlink",{type:"POST",data:{host_id:eU,user_id:eT,team_id:eV},subject_user:eW,success:function(eX){return T.remove()}});return false},checkKey:function(eT,T){return function(eU){eU=eU||window.event;if(eU.keyCode===Event.KEY_RETURN){dB.doneEditing(eT,T)}if(eU.keyCode===Event.KEY_ESC){return dB.cancelEditing(T)}}},show_device_unlink_modal:function(eV,eW,eY,eU,eT,e0,T){var eZ,eX;eZ=br("#unlink-device-modal-"+e0);eX={both:$u.values(eT),personal:[eT[Constants.ROLE_PERSONAL]],work:[eT[Constants.ROLE_WORK]]};eM.show(eU,eZ[0]);if($u.values(eT).length>1){eZ.addClass("show-selector")}return br("form input[type=submit]",eZ).on("click",function(e1){e1.preventDefault();eT=eX[br(".unlink-select select",eZ).val()];bF.add_vars(br("form",eZ)[0],{user_ids:JSON.stringify(eT),app_id:eW,device_id:JSON.stringify(eV),device_name:T});return br("form",eZ).submit()})}};ec=B.DeleteFailuresModal=(function(T){cA(eT,T);function eT(){this.on_show=db(this.on_show,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);return eT.__super__.constructor.apply(this,arguments)}eT.prototype.on_confirm_button_click=function(eU){eU.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};eT.prototype.on_show=function(eV){var eU;eU=a1("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(eU)};return eT})(dN);r=INLINE_JS.show_delete_failures_modal=B.show_delete_failures_modal=function(eU,eT,T){var eV;eV=new ec({element_id:"delete-failures-modal"});eV.host_id=eU;eV.name=eT;eV.num_failures=T;eV.show();return false};aa=INLINE_JS.UnlinkHostModal=B.UnlinkHostModal=(function(eT){cA(T,eT);function T(eY,eW,eU,eV,eX){this.host_ids=eY;this.name=eW;this.delete_support_type=eU;this.owner_id=eV;this.team_id=eX;this.on_show=db(this.on_show,this);this._set_delete_text=db(this._set_delete_text,this);this.fail_callback=db(this.fail_callback,this);this.success_callback=db(this.success_callback,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);T.__super__.constructor.call(this,{element_id:"unlink-host-modal"});this.show_host_selector=$u(this.host_ids).values().length>1}T.prototype.on_confirm_button_click=function(eX){var eV,eW,eU;eX.preventDefault();eW=this.$modal_window.find(".unlink_host_form")[0];eV=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");eU={host_ids:JSON.stringify(this.get_selected_hosts())};return bF.ajax_submit(eW,false,this.success_callback,this.fail_callback,eV,eU)};T.prototype.success_callback=function(){return window.location.reload()};T.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};T.prototype._set_delete_text=function(eU){return this.$modal_window.find(".delete_data_label").text(eU)};T.prototype._get_unlink_select=function(){return this.$modal_window.find(".unlink-select select").val()};T.prototype._set_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",true)};T.prototype._clear_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",false)};T.prototype.on_show=function(eV){var eU;this._clear_delete_checkbox();if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_TEAM_ONLY){this._set_delete_checkbox();this.$modal_window.find(".unlink-choice").change((function(eW){return function(eX){if(eW._get_unlink_select()===Constants.ROLE_PERSONAL){eW._clear_delete_checkbox();return eW.$modal_window.find(".new_client").hide()}else{eW._set_delete_checkbox();return eW.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(ef("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cy.get_viewer().team_name}))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_PERSONAL_ONLY){this._set_delete_checkbox();this.$modal_window.find(".unlink-choice").change((function(eW){return function(eX){if(eW._get_unlink_select()===Constants.ROLE_WORK){eW._clear_delete_checkbox();return eW.$modal_window.find(".new_client").hide()}else{eW._set_delete_checkbox();return eW.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(ef("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED){this._set_delete_checkbox();this._set_delete_text(ef("Delete files from these Dropboxes the next time this computer comes online."));this.$modal_window.find(".unlink-choice").change((function(eW){return function(eX){if(eW._get_unlink_select()===Constants.ROLE_PERSONAL){return eW._set_delete_text(ef("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(eW._get_unlink_select()===Constants.ROLE_WORK){return eW._set_delete_text(ef("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cy.get_viewer().team_name}))}else{return eW._set_delete_text(ef("Delete files from these Dropboxes the next time this computer comes online."))}}}})(this))}}}}}if(this.show_host_selector){eU="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(ef("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:eU}))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};T.prototype.get_selected_hosts=function(){var eU;if($u.values(this.host_ids).length===1){return $u.values(this.host_ids)}eU=br(".unlink-choice").val();if(eU==="both"){return $u.values(this.host_ids)}else{return[this.host_ids[eU]]}};return T})(dN);var ep;ep=B.News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(eT,eU){var T;if(eU.hasAttribute("data-div")){eT.preventDefault();T=eU.readAttribute("data-div");return ei.push_state("/news/"+T)}});return ei.add_callback("/news",ep.history_change)},change_tab:function(T){var eT;eT=$$("#nav a[data-div="+T+"]").first();if($(eT)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(eT).addClassName("selected");return $(T).addClassName("selected")}},history_change:function(T){T=T||ep.DEFAULT_TAB;return ep.change_tab(T)}};var dn;dn=B.Recover={init:function(){var T;T=$("recover-form");return T.observe("submit",this.form_submit.bind(this))},form_submit:function(T){this.clear_error();T.preventDefault();return bF.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(eT){var T;T=JSON.parse(eT.responseText);if(T.status==="error"){this.show_error(T.msg)}if(T.status==="ok"){this.show_hosts(T)}if(T.status==="redirect"){return window.location.href=T.url}},show_hosts:function(eZ){var eW,eU,eV,T,eY,eT,eX;bF.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(eZ.filename);eU=$("trusted-hosts");eU.update();eX=eZ.hosts;for(eY=0,eT=eX.length;eY<eT;eY++){eW=eX[eY];T=new Element("li");eV="lnx";if(eW.platform==="mac"){eV="osx"}if(eW.platform==="win"){eV="win"}T.__sert(cj.make("web",eV));T.__sert(new eP(eW.display_name.escapeHTML()));eU.appendChild(T)}$("login-step").hide();return $("hosts-step").show()},show_error:function(T){$("error-messages").update(T);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var c3;c3=B.Restore={next:function(T,eV){var eU,eT;eT=br("ul.selected");eU=eT.next("ul");eU.addClass("selected");eT.removeClass("selected");if(eU.next("ul").length){br("#next-page").show()}else{br("#next-page").hide()}br("#prev-page").show();return c3.inc_page(1)},prev:function(T,eV){var eU,eT;eT=br("ul.selected");eU=eT.prev("ul");eU.addClass("selected");eT.removeClass("selected");if(eU.prev("ul").length){br("#prev-page").show()}else{br("#prev-page").hide()}br("#next-page").show();return c3.inc_page(-1)},inc_page:function(eU){var eT,T;eT=parseInt(br("#page_num").text(),10);T=eT+eU;return br("#page_num").text(T)},init:function(eV,T,eT){var eU;eU=cy.get_viewer().get_user_by_id(eT);br("#next-page").on("click",function(eW){c3.next(eW);return false});br("#prev-page").on("click",function(eW){c3.prev(eW);return false});br("#restore-submit-button").on("click",function(eW){di.do_folder_restore(eV,eU);return false});br("#restore-cancel-button").on("click",function(eW){return bO.redirect(T)});return br("#restore-back-button").on("click",function(eW){return bO.redirect(T)})}};var b2,de,cs,aJ,db=function(T,eT){return function(){return T.apply(eT,arguments)}},ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV};b2=B.SelectRoleModal=(function(T){cA(eT,T);function eT(){this.on_show=db(this.on_show,this);return eT.__super__.constructor.apply(this,arguments)}eT.prototype.on_select_role=null;eT.prototype.on_show=function(){return br(".role-options li").click((function(eU){return function(eW){var eV,eX;eV=br(eW.target).closest("li");eX=eV.data("role");cw(eU.on_select_role,"missing on_select_role implementation");eU.on_select_role(eX);return eU.hide()}})(this))};return eT})(dN);cs=B.SharedFolderSelectRoleModal=(function(T){cA(eT,T);function eT(){return eT.__super__.constructor.apply(this,arguments)}eT.prototype.on_select_role=function(eV){var eU;eU=function(){bM.role_picker.ensure_role_is_visible(eV);dk.set_role(eV);return p.start_wizard_for_user(cy.get_viewer().get_user_by_role(eV))};if(eV===bB.logged_out_role){return bB.show_modal({role:eV,on_success:eU})}else{return eU()}};return eT})(b2);aJ=B.ShmodelC2DSelectRoleModal=(function(T){cA(eT,T);function eT(){return eT.__super__.constructor.apply(this,arguments)}eT.prototype.on_select_role=function(eV){var eU;eU=function(){return ag.show_c2d_modal(eV)};if(!cy.get_viewer().is_role_signed_in(eV)){return bB.show_modal({role:eV,on_success:eU})}else{return eU()}};return eT})(b2);de=B.ShareShmodelSelectRoleModal=(function(T){cA(eT,T);function eT(){this.on_select_role=db(this.on_select_role,this);return eT.__super__.constructor.apply(this,arguments)}eT.prototype.on_select_role=function(eU){return ag.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,eU)};return eT})(b2);var cC;cC=B.TabController=Class.create({initialize:function(eU,eT){var T;T=$(eU);cw(T,eU+" is missing.");this.container=T;this.options={killEvent:true};Object.extend(this.options,eT);return this.listen()},listen:function(){var eX,eU,eW,eT,eV,T;eU=this;eV=this.container.select("a");T=[];for(eW=0,eT=eV.length;eW<eT;eW++){eX=eV[eW];cw(eX.id&&eX.id.length>0,"Element is missing an id");T.push(eX.observe("click",(function(eY){return this.click(eY)}).bindAsEventListener(eU)))}return T},click:function(T){if(this.options.killEvent){Event.stop(T)}return this.toggle($(T.target))},toggle:function(eT){var eW,T,eV,eX,eU;eU=this.container.down("a.selected");if(eU){eX=$(eU.id+"-content");if(eX){eX.hide()}}this.container.select(".selected").invoke("removeClassName","selected");T=false;if(!eT){eT=this.container.down("a");T=true}eT.addClassName("selected");eW=$(eT.id+"-content");if(eW){eW.show()}if(this.options.onTabChange){this.options.onTabChange(eT,eU)}if(this.options.url_prefix){eV=this.options.url_prefix;if(!T){eV+="/"+eT.id}return ei.push_state(eV)}}});var dw;dw=B.InviteForm={initialized:false,init:function(){if(this.initialized){return}return br((function(T){return function(){T.add_auto_completer=new Autocompleter.ContactsTokenizer(cy.get_viewer().get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(eT){return eT.excludeTeamMembers().excludeFacebook().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeMe()}});T.add_auto_completer.clearTokens();T.tokenAdd=br.proxy(T._tokenAdd,T);T.tokenRemove=br.proxy(T._tokenRemove,T);br("#team-invite-new-collab-input")[0].on("token:add",T.tokenAdd);br("#team-invite-new-collab-input")[0].on("token:remove",T.tokenRemove);T.reset_licenses();T.initialized=true;T.setup_tab_support(br);return b5.init()}})(this))},set_emails:function(T){if(T==null){return}return br((function(eT){return function(){var eW,eY,eX,eV,eU;eT.init();eU=[];for(eX=0,eV=T.length;eX<eV;eX++){eW=T[eX];eY=eT.add_auto_completer.createTokenInfo(null,eW,S.EMAIL);eU.push(eT.add_auto_completer.addContact(eY))}return eU}})(this))},rebind_modal_submit_autocompleter:function(){var T,eT;T=this.invite_modal.$modal_window;eT=T.find(".tokenizer-submit-button");eT.on("mousedown",(function(eU){return function(){return eU.add_auto_completer.beforeSubmit()}})(this));return this.setup_tab_support(T)},setup_tab_support:function(T){return T.find("#team-invite-new-collab-input").first().on("keyup change",function(){var eT;eT=T.find(".new-collab-input").first();if(eT.val()!==""){return eT.attr("tabindex",-1)}else{return eT.removeAttr("tabindex")}})},reset_modal_licenses:function(){var T;T=__CIRCULAR_DEPENDENCY__.Dashboard!=null?__CIRCULAR_DEPENDENCY__.Dashboard.get_total_members():__CIRCULAR_DEPENDENCY__.MembersReact!=null?__CIRCULAR_DEPENDENCY__.MembersReact.get_total_members():window.active_team_member_table.get_user_count();this.update_used_licenses(T);this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(T){this.available_licenses--;br(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users++},_tokenRemove:function(T){this.available_licenses++;br(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users--},already_invited_user:function(eT){var eU,T,eV;if(window.active_team_member_table){eV=window.active_team_member_table.data.users;for(T in eV){eU=eV[T];if(eU.email===eT){return true}}}},update_license_count:function(){var T,eT;T=br("#license-count-message");if(this.available_licenses<0){eT=ef("You need more licenses for this invitation.");T.addClass("over")}else{if(this.available_licenses===0){eT=ef("You have no remaining licenses.");T.removeClass("over")}else{if(this.available_licenses>0){eT=a1("You have %(invites)d remaining license.","You have %(invites)d remaining licenses.",this.available_licenses).format({invites:this.available_licenses});T.removeClass("over")}else{eT="You have \u00a0 remaining licenses."}}}return T.text(eT)},init_modal_licenses:function(eU,eT,T){if(!this.invite_modal){this.invite_modal=new t(T)}this.total_licenses=eU;this.is_trial=eT;return br("body").trigger("invite-modal-initialized")},update_used_licenses:function(T){this.used_licenses=T;return this.reset_licenses()},init_form_licenses:function(eU,T,eT){this.total_licenses=eU;this.used_licenses=T;this.is_trial=eT;return dw.reset_licenses()},add_total_licenses:function(T){T=T||0;if(T>0){this.total_licenses+=T;this.available_licenses+=T;this.update_license_count();if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){return __CIRCULAR_DEPENDENCY__.Dashboard.add_licenses(T)}}},on_add_licenses_exit:function(eT,T){var eU;if((eU=this.invite_modal)!=null?eU.$modal_window:void 0){this.rebind_modal_submit_autocompleter()}return this.add_total_licenses(T)},reset_modal:function(){var T;T=this.invite_modal.$modal_window;cP.reset(T.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens()}this.reset_modal_licenses();return T.find(".new-collab-input").val("")},on_add_licenses_click:function(eT){var T;eT.preventDefault();if(this.is_trial){if((T=this.invite_modal)!=null){T.hide()}return __CIRCULAR_DEPENDENCY__.add_more_licenses_to_trial()}else{if(this.add_licenses_cb!=null){dH.unregister(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb)}this.add_licenses_cb=br.proxy(this.on_add_licenses_exit,this);dH.register(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb);return dH.push(new __CIRCULAR_DEPENDENCY__.AddLicensesModal())}}};var t,db=function(T,eT){return function(){return T.apply(eT,arguments)}},ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV};t=B.InviteModal=(function(eT){cA(T,eT);function T(eU){this.transition_view_model=eU;this._reset=db(this._reset,this);this._update_form_pricing_information=db(this._update_form_pricing_information,this);this._update_remaining_licenses_message=db(this._update_remaining_licenses_message,this);this._make_transition_info_request=db(this._make_transition_info_request,this);this._handle_token_change=db(this._handle_token_change,this);this._licenses_total=db(this._licenses_total,this);this._licenses_to_add=db(this._licenses_to_add,this);this.on_hide=db(this.on_hide,this);this.on_show=db(this.on_show,this);T.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input"});this.inline_add_license=this.transition_view_model!=null;if(this.inline_add_license){this.transition_info_fetcher=new eO([eU]);this.probability=Math.random()}this.skip_reset=false}T.prototype.on_confirm_button_click=function(eU){return dA.add_users(eU,this.add_qty)};T.prototype.on_show=function(){var eU;this._reset();eU=br("#team-invite-wizard .team-invite-add-licenses");eU.on("click",br.proxy(dw.on_add_licenses_click,dw));br(window).on("token:changed",this._handle_token_change);if(dw.initialized){dw.update_license_count()}return dH.register(dH.CLEAR,function(){return dw.reset_modal()})};T.prototype.on_hide=function(){return br(window).off("token:changed",this._handle_token_change)};T.prototype._licenses_to_add=function(){return -1*dw.available_licenses};T.prototype._licenses_total=function(){return dw.total_licenses+this._licenses_to_add()};T.prototype._handle_token_change=function(eV,eU){this._update_remaining_licenses_message(eU.remaining_licenses);if(this.inline_add_license){clearTimeout(this.fetch_transition_timeout_id);return this.fetch_transition_timeout_id=setTimeout((function(eW){return function(){eW._make_transition_info_request();return eW.fetch_transition_timeout_id=null}})(this),100)}};T.prototype._make_transition_info_request=function(){var eW,eV,eU,eX;eV=Math.floor(Math.random()*1000000);this.current_callback_token=eV;eW=this._licenses_to_add();eU=this._licenses_total();eX=(function(eY){return function(eZ){return eY._update_form_pricing_information(eV,eW,eU,eZ[0])}})(this);if(eW>0){return this.transition_info_fetcher.get(eX,{total_users:this._licenses_total()})}else{return eX(null)}};T.prototype._update_remaining_licenses_message=function(eU){var eV;this.remaining_licenses=eU;eV=this._get_remaining_licenses_message(eU);return this.$modal_window.find("#license-count-message").text(eV)};T.prototype._get_remaining_licenses_message=function(eU){var eV;if(eU<0){eV=ef("You need more licenses for this invitation.")}else{if(eU===0){eV=ef("After this invitation, you'll have no remaining licenses.")}else{eV=a1("After this invitation, you'll have %(count)d remaining license.","After this invitation, you'll have %(count)d remaining licenses.",eU).format({count:eU})}}return eV};T.prototype._update_form_pricing_information=function(eX,eY,eU,e1){var eV,e0,eZ,eW;if(eX!==this.current_callback_token){return}if(e1&&eY>0){this.add_qty=eY;eV=this.transition_view_model.state.currency;eZ=e1.current_total.amount;e0=eN.formatCurrency(eZ,eV);eW=eN.formatCurrency(e1.recurring_total.amount,eV);br(".new-amount").text(e0);br(".add-qty").text(eY);br(".recurring-amount").text(eW);br(".total-qty").text(eU);br(".charges-section").show();br(".team-invite-buttons .confirm-button").val(ef("Invite and buy"));return br("#expected_price").val(eZ)}else{return this._reset()}};T.prototype._reset=function(){this.add_qty=0;br(".charges-section").hide();br("#expected_price").val(0);return br(".team-invite-buttons .confirm-button").val(ef("Invite to team"))};return T})(dN);var bv,aq,av,Q,dT,eB,bj,en,dA,eL,a5,ce,n,db=function(T,eT){return function(){return T.apply(eT,arguments)}},ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV};dA=INLINE_JS.Team=B.Team={_use_async_reset:false,team_id:cy.get_viewer().team_id,set_team_id:function(T){this.team_id=T},setup_beta_modal_listeners:function(){var eX,e0,eY,T,eW,eV,eZ,eT,eU;e0=br(".feature-list .enroll-button");T=br(".feature-list .feedback-button");for(eW=0,eZ=e0.length;eW<eZ;eW++){eX=e0[eW];eY=br(eX).data("feature");br(eX).click((function(e1){return function(){return new aq(e1).show()}})(eY));eX.disabled=false}eU=[];for(eV=0,eT=T.length;eV<eT;eV++){eX=T[eV];eY=br(eX).data("feature");eU.push(br(eX).click((function(e1){return function(){return new av(e1).show()}})(eY)))}return eU},invite_modal_show:function(T){if(!dw.invite_modal){return br("body").one("invite-modal-initialized",(function(eT){return function(){return eT.invite_modal_show(T)}})(this))}if(!this.invite_modal_already_initialized){dw.invite_modal.show();dw.init();this.invite_modal_already_initialized=true}else{dw.invite_modal.show();dw.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){dw.update_used_licenses(window.active_team_member_table.get_user_count())}return dw.set_emails(T)},init_admin:function(){bd.set_vertical_space(2);return br("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){return br(".team_name_change_notice .hide_link").click((function(T){return function(eT){return T.hide_team_name_change_banner()}})(this))},add_users:function(eU,T){var eW,eT,eV;Event.stop(eU);eT=$("team-invite-form");cw(eT,"Couldn't find the team invite form.");eW=br(eT).find("input[name='emails']");if(eW.length===0){ab.error(ef("You haven't included anyone to invite! Please invite at least one person."));return}eV=bF.collect_form_vars(eT);br.extend(eV,{team_id:this.team_id});bF.add_loading(eU.target);return new Ajax.DBRequest("/account/team/add_users",{parameters:eV,subject_user:cy.get_viewer().work_user,progress_text:ef("Inviting members..."),noAutonotify:true,onSuccess:function(e2){var e0,eZ,eY,e1,eX;bF.remove_loading();dw.reset_modal();dw.add_total_licenses(T);dw.invite_modal.hide();e1=br(".team_admin_members_table");eY=JSON.parse(e2.responseText);if(eY){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.add_users(eY!=null?eY.users:void 0)}else{if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){__CIRCULAR_DEPENDENCY__.Dashboard.set_num_invited(eY!=null?eY.num_invited:void 0)}}}e0=(function(){var e4,e3;e4=eY!=null?eY.users:void 0;e3=[];for(eZ in e4){eX=e4[eZ];e3.push(eX)}return e3})();if(e0.length===1){return ab.success(ef("Invited %(user_email)s.").format({user_email:e0[0].email}))}else{if(e0.length>1){return ab.success(ef("Invited %(user_count)d people.").format({user_count:e0.length}))}else{return ab.error(a1("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",eW.length).format({num_skipped:eW.length}))}}}else{return ab.error()}},onFailure:function(eZ){var eX,eY;if(eZ){if(eZ.responseText.indexOf("err:")===0){eX=eZ.responseText.substr(4);if(eX.indexOf("{")===0){eY=eX.evalJSON(true);bF.fill_errors(eT,eY)}else{eX=new eP(eX);ab.error(eX)}}else{ab.error()}}bF.remove_loading();return br("input[type='submit']").prop("disabled",false)},cleanUp:function(){bF.remove_loading();dw.reset_modal();return dw.invite_modal.hide()}})},show_demo_signup_modal:function(eU,eV,eW,eT,eX){var T,e0,eZ,eY;this.webinar_key=eU;this.webinar_iso_datetime=eV;this.webinar_date=eW;this.webinar_title=eT;this.tab_url=eX;eY=ef("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});e0=new Q({element_id:"demo-signup-modal",title:eY});e0.show();e0.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);e0.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);e0.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);e0.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);eZ=e0.$modal_window.find("input[name=retURL]");eZ.attr("value",eZ.val()+"#"+this.tab_url);T=e0.$modal_window.find("#demo-signup-form")[0];return T.on("submit",e0.on_confirm_button_click)},show_unsuspend_modal:function(eU,T,eT){var eV;eV=new bj({element_id:"dfe-unsuspend-modal",focus:"confirm"});eV.user_name=eU||eT;eV.email=eT;eV.user_id=T;eV.team_id=this.team_id;eV.show();return false},show_remove_or_deactivate_modal:function(eU,eW,T,eT,eX){var eV;eV=new dT({element_id:"dfe-remove-or-deactivate-user-modal",focus:".new-collab-input"});eV.user_name=eW||eT;eV.email=eT;eV.user_id=T;eV.team_id=this.team_id;eV.invited=eX;eV.show();return false},show_remove_modal:function(eV,eX,T,eT,eY,eU){var eW;eW=new eB({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});eW.user_name=eX||eT;eW.email=eT;eW.user_id=T;eW.team_id=this.team_id;eW.invited=eY;eW.num_api_apps=eU;eW.show();return false},remove_user:function(eV,eW){var eU,eT,T;alert("in remove_user");Event.stop(eV);eT=br("input[type=submit]","#remove-user-modal");eT.attr("disabled",1);T=eM.vars.user_id;if(eW){eU=true}else{eU=br("input[name=disable_if_joined]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:this.team_id,user_id:T,disable_if_joined:eU},onSuccess:(function(eX){return function(e0){var eZ,e1,eY;eZ=JSON.parse(e0.responseText);if((e1=window.active_team_member_table)!=null){e1.remove_user(eM.vars.user_id)}if((eY=window.removed_team_member_table)!=null){eY.add_users(eZ)}eX.decrement_used_licenses();return ab.success(ef("User removed."))}})(this),cleanUp:function(){eM.hide();return eT.removeAttr("disabled")}})},show_reinvite_modal:function(eU,eV,T,eT){var eW;c9.fillVal(eT,"reinvite-user-email");c9.fillVal(eV,"reinvite-user-team");eW=ef("Resend invite to '%(email_address)s'").format({email_address:bG.em_snippet(eT,18)});return eM.show(eW,$("reinvite-user-modal"),{user_id:T,button:eU})},reinvite_user:function(eT){var T;Event.stop(eT);T=eM.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(eX){var eV,eW,eU,eY;ab.success(ef("Invite sent."));if((eY=$("team-member-info"))!=null){eY.update(eX.responseText)}eV=window.active_team_member_table;if(eV){eU=eV.data.users[T];eU.invite_expired=false;eW={};eW[T]=eU;return eV.update_user_data(eW)}},cleanUp:function(){return eM.hide()}})},show_user_activity_log_modal:function(T,eU,eV){var eT;eT=br("#activity-log-modal");eT.find(".activity-log-email").text(eU);eT.find(".activity-log-name").text(eV);eT.find("#activity-log-user-message").show();return eM.show(ef("Create activity report"),eT[0],{user_id:T})},show_team_activity_log_modal:function(eT,eU){var T;T=br("#activity-log-modal");T.find(".activity-log-email").text(eT);T.find(".activity-log-name").text(eU);T.find("#activity-log-team-message").show();return eM.show(ef("Create full activity report"),T[0])},generate_activity_log:function(eZ){var eX,eV,eY,eW,T,eU,eT;Event.stop(eZ);eV=br("#activity-log-modal");eY=eV.find("input[name='from_date']").val();T=eV.find("input[name='to_date']").val();if(eY>T){ab.error(ef("Your start date is after your end date."));return}eW=this.team_id;eT=eM.vars.user_id;eU=new Date().getTimezoneOffset().toString();eX=br(".activity-report-generator .freshbutton-blue");eX.prop("disabled",true);return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:eY,to_date:T,team_id:eW,user_id:eT,tzoffset:eU},onSuccess:function(e0){return ab.success(ef("Report started. We'll email you when it's ready."))},cleanUp:function(){eM.hide();return eX.prop("disabled",false)}})},show_reset_password_modal:function(eT,eU,T){var eV;br("#reset-password-modal .member-name").text(eU);eV=ef("Reset password for '%(user_name)s'").format({user_name:eU});return eM.show(eV,$("reset-password-modal"),{user_id:T,button:eT})},reset_password:function(eT){var T;Event.stop(eT);T=eM.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(eU){return ab.success(ef("User's password reset."))},cleanUp:function(){return eM.hide()}})},show_reset_all_passwords_modal:function(){return eM.show(ef("Reset all passwords"),$("reset-all-passwords-modal"))},set_async_password_reset:function(T){return this._use_async_reset=T},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:this.team_id},job:this._use_async_reset,subject_user:cy.get_viewer().work_user,progress_text:ef("Resetting all passwords..."),onSuccess:function(T){return ab.success(ef("All passwords reset."))},cleanUp:function(){return eM.hide()}})},show_admin_status_modal:function(eU,e0,e2,eW,e1,eX){var eT,eY,T,eV,eZ;T=e1.strip()||eW;eV=void 0;eT=void 0;eZ=void 0;eY=void 0;if(eX){eZ=ef("Add admin permissions for '%(person_name)s'").format({person_name:T.escapeHTML()});eV=ef("Are you sure you want to add admin permissions for <strong>%(person_name)s</strong>?").format({person_name:T.escapeHTML()});eT=ef("Add admin permissions",{comment:"make this user an admin; give them the permissions an admin has"});eY="alert_32"}else{eZ=ef("Remove admin privileges from '%(person_name)s'").format({person_name:T.escapeHTML()});eV=ef("Are you sure you want to remove admin permissions from <strong>%(person_name)s</strong>?").format({person_name:T.escapeHTML()});eT=ef("Remove admin permissions",{comment:"clicking this button completes the action: it removes a person's admin status"});eY="alert_32"}c9.fillVal(eW,"admin-status-email");c9.fillVal(eV,"admin-status-action");c9.fillVal(eT,"admin-status-button-action");return eM.show(eZ,$("admin-status-modal"),{user_id:e2,button:eU,admin_on:eX})},set_admin_status:function(eT){var T;Event.stop(eT);T=eM.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:this.team_id,user_id:T,on:(eM.vars.admin_on?"yes":"no")},onSuccess:function(eV){var eW,eU;eW=(eM.vars.admin_on?ef("User's admin status granted."):ef("User's admin status removed."));if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){return __CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){eU=JSON.parse(eV.responseText);window.active_team_member_table.update_user_data(eU);return ab.success(eW)}else{if(eM.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(eM.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(eM.vars.user_id)}}}},cleanUp:function(){return eM.hide()}})},show_disable_2fa_modal:function(eU,T,eT){br("#disable-2fa-modal .member-name").text(eT);return eM.show(ef("Disable two-step verification"),$("disable-2fa-modal"),{user_id:T,elm:eU})},show_reset_2fa_modal:function(eU,T,eT){br("#reset-2fa-modal .member-name").text(eT);return eM.show(ef("Reset two-step verification"),$("reset-2fa-modal"),{user_id:T,user_name:eT,elm:eU})},reset_2fa:function(){return new Ajax.DBRequest("/account/team/reset_2fa",{parameters:{team_id:this.team_id,user_id:eM.vars.user_id},onSuccess:function(eT){var T;br(".tfa_enabled").replaceWith(ef("Disabled"));T=JSON.parse(eT.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}ab.success(ef("Two-step verification reset for %(user_name)s").format({user_name:eM.vars.user_name}));return eM.hide()}})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:this.team_id,user_id:eM.vars.user_id},onSuccess:function(eT){var T;br(".tfa_enabled").replaceWith(ef("Disabled"));T=JSON.parse(eT.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}ab.success(ef("Two-step verification disabled."));return eM.hide()}})},show_sso_preview_email:function(T){return eM.show(ef("Email preview"),$(T))},show_sso_sample_email:function(T){return eM.show(ef("Sample email"),$(T))},show_user_message_modal:function(eU,eT,T){var eV;c9.fillVal(T,"user-message-email");eV=ef("Send email to '%(user_name)s'").format({user_name:eU});$("user-message").value="";eM.show(eV,$("user-message-modal"),{user_name:eU,user_id:eT});return dL.focus.defer("user-message")},send_user_message:function(){var eT,T;T=eM.vars.user_id;eT=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:T,team_id:this.team_id,message:eT},onSuccess:function(){var eU;eU=eM.vars.user_name;ab.success(ef("Message successfully sent to %(user_name)s.").format({user_name:eU}));return eM.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:this.team_id}});br(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return br(".pin_notice").hide()},hide_pin_banner_with_user_id:function(T,eT){var eU;eU=function(eV){return br(eT).closest("span").removeClass("on").addClass("off")};if(T===null){return new Ajax.DBRequest("/team/invalidate_pin",{onSuccess:eU})}else{return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:T},onSuccess:eU})}},get_pin_with_user_id:function(T,eU,eT){var eV;if(eT==null){eT=null}if(eT===null){eT=function(eX,eW){br(eW).closest("span").find(".pin-value").text(eX.pin+" -");return br(eW).closest("span").removeClass("off").addClass("on")}}eV=function(eX){var eW;eW=JSON.parse(eX.responseText);return eT(eW,eU)};if(T===null){return new Ajax.DBRequest("/team/generate_pin",{onSuccess:eV})}else{return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:T},onSuccess:eV})}},send_team_message:function(eT){var T;Event.stop(eT);T=$F("team-message").strip();if(T){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:this.team_id,message:T},onSuccess:function(eU){ab.success(ef("Message successfully sent to team."));return eM.hide()}})}},show_security_message_modal:function(){return new eL().show()},send_team_security_message:function(eU){var eT,T;Event.stop(eU);T=$F("team-security-message").strip();eT=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:eT.serialize(true),onSuccess:function(eV){ab.success(ef("Message successfully sent."));return eM.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(T,eT){this.used_licenses=T;return this.total_licenses=eT},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(T,eT){$("migration-url").value=eT;eM.show(ef("Migration link for '%(email)s'").format({email:bG.em_snippet(T,18)}),$("migrate-url-modal"));return $("migration-url").select()},show_end_session_modal:function(eT,T,eU){bd.hide_all();br("#end-session-modal .member-name").text(br("#member-name").text());return eM.show(ef("Close web session",{comment:"Log out of your current Dropbox web session"}),$("end-session-modal"),{login_id:eT,user_id:T,elm:eU})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:eM.vars.login_id,team_id:this.team_id,user_id:eM.vars.user_id},onSuccess:function(){eM.hide();dA.remove_closest_row(eM.vars.elm);return ab.success(ef("Web session closed."))}})},unlink_device:function(T,eV,eZ,eT,e0,eU,eW){var eY,eX;bd.hide_all();eY=$("unlink-device-modal-"+eU);eX=ef("Unlink %(device_name)s").format({device_name:eZ});return eM.show(eX,eY,{app_id:eV,user_id:e0,elm:eW,device_id:T,display_name:eZ})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_team_device",{parameters:{app_id:eM.vars.app_id,team_id:this.team_id,user_id:eM.vars.user_id,device_id:JSON.stringify(eM.vars.device_id)},subject_user:cy.get_viewer().work_user,onSuccess:function(){eM.hide();dA.remove_closest_row(eM.vars.elm);return ab.success(ef("%(device_name)s unlinked.").format({device_name:eM.vars.display_name}))}})},disable_app:function(eT,eU,T,eV){bd.hide_all();br("#disable-app-modal .app-name").text(eU);br("#disable-app-modal .member-name").text(br("#member-name").text());return eM.show(ef("Disable '%(app_name)s'?").format({app_name:eU}),$("disable-app-modal"),{app_id:eT,user_id:T,elm:eV})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:eM.vars.app_id,keep_sandbox_files:true,team_id:this.team_id,user_id:eM.vars.user_id},subject_user:cy.get_viewer().work_user,onSuccess:function(T){eM.hide();dA.remove_closest_row(eM.vars.elm);return ab.success(T.responseText)}})},remove_closest_row:function(eV){var eU,eT,T;eU=br(eV).closest(".team_admin_table_row");eT=br(eU).closest(".team_admin_table");if(eT.find(".team_admin_table_row").length===1){T=eT.prev(".team_admin_table_title");if(!T.length){T=br(".team_apps_table_panel")}T.remove();return eT.remove()}else{return eU.remove()}},submit_report_form:function(T){br(T.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};aq=B.BetaEnrollConfirmationModal=(function(eT){cA(T,eT);function T(eU){this.feature_name=eU;this.on_confirm_button_click=db(this.on_confirm_button_click,this);T.__super__.constructor.call(this,{element_id:"beta-enroll-confirmation-modal"})}T.prototype.on_confirm_button_click=function(eU){br("<input>").attr({type:"hidden",name:"feature_name",value:this.feature_name}).appendTo("#beta-enroll-confirmation-modal form");return this.$modal_window.addClass("ajax-loading")};return T})(dN);av=B.BetaFeedbackModal=(function(eT){cA(T,eT);function T(eU){this.feature_name=eU;this.error=db(this.error,this);this.success=db(this.success,this);T.__super__.constructor.call(this,{element_id:"beta-feedback-modal"});this.on_confirm_button_click=(function(eV){return function(eZ){var eY,eX,eW;eZ.preventDefault();eY=br(eZ.target);eX=eY.closest("form");eW={feature_name:eV.feature_name};return bF.ajax_submit(eX[0],false,eV.success,eV.error,eY[0],eW)}})(this)}T.prototype.success=function(eU){ab.success(ef("Thank you for your feedback."));return this.$modal_window.hide()};T.prototype.error=function(eU){if(eU.status!==200){return ab.error(ef("Failed to submit feedback. Please try again."))}};return T})(dN);Q=B.DemoSignupModal=(function(T){cA(eT,T);function eT(){this.on_show=db(this.on_show,this);this.on_confirm_button_click=db(this.on_confirm_button_click,this);return eT.__super__.constructor.apply(this,arguments)}eT.prototype.on_confirm_button_click=function(eY){var e6,e3,eZ,eU,e1,eW,e5,e4,eV,e2,e0,eX;eY.preventDefault();e0=$("demo-signup-form");e4=$("1210");eW=br(e0).find("input[name='first_name']").val();br(e4).find("input[name='FirstName']").attr("value",eW);e5=br(e0).find("input[name='last_name']").val();br(e4).find("input[name='LastName']").attr("value",e5);e1=br(e0).find("input[name='email']").val();br(e4).find("input[name='Email']").attr("value",e1);e2=br(e0).find("input[name='phone_number']").val();br(e4).find("input[name='Phone']").attr("value",e2);e6=br(e0).find("input[name='company_name']").val();br(e4).find("input[name='Company']").attr("value",e6);eZ=br(e0).find("select[name='company_size']");e3=eZ.find("option:selected").val();br(e4).find("input[name='Company_size__c']").attr("value",e3);eU=$(this.$modal_window.find(".confirm-button")[0]);eX=(function(e7){return function(e8){e7.$modal_window.hide();return e4.submit()}})(this);eV=bF.collect_form_vars(e0,true);return bF.ajax_submit(e0,false,eX,false,eU,eV,true)};eT.prototype.on_show=function(eU){this.$modal_window.find(".db-modal-content").css({"overflow-y":""});return b5.init()};return eT})(dN);bv=B.AccountTransferBaseModal=(function(eT){cA(T,eT);function T(eU,eW,eV){this.file_action_selector=eW;this.transfer_choice_selector=eV;this._clearInput=db(this._clearInput,this);this._markInputInvalid=db(this._markInputInvalid,this);this._markInputValid=db(this._markInputValid,this);this._tokenRemove=db(this._tokenRemove,this);this._tokenAdd=db(this._tokenAdd,this);this._selectChange=db(this._selectChange,this);this._isTransferSelected=db(this._isTransferSelected,this);this.handleAjaxFailure=db(this.handleAjaxFailure,this);T.__super__.constructor.call(this,eU,this.file_action_selector,this.transfer_choice_selector)}T.prototype.on_show=function(){if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(cy.get_viewer().get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:(function(eU){return function(eV){return eV.excludeNonTeam().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeByEmail(eU.email?[eU.email.toLowerCase()]:[])}})(this)});this.tokenAdd=br.proxy(this._tokenAdd,this);this.tokenRemove=br.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=br.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};T.prototype.handleAjaxFailure=function(eU){if(eU.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};T.prototype._isTransferSelected=function(){return br(this.transfer_choice_selector).prop("checked")};T.prototype._selectChange=function(eU){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};T.prototype._tokenAdd=function(eU){this.$collab_input.hide();if(eU.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};T.prototype._tokenRemove=function(eU){this.$collab_input.show();return this._clearInput()};T.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};T.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};T.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return T})(dN);eL=B.TwoFactorMessageModal=(function(eT){cA(T,eT);function T(){T.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}T.prototype.on_confirm_button_click=function(eU){dA.send_team_security_message(eU);return this.hide()};return T})(dN);bj=B.DfeUnsuspendUserModal=(function(T){cA(eT,T);function eT(eU){this.on_confirm_button_click=db(this.on_confirm_button_click,this);this.success_callback=db(this.success_callback,this);eT.__super__.constructor.call(this,eU)}eT.prototype.before_show=function(){var eU;eT.__super__.before_show.call(this);eU=ef("Unsuspend %(user_name)s").format({user_name:this.user_name});this.$modal_window.find(".db-modal-title-text").text(eU);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=email]").attr("value",this.email);this.$modal_window.find(".unsuspended_name").text(this.user_name);return this.$modal_window.find(".unsuspended_email").text(this.email)};eT.prototype.success_callback=function(eU){var eV;ab.success("User unsuspended");if((eV=__CIRCULAR_DEPENDENCY__.MembersReact)!=null){eV.refresh_member_stats()}return this.hide()};eT.prototype.on_confirm_button_click=function(eW){var eU,eV;eW.preventDefault();eV=this.$modal_window.find(".dfe-unsuspend-modal")[0];eU=$(this.$modal_window.find(".confirm-button")[0]);return bF.ajax_submit(eV,false,this.success_callback,false,eU)};return eT})(dN);dT=B.DfeRemoveOrDeactivateUserModal=(function(eT){cA(T,eT);function T(eU){this.on_confirm_button_click=db(this.on_confirm_button_click,this);this.success_callback=db(this.success_callback,this);this.on_show=db(this.on_show,this);this.handle_change_action=db(this.handle_change_action,this);this.switch_to_uninvite_mode=db(this.switch_to_uninvite_mode,this);this.switch_to_removal_mode=db(this.switch_to_removal_mode,this);this.switch_to_deactivation_mode=db(this.switch_to_deactivation_mode,this);this.show_removal_content=db(this.show_removal_content,this);this.show_deactivation_content=db(this.show_deactivation_content,this);this.set_modal_class=db(this.set_modal_class,this);this.set_form_action_to_remove=db(this.set_form_action_to_remove,this);this.set_form_action_to_deactivate=db(this.set_form_action_to_deactivate,this);T.__super__.constructor.call(this,eU,"input[name=transfer_files]","#transfer_files_on")}T.prototype.set_form_action_to_deactivate=function(){return br(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/deactivate_user")};T.prototype.set_form_action_to_remove=function(){return br(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/remove_user")};T.prototype.set_modal_class=function(eW){var eV,eU;eV="suspending deleting";eU=this.$modal_window.find(".dfe-remove-or-deactivate-user-modal");eU.removeClass(eV);return eU.addClass(eW)};T.prototype.show_deactivation_content=function(){return this.set_modal_class("suspending")};T.prototype.show_removal_content=function(){return this.set_modal_class("deleting")};T.prototype.switch_to_deactivation_mode=function(){this.show_deactivation_content();return this.set_form_action_to_deactivate()};T.prototype.switch_to_removal_mode=function(){this.show_removal_content();return this.set_form_action_to_remove()};T.prototype.switch_to_uninvite_mode=function(){this.set_form_action_to_remove();this.set_modal_class("invited");this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()};T.prototype.handle_change_action=function(eU){eU.preventDefault();if(br("#deactivate_option").is(":checked")){return this.switch_to_deactivation_mode()}else{return this.switch_to_removal_mode()}};T.prototype.on_show=function(eU){var eV;T.__super__.on_show.call(this);br("input[name=deactivate_or_remove]").on("change",this.handle_change_action);this.$modal_window.find(".deleted_user_name").text(this.user_name);if(this.invited){eV=ef("Uninvite %(user_name)s").format({user_name:this.user_name});this.switch_to_uninvite_mode()}else{eV=ef("Remove %(user_name)s").format({user_name:this.user_name});br("#deactivate_option").attr("checked","checked");this.switch_to_deactivation_mode()}this.$modal_window.find(".db-modal-title-text").text(eV);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);return this.$modal_window.find("[name=team_id]").attr("value",this.team_id)};T.prototype.success_callback=function(eU){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}if(this.invited){ab.success(ef("User uninvited"))}else{if(br("#deactivate_option").is(":checked")){ab.success(ef("User suspended"))}else{ab.success(ef("User deleted"))}}return this.hide()};T.prototype.on_confirm_button_click=function(eW){var eU,eV;eW.preventDefault();eV=this.$modal_window.find(".dfe-remove-or-deactivate-user-modal")[0];eU=$(this.$modal_window.find(".confirm-button")[0]);return bF.ajax_submit(eV,false,this.success_callback,this.handleAjaxFailure,eU)};return T})(bv);eB=B.DfeRemoveUserModal=(function(T){cA(eT,T);function eT(eU){this.on_confirm_button_click=db(this.on_confirm_button_click,this);this.success_callback=db(this.success_callback,this);this.on_show=db(this.on_show,this);eT.__super__.constructor.call(this,eU,"input[name=transfer_files]","#transfer_files_on")}eT.prototype.on_show=function(eV){var eU,eW;eT.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){eW=ef("Uninvite %(user_name)s").format({user_name:this.user_name})}else{eW=ef("Delete %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(eW);if(this.num_api_apps){eU=a1("%(num)s API app","%(num)s API apps",this.num_api_apps).format({num:this.num_api_apps});this.$modal_window.find(".num_api_app").text(eU)}else{this.$modal_window.find(".api_app_warning").hide()}this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.invited){this.$modal_window.find(".active_user_remove_setting").remove();return this.$modal_window.find(".dfe-remove-user-modal").addClass("invited")}};eT.prototype.success_callback=function(eW){var eV,eX,eU;eV=JSON.parse(eW.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if((eX=window.active_team_member_table)!=null){eX.remove_user(this.user_id)}if((eU=window.removed_team_member_table)!=null){eU.add_users(eV)}}if(this.invited){ab.success(ef("User uninvited."))}else{ab.success(ef("User removed."))}dA.decrement_used_licenses();return this.hide()};eT.prototype.on_confirm_button_click=function(eW){var eU,eV;eW.preventDefault();eV=this.$modal_window.find(".dfe-remove-user-modal")[0];eU=$(this.$modal_window.find(".confirm-button")[0]);return bF.ajax_submit(eV,false,this.success_callback,this.handleAjaxFailure,eU)};return eT})(bv);en=B.ManageFilesModal=(function(eT){cA(T,eT);function T(eV,eW,eU){this.source_user_id=eV;this.source_user_name=eW;this.options=eU;this.on_confirm_button_click=db(this.on_confirm_button_click,this);T.__super__.constructor.call(this,this.options,"input[name=file_action]","#move-files")}T.prototype.get_form=function(){return this.$modal_window.find("form")[0]};T.prototype.on_show=function(){var eU;T.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);eU=ef("Manage %(team_member)s's files").format({team_member:this.source_user_name});this.$modal_window.find(".db-modal-title-text").text(eU);return this.get_form().on("submit",this.on_confirm_button_click)};T.prototype.on_confirm_button_click=function(eW){var eU,eV,eX;eW.preventDefault();eV=this.get_form();eU=$(this.$modal_window.find(".confirm-button")[0]);eX=(function(eY){return function(e0){var eZ;eZ=JSON.parse(e0.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(eZ)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu!=null){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",eZ)}}}if(br("#move-files").prop("checked")){ab.success(ef("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{ab.success(ef("Permanently deleted files"))}return eY.$modal_window.hide()}})(this);return bF.ajax_submit(eV,false,eX,this.handleAjaxFailure,eU)};return T})(bv);ce=B.show_manage_files_modal=function(T,eT){var eU;eU=new en(T,eT,{element_id:"manage-files-modal",focus:".new-collab-input"});return eU.show()};n=function(){var T;T=function(eV,eU){var eT,eW;br(eU).css("display","none");eT=br(eU).closest("#user_generate_liveops_pin");eW=eT.find(".user_generate_liveops_pin_value");eW.text(eV.pin);br(eU).addClass("liveops_pin_elem_invisible");return eT.find(".user_generate_liveops_pin_text").removeClass("liveops_pin_elem_invisible")};dA.get_pin_with_user_id(null,this,T);return false};br("#user_generate_liveops_pin_button").click(n);a5=function(){br("#help_callus_title").hide();br("#help_callus_details").show();return false};br("#help_callus_trigger").click(a5);var O,b,dO,a8,ai,bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1},cO=[].slice;O=B.NOTCLIENTS={};b=B.NOTCLIENT_DEBUG=false;dO="/subscribe";a8=B.add_notclient=function(T,eU,eT){ai(T);return setTimeout((function(){return O[T].init(eU,eT)}),2000)};ai=B.new_notclient=function(fa){var fo,fq,e1,e3,e0,fb,e8,fj,eU,e5,T,eW,e4,ft,eV,fu,eY,ff,e9,eX,fh,e2,e7,fp,fe,fv,fn,e6,fm,eT,fg,fl,eZ,fc,fs,fk,fd,fr,fi;cw(bx.call(O,fa)<0,"cannot create more than one notclient per user");e9=function(fw){return $u.isNumber(fw)&&fw%1===0&&fw>0};ff=function(fw){return $u.isNumber(fw)&&fw%1===0&&fw>=0};cw(e9(fa),"user_id must be a positive integer");eX=function(){var fw;fw=1<=arguments.length?cO.call(arguments,0):[];if(b){return console.log.apply(console,fw)}};fo=90000;e3=8096;fb="user";e0="list";eV=false;fq=1000;e1=5*60*1000;fv=0;fc=function(){var fw;if(eW===0){fw=0}else{fw=Math.min(fq*Math.pow(2,eW-1),e1)}return Math.max(fw,fv)};fp=null;fn={};ft={};e7=1;fu=false;eY=false;fr=null;fj=false;fk=[];eZ=null;T=null;fh=null;e2={};e6=false;eW=0;fs=0;fd=function(fA,fy){var fx,fw,fz;fz=[];for(fx in fy){fw=fy[fx];fx=parseInt(fx,10);cw(e9(fx),"ns_ids must be positive integers: "+fx);cw(ff(fw),"sjids must be nonnegative integers: "+fw);if(fA[fx]!=null){fz.push(fA[fx]=Math.min(fA[fx],fw))}else{fz.push(fA[fx]=fw)}}return fz};eU=function(){var fy,fx,fz,fw;cw((fp!=null)&&!$u.isEmpty(fn),"expected nid and ns_map");fz={host_int:0,trace:window.location.pathname,rev:Constants.SVN_REV};fy=$u.pluck($u.values(ft),"type");if(bx.call(fy,fb)>=0){fz.user_id=fa;fz.nid=fp!=null?fp.replace(/^0+(.)/,"$1"):void 0}if(bx.call(fy,e0)>=0){fz.ns_map=((function(){var fA;fA=[];for(fx in fn){fw=fn[fx];fA.push(""+fx+"_"+fw)}return fA})()).join(",")}if(D.parse(dO).updateQuery(fz).toString().length>e3){delete fz.ns_map}return fz};e5=function(){var fw;if(!eV){return}fw=fc();if(fw>0){return T=window.setTimeout(fi,fw)}else{return fi()}};fi=function(){var fw;cw(!fu&&!eY,"connect: invalid state");cw(fp>=0||!$u.isEmpty(fn),"notclient: called connect with nothing to subscribe to");eX("###########################");fw=eU();if((fw.nid==null)&&!fw.ns_map){eX("nothing to subscribe to. skipping notserver connection.");return}eX("connecting to notserver...");fu=true;fs+=1;return fr=br.ajax(dO,{data:fw,dataType:"json",noDropboxDefaults:true,error:function(){if(fj){fj=false;return}eW+=1;eX("error connecting to notserver. bad rounds="+eW+".");fu=false;return e5()},success:function(fx){eX("notserver connection closed. response:",fx);fu=false;if(fx.chillout!=null){fv=parseInt(fx.chillout,10)*1000;eX("notserver told us to chill for "+fv+"ms")}else{if(fv>0){eX("setting notserver chillout back to 0ms");fv=0}}if(fx.ret==="punt"){return e5()}else{cw(fx.ret==="new","unknown notserver ret: "+fx.ret);cw("refresh" in fx,"expected notserver ret:new to have refresh keyword");return fl(fx.refresh)}}})};e8=function(){if(fr!=null){fj=true;fr.abort();return fr=null}};fm=function(){fv=0;fu=false;eY=false;e8();fk=[];window.clearTimeout(eZ);window.clearTimeout(T);eZ=null;T=null;fh=null;e2={};e6=false;eW=0;return e5()};fg=function(){var fw;eV=false;fv=0;fp=null;fn={};ft={};fw=0;e7=1;fu=false;eY=false;fr=null;fj=false;fk=[];window.clearTimeout(eZ);window.clearTimeout(T);eZ=null;T=null;fh=null;e2={};e6=false;eW=0;return fs=0};fl=function(fB){var fE,fA,fw,fx,fC,fy,fD,fz;cw(!eY&&!fu,"run_handlers: invalid state");cw(fh===null,"run_handlers: new_nid must start at null");cw($u.isEqual(e2,{}),"run_handlers: new_ns_map must start at {}");cw(!e6,"expected one_or_more_handler_failures=false");eY=true;eX("running handlers...");fx=$u.filter($u.values(ft),function(fG){var fF;return fF=fG.type,bx.call(fB,fF)>=0});cw(!$u.isEmpty(fx),"notserver sent a ping for unsubscribed activity");fk=$u.pluck(fx,"handler_id");for(fy=0,fD=fx.length;fy<fD;fy++){fz=fx[fy],fE=fz.handler,fA=fz.handler_id,fw=fz.name,fC=fz.type;eX("running id="+fA+", name="+fw+", type="+fC);fE()}if($u.isEmpty(fk)){return eX("all handlers already finished running. no need for a slacker timeout.")}else{eX("all handlers running. slacker timeout set.");return eZ=window.setTimeout(eT,fo)}};eT=function(){var fy,fz,fx,fw;cw(eY&&!fu,"called report_slackers in an invalid state.");cw(!$u.isEmpty(fk,"report_slackers called w/ nothing slackin'"));eX("found some slackers");e6=true;fw=[];for(fz=0,fx=fk.length;fz<fx;fz++){fy=fk[fz];fw.push(e4(fy))}return fw};e4=function(fw){if(bx.call(fk,fw)<0){return}eX("done handling: "+fw);fk=$u.without(fk,fw);if($u.isEmpty(fk)){eX("all handlers are done running.");eY=false;window.clearTimeout(eZ);if(fh!=null){eX("new nid: "+fh);fp=fh}if(!$u.isEmpty(e2)){eX("new ns_map:",e2);fn=e2}if(e6){eW+=1;eX("one or more handler errors. bad_rounds="+eW)}else{eW=0}fh=null;e2={};e6=false;return e5()}};fe={get_user_id:function(){return fa},get_nid:function(){return fp},get_ns_map:function(){return $u.clone(fn)},get_consecutive_bad_rounds:function(){return eW},get_total_rounds:function(){return fs},get_notserver_chillout_ms:function(){return fv},get_sleep_ms:fc,subscribe_user:function(fD){var fx,fy,fC,fB,fA,fw,fz;cw(!eY,"adding new handlers from inside handlers is not currently supported");fz=["name","handler"];for(fA=0,fw=fz.length;fA<fw;fA++){fB=fz[fA];cw(fD[fB],"subscribe_user requires this param be non-falsey: "+fB)}cw($u.isFunction(fD.handler),"handler must be a function");eX("adding user handler "+fD.name);fy=$u.pluck($u.values(ft),"type");fC=bx.call(fy,fb)<0;fx=e7++;ft[fx]={handler_id:fx,handler:fD.handler,name:fD.name,type:fb};if(fC){eX("first user handler added, reconnecting");fm()}return fx},subscribe_sfj:function(fD){var fx,fy,fC,fB,fA,fw,fz;cw(!eY,"adding new handlers from inside handlers is not currently supported");fz=["name","handler"];for(fA=0,fw=fz.length;fA<fw;fA++){fB=fz[fA];cw(fD[fB],"subscribe_sfj requires this param be non-falsey: "+fB)}cw($u.isFunction(fD.handler),"handler must be a function");eX("adding sfj handler "+fD.name);fy=$u.pluck($u.values(ft),"type");fC=bx.call(fy,e0)<0;fx=e7++;ft[fx]={handler_id:fx,handler:fD.handler,name:fD.name,type:e0};if(fC){eX("first sfj handler added, reconnecting");fm()}return fx},handler_success:function(fw,fy){var fx;if(bx.call(fk,fw)<0){return}fx=ft[fw].type;if(fx===e0){cw("ns_map" in fy,"ns_map required param is missing");cw(!("nid" in fy),"nid is disallowed from SFJ handlers");fd(e2,fy.ns_map)}else{cw(fx===fb,"unknown handler type: "+fx);cw("nid" in fy,"nid required param is missing");cw(!("ns_map" in fy),"ns_map is disallowed from user handlers");if((fh==null)||fy.nid<fh){fh=fy.nid}}return e4(fw)},handler_failure:function(fw){eX("handler failed. handler_id="+fw);if(bx.call(fk,fw)<0){return}e6=true;return e4(fw)},handle_visibility_change:function(){if(window.document.hidden){return e8()}else{return fm()}},init:function(fx,fw){cw(!eV,"error: init() has been called twice.");fp=fx;fd(fn,fw);eV=true;if(window.document.visibilityState!=null){window.document.on("visibilitychange",this.handle_visibility_change);if(!window.document.hidden){return e5()}}else{return e5()}},reset:fg,abort:e8,reconnect:fm};O[fa]=fe;return fe};var bq;bq=B.UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var bU;bU=B.FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5,TEAM_SHARED_FOLDER:6};var aW;aW=B.BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(eT,eU){var T;if(eU==null){eU=null}T=Object.clone(eT);if(T.is_dir){T.ago="";T.ts=0}else{T.target_ns=false}T.sort_key=dL.decode_sort_key(T.sort_key);T.request_id=eU!=null?eU:null;return new cD(T)},filepreview_from_selected:function(e5,fa,fb,eW,eX,eY){var e8,e2,eZ,e6,eU,e4,eT,e0,e7,e3,e1,eV,T,e9;if(eW==null){eW=false}if(eX==null){eX=false}if(eY==null){eY=false}if(fa&&(fa.bytes<0||fa.preview_type==="download")){window.open(fa.href,"_blank");return}eV=ei.get_url();e4=ei.deconstruct_url(eV);eU=eV.indexOf("/lightbox")===0;eZ=eV.indexOf("/sh/")===0;e2=eV.indexOf("/s/")===0;eT=e4.qargs.preview!=null;if((e5==="callback")&&eU&&aD.shown){return}else{if(e5==="fileclick"&&fa&&(eY||fa.preview_type!=="photo")&&(eY||fa.preview_type!=="video")){l.show(fa,cf.active_user,true,false,cf.files);if(!(eX||e2||e4.qargs.preview===fa.filename)){l.set_preview_url(fa,cf.active_user,true)}return}}if(!fa){e3=eA.get_selected_files();fa=e3&&e3.first()}e7=eW?[fa]:cf.files;e0=this.browsefile_to_filepreview(e7,eY);if(e0.length){e1=0;if(fa){for(e6=T=0,e9=e0.length;T<e9;e6=++T){e8=e0[e6];if(e8.fq_path===fa.fq_path){e1=e6;break}}}if(eZ){ad.close_shared_link_view()}return aD.init(e0,{start_index:e1,include_delete:true,keep_url:e2||eX,is_loading:fb,share_button_experiment_variant:cf.lightbox_share_button_experiment_variant})}},browsefile_to_filepreview:function(T,eV){var eX,eZ,eU,eY,eT,eW,e0;if(eV==null){eV=false}eY=[];for(eW=0,e0=T.length;eW<e0;eW++){eX=T[eW];if(eX.bytes<0||eX.dir){continue}if(!eV&&eX.preview_type==="photo"&&eX.large_thumbnail_url_tmpl){eZ="null-"+eX.filename;eU=new V({filename:eX.filename,fq_path:eX.fq_path,thumbnail_url_tmpl:eX.large_thumbnail_url_tmpl,dl_url:D.parse(eX.href).updateQuery({dl:1}).toString(),original_url:eX.href,link_hash:eZ,ns_id:eX.ns_id,ns_path:eX.ns_path,owner_id:eX.user_id});eY.push(eU)}else{if(!eV&&eX.preview_type==="video"&&eX.large_thumbnail_url_tmpl&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){eT=new bt({filename:eX.filename,fq_path:eX.fq_path,thumbnail_url_tmpl:eX.large_thumbnail_url_tmpl,preview_url:eX.video_transcode_url(),dl_url:D.parse(eX.href).updateQuery({dl:1}).toString(),ns_id:eX.ns_id,ns_path:eX.ns_path,owner_id:eX.user_id});eY.push(eT)}}}return eY},profile_files:function(eT){var eU,eV,eW,T;eV={files:0,folders:0,shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0};for(eW=0,T=eT.length;eW<T;eW++){eU=eT[eW];if(eU.dir){eV.folders+=1}else{eV.files+=1}if(eU.is_sandbox()){eV.sandboxes+=1}if(eU.is_shared_folder()){eV.shared_folders+=1}if(eU.bytes===-1){eV.deleted+=1}if(eU.target_ns){eV.target_namespaces+=1}if(eU.fq_path.toLowerCase()==="/public"&&cf.public_folder_enabled){eV.public_folder=1}if(eU.in_root_coll){eV.in_root_coll+=1}}return eV},profile_summary:function(eT){var eU,T;eU=a1("%d file","%d files",eT.files,{comment:"used in a phrase such as 'x files and y folders'"}).format(eT.files);T=a1("%d folder","%d folders",eT.folders,{comment:"used in a phrase such as 'x files and y folders'"}).format(eT.folders);if(eT.files&&eT.folders){return ef("%(x_files)s and %(y_folders)s",{comment:"x_files will either be '1 file' or 'd files', similar for x_folders"}).format({x_files:eU,y_folders:T})}else{if(eT.files){return eU}else{if(eT.folders){return T}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var eZ,eX,eU,eT,eY,eW,T,eV;eZ=br("#browse");eU=eZ.find("#browse-root-actions");eT=eZ.find("#browse-sort");eX=eZ.find("#browse-header-status");eV=this.SPECIAL_MODES;for(eW=0,T=eV.length;eW<T;eW++){eY=eV[eW];eZ.removeClass(eY);eU.removeClass(eY);eT.removeClass(eY);eX.removeClass(eY)}if(bW.sparky_search_ui_enabled){bW.reset_fulltext_search(true);eZ.removeClass("fulltext_search");eU.removeClass("fulltext_search");eT.removeClass("fulltext_search");eX.removeClass("fulltext_search");br("#fulltext-search-loading").hide();return br("#fulltext-search-all-link").hide()}},set_special_mode:function(eY){var eT,eU,e0,T,eX,eV,eZ,eW;eT=br("#browse");e0=eT.find("#browse-root-actions");T=eT.find("#browse-sort");eU=eT.find("#browse-header-status");cw(this.SPECIAL_MODES.indexOf(eY)!==-1,"unknown mode");if(eT.hasClass(eY)){cw(e0.hasClass(eY),"inconsistent modes");cw(T.hasClass(eY),"inconsistent modes");return}eW=this.SPECIAL_MODES;for(eV=0,eZ=eW.length;eV<eZ;eV++){eX=eW[eV];if(eX!==eY){eT.removeClass(eX);e0.removeClass(eX);T.removeClass(eX);eU.removeClass(eX)}}eT.addClass(eY);e0.addClass(eY);T.addClass(eY);eU.addClass(eY);if(eY===this.SEARCH_MODE){if(bW.sparky_search_ui_enabled){eT.addClass("fulltext_search");e0.addClass("fulltext_search");T.addClass("fulltext_search");return eU.addClass("fulltext_search")}}},get_mode:function(){var eW,T,eV,eT,eU;T=this.BROWSE_MODE;eU=this.SPECIAL_MODES;for(eV=0,eT=eU.length;eV<eT;eV++){eW=eU[eV];if(br("#browse").hasClass(eW)){T=eW}}return T},load_visible_thumbs:function(){var e2,e5,eV,e1,e6,e7,e3,eU,eZ,eT,eY,eX,e4,T,e0,eW;eU=this.get_files_in_view();e5=eU[1]-eU[0];e3=[Math.max(eU[0]-e5,0),eU[0]];e7=[Math.min(eU[1],cf.files.length),Math.min(eU[1]+e5,cf.files.length)];e2=[];e0=[eU,e7,e3];for(eY=0,e4=e0.length;eY<e4;eY++){e6=e0[eY];e1=e6[0],eZ=e6[1];eW=cf.files.slice(e1,+eZ+1||9000000000);for(eX=0,T=eW.length;eX<T;eX++){eV=eW[eX];if(eV.get_div()){e2.push(eV.get_div().down("img"))}}}eT=function(e8){if(!e8.src.endsWith(cj.SPACER)){e8.addClassName("thumbnail");return e8.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return bh.batch_load_thumbs(e2,this.THUMBS_BATCH_SIZE,eT)},get_files_in_view:function(){var eY,eV,e0,eW,eX,eU,T,e1,eZ,eT,e2;T=[0,cf.files.length-1];eT=z.viewport_dimensions().height;e2=z.scroll_offsets().top;eU=this._get_elm_height();if(!eU){return T}eY=br("#browse-files");eW=parseInt(eY.css("padding-top"),10);if(!eY.length||isNaN(eW)){return T}if(br("body").hasClass("absolutize")){eV=eY.offset().top+eW;e0=eV-e2;if(e0>0){e1=0;eX=eT-e0;eZ=eX/eU}else{e1=Math.abs(e0/eU);eZ=Math.abs(eT-e0)/eU}}else{e1=e2/eU;eX=eT-eW;eZ=(eX+e2)/eU}e1=Math.max(Math.floor(e1),0);eZ=Math.min(Math.floor(eZ),cf.files.length-1);return[e1,eZ]},_get_elm_height:function(){var eT,T;if(cf.files.length>=3&&cf.files[1].get_div()){eT=br(cf.files[1].get_div());T=eT.outerHeight()+parseInt(eT.css("margin-bottom"))+parseInt(eT.css("margin-top"));return T}else{return null}},append_ellipsis:function(T){return ef("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:T})},_show_blue_sharing_icons:function(){return cf.sharing_icons_experiment_variant&&cf.sharing_icons_experiment_variant==="BLUE_ICONS"},get_shared_folder_icon:function(){if(this._show_blue_sharing_icons()){return"s-folder-blue"}else{return"rainbow_16"}},get_shared_link_icon:function(){if(this._show_blue_sharing_icons()){return"s-link-blue"}else{return"s_link"}}};var bf;bf=B.Sort=(function(){var eY,T,eV,eX,eW,eU,eT;eV=function(e0){var eZ;eZ=e0?1:-1;return function(e1,e2){return eZ*dL.sort_by_rank_or_key(e1,e2)}};eX=function(e0){var eZ;eZ=e0?1:-1;return function(e1,e2){if(e1.bytes>e2.bytes){return eZ}else{if(e1.bytes<e2.bytes){return -eZ}else{return eZ*bf.FILES_BY_NAME(e1,e2)}}}};eY=function(e0){var eZ;eZ=e0?1:-1;return function(e1,e2){return eZ*(e1.fq_path.toLowerCase()>e2.fq_path.toLowerCase()?1:-1)}};T=function(e0){var eZ;eZ=e0?1:-1;return function(e2,e3){var e1;e1=e2.ts===e3.ts?0:e2.ts>e3.ts?1:-1;return eZ*e1}};eU=function(eZ){return function(e2){var e1,e0;e0=eZ(e2);e1=eV(true);return function(e3,e4){if(e3.dir^e4.dir){return(e3.dir?1:0)-(e4.dir?1:0)}else{return e0(e3,e4)||e1(e3,e4)}}}};eW=function(eZ){return function(e2){var e0,e1;if(!bf.FOLDERS_FIRST){return eZ(e2)}e1=eZ(e2);e0=e2?1:-1;return function(e4,e5){var e3;if(e4.dir^e5.dir){e3=(e4.dir?0:1)-(e5.dir?0:1);return e0*e3}else{return e1(e4,e5)}}}};eT=function(eZ){return function(e2){var e0,e1;e1=bf.FILES_BY_NAME(e2);e0=e2?1:-1;return function(e4,e5){var e3;if(e4.is_deleted^e5.is_deleted){return(e4.is_deleted?1:0)-(e5.is_deleted?1:0)}e3=0;if(eZ){if(e4.get_category()!==e5.get_category()){e3=e4.get_category()<e5.get_category()?-1:1}else{if(e4.get_extension()!==e5.get_extension()){e3=e4.get_extension()<e5.get_extension()?-1:1}}}else{if(e4.get_extension()!==e5.get_extension()){e3=e4.get_extension()<e5.get_extension()?-1:1}else{if(e4.get_category()!==e5.get_category()){e3=e4.get_category()<e5.get_category()?-1:1}}}return(e0*e3)||e1(e4,e5)}}};return{FILES_BY_NAME:eW(eV),SHARED_WITH:eW(eV),FILES_BY_SIZE:eU(eX),FILES_BY_LOCATION:eU(eY),FILES_BY_KIND:eU(eT(true)),FILES_BY_EXTENSION:eU(eT(false)),FILES_BY_MODIFIED:eU(T),FOLDERS_FIRST:!dL.is_mac(),ALL_BY_MODIFIED:T}})();var c6,bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1};c6=B.FlexColumn=(function(){var eX,eT,e0,eW,eZ,eU,T,eV,eY;eX=[{label:"FILES_BY_KIND",func:bf.FILES_BY_KIND,display:ef("Kind"),is_asc:true},{label:"FILES_BY_EXTENSION",func:bf.FILES_BY_EXTENSION,display:ef("Extension"),is_asc:true},{label:"FILES_BY_SIZE",func:bf.FILES_BY_SIZE,display:ef("Size"),is_asc:false}];eZ={label:"SHARED_WITH",func:bf.FILES_BY_NAME,display:ef("Shared With"),is_asc:true};eT={};e0={};eU=[];eW=[];for(eV=0,eY=eX.length;eV<eY;eV++){T=eX[eV];eU.push(T.func);eT[T.label]=T.display;e0[T.label]=T.is_asc;eW.push(T.label)}e0[eZ.label]=eZ.is_asc;return{SORT_FUNCTIONS:eU,DISPLAY:eT,IS_ASC:e0,LABELS:eW,has_label:function(e1){return(bx.call(this.LABELS,e1)>=0)||e1===eZ.label},has_sort:function(e1){return bx.call(this.SORT_FUNCTIONS,e1)>=0},next:function(e3,e2){var e1;if(e2==null){e2=false}e1=c6.LABELS.indexOf(e3)+1;if(e1===c6.LABELS.length){if(e2){return eZ}else{e1=0}}return eX[e1]}}})();var bW,eh;eh=B.SearchType={COMPLETION:"completion",DELETED:"deleted",FULLTEXT:"full-text"};bW=B.FileSearch={MAX_RESULTS:100,SHORT_PREFIX_LEN:2,SHORT_PREFIX_DELAY_TIME:250,_cache:{},_cache_ts:{},CACHE_TIME:60000,last_state:false,last_fq_path:null,scoped_search:true,last_new_search_ts:{},init:function(e6,e1,e2,e7){var e5,eT,e4,e0,eU,eY,eX,e3,T,eZ,eW,eV;this.sparky_search_ui_enabled=e6;this.firefly_enabled=e1;this.fulltext_search_enabled=e2;this.search_page_enabled=e7;if(this.sparky_search_ui_enabled){return}e0=$("browse-search");e4=$("browse-search-input");b5.add_interval_handler(e0,this.search_with_delay.bind(this));$("advanced-search-box").observe("submit",(function(e8){return function(e9){e8.search();return Event.stop(e9)}})(this));$("exit-search-xclose").observe("click",(function(e8){return function(){return e8.exit_search()}})(this));key("/",cf.KEY_SCOPE,function(){if(L.is_active()){return}if(!e0.hasClassName("focused")){e4.focus();return false}});key("escape",cf.KEY_SCOPE,(function(e8){return function(){if(cf.in_search_mode()){e8.exit_search();return false}if(e4.getValue().strip()===""){e4.blur();return false}}})(this));key("tab",cf.KEY_SCOPE,(function(e8){return function(e9){if(document.activeElement===e4){e9.preventDefault();e4.blur();if(cf.files.length){eA.set_selected_files(cf.files[0])}else{if(cf.in_search_mode()){e8.toggle_advanced()}}return false}}})(this));eU="#advanced-search-link, #advanced-search-exit, #advanced-search-cancel";$(document.body).on("click",eU,this.toggle_advanced.bind(this));document.observe(aB.RENAME,(function(e8){return function(){return e8.clear_cache()}})(this));eZ=[aB.DELETE,aB.COPY,aB.MOVE,aB.PURGE,aB.RESTORE,aB.UPLOAD,aB.SF_NEW,aB.SF_LEAVE,aB.SF_UNSHARE,aB.SF_REJOIN,aB.SF_IGNORE,aB.LINKS_REMOVE];for(eY=0,e3=eZ.length;eY<e3;eY++){eT=eZ[eY];e5=(function(e8){return function(e9){if(!cf.inside_dir){return e8.force_reload()}}})(this);document.observe(eT,e5);br(document).on(eT,e5)}eW=[bq.ADD,bq.MOVE,bq.REMOVE];eV=[];for(eX=0,T=eW.length;eX<T;eX++){eT=eW[eX];eV.push(document.observe(eT,(function(e8){return function(e9){return e8._update_number_results(cf.files.length)}})(this)))}return eV},get_state:function(){var eY,eU,eX,eT,eW,T,eV;eY=br("#browse-search");if(this.sparky_search_ui_enabled){eX={is_advanced:false}}else{eX={is_advanced:eY.length&&!eY.visible()}}if(eX.is_advanced){eV=["all_terms","any_terms","excluded_terms","exact"];for(eW=0,T=eV.length;eW<T;eW++){eU=eV[eW];eT=br("#"+eU).val();if(eT){eX[eU]=eT}}eX.include_files=br("#include_files").prop("checked");eX.include_folders=br("#include_folders").prop("checked");eX.include_deleted=!Constants.can_see_trash&&br("#include_deleted").prop("checked")}else{eX.query_unnormalized=this.get_basic_query();eX.query=eX.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ");if(this.sparky_search_ui_enabled){eX.last_fq_path=this.last_fq_path!=null?this.last_fq_path:""}}return eX},set_state:function(eW){var eT,eV,T,eU;if(eW.is_advanced){eU=["all_terms","any_terms","excluded_terms","exact"];for(eV=0,T=eU.length;eV<T;eV++){eT=eU[eV];if(eW[eT]){$(eT).setValue(eW[eT])}}br("#include_files").prop("checked",eW.include_files);br("#include_folders").prop("checked",eW.include_folders);if(!Constants.can_see_trash){br("#include_deleted").prop("checked",eW.include_deleted)}this.show_advanced();return this.search()}else{if(this.sparky_search_ui_enabled){this.last_fq_path=eW.last_fq_path!=null?eW.last_fq_path:"";this.scoped_search=this.last_fq_path!=="";cf.inside_dir=this.scoped_search}this.set_basic_query(eW.query_unnormalized);this.show_basic();if(this.sparky_search_ui_enabled){if(this.search_page_enabled){return this.do_search(false,true)}else{return this.do_search(this.scoped_search,true)}}else{return this.search()}}},state_changed:function(){var eT,T;eT=this.get_state();T=this.last_state;if(this.sparky_search_ui_enabled){if(T===false){return !!eT.query}return(eT.is_advanced!==T.is_advanced)||(eT.query!==T.query)||(eT.last_fq_path!==T.last_fq_path)}else{if(T===false){return !!eT.query}return(eT.is_advanced!==T.is_advanced)||(eT.query!==T.query)}},get_basic_query:function(){return this._get_browse_search_input().val()},set_basic_query:function(T){if(T===this.get_basic_query()){return}this._get_browse_search_input().val(T);if(!this.sparky_search_ui_enabled){$("browse-search").show()}return $("advanced-search-link").__date(ef("Advanced search"))},set_title:function(){var T,eT;T=this.get_state();eT=ef("Search - Dropbox");if(T.query_unnormalized){eT=""+T.query_unnormalized+" - "+eT}return document.title=eT},_pending_search_q:"",search_with_delay:function(){var eT,eU,T;eU=this.search.bind(this);T=this.get_state();if(T.is_advanced){return}eT=T.query;if(eT.length===0&&cf.in_search_mode()){eU();return}if(eT.length<=this.SHORT_PREFIX_LEN){if(eT!==this._pending_search_q){this._pending_search_q=eT;clearTimeout(this._pending_search_timer);return this._pending_search_timer=setTimeout(eU,this.SHORT_PREFIX_DELAY_TIME)}}else{this._pending_search_q="";if(this.state_changed()){return eU()}}},_set_scope_path_to_browse_location:function(){if(cf.inside_dir){return this.last_fq_path=cf.containing_fq_path()}else{return this.last_fq_path=""}},do_search:function(eU,T){var eW,eX,eV,eT;if(T==null){T=false}if(typeof cf.entered_search==="function"){cf.entered_search()}eT=!T&&!cf.in_search_mode();if(this.sparky_search_ui_enabled&&eT){this._set_scope_path_to_browse_location()}eV=this.get_state();eX=""===this.get_basic_query();if(!eV.is_advanced&&eX){if(cf.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=eV;this._clear_on_reload=true;if(!(cf.in_search_mode()&&!this.sparky_search_ui_enabled)){eA.deselect_all();cf.clear();aW.set_special_mode("search");if(!this.sparky_search_ui_enabled){this._set_scope_path_to_browse_location()}this.scoped_search=this.last_fq_path!=="";if(!T){eW=null;if(this.sparky_search_ui_enabled){if(this.search_page_enabled){ei.push_state("/search/"+cf.active_user.role,eV)}else{ei.push_state("/search",eV)}}else{ei.push_state("/search")}}}this._prune_cache();this.set_title();if(eV.is_advanced){this.ask_server_advanced()}else{if(this.sparky_search_ui_enabled){this.reset_fulltext_search(this.scoped_search);this.last_new_search_ts=new Date();br("#fulltext-search-loading").show();this.ask_server("/ajax_fulltext_search",eU,0,this.MAX_RESULTS,false)}else{if(eV.query in this._cache){this.update_results()}else{if(!this.attempt_cache_filter()){this.ask_server("/ajax_search",false)}}}}return em("search")},build_search_url:function(T,eT){if(this.search_page_enabled){return ei.construct_url("/search/"+T.role,eT)}else{return ei.construct_url("/search",eT)}},search:function(T){if(T==null){T=false}if(T!==this.scoped_search){this.last_state=false}this.scoped_search=this.scoped_search&&T;if(this.sparky_search_ui_enabled&&!this.scoped_search){this.last_fq_path=""}return this.do_search(false)},load_more_results:function(){var T;if(this.sparky_search_ui_enabled&&!this.end_of_results){T=this.search_pos;if(this.end_of_active_results){T=this.deleted_search_pos}return this.ask_server("/ajax_fulltext_search",false,T,this.MAX_RESULTS,this.end_of_active_results)}},firefly_filename_search:function(){return this.do_search(true)},_prune_cache:function(){var eU,eV,eX,eW,eT,T;eU=new Date();eV=[];for(eX in this._cache_ts){if(eU-this._cache_ts[eX]>this.CACHE_TIME){eV.push(eX)}}T=[];for(eW=0,eT=eV.length;eW<eT;eW++){eX=eV[eW];delete this._cache[eX];T.push(delete this._cache_ts[eX])}return T},update_empty:function(){var T;T=ef("No results found");if(this.scoped_search&&this.sparky_search_ui_enabled){T=ef("No results found in '%(path)s'").format({path:au.filename(this.last_fq_path)})}br("#noresults-header").text(T);br("#fulltext-search-all-link").hide();br("#noresults-directions").toggle(!(this.scoped_search&&this.sparky_search_ui_enabled));return br("#noresults-search-all-link").toggle(this.scoped_search&&this.sparky_search_ui_enabled)},show_empty:function(){this.update_empty();return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},reset_fulltext_search:function(T){eA.deselect_all();cf.clear();cf.reset_state();cf.update_header_status("");this.search_pos=0;this.deleted_search_pos=0;this.end_of_active_results=false;this.end_of_results=false;this.scoped_search=T;return br("#fulltext-search-all-link").hide()},exit_search:function(){var eW,eT,eV,T,eU;if(cf.in_search_mode()&&this.sparky_search_ui_enabled){if(this.search_page_enabled){eW=[cf.inside_deleted_dir,cf.inside_deleted_sandbox,cf.inside_deleted_shared_folder];if(!$u.any(eW)){cf.deleted_shown=false}}else{cf.deleted_shown=false}}eU=$$("#advanced-search-box .sick-input input");for(eV=0,T=eU.length;eV<T;eV++){eT=eU[eV];eT.setValue("");eT.blur()}this.show_basic();$("browse").removeClassName("pending-search");this.hide_empty();if(this.search_page_enabled){return aV.set_path_url(null,this.last_fq_path,cf.deleted_shown)}else{cf.first_load=true;return cf.reload_fqpath(this.last_fq_path,true)}},clear_cache:function(){this._cache={};return this._cache_ts={}},force_reload:function(){this.clear_cache();return this.search()},create_completion_log_dict:function(eT,eY,eV,eW,eX,T,eU){if(eT==null){eT=null}if(eY==null){eY=null}if(eV==null){eV=null}if(eW==null){eW=null}if(eX==null){eX=null}if(T==null){T=null}if(eU==null){eU=null}if(eT==null){return}if(eY!=null){eT.request_id=eY}if(eV!=null){eT.latency=(new Date().getTime())-eV}if(eW!=null){eT.query_string=eW.query;if((T==null)||T===200){eT.displayed=this.last_state.query===eW.query?true:false}}if(eX!=null){eT.result_count=eX}if((T!=null)&&T!==200){eT.failure_type=T}if(eU!=null){eT.file_nsid=eU.ns_id;eT.file_sjid=eU.sjid}return eT},ask_server:function(eT,eY,eU,eZ,eW){var eX,e2,e0,eV,e1,T;T=this.get_state();e1=null;if(this.sparky_search_ui_enabled){eV=new Date();if(eW){e1=eh.DELETED}else{if(eY){e1=eh.COMPLETION}else{e1=eh.FULLTEXT}}}eX={firefly:this.firefly_enabled,infinite_scroll:eU>0?true:false,path_scoped:false,search_type:e1,query_string:T.query};a0.SearchClientActivityLogger.log("query_started",cf.active_user.id,eX);cw(!T.is_advanced,"expected to be in basic search mode");if(!eU){br("#web-search-results").html(ef("Searching..."))}br("#browse").addClass("pending-search");e2={query:T.query};if(this.sparky_search_ui_enabled){if(eU){e2.start=eU}if(eZ){e2.max_results=eZ}if(eW){e2.deleted=eW}if(this.scoped_search){e2.fq_path=this.last_fq_path}if(!eY){this.last_fulltext_query=T.query}}if(eY){e2.filename_only=true}e0=false;return new Ajax.DBRequest(eT,{no_watch:true,evalJSON:false,parameters:e2,log_timing:true,onSuccess:(function(e3){return function(e5){var e6,e4,e8,e7;if(!cf.in_search_mode()){return}e8=e5.request.parameters.parent_request_id;e6=JSON.parse(e5.responseText);e7=e6.file_info.length;if(e3.sparky_search_ui_enabled){if(T.query===e3.last_fulltext_query&&eV>=e3.last_new_search_ts){e3.search_pos=e3.search_pos+e7;if(e3.end_of_active_results){e3.deleted_search_pos=e3.deleted_search_pos+e7}if(e7<e3.MAX_RESULTS){e3.end_of_results=true&&e3.end_of_active_results;e3.end_of_active_results=true;if(!e3.end_of_results){e0=true}else{br("#fulltext-search-loading").hide()}}e3.update_results(e6,e0,e8)}}else{e3._cache[T.query]=e6;e3._cache_ts[T.query]=new Date();if(!e3.last_state.is_advanced&&(e3.last_state.query===T.query)){e3.update_results(null,false,e8)}}if(e6.file_info.length>0){e4=e6.file_info[0]}else{e4=null}eX=e3.create_completion_log_dict(eX,e8,e5.request.start_time,T,e7,null,e4);return a0.SearchClientActivityLogger.log("query_completed",cf.active_user.id,eX)}})(this),onFailure:(function(e3){return function(e4){eX=e3.create_completion_log_dict(eX,e4.request.parameters.parent_request_id,e4.request.start_time,T,null,e4.status);return a0.SearchClientActivityLogger.log("query_failed",cf.active_user.id,eX)}})(this),cleanUp:(function(e3){return function(){if(e0){return e3.load_more_results()}else{return br("#browse").removeClass("pending-search")}}})(this),subject_user:cf.active_user})},ask_server_advanced:function(){var T,eT;eT=this.get_state();T={firefly:this.firefly_enabled,query_string:eT.query};a0.SearchClientActivityLogger.log("query_started",cf.active_user.id,T);cw(eT.is_advanced,"expected to be in advanced search mode");cw(!eT.query,"expected advanced search params only");delete eT.is_advanced;$("web-search-results").__date(ef("Searching..."));$("browse").addClassName("pending-search");return new Ajax.DBRequest("/ajax_advanced_search",{no_watch:true,evalJSON:false,parameters:eT,log_timing:true,onSuccess:(function(eU){return function(eW){var eV,eX;if(!cf.in_search_mode()){return}eX=eW.request.parameters.parent_request_id;eU.advanced_results=JSON.parse(eW.responseText);eU.update_results(null,false,eX);if(eU.advanced_results.file_info.length>0){eV=eU.advanced_results.file_info[0]}else{eV=null}T=eU.create_completion_log_dict(T,eW.request.parameters.parent_request_id,eW.request.start_time,eT,eU.advanced_results.file_info.length,null,eV);return a0.SearchClientActivityLogger.log("query_completed",cf.active_user.id,T)}})(this),onFailure:(function(eU){return function(eV){T=eU.create_completion_log_dict(T,eV.request.parameters.parent_request_id,eV.request.start_time,eT,null,eV.status);return a0.SearchClientActivityLogger.log("query_failed",cf.active_user.id,T)}})(this),cleanUp:function(eU){return $("browse").removeClassName("pending-search")},subject_user:cf.active_user})},attempt_cache_filter:function(){var T,eV,eT,eZ,eU,eY,eX,eW;eY=this.get_state().query;eZ=this._query_to_regex(eY);eT=function(e0){return eZ.match(au.filename(e0.ns_path).toLowerCase())};if(eY.length<=1){return false}for(eU=eX=eW=eY.length-1;eW<=1?eX<=1:eX>=1;eU=eW<=1?++eX:--eX){eV=eY.substr(0,eU).strip();if(eV in this._cache){if(this._cache[eV].file_info.length<this.MAX_RESULTS){T=Object.clone(this._cache[eV]);T.file_info=T.file_info.findAll(eT);this.update_results(T);return true}else{return false}}}return false},_query_to_regex:function(T){return new RegExp(RegExp.escape(T).split(new RegExp(" +")).join(".*"))},update_results:function(eT,T,eX){var eW,eV,eU;if(T==null){T=false}if(eX==null){eX=null}if(!this.sparky_search_ui_enabled){cf.reset_state();cf.reset_sort()}eU=this.get_state();if(!eT&&eU.is_advanced){eT=this.advanced_results}if(!eT){eV="the only way to get to advanced is through basic -- expected last_state to exist and not be advanced!";cw(this.last_state&&!this.last_state.is_advanced,eV);cw(this.last_state.query in this._cache,("update() called w/o a cache entry: q="+this.last_state.query)+(eT=this._cache[this.last_state.query]))}cf.update(eT,eX);cf.set_selection_from_fq_paths_or_index(bW);eW=eU.is_advanced?ef("Basic search"):ef("Advanced search");$("advanced-search-link").__date(eW);if(!T){if(this.sparky_search_ui_enabled){this._update_number_results(this.search_pos)}else{this._update_number_results(cf.files.length)}if(cf.files.length){return this.hide_empty()}else{return this.show_empty()}}},_update_number_results:function(eT){var T,eU;if(this.sparky_search_ui_enabled){if(eT===0){T=""}else{if(this.end_of_results){T=this.fulltext_search_enabled?a1("%(num_results)s result in files, folders, and content.","%(num_results)s results in files, folders, and content.",eT).format({num_results:eT}):a1("%(num_results)s result in files and folders.","%(num_results)s results in files and folders.",eT).format({num_results:eT})}else{T=this.fulltext_search_enabled?a1("Over %(num_results)s result in files, folders, and content.","Over %(num_results)s results in files, folders, and content.",eT).format({num_results:eT}):a1("Over %(num_results)s result in files and folders.","Over %(num_results)s results in files and folders.",eT).format({num_results:eT})}}}else{if(eT===0){T=ef("No Results")}else{if(eT>=this.MAX_RESULTS){eT=eT+"+"}T=a1("%(num_results)s result","%(num_results)s results",eT).format({num_results:eT})}}eU=ef("Search")+" - "+T;if(this.sparky_search_ui_enabled){cf.update_header_status(T);eU=ef("Results for '%(query)s'").format({query:this.get_state().query});if(this.scoped_search){eU=ef("Results for '%(query)s' in '%(path)s'").format({query:this.get_state().query,path:au.filename(this.last_fq_path+"'")})}}br("#web-search-results").text(eU);if(this.sparky_search_ui_enabled&&this.scoped_search){return br("#fulltext-search-all-link").show()}},show_advanced:function(){$("browse").addClassName("advanced-search");$("browse-search").hide();$("advanced-search-link").__date(ef("Basic search"));$("advanced-search-box").show();return $("all_terms").focus()},show_basic:function(T){$("browse").removeClassName("advanced-search");$("advanced-search-box").hide();$("advanced-search-link").__date(ef("Advanced search"));if($("browse-search")){$("browse-search").show();if(!T){return $("browse-search-input").focus()}}},toggle_advanced:function(){var T,eT;eT=$("advanced-search-link");eT.toggleClassName("selected");if(eT.hasClassName("selected")){br("#all_terms").val(this.get_basic_query());return this.show_advanced()}else{T=br("#all_terms").val();if(T){this.set_basic_query(T);return this.show_basic()}else{return this.exit_search()}}},history_change_handler:function(T,eT){var eU;if(this.sparky_search_ui_enabled&&eT){this.last_state=eT;this.last_state.is_advanced=false}if(!this.last_state){aV.set_path_url(Constants.root_ns,"");return}if(this.state_changed()){this.set_state(this.last_state)}if(!l.shown()){key.setScope(cf.KEY_SCOPE)}if(eA.get_selected_files().length){eU=eA.get_selected_files()[0].get_div();return cf.scrollToWithPadding(eU,eU.getHeight()*2)}},clear_searchbox:function(){return this._get_browse_search_input().val("")},_get_browse_search_input:function(){return br("#browse-search-input")}};var d4;d4=B.BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var eU,T,eT;eT=this.advanced_dict;for(T in eT){eU=eT[T];key(eU.key,cf.KEY_SCOPE,eU.onPress)}this.customize_chart();if(dL.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",(function(eV){return function(eW){if(eW.charCode===63&&!z.focus_in_input()){return eV.advanced_dict.help.onPress()}}})(this))}},customize_chart:function(){var eV,eT,eU,T;eV=(dL.is_mac()?".key-windows":".key-macos");eU=0;eT=void 0;T=[];while(true){eT=$("keys-chart").down(eV,eU++);if(!eT){break}T.push(eT.hide())}return T},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var T,eT;T=$("keys-chart");T.style.position="fixed";eT=$("browse-sort");if(bW.sparky_search_ui_enabled&&cf.in_search_mode()){eT=$("browse-header-wrapper")}else{if(eT.getStyle("display")==="none"){eT=$("browse-root-actions")}}br(T).clonePosition(br(eT),{setHeight:false});T.style.top=eT.cumulativeOffset()[1]+eT.getHeight()+"px";T.setOpacity(0.9);return T.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:ef("Rename selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"f2",onPress:function(eT,eU){var T;T=eA.get_selected_files();if(T.length){return T.first().edit()}}},"delete":{title:ef("Delete selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"delete, command+backspace, backspace",onPress:function(eV,eW){var T,eU,eT;Event.stop(eV);if(cf.inside_read_only_shared_folder){ab.warning(ef("You don't have permission to delete files in this folder."))}eT=eA.get_selected_files();if(eT.length===1){T=eT.first();if(T.is_deleted){return di.show_purge(T.fq_path,T.dir)}else{return di.show_delete(cf.active_user,T.fq_path,T.dir)}}else{if(eT.length>1){eU=aW.profile_files(eT);if(eU.deleted===eT.length){return di.show_bulk_purge(eT)}else{if(eU.deleted===0){return di.show_bulk_delete(cf.active_user,eT)}}}}}},help:{title:ef("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return d4.toggle_chart()}},close_help:{title:ef("Hide keyboard shorcuts"),key:"escape",onPress:function(){return d4.hide_chart()}},up_dir:{title:ef("Up a folder",{comment:"meaning, go from the current folder to its containing (parent) folder. this is one step up only -- the parent, not the root."}),key:"left",onPress:function(){var T,eT;cf.keyboard_nav=true;if(!cf.reloading){if(cf.inside_dir){if(!cf.containing_ns_path()&&cf.containing_ns_id()!==Constants.root_ns){eT=Constants.root_ns;T=au.normalize(au.parent_dir(cf.containing_fq_path()))}else{eT=cf.containing_ns_id();T=au.normalize(au.parent_dir(cf.containing_ns_path()))}if(cf.containing_ns_path()!==T||cf.containing_ns_id()!==eT){cf.select_fq_paths=[cf.containing_fq_path()];return aV.set_path_url(eT,T)}else{return eA.flicker_selected()}}else{return eA.flicker_selected()}}}},open_file:{title:ef("Open highlighted file"),key:"enter",onPress:function(){var T,eT;eT=eA.get_selected_files();if(eT.length===1){T=eT[0];cf.open_file(T,false)}return false}},open_dir:{title:ef("Open highlighted folder"),key:"right",onPress:function(){var T,eT;cf.keyboard_nav=true;eT=eA.get_selected_files();if(eT.length===1){T=eT[0];if(T.dir){cf.select_index=0;cf.open_folder(T)}else{eA.flicker_selected()}}return false}},undo:{title:ef("Undo recent move/copy/rename/delete"),key:""+(key.main_modifier())+"+z",onPress:function(){U.perform_undo();return false}},search:{title:ef("Search"),key:"/",onPress:function(){br(document).trigger("db:searchbar:focus");return false}}}};var ad;ad=B.BrowseSharedLink={store_shared_link_info:function(eU,T,eT){if(eU.charAt(0)==="/"){eU=eU.substring(1)}this._shared_link_fq_dir=eU;this._shared_link_file=eT;return this._shared_link_url=T},shared_link_handler:function(T,eT){if(ad._shared_link_url==="/s/"+T){aV.load_browse_view(void 0,encodeURIComponent(ad._shared_link_fq_dir));cf.open_preview(ad._shared_link_file)}else{if(ad._shared_link_url==="/sh/"+T){aV.load_browse_view(void 0,encodeURIComponent(ad._shared_link_fq_dir));if(ad._shared_link_file){cf.open_preview(ad._shared_link_file)}else{aD.init([],{include_delete:true,keep_url:true,filename_in_url:true,enable_sublinks:true,share_button_experiment_variant:cf.lightbox_share_button_experiment_variant})}}else{location.reload()}}return ad.highlight_user()},close_shared_link_view:function(){if(window.location.pathname===this._shared_link_url){return aV.set_path_url(null,"/"+this._shared_link_fq_dir)}},highlight_user:function(){if(cf.active_user.role===Constants.ROLE_WORK){br("#work-nav-item").addClass("selected");return br("#personal-nav-item").removeClass("selected")}else{br("#personal-nav-item").addClass("selected");return br("#work-nav-item").removeClass("selected")}}};var aV;aV=B.BrowseURL={_DEFAULTS:{d:false,select:false,open_preview:false},_get_helper:function(T){var eT;eT=ei.deconstruct_url().qargs;if(T in eT){return !!eT[T]}else{cw(T in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[T]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(T,eU){var eT;if(T!==cf.active_user.root_ns&&(!(T in cf.ns_id_to_mount_point))){T=cf.active_user.root_ns}if(T===cf.active_user.root_ns){return eU}else{eT=cf.ns_id_to_mount_point[T];return eT+eU}},_make_url:function(T,eX,eY){var eZ,eW,eT,eV,eU;if(eY==null){eY={}}if(!T){T=cf.active_user.root_ns}cw(typeof T==="number","expected ns_id as a number");cw(typeof eX==="string","expected explicit ns_path string");eZ=this.ns_to_fq_path(T,eX);eV=D({path:eR.get_browse_root(cf.active_user)+eZ});eT=ei.deconstruct_url().qargs;for(eW in eY){eU=eY[eW];if(eW in this._DEFAULTS&&!!eU!==this._DEFAULTS[eW]){eT[eW]=eU}}for(eW in eT){if(!(eW in this._DEFAULTS)){delete eT[eW]}}return ei.construct_url(String(eV),eT)},set_path_url:function(T,eX,eV){var eW,eU,eT;if(!T){T=cf.active_user.root_ns}else{eU=parseInt(T,10);T=!isNaN(eU)?eU:Constants.root_ns}eX=au.normalize(eX);eT=eV!=null?this._make_url(T,eX,{d:eV?1:0}):this._make_url(T,eX);eW=ei.deconstruct_url(eT);return ei.push_state(eW.path,eW.qargs)},set_del_url:function(T){var eU,eV,eT;eT=ei.deconstruct_url();eU=eT.path;eV=eT.qargs;if(T){eV.d="1"}else{delete eV.d}return ei.push_state(eU,eV)},_first_load:true,_last_ns_dir:null,_last_ns_id:null,load_browse_view:function(T,eV,eT){var eW,eX,eU;if(eT==null){eT=false}key.setScope(cf.KEY_SCOPE);eV=au.normalize(eV);eU=false;if(!this._first_load){eU=(!cf.inside_dir)||(eV!==this._last_ns_dir)||(T!==this._last_ns_id)||(cf.in_search_mode()&&bW.sparky_search_ui_enabled)}eW=eT!==cf.deleted_shown;cf.deleted_shown=eT;if(this._first_load||eU||eW){cf.reload(T,eV,true)}bW.show_basic(true);this._first_load=false;this._last_ns_dir=eV;this._last_ns_id=T;if(eA.get_selected_files().length){eX=eA.get_selected_files()[0].get_div();if(eX){return cf.scrollToWithPadding(eX,eX.getHeight()*2)}}},history_change_handler:function(eW,eX){var eU,eV,T,eT;if(cf.show_inline_share){cf.reset_browse_exp()}T=eX.ns;eT=eX.d==="1";this.load_browse_view(T,eW,eT);if(eX.preview!=null){eV="/"+D.encode(eX.preview);if(!!eW){eV="/"+eW+eV}eU=cf.find_file(D.decode(eV));if(eU!=null){return cf.open_preview(eU,false,false,true)}else{a0.UserActivityLogger.log("web","browse_preview_does_not_exist");return ei.replace_state(eR.get_browse_root(cf.active_user))}}else{if(l.shown()){return l.hide()}}},parse_b2_hash:function(eW){var eU,eT,eV,T,eX;T=eW.split(":");if(T.length!==4){return false}eV=T[0];eU=T[2]==="1";eT=T[3];eX=!eT||dL.isNumber(eT);if(!eX){return false}eT=parseInt(eT,10)||Constants.root_ns;return{ns_id:eT,ns_path:eV,deleted:eU}}};var cD;cD=B.BrowseFile=Class.create({initialize:function(eU){var eW,eT,eV,T,eX;eW=cf.inside_dir?c4:b8;eT=au.filename(eU.fq_path);this.icon=eU.icon;this.filename=eT;this.filename_highlights=(eV=eU.filename_highlights)!=null?eV:[];this.caption=bG.em_snippet(eT,eW);this.ns_id=eU.ns_id;this.ns_path=eU.ns_path;this.fq_path=eU.fq_path;this.mount_point=eU.mount_point;this.hash=eU.hash;this.href=eU.href;this.size=eU.size!=="None"?eU.size:"";this.bytes=eU.bytes;this.is_deleted=this.bytes===-1;this.ago=eU.ago;this.ts=eU.ts;this.dir=eU.is_dir?1:0;this.target_ns=eU.target_ns;this.sort_rank=eU.sort_rank;this.sort_key=eU.sort_key||[""];this.sjid=eU.sjid;this.tkey=void 0;this.thumbnail_url_tmpl=eU.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=eU.large_thumbnail_url_tmpl;this.type=eU.type;this.preview_type=eU.preview_type;if(eU.last_modified_fname){this.last_modified_fname=bG.em_snippet(eU.last_modified_fname,cF)}this.htmlified_link=eU.htmlified_link;this.doc_preview_status=eU.doc_preview_status;this.in_root_coll=eU.in_root_coll;this.user_id=eU.user_id;this.sf_perm_role=eU.sf_perm_role;this.fulltext_search=eU.fulltext_search;this.read_only=eU.read_only?true:false;this.is_read_only_mount=eU.is_read_only_mount?true:false;this.request_id=(T=eU.request_id)!=null?T:null;return this.match_type=(eX=eU.match_type)!=null?eX:"UNKNOWN_MATCH"},track_in_browse:function(){if(!(this.to_key() in cD._file_index)){cf.add_file(this);return cD._file_index[this.to_key()]=this}},is_shared_folder:function(){return this.type===bU.SHARED_FOLDER},could_be_shared_folder:function(){var eU,eV,T,eT;eV=cf.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");eT=cf.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";T=this.target_ns;eU=this.ns_id!==Constants.root_ns;return this.type===bU.FOLDER&&!T&&!eV&&!eT&&!this.is_sandbox()&&(cf.bypass_nested_sharing_checks||!eU)},is_shared_single_file:function(){var T;T=this.ns_id!==Constants.root_ns;return this.type===bU.FILE&&T},could_be_shared_single_file:function(){var eT,eU,T;eU=cf.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");T=cf.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";eT=this.ns_id!==Constants.root_ns;return this.type===bU.FILE&&!(eT||eU||T)},is_sandbox:function(){return this.type===bU.SANDBOX},video_transcode_url:function(){var T;cw(this.fq_path,"video_transcode_url: expected a non-root fq_path");if(Constants.transcoder_hls4web){T=D({path:"/playlist"+this.fq_path})}else{T=D({scheme:"https",authority:Constants.LIVE_TRANSCODE_SERVER,path:"/transcode_video/w/"+(this.hash+this.fq_path)})}return T.updateQuery(Constants.UID_PARAM_NAME,cf.active_user.id).toString()},get_div:function(){return $("f_"+(this.to_key()))},rename:function(eX,eZ,eV,eW,eY,e0){var eT,e1,T,eU;eT=cf.inside_dir?c4:b8;T=this.fq_path;cf.pre_action_selection=[T];e1=cf.find_file(eX);if(e1){cf.remove_file(e1)}this.filename=au.filename(eX);this.caption=bG.em_snippet(this.filename,eT);this.fq_path=eX;this.ns_path=eZ;this.htmlified_link=e0;this.hash=eV;this.sort_key=eW;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){eU=this.href.split("/");eU[eU.length-1]=dL.urlquote(this.filename)+("?w="+eV);this.href=eU.join("/");this.icon=eY}else{this.href="/home"+dL.urlquote(eX);if(this.target_ns){cf.ns_id_to_mount_point[this.target_ns]=eX}}if(cf.in_search_mode()&&bW.sparky_search_ui_enabled){this.filename_highlights=[]}cD._file_index[this.to_key()]=this;cf.update_file_pos(this);return document.fire(aB.RENAME,{old_fq_path:T,file:this})},edit:function(){var eU,T,eV,eT,eW;this.editing=true;cf.selectable();eW=(function(eX){return function(e5){var eZ,eY,e2,e7,e4,e1,e8,e6,e3,e0;e0=e5.responseText.evalJSON(true);cw(e0.new_browse_files.length===1,"No new file data returned.");e2=e0.new_browse_files.first();e7=e2.fq_path;e4=e2.hash;e3=dL.decode_sort_key(e2.sort_key);e8=e2.icon;e6=e2.ns_path;e1=e2.htmlified_link;eZ=e0.changesets;eY=ef("Rename complete.");U.notifyWithUndo(eY,eZ,di.do_rollback);eX.rename(e7,e6,e4,e3,e8,e1);eA.set_selected_files([eX]);eX.get_div().smoothScrollIntoView();aW.load_visible_thumbs();return cf.fire_visible_change_callbacks()}})(this);T=D({path:"/cmd/rename"+this.fq_path}).updateQuery(Constants.UID_PARAM_NAME,cf.active_user).toString();eV=bW.sparky_search_ui_enabled&&cf.in_search_mode()?".filename-col":".filename-col a";eU=new Ajax.InPlaceEditor(this.get_div().down(eV),T,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:(function(eX){return function(){return eX.editing=false}})(this),onFailure:function(){},savingText:ef("Saving..."),ajaxOptions:{job:true,subject_user:cf.active_user,html_in_error_msg:true,progress_text:ef("Renaming..."),method:"POST",onCreate:ab.clear,onSuccess:eW,onUninitialized:cf.unselectable},callback:(function(eX){return function(eY,eZ){return{to_path:eZ||"",folder:(eX.dir?"yes":"")}}})(this)});eU.enterEditMode();eT=this.get_div().down(".editor_field");if("selectionEnd" in eT&&this.filename.lastIndexOf(".")>-1){return eT.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return""+this.ns_id+"_"+this.sjid},get_category:function(){var eT,T;if(this.dir){if(cf.inside_dir&&cf.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&cf.public_folder_enabled){eT="PUBLIC_FOLDER"}}if(eT==null){if(this.type===bU.FOLDER){eT="FOLDER"}else{if(this.type===bU.PACKAGE){eT="FOLDER"}else{if(this.type===bU.TEAM_SHARED_FOLDER){eT="TEAM_SHARED_FOLDER"}else{if(this.type===bU.SHARED_FOLDER){eT="SHARED_FOLDER"}else{if(this.type===bU.SANDBOX){eT="SANDBOX"}else{if(this.target_ns){eT="SHARED_FOLDER"}else{eT="FOLDER"}}}}}}}}if(eT==null){eT=cD.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}T=this.is_deleted?cD.CATEGORY_TO_DELETED_TRANSLATION[eT]:cD.CATEGORY_TO_TRANSLATION[eT];cw(T,"CATEGORY MISSING FOR "+eT);return T},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return au.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&cf.is_shmodelable_path(this.fq_path)}});cD._CATEGORIES={IMAGE:"bmp cr2 gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"ai cdr csv dbxlink doc docx docm eps fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};cD.EXTENSION_TO_CATEGORY={};cD.CATEGORY_TO_TRANSLATION={FILE:ef("file"),FOLDER:ef("folder"),SHARED_FOLDER:ef("shared folder"),TEAM_SHARED_FOLDER:ef("team folder"),PUBLIC_FOLDER:ef("folder"),IMAGE:ef("image"),VIDEO:ef("video"),AUDIO:ef("audio"),DOCUMENT:ef("document"),COMPRESSED_FILE:ef("archive"),CODE:ef("code"),DISK_IMAGE:ef("disk image"),EXECUTABLE:ef("executable"),SHORTCUT:ef("shortcut"),LINK:ef("link"),FONT:ef("font"),SANDBOX:ef("app folder")};cD.CATEGORY_TO_DELETED_TRANSLATION={FILE:ef("deleted file"),FOLDER:ef("deleted folder"),SHARED_FOLDER:ef("deleted shared folder"),TEAM_SHARED_FOLDER:ef("deleted team folder"),PUBLIC_FOLDER:ef("deleted folder"),IMAGE:ef("deleted image"),VIDEO:ef("deleted video"),AUDIO:ef("deleted audio"),DOCUMENT:ef("deleted document"),COMPRESSED_FILE:ef("deleted archive"),CODE:ef("deleted code"),DISK_IMAGE:ef("deleted disk image"),EXECUTABLE:ef("deleted executable"),SHORTCUT:ef("deleted shortcut"),LINK:ef("deleted link"),FONT:ef("deleted font"),SANDBOX:ef("deleted app folder")};(function(){var eU,eW,eT,eV,T;eV=cD._CATEGORIES;T=[];for(eU in eV){eT=eV[eU];T.push((function(){var e0,eY,eX,eZ;eX=eT.trim().split(" ");eZ=[];for(e0=0,eY=eX.length;e0<eY;e0++){eW=eX[e0];eZ.push(cD.EXTENSION_TO_CATEGORY[eW]=eU)}return eZ})())}return T})();cD._file_index={};cD.from_key=function(T){return cD._file_index[T]};cD.from_elem=function(eT){var T;if(!eT){return}T=eT.readAttribute("data-identity");if(T){return cD.from_key(T)}else{return cD.from_elem(eT.up("[data-identity]"))}};var a,el,ae,eK,bA,dm;a=INLINE_JS.BrowseActions=B.BrowseActions=Class.create({initialize:function(T){return this._set_files(T)},firefly_logging_helper:function(T){if(cf.in_search_mode()&&T){this._firefly_log_values.action_type=T;return a0.SearchClientActivityLogger.log("result_action",cf.active_user.id,this._firefly_log_values)}},unlisten:function(){},get_action_names:function(){var T;T=this.get_files();if(T.length<2){return this._get_actions_single(T.first())}else{return this._get_actions_multi(T)}},get_files:function(){return this._files},get_action_by_name:function(T){return this.evaluate_action(a.option_dict[T],T)},evaluate_action:function(eU,eT){var eV,eW,T;eV=(function(eX){return function(eZ,eY){if((eY!=null)&&(eZ==null)){return eY}if(br.isFunction(eZ)){return eZ.call(eX)}else{if(eZ!=null){return eZ}else{return eY}}}})(this);T={icon_href:eU.icon_href,target:eU.target,click_handler:eU.click_handler,type:eU.type,name:eT||eU.name,is_dropdown:!!eU.is_dropdown,icon:eV(eU.icon),text:eV(eU.text),detail_text:eV(eU.detail_text),href:eV(eU.href,""),kind:eV(eU.kind,"icon"),button_label:eV(eU.button_label,eU.text)};if(br.isFunction(eU.subactions)){T.subactions=eU.subactions.call(this)}else{if(br.isArray(eU.subactions)){T.subactions=(function(){var e0,eY,eZ,eX;eZ=eU.subactions;eX=[];for(e0=0,eY=eZ.length;e0<eY;e0++){eW=eZ[e0];eX.push(this.get_action_by_name(eW))}return eX}).call(this)}else{if(eU.subactions){cw(0,"subactions must be a function or an array of actions")}}}return T},_set_files:function(eT){var T;this._files=$A(eT);this._log_extras={};if(this.get_files().length>0){T=eT.first();this._log_extras={path:T.fq_path,ns_id:T.ns_id};return this._firefly_log_values={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:bW.firefly_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view"}}},_get_actions_single:function(e8){var eY,e1,e2,e5,eU,eV,fa,eZ,e4,eW,eX,e6,e7,e3,T,e9,e0,eT;e1=[];if(!e8){return[]}e5=cf.public_folder_enabled&&e8.fq_path.toLowerCase().startsWith("/public/");e4=cf.public_folder_enabled&&e8.fq_path.toLowerCase()==="/public";fa=e8.target_ns;e2=e8.ns_id!==Constants.root_ns;eX=e8.type===bU.SHARED_FOLDER;eW=e8.type===bU.SANDBOX;eZ=e8.type===bU.PACKAGE;eV=e8.in_root_coll;if(e8.is_deleted){e1=e1.concat(["restore"]);e1.push("purge");if(!e8.dir){e1.push("revisions")}}else{e3=(__CONDITIONAL_JS__.UnityFeatures!=null)&&((e0=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?e0.is_cached_and_locally_available(e8.ns_id,e8.ns_path):void 0);e6=e3?"open":"download";if(e8.dir){if(eW){e1.push("app_info")}else{if(cf.simple_sharing_enabled){e1.push("share_folder_and_token")}else{if(eX){e1.push("sharing_options")}else{if(!(e2||fa||e5||e4)){e1.push("share")}}}}if(e8.is_shmodelable()&&!cf.simple_sharing_enabled){e1.push("token_share")}e1.push(e6);if(!e4){e1=e1.concat(["delete","rename","move"]);if(!(eZ||fa)){e1.push("copy")}}if(cf.can_use_photos_features){if(cf.can_use_photos_features){e1.push("album_from_folder")}}}else{if(e8.is_shmodelable()){e1.push("token_share")}if(e5||cf.public_app_token){e1.push("copy_url")}e1.push(e6);e1=e1.concat(["delete","rename","move","copy","revisions"]);if(eV&&cf.can_jump_to_photo){e1.push("view_in_photos")}}if(cf.sharing_growth_experiments_variant&&cf.sharing_growth_experiments_variant==="DROPDOWN"&&!cf.simple_sharing_enabled){e7=false;eT=["sharing_options","share","token_share"];for(T=0,e9=eT.length;T<e9;T++){eY=eT[T];eU=e1.indexOf(eY);if(eU>-1){e1.splice(eU,1);e7=true}}if(e8.is_shared_folder()||e8.could_be_shared_folder()){e1.unshift("single_entry_share_dropdown_variant_menu")}else{e1.unshift("single_entry_share_dropdown_variant_token_share_only")}}}return e1},_get_actions_multi:function(eU){var T,eT,eV;if(Constants.send_a_copy_enabled){T=["send_copy","download"]}else{T=["download"]}T=T.concat(["delete","move","copy","restore","purge","view_in_photos"]);eT=aW.profile_files(eU);if(eT.deleted>0||eT.public_folder>0){T.removeItem("move");T.removeItem("copy");T.removeItem("delete")}if(eT.shared_folders>0){T.removeItem("copy")}if(eT.deleted>0){T.removeItem("send_copy");T.removeItem("delete");T.removeItem("download")}if(!cf.inside_dir){T.removeItem("download")}if(!(eT.deleted===eU.length&&(eT.shared_folders===0||((eT.shared_folders===(eV=eU.length)&&eV===1))))){T.removeItem("restore");if(eT.deleted!==eU.length){T.removeItem("purge")}}if(eT.in_root_coll!==eU.length||!cf.can_use_jump_to_photo){T.removeItem("view_in_photos")}return T},_show_appropriate_sharing_modals:function(eT,T){var eU;if(cf.simple_sharing_enabled&&eT.dir){if(dK.get_for_user(cf.active_user).verified_or_show()){ek.createAndShowInbandModalFromBrowseFile(cf.active_user,eT)}return}if(eT.is_shared_folder()){a0.ShmodelUILogger.log_with_target_file("sf_options",T,eT);return p.show_shared_folder_options_modal(eT.fq_path,cf.active_user)}else{if(eT.could_be_shared_folder()){a0.ShmodelUILogger.log_with_target_file("sf_invite",T,eT);return p.show_share_existing_modal(eT.fq_path,cf.active_user)}else{a0.ShmodelUILogger.log_with_target_file("token_share",T,eT);eU=eT.fq_path;cw(eU,"token_share: expected non-root fq_path");return dc.shmodel(eU,T+"_token_share")}}},get_disabled_action_names:function(){var T,eU,eW,eT,eV;T=false;eV=this.get_files();for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];T=true;if(!eU.read_only){T=false;break}}if(cf.inside_read_only_shared_folder||T){return["move","rename","delete","restore","purge","upload","new_folder"]}else{return[]}},show_disabled_action_warning:function(T){if(cf.inside_read_only_shared_folder){if(T==="move"){return ab.warning(ef("You don't have permission to move files in this folder."))}else{if(T==="rename"){return ab.warning(ef("You don't have permission to rename files in this folder."))}else{if(T==="delete"){return ab.warning(ef("You don't have permission to delete files in this folder."))}else{if(T==="restore"){return ab.warning(ef("You don't have permission to restore files in this folder."))}else{if(T==="purge"){return ab.warning(ef("You don't have permission to permanently delete files in this folder."))}else{if(T==="upload"){return ab.warning(ef("You don't have permission to upload files into this folder."))}else{if(T==="new_folder"){return ab.warning(ef("You don't have permission to create a new folder in this folder."))}else{return ab.warning(ef("You only have permission to view this folder."))}}}}}}}}else{return ab.warning(ef("You do not have permission to perform the requested action."))}}});Object.extend(a,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(eT){var T,eU;eM.show(aW.append_ellipsis(ef("Copy public link")),c9.fromElm("copy-public-url"),{wit_group:"copy_public_link"});eM.onHide=function(){$("flash_copy_container").remove();delete eM.onHide;return eM.hide()};T=q.clipboard_overlay(eT,br("#real_copy"),function(){ab.success(ef("Link copied to clipboard!"));return eM.hide()});T.css({zIndex:1001});eU=$("modal-content").down("#public_url");cw(eU,"Text element not found for copy pulic link");eU.setValue(eT);return eU.select()},shortenPublicLink:function(){var T;dL.shorten_url($F("public_url"),a.updatePublicLink);T=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif",className:"right"});return $("modal-content").down("a").__date(T)},updatePublicLink:function(eT){var T;$("public_url").setValue(eT);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();T=q.clipboard_overlay(eT,br("#real_copy"),function(){ab.success(ef("Link copied to clipboard!"));return eM.hide()});return T.css({zIndex:1001})},option_dict:{new_folder:{icon:"folder_add",text:ef("New folder"),click_handler:function(T){return cf.new_folder()}},global_restore:{icon:"restore",text:function(){cw(cf.inside_deleted_dir,"Global restore from not a deleted dir");if(cf.inside_deleted_shared_folder){return aW.append_ellipsis(ef("Rejoin shared folder"))}else{if(cf.inside_deleted_sandbox){return ef("Restore app folder")}else{return ef("Restore folder")}}},click_handler:function(){var eV,eW,eT,T,eU;eV=cf.containing_fq_path();eT=eV.toLowerCase();if(cf.inside_deleted_sandbox){cw(cf.old_path_to_ns_id[eT],"Deleted sandbox missing nsid");return a6.restore_sandbox(cf.active_user,eV,cf.old_path_to_ns_id[eT])}else{if(cf.inside_deleted_shared_folder){cw(cf.old_path_to_ns_id[eT],"Deleted shared folder missing nsid");return p.show_rejoin_modal(cf.active_user,eV,cf.old_path_to_ns_id[eT])}else{eW=D.parse(location.href).setFragment("").toString();T={prev:eW};T[Constants.UID_PARAM_NAME]=cf.active_user;eU=D({path:"/restore"+eV}).updateQuery(T);return window.location.href=String(eU)}}}},restore:{icon:"restore",text:function(){var eT,T;eT=this.get_files();T=aW.profile_files(eT);if(T.shared_folders===eT.length){return aW.append_ellipsis(a1("Rejoin shared folder","Rejoin shared folders",eT.length,{comment:"BUTTON"}))}else{return aW.append_ellipsis(ef("Restore",{comment:"Restore a previously-deleted file"}))}},click_handler:function(){var eU,eX,eT,eY,eW,T,eV;eX=this.get_files();if(eX.length===0){}else{if(eX.length===1){eU=eX.first();if(!eU.is_deleted){return}eY=eU.fq_path;eT=eY.toLowerCase();if(eU.type===bU.SANDBOX){cw(cf.old_path_to_ns_id[eT],"Restore missing ns");a6.restore_sandbox(cf.active_user,eY,cf.old_path_to_ns_id[eT])}else{if(eU.type===bU.SHARED_FOLDER){cw(cf.old_path_to_ns_id[eT],"Rejoin missing ns");p.show_rejoin_modal(cf.active_user,eY,cf.old_path_to_ns_id[eT])}else{if(eU.dir){eW=D.parse(location.href).updateQuery({select:eU.filename});T={prev:String(eW)};T[Constants.UID_PARAM_NAME]=cf.active_user;eV=D({path:"/restore"+eU.fq_path}).updateQuery(T);window.location=String(eV)}else{di.show_undelete(eU)}}}}else{return di.show_bulk_restore(eX,cf.active_user)}}}},global_share:{icon:function(){return aW.get_shared_folder_icon()},text:function(){if(cf.inside_shared_folder){return aW.append_ellipsis(ef("Shared folder options",{comment:"BUTTON. please keep this as short as possible."}))}else{if(cf.containing_fq_path()===""){return aW.append_ellipsis(ef("Share a folder",{comment:"BUTTON. this initiates a wizard that lets the user select a folder to share."}))}else{return aW.append_ellipsis(ef("Share this folder",{comment:"BUTTON. this button lets the user share the current folder that they're viewing."}))}}},click_handler:function(eU){var eT,T;eU.preventDefault();if(cf.containing_fq_path()===""){return p.start_wizard_for_user(cf.active_user)}else{if(cf.simple_sharing_enabled){eT=cf.inside_shared_folder&&!cf.containing_ns_path();T=eT?cf.containing_ns_id():void 0;return ek.createAndShowInbandModal(cf.active_user,cf.containing_fq_path(),true,T,eT,!cf.inside_shared_folder,cf.containing_sf_perm_role())}else{if(cf.inside_shared_folder){return p.show_shared_folder_options_modal(cf.containing_mount_point(),cf.active_user)}else{return p.show_share_existing_modal(cf.containing_fq_path(),cf.active_user)}}}}},global_share_button:{icon:"rainbow_16",kind:"button",button_label:ef("Share"),text:function(){return aW.append_ellipsis(ef("Share a folder"))},click_handler:function(eT,T){eT.preventDefault();if(cf.containing_fq_path()===""){return p.start_wizard_for_user(cf.active_user)}else{if(cf.is_in_subfolder_of_shared_folder()){a0.ShmodelUILogger.log("via-single-entry-sharing-button");return dc.shmodel(cf.containing_fq_path(),T+"_global_share_button")}else{return p.show_shmodel_or_invite_modal(cf.containing_fq_path(),cf.inside_shared_folder,cf.active_user)}}}},sharing_options:{icon:function(){return aW.get_shared_folder_icon()},text:aW.append_ellipsis(ef("Shared folder options",{comment:"BUTTON"})),click_handler:function(eU,T){var eT;eT=this.get_files().first();a0.ShmodelUILogger.log_with_target_file("sf_options",T,eT);return p.show_shared_folder_options_modal(eT.fq_path,cf.active_user)}},share:{icon:function(){return aW.get_shared_folder_icon()},text:aW.append_ellipsis(ef("Invite to folder",{comment:"BUTTON"})),click_handler:function(eU,T){var eT;eT=this.get_files().first();a0.ShmodelUILogger.log_with_target_file("sf_invite",T,eT);return p.show_share_existing_modal(eT.fq_path,cf.active_user)}},share_folder_and_token:{icon:function(){return aW.get_shared_folder_icon()},text:aW.append_ellipsis(ef("Share",{comment:"BUTTON"})),click_handler:function(eU,T){var eT;eT=this.get_files().first();return this._show_appropriate_sharing_modals(eT,T)}},revisions:{icon:"s_clock",click_handler:function(){return window.location.href=di.build_revisions_uri(this.get_files().first().fq_path,cf.active_user)},text:ef("Previous versions",{comment:"BUTTON"})},token_share:{icon:function(){return aW.get_shared_link_icon()},text:aW.append_ellipsis(ef("Share link",{comment:"BUTTON"})),click_handler:function(eV,T){var eT,eU;eT=this.get_files().first();a0.ShmodelUILogger.log_with_target_file("token_share",T,eT);eU=eT.fq_path;cw(eU,"token_share: expected non-root fq_path");return dc.shmodel(eU,T+"_token_share")}},global_token_share:{icon:function(){return aW.get_shared_link_icon()},text:aW.append_ellipsis(ef("Share link",{comment:"BUTTON"})),click_handler:function(eT,T){a0.ShmodelUILogger.log("via-global-toolbar");return dc.shmodel(cf.containing_fq_path(),T+"_global_token_share")}},copy_url:{icon:"world_link",text:aW.append_ellipsis(ef("Copy public link",{comment:"BUTTON"})),click_handler:function(eU){var eT,T;eT=this.get_files().first();if(cf.public_app_token){T="/spa/"+cf.public_app_token+eT.ns_path}else{T="/u/"+cf.active_user.id+eT.fq_path.substring(a.PUBLIC_FOLDER_PATH_LENGTH)}return a.showCopyPublicUrlModal(String(new D({scheme:"https",authority:Constants.PUBSERVER,path:T})))}},download:{icon:"download",text:function(){return ef("Download",{comment:"BUTTON"})},click_handler:function(){var eV,eU,T,eY,e0,eZ,eW,eT,eX;T=this.get_files();if(T.length===1&&!T[0].dir){eU=T.first();eX=[Constants.protocol,Constants.BLOCK_CLUSTER,eU.fq_path,eU.hash],eZ=eX[0],eV=eX[1],e0=eX[2],eY=eX[3];eW={w:eY,dl:1};eT=D({scheme:eZ,authority:eV,path:"/get"+e0,query:eW});return window.location=String(eT.updateQuery(Constants.UID_PARAM_NAME,cf.active_user))}else{return di.do_bulk_download(T)}}},view:{href:function(){var eX,T,eV,eU,eW,eT;T=this.get_files().first();eT=[Constants.protocol,Constants.BLOCK_CLUSTER,dL.urlquote(T.fq_path),T.hash],eW=eT[0],eX=eT[1],eU=eT[2],eV=eT[3];return""+eW+"://"+eX+"/get"+eU+"?w="+eV},icon:"page_white_magnify",text:ef("View file",{comment:"BUTTON"})},ignore:{click_handler:function(){return p.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:ef("Permanently remove",{comment:"BUTTON"})},show_del:{click_handler:function(T){return cf.toggle_deleted()},icon:"trash-can",text:ef("Show deleted files",{comment:"BUTTON"})},hide_del:{click_handler:function(T){return cf.toggle_deleted()},icon:"trash-can-open",text:ef("Hide deleted files",{comment:"BUTTON"})},copy:{icon:"copy",text:aW.append_ellipsis(ef("Copy",{comment:"BUTTON"})),click_handler:function(eU){var T,eT;eT=this.get_files();if(eT.length===1){T=eT.first();return di.show_copy(T.fq_path,T.dir)}else{if(eT.length>1){return di.show_copy_bulk(eT)}}}},move:{icon:"move_16",text:aW.append_ellipsis(ef("Move",{comment:"BUTTON"})),click_handler:function(eU){var T,eT;eT=this.get_files();if(eT.length===1){T=eT.first();return di.show_move(T.fq_path,T.dir)}else{if(eT.length>1){return di.show_move_bulk(eT)}}}},rename:{icon:"rename",text:ef("Rename",{comment:"BUTTON"}),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:aW.append_ellipsis(ef("Delete",{comment:"BUTTON"})),click_handler:function(eU){var T,eT;eT=this.get_files();if(eT.length>1){return di.show_bulk_delete(cf.active_user,eT)}else{if(eT.length===1){T=eT.first();return di.show_delete(cf.active_user,T.fq_path,T.dir)}}}},global_purge:{icon:"cancel",text:aW.append_ellipsis(ef("Permanently delete folder")),click_handler:function(){return di.show_purge(cf.containing_fq_path(),true)}},purge:{icon:"cancel",text:aW.append_ellipsis(ef("Permanently delete",{comment:"BUTTON"})),click_handler:function(eU){var T,eT;eT=this.get_files();if(eT.length===1){T=eT.first();return di.show_purge(T.fq_path,T.dir)}else{return di.show_bulk_purge(eT)}}},upload:{icon:"upload_16",text:aW.append_ellipsis(ef("Upload")),click_handler:function(T){return di.show_upload()}},app_info:{icon:"application_double",text:aW.append_ellipsis(ef("Application info")),click_handler:function(T){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:ef("More",{comment:"Show more options"}),click_handler:Prototype.emptyFunction},more_global_actions:{text:ef("More actions"),click_handler:function(){bA.show_secondary();return document.body.observe("click",bA.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return ef("View in Photos")},click_handler:function(){var T;T=this.get_files();return di.do_bulk_photo_view(T)}},album_from_folder:{icon:"create-album",text:function(){return ef("Create album")},click_handler:function(){var eT,T;eT=this.get_files();T=eT.first();return di.create_album_from_folder(T.fq_path,T.filename)}},open:{icon:"open",text:function(){return ef("Open")},click_handler:function(){var T;T=this.get_files().first();return __CONDITIONAL_JS__.UnityFeatures.open_file(T.ns_id,T.ns_path,T.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(eT){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})}},single_entry_share_dropdown_variant_token_share_only:{icon:"s_rainbow",text:aW.append_ellipsis(ef("Share")),click_handler:function(eU,T){var eT;eT=this.get_files().first();a0.ShmodelUILogger.log_with_target_file("single_entry_share_click",T,eT);return dc.shmodel(eT.fq_path,T)}},single_entry_share_dropdown_variant_menu:{icon:"s_rainbow",text:aW.append_ellipsis(ef("Share")),is_dropdown:true,subactions:["single_entry_share_dropdown_variant_menu_invite_option","single_entry_share_dropdown_variant_menu_token_share_option"],click_handler:function(){},hover_handler:function(eU,T){var eT;eT=this.get_files().first();return a0.ShmodelUILogger.log_with_target_file("single_entry_share_hover",T,eT)}},single_entry_share_dropdown_variant_menu_invite_option:{icon:"user_add",text:aW.append_ellipsis(ef("Invite people to collaborate")),click_handler:function(eX,T){var eU,eV,eW,eT;eU=this.get_files().first();if(eU.is_shared_folder()){if(dK.get_for_user(cf.active_user).verified_or_show()){a0.ShmodelUILogger.log_with_target_file("sf_options",T,eU);eV=new cX(cf.active_user,eU.fq_path);return eV.show()}}else{eT=cf.verify_email_after_share_experiment_variant;eW=eT&&eT==="VERIFY_LAST";if(eW){a0.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(eT){a0.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(eW||dK.get_for_user(cf.active_user).verified_or_show()){a0.ShmodelUILogger.log_with_target_file("sf_invite",T,eU);eV=new cb(cf.active_user,{folder_name:eU.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+cf.active_user.id,must_check_verified:eW});return eV.show()}}}},single_entry_share_dropdown_variant_menu_token_share_option:{icon:"s_link",text:aW.append_ellipsis(ef("Send link")),click_handler:function(eU,T){var eT;eT=this.get_files().first();a0.ShmodelUILogger.log_with_target_file("token_share",T,eT);return dc.shmodel(eT.fq_path,T)}}}});ae=B.BrowseActionsContext=Class.create(a,{initialize:function($super,T){$super(T);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");br("#context-menu-container").off("mouseenter");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));br("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));br("#context-menu-container").on("mouseout","li.primary",this._out.bind(this));return br("#context-menu-container").on("mouseenter",".action button",this._enter.bind(this))},_click:function(eV,eT){var eU,T;eU=eT.readAttribute("data-value");this.firefly_logging_helper(eU);T=a.option_dict[eU];a0.BrowseActionsContextMenuLogger.log(this.get_files(),eU);if(!T.is_dropdown||eT.hasAttribute("submenu-index")){bc.hide()}eV.preventDefault();T.click_handler.call(this,eV,"browse_actions_context");if(eU==="sharing_options"){a0.SharedFolderActivityLogger.log("web","browse_view_options",cf.active_user,this._log_extra,true)}if(eU==="share"){return a0.SharedFolderActivityLogger.log("web","browse_view_share_existing",cf.active_user,this._log_extras,true)}},_reset_all_submenus:function(){return br("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(T){return br(T).removeClass("hover")},_enter:function(eV){var eU,T,eT;eU=br(eV.currentTarget).data("value");cw(eU);T=a.option_dict[eU];cw(T,"Action info is missing for "+eU);return(eT=T.hover_handler)!=null?eT.call(this,eV,"browse_actions_context"):void 0},_over:function(T){if(br(T.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return br(T.currentTarget).addClass("hover")}},_out:function(T){if(br(T.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout((function(eT){return function(){return eT._reset_submenu(T.currentTarget)}})(this),300)}}});el=B.BrowseActionsBasic=Class.create(a,{initialize:function($super){var T;T=eA.get_selected_files();$super(T);this._render();return this._listen()},_listen:function(){var T;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(eA.UPDATED_EVT,this.bound_update);document.observe(bc.SHOW_EVT,this.bound_disable);document.observe(bc.HIDE_EVT,this.bound_enable);T=$("browse-root-actions");T.stopObserving("click");return T.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(eA.UPDATED_EVT,this.bound_update);document.stopObserving(bc.SHOW_EVT,this.bound_disable);document.stopObserving(bc.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(eA.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(eU){var eT,T;T="#browse-root-actions #"+eU+"_action_button";eT=br(T);eT.addClass("disabled");return eT.click((function(eV){return function(eW){eV.show_disabled_action_warning(eU);return false}})(this))},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var fj,fc,fe,e4,fg,fk,fm,fb,fd,e7,T,e0,e1,e3,e2,ff,eZ,fn,e9,eX,e6,e5,e8,fa,eY,eW,eU,eT,fh,fl,fi,eV;e0=this.get_files();fe=this.get_action_names();if(cf.sharing_growth_experiments_variant&&cf.sharing_growth_experiments_variant==="DROPDOWN"&&!cf.simple_sharing_enabled){e5=["single_entry_share_dropdown_variant_token_share_only","single_entry_share_dropdown_variant_menu"];for(eW=0,fh=e5.length;eW<fh;eW++){fc=e5[eW];e2=fe.indexOf(fc);if(e2>-1){fe.splice(e2,1);break}}}fj=13.5;fd="";e1="";if(e0.length===1){fd=bG.em_snippet(e0[0].filename,fj);if(!e0[0].dir&&e0[0].bytes>=0){e1=e0[0].size}}else{if(1<e0.length){eX=aW.profile_files(e0);ff=[];if(eX.files){eZ=a1("%d file","%d files",eX.files).format(eX.files);ff.push(eZ)}if(eX.folders){eZ=a1("%d folder","%d folders",eX.folders).format(eX.folders);ff.push(eZ)}fd=dL.nice_list(ff)}}fk=$("browse-root-actions");fg=fk.getLayout().get("width");e3=fk.getStyle("font-size");cw(e3.endsWith("px"),"Invalid font size "+e3);e3=parseInt(e3,10);e7=new bG(fd).length*e3;e8=new bG(e1).length*e3;fg-=e7+e8;fa=[];e6=[];fg-=30;for(eU=0,fl=fe.length;eU<fl;eU++){fn=fe[eU];fc=this.get_action_by_name(fn);eY=new bG(fc.text).length*e3;fm=eY+16+8+10+9;if(fg>fm){fa.push(fn)}else{if(e6.length===0){e9=fa.pop();e6.push(e9)}e6.push(fn)}fg-=fm}if(e6.length){fa.push("more_actions")}e4=(function(){var fq,fo,fp;fp=[];for(fq=0,fo=fa.length;fq<fo;fq++){fn=fa[fq];fp.push(this.get_action_by_name(fn))}return fp}).call(this);if(e6.length){e4[e4.length-1].subactions=(function(){var fq,fo,fp;fp=[];for(fq=0,fo=e6.length;fq<fo;fq++){fn=e6[fq];fp.push(this.get_action_by_name(fn))}return fp}).call(this)}fb=eP.tmpl("actions_bar_tmpl",{context:this,description:fd,filesize:e1,has_actions:!!fe.length,actions:e4,_:ef,Sprite:cj});$("browse-root-actions").__date(fb);T=this.get_disabled_action_names();eV=[];for(eT=0,fi=T.length;eT<fi;eT++){fc=T[eT];eV.push(this._disable_action(fc))}return eV},_click:function(eV,eT){var eU,T;eU=eT.readAttribute("data-value");cw(eU);this.firefly_logging_helper(eU);T=a.option_dict[eU];cw(T,"Action info is missing for "+eU);eV.preventDefault();T.click_handler.call(this,eV,"browse_actions_basic");if(eU==="sharing_options"){a0.SharedFolderActivityLogger.log("web","browse_view_select_folder_options",cf.active_user,this._log_extras,true)}if(eU==="share"){return a0.SharedFolderActivityLogger.log("web","browse_view_select_share_existing",cf.active_user,this._log_extras,true)}}});Object.extend(el,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos"]});eK=B.GlobalActions=Class.create(a,{initialize:function($super){return $super()},get_action_names:function(){var T;if(!cf.inside_dir){return[]}T=[];if(!cf.inside_deleted_dir){T=T.concat(["upload","new_folder"]);if(this._should_show_shared_folder_options()){T.push("global_share")}if(this._should_show_share_link()){T.push("global_token_share")}if(this._should_show_single_entry_share()){T.push("global_share_button")}if(!Constants.can_see_trash){T.push((cf.deleted_shown?"hide_del":"show_del"))}}else{T=T.concat(["global_restore"])}return T},_should_show_shared_folder_options:function(){return !cf.is_in_subfolder_of_shared_folder()&&!cf.inside_sandbox&&!this._should_show_single_entry_share()},_should_show_share_link:function(){return cf.is_shmodelable_path(cf.containing_fq_path())&&!this._should_show_single_entry_share()},_should_show_single_entry_share:function(){return cf.single_share_entry_point&&cf.containing_fq_path()!==""}});bA=B.GlobalActionsBasic=Class.create(eK,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(bc.SHOW_EVT,this._disable.bind(this));return document.observe(bc.HIDE_EVT,this._enable.bind(this))},_render:function(){var eV,eX,eZ,e2,e4,T,eT,eY,e1,e0,eW,e3,eU;eX=this.get_action_names();e0=eX.intersect(bA.STANDARD_ACTIONS);eY=eX.without.apply(eX,bA.STANDARD_ACTIONS);if(eY.length===1){e0=eX;eY=[]}if(eY.length){e0.push("more_global_actions")}e1=(function(){var e7,e6,e5;e5=[];for(e7=0,e6=e0.length;e7<e6;e7++){T=e0[e7];e5.push(this.get_action_by_name(T))}return e5}).call(this);eZ=(function(){var e7,e6,e5;e5=[];for(e7=0,e6=e1.length;e7<e6;e7++){eV=e1[e7];if(eV.kind==="button"){e5.push(eV)}}return e5})();eT=(function(){var e7,e6,e5;e5=[];for(e7=0,e6=e1.length;e7<e6;e7++){eV=e1[e7];if(eV.kind!=="button"){e5.push(eV)}}return e5})();e2=eP.tmpl("global_actions_tmpl",{context:this,standard_actions:eZ.concat(eT),secondary_actions:(function(){var e7,e6,e5;e5=[];for(e7=0,e6=eY.length;e7<e6;e7++){T=eY[e7];e5.push(this.get_action_by_name(T))}return e5}).call(this),Sprite:cj});$("global-actions").__date(e2);br(document).trigger("db:browse:ga_rendered");e4=this.get_disabled_action_names();eU=[];for(eW=0,e3=e4.length;eW<e3;eW++){eV=e4[eW];eU.push(this._disable_action(eV))}return eU},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(eU){var eT,T;T="#global-actions #"+eU+"_button";eT=br(T);eT.addClass("disabled");return eT.click((function(eV){return function(eW){eV.show_disabled_action_warning(eU);return false}})(this))},_enable:function(){var eV,eW,eU,eT,T;$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");$$("#global-actions .action a").invoke("addClassName","title_bubble");eW=this.get_disabled_action_names();T=[];for(eU=0,eT=eW.length;eU<eT;eU++){eV=eW[eU];T.push(this._disable_action(eV))}return T},_click:function(eV,eT){var eU,T;eU=eT.readAttribute("data-value");cw(eU);T=a.option_dict[eU];cw(T,"Action info is missing for "+eU);bA.hide_secondary();eA.deselect_all();eV.preventDefault();T.click_handler.call(this,eV,"global_actions_basic");if(eU==="global_share"){if(this._log_extras.path===""){return a0.SharedFolderActivityLogger.log("web","browse_view_share_button",cf.active_user,this._log_extras,true)}else{return a0.SharedFolderActivityLogger.log("web","folder_view_share_button",cf.active_user,this._log_extras,true)}}}});Object.extend(bA,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge","global_share_button"],show_secondary:function(){var T,eT;eT=$("secondary-actions");T=$("more_global_actions_button");eT.show();return T.addClassName("down")},hide_secondary:function(){var T,eT;eT=$("secondary-actions");if(!eT){return}T=$("more_global_actions_button");eT.hide();return T.removeClassName("down")}});dm=B.GlobalActionsContext=Class.create(eK,{initialize:function($super,T){$super(T);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(eV,eT){var eU,T;eU=eT.readAttribute("data-value");this.firefly_logging_helper(eU);T=a.option_dict[eU];eA.deselect_all();if(!T.is_dropdown){bc.hide()}eV.preventDefault();T.click_handler.call(this,eV,"global_actions_context");if(eU==="global_share"){if(this._log_extras.path===""){return a0.SharedFolderActivityLogger.log("web","browse_view_right_click_share",cf.active_user,this._log_extras,true)}else{if(cf.inside_shared_folder){return a0.SharedFolderActivityLogger.log("web","folder_view_right_click_options",cf.active_user,this._log_extras,true)}else{return a0.SharedFolderActivityLogger.log("web","folder_view_right_click_share",cf.active_user,this._log_extras,true)}}}}});var w;w=B.BrowseClipboard=(function(){var e0,eX,eU,eY,eW,e2,e4,eZ,eT,T,e1,eV,e3;e0=0;eX=1;eW=[];eU=null;e3=function(){var e7,e9,e6,fa,e8,e5;if(z.focus_in_input()){return}e6=eA.get_selected_files();if(e6&&e6.length){for(e8=0,e5=e6.length;e8<e5;e8++){e9=e6[e8];if(e9.bytes<0){ab.error(ef("Deleted files cannot be added to the clipboard"));return false}else{if(e9.target_ns){fa=ef("'%(filename)s' cannot be added to the clipboard");fa=fa.format({filename:e9.filename});ab.error(fa);return false}}}eW=e6;e7=e6.length;fa=a1("Added %d item to clipboard","Added %d items to clipboard",e7).format(e7);ab.success(fa);return true}};e2=function(){if(e3()){eU=e0;return false}};e4=function(){if(e3()){eU=eX;return false}};eZ=function(e5){var e6;cw(typeof e5!=="undefined","BrowseClipboard _paste got an undefined path");if(eW.length){e6=eU===e0?di.do_bulk_copy:di.do_bulk_move;e6(eW,e5);return true}};eV=function(e5){var e6;if(z.focus_in_input()||cf.in_search_mode()||cf.inside_deleted_dir){return}e6=eZ(cf.containing_fq_path());if(e6){return false}};eY=function(){return eW=[]};T=function(fc){var fb,e7,e9,fa,e8,e6,e5;e9=fc.memo.files;for(fa=0,e6=e9.length;fa<e6;fa++){e7=e9[fa];for(e8=0,e5=eW.length;e8<e5;e8++){fb=eW[e8];if(fb.fq_path===e7.fq_path||fb.fq_path.startsWith(e7.fq_path+"/")){eY();return}}}};eT=function(e5){cw((e5.memo.file!=null)&&(e5.memo.files==null));e5.memo.files=[e5.memo.file];return T(e5)};e1=function(){var e9,e5,e8,e6,e7;document.observe(aB.RENAME,eT);e7=[aB.DELETE,aB.MOVE];for(e8=0,e6=e7.length;e8<e6;e8++){e9=e7[e8];document.observe(e9,T)}e5=key.main_modifier();key(""+e5+"+c",cf.KEY_SCOPE,e2);key(""+e5+"+x",cf.KEY_SCOPE,e4);return key(""+e5+"+v",cf.KEY_SCOPE,eV)};return{init:function(){return e1()}}})();var eA,aQ,ay;eA=B.BrowseSelection=(function(){var eW,eY,ff,e4,fi,T,fb,e3,fq,e8,fc,eZ,e5,fd,fn,fm,e0,e6,eV,fe,e9,fg,fo,eX,fj,fh,fp,e2,fl,fk,fa,fs,eU,e7,e1,eT,fr;fk=[];e4=null;e8=null;e3=null;T=[];e1=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");eA.get_selected_files().invoke("get_div").findAll(function(ft){return ft}).invoke("addClassName","file-select");if(eA.get_selected_files().length===1){return eA.get_selected_files().invoke("get_div").invoke("addClassName","file-select-one")}};eT=function(){if(e3){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);if(cf.in_search_mode()&&bW.sparky_search_ui_enabled){return}return eA.get_selected_files().filter(function(ft){return !ft.editing}).invoke("get_div").findAll(function(ft){return ft}).invoke("writeAttribute","draggable","true")};fr=function(ft){ft.apply(null,$A(arguments).slice(1));return document.fire(eA.UPDATED_EVT)};fa=function(fv,fu){var fw,ft;ft=fk.length;fk=(fv instanceof cD?[fv]:$A(fv));if(fk.length!==ft){em("Selected",fk.length,"files")}fw=fu||fk.last();cw(!fw||fw instanceof cD,"Invalid anchor type"+fw);return e4=fw};fa=fa.wrap(fr);eW=function(fu,ft){if(fu){fk.push(fu)}return e4=ft||fu};eW=eW.wrap(fr);fj=function(ft){var fu;fu=fk.indexOf(ft);if(fu===-1){return}return fk.splice(fu,1)};fj=fj.wrap(fr);fh=function(){return fk=[]};fh=fh.wrap(fr);fs=function(ft){T=ft;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return ft.invoke("get_div").findAll(function(fu){return fu}).invoke("addClassName","context-select")};e6=function(fC){var fz,fx,fw,fy,fF,fv,fE,fG,ft,fB,fD,fA,fu;fA=$(fC.target);fG=fA.match("li.browse-file")?fA:fA.up("li.browse-file");fz=fA.match("a")?fA:fA.up("a");fw=cD.from_elem(fG);if(fC.isRightClick()||!fG||fz||fG.hasClassName("unselectable")){return}cf.keyboard_nav=false;if(T.length){return}fv=dL.is_mac();if((fv&&fC.metaKey)||(!fv&&fC.ctrlKey)){if(fk.indexOf(fw)===-1){return eW(fw)}else{return fj(fw)}}else{if(fC.shiftKey){fx=cf.files.indexOf(e4);fu=cf.files.indexOf(fw);fE=cf.files.indexOf(fk.last());fB=fk.slice(0);fF=fE<fx?-1:1;fy=fx;while(fy!==fE){fy+=fF;fD=fB.indexOf(cf.files[fy]);if(fD!==-1){fB.splice(fD,1)}}fF=fu<fx?-1:1;fy=fx;while(fy!==fu){fy+=fF;ft=fB.indexOf(cf.files[fy]);if(ft!==-1){fB.splice(ft,1)}fB.push(cf.files[fy])}return fa(fB,e4)}else{return fa(fw)}}};eV=function(fy){var fC,fv,fB,fz,fu,ft,fx,fw,fA;if(fy.isRightClick()||T.length||dL.in_scrollbar(fy.pointerX())){return}fz=$(fy.target);if(Element.match(fz,"object")){fz=fz.parentNode}fx=["browse-box","context-menu-container","modal","modal-overlay"];fu=false;for(fw=0,fA=fx.length;fw<fA;fw++){ft=fx[fw];if(fz.descendantOf(ft)||fz.match("#"+ft)){fu=true;break}}if(!fu){fa();return}fB=fz.match("li.browse-file")?fz:fz.up("li.browse-file");fv=cD.from_elem(fB);fC=fz.match("[draggable]")||fz.up("[draggable]");if(fv&&!fC){e8=e4;if(!fy.shiftKey){if(fv){e8=fv}else{if(fz.match("#browse-files")){e8=cf.files.last()}}}e3=[];if(fy.metaKey||fy.ctrlKey){return e3=eA.get_selected_files()}}};eU=function(fv){var fu,ft;fu=cD.from_elem(fm(fv));fv.preventDefault();if(!fu){return}ft="browse_file_row";a0.ShmodelUILogger.log_with_target_file("token_share",ft,fu);return dc.shmodel(fu.fq_path,ft)};fm=function(fu){var ft;ft=$(fu.target);if(ft.match("li.browse-file")){return ft}else{return ft.up("li.browse-file")}};fn=(function(ft){return function(fC){var fv,fu,fw,fF,fE,fA,fD,fB,fy,fz,fx;fD=cf.sharing_growth_experiments_variant&&cf.sharing_growth_experiments_variant==="DROPDOWN";fB=cf.sharing_single_file_collaboration&&cf.sharing_single_file_collaboration==="SINGLE_FILE_SHARING";fF=fm(fC);fv=cD.from_elem(fF);fC.preventDefault();if(!(fv&&fD)){return}fE="browse_file_row";fz=a0.ShmodelUILogger.get_target_item(fv);a0.ShmodelUILogger.log("single_entry_share",fE,fz);fw=cf.simple_sharing_enabled;fA=br(fF).find(".inline-share-button")[0];if(cf.show_shared_with&&!cf.show_inline_share&&!cf.in_search_mode()){fA=br(fF).find(".sharing .inline-share-button")[0]}fy=fv.dir&&(fv.is_shared_folder()||fv.could_be_shared_folder());if(fy){if(fw){if(dK.get_for_user(cf.active_user).verified_or_show()){return ek.createAndShowInbandModalFromBrowseFile(cf.active_user,fv)}}else{return ay.open(fv.fq_path,fv.is_shared_folder(),fA,cf.active_user,fz)}}else{if(cf.simple_sharing_to_file_enabled&&((fx=__CONDITIONAL_JS__.OpenWith)!=null?fx.file_supported(fv):void 0)){if(dK.get_for_user(cf.active_user).verified_or_show()){return ek.createAndShowInbandModalFromBrowseFile(cf.active_user,fv)}}else{if(fB&&(fv.is_shared_single_file()||fv.could_be_shared_single_file())&&!fw){return ay.open(fv.fq_path,fv.is_shared_single_file(),fA,cf.active_user,fz,fu=true,fv.mount_point)}else{eA.firefly_logging_helper(fv,"single_entry_share_button_file_link");return dc.shmodel(fv.fq_path,fE)}}}}})(this);eX=(function(ft){return function(fw){var fv,fu;fu=fm(fw);fv=cD.from_elem(fu);return aQ.recipients_click(fv,cf.active_user)}})(this);e0=(function(ft){return function(fw){var fv,fu;fu=fm(fw);fv=cD.from_elem(fu);return aQ.link_click(fv,cf.active_user)}})(this);fi=function(fw){var fu,ft,fv;fv=$(fw.target);ft=fv.match("li.browse-file")?fv:fv.up("li.browse-file");fu=cD.from_elem(ft);if(fu){return e6(fw)}};fd=null;fc=function(){var ft;clearInterval(fd);ft=function(){cf.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return fd=setTimeout(ft,100)};fb=function(){if(!cf.keyboard_nav){cf.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};fe=function(fz){var fw,fv,fu,fy,fB,ft,fx,fA;fc();if(!eA.is_selecting()){return}fw=cf.files.indexOf(e8);ft=cf.files.indexOf(cD.from_elem(fz.target));cw(fw<cf.files.length&&fw>=0,"anchor_index: "+fw+" "+e8);cw(ft<cf.files.length&&ft>=0,"target_index: "+ft);fv=cf.files.slice(Math.min(fw,ft),Math.max(fw,ft)+1);fu=e3.slice(0);for(fx=0,fA=fv.length;fx<fA;fx++){fB=fv[fx];fy=fu.indexOf(fB);if(fy===-1){fu.push(fB)}else{fu.splice(fy,1)}}return fa(fu)};fq=function(ft){e8=null;return e3=null};fo=function(fv){var ft,fu;if(typeof L!=="undefined"&&L!==null){L.reset()}fb();if(fv){Event.extend(fv).preventDefault()}fu=fk.length?fk.last()===cf.files.first()?cf.files.first():(ft=cf.files.indexOf(fk.last())-1,cf.files[ft]):cf.files.last();fa(fu);if(fu){return cf.scrollTo(fu.get_div())}};e9=function(fv){var ft,fu;if(typeof L!=="undefined"&&L!==null){L.reset()}fb();if(fv){Event.extend(fv).preventDefault()}fu=fk.length?fk.last()===cf.files.last()?cf.files.last():(ft=cf.files.indexOf(fk.last())+1,cf.files[ft]):cf.files.first();fa(fu);if(fu){return cf.scrollTo(fu.get_div())}};ff=function(fB){var ft,fu,fz,fA,fw,fx,fy,fv;if(typeof L!=="undefined"&&L!==null){L.reset()}fb();if(fB){Event.extend(fB).preventDefault()}if(fk.length>0){fA=cf.files.indexOf(fk.last());ft=cf.files.indexOf(e4);if(e4===fk.last()||ft>fA){if(fA>0){fv=[];for(fz=fx=fy=fA-1;fy<=0?fx<=0:fx>=0;fz=fy<=0?++fx:--fx){fu=cf.files[fz];fw=fk.indexOf(fu);eW(fu,e4);if(fw!==-1){fv.push(fk.splice(fw,1))}else{cf.scrollTo(fu.get_div());break}}return fv}}else{fj(fk.last());return cf.scrollTo(fk.last().get_div())}}else{return fo()}};eY=function(fC){var ft,fu,fA,fB,fx,fy,fz,fw,fv;if(typeof L!=="undefined"&&L!==null){L.reset()}fb();if(fC){Event.extend(fC).preventDefault()}if(fk.length>0){fB=cf.files.indexOf(fk.last());ft=cf.files.indexOf(e4);if(e4===fk.last()||ft<fB){fv=[];for(fA=fy=fz=fB+1,fw=cf.files.length;fz<=fw?fy<fw:fy>fw;fA=fz<=fw?++fy:--fy){fu=cf.files[fA];fx=fk.indexOf(fu);eW(fu,e4);if(fx!==-1){fv.push(fk.splice(fx,1))}else{cf.scrollTo(fu.get_div());break}}return fv}else{fj(fk.last());return cf.scrollTo(fk.last().get_div())}}else{return e9()}};fp=function(){if(typeof L!=="undefined"&&L!==null){L.reset()}fa(cf.files);return false};fl=function(){if(typeof L!=="undefined"&&L!==null){L.reset()}return fa(null,null,null)};e2=function(ft){return fa(cf.find_file(ft.memo.fq_path))};e5=function(){$$(".file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");return setTimeout(e1,100)};fg=function(ft){return ft.memo.files.each(function(fu){var fv;fv=fk.indexOf(fu[0]);if(fv!==-1){fk.splice(fv,1);return eW(fu[1])}})};eZ=function(ft,fu){var fv;if(cf.in_search_mode()&&ft&&fu){fv={file_nsid:ft.ns_id,file_sjid:ft.file_sjid,firefly:bW.firefly_enabled,match_type:ft.match_type,position:ft.sort_rank,request_id:ft.request_id,viewport:"full-view",action_type:fu};return a0.SearchClientActivityLogger.log("result_action",cf.active_user.id,fv)}};e7=function(fu,ft,fv,fx,fB){var fA,fz,fy,fw;fz="file_row_sharing_menu";if(ft){if(dK.get_for_user(fu).verified_or_show()){a0.ShmodelUILogger.log("sf_options",fz,fv);eZ("single_entry_share_button_folder_options");fA=new cX(fu,fx);if(typeof fB==="function"){fB()}return fA.show()}}else{fw=cf.verify_email_after_share_experiment_variant;fy=fw&&fw==="VERIFY_LAST";if(fy){a0.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(fw){a0.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fy||dK.get_for_user(fu).verified_or_show()){a0.ShmodelUILogger.log("sf_invite",fz,fv);eZ("single_entry_share_button_folder_invite");fA=new cb(fu,{folder_name:fx,element_id:"invite-to-new-sf-wizard-modal-"+fu.id,must_check_verified:fy});if(typeof fB==="function"){fB()}return fA.show()}}};document.observe(bq.REMOVE,function(ft){return ft.memo.files.each(fj)});document.observe(bq.MOVE,fg);return{UPDATED_EVT:"db:select:updated",LIGHTBOX_EXIT_SELECT_EVT:"db:filepreview:exitselect",init:function(){var ft;document.observe("click",fi);document.observe("mousedown",eV);document.observe("mouseup",fq);document.observe("dragend",fq);document.observe("mouseup",eT);$("browse-files").on("mouseover","li.browse-file",fe);$("browse-files").on("click",".shmodel-file",eU);$("browse-files").on("click",".inline-share-button",fn);$("browse-files").on("click",".more-link",fn);document.observe(eA.UPDATED_EVT,e1);document.observe(eA.UPDATED_EVT,eT);document.observe(cf.RENDER_EVT,e1);document.observe(cf.RENDER_EVT,eT);document.observe(cf.UPDATE_EVT,fa.bind(null,null,null));document.observe(eA.LIGHTBOX_EXIT_SELECT_EVT,e2);ft=key.main_modifier();key("up",cf.KEY_SCOPE,fo);key("down",cf.KEY_SCOPE,e9);key(ft+"+a",cf.KEY_SCOPE,fp);key("escape",cf.KEY_SCOPE,fl);key("shift+up",cf.KEY_SCOPE,ff);return key("shift+down",cf.KEY_SCOPE,eY)},set_selected_files:function(ft){return fa(ft)},get_selected_files:function(){return fk.slice(0)},get_selected_fq_paths:function(){return fk.map(function(ft){return ft.fq_path})},has_selected_files:function(){return fk.length},is_selected:function(ft){return fk.indexOf(ft)!==-1},is_selecting:function(){return !!e8},deselect_all:fh,set_context_selected:function(ft){return fs(ft)},flicker_selected:e5,firefly_logging_helper:function(ft,fu){return eZ(ft,fu)},show_share_modal_if_email_verified:e7,recipients_click:function(ft){return eX(ft)},link_click:function(ft){return e0(ft)}}})();ay=B.SharingGrowthExperimentsDropdown={open:function(eX,eU,eV,eT,eY,eZ,eW){var T;this.fq_path=eX;this.existing_sf=eU;this.button=eV;this.user=eT;this.target_item=eY;this.is_file=eZ;this.mount_point=eW;this.$menu=br("#sharing-growth-experiments-dropdown-menu");T=this.$button&&this.$button.length;if(T){if(this.$button[0]===this.button){this._hide();return}else{this._hide()}}return this._show()},_show:function(){var T;this.$menu.show();this.$button=br(this.button);this.$button.addClass("pressed");if(cf.show_inline_share){this.$button.parent(".sharing-actions").addClass("pressed")}T={offsetLeft:-1*Math.abs(this.$button.outerWidth()-this.$menu.outerWidth())+6,offsetTop:46,setWidth:false,setHeight:false};z.clone_position(this.$menu,this.$button,T);br("#browse-box").addClass("dropdown-menu-open");if(this.is_file){this._add_share_file_logging("single_file_shared_entry_button_displayed","single_file_unshared_entry_button_displayed")}return this._listen()},_listen:function(){this.$menu.on("click dblclick",function(T){return T.stopPropagation()});br(document).on("mousedown",br.proxy(this._click_outside_menu_callback,this));this.$menu.find(".option-to-share-folder").on("click",br.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").on("click",br.proxy(this._share_link_click,this))},_unlisten:function(){this.$menu.hide().off("click dblclick");br(document).off("mousedown",this._click_outside_menu_callback);this.$menu.find(".option-to-share-folder").off("click",br.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").off("click",br.proxy(this._share_link_click,this))},_add_share_file_logging:function(eU,eV){var eT,T;T={path:this.fq_path};eT=this.existing_sf?eU:eV;return a0.SharedFolderActivityLogger.log("web",eT,this.user,T)},_sf_click:function(eT){var T;if(this.is_file){if(dK.get_for_user(this.user).verified_or_show()){this._add_share_file_logging("single_file_shared_collaboration_clicked","single_file_unshared_collaboration_clicked");if(this.existing_sf){T=new dM(this.user,{folder_name:au.filename(this.mount_point),folder_path:this.mount_point,element_id:"confirm-share-existing-file-wizard-modal"})}else{T=new cb(this.user,{folder_name:this.fq_path,is_file:true,element_id:"invite-to-new-share-file-wizard-modal-"+this.user.id})}this._hide();return T.show()}}else{return eA.show_share_modal_if_email_verified(this.user,this.existing_sf,this.target_item,this.fq_path,this._hide.bind(this))}},_share_link_click:function(eT){var T;T="file_row_sharing_menu";a0.ShmodelUILogger.log("token_share",T,this.target_item);this._firefly_logging_helper("single_entry_share_button_folder_link");dc.shmodel(this.fq_path,T);if(this.is_file){this._add_share_file_logging("single_file_shared_link_clicked","single_file_unshared_link_clicked")}return this._hide()},_firefly_logging_helper:function(T){return eA.firefly_logging_helper(cf.find_file(this.fq_path),T)},_clicked:function(T,eT){return T.is(eT.target)||T.has(eT.target).length},_click_outside_menu_callback:function(T){if(!(this._clicked(this.$menu,T)||this._clicked(this.$button,T))){return this._hide()}},_hide:function(T){this._unlisten();br("#browse-box").removeClass("dropdown-menu-open");this.$button.removeClass("pressed");if(cf.show_inline_share){this.$button.parent(".sharing-actions").removeClass("pressed")}return this.$button=null}};aQ=B.SharingGrowthExperimentsAutocomplete={init:function(){return this.autocomplete=new Autocompleter.ContactsTokenizer(cf.active_user,"growth-browse-inline-new-collab-input","growth-browse-inline-new-whobulk","growth-browse-inline-hidden-input",{tokens:[",",";"],include_fb:false,include_team:false,hide_import_contacts:false,suggestions_disabled:true})},recipients_click:function(eT,T){var eU;this.file=eT;this.user=T;this.mode="recipients";this._activate();this.$sharing_actions.find(".get-link").hide();this.$sharing_actions.find(".send-button").show();eU=this._autocomplete_div();this.$sharing_actions.prepend(eU);eU.show();this.autocomplete.dynamically_resize_input();br(this.autocomplete.element).val("");this.autocomplete.clearTokens();br(this.autocomplete.get_entry_container()).hide();br(this.autocomplete.element).focus();return false},link_click:function(eU,eT){var T;this.file=eU;this.user=eT;if(!dK.get_for_user(this.user).verified_or_show(d8.SHMODAL)){return}T="file_row_sharing_menu";a0.ShmodelUILogger.log("token_share",T,this.target_item);return dc.shmodel(this.file.fq_path,T)},_activate:function(){this.$sharing_div=br(this.file.get_div()).find(".sharing");this.$sharing_actions=this.$sharing_div.find(".sharing-actions");this.$sharing_actions.find(".recipients").hide();this.$sharing_div.addClass("pressed");br("#browse-box").addClass("dropdown-menu-open");return this._listen()},_send:function(){var eT,eY,eZ,e1,e4,eV,eU,eW,e0,e3,eX,T,e2;this.sharing_api=new ba(this.user);this.autocomplete.tokenize_emails_input(true);e1=this.emails=this.autocomplete.getEmails().split(", ");e4=this.file.fq_path;T={emails:e1};eZ="";eY="";eT="";eW=this.file.target_ns;eU="";e2="";eT="";eV=false;this._hide();e3=(function(e5){return function(){return e5._complete(ef("Sent!"),"success")}})(this);e0=(function(e5){return function(fa){var e9,e8,e7,e6;e6=fa.responseText.substr(4);if(e6[0]==="{"){e9=JSON.parse(e6);if(e9.emails){e8=e9.emails["message_text"]}if(e9.path){e8=e9.path["message_text"]}}else{e8=e6}if(!e8){e8="Unknown"}e7=ef("Error: %(msg)s").format({msg:e8});return e5._complete(e7,"error")}})(this);if(!dK.get_for_user(this.user).verified_or_show(d8.SHMODAL)){return}eX=this.file.read_only||this.file.is_read_only_mount;if(this.file.is_shared_folder()&&!eX){return this.sharing_api.invite_more_to_folder(eW,T,eZ,eT,e3,e0)}else{if(this.file.could_be_shared_folder()&&!eX){return this.sharing_api.share_folder(false,e4,T,eZ,eY,eU,e2,eT,eV,e3,e0)}else{return this._get_shmodel_link(function(e6){var e5;e5=D.parse(e6);return cp.WebRequest({url:"/sm/share",data:{emails:e1,shmodel_path:e5.path},subject_user:cf.active_user.id,success:e3,error:e0})})}}},_get_shmodel_link:function(T){return cp.WebRequest({url:"/growth/find_or_create_shmodel_link",data:{path:this.file.fq_path},subject_user:cf.active_user.id,dataType:"json",success:(function(eT){return function(eU){if(eU.error!=null){return eT._complete(ef("Error"),"error")}else{return T(eU.shmodel_link)}}})(this),error:(function(eT){return function(){return eT._complete(ef("Error"),"error")}})(this)})},_complete:function(eT,eY){var T,eX,eZ,e0,eV,eW,eU;this.$sharing_div.addClass("complete");T=this.$sharing_div.find(".sharers");if(eY==="success"&&this.emails){eW=a1("Sent to %(number)d person","Sent to %(number)d people",this.emails.length).format({number:this.emails.length});ab.success(eW);eX=T.text();if(eX==="--"){eX=""}if(eX.length===""||eX.length+this.emails.join(", ").length<28){eZ=[];eU=0;eV=0;while(eV<this.emails.length&&eU+this.emails[eV].length<(30-eX.length)){eZ.push(this.emails[eV]);eU+=this.emails[eV].length;eV++}if(this.emails.length>eZ.length){eZ.push("+"+(this.emails.length-eZ.length))}if(eX!==""){eZ.push(eX)}e0=eZ.join(", ");T.text(e0)}}else{if(eY==="error"){ab.error(eT)}}return setTimeout(this._removeComplete,2000)},_removeComplete:function(){return br("div.sharing.complete").removeClass("complete")},_autocomplete_div:function(){return br("#browse-inline-autocomplete")},_listen:function(){if(this.mode==="recipients"){this._autocomplete_div().on("click dblclick",function(T){return T.stopPropagation()});this.$sharing_actions.find(".send-button").on("click",br.proxy(this._send,this))}return br(document).on("mousedown",br.proxy(this._click_outside_autocompleter_callback,this))},_unlisten:function(){if(this.mode==="recipients"){this._autocomplete_div().off("click dblclick");this.$sharing_actions.find(".send-button").off("click",br.proxy(this._send,this))}return br(document).off("mousedown",this._click_outside_autocompleter_callback)},_click_outside_autocompleter_callback:function(T){if(!(this.$sharing_actions.is(T.target)||br(T.target).parents(".sharing-actions").length)){return this._hide()}},_hide:function(T){var eT;this._unlisten();br("#browse-box").removeClass("dropdown-menu-open");this.$sharing_actions.find(".recipients, .get-link").show();this.$sharing_actions.find(".send-button, .link-field").hide();this.$sharing_div.removeClass("pressed");eT=this._autocomplete_div().hide();return br("#browse-sort").append(eT)}};var y;y=B.DragScroll={_timer:null,_mouse_y:0,_initial_mouse_y:null,_scroll_amount:40,_scroll_window:50,_min_drag_distance:20,_exclude_move_event:null,init:function(T,eT){this._exclude_move_event=T;if(eT!=null){return this._scroll_window=eT}},start:function(){this._initial_mouse_y=null;this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(eT){var T;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(eT):void 0){return this._mouse_y=0}else{T=eT.pointerY();return this._mouse_y=T-z.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var T;if(this._initial_mouse_y===null){this._initial_mouse_y=this._mouse_y}if(Math.abs(this._mouse_y-this._initial_mouse_y)<this._min_drag_distance){return}T=0;if(this._mouse_y<this._scroll_window){T=-1*this._scroll_amount}else{if(this._mouse_y>z.viewport_dimensions().height-this._scroll_window){T=this._scroll_amount}}if(T){return z.scroll_to(z.scroll_offsets().left,z.scroll_offsets().top+T)}}};var bD;bD=B.BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var T;if(!Modernizr.draganddrop){return}this.listen();T=function(eU){var eT;eT=br(eU.target);return eT.closest("#browse-location").length||eT.attr("id")==="browse-location"};return y.init(T,br("#browse-header").height())},listen:function(){var T;T=$(document.body);document.observe(cf.UPDATE_EVT,this._update_body_data.bind(this));T.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));T.on("dragend",this._body_dragend.bind(this));T.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){T.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));T.on("mousedown",this._ie_start_drags.bind(this));T.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}T.observe("dragover",this._body_dragover.bind(this));T.observe("dragleave",this._body_dragleave.bind(this));T.observe("dragstart",this._body_dragstart.bind(this));T.observe("mousemove",this._body_mousemove.bind(this));T.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(eA.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(cf.RENDER_EVT,this._build_selected_drag_icon.bind(this));T.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return T.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(eT){var T;if(!window.event||window.event.button!==1){return}T=eT.findElement("[draggable]");if(T&&T!==document&&T.dragDrop){T.dragDrop();return bD._ie_end_drags()}},_ie_start_drags:function(T,eT){if(eT.tagName!=="OBJECT"&&$(eT).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var eT,T;eT=cf.inside_dir?"copy move":false;T=cf.inside_dir?cf.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",eT);return $(document.documentElement).writeAttribute("data-fq_path",T)},_body_dragover:function(eV){var eT,eU,T;eT=this._get_event_browse_files();if(eT.length){return this._update_status_position(eV,eT)}else{if(!this._drag_from_window&&((eU=eV.dataTransfer)!=null?(T=eU.types)!=null?T.contains("Files"):void 0:void 0)){return be.show_drop_indicators(eV)}}},_body_dragleave:function(eU){var eT,T,eV;T=eU.x||eU.clientX;eV=eU.y||eU.clientY;eT=z.viewport_dimensions();if(!((0<T&&T<eT.width)&&(0<eV&&eV<eT.height))){return be.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();be.hide_drop_indicators();y.end();return this._drag_from_window=false},_body_mousemove:function(){return be.hide_drop_indicators()},_ie_mouseover:function(eT,T){if(!z.focus_in_input()){return T.focus()}},_dropzone_dragover:function(eX,T){var eT,eU,eV,eW;eX.preventDefault();eV=this._get_event_browse_files();eW=this._target_fq_path(T);if(!eV.pluck("fq_path").indexOf(eW===-1)){return}if(!this._can_drop(eX,T)){T.addClassName("drag_nodrop");return}try{eU=eX.dataTransfer.effectAllowed}catch(eY){}if(eU==="move"||eU==="copyMove"||eU==="linkMove"||eU==="all"){eX.dataTransfer.dropEffect="move"}else{eX.dataTransfer.dropEffect="copy"}eX.preventDefault();eT=$$(".dragover");eT.removeItem(T);eT.invoke("removeClassName","dragover");if(!dz.disabled){T.addClassName("dragover")}return be.folder_dragover(eW)},_dropzone_dragleave:function(eT,T){return this._clear_hover_state(T)},_file_dragstart:function(eY,e1){var e2,T,e3,eT,eX,eW,eV,eZ,eU;dL.clear_selected();if(eA.is_selecting()){return eY.preventDefault()}eY.dataTransfer.effectAllowed="copyMove";eY.dataTransfer.setData("URL","about:blank");eX=cD.from_elem(e1);this._set_event_browse_files(eX);eW=this._get_event_browse_files();if(eW.length<=1&&!eX.dir){eU=eX.href;eV=(eX.filename||ef("file")).replace(/:/g,"-");eZ="application/octet-stream";try{eY.dataTransfer.setData("DownloadURL",[eZ,eV,eU].join(":"))}catch(e0){}}e3=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif",width:1,height:1});e2=true;try{eY.dataTransfer.setDragImage(e3,150,150)}catch(e0){eT=e0;e2=dL.ie8}this._add_drop_indicators(eY);y.start();if(e2){this._update_status_position(eY,eW);T=$("drag-status");T.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(eW.length>1){T.addClassName("rotatein")}if(this._is_dragging_selection()){T.addClassName("selection")}return T.addClassName("fadein")}},_add_drop_indicators:function(eW){var eX,eV,eT,eU,T;$(document.body).addClassName(this._STATUS_CLASS);if(!dz.disabled){eU=$$('[dropzone="copy move"]');T=[];for(eV=0,eT=eU.length;eV<eT;eV++){eX=eU[eV];if(this._can_drop(eW,eX)){T.push(eX.addClassName("can_drop"))}else{T.push(void 0)}}return T}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var T,eV,e0,eU,eY,e1,eZ,eT,eW,e2,eX;eT=eA.get_selected_files();e0=new Element("div",{id:"drag-selection-status"});eX=eT.slice(0,4);for(eY=eW=0,e2=eX.length;eW<e2;eY=++eW){eV=eX[eY];T=eV.get_div();if(!T){continue}eZ=T.down(".icon");eZ.stopObserving("load");eZ.observe.bind(eZ).defer("load",bD._build_selected_drag_icon);e1=eZ.cloneNode(false);Element.addClassName(e1,"icon icon"+eY);e0.__sert(e1)}eU=new Element("span",{className:"badge"});eU.__date(eT.length);e0.appendChild(eU);return $("drag-selection-status").replace(e0)},_build_file_drag_icon:function(eW,T){var eT,eX,eV,eU;eT=cD.from_elem(T);eU=eT.get_div().down(".icon").cloneNode(false);Element.addClassName(eU,"icon icon0");eV=new Element("span",{className:"badge"});eV.__date("1");eX=new Element("div",{id:"drag-file-status"});eX.__date(eU).__sert(eV);return $("drag-file-status").replace(eX)},_drop:function(eX,e0){var eY,eU,e2,e1,e4,e3,eW,eT,T,eV,eZ;eU=this._get_event_browse_files();e3=eX.dataTransfer.files;eW=eX.dataTransfer.items;eX.preventDefault();if(e0.readAttribute("quicksend")){if(e3&&e3.length){e2=function(){return be.upload(W.DEST_FOLDER,e3,eW)};W.get_folder_name(e2)}else{if(eU.length){for(eV=0,eZ=eU.length;eV<eZ;eV++){eT=eU[eV];eT.id=plupload.guid();W.add_dropbox_file(eT)}}}return}if(this._is_read_only(e0)){T=ef("You don't have permission to add to this folder.");ab.error(T);return}e1=null;e4=cD.from_elem(e0);eY=e0.readAttribute("data-fq_path");if(e4){e1=e4.fq_path}else{if(eY||eY===""){e1=eY}}if(e3&&e3.length){if(!be.supported()){ab.error(ef("Drag and drop not supported. Please try the simple uploader."))}else{if(!be.browse_indicators_enabled()&&!be.modal_indicators_enabled()){if(cn.choose_button_id.startsWith("wizard-")){ab.error(ef("You'll be able to drag and drop files once you finish this tutorial. For now, choose a file to upload."))}else{ab.error(ef("You can't drag and drop upload right now."))}}else{be.upload(e1,e3,eW)}}}else{if(eU.length){if((eX.dataTransfer.dropEffect==="copy")||(eX.dataTransfer.effectAllowed==="copy")){di.do_bulk_copy(eU,e1)}else{if(!cf.inside_dir||cf.containing_fq_path()!==e1){di.do_bulk_move(eU,e1)}}}}this._remove_drop_indicators();return be.hide_drop_indicators()},_set_event_browse_files:function(T){var eT;eT=eA.is_selected(T);return this._current_item_key=eT?this._SELECTION_CONST:T.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var eU,eT,T;try{T=this._current_item_key;if(this._is_dragging_selection()){return eA.get_selected_files()}else{if(T){eT=cD.from_key(T);return(eT?[eT]:[])}}}catch(eV){eU=eV;console.log(eU)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_is_read_only:function(T){if(T.readAttribute("read_only")){return true}if(T.readAttribute("is_read_only_mount")){return true}return false},_can_drop:function(eV,eT){var T,eU;if(eT.readAttribute("quicksend")){return true}if(this._is_read_only(eT)){return false}T=this._target_fq_path(eT);eU=this._get_event_browse_files();if(eU.length){return !di.bulk_move_error(eU,T)}else{if($A(eV.dataTransfer.types).indexOf("Files")!==-1){return be.supported()}else{return false}}},_target_fq_path:function(T){var eT;eT=cD.from_elem(T);if(eT){return eT.fq_path}else{return T.readAttribute("data-fq_path")}},_clear_hover_state:function(eT){var eW,eV,T,eU;eU=$$("#browse .dragover");for(eV=0,T=eU.length;eV<T;eV++){eW=eU[eV];if(eW!==eT){eW.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(T){T=Event.extend(T);return dL.scry("drag-status").setStyle({left:(T.pointerX()-z.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(T.pointerY()-z.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var L;L=B.BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(T){return T.charCodeAt(0)}),update:function(){var eU,eX,eT,eW,T,eV;if(!L._listening){L.listen();L._listening=true}eU=[];eV=cf.files;for(eW=0,T=eV.length;eW<T;eW++){eT=eV[eW];eX=L.to_codepoint_list(eT.filename);eU.push([eX,eT])}eU.sort(function(eZ,eY){return L.cmp_codepoints(eZ[0],eY[0])});return L._CODEPOINTS=eU},reset:function(){return L._active=""},is_active:function(){return L._active},jump:function(T){if(T){eA.set_selected_files([T]);return cf.scrollTo(T.get_div())}},listen:function(){var eW,eV,eT,eU,T;document.observe("keypress",function(eY){var eX;if(key.getScope()!==cf.KEY_SCOPE){return}if(z.focus_in_input()||eY.metaKey||eY.altKey||eY.altGraphKey||eY.ctrlKey){return}eX=eY.charCode||eY.keyCode;if(eX<32){return}if((33<=eX&&eX<=40)){return}if(eX===32){if(L._active){eY.preventDefault()}else{return}}if(L._BLACKLIST.indexOf(eX)!==-1){return}clearTimeout(L._RESET_TIMER_ID);L._active+=String.fromCharCode(eX).toLowerCase();L.jump(L.nearest_file(L._active));return L._RESET_TIMER_ID=setTimeout(L.reset,L._RESET_WAIT)});eU=[aB.DELETE,aB.COPY,aB.MOVE,aB.RENAME,aB.PURGE,aB.RESTORE,aB.UPLOAD,aB.SF_NEW,aB.SF_LEAVE,aB.SF_UNSHARE,aB.SF_REJOIN,aB.SF_IGNORE,aB.LINKS_REMOVE,bq.ADD,bq.REMOVE,bq.MOVE];T=[];for(eV=0,eT=eU.length;eV<eT;eV++){eW=eU[eV];document.observe(eW,function(eX){return L.update()});T.push(br(document).on(eW,function(eX){return L.update()}))}return T},nearest_file:function(e0){var eX,eT,T,eW,eZ,eY,eV,eU;if((eY=L._CODEPOINTS)!=null?eY.length:void 0){eX=L.to_codepoint_list(e0);eV=L._CODEPOINTS;for(eW=0,eZ=eV.length;eW<eZ;eW++){eU=eV[eW],T=eU[0],eT=eU[1];if(L.cmp_codepoints(eX,T)<1){return eT}}L._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(eW,eV){var T,eU,eT;cw(eW.length>0&&eV.length>0,"bad input to cmp_codepoints");for(T=eU=0,eT=eW.length;0<=eT?eU<eT:eU>eT;T=0<=eT?++eU:--eU){if(eV[T]==null){return 1}if(eW[T]!==eV[T]){return(eW[T]<eV[T]?-1:1)}}if(eV.length>eW.length){return -1}else{return 0}},to_codepoint_list:function(eT){var eU,T,eW,eV;eT=eT.toLowerCase();T=[];for(eU=eW=0,eV=eT.length;0<=eV?eW<eV:eW>eV;eU=0<=eV?++eW:--eW){T.push(eT.charCodeAt(eU))}return T}};var bc;bc=B.ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){br(document).click(this.hide_on_click);br(document).on(cf.UPDATE_EVT,this.hide_on_click);return key("esc",this.KEY_SCOPE,(function(T){return function(eT){return bc.hide()}})(this))},unlisten:function(){br(document).off("click",this.hide_on_click);return br(document).off(cf.UPDATE_EVT,this.hide_on_click)},hide_on_click:function(T){if(!(T.which===3||br(T.target).parents("#context-menu").length)){return bc.hide()}},show_for_file:function(T,eV,eU){var eW,eT;cf.keyboard_nav=false;this.hide();eW=cD.from_elem(eU);eT=eA.is_selected(eW)?eA.get_selected_files():(eA.deselect_all(),[eW]);eA.set_context_selected(eT);return this._show(eV,new T(eT))},show_global:function(T,eT){this.hide();return this._show(eT,new T())},show_shmodel:function(eY){var eX,eT,T,eU,eV,eW;eX=["get_original"];eV=eY.findElement("img");if((eV.readAttribute("enable-download"))==="true"){eU=eV.readAttribute("data-original-href");eT=[]}else{eU="";eT=["get_original"]}this.hide();eW={get_original:{icon:"download",text:ef("Download original"),href:eU}};T=Class.create({get_action_names:function(){return eX},get_disabled_action_names:function(){return eT},get_action_by_name:function(eZ){var e0;e0=eW[eZ];e0.name=eZ;return e0}});return this._show(eY,new T())},show_for_lightbox:function(eZ){var eY,eT,T,eW,eU,eX,eV;eY=["download","view_original"];this.hide();eU=eZ.findElement("img");if((eU.readAttribute("enable-download"))==="false"){eT=["download","view_original"];eW="";eV=""}else{eT=[];eW=D.parse(eU.readAttribute("data-original-href")).updateQuery({dl:1}).toString();eV=eU.readAttribute("data-original-href")}eX={download:{icon:"download",text:ef("Download"),href:eW},view_original:{icon:"view_original",text:aW.append_ellipsis(ef("View original")),href:eV,target:"_blank"}};T=Class.create({initialize:function(){return this._listen()},_listen:function(){var e0;e0=$("context-menu-container");e0.stopObserving("click");e0.stopObserving("contextmenu");e0.on("click",".action button",this._click.bind(this));return e0.on("contextmenu",".action button",this._click.bind(this))},_click:function(e4,e1){var e3,e0,e2;e3=e1.readAttribute("data-value");e0=eX[e3];bc.hide();e4.preventDefault();return(e2=e0.click_handler)!=null?e2.call(this,e4):void 0},get_action_names:function(){return eY},get_disabled_action_names:function(){return eT},get_action_by_name:function(e0){var e1;e1=eX[e0];e1.name=e0;return e1}});return this._show(eZ,new T())},show_photos:function(e0,e4){var e3,eT,eX,eV,e2,e1,T,eU,eY,eZ,eW;this.hide();eV={divider:{type:"divider"},choose_album:{icon:"album_16",text:aW.append_ellipsis(ef("Add %(num_photos)s to album").format({num_photos:e4.length})),click_handler:function(e5){ct.show_add_to_album_modal(e5,e4);return h.log_interaction(d2.ADD_TO_OTHER_ALBUM,cT.PCM,{num_photos:e4.length})}},remove:{icon:"album_delete_16",text:ef("Remove %(num_photos)s from album").format({num_photos:e4.length}),click_handler:function(){ct.show_remove_photos_modal(bC.get_current_collection(),e4);return h.log_interaction(d2.REMOVE,cT.PCM,{num_photos:e4.length})}},set_cover:{icon:"album_16",text:ef("Set as cover"),click_handler:function(){bC.get_current_collection().set_cover(e4[0]);return h.log_interaction(d2.SET_AS_COVER,cT.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return bC.show_timestamps_modal(e4)}}};if(bC.in_single_collection_view()){e3=["share","choose_album","remove"];if(e4.length===1){e3.unshift("divider");e3.unshift("set_cover")}}else{e3=["share","choose_album"];e3.push("divider");e3.push("delete");if(bC.timestamp_edit_enabled){e2=(function(){var e7,e6,e5;e5=[];for(e7=0,e6=e4.length;e7<e6;e7++){eU=e4[e7];if(eU.time_taken==null){e5.push(eU)}}return e5})();if(e2.length===0){e3.push("edit_timestamp")}else{if(e2.length===e4.length){eV.edit_timestamp.text="Set timestamp";e3.push("edit_timestamp")}}}}if(e4.length===1){eZ=cR.categorize_files(e4),e1=eZ[0],T=eZ[1];if(e1){eY=aW.append_ellipsis(ef("Share photo"))}else{eY=aW.append_ellipsis(ef("Share video"))}Object.extend(eV,{share:{icon:"s_link",text:eY,click_handler:function(e5){ee.show(e4,false);return h.log_interaction(d2.SHARE,cT.PCM,{num_photos:1})}},"delete":{text:aW.append_ellipsis(ef("Delete")),click_handler:function(){bC.show_delete_photos_modal(e4);return h.log_interaction(d2.DELETE,cT.PCM,{num_photos:1})}},show_in_folder:{text:aW.append_ellipsis(ef("Show in folder")),click_handler:function(){bC.show_in_folder(e4[0]);return h.log_interaction(d2.SHOW_IN_FOLDER,cT.PCM,{num_photos:1})}}});if(bC.in_single_collection_view()){e3.push("divider")}e3.push("show_in_folder")}else{eW=cR.categorize_files(e4),e1=eW[0],T=eW[1];if(e1&&T){eY=a1("Share %(file_count)s item","Share %(file_count)s items",e4.length);eX=a1("Delete %(file_count)s item","Delete %(file_count)s items",e4.length)}else{if(e1){eY=a1("Share %(file_count)s photo","Share %(file_count)s photos",e4.length);eX=a1("Delete %(file_count)s photo","Delete %(file_count)s photos",e4.length)}else{eY=a1("Share %(file_count)s video","Share %(file_count)s videos",e4.length);eX=a1("Delete %(file_count)s video","Delete %(file_count)s videos",e4.length)}}eY=eY.format({file_count:e4.length});eX=eX.format({file_count:e4.length});Object.extend(eV,{share:{icon:"s_link",text:eY,click_handler:function(e5){bC._share_selected();return h.log_interaction(d2.SHARE,cT.PCM,{num_photos:e4.length})}},"delete":{text:eX,click_handler:function(e5){bC.show_delete_photos_modal(e4);return h.log_interaction(d2.DELETE,cT.PCM,{num_photos:e4.length})}}})}eT=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(e8,e6){var e7,e5,e9;e7=e6.readAttribute("data-value");e5=eV[e7];if(e8.clientX===0&&e8.clientY===0){return}bc.hide();return(e9=e5.click_handler)!=null?e9.call(this,e8):void 0},get_action_names:function(){return e3},get_disabled_action_names:function(){return[]},get_action_by_name:function(e5){var e6;e6=eV[e5];e6.name=e5;return e6}});return this._show(e0,new eT())},show_photo_collection:function(eV,eW,eX){var eU,T,eT;this.hide();if(eW.is_anonymous){eU=["go_to_link","unshare"]}else{if(eW.is_creator){eU=["share","rename"];if(eW.share_tkey!=null){eU.push("unshare")}eU.push("delete")}else{eU=["share"]}}eT={share:{icon:"s_link",text:aW.append_ellipsis(ef("Share album")),click_handler:function(eY){if(eW.num_items===0){ab.error(ef("This album is empty. Add some photos before you share it!"));return}ee.show(eW,true);return h.log_interaction(d2.SHARE_ALBUM,cT.CCM,{num_photos:eW.num_photos})}},unshare:{icon:"lock",text:aW.append_ellipsis(eW.is_anonymous?ef("Unshare"):ef("Unshare album")),click_handler:function(eY){ct.show_unshare_modal(eW);return h.log_interaction(d2.UNSHARE_ALBUM,cT.CCM,{num_photos:eW.num_photos})}},rename:{icon:"pencil",text:ef("Rename album"),click_handler:function(eY){eW.rename(eX.down(".collection-name"));return h.log_interaction(d2.RENAME_ALBUM,cT.CCM,{num_photos:eW.num_photos})}},"delete":{icon:"album_delete_16",text:aW.append_ellipsis(ef("Delete album")),click_handler:function(eY){ct.show_delete_modal(eW);return h.log_interaction(d2.DELETE_ALBUM,cT.CCM,{num_photos:eW.num_photos})}},go_to_link:{icon:"s_link",text:ef("Go to link"),click_handler:function(eY){ct.go_to_link(eW);return h.log_interaction(d2.GO_TO_ALBUM_LINK,cT.CCM,{num_photos:eW.num_photos})}}};T=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(e2,eZ){var e1,eY,e0;e1=eZ.readAttribute("data-value");eY=eT[e1];bc.hide();return(e0=eY.click_handler)!=null?e0.call(this):void 0},get_action_names:function(){return eU},get_disabled_action_names:function(){return[]},get_action_by_name:function(eY){var eZ;eZ=eT[eY];eZ.name=eY;return eZ}});return this._show(eV,new T())},_show:function(e5,eZ,e4){var e3,eW,e6,T,e2,e1,e8,e0,eU,eT,e7,e9,eY,eX,eV;if(e4==null){e4=false}e0=((e5!=null?(eY=e5.target)!=null?eY.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((e5!=null?(eX=e5.target)!=null?eX.type.toUpperCase():void 0:void 0)==="TEXT")||((e5!=null?(eV=e5.target)!=null?eV.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");e2=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#notify-wrapper",".db-modal-wrapper","#sharing-growth-experiments-dropdown-menu",".inline-share-button","#wizard-overlay","#react-bubble-dropdown-root",".preview-sf-members-box",".db-modal",".db-modal-overlay"];e8=$(e5.target);if(br(e8).parents("#context-menu").length){return}e3=br("#file-preview-modal");if(!(e3.find(e8).length&&br(e8).is("img"))){for(eU=0,e7=e2.length;eU<e7;eU++){T=e2[eU];e6=$$(T);if(e6){for(eT=0,e9=e6.length;eT<e9;eT++){eW=e6[eT];if(e8.descendantOf(eW)||e8.match(T)){return}}}}}if((e5!=null?e5.shiftKey:void 0)||e0){return}else{Event.stop(e5)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=eP.tmpl("context_menu_tmpl")}if(!eZ.get_action_names().length){return}ex.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:eZ,actions:(function(){var fc,fa,fd,fb;fd=eZ.get_action_names();fb=[];for(fc=0,fa=fd.length;fc<fa;fc++){e1=fd[fc];fb.push(eZ.get_action_by_name(e1))}return fb})(),disabled_actions:eZ.get_disabled_action_names(),big:e4,Sprite:cj}));this.position_at(e5.clientX,e5.clientY);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(eU,eX){var eT,T,eV,eW;eW=z.viewport_dimensions();T=parseInt($("context-menu").getStyle("width"),10);eT=parseInt($("context-menu").getStyle("height"),10);eV=15;if(eU+T>eW.width-eV){$("context-menu").setStyle({left:(eW.width-T-eV)+"px"})}else{$("context-menu").setStyle({left:eU+"px"})}if(eX+eT>eW.height-eV){return $("context-menu").setStyle({top:(eW.height-eT-eV)+"px"})}else{return $("context-menu").setStyle({top:eX+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();eA.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}}};var c4,cf,j,at,cF,b8;c4=B.BROWSE_SNIPPET_LEN=25;b8=B.SEARCH_SNIPPET_LEN=20;cF=B.LAST_MODIFIED_FNAME_SNIPPET=4;at=[bf.FILES_BY_NAME,true,"FILES_BY_NAME"];cf=INLINE_JS.Browse=B.Browse={KEY_SCOPE:"browse",RENDER_EVT:"db:browse:render",UPDATE_EVT:"db:browse:update",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:at,folder_loading_notification:null,folder_loading_timeout:null,keyboard_nav:false,paginating:false,is_initialized:false,init:function(eT,eY,eV,eX,T,eW,eU){this.browse_actions_ctor=eY;this.global_actions_ctor=eV;this.browse_actions_context_ctor=eX;this.global_actions_context_ctor=T;this.ns_id_to_mount_point=eW;cw(typeof eU==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=cy.get_viewer().get_user_by_id(eU);__CIRCULAR_DEPENDENCY__.active_user_loaded=true;cw(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();z.viewport_dimensions();if(bO.chrome){this.browser_supports_previews=eT&&dL.pdf_plugins().length}else{this.browser_supports_previews=eT}if(cy.get_viewer().is_paired){dk.set_role(this.active_user.role)}this.subscribe_sfj_callbacks={};this.compiled_search_tmpl=eP.tmpl("search_list_item_tmpl");this.add_visible_change_callback((function(eZ){return function(){return eZ.show_inline_sharing_on_browse_exp()}})(this));cp.AuthenticatedRequest({url:D({path:"/flash_detect_log"}),data:{installed:FlashDetect.installed,major:FlashDetect.major,minor:FlashDetect.minor,revision:FlashDetect.revision,revisionStr:FlashDetect.revisionStr,raw:FlashDetect.raw}});return this.is_initialized=true},setup:function(eT,eZ){var eY,eX,eW,eV,T,eU;if(eZ==null){eZ=null}this.ns_id_to_mount_point=eT.ns_id_to_mount_point;this.old_path_to_ns_id=eT.old_path_to_ns_id;this.compiled_tmpl=eP.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_root_folder=eT.containing_fq_path==="";this.inside_dir=eT.inside_dir;this.inside_deleted_dir=eT.inside_deleted_dir;this.inside_shared_folder=eT.inside_shared_folder;this.inside_read_only_shared_folder=eT.inside_read_only_shared_folder;this.inside_sandbox=eT.inside_sandbox;this.public_app_token=eT.public_app_token;this.public_folder_enabled=eT.public_folder_enabled;this.inside_deleted_sandbox=eT.inside_deleted_sandbox;this.inside_deleted_shared_folder=eT.inside_deleted_shared_folder;this.inside_team_folder=eT.inside_team_folder;this.bypass_nested_sharing_checks=eT.bypass_nested_sharing_checks;this.is_read_only=eT.is_read_only;this.ns_map=eT.ns_map;this.contents_cache_key=eT.contents_cache_key;this._eventbus_darklaunch_enabled=eT.eventbus_darklaunch_enabled;this._eventbus_darklaunch_num_queues=eT.eventbus_darklaunch_num_queues;eX="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(eX)}else{$("browse").removeClassName(eX)}this.block_hash=eT.block_hash;this.block_hash_param=eT.block_hash_param;if(this.inside_dir){$("advanced-search-box").hide();$("advanced-search-link").removeClassName("selected");this._containing_ns_id=eT.containing_ns_id;this._containing_ns_path=eT.containing_ns_path;this._containing_fq_path=eT.containing_fq_path;this._containing_mount_point=eT.containing_mount_point;this._containing_sf_perm_role=eT.containing_sf_perm_role;this.breadcrumb();eU=[this.browse_actions,this.global_actions];for(eV=0,T=eU.length;eV<T;eV++){eY=eU[eV];if(eY!=null){eY.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!(eT.file_info||eT.paginated)){this.show_message(ef('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}if(eT.paginated){this._start_pagination(eT.first_page)}else{this._push_files(eT.file_info,eZ)}if(this._eventbus_darklaunch_enabled){eW=new __CIRCULAR_DEPENDENCY__.EventbusDarkLaunch(cf.active_user.id,this._eventbus_darklaunch_num_queues);return eW.allocate_event_queues()}},entered_search:function(){return this._stop_pagination()},_start_pagination:function(eT){var T;if(eT.unsupported_sort!=null){this.reset_sort()}this.paginating=true;T=cf.active_user.id;this.pagination_manager=new eS();this.pagination_manager.initialize(eT,"sjid","/browse_get_next",T,(function(eU){return function(eV,eW){return eU._new_data_available(eV,eW)}})(this));this.pagination_manager.startAutoFetching();br("#more-loading").show();return this.disable_sorting()},_stop_pagination:function(){if(!this.paginating){return}this.paginating=false;this.pagination_manager.stopAutoFetching();this.pagination_manager=null;br("#more-loading").hide();return this.enable_sorting()},_new_data_available:function(eT,T){if(!this.paginating){return}this._push_files(T);if(!this.in_search_mode()){this.smartfill()}if(eT.areAllItemsReady()){return this._stop_pagination()}},_start_darklaunch_event_queues:function(){var T,eV,eU,eT;if(this._eventbus_darklaunch_num_queues<=0){return}eT=[];for(T=eV=1,eU=this._eventbus_darklaunch_num_queues;1<=eU?eV<=eU:eV>=eU;T=1<=eU?++eV:--eV){__CIRCULAR_DEPENDENCY__.UserQueue.get_user_queue(cf.active_user.id,this._eventbus_darklaunch_num_queues);eT.push(eventbus_dark_launch.allocate_event_queues())}return eT},_push_files:function(eU,eX){var eT,eV,eW,T;if(eX==null){eX=null}for(eW=0,T=eU.length;eW<T;eW++){eV=eU[eW];eT=aW.make_browsefile(eV,eX);eT.track_in_browse()}return L.update()},_get_helper:function(T){cw(this.inside_dir,"accessed "+T+", but not inside a directory");return cf[T]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},containing_fq_path:function(){if(!this.inside_dir){return""}return this._get_helper("_containing_fq_path")},containing_sf_perm_role:function(){return this._get_helper("_containing_sf_perm_role")},listen:function(){var e4,eV,eW,eZ,e7,eT,e2,e1,eY,e5,eU,T,e6,e3,e0,eX;br("#fulltext-search-all-link").click(this.unscoped_search);br("#noresults-search-all-link").click(this.unscoped_search);$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",bc.show_for_file.bind(bc,this.browse_actions_context_ctor));this.enable_sorting();eZ="#browse-sort a.sortable-column-header";dL.add_sort_arrow_mouseover($("name-sorter"),true,eZ,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",bc.show_global.bind(bc,this.global_actions_context_ctor));document.observe(eA.UPDATED_EVT,this.selection_handler.bind(this));document.observe(aB.COPY,(function(e8){return function(e9){if(e8.inside_dir&&e9.memo.to_fq_path===e8.containing_fq_path()){return e8.force_reload()}}})(this));e3=[aB.MOVE,aB.RESTORE,aB.UPLOAD,aB.SF_NEW,aB.SF_REJOIN,aB.SF_IGNORE,aB.LINKS_REMOVE,aB.LINKS_ADD];for(e2=0,e5=e3.length;e2<e5;e2++){eV=e3[e2];eW=(function(e8){return function(e9){if(e8.inside_dir&&!(bW.sparky_search_ui_enabled&&cf.in_search_mode())){return e8.force_reload()}}})(this);document.observe(eV,eW);br(document).on(eV,eW)}e0=[aB.SF_LEAVE,aB.SF_UNSHARE];for(e1=0,eU=e0.length;e1<eU;e1++){eV=e0[e1];document.observe(eV,(function(e8){return function(e9){if(e8.inside_dir){if(e9.memo.target_ns_id===e8.containing_ns_id()){if(e9.memo.folder_deleted){return e8.reload_fqpath("")}else{return e8.reload_fqpath(e8.containing_fq_path())}}else{return e8.force_reload()}}}})(this))}eX=[aB.DELETE,aB.PURGE];for(eY=0,T=eX.length;eY<T;eY++){eV=eX[eY];document.observe(eV,(function(e8){return function(fh){var fe,fg,fa,ff,e9,fc,fd,fb;if(e8.inside_dir){if(fh.eventName===aB.PURGE||(fh.eventName===aB.DELETE&&!aV.get_del())){for(fg=ff=fd=e8.files.length-1;fd<=0?ff<=0:ff>=0;fg=fd<=0?++ff:--ff){if(fh.memo.files.indexOf(e8.files[fg])===-1){fa=e8.files[fg]}else{break}}eA.deselect_all();fb=fh.memo.files;for(fc=0,e9=fb.length;fc<e9;fc++){fe=fb[fc];fe.get_div().remove();e8.files.removeItem(fe)}if(e8.files.length){if(fa!=null){return eA.set_selected_files(fa)}else{return eA.set_selected_files(e8.files.last())}}else{return e8.show_empty()}}else{if(e8.keyboard_nav){e8.select_fq_paths=[e8.containing_fq_path()+"/"+fh.memo.files.last().filename]}if(aD.shown){return aD.reload=true}else{return e8.force_reload()}}}}})(this))}document.observe(bc.SHOW_EVT,this.disable_sorting.bind(this));document.observe(bc.HIDE_EVT,this.enable_sorting.bind(this));e6=function(){var e9,e8;e9=$("browse-header");e8=e9.cumulativeOffset().top+e9.getHeight();return z.viewport_dimensions().height-e8};key("pagedown",this.KEY_SCOPE,(function(e8){return function(e9){Event.extend(e9).preventDefault();return window.scrollBy(0,e6())}})(this));key("pageup",this.KEY_SCOPE,(function(e8){return function(e9){Event.extend(e9).preventDefault();return window.scrollBy(0,-1*e6())}})(this));e7=function(){var e8;e8=cf.in_search_mode()?bW:cf;if(cf.files.length===0){return e8.show_empty()}else{return e8.hide_empty()}};document.observe(bq.ADD,(function(e8){return function(fb){var fa,e9,fd,fc;fc=fb.memo.files;for(e9=0,fd=fc.length;e9<fd;e9++){fa=fc[e9];e8.insert_file(fa,true)}return e7()}})(this));document.observe(bq.REMOVE,(function(e8){return function(fb){var fa,e9,fd,fc;fc=fb.memo.files;for(e9=0,fd=fc.length;e9<fd;e9++){fa=fc[e9];e8.remove_file(fa)}return e7()}})(this));document.observe(bq.MOVE,(function(e8){return function(fe){var fh,ff,fg,fi,fc,e9,fb,fa,fd;ff=e8.in_search_mode()&&bW.sparky_search_ui_enabled;fb=fe.memo.files;fd=[];for(fc=0,e9=fb.length;fc<e9;fc++){fa=fb[fc],fh=fa[0],fi=fa[1];if(ff){if(fh!=null){fg=e8.get_file_pos(fh)}else{continue}}e8.remove_file(fh);e8.insert_file(fi);if(ff&&fg>=0){fd.push(e8.update_file_pos(fi,fg))}else{fd.push(void 0)}}return fd}})(this));e4=this.fire_visible_change_callbacks.bind(this);br(window).on("resize",e4);this._last_visible_change_timeout_id=null;eT=(function(e8){return function(e9){clearTimeout(e8._last_visible_change_timeout_id);return e8._last_visible_change_timeout_id=setTimeout(e4,250)}})(this);return br(window).on("scroll",eT)},add_subscribe_sfj_callback:function(T){return this.subscribe_sfj_callbacks[this.subsribe_sfj_count]=T},remove_sfj_callback:function(T){return delete this.subscribe_sfj_callbacks[T]},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(eU,eW){var T,eV,eT;eT=$(eU.target);if(eT.match("a.filename-link")||eT.match("img.icon")||eT.up("a.filename-link")){this._click(eU,eW)}if(eT.match("a.parent-dir")){T=cD.from_elem(eW);if(T){eV={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:bW.firefly_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view",action_type:"click_path_link"};return a0.SearchClientActivityLogger.log("result_action",cf.active_user.id,eV)}}},dblclick:function(T,eT){if($(T.target).match("a")){return}return this._click(T,eT)},open_file:function(eV,T,eT){var eX,eU,eW;if(eT==null){eT=false}eU={mode:"get",file_ext:au.file_extension_for_logging(eV.filename),file_bytes:eV.bytes};eX={file_nsid:eV.ns_id,file_sjid:eV.sjid,firefly:bW.firefly_enabled,match_type:eV.match_type,position:eV.sort_rank,request_id:eV.request_id,viewport:eT?"dropdown-view":"full-view"};if(eV.dir){if(this.in_search_mode()||eT){eX.action_type="folder_open";a0.SearchClientActivityLogger.log("result_action",cf.active_user.id,eX)}if(T){return this.open_folder_in_new_window(eV)}else{return this.open_folder(eV)}}else{if(!T&&!((eV.preview_type==="video")&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX)){if(this.browser_supports_previews||((eW=eV.preview_type)==="photo"||eW==="video")){if(this.in_search_mode()||eT){eX.action_type="file_view";a0.SearchClientActivityLogger.log("result_action",cf.active_user.id,eX)}return this.open_preview(eV,true,eT,eT)}else{if(this.in_search_mode()||eT){eX.action_type="file_view";a0.SearchClientActivityLogger.log("result_action",cf.active_user.id,eX)}a0.UserActivityLogger.log("web","file_view",eU);return window.open(eV.href,"_blank")}}else{if(this.in_search_mode()||eT){eX.action_type="file_view";a0.SearchClientActivityLogger.log("result_action",cf.active_user.id,eX)}a0.UserActivityLogger.log("web","file_view",eU);return window.open(eV.href,"_blank")}}},close_preview_callback:function(){br(document).off("db:filepreview:close",this.close_preview_callback);document.stopObserving(aD.EXIT_SELECT_EVT,this.close_preview_callback);ad.close_shared_link_view();return cf.set_title()},open_preview:function(eT,eV,eW,eU){var T,eY,eX;if(eV==null){eV=false}if(eW==null){eW=false}if(eU==null){eU=false}eY=eT.preview_type==="video"&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX;T=this.browser_supports_previews||((eX=eT.preview_type)==="photo"||eX==="video");if(!eY&&T){aW.filepreview_from_selected("fileclick",eT,!eV,eW,eU,this.photopreview_ui_zoomzoom_enabled);br(document).on("db:filepreview:close",this.close_preview_callback);return document.observe(aD.EXIT_SELECT_EVT,this.close_preview_callback)}},_click:function(eU,eV){var eT,T;this.keyboard_nav=false;eT=cD.from_elem(eV);if(eT.editing){return}T=(eU.which===2)||(dL.is_mac()&&eU.metaKey);cf.open_file(eT,T);eU.preventDefault()},crumb_click:function(eV,T){var eU,eT;this.keyboard_nav=false;eV.preventDefault();eT=T.readAttribute("data-fq_path");eU=this.details_from_fq_path(eT);return aV.set_path_url(eU.ns_id,eU.ns_path)},parent_click:function(eW,eV){var eU,eX,T,eT;this.keyboard_nav=false;eW.preventDefault();eT=eV.readAttribute("data-parent_ns_path");T=parseInt(eV.readAttribute("data-parent_ns_id"),10);aV.set_path_url(T,eT);eU=cD.from_elem(eV);if(eU){eX={file_nsid:eU.ns_id,file_sjid:eU.sjid,firefly:bW.firefly_enabled,match_type:eU.match_type,position:eU.sort_rank,request_id:eU.request_id,viewport:"full-view",action_type:"click_path_link"};return a0.SearchClientActivityLogger.log("result_action",cf.active_user.id,eX)}},selection_handler:function(){if(eA.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){var T,eT,eV,eU;if(bW.sparky_search_ui_enabled&&this.in_search_mode()&&!bW.end_of_results){eU=aW.get_files_in_view(),eV=eU[0],eT=eU[1];T=this.files.length-(eV+eT);if(T<=50&&!$("browse").hasClassName("pending-search")){bW.load_more_results()}}clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(aW.load_visible_thumbs.bind(aW),this.POST_SCROLL_WAIT)},unscoped_search:function(){return bW.search(false)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var eT,T;this.last_sort=at;T="#browse-sort a.sortable-column-header";eT=$$(T)[0];dL.add_sort_arrow_mouseover(eT,true,T,false);$("kind-sorter-label").__date(c6.DISPLAY.FILES_BY_KIND);return cj.src(eT.down("img"),"web","arrow-up-gray")},sort_handler:function(eZ,eV,eY){var eT,eX,eW,T,eU;eV=$(eV);eV.blur();eU=eV.readAttribute("data-sort");if(eY!=null){}else{if(this.last_sort[0]===bf[eU]){eY=eV.readAttribute("data-ascending")==="false"}else{eY=eU!=="FILES_BY_MODIFIED"}}if(c6.has_label(eU)){if(c6.has_sort(this.last_sort[0])||this.show_shared_with){eW=c6.next(eU,this.show_shared_with);eT=this.show_shared_with?"sharing-sorter-label":"kind-sorter-label";$(eT).__date(eW.display);eU=eW.label}eV.writeAttribute("data-sort",eU);eY=c6.IS_ASC[eU]}else{eV.writeAttribute("data-ascending",(eY?"true":"false"))}T="#browse-sort a.sortable-column-header";dL.add_sort_arrow_mouseover(eV,eY,T,true);eX=bf[eU];this.sort(eX,eY,eU);if(eZ){return eZ.stop()}},toggle_deleted:function(){var T;T=!aV.get_del();return aV.set_del_url(T)},new_folder:function(){var eX,e9,eZ,eT,eY,e6,e2,e4,eW,e1,e5,eU,e7,e3,e0,T,e8,eV;if(this.reloading||this.creating_folder){return}if(cf.sharing_create_and_share_new_folder_enabled&&!this.inside_shared_folder){e4=new aT(cf.active_user,{element_id:"create-and-share-new-folder-modal-"+cf.active_user.id,destination_dir:this.containing_fq_path()});e4.show();return}this.hide_empty();this.selectable();e9=ef("New folder");eY=[];eV=this.files;for(T=0,e8=eV.length;T<e8;T++){e6=eV[T];if(e6.dir&&e6.filename.indexOf(e9)!==-1){eY.push(e6.filename)}}eW=e9;eX=1;while(true){if(eY.indexOf(eW)===-1){break}eW=e9+" ("+eX+")";eX++}e0=eP.tmpl("new_folder_tmpl",{name:eW,Sprite:cj,_:ef});e2=-1;if(this.files.length){e3=z.scroll_offsets();if(e3.top>0){e7=this.files[0].get_div().getLayout().get("margin-box-height");e2=Math.floor(e3.top/e7)}}if(e2>0){this.files[e2].get_div().__sert({after:e0})}else{$("browse-files").__sert({top:e0})}e1=$$("#browse-files .browse-new-folder .name").first();cw(e1!=null,"expected new_folder_name to be defined");eZ=this.containing_fq_path();eU=(function(fa){return function(fd){var fc,fb,fe;fe=fd.responseText.evalJSON(true);cw(fe.new_browse_files.length===1,"No new file data returned.");fc=au.filename(fe.new_browse_files.first().fq_path);fb=ef("Created folder '%(folder_name)s'");fb=fb.format({folder_name:bG.em_snippet(fc,25)});ab.success(fb);fa.select_fq_paths=[fe.new_browse_files.first().fq_path];return fa.force_reload()}})(this);e5=(function(fa){return function(fc){var fb;fb=$$("#browse-files li.browse-new-folder").first();if(fb){fb.remove()}return fa.creating_folder=false}})(this);eT=new Ajax.InPlaceEditor(e1,"/cmd/new"+(dL.urlquote(eZ)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:e5,savingText:ef("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:eU,subject_user:cf.active_user},callback:(function(fa){return function(fb,fc){fa.creating_folder=true;return{to_path:fc||"",folder:"yes"}}})(this)});return eT.enterEditMode()},open_folder:function(eT){var eV,T,eU;cw(eT.dir,"Only open directories, not files");if(cf.inside_dir&&cf.containing_ns_path()===eT.ns_path&&!(this.in_search_mode()&&bW.sparky_search_ui_enabled)){return}if(!(eA.get_selected_files().length===1&&eA.get_selected_files().indexOf(eT)===0)){eA.deselect_all();eV=eT.get_div();if(eV){eV.addClassName("file-select")}}clearTimeout(this.folder_loading_timeout);this.folder_loading_timeout=setTimeout((function(eW){return function(){var eX;eX=ef("Loading %(filename)s...");eX=eX.format({filename:bG.em_snippet(eT.filename,50)});return eW.folder_loading_notification=ab.success(eX,60,true)}})(this),1000);if(eT.target_ns){T=eT.target_ns;eU=""}else{T=eT.ns_id;eU=eT.ns_path}if(eT.is_deleted){return aV.set_path_url(T,eU,true)}else{return aV.set_path_url(T,eU)}},open_folder_in_new_window:function(T){return window.open(aV._make_url(T.ns_id,T.ns_path),"_blank")},show_message:function(eU){var eT,T;if((typeof eU)!==(typeof"string")){T=$("browse-files").down(".browse-message");if(T){T.show()}return}this.msg=eU;eT=new Element("div",{"class":"browse-message"});eT.__date(eU);return $("browse-files").__sert(eT)},sort:function(eT,eW,T,eV){var eU;if(!eV&&eT===this.last_sort[0]&&eW===this.last_sort[1]){return}this.last_sort=[eT,eW,T];eU=eT(eW);this.files.sort(eU);this.smartfill();aW.load_visible_thumbs();return this.fire_visible_change_callbacks()},resort:function(){var eV,T,eU,eT;T=this.last_sort;eU=T[0];eV=T[1];eT=T[2];return this.sort(eU,eV,eT,true)},in_search_mode:function(){return br("#browse").hasClass("search")},flex_column:function(){if(this.show_shared_with){return $("sharing-sorter").readAttribute("data-sort")}else{return $("kind-sorter").readAttribute("data-sort")}},smartfill:function(){var eT,eW,eU,eX,eV,eZ,T,eY;eT=$("browse-files");eV=[];eX=this.in_search_mode();eY=this.files;for(eZ=0,T=eY.length;eZ<T;eZ++){eW=eY[eZ];eU=this.flex_column();eV.push(this.compiled_tmpl({file:eW,in_search_mode:eX,flex_column:eU,sharing_growth_experiments_variant:cf.sharing_growth_experiments_variant,share_link_icon_src:aW.get_shared_link_icon(),Browse:cf,Sprite:cj,Constants:Constants,FilePath:au,Emstring:bG,_:ef}))}eT.__date(eV);document.fire(this.RENDER_EVT);return br(document).trigger(this.RENDER_EVT)},search_smartfill:function(e0,eU){var T,eZ,eX,eT,eW,eV,eY;if(eU==null){eU=null}eW=[];for(eV=0,eY=e0.length;eV<eY;eV++){eZ=e0[eV];eT=aW.make_browsefile(eZ,eU);eT.track_in_browse();eX=this.compiled_search_tmpl({file:eT,sharing_growth_experiments_variant:cf.sharing_growth_experiments_variant,share_link_icon_src:aW.get_shared_link_icon(),BrowseInterface:eR,Browse:cf,Sprite:cj,Constants:Constants,_:ef,searchHelpers:ak,HTML:eP,FilePath:au,Emstring:bG,Util:dL});T=br(eX.toHTML());eW.push(T)}br("#browse-files").append(eW);document.fire(this.RENDER_EVT);br(document).trigger(this.RENDER_EVT);aW.load_visible_thumbs();return this.fire_visible_change_callbacks()},add_file:function(T){this.files.push(T);if(T.target_ns){cf.ns_id_to_mount_point[T.target_ns]=T.fq_path}if(T.bytes<0){return this.deleted_shown=true}},insert_file:function(eU,eT){var T;if(!eU){return}eT=eT||0;T=this.find_file(eU.fq_path);if(T&&T!==eU){this.remove_file(T)}cD._file_index[eU.to_key()]=eU;this.update_file_pos(eU);if(eT){eU.get_div().setStyle({display:"none"})}return document.fire(this.RENDER_EVT)},add_files:function(T){return cf._push_files(T.file_info)},get_file_pos:function(T){var eT;eT=this.files.indexOf(T);cw(eT!==-1,"file not present in @files");cw(T.to_key() in cD._file_index,"file not present in BrowseFile._file_index");return eT},remove_file:function(T){var eU,eT;if(!T){return}eU=this.files.indexOf(T);if(eU!==-1){this.files.splice(eU,1);delete cD._file_index[T.to_key()];return(eT=T.get_div())!=null?eT.remove():void 0}},update_file_pos:function(eX,eZ){var T,e1,eV,eW,eY,eU,eT,e0;if(eZ==null){eZ=-1}e0=this.files.indexOf(eX);if(e0!==-1){this.files.splice(e0,1)}delete eX.sort_rank;eU=this.last_sort[0];eY=this.last_sort[1];if(eZ>=0){e0=eZ}eW=this.in_search_mode()&&bW.sparky_search_ui_enabled?e0:dL.bsearch(this.files,eX,eU(eY),true);this.files.splice(eW,0,eX);eV=eX.get_div();T=$("browse-files");if(eV){eV.remove()}if(this.in_search_mode()&&bW.sparky_search_ui_enabled){eT=this.compiled_search_tmpl({file:eX,Browse:cf,BrowseInterface:eR,Constants:Constants,Emstring:bG,FilePath:au,HTML:eP,Search:__CIRCULAR_DEPENDENCY__.Search,Sprite:cj,Util:dL,_:ef})}else{eT=this.compiled_tmpl({file:eX,in_search_mode:this.in_search_mode(),flex_column:this.flex_column(),sharing_growth_experiments_variant:cf.sharing_growth_experiments_variant,share_link_icon_src:aW.get_shared_link_icon(),Browse:cf,Constants:Constants,Emstring:bG,FilePath:au,Sprite:cj,_:ef})}e1=T.childElements();if(eW<e1.length){return T.childElements()[eW].__sert({before:eT})}else{return T.__sert(eT)}},find_file:function(T){return this.files.find(function(eT){return eT.fq_path.toLowerCase()===T.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];cD._file_index={};return bD._body_dragend()},clear:function(){$("browse-files").__date();this.hide_empty();return bW.hide_empty()},show_empty:function(){var T;this.hide_empty();if(br("#browse-empty-team-folder").length&&this.inside_team_folder&&!this.is_in_subfolder_of_team_folder()){T="#browse-empty-team-folder"}else{T="#browse-empty"}br(""+T+" .drag-prompt").toggle(!this.is_read_only);if(!(cf.in_search_mode()&&bW.sparky_search_ui_enabled)){return br(T).show()}},hide_empty:function(){return br("#browse-empty, #browse-empty-team-folder").hide()},update:function(T,eT){if(eT==null){eT=null}$("browse-box").show();if(bW.sparky_search_ui_enabled&&this.in_search_mode()){return this.search_smartfill(T.file_info,eT)}else{this.clear();if(typeof T==="string"){T=JSON.parse(T)}this.setup(T,eT);this.resort();document.fire(this.UPDATE_EVT);return br(document).trigger(this.UPDATE_EVT)}},show_inline_sharing_on_browse_exp:function(){var eU,eX,eT,eW,T,eV;if(!cf.show_inline_share){return}if(this.in_search_mode()){br("#browse-box").removeClass("show-inline-share");return}br("#browse-box").addClass("show-inline-share");eV=cf.files;for(eW=0,T=eV.length;eW<T;eW++){eU=eV[eW];eT=br(eU.get_div()).find(".sharing");eT.find(".recipients").off().on("click",eA.recipients_click);if((eU.is_shared_folder()||eU.could_be_shared_folder())&&!(eU.read_only||eU.is_read_only_mount)){eX=ef("Who do you want to collaborate on this folder with?")}else{if(eU.type===bU.FOLDER){eX=ef("Who do you want to send this folder to?")}else{eX=ef("Who do you want to send this file to?")}}eT.find(".recipients").attr("placeholder",eX);eT.find(".get-link").off().on("click",eA.link_click)}if(!this.show_sharing_init_done){this.show_sharing_init_done=true;return aQ.init()}},reset_browse_exp:function(){var T;T=br("#browse-inline-autocomplete");T.hide().off();br("#browse-sort").append(T);return br("#browse-box").removeClass("dropdown-menu-open")},reload_fqpath:function(eT,T){return this.reload(null,dL.urlquote(eT),T)},force_reload:function(){return this.reload(this.containing_ns_id(),dL.urlquote(this.containing_ns_path()),true)},set_title:function(){var T;if(cf.in_search_mode()){bW.set_title();return}if(!cf.inside_dir){return}T=this.containing_fq_path();return document.title=T?au.filename(T)+" - Dropbox":cy.get_viewer().is_paired&&cf.active_user.role===Constants.ROLE_WORK?cy.get_viewer().team_name+" - Dropbox":cy.get_viewer().is_paired&&cf.active_user.role===Constants.ROLE_PERSONAL?ef("Personal")+" - Dropbox":ef("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(e0){var eU,eT,eY,eX,T,eV,eW,eZ;T=e0.select_fq_paths;eV=e0.select_index;if(T||eV>-1){eT=[];if(T){for(eW=0,eZ=T.length;eW<eZ;eW++){eY=T[eW];eX=this.find_file(eY);if(eX){eT.push(eX)}}}if(!eT.length&&eV>-1){eU=this.files[eV];if(eU){eT.push(eU)}}if(eT.length){eA.set_selected_files(eT);this.scrollToWithPadding(eT.first().get_div(),100)}e0.select_fq_paths=false;return e0.select_index=-1}else{if(!bW.sparky_search_ui_enabled){return window.scrollTo(0,0)}}},set_selection_from_item_counters:function(){var eT,eZ,eW,e1,eX,eV,e0,T,eY,eU;if(this.select_item_counters!=null){eW={};eY=this.select_item_counters;for(eX=0,e0=eY.length;eX<e0;eX++){eZ=eY[eX];eW[eZ]=true}e1=[];eU=this.files;for(eV=0,T=eU.length;eV<T;eV++){eT=eU[eV];if(eT.root_coll_item_counter in eW){e1.push(eT)}}eA.set_selected_files(e1);return this.select_item_counters=null}},reload:function(eV,e0,eT){var e2,eW,e1,eU,eY,eX,eZ,T;eU="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+e0+")";cw(e0.search(ei.URL_ESCAPE_REGEX)===-1,eU);if(eV==null){eV=cf.active_user.root_ns}e0=au.normalize(e0);if(aW.get_mode()!==aW.BROWSE_MODE){this.clear();aW.set_browse_mode()}if(bW._clear_on_reload){bW.clear_searchbox()}if(!al.uploading){cL.hide()}this._stop_pagination();if(this.reloading){return}if(this.inside_dir&&e0===this.containing_ns_path()&&eV===this.containing_ns_id()&&!eT){return}eZ=this.first_load?Constants.referrer:"";e1=this.deleted_shown?"?show_deleted=yes":"";eX={ns_id:eV,referrer:eZ,delays_parent_request_rendering:this.first_load,sort_label:this.last_sort[2],sort_is_ascending:this.last_sort[1]};eX=Object.extend(eX,this.extra_reload_args);em("Browse.reload:",e0);this.reloading=true;T="/browse"+e0+e1;e2=2;eW=["browse",eV,e0,e1,cf.active_user.id,e2];eY=(function(e3){return function(e4){e3.reset_state();e3.update(e4);(e3.files.length?e3.hide_empty.bind(e3):e3.show_empty.bind(e3))();clearTimeout(e3.folder_loading_timeout);if(ab.isShown()&&ab.current()===e3.folder_loading_notification){ab.clear()}z.scroll_clear_cache();e3.set_selection_from_fq_paths_or_index(cf);if(!l.shown()){return e3.set_title()}}})(this);new Ajax.DBRequest(T,{allow_retries:true,subject_user:cf.active_user,parameters:eX,log_timing:true,on304:(function(e3){return function(e4){}})(this),onSuccess:(function(e3){return function(e9){var e7,e4,fc,e5,e8,fb,e6,fa;if(e3.in_search_mode()){return}fc=JSON.parse(e9.responseText);fb=null;e8=null;eY(fc);if(fb){e5=[];for(e6=0,fa=fb.length;e6<fa;e6++){e7=fb[e6];e5.push(cf.find_file(e7.fq_path))}eA.set_selected_files(e5);window.scrollTo(e8[0],e8[1])}else{cf.set_selection_from_item_counters()}if(cf.sharing_autoselect_first_file_enabled&&!eA.has_selected_files()){e4=e3.files[0];return eA.set_selected_files([e4])}}})(this),onFailure:(function(e3){return function(){aD.update_with_error();if(e3.first_load){e3.reload.bind(e3).defer(Constants.root_ns,"")}return clearTimeout(e3.folder_loading_timeout)}})(this),cleanUp:(function(e3){return function(){e3.first_load=false;return e3.reloading=false}})(this),no_feed_reload:true,evalJSON:false});return true},is_in_subfolder_of_shared_folder:function(){return cf.inside_shared_folder&&cf.containing_ns_path()},is_in_subfolder_of_team_folder:function(){return cf.inside_team_folder&&cf.containing_ns_path()},is_shmodelable_path:function(T){var eT;if(cf.public_app_token){return false}if(T===""){return false}if(cf.public_folder_enabled){eT=T.toLowerCase();if(eT.startsWith("/public/")){return false}}return true},can_get_details_from_fq_path:function(eU){var eT,T;eT=this.containing_fq_path();T=this.containing_mount_point();return(T&&eU.startsWith(T))||eT.startsWith(eU)},details_from_fq_path:function(eV){var eW,eT,T,eU;cw(this.can_get_details_from_fq_path(eV));eT=this.containing_mount_point();if(eT&&eV.startsWith(eT)){T=this.containing_ns_id();eU=eV.slice(eT.length);eW=au.filename(eV,this._get_root_name())}else{T=Constants.root_ns;eU=eV;eW=au.filename(eV,this._get_root_name())}return{ns_id:T,ns_path:eU,fq_path:eV,folder_name:eW||this._get_root_name(),url:String(eR.browse_uri_for_fq_path(cf.active_user,eV)),icon:(eV.length?"folder_32":this._get_root_icon())}},update_header_status:function(T){return br("#browse-header-status").text(T)},update_header_height:function(){var eT,eV,eU,T;eV=br("#browse-header");eT=br("#browse-files");T=0;if(eV.css("position")==="fixed"){T=br(window).scrollTop()}if(!z.is_page_scrollable()){T=Math.abs(parseFloat(br("html").css("top"))||0)}eU=eV.offset().top+eV.height()-eT.offset().top-T;return eT.css("padding-top",eU)},_make_breadcrumbs_data:function(){var eX,eY,eT,eW,T,eV,eU;eY=this.containing_fq_path();eX=[];T=eY.split("/");for(eT=eV=0,eU=T.length;0<=eU?eV<eU:eV>eU;eT=0<=eU?++eV:--eV){eW=au.normalize(T.slice(0,eT+1).join("/"));eX.push(this.details_from_fq_path(eW))}return eX},_get_root_icon:function(){if(!cy.get_viewer().is_paired){return"glyph"}if(cf.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(cf.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return cy.get_root_name(cf.active_user)},_get_max_breadcrumb_width:function(eV){var eT,eU,T;eU=eV?this._DROPDOWN_WIDTH:new bG(this._get_root_name()).length;if(this.use_shorter_breadcrumbs){eT=br("#browse-rightmenu").width();T=br("#browse-global-actions-bar").width();return((T-eT)*this._FUDGE_FACTOR/this._PX_TO_EM)-eU}else{return this._MAX_BREADCRUMB_WIDTH-eU}},_PX_TO_EM:16,_FUDGE_FACTOR:0.75,_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var e1,eT,eV,e2,eY,e0,T,e3,eZ,eU,eW,eX;eT=this._make_breadcrumbs_data();eU=eT.collect(function(e4){return new bG(e4.fq_path?e4.folder_name:"").length});eZ=0;eV=0;cw(eT.length>0,"expected at least one breadcrumb");e3=this._get_max_breadcrumb_width();for(eY=eW=eX=eT.length-1;eX<=0?eW<=0:eW>=0;eY=eX<=0?++eW:--eW){eZ+=eU[eY];if(eZ>e3){break}eV+=1;eZ+=this._CONNECT_WIDTH}e2=eT.slice(0,eT.length-Math.max(1,eV));eT=eT.slice(e2.length,eT.length);if(!e2.length&&eT.length>1){eT.shift()}e0=eT.pop();e1=eP.tmpl("breadcrumb_tmpl",{breadcrumbs:eT,dropdown:e2,containing_fq_path:this.containing_fq_path(),url_root:eR.get_browse_root(cf.active_user),root_name:this._get_root_name(),Sprite:cj});T=e0.folder_name;if(e0.fq_path!==""){T=bG.em_snippet(T,this._get_max_breadcrumb_width(e2.length>1))}$("browse-location").__date(e1);$("browse-location").__sert(" "+T);if(e2.length>1){return this._render_breadcrumbs_dropdown(e2)}},_render_breadcrumbs_dropdown:function(eW){var T,eU,eT,eV;T=$("breadcrumbs-box");eW.reverse();eT=eP.tmpl("breadcrumb_li_tmpl",{breadcrumbs:eW,Sprite:cj,Emstring:bG});$("browse-location").__sert(eT);eU=$("breadcrumb-dropdown");eV=(function(eX){return function(eZ){var eY;eZ.stopPropagation();eU.show();eY=br(T);return br(eU).clonePosition(eY,{setWidth:0,setHeight:0,offsetTop:eY[0].offsetHeight,offsetLeft:parseInt(eY.css("padding-left"),10)})}})(this);T.observe("click",eV);T.observe("dragover",eV);return document.observe("click",(function(eX){return function(){T.removeClassName("down");return eU.hide()}})(this))},viewportOffset:function(){var T,eU,eT;if(!this.files.length){return}if(!this.div_parent){eU=this.files[0].get_div().offsetParent;if(!eU){return}this._viewportOffset={};this.div_parent=$(eU);this._cumulativeOffset=this.div_parent.cumulativeOffset()}T=dL.scrollLeft(this.div_parent);eT=dL.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==eT||this.scrollLeft!==T){this._viewportOffset.top=this._cumulativeOffset.top-eT;this._viewportOffset.left=this._cumulativeOffset.left-T;this.scrollLeft=T;this.scrollTop=eT}return this._viewportOffset},selectable:function(){return dL.enableSelection($("browse-files"))},unselectable:function(){return dL.disableSelection($("browse-files"))},_header_offset:(function(){var T;T=$("browse-header");return T.getHeight()+T.cumulativeOffset().top}).cached(1000),scrollTo:function(T){return this.scrollToWithPadding(T,3)},scrollToWithPadding:function(eV,eX){var eU,eY,eT,eW,T;if(!eV){return}eW=z.viewport_dimensions();T=z.scroll_offsets();eY=eV.cumulativeOffset().top-T.top;eU=eV.getHeight();eT=this._header_offset();if(eY<eT){z.scroll_to(0,T.top+eY-eT-eX)}else{if(eY+eU>eW.height){z.scroll_to(0,T.top+eY+eU-eW.height+eX)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return eM.fix_position()}},_visible_change_callbacks:{},_next_visible_change_callback_id:0,add_visible_change_callback:function(T){this._visible_change_callbacks[this._next_visible_change_callback_id]=T;return this._next_visible_change_callback_id++},remove_visible_change_callback:function(T){return delete this._visible_change_callbacks[T]},fire_visible_change_callbacks:function(){var eU,eY,eV,eX,eW,T,eT;if(!br.isEmptyObject(this._visible_change_callbacks)){eW=aW.get_files_in_view(),eX=eW[0],eU=eW[1];T=this._visible_change_callbacks;eT=[];for(eV in T){eY=T[eV];eT.push(eY(this.files,this.active_user.id,eX,eU))}return eT}}};j=B.BrowseUpdate=(function(){var T,eZ,eY,eV,eX,eW,eU,eT;eU=function(e1){var e2,e3,e0;if(!cf.inside_dir){return}e3=e1.parent_changes;if(e3.change_to_fq_path!=null){if(e3.change_type==="moved"){if(e3.is_changing_view){e2=ef("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");e2=e2.format(e3.old_fq_path.escapeHTML(),dL.urlquote(e3.new_fq_path))}else{e2=ef("This folder has been moved")}}else{if(e3.change_type==="renamed"){if(e3.is_changing_view){e2=ef("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");e2=e2.format(e3.old_fq_path.escapeHTML(),dL.urlquote(e3.new_fq_path))}else{e2=ef("This folder has been renamed to '%s'.");e0=e3.change_to_fq_path.split("/");e2=e2.format(e0[e0.length-1].escapeHTML())}}else{e2=ef("The folder '%s' has been deleted.");e2=e2.format(e3.old_fq_path.escapeHTML())}}if(e3.is_changing_view){ab.error(new eP(e2))}else{if(e3.old_fq_path===cf.containing_fq_path()){ab.success(new eP(e2))}}cf.reload_fqpath(e3.change_to_fq_path);return}return eW(e1)};eT=function(e5){var e1,e8,e7,e0,fa,e6,e3,e9,e4,e2;e8=[];e6=[];if(!cf.in_search_mode()){return}bW.clear_cache();for(e0 in cf.ns_id_to_mount_point){if(!(e0 in e5.mount_points)){e5.mount_points[e0]=null}}e4=e5.mount_points;for(e0 in e4){e7=e4[e0];e0=parseInt(e0,10);fa=cf.ns_id_to_mount_point[e0];if(e7===fa){continue}if(e7){cf.ns_id_to_mount_point[e0]=e7}else{delete cf.ns_id_to_mount_point[e0]}e2=cf.files;for(e3=0,e9=e2.length;e3<e9;e3++){e1=e2[e3];if(e1.fq_path.indexOf(fa)===0&&e1.target_ns!==e0){if(e7){e1.fq_path=e7+e1.fq_path.slice(fa.length);e1.href=eR.get_browse_root(cf.active_user)+e7+e1.href.slice(5+fa.length);e8.push([e1,e1])}else{e6.push(e1)}}}}return eW(e5,[],e6,e8)};eW=function(fn,e8,fh,e7){var fc,e6,fi,fd,fg,e9,ff,fe,fk,fa,e3,e1,e0,fj,fm,fl,fb,e5,e4,e2;if(e8==null){e8=[]}if(fh==null){fh=[]}if(e7==null){e7=[]}fb=fn.added;for(e3=0,fj=fb.length;e3<fj;e3++){fi=fb[e3];e6=au.normalize(au.parent_dir(fi.ns_path));if(cf.in_search_mode()||(fi.ns_id===cf.containing_ns_id()&&e6===cf.containing_ns_path())){fc=aW.make_browsefile(fi);fc.track_in_browse();e8.push(fc)}}e5=fn.removed;for(e1=0,fm=e5.length;e1<fm;e1++){fd=e5[e1];fh.push(cf.find_file(fd))}e4=fn.moved;for(e0=0,fl=e4.length;e0<fl;e0++){e2=e4[e0],fg=e2[0],fa=e2[1];fk=au.normalize(au.parent_dir(fa.ns_path));fe=null;ff=cf.in_search_mode()||(fa.ns_id===cf.containing_ns_id()&&fk===cf.containing_ns_path());e9=cf.in_search_mode()&&bW.sparky_search_ui_enabled;if(ff&&!(e9&&cf.find_file(fa.ns_path))){fe=aW.make_browsefile(fa);fe.track_in_browse()}e7.push([cf.find_file(fg),fe])}document.fire(bq.ADD,{files:e8});br(document).trigger(bq.ADD,{files:e8});document.fire(bq.MOVE,{files:e7});aW.load_visible_thumbs();cf.fire_visible_change_callbacks();return eX(e8,fh,e7)};T=function(e3,e1,e2,e0){e3.css("background","");br(document).trigger("db:browse:update_rendered");return document.fire(bq.REMOVE,{files:e2})};eX=function(fa,e9,fb){var e2,fd,e7,fe,e6,e5,e3,fc,e1,e0,e8,e4;e7=(fa.length+e9.length)<=10;for(e6=0,fc=fa.length;e6<fc;e6++){e2=fa[e6];if(!(e2&&e2.get_div())){continue}eZ(e2,e7,fa,e9,fb)}for(e5=0,e1=e9.length;e5<e1;e5++){e2=e9[e5];if(!(e2&&e2.get_div())){continue}eV(e2,e7,fa,e9,fb)}e4=[];for(e3=0,e0=fb.length;e3<e0;e3++){e8=fb[e3],fd=e8[0],fe=e8[1];if(fd){eV(fd,e7,fa,e9,fb)}if(fe){e4.push(eZ(fe,e7,fa,e9,fb))}else{e4.push(void 0)}}return e4};eY=function(e0){var e1;e1=eA.is_selected(e0)?"#83B8DC":"#CCEAFF";return br(e0.get_div()).css("background-color",e1)};eV=function(e0,e3,e2,e4,e1){var e5;eY(e0);e5=br(e0.get_div());if(e3){return e5.show().slideUp("normal",function(){return T(e5,e2,e4,e1)})}else{e5.hide();return T(e5,e2,e4,e1)}};eZ=function(e0,e3,e2,e4,e1){var e5;eY(e0);e5=br(e0.get_div());if(e3){return e5.hide().slideDown("normal",function(){return T(e5,e2,e4,e1)})}else{e5.show();return T(e5,e2,e4,e1)}};return{init:function(){var e2,e1,e0;e0=O[cf.active_user.id];e2=(function(e3){return function(){return aD.refresh_file_list(cf.files)}})(this);document.observe(cf.UPDATE_EVT,e2);return e1=e0.subscribe_sfj({name:"BrowseUpdater",handler:function(){var fb,e6,e8,fa,e7,fc,e5,e4,e3,e9;fc=cf.in_search_mode();fb=fc?eT:eU;e3=fc?"/update/list_search":"/update/list_dir";if(!(cf.inside_dir||fc)){e0.handler_failure(e1);return}if(fc){e4=bW.get_state();if(e4.is_advanced){e7=e4}else{e7={all_terms:e4.query}}}else{e7={fq_dir:cf.containing_fq_path(),show_deleted:cf.deleted_shown}}e7.ns_map=((function(){var fe,fd;fe=e0.get_ns_map();fd=[];for(fa in fe){e5=fe[fa];fd.push(""+fa+"_"+e5)}return fd})()).join(",");cw(cf.active_user,"No active_user was set before calling "+e3+". Active user loaded? "+(__CIRCULAR_DEPENDENCY__.active_user_loaded||false)+". Error before loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_before_loading||false)+". Error after loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_after_loading||false)+".",true,[],false);e9=cf.subscribe_sfj_callbacks;for(e8 in e9){e6=e9[e8];e6()}return new br.ajax(e3,{data:e7,dataType:"json",type:"POST",subject_user:cf.active_user,success:(function(fd){return function(fe){fb(fe);return e0.handler_success(e1,{ns_map:fe.ns_map})}})(this),error:function(){return e0.handler_failure(e1)}})}})}}})();var aB;aB=B.FileEvents={DELETE:"db:bulk_delete",COPY:"db:bulk_copy",MOVE:"db:bulk_move",RENAME:"db:bulk_rename",PURGE:"db:bulk_purge",RESTORE:"db:bulk_restore",UPLOAD:"db:upload",SF_NEW:"db:sf_new",SF_LEAVE:"db:sf_leave",SF_UNSHARE:"db:sf_unshare",SF_REJOIN:"db:sf_rejoin",SF_INVITE:"db:sf_invite",SF_IGNORE:"db:sf_ignore",LINKS_REMOVE:"db:link_remove",LINKS_ADD:"db:link_add"};var dR;dR=B.ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(T,eW){var eV,eU,eT;if(T.async_task_id){if(!T.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}eU=T.async_task_id}else{eU=T.job_id}dR.job_info[eU]={};eV=dR.job_info[eU];eV.subject_user=T.subject_user||((eT=T.parameters)!=null?eT[Constants.UID_PARAM_NAME]:void 0);eV.req=T;eV.is_async_task=!!T.async_task_id;eV.poll_int=dR.INIT_POLL_INT;eV.poll_count=0;eV.int_id=setInterval(dR.update_for(eU),eV.poll_int);eV.failures=0;eV.start_time=bR.time();return eV.dont_hide=eW},update_for:function(T){return function(){return dR.update(T)}},backoff:function(eT){var T;T=dR.job_info[eT];clearInterval(T.int_id);T.poll_int=Math.min(Math.floor(T.poll_int*1.5),30000);return T.int_id=setInterval(dR.update_for(eT),T.poll_int)},update:function(eU){var T,eT;eT=dR.job_info[eU];if(c1.peek(eU)){return dR.done(eU)}eT.poll_count++;if(eT.poll_count%10===0){dR.backoff(eU)}if(!eT.modaled&&bR.time()-eT.start_time>dR.MODAL_WAIT_MS){T=eT.req.options;eg.show(T.progress_text);T.onProgress=eg.update;if(T.on_modal_shown!=null){T.on_modal_shown()}eT.modaled=true}if(eT.is_async_task){return dR.get_async_task_status(eU)}else{return dR.get_job_status(eU)}},get_job_status:function(T){return new Ajax.DBRequest("/job_status/"+T,{method:"post",subject_user:dR.job_info[T].subject_user,onSuccess:function(eU){var eV,eT;eV=dR.job_info[T];eT=eU.responseText;if(eT.indexOf("err")===0){dR.done(T);if(eV.req.options.onFailure&&!c1.handled(T)){eV.req.options.onFailure(eU)}return}if(eT.indexOf("done")===0){eV.req.options.job=false;if(!c1.peek(T)){new Ajax.Request("/job_results/"+T,{method:"post",parameters:{t:bk.read(Constants.JS_CSRF_COOKIE)},onSuccess:function(eX){if(c1.handled(T)){return}am.clearWorkingMessage();if(eV.req.options.onSuccess){return eV.req.options.onSuccess(eX)}},onFailure:function(eX){if(c1.handled(T)){return}am.clearWorkingMessage();if(eV.req.options.onFailure){return eV.req.options.onFailure(eX)}}})}return dR.done(T)}else{try{if(eV.req.options.onProgress){return eV.req.options.onProgress(eU.responseText)}}catch(eW){}}},onFailure:function(eT){var eU;eU=dR.job_info[T];eU.failures++;if(eU.failures>=dR.FAILS_MEAN_FAIL){if(eU.req.options.onFailure){eU.req.options.onFailure(eT,true)}am.remove(eU.req);return dR.done(T)}}})},get_async_task_status:function(T){return new Ajax.DBRequest("/async_task_status/"+T,{method:"post",subject_user:dR.job_info[T].subject_user,onSuccess:function(eU){var eV,eT;eV=dR.job_info[T];eT=eU.responseText;if(eT.indexOf("done:")===0||eT.indexOf("err:")===0){c1.handled(T);am.clearWorkingMessage();if(eT.indexOf("done:")===0){eU.responseText=eT.substr(5)}if(eV.req.options.onSuccess){eV.req.options.onSuccess(eU)}if(eV.req.options.onComplete){eV.req.options.onComplete(eU)}return dR.done(T)}else{if(eT.indexOf("async_task_err:")===0){ab.error(new eP(eT.substr(15)));c1.handled(T);am.clearWorkingMessage();dR.done(T);return cf.force_reload()}else{try{if(eV.req.options.onProgress){return eV.req.options.onProgress(eU.responseText)}}catch(eW){}}}},onFailure:function(eT){var eU;eU=dR.job_info[T];eU.failures++;if(eU.failures>=dR.FAILS_MEAN_FAIL){try{if(eU.req.options.onFailure){eU.req.options.onFailure(eT,true)}}catch(eV){}am.remove(eU.req);return dR.done(T)}}})},done:function(eT){var T;T=dR.job_info[eT];clearInterval(T.int_id);if(!T.dont_hide){delete dR.job_info[eT];if(!(T.req.async_task_id&&T.req.async_task_id!==eT)){return eg.hide(eT)}}else{return eg.update("1/1")}}};var c8,bL,bp,bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1};bp=B.NamespaceEvents=(function(){function T(eT){this.ns_id=eT;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return T})();c8=B.EventDatePicker=(function(){function T(eU){var eT,eV,eW;this.on_change=eU;br(document.body).on("click",(function(eX){return function(eY){return eX.hide_calendar(eY)}})(this));eW=new Element("div",{id:"cal_container"});br(eW).bind("click",function(eX){return eX.preventDefault()});br(document.body).append(eW);this.calendar=new F("cal_container",{onDateChange:(function(eX){return function(eY){return eX.on_change(eY)}})(this),disable_future:true});br(eW).css("position","fixed");eV=br("#cal_date");eT=br("#cal_container");eT.clonePosition(eV,{setWidth:false,setHeight:false,offsetTop:eV.height(),offsetLeft:eV.width()-eT.children().first()[0].offsetWidth});this.hide_calendar()}T.prototype.show_calendar=function(eT){if(this.shown){br("#cal_container").hide();this.shown=false;return}br("#cal_container").show();return this.shown=true};T.prototype.hide_calendar=function(eT){if(eT&&br(eT.target).closest("#cal_date").length>0){return}br("#cal_container").hide();this.shown=false;return true};return T})();bL=INLINE_JS.Events=B.Events={ns:null,role:"all",now:Number(new Date()),timestamp:dL.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(T,eX,eZ,eU,eY){var eV,eW,eT;if(eY==null){eY=false}eT=ei.deconstruct_url();this.first_event_map=T;this.roles=eX;this.rss_data=eZ;this.role_has_events=eU;this.for_deleted_files_page=eY;this.role_picker=br("#role-selector").controller();if(this.roles.length===1){this.role=this.roles[0].role}else{if(eT.qargs.role){this.role=eT.qargs.role;this.role_picker.set_state(this.role)}}this.date_picker=new c8((function(e0){return function(e1){e0.change_date(e1);e0.set_url();return a0.WebMiscActivityLogger.log("filter_events_date")}})(this));this._init_state();this.role_picker.on_state_change=(function(e0){return function(){e0.role=e0.role_picker.get_state();if(e0.ns&&!$u(e0.valid_roles()).any(function(e1){return e1.ns_ids.contains(e0.ns.ns_id)})){e0.ns=null;aI.set_selected_by_value(br("#namespace-list")[0],"false")}e0.set_url();return e0.get_more(true)}})(this);bB.set_during_login_callback((function(e0){return function(e2,e1){return window.location.reload()}})(this));br(window).bind("beforeunload",(function(e0){return function(){e0.user_navigated_away=true;return void 0}})(this));if(br("#namespace-list-container")[0]){br("#namespace-list-container")[0].observe("db:change",(function(e0){return function(e1){e0.ns=e0.namespaces[JSON.parse(e1.memo)];e0.set_url();e0.get_more(true);return a0.WebMiscActivityLogger.log("filter_events_shared_folder")}})(this))}br(window).on("scroll",(function(e0){return function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-z.viewport_dimensions().height-10);return e0.get_more()}})(this));if(eT.qargs.ns){aI.set_selected_by_value(br("#namespace-list")[0],eT.qargs.ns);this.ns=this.namespaces[eT.qargs.ns]}if(eT.qargs.date){eW=eT.qargs.date.split("-").map(Number);eV=new Date(eW[2],eW[1]-1,eW[0]);this.date_picker.calendar.selected_date=eV;this.change_date(eV)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var eT,eW,eZ,eX,eV,eU,eY,T;this.namespaces={};eY=$u(this.roles).values();for(eZ=0,eV=eY.length;eZ<eV;eZ++){eW=eY[eZ];T=eW.ns_ids;for(eX=0,eU=T.length;eX<eU;eX++){eT=T[eX];this.namespaces[eT]=new bp(eT)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(T){this.timestamp=Number(T)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}br("#cur_date_text").text(K.localize(T));return this.get_more(true)},is_scrolled_down:function(){var T,eU,eT;eT=z.scroll_offsets().top;eU=z.viewport_dimensions().height;T=br("#events").height();return eT+eU+50>=T},get_more:function(eV){var T,eT,eU;if(this.request_in_flight){return}if($u(this.valid_nss()).all(function(eW){return eW.done})){this.render();return}if(!(eV||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();eT=(function(eW){return function(){return $u(eW.valid_nss()).map(function(eX){return eX.ns_id}).join(",")}})(this);T=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));eU={page_size:25,ns_ids:eT(),timestamp:T};if(this.for_deleted_files_page){eU.for_deleted_files_page=true}return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:eU,onSuccess:(function(eW){return function(e9){var e7,eY,fa,e0,e8,e5,e4,e2,fb,eZ,eX,e6,e3,e1;e7=JSON.parse(e9.responseText);eW.request_in_flight=false;e6=e7.events;for(e5=0,fb=e6.length;e5<fb;e5++){eY=e6[e5];eY.html=br(eY.html)[0];e8=eY.pkey+" "+(eY.html.textContent||eY.html.innerText);fa=eW.namespaces[eY.ns_id];if(!fa.seen[e8]){fa.events.push(eY);fa.seen[e8]=true;fa.earliest=eY.timestamp}}if(e7.events.length>0){e3=e7.ns_ids;for(e4=0,eZ=e3.length;e4<eZ;e4++){e0=e3[e4];eW.namespaces[e0].earliest=$u(e7.events).map(function(fc){return fc.timestamp}).min()}}eW.render();if(e7.events.last()){eW.get_more()}else{if($u(e7.ns_ids).join(",")!==eT()){eW.get_more()}else{e1=e7.ns_ids;for(e2=0,eX=e1.length;e2<eX;e2++){e0=e1[e2];eW.namespaces[e0].done=true}}}return an.configureAllLinks("#event-table",".inline-restore","events")}})(this),onError:(function(eW){return function(){eW.request_in_flight=false;if(!eW.user_navigated_away){return ab.error(ef("We had problems loading your events feed; please try again later."))}}})(this)})},valid_roles:function(){if(this.role!=="all"){return $u(this.roles).filter((function(T){return function(eT){return eT.role===T.role}})(this))}else{return this.roles}},valid_nss:function(){if(this.ns){return[this.ns]}else{return $u(this.valid_roles()).map((function(T){return function(eT){return eT.ns_ids}})(this)).flatten().map((function(T){return function(eT){return T.namespaces[eT]}})(this)).uniq()}},earliest:function(){return $u(this.valid_nss()).map((function(T){return function(eT){return eT.earliest}})(this)).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){this.date_picker.calendar.options.first_day=dL.start_of_day(new Date($u(this.valid_nss()).map((function(T){return function(eT){return T.first_event_map[eT.ns_id]}})(this)).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=dL.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var eU,eV,eT,T;eT=new Date(this.timestamp-this.one_day);eV=this.now-this.timestamp>0;eU={};if(this.ns){eU.ns=this.ns.ns_id}if(this.role!=="all"){eU.role=this.role}if(eV){eU.date=""+(eT.getDate())+"-"+(eT.getMonth()+1)+"-"+(eT.getFullYear())}T=this.for_deleted_files_page?"/deleted_files":"/events";return ei.push_state(T,eU)},on_preview_open:function(eU){var eT,T;T=cy.get_viewer().get_user_by_id(eU.user_id);if(eU.preview_type==="photo"&&eU.large_thumbnail_url_tmpl){eT={filename:eU.filename,fq_path:eU.fq_path,thumbnail_url_tmpl:eU.large_thumbnail_url_tmpl,original_url:eU.href,ns_id:eU.ns_id,ns_path:eU.ns_path};aD.init([new V(eT)],{start_index:0})}else{br(document).on("db:filepreview:close",this.on_preview_close);l.show(eU,T,false)}return false},on_preview_close:function(){br(document).off("db:filepreview:close",this.on_preview_close);return document.title=ef("Recent events - Dropbox")},render:function(){var T,e8,fa,e9,e2,fb,e1,fe,e6,eU,e0,e4,eZ,e5,e7,eT,eY,eW,eV,fc,fd,e3,eX;if(this.role_has_events[this.role]){this.update_calendar_first_day()}T=$u(this.valid_nss()).map((function(ff){return function(fg){return fg.events}})(this)).flatten();e8=this.earliest();eT=$u(T).sortBy(function(ff){return -ff.timestamp});e2=$u(eT).filter((function(ff){return function(fg){return fg.timestamp>=e8&&fg.timestamp<ff.timestamp/1000&&(ff.ns!==null||!fg.is_dup)}})(this));if(this.role_has_events[this.role]){br("#event-table").empty();for(eW=0,fc=e2.length;eW<fc;eW++){e0=e2[eW];fa=br(e0.html);e4=$u(this.valid_roles()).filter((function(ff){return function(fg){return fg.ns_ids.contains(e0.ns_id)}})(this)).map((function(ff){return function(fg){return fg.name}})(this)).join(" & ");fa.find("span.role-label > span").text(e4);br("#event-table").append(fa);if(e0.preview_jsinfo!=null){e9=e0.preview_jsinfo;e1=fa.find("#prev_link");e1.on("click",this.on_preview_open.bind(this,e9));e7=fa.find(".inline-button");e7.on("click",this._inline_share_button.bind(this,e9))}}br("#events-container").show();br("#events-sub-header").show();br("#events-sub-header").css("visibility","visible");br("#events-empty-state").hide();br(".empty-explanation").hide()}else{if(!this.request_in_flight){br("#events-container").hide();br("#events-sub-header").hide();br("#events-empty-state").show();br(".empty-explanation").show()}}if(!this.request_in_flight){br("#more-loading").hide()}else{br("#more-loading").show()}br("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");e3=br("#namespace-list > li");for(eV=0,fd=e3.length;eV<fd;eV++){fb=e3[eV];eU=$u(this.valid_roles()).map((function(ff){return function(fg){return fg.ns_ids}})(this)).flatten().any((function(ff){return function(fg){return fg===br(fb).data("value")}})(this));e6=br(fb).data("value")===false;eY=e6||eU;br(fb).css("display",eY?"":"none")}e5=bx.call((function(){var fi,fg,ff,fh;ff=this.valid_roles();fh=[];for(fi=0,fg=ff.length;fi<fg;fi++){fe=ff[fi];fh.push(fe.ns_ids.length>1)}return fh}).call(this),true)>=0;if(!this.request_in_flight){if(e5){br("#namespace-list-container").css("visibility","visible");br("#namespace-list-container").show()}else{br("#namespace-list-container").hide()}eZ=this.rss_data[(eX=this.ns)!=null?eX.ns_id:void 0]||this.rss_data[this.role];if(eZ&&this.role_has_events[this.role]){br("#rss-feed a").attr("data-title",eZ.title);br("#rss_url").val(eZ.url);br("#reset-rss-link").on("click",(function(ff){return function(fg){new Ajax.DBRequest("/reset_rss",{parameters:{ns_id:eZ.ns_id},onSuccess:function(){ab.success(ef("RSS feed url successfully reset."));return bO.redirect("/events")}});return false}})(this));br("#rss_url").focus();br("#rss-feed").show();return br("#rss-feed").css("visibility","visible")}else{return br("#rss-feed").hide()}}},show_rss_modal:function(){var T,eT;eM.show(ef("Subscribe to this RSS feed"),br("#rss-modal")[0]);eT=br("#rss_url").val();T=q.clipboard_overlay(eT,br("#real_copy"),function(){ab.success(ef("Link copied to clipboard!"));return eM.hide()},br(".modal-buttons"));return T.css({zIndex:1001})},_inline_share_button:function(eT,eV){var T,eU;eV.preventDefault();T="events_table_row";eU=a0.ShmodelUILogger.get_target_item(eT);a0.ShmodelUILogger.log("single_entry_share",T,eU);return new cY(eT.user_id,eT.fq_path,T).show()}};var K;K=B.DateUtil={fromSecondsSinceEpochUTC:function(T){var eT;eT=new Date(1970,0,1);eT.setSeconds(T);return eT},applyTimezoneOffset:function(eT,eV){var T,eU;T=parseInt(eV,10);eU=60*(eV-T);eT.setHours(eT.getHours()+T);return eT.setMinutes(eT.getMinutes()+eU)},contextualFormat:function(eT){var eV,eX,T,eU,eW;T=new Date(Date.now());eU=(T.getTime()-eT.getTime())/1000;eV=0;if(eU<8*3600){return bR.ago(eT)}this.applyTimezoneOffset(T,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(eT,Constants.TIMEZONE_OFFSET);eW=new Date(Date.now());this.applyTimezoneOffset(eW,Constants.TIMEZONE_OFFSET);eW.setDate(eW.getDate()-1);if(eT.getYear()===T.getYear()&&eT.getMonth()===T.getMonth()&&eT.getDate()===T.getDate()){eX=ef("Today %(time)s");return eX.format({time:K.format(eT,Constants.time_format)})}else{if(eT.getYear()===eW.getYear()&&eT.getMonth()===eW.getMonth()&&eT.getDate()===eW.getDate()){eX=ef("Yesterday %(time)s");return eX.format({time:K.format(eT,Constants.time_format)})}else{return K.format(eT,Constants.datetime_format)}}},toUTCDate:function(T){return new Date(T.getUTCFullYear(),T.getUTCMonth(),T.getUTCDate(),T.getUTCHours(),T.getUTCMinutes(),T.getUTCSeconds(),T.getUTCMilliseconds())},differenceStr:function(eV,eY){var e0,eZ,eT,eU,eW,T,eX;eW=(eV.getTime()-eY.getTime())/1000;if(eW<60){return a1("%d sec","%d secs",eW).format(eW)}else{if(eW<3600){eT=parseInt(eW/60,10);return a1("%d min","%d mins",eT).format(eT)}else{if(eW<86400){eZ=parseInt(eW/3600,10);return a1("%d hour","%d hours",eZ).format(eZ)}else{if(eW<2592000){e0=parseInt(eW/(60*60*24),10);return a1("%d day","%d days",e0).format(e0)}else{if(eW<4838400){T=parseInt(eW/(60*60*24*7),10);return a1("%d week","%d weeks",T).format(T)}else{if(eW<31536000){eU=parseInt(eW/(60*60*24*30),10);return a1("%d month","%d months",eU).format(eU)}else{eX=parseInt(eW/(60*60*24*365),10);return a1("%d year","%d years",eX).format(eX)}}}}}}},localize:function(T){cw(Constants.date_format!=null,"Date format missing.");return K.format(T,Constants.date_format)},format:function(T,eT){var eU;cw(typeof eT==="string","Date format requires a format string");eU={yy:(function(eV){return function(){return T.getFullYear().toString().substring(2)}})(this),yyyy:(function(eV){return function(){return T.getFullYear().toString()}})(this),M:(function(eV){return function(){return(T.getMonth()+1).toString()}})(this),MM:(function(eV){return function(){return(T.getMonth()+1).toString().lpad(2)}})(this),d:(function(eV){return function(){return T.getDate().toString()}})(this),dd:(function(eV){return function(){return T.getDate().toString().lpad(2)}})(this),h:(function(eV){return function(){return(T.getHours()%12||12).toString()}})(this),H:(function(eV){return function(){return T.getHours().toString()}})(this),HH:(function(eV){return function(){return T.getHours().toString().lpad(2)}})(this),m:(function(eV){return function(){return T.getMinutes().toString()}})(this),mm:(function(eV){return function(){return T.getMinutes().toString().lpad(2)}})(this),a:(function(eV){return function(){if(T.getHours()>11){return ef("PM",{comment:"PM as in evening"})}else{return ef("AM",{comment:"AM as in morning"})}}})(this)};return eT.replace(/([a-zA-Z]+)/g,function(eV){if(eU[eV]!=null){return eU[eV]()}else{return eV}})}};var ev;ev=INLINE_JS.Timezone=B.Timezone={check_timezone:function(){var T;if(!cy.get_viewer().is_signed_in){return}T=ev.get_current_timezone();if((Constants.auto_timezone_offset==null)||Constants.auto_timezone_offset!==T){return ev.update(T)}},get_current_timezone:function(){var eV,eU,T,eT;eU=new Date();eU.setSeconds(0);eU.setMilliseconds(0);eT=eU.toGMTString();eV=new Date(eT.substring(0,eT.lastIndexOf(" ")));T=(eU-eV)/(1000*60*60);return T},update:function(T){cw(typeof T==="number","Timezone offset was not a number: "+T);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:T},noAutonotify:true})},update_timezones_dropdown:function(eT,eV){var eU,T;if(eV==null){eV=null}T=ev.timezones_by_country[eT];br("#timezone_id").empty();return br("#timezone_id").append((function(){var eY,eX,eW;eW=[];for(eY=0,eX=T.length;eY<eX;eY++){eU=T[eY];eW.push(br('<option value="'+eU.id+'">'+eU.name+"</option>").prop("selected",eU.id===eV))}return eW})())},auto:function(){var T;T=$F("timezone_auto");if(T){return br("#tz").hide()}else{if(ev.default_country){br("#timezone_country").val(ev.default_country);ev.update_timezones_dropdown(ev.default_country)}return br("#tz").show()}},load_data:function(eT,T){ev.timezones_by_country=eT;return ev.default_country=T}};var a6,bw;bw=B.CreateApp={init:function(eV,eT){var eU,eW,T;this.accepted_tos_by_uid=eV;this.form=eU=br("#create-app-form");this.email_verification=null;if(!cy.get_viewer().is_paired){T=cy.get_viewer().get_users()[0];this.select_user(T.id)}eW=(function(eX){return function(eY){var eZ;eZ=eY.target.name;return eU.find("input[name="+eZ+"]").each(function(){br(this).parents("label").removeClass("active");return eU.removeClass(br(this).data("next"))})}})(this);eU.find("input[type=radio]").change(function(eX){eW(eX);br(eX.target).parents("label").addClass("active");return eU.addClass(br(this).data("next"))});eU.find("input[type=checkbox]").change(function(eX){var eY;if(br(this).filter("#accept-tos").length){return}br(eX.target).parents("label").toggleClass("active");eY=eU.find("input[name="+(br(this).attr("name"))+"]:checked");eU.toggleClass(br(this).data("next"),eY.length!==0)});eU.find(".role-choice input").change((function(eX){return function(eZ){var eY,e0;eY=eU.find(".role-choice input:checked");e0=eY.val();if(!cy.get_viewer().is_uid_signed_in(e0)){eY.prop("checked",false);eW(eZ);bB.show_modal({user_id:e0,on_success:function(){return eY.prop("checked",true).trigger("change")}});return false}else{return eX.select_user(e0)}}})(this));eU.find("input:checked").trigger("change");eU.find("input[name=tos_accept]").change((function(eX){return function(eY){return eX.update_submit_enabled()}})(this));eU.find("#send-verify-email, #resend-verify-email").click((function(eX){return function(eY){eX.email_verification.send_email(eT,function(){eU.addClass("verify-email-sent");eX.email_verification.flash_email_sent_notification();return eX.email_verification.ensure_polling(function(){if(!eX.email_verification.user.is_email_verified){return}eU.addClass("email-verified");eU.removeClass("verifiy-email-sent");return eX.update_submit_enabled()})});return false}})(this));return eU.submit(function(eX){eU=br(eX.target);bF.ajax_submit(eU[0],false,(function(eY){return window.location.href=eY.responseText}));return false})},select_user:function(T){this.email_verification=dK.get_for_user(cy.get_viewer().get_user_by_id(T));this.form.find("#accept-tos-wrapper").toggle(!this.accepted_tos_by_uid[T]);this.form.find("input[name=tos_accept]").prop("checked",false);this.form.removeClass("verify-email-sent");this.form.find("#verify-email-wrapper").toggle(!this.email_verification.user.is_email_verified);this.form.toggleClass("email-verified",this.email_verification.user.is_email_verified);return this.update_submit_enabled()},update_submit_enabled:function(){var eT,T;T=this.email_verification.user;eT=this.accepted_tos_by_uid[T.id]||this.form.find("input[name=tos_accept]").prop("checked");return this.form.find("#create-button").prop("disabled",!eT)}};a6=INLINE_JS.Apps=B.Apps={init_apps:function(){return br("#show-disabled-apps").click(function(){br(this).parent().hide();br("#disabled-apps").show();return false})},init_app_info:function(eT,eU,T){this.user_email=T;br("#app-info .icon-container").each(function(eW,eX){var eV;eV=br(eX);return eV.append(Dropbox.createChooseButton({success:function(eY){eV.find(".icon").attr("src",eY[0].thumbnailLink);return eV.find("input[type=hidden]").val(eY[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=eP.tmpl("hoverable_tmpl");this._webhook_info_row_tmpl=eP.tmpl("webhook_info_row_tmpl");br("#domain-list").on("click",".img-container",function(eV){a6.remove_domain(eV.currentTarget.parentNode,eT)});br("#oauth-uri-list").on("click",".img-container",function(eV){a6.remove_oauth_uri(eV.currentTarget.parentNode,eT)});br("#webhook-list").on("click",".img-container",function(eV){a6.remove_webhook(eV.currentTarget.parentNode,eT)});br("#webhook-list").on("click",".webhook-actions.enabled .webhook_disable",function(eV){a6.update_webhook_url(eV.currentTarget,eT,false)});br("#webhook-list").on("click",".webhook-actions.disabled .webhook_enable",function(eV){a6.update_webhook_url(eV.currentTarget,eT,true)});br("#generate-token-button").on("click",function(eV){a6.generate_access_token(eT)});br("#delete-app-button").on("click",function(eV){a6.confirm_disable(eU,eT,0)});br("#webhook_url").on("click change paste focus",function(eV){br("#webhook-form").removeClass("error")});this.init_app_info_add_redirect_uri();return br("#oauth2-allow-implicit-grant").on("change",function(eV){return a6.set_oauth2_allow_implicit_grant(eV.currentTarget,eT)})},init_app_info_add_redirect_uri:function(){var T,eT,eU,eV;eT=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!eT){return}eV=window.decodeURIComponent(eT[1]);T=br("#oauth-add-uri-form");br("input[name=oauth_uri]",T).val(eV);eU=br("#add-redirect-uri-modal")[0];br("#add-redirect-uri-modal-uri").text(eV);eM.show(ef("Add OAuth redirect URI"),eU,{doit:function(){var eW;if(window.history&&window.history.replaceState){eW=window.location.href;eW=eW.substring(0,eW.indexOf("#"));window.history.replaceState({},document.title,eW)}else{window.location.hash=""}eM.hide();return a6.submit_new_oauth_uri(br("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(T){this.ds_info=T;if(cy.get_viewer().is_paired){this.role_picker=br("#role-selector").controller();this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return bB.set_during_login_callback((function(eT){return function(eV,eU){return eT.app_datastores_browse_reload_info(function(){return eU()},function(){eU("Error displaying datastores");return window.location.reload()})}})(this))}},app_datastores_browse_reload_info:function(eT,T){br.ajax({url:"/developers/apps/datastores/info",success:(function(eU){return function(eV){eU.ds_info=eV;eU.app_datastores_browse_render();return typeof eT==="function"?eT():void 0}})(this),error:(function(eU){return function(eV){return typeof T==="function"?T(eV):void 0}})(this)});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var eU,eT,T,eV;eT=br("#no_apps_container").empty();if(br("#apps_developed_container").children().length!==0||br("#apps_used_container").children().length!==0){return}eU=br("<div class='empty-state'></div>").appendTo(eT);switch((eV=this.role_picker)!=null?eV.get_state():void 0){case dI.PERSONAL:case dI.WORK:T=cy.get_viewer().get_user_by_role(this.role_picker.get_state());return eU.append("You don't have any datastores in your "+cy.get_role_title(T)+" Dropbox.");default:return eU.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(eZ){var eT,eY,eV,eX,eW,eU,T;eX=this.app_datastores_browse_get_id_info(eZ);eY=br(eZ);eY.empty();eT="";for(eU=0,T=eX.length;eU<T;eU++){eV=eX[eU];if(this.app_datastores_should_render(eV.uid)){eT+=eV.html}}if(eT){eY.append(this.app_datastores_browse_get_id_header(eZ));eW=br("<div class='app-list clearfix'/>").appendTo(eY);return eW.html(eT)}},app_datastores_should_render:function(eT){var T;if(this.role_picker!=null){T=cy.get_viewer().get_user_by_id(eT);return this.role_picker.is_role_visible(T.role)}else{return true}},app_datastores_browse_get_id_info:function(T){switch(T){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return cw(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(T){switch(T){case"#apps_developed_container":return br("<h2>Apps you develop</h2>");case"#apps_used_container":return br("<h2>Apps you use</h2>");default:return cw(false,"invalid ds group id")}},generate_access_token:function(eT){var eV,eU,T;T=this;eV=br("#generate-token-button");eU=br("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");eV.replaceWith(eU);return br.ajax({url:"/developers/apps/generate_access_token",type:"POST",data:{app_id:eT},dataType:"json",success:function(eX){var eW;if(eX.status==="ok"){eW=br("<div>").append(br("<div>").attr("id","generated-token").addClass("text").css("padding-top",0).text(eX.token));eW.append(br("<div>").addClass("detail-text").text(eX.warning))}else{if(eX.status==="error"){eW=br("<div>").addClass("detail-text").addClass("error").text(eX.msg)}}return eU.replaceWith(eW)},error:function(){return ab.error("Unable to complete your request.")}})},confirm_disable:function(eV,eU,eT){var eW,T;eW=(eT?ef("Are you sure you want to disable '%(app_name)s'?"):ef("Are you sure you want to delete '%(app_name)s'?"));c9.fillVal(eW.format({app_name:eV.escapeHTML()}),"app-disable-text");eM.show((eT?ef("Confirm disable"):ef("Confirm delete")),$("app-disable-modal"));T="/developers/disable_app/"+eU;$("app-disable-modal").down("form").action=T;return $("disable-app-button").setValue((eT?ef("Disable"):ef("Delete")))},enable_app:function(eT){var T;T="/developers/enable_app/"+eT;return window.location.href=T},show_uninstall:function(eX,eW,eU,eT,eV,T){var eY;if(eX){Event.stop(eX)}eM.vars={app_id:eU,user_id:T};eY=br("#delete-"+eT+"-app-confirm");if(eT==="sandbox"){if(!eV){a6.do_uninstall();return}br(".app_folder",eY).text(eV)}br(".app_name",eY).text(eW);eM.show(ef("Remove %(app_name)s?").format({app_name:bG.em_snippet(eW,22)}),eY[0],eM.vars);return null},do_uninstall:function(){var T;T=eM.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:eM.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(eT){var eU;ab.success(eT.responseText);eU=br(".apps-"+T);br("#inst-app-"+eM.vars.app_id+"-row",eU).hide().removeClass("active_app");if(br(".active_app",eU).length===0){eU.hide()}if(br(".active_app").length===0){br("#empty-explanation").text(ef("You have no apps linked to your Dropbox."));return br("#applications-explanation",eU).remove()}},subject_user:T});return eM.hide()},enable_users_in_dev:function(T,eT){new Ajax.DBRequest("/developers/enable_users_in_dev/"+T,{onSuccess:function(eU){eM.show(ef("Limit raised to %d users").format(eT),$("increased-dev-user-limit-modal"));br("#users-in-dev-none, #users-in-dev-some").hide();return br("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(T){eM.show(ef("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+T,{onSuccess:function(eT){br("#current-app-users-1, #current-app-users-2").text("0");return eM.hide()}})}});return false},unlink_all_teams_in_dev:function(T){eM.show(ef("Unlink all teams"),$("confirm-unlink-all-teams"),{doit:function(){return br.ajax({url:"/developers/unlink_all_teams/"+T,type:"POST",success:function(eT){br("#current-app-teams").text("0");return eM.hide()}})}});return false},restore_sandbox:function(eT,eV,T){var eX,eU,eW;eX=br("#restore-sandbox")[0];eM.show(ef("Restore app folder '%(filename)s'").format({filename:bG.em_snippet(au.filename(eV),17)}),eX);eW=br("#restore-sandbox-form")[0];eU={ns_id:T};eU[Constants.UID_PARAM_NAME]=eT.id;return bF.add_vars(eW,eU)},submit_restore_sandbox:function(eT){var T;T=$("restore-sandbox-form");bF.ajax_submit(T,false,(function(eU){eM.hide();ab.success(ef("Restored app folder"));if(eU.responseText.length){return cf.reload_fqpath(eU.responseText)}else{return cf.reload("","",true)}}),false,eT.target);return false},submit_app_info:function(T){var eT;eT=br(T).find("input[name=name]").val();bF.clear_errors(T);return bF.ajax_submit(T,false,(function(){ab.success("App info updated.");if(eT){return br("#app-info h1").text(eT)}}))},submit_folder_name:function(T){var eT;eT=br(T).find("input[name=folder]").val();bF.clear_errors(T);return bF.ajax_submit(T,false,(function(){ab.success("App folder name updated.");br("#folder-name .text").text(eT);return a6.hide_folder_input()}))},submit_new_webhook:function(eT){var eU,e4,e2,eX,e0,eZ,e3,e1,eV,T,eY,eW;e4=br(eT);e0=br("#webhook-list");eX=br("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");e2=e4.find("input[name=webhook_url]");eV=function(e6,e5){if(e5){e5.remove()}if(e0.find(".hoverable-url").length===0){e0.addClass("hide-status")}br("#webhook-form-error").text(e6);return br("#webhook-form").addClass("error")};e3=e2.val();if(e3===""){eV("Empty URI");return}e1=D.parse(e3);if((eY=e1.scheme)!=="http"&&eY!=="https"){eV("URI scheme must be http or https");return}if(!e1.authority){eV("Improperly formatted URI (typo maybe?)");return}if(((eW=e1.authority)==="localhost"||eW==="127.0.0.1")||e1.authority.indexOf("[::1]")===0){eV("Webhooks doesn't support localhost as Dropbox can't contact your local server. Please use an internet accessible URI.");return}if(e0.find("tbody").length>=Constants.MAX_WEBHOOKS_PER_APP){eV("You can register a maximum of %d webhook URIs per app.".format(Constants.MAX_WEBHOOKS_PER_APP));return}eU=br(this._webhook_info_row_tmpl({url:e3,status:"Verifying"}).toHTML());eU.find(".status").append(eX);eU.find(".webhook-actions").removeClass("disabled").addClass("enabled");e0.append(eU);e0.removeClass("hide-status");br("#webhook-form").removeClass("error");eZ=bF.collect_form_vars(eT);e2.val("");T=new Date().getTime();return br.ajax({url:"/developers/apps/update/add_webhook",type:"POST",dataType:"json",data:eZ,success:function(e7){var e5,e6;if(e7.status==="invalid"){eV(e7.failure_text,eU);return e2.val(e3)}else{e6=new Date().getTime()-T;e5=Math.max(0,1000-e6);return setTimeout((function(){if(e7.status==="ok"){return eU.find(".status").text("Enabled")}else{if(e7.status==="error"){eU.find("textarea").text(e7.failure_text);eU.find(".status").text(e7.status_text).addClass("error");eU.find(".timestamp").text("Just now");return eU.find(".webhook-failure-info").css("display","")}}}),e5)}},error:function(){ab.error("Unable to complete your request.");eU.remove();return e2.val(e3)}})},remove_webhook:function(eU,eT){var eV,T;br("#webhook-form").removeClass("error");T=br(eU).find(".value").text();eV=br("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");br(eU).find(".status").text("Removing").removeClass("error").append(eV);return br.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:eT,webhook_url:T},dataType:"json",success:function(eY){var eW,eX;eW=eU.parentNode;eX=eW.parentNode;eX.removeChild(eW);if(eX.getElementsByClassName("hoverable-url").length===0){br(eX).addClass("hide-status")}if(!br("#webhook_url").val()){return br("#webhook_url").val(T)}},error:function(){return ab.error("Unable to complete your request.")}})},update_webhook_url:function(eX,eV,eU){var eY,T,eW,eZ,eT;eT=br(eX.parentNode.parentNode).find(".value").text();br("#webhook-form").removeClass("error");eW=eX.parentNode.parentNode.parentNode;eY=br("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");T=br(eW).find(".status").text();eU=T==="Disabled";eZ=eU?"Enabling":"Disabling";br(eW).find(".status").text(eZ).removeClass("error").append(eY);return br.ajax({url:"/developers/apps/update/update_webhook_url",type:"POST",data:{app_id:eV,webhook_url:eT,enable:eU},dataType:"json",success:function(e1){var e0;T=br(eW).find(".status").text();e0=T==="Disabling"?"Disabled":"Enabled";br(eW).find(".status").text(e0).removeClass("error").removeClass("img");if(T==="Disabling"){return br(eW).find(".webhook-actions").removeClass("enabled").addClass("disabled")}else{return br(eW).find(".webhook-actions").removeClass("disabled").addClass("enabled")}},error:function(e0){return ab.error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(eT,T){return br.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:T,allow:br(eT).val()},dataType:"json",success:function(eU){return ab.success("OAuth 2 allow implicit grant updated.")},error:function(){return ab.error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(eT){var T;T=br(eT).find("input[name=oauth_uri]").val();bF.clear_errors(eT);return bF.ajax_submit(eT,false,(function(){ab.success("OAuth URI added.");a6.add_oauth_uri(T);return br(eT).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(eT){var T;T=br("#oauth-uri-list");T.append(this._hoverable_tmpl({value:eT}).toHTML());return T.show()},remove_oauth_uri:function(eT,T){var eV,eU;eV=br(eT).find(".value").text();eU=function(eX){var eW;ab.success("OAuth URI removed.");eW=eT.parentNode;eW.removeChild(eT);if(eW.getElementsByTagName("div").length===0){return eW.hide()}};return br.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:T,oauth_uri:eV},dataType:"json",success:eU,error:function(){return ab.error("Unable to complete your request.")}})},submit_new_domain:function(T){var eT;eT=br(T).find("input[name=domain_name]").val();bF.clear_errors(T);return bF.ajax_submit(T,false,(function(){ab.success("Domain added.");a6.add_domain(eT);return br(T).find("input[name=domain_name]").val("")}))},add_domain:function(eT){var T;T=br("#domain-list");T.append(this._hoverable_tmpl({value:eT}).toHTML());return T.show()},remove_domain:function(eT,T){var eV,eU;eV=br(eT).find(".value").text();eU=function(eX){var eW;ab.success("Domain removed.");eW=eT.parentNode;eW.removeChild(eT);if(eW.getElementsByTagName("div").length===0){return eW.hide()}};return br.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:T,domain_name:eV},dataType:"json",success:eU,error:function(){return ab.error("Unable to complete your request.")}})},show_need_users_modal:function(T){eM.show(ef("Please test this app",{comment:"Error message"}),$("app-need-users-modal"));return false},show_need_teams_modal:function(T){return eM.show(ef("Please test this app",{comment:"Error message"}),$("app-need-teams-modal"))},show_name_branding_modal:function(T){eM.show(ef("Please rename this app",{comment:"Error message"}),$("app-name-branding-modal"));return false},show_need_icon_modal:function(T){eM.show(ef("Please add an icon for this app",{comment:"Error message"}),$("app-need-icon-modal"));return false},hide_folder_input:function(){br("#folder-name").show();return br("#folder-input").hide()},show_folder_input:function(){br("#folder-name").hide();br("#folder-input").show();return br("#folder-input input[name=folder]").focus()}};var cq,dl;dl=INLINE_JS.twitter_auth_complete=function(T){cw(T!=null,"user_id must be provided");if(cq.onLoginSuccessCallback){cq.onLoginSuccessCallback(T)}else{window.location.reload()}return false};cq=B.Twitter={is_authed:function(T){T=parseInt(T);if(cq._authed_users==null){cq._authed_users={}}return cq._authed_users[T]},set_is_authed:function(T,eT){T=parseInt(T);if(cq._authed_users==null){cq._authed_users={}}return cq._authed_users[T]=eT},get_progress_container:function(){var T;cw(cq.progress_container,"Twitter is missing progress_container");T=$(cq.progress_container);cw(T,"Missing progress_container elm");return T},follow_dropbox:function(eT,T){var eU;cw(T!=null,"user_id must be provided");if(eT.showWorking){eT.showWorking()}eU=function(){if(eT.onFailure){return eT.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(eV){if(!eV.responseText.startsWith("ok")){return eU()}else{if(eT.onSuccess){return eT.onSuccess()}}},onFailure:function(){return eU()},subject_user:T})},do_auth:function(eV,T){var eU,eT;cw(T!=null,"user_id must be provided");eT=D({path:"/twitter/request_token"}).updateQuery(Constants.UID_PARAM_NAME,T).toString();window.open(eT,"twitter_auth","width=800,height=400");eU=function(eW){cq.set_is_authed(eW,true);return typeof eV==="function"?eV(eW):void 0};return cq.onLoginSuccessCallback=eU},show_auth:function(T){if(T){cq.onLoginSuccessCallback=T}return c9.updateFromElm(cq.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(cq.should_hide_modal()){eM.hide()}return cq.get_progress_container().update(c9.fromElm("sharing-progress"))},show_complete:function(eT){var T;T=cq.get_progress_container();T.update(c9.fromElm("sharing-posted"));return cq.show_complete_into(eT,T)},show_complete_into:function(eY,T){var eV,eW,eU,eX,eT;eV="twitter";eX=ef("View tweet");eT=void 0;if(eY.startsWith("ok")){eT="http://www.twitter.com/"}else{eT=eY}eW=T.down("#view-post");eW.href=eT;eW.update(eX);eU=cj.make("web",eV);return eW.__sert({top:eU})},post:function(eV,eX,eU,T){var eW,eT;cw(T!=null,"user_id must be provided");cw(eV,"Twitter message is empty");eW={message:eV,from_referrals:cq.from_referrals,from_getspace:cq.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:eW,onSuccess:function(eY){var eZ,e0;if(eY.responseText==="login"){cq.onLoginSuccessCallback=function(){return cq.post(eV,null,null,T)};eZ=cq.custom_show_auth||cq.show_auth;return eZ()}else{if(cq.should_hide_modal()){eM.hide()}e0=cq.onPostSuccessCallback||cq.show_complete;return e0(eY.responseText)}},subject_user:T});eT=cq.custom_show_posting||cq.show_posting;return eT()},custom_post:function(eT,eU,T){cw(T!=null,"user_id must be provided");if(eU){cq.onPostSuccessCallback=eU}if(!eT){return}cw(eT,"Twitter message doesn't exist");if(!cy.get_viewer().is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(eT))}else{return cq.post(eT,null,null,T)}},get_user_info:function(eT,T){cw(T!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(eU){return eT(JSON.parse(eU.responseText))},subject_user:T})},should_hide_modal:function(){if(typeof cq.hide_modal==="undefined"){return true}else{return cq.hide_modal}}};var c7,eD,dj,V,ew,ao,bt,aj,v,d1,ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV},db=function(T,eT){return function(){return T.apply(eT,arguments)}};dj=B.LightboxPreviewBase=(function(){function T(eT){this.link_hash=eT.link_hash;this.filename=eT.filename;this.fq_path=eT.fq_path;this.thumbnail_url_tmpl=eT.thumbnail_url_tmpl;this.dl_url=eT.dl_url;this.ns_id=eT.ns_id;this.ns_path=eT.ns_path;this.display_time=eT.display_time||null;this.more_actions_item_tmpl=eP.tmpl("lightbox_more_actions_item_tmpl")}T.prototype.shutdown=function(){};T.prototype.preload=function(){};T.prototype.render=function(){};T.prototype.image_size=function(){var eT;eT=document.viewport.getDimensions();return aA(eT.width,eT.height)};T.prototype.get_more_actions_above_divider=function(eU){var eV,eT;eT=[];eV=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,_ns_id:this.ns_id,_ns_path:this.ns_path,sprite_name:"lightbox_download",item_text:ef("Download"),more_classes:"more-actions-item",Sprite:cj});eT.push(eV);return eT};T.prototype.get_more_actions_below_divider=function(eT){return[]};T.prototype.is_a_timeline_preview=function(){return this instanceof ew||this instanceof c7||this instanceof ao||this instanceof eD};T.prototype.is_an_album_preview=function(){return this instanceof ew||this instanceof ao};T.prototype.is_a_photo_preview=function(){return this instanceof V};T.prototype.is_a_video_preview=function(){return this instanceof bt};T.prototype.get_actions=function(eV){var eX,eZ,e0,eU,eY,eT,eW;eU=[];if(!this.is_a_timeline_preview()&&eV.enable_sublinks){if(eV.share_button_experiment_variant==="WHITE_BUTTON"){e0=br("#lightbox-share-action-base").clone().attr("id","lightbox-share-button");if(this.shmodel_link){eW=(function(e1){return function(e2){a0.ShmodelUILogger.log("via-shmodel-lightbox");return window.open(D.parse(e1.shmodel_link).updateQuery("m","1"))}})(this)}else{eW=(function(e1){return function(e2){e2.preventDefault();a0.ShmodelUILogger.log("via-browse-lightbox");return dc.shmodel(e1.fq_path,"browse_lightbox")}})(this)}}else{e0=br("<a />",{id:"lightbox_share_link","class":"title_bubble black"});e0.html(cj.make("web","link_white"));if(this.is_a_photo_preview()){e0.attr("title",ef("Share link to photo"))}else{if(this.is_a_video_preview()){e0.attr("title",ef("Share link to video"))}else{cw(false,"preview needs to be a photo or video")}}if(this.shmodel_link){e0.attr("href",D.parse(this.shmodel_link).updateQuery("m","1"));e0.attr("target","_blank");eW=(function(e1){return function(e2){return a0.ShmodelUILogger.log("via-shmodel-lightbox")}})(this)}else{e0.attr("href","#");eW=(function(e1){return function(e2){e2.preventDefault();a0.ShmodelUILogger.log("via-browse-lightbox");return dc.shmodel(e1.fq_path,"browse_lightbox")}})(this)}}e0.on("click",eW);eU.push(e0[0])}if(eV.include_delete){eY=bC.in_single_collection_view()?ef("Remove"):ef("Delete");if(eV.share_button_experiment_variant==="WHITE_BUTTON"){eX=br("#lightbox-delete-action-base").clone().attr("id","lightbox-delete-link");eX.find(".sprite-text-inner").text(eY);eX.on("click",(function(e1){e1.preventDefault();return aD.delete_current()}))}else{eX=br("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:eY});eX.html(cj.make("web","lightbox_delete_16"));eX.on("click",(function(e1){e1.preventDefault();return aD.toggle_delete()}))}eU.push(eX[0])}if(eV.share_button_experiment_variant==="WHITE_BUTTON"){eT=(function(e1){return function(e2){e2.preventDefault();return aD.toggle_more_actions_menu()}})(this);eZ=br("#lightbox-more-actions-base").clone().attr("id","lightbox-more-actions-button").on("click",eT);eU.push(eZ[0])}else{cw(aD.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");eU.push(aD.more_actions_button)}return eU};T.prototype.delete_pressed=function(){var eT;eT=ef("Deleting...");if(this.is_a_timeline_preview()){if(bC.in_single_collection_view()){eT=ef("Removing...");bC.get_current_collection().remove_photos([this.photo])}else{bC._delete_photos([this.photo])}}else{document.fire(aD.PHOTO_DELETE_EVT,this)}return ab.success(eT)};T.prototype.set_more_actions_event_handlers=function(eT){};T.prototype.replace_dl_action_with_open_action_if_file_available=function(){var eU,eV,eT,eW;if(__CONDITIONAL_JS__.UnityFeatures==null){return}eT=cf.active_user.id;eV=(function(eX){return function(eY,e1,eZ){var e2,e0;e2=br("#lightbox_download_link");if(!(e2.data("ns-id")===eY&&e2.data("ns-path")===e1)){return}e0=br(eX.more_actions_item_tmpl({_id:"unity_open_action",_href:"#",_ns_id:eY,_ns_path:e1,sprite_name:"lightbox_open",item_text:ef("Open"),more_classes:"more-actions-item",Sprite:cj}).toHTML());e2.replaceWith(e0);return e0.on("click",function(e3){return __CONDITIONAL_JS__.UnityFeatures.open_file(eY,e1,eZ,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(e4){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})})}})(this);if((eW=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?eW.is_cached_and_locally_available(this.ns_id,this.ns_path):void 0){return eV(this.ns_id,this.ns_path,eT)}else{eU=(function(eX){return function(eY){if(eY.is_locally_available){return eV(eX.ns_id,eX.ns_path,eT)}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.ns_id,this.ns_path,eT,eU)}};return T})();V=INLINE_JS.PhotoPreview=B.PhotoPreview=(function(eT){cA(T,eT);function T(eU){T.__super__.constructor.call(this,eU);this.original_url=String(D.parse(eU.original_url).updateQuery(Constants.UID_PARAM_NAME,cf.active_user));this.shmodel_link=eU.shmodel_link;this.fail_image_src="/static/images/preview_fail-vflc3IDxf.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false;this.enable_download=eU.enable_download}T.prototype.show_fail=function(eV){var eU;return eU=br(eV).find(".lightbox_fail_text").text(ef("Unable to preview this item."))};T.prototype.fallback=function(eV){var eU,eW;eU=$(eV.target);eU.writeAttribute({src:this.fail_image_src,width:128,height:128});eW=eU.up("div.content-item");if(eW){return this.show_fail(eW)}};T.prototype.is_gif=function(){return"gif"===au.file_extension(this.filename).toLowerCase()};T.prototype.preload=function(eW){var eV,eX,eU;eU=D.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){eU=this.thumbnail_url_tmpl}eX=(function(eY){return function(){if(typeof eW==="function"){eW()}return eY.loaded=true}})(this);dL.preload_image(eU,this.fallback.bind(this),eX);eV=$(dL.preloaded_images[eU]);eV.writeAttribute("data-original-href",this.original_url);eV.setAttribute("enable-download",this.enable_download);eV.writeAttribute("class","thumbnail");return eV};T.prototype.render=function(eZ,eW){var eX,eV,eY,eU,e0;if(this.loaded){eW()}eV=this.preload(eW);e0=br("<div />",{"class":"content-item"}).append(eV);eX=br("<div />",{"class":"lightbox_fail_text"});e0.append(eX);eY=eV.getAttribute("src").length;eU=eV.getAttribute("src").substring(eY-this.fail_image_src.length,eY);if(eU===this.fail_image_src){this.show_fail(e0)}eZ.appendChild(e0[0]);return e0[0]};T.prototype.advance_on_click=true;T.prototype.get_more_actions_above_divider=function(eW){var eV,eU;eU=T.__super__.get_more_actions_above_divider.call(this,eW);eV=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:ef("View original"),more_classes:"more-actions-item",Sprite:cj});eU.push(eV);return eU};return T})(dj);bt=B.VideoPreview=(function(T){cA(eT,T);function eT(eU){this._player_error=db(this._player_error,this);this._player_ready=db(this._player_ready,this);eT.__super__.constructor.call(this,eU);this.preview_url=eU.preview_url;this.shmodel_link=eU.shmodel_link;this.thumbnail_div=null;this.metadata_link=eU.metadata_link!=null?eU.metadata_link:void 0;this.metadata=null;this.player=null}eT.prototype.render_error=function(eX){var eZ,eV,eU,eW,eY;eV=br("<div/>");eU=br("<img/>",{src:"/static/images/preview_fail-vflc3IDxf.png","class":"video-preview-fail"});eW=br("<div/>",{"class":"video-preview-fail"});if(eX==="needflash"){eW.html(ef('Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to view this video.'))}else{eW.text(ef("Unable to preview this item.",eY="web",eZ="preview means showing the item in the same browser window without downloading a copy."))}eV.append(eU,eW);return eV[0]};eT.prototype._player_ready=function(){var eU;eU=function(){br(".vjs-poster").show();br(".vjs-big-play-button").show();return br(".vjs-big-play-button").focus()};return eU.defer()};eT.prototype._onPlay=function(){br(".vjs-poster").hide();return br(".vjs-big-play-button").hide()};eT.prototype._onEnded=function(){br(".vjs-poster").show();br(".vjs-big-play-button").show();return br(".vjs-loading-spinner").hide()};eT.prototype._player_error=function(eU){this.shutdown();this.div=this.render_error(eU);return br("#file-preview-modal .content-item").html(this.div)};eT.prototype.preload=function(){};eT.prototype.render=function(eV,eU){this.div=this.render_video(eV);return this.div};eT.prototype.render_video=function(e0){var eU,eY,eW,eV,eZ,eX;eX=new Element("div",{"class":"video-player content-item"});eZ=this.image_size().split("x")[0]*0.8;eV=parseInt(eZ*0.55,10);eY=false;eW=D.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();eU=(function(e1){return function(e2){return e1.metadata=e2}})(this);this.player=bi.embed(eX,{src:this.preview_url,type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:eZ,height:eV,controls:true,preload:"auto",poster:eW,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:eU});e0.appendChild(eX);br(".vjs-poster").hide();br(".vjs-big-play-button").hide();this.player.on("play",this._onPlay);this.player.on("ended",this._onEnded);return eX};eT.prototype.shutdown=function(){var eV,eU;br(".vjs-big-play-button").blur();if(this.player){try{this.player.trigger("shutdown");if(this.player.techName==="Hls"){if((eU=this.player.tech.sourceBuffer)!=null){eU.abort()}}this.player.dispose()}catch(eW){eV=eW}return this.player=null}};return eT})(dj);aj=function(eU){var T,eT;T=(function(eW){cA(eV,eW);function eV(eX){eX.ns_id=eX.photo.ns_id;eX.ns_path=eX.photo.ns_path;eV.__super__.constructor.call(this,eX);this.photo=eX.photo;bd.set_vertical_space(3);if(bC.in_single_collection_view()){br("#lightbox-delete-photo").val(ef("Remove"))}else{br("#lightbox-delete-photo").val(ef("Delete"))}}eV.prototype.get_more_actions_above_divider=function(eZ){var eY,eX;eX=eV.__super__.get_more_actions_above_divider.call(this,eZ);eY=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:ef("Add to album"),more_classes:"more-actions-item",Sprite:cj});eX.push(eY);return eX};eV.prototype.toggle_select_button_off=function(eX){if(this.is_a_photo_preview()){eX.attr("title",ef("Select photo"))}else{if(this.is_a_video_preview()){eX.attr("title",ef("Select video"))}}eX.html(cj.make("web","lightbox_unselected"));eX.removeClass("selected");eX.addClass("elbboggiw");return setTimeout((function(){return eX.removeClass("elbboggiw")}),540)};eV.prototype.toggle_select_button_on=function(eX){if(this.is_a_photo_preview()){eX.attr("title",ef("Un-select photo"))}else{if(this.is_a_video_preview()){eX.attr("title",ef("Un-select video"))}}eX.html(cj.make("web","lightbox_selected"));eX.addClass("selected");eX.addClass("wiggobble");return setTimeout((function(){return eX.removeClass("wiggobble")}),540)};eV.prototype.toggle_select=function(eY){var eX;eY.preventDefault();eX=br("#lightbox-select-button");bd.hide_all();if(ez.contains(this.photo)){ez._remove(this.photo);return this.toggle_select_button_off(eX)}else{ez._add(this.photo);return this.toggle_select_button_on(eX)}};eV.prototype.get_actions=function(eZ){var eY,eX,e0;eY=[];e0=br("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});aD.update_share_button_text(null,br(e0));e0.on("click",((function(e1){return function(e3){var e2;e3.preventDefault();e2=ez.get();if(e2.length===0){return ee.show([e1.photo],false)}else{return ee.show(ez.get(),false)}}})(this)));eX=br("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:ef("Select this photo")});if(ez.contains(this.photo)){eX.html(cj.make("web","lightbox_selected"))}else{eX.html(cj.make("web","lightbox_unselected"))}eX.on("click",this.toggle_select.bind(this));eY.push(e0[0]);eY.push(eX[0]);return eY.concat(eV.__super__.get_actions.call(this,eZ))};eV.prototype.set_more_actions_event_handlers=function(eX){$("lightbox_add_to_album").observe("click",((function(eY){return function(eZ){eZ.preventDefault();return ct.show_add_to_album_modal(eZ,[eY.photo])}})(this)));$("lightbox_show_in_folder").observe("click",((function(eY){return function(eZ){eZ.preventDefault();return bC.show_in_folder(eY.photo)}})(this)));return eV.__super__.set_more_actions_event_handlers.call(this,eX)};eV.prototype.get_more_actions_below_divider=function(eZ){var eY,eX;eY=[];eX=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:ef("Show in folder"),more_classes:"more-actions-item",Sprite:cj});eY.push(eX);eY=eY.concat(eV.__super__.get_more_actions_below_divider.call(this,eZ));return eY};return eV})(eU);eT=(function(eW){cA(eV,eW);function eV(){return eV.__super__.constructor.apply(this,arguments)}eV.prototype.get_more_actions_below_divider=function(eZ){var eX,eY;eY=[];eX=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:ef("Remove from album"),more_classes:"more-actions-item",Sprite:cj});eY.push(eX);eY=eY.concat(eV.__super__.get_more_actions_below_divider.call(this,eZ));return eY};eV.prototype.set_more_actions_event_handlers=function(eX){$("lightbox_remove_from_album").observe("click",((function(eY){return function(eZ){eZ.preventDefault();return ct.show_remove_photos_modal(bC.get_current_collection(),[eY.photo])}})(this)));return eV.__super__.set_more_actions_event_handlers.call(this,eX)};return eV})(T);return[T,eT]};v=aj(V),c7=v[0],ew=v[1];d1=aj(bt),eD=d1[0],ao=d1[1];var aD;aD=INLINE_JS.Lightbox=B.Lightbox=(function(){var fc,fa,fI,fH,fu,e0,eT,fh,fq,fM,fG,eZ,fp,fB,e7,fA,fm,fv,fL,e6,fn,e4,fz,fD,eY,fC,eX,ff,fF,e9,fo,e1,fi,fw,fj,fs,eV,fb,T,fr,fE,fK,fy,e8,fe,eW,fd,ft,eU,e2,fx,fk,fl,e5,fg,e3,fJ;fH=[];fc=0;fu=false;fI=true;fk=void 0;eT=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;e0=false;fF=void 0;fB=void 0;ft=-1;eU=null;fv=null;fn=false;T=false;eY=false;e4=null;e6=function(fN){return fN.complete!==false};eW=function(){var fN;if($$("#file-preview-modal .loading-image").length){return}fN=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black-vflweQQeE.gif"});return $$("#file-preview-modal .preview-content").first().__sert(fN)};fm=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};fj=function(){var fT,fS,fP,fN,fR,fQ,fO;fS=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!fS||!e6(fS)){return}fN=$$("#file-preview-modal .preview").first().getDimensions();fT=void 0;if(!fS.naturalHeight){fT=fS.getDimensions();fS.naturalHeight=fT.height;fS.naturalWidth=fT.width}else{fT={width:fS.naturalWidth,height:fS.naturalHeight}}fP=fT.width/fN.width;fO=fT.height/fN.height;fQ=Math.max(fP,fO);fS.style.visibility="";if(fQ<1){fS.style.width="";fS.style.height=""}else{fS.style.width=Math.floor(fT.width/fQ)+"px";fS.style.height=Math.floor(fT.height/fQ)+"px"}fR=br("#file-preview-modal .paging-block").position().left-16;return br("#file-preview-modal .filename").css("max-width",fR)};fp=void 0;fC=function(){var fU,fP,fT,fS,fR,fO,fQ,fN;fP=$("file-preview-modal");fS=fP.down(".menu");fT=fP.down(".header");fQ=$$(".lightbox-not-important");fN=[];for(fR=0,fO=fQ.length;fR<fO;fR++){fU=fQ[fR];fN.push(fU.addClassName("opacity-zero"))}return fN};fd=function(){var fR,fQ,fO,fP,fN;if(fp){clearTimeout(fp)}fP=$$(".lightbox-not-important");fN=[];for(fQ=0,fO=fP.length;fQ<fO;fQ++){fR=fP[fQ];fN.push(fR.removeClassName("opacity-zero"))}return fN};fs=function(fO){var fN;fd();fN=fO&&$(fO.target).descendantOf("file-preview-menu");if(fp!=null){clearTimeout(fp)}if(fI){if(!e0&&!fN){return fp=setTimeout(fC,3112)}}};fx=function(){if(fp!=null){clearTimeout(fp)}return fI=false};e2=function(){fI=true;return fs()};fL=function(fO){var fN;fN=fH.length;return(fN+(fc+fO)%fN)%fN};fo=function(fO){var fN,fP;if(fF.no_preload){return}fN=e8.bind(null,fO);return typeof(fP=fH[fO]).preload==="function"?fP.preload(fN):void 0};e1=function(){var fP,fR,fO,fQ,fN;fQ=[1,2,3,4,5,6,-1,-2];fN=[];for(fR=0,fO=fQ.length;fR<fO;fR++){fP=fQ[fR];if(Math.abs(fP)<fH.length){fN.push(fo(fL(fP)))}else{fN.push(void 0)}}return fN};fb=function(fN){if(!fF.filename_in_url){return}if(fN!=null){aU.replace_hash("lh",fN)}else{aU.replace_hash("")}return e4=fN};fw=function(){var fN,fO;fN=br("#file-preview-modal");fO=fF.num_previews||fH.length;if(fn&&T&&eY){fN.find(".lightbox-index-text-container").text(ef("Could not load folder",{comment:"Error shown when a folder fails to load"}))}else{if(fn){if(T){fN.find(".lightbox-index-text-container").text(ef("Loading...",{comment:"Shown while waiting for photos/videos to load"}))}else{fN.find(".lightbox-index-text-container").text("")}}else{fN.find(".lightbox-index-text-container").text(ef("%(cur_file_num)s of %(num_total_files)s",{comment:"Indicating which we're viewing, like '3 of 10'"}).format({cur_file_num:fc+1,num_total_files:fO}))}}if(fH.length===1){fN.find(".prev").addClass("opacity-zero");return fN.find(".next").addClass("opacity-zero")}else{if(fc===0&&fF.no_wrap){fN.find(".prev").addClass("opacity-zero");return fN.find(".next").removeClass("opacity-zero")}else{if(fc===fH.length-1&&fF.no_wrap){fN.find(".prev").removeClass("opacity-zero");return fN.find(".next").addClass("opacity-zero")}else{fN.find(".prev").removeClass("opacity-zero");return fN.find(".next").removeClass("opacity-zero")}}}};fr=function(fP,f8){var fX,fY,fZ,f4,fT,fQ,fR,fN,f3,f7,f6,f2,fV,f1,fU,f0,f5,fO,f9,fW,fS;ft=bR.time();cw(fc<fH.length,"Invalid index "+fc);f0=fH[fc];if(typeof f0!=="object"){if(eU){clearTimeout(eU)}eU=setTimeout((function(){if((aD.shown!=null)&&aD.shown){return fr(fP,f8)}}),100);return}br("#file-preview-modal").trigger(aD.LIGHTBOX_SHOW_EVT,{preview:f0});if(f0.fq_path!=null){fR="browse_lightbox"}else{if(f0.shmodel_link!=null){fR="shmodel_lightbox"}else{fR="lightbox"}}fQ=au.file_extension_for_logging(f0.filename);f3={mode:fR,file_ext:fQ};a0.UserActivityLogger.log("web","file_view",f3);a0.WebLightboxLogger.log(a0.WebLightboxLogger.VIEW,{context:fR,file_ext:fQ});f6=br("#file-preview-modal");f5=f6.find(".preview-content");fU=fP?fy:e8;f5.empty();fT=f0.render(f5[0],fU);f6=f6[0];if(!fv){fv=f6.on("contextmenu","img.thumbnail",bc.show_for_lightbox.bind(bc))}fb(f0.link_hash);fw();if(f0.display_time){if(f0.filename.match(eT)){f6.down(".filename").__date(f0.display_time)}else{f6.down(".filename").__date(f0.display_time+" - "+f0.filename)}}else{f6.down(".filename").__date(f0.filename)}f6.down(".filename").writeAttribute("title",f0.filename);if(bC.in_single_collection_view()&&((fW=bC.get_current_collection().member_fnames)!=null?fW.length:void 0)>1&&(((fS=f0.photo)!=null?fS.item_owner_fname:void 0)!=null)){f4="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";f4+=ef("Added by %(fname)s").format({fname:bG.em_snippet(f0.photo.item_owner_fname,7)});f6.down(".added-by").__date(new eP(f4));f6.down(".added-by").show()}else{f6.down(".added-by").hide()}fV=eP.tmpl("lightbox_more_actions_item_tmpl");f2=f0.get_more_actions_above_divider(fF);fZ=f0.get_more_actions_below_divider(fF);if(fZ.length){f2.push(fV({divider:true,Sprite:cj}));f2=f2.concat(fZ)}$("lightbox-more-actions-list").__date(f2);f0.set_more_actions_event_handlers(fF);if(br(f6).data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)){f0.replace_dl_action_with_open_action_if_file_available()}fY=f0.get_actions(fF);fN=document.createDocumentFragment();for(fO=0,f9=fY.length;fO<f9;fO++){fX=fY[fO];fN.appendChild(fX)}f6.down(".actions").__date();f6.down(".actions").appendChild(fN);if(fF.share_button_experiment_variant==="WHITE_BUTTON"){f1=br("#lightbox-more-actions-button .sprite-div").width();br("#lightbox-more-actions-menu").css("right",f1/2)}document.fire(aD.ACTIONS_ADDED);if(bC.in_single_collection_view()){f6.down(".album-name").show().__date(bG.em_snippet(bC.get_current_collection().name,15,1));f6.down(".filename").addClassName("faded")}else{f6.down(".album-name").hide();f6.down(".filename").removeClassName("faded")}fT=fT.down("img.thumbnail");if(fT){if(!e6(fT)){fT.hide();eW();fT.observe("load",function(){fm();fT.style.visibility="hidden";fT.show();return fj()})}else{fT.show();fj()}}f7={preview_obj:f0,index:fc,direction:f8};return document.fire(aD.PHOTO_CHANGE_EVT,f7)};fK=function(fS){var fO,fP,fN,fQ,fR;if(ft===-1){return}fR=bR.time()-ft;if(typeof h!=="undefined"&&h!==null){fO=h.get_current_view()}else{if(typeof ag!=="undefined"&&ag!==null?ag.is_album:void 0){fO="album_shmodel"}else{fO="not_photos"}}fP={current_view:fO};fN=br("#file-preview-modal .content-item img.thumbnail")[0];if((fN!=null)&&(fN.src!=null)){fQ=D.parse(fN.src).getQuery();if("size" in fQ){fP.size=fQ.size}}dX.log_ajax_transition(fR,fS,fP);ft=-1;return e1()};fy=function(){return fK("file-preview-lightbox-load-initial")};e8=function(fN){var fO;if(typeof fN==="number"){if((fO=fH[fN])!=null){fO.loaded=true}if(fN===fc){return fK("file-preview-lightbox-load")}}else{return fK("file-preview-lightbox-load")}};fE=function(fN){var fO;fO=br("#lightbox-click-catcher");if(!fO.length){fO=br("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});fO.appendTo("#file-preview-modal .modal-preview-content");if(bO.msie_version_at_most(10)){fO.css("background","black");fO.fadeTo(0,0)}}fO.off("click");fO.on("click",(function(fP){fP.preventDefault();return fN()}));return fO.show()};e7=function(){return br("#lightbox-click-catcher").hide()};fM=function(){var fN;fN=br("#lightbox-more-actions-button");if(fN.hasClass("toggled")){e7();fN.removeClass("toggled");$("lightbox-more-actions-menu").hide();br(document).trigger("dropdownClosed",[1]);e2();return true}return false};ff=function(){var fN;fN=br("#lightbox-more-actions-button");if(!fN.hasClass("toggled")){fA();fN.addClass("toggled");bd.hide_all();br("#lightbox-more-actions-menu").show();br(document).trigger("dropdownOpened",[1]);fx();return fE(aD.close_more_actions_menu)}};e5=function(){if(br("#lightbox-more-actions-button").hasClass("toggled")){return fM()}else{return ff()}};eX=function(fO){var fN;if(fn){T=true;fw()}fM();if(fO){fO.preventDefault()}if(fc===fH.length-1&&fF.no_wrap){return}if((fN=fH[fc])!=null){fN.shutdown()}fc=fL(1);if(fc===0){fs()}return fr(null,aD.NEXT)};fi=function(fO){var fN;if(fn){T=true;fw()}fM();if(fO){fO.preventDefault()}if(fc===0&&fF.no_wrap){return}if((fN=fH[fc])!=null){fN.shutdown()}fc=fL(-1);return fr(null,aD.PREV)};fq=function(fN){if(fN){fN.preventDefault()}if(fH[fc].advance_on_click){if(fN.clientX<br(window).width()/10){return fi()}else{return eX()}}};fG=function(fT){var fQ,fP,fS,fU,fR,fO,fN;fQ=fH.dict_by("fq_path");fU=void 0;if(fT.memo.files){fU=fT.memo.files.collect(function(fV){return fV.fq_path})}else{fU=fT.memo.fq_paths}fN=[];for(fR=0,fO=fU.length;fR<fO;fR++){fS=fU[fR];if(fQ[fS]){fP=fH.indexOf(fQ[fS]);fH.splice(fP,1);if(fF.num_previews){fF.num_previews--}if(!fF.num_previews&&!fH.length){fN.push(fB())}else{if(fP===fH.length){fN.push(fi())}else{fN.push(fr())}}}else{fN.push(void 0)}}return fN};eV=function(fN){if(fH[fc].is_a_timeline_preview()){return fH[fc].toggle_select(fN)}};fg=function(){Event.stopObserving(document,"mousemove",fs);Event.stopObserving(document,"click",fs);document.stopObserving(aD.PHOTO_DELETE_EVT,e9);document.stopObserving(aB.DELETE,fG);document.stopObserving(ez.CHANGE_EVT,e3);return clearInterval(fk)};fB=function(fQ){var fO,fP,fN,fR;if(fQ){fQ.preventDefault()}if(!aD.shown){return}if((fP=fH[fc])!=null){fP.shutdown()}fO=$("file-preview-modal");fO.hide();fO.down(".preview-content").__date();z.scroll_unlock_document();fg();fb();aD.shown=0;fO.stopObserving("click",aD.back);if((fN=$$(".preview-content"))!=null){if((fR=fN.first())!=null){fR.stopObserving("click")}}br("#file-preview-modal").trigger(aD.LIGHTBOX_HIDE_EVT);if(aD.reload){return cf.force_reload()}};fa="db:filepreview:exitselect";fh=function(fO){var fN;if(fF.keep_url){fB()}else{if((fN=fH[fc])!=null){fN.shutdown()}window.history.go(-1)}if(fO!=null){if(fO.originalEvent){fO=fO.originalEvent}Event.extend(fO).stop()}return document.fire(fa,fH[fc])};e9=(function(fN){return function(fO){return di.do_delete(cf.active_user,fO.memo.fq_path)}})(this);fD=function(){var fN;if(!fu){fN=br("#file-preview-modal");fN.on("click",".close",fh);key("esc",aD.KEY_SCOPE,(function(fO){if(br("#lightbox-more-actions-button").hasClass("toggled")){return fM()}else{if(e0){return fA()}else{return fh(fO)}}}));fN.on("click",".next",eX);fN.on("click",".prev",fi);fN.on("click",".preview-container",fq);key("left, k",aD.KEY_SCOPE,function(fO){return fi()});key("right, j",aD.KEY_SCOPE,function(fO){eX();return false});key("up, down",aD.KEY_SCOPE,function(fO){return false});key("x, s, space",aD.KEY_SCOPE,function(fO){eV(fO);return false});if(fF.include_delete&&fF.share_button_experiment_variant!=="WHITE_BUTTON"){key("delete, command+backspace, backspace",aD.KEY_SCOPE,function(fO){Event.extend(fO).preventDefault();return aD.toggle_delete()});br("#lightbox-delete-photo").on("click",(function(fO){fl();return fH[fc].delete_pressed()}));br("#lightbox-delete-cancel").on("click",fA)}ei.add_exit_callback("/lightbox",function(){return fB()});dL.disableSelection(fN.find(".preview-container")[0]);dL.disableSelection(fN.find(".header")[0]);fu=true}Event.observe(document,"mousemove",fs);Event.observe(document,"click",fs);document.observe(aB.DELETE,fG);document.observe(aD.PHOTO_DELETE_EVT,e9);document.observe(ez.CHANGE_EVT,e3);key.setScope(aD.KEY_SCOPE);return fk=setInterval(fj,500)};fz=function(){var fP,fR,fQ,fO,fN;if(!e4){return}fN=[];for(fP=fQ=0,fO=fH.length;fQ<fO;fP=++fQ){fR=fH[fP];if(fR.link_hash&&fR.link_hash.toLowerCase()===e4.toLowerCase()){fc=fP;if(!aD.shown){fN.push(aD.show())}else{fN.push(fr())}}else{fN.push(void 0)}}return fN};fJ=function(){return on_script_loaded(function(){aU.watch("lh",function(fN){e4=fN;return fz()});return aU.watch("f",function(fP){var fQ,fS,fR,fO,fN;fN=[];for(fQ=fR=0,fO=fH.length;fR<fO;fQ=++fR){fS=fH[fQ];if(fS.filename.toLowerCase()===fP.toLowerCase()){fc=fQ;if(!aD.shown){fN.push(aD.show())}else{fN.push(fr())}}else{fN.push(void 0)}}return fN})})};e3=function(fR,fT){var fP,fS,fO,fQ,fN;if(fT==null){fT=br("#lightbox_share")}fO=ez.get();fQ=cR.categorize_files(fO),fP=fQ[0],fS=fQ[1];if(fO.length===0){fT.text(ef("Share"));return(fN=fH[fc])!=null?fN.toggle_select_button_off(br("#lightbox-select-button")):void 0}else{if(fO.length===1){if(fP){return fT.text(ef("Share 1 photo"))}else{return fT.text(ef("Share 1 video"))}}else{if(fP&&fS){return fT.text(ef("Share %(num_files)s items",{comment:"num_files is a number greater than 1"}).format({num_files:fO.length}))}else{if(fP){return fT.text(ef("Share %(num_photos)s photos",{comment:"num_photos is a number greater than 1"}).format({num_photos:fO.length}))}else{return fT.text(ef("Share %(num_videos)s videos",{comment:"num_videos is a number greater than 1"}).format({num_videos:fO.length}))}}}}};fe=function(){bd.hide_all();br("#file-preview-modal .delete-file-prompt").show();br(document).trigger("dropdownOpened",[1]);fd();e0=true;fE(aD.toggle_delete);return br("#lightbox-delete-photo").focus()};fA=function(){var fO,fN;if(e0){fO=br("#file-preview-modal .delete-file-prompt");fO.hide();br(document).trigger("dropdownClosed",[1]);if((fN=fO.find(":focus")[0])!=null){fN.blur()}fs();e0=false;return e7()}};fl=function(){fM();if(e0){return fA()}else{return fe()}};eZ=function(){return fH[fc].delete_pressed()};return{init_from_preview_objs:function(fQ,fU,fP){var fT,fS,fN,fR,fO;if(fP==null){fP=true}fN=[];for(fR=0,fO=fQ.length;fR<fO;fR++){fT=fQ[fR];if(fT.is_video){fS=new bt({filename:fT.filename,fq_path:fT.path,thumbnail_url_tmpl:fT.thumbnail_url,preview_url:fT.preview_url,dl_url:fT.dl_url,shmodel_link:fT.shmodel_link,ns_id:fT.ns_id,ns_path:fT.path,link_hash:fT.item_id+"-"+fT.filename,metadata_link:fT.metadata_link})}else{fS=new V({filename:fT.filename,fq_path:fT.path,thumbnail_url_tmpl:fT.thumbnail_url,dl_url:fT.dl_url,original_url:fT.orig_url,shmodel_link:fT.shmodel_link,ns_id:fT.ns_id,ns_path:fT.ns_path,link_hash:fT.item_id+"-"+fT.filename,enable_download:fT.enable_download})}fN.push(fS)}aD.init(fN,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:fP});return document.on(aD.EXIT_SELECT_EVT,(function(fV){return function(fX){var fW;key.setScope("all");fW=br(fU)[fN.indexOf(fX.memo)];dL.scroll_to_thumb(fW);br(fW).addClass("wiggobble");return setTimeout((function(){return br(fW).removeClass("wiggobble")}),1000)}})(this))},init:function(fN,fO){if(aD.shown){return}aD.more_actions_button=new Element("a",{id:"lightbox-more-actions-button",href:"#","class":"lightbox-more-actions-button title_bubble black extra-margin",title:ef("More actions")});aD.more_actions_button.observe("click",((function(fP){return function(fQ){fQ.preventDefault();return aD.toggle_more_actions_menu()}})(this)));aD.more_actions_button.__date(cj.make("web","lightbox_more"));fO=fO||{};fF={include_delete:fO.include_delete||false,keep_url:fO.keep_url||false,num_previews:fO.num_previews||null,filename_in_url:fO.filename_in_url||false,no_wrap:(fO.no_wrap||false)||true,no_preload:fO.no_preload||false,enable_sublinks:fO.enable_sublinks!=null?fO.enable_sublinks:true,share_button_experiment_variant:fO.share_button_experiment_variant||false};fn=fO.is_loading||false;cw(!fF.filename_in_url||fF.keep_url,"filename_in_url cannot be used with keep_url off");fH=fN;if(fO.start_index!=null){aD.show(fO.start_index)}if(fF.filename_in_url){fJ()}return $(document.body).on("click",".more-actions-item",function(fP,fQ){if(fQ.down("a").getAttribute("href").length<2){fP.preventDefault()}return aD.close_more_actions_menu()})},update_previews:function(fN){return fH=fN},show:function(fN){var fO,fP;if(aD.shown){return}cw(fH&&fH.length,"Lightbox.show() requires file preview objects to show");fD();if(fN!=null){fc=fN}br("#file-preview-modal").trigger("lightbox-init-show",{preview:fH[fc]});if((fP=fH[fc])!=null?fP.enable_download:void 0){aD.more_actions_button.show()}else{aD.more_actions_button.hide()}cw(!aD.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();z.scroll_lock_document();fr(true);aD.shown=1;if(!fF.keep_url){fO=ei.deconstruct_url(ei.get_url());if(fO.path.indexOf("/lightbox/")!==0){ei.push_state("/lightbox"+fO.path,fO.qargs)}}return fs()},jump_to:function(fN){cw(aD.shown,"Lightbox should be showing");fc=fN;fr();return fs()},set_no_wrap:function(fN){return fF.no_wrap=fN},refresh_file_list:function(fQ){var fP,fS,fO,fR,fN;if(aD.shown){fS=fH[fc].fq_path}fH=aW.browsefile_to_filepreview(fQ);fz();if(!aD.shown){return}for(fO=fR=0,fN=fH.length;fR<fN;fO=++fR){fP=fH[fO];if(fP.fq_path===fS){fc=fO;break}}fn=false;T=false;return fw()},update_with_error:function(){eY=true;return fw()},num_previews:function(){return fF.num_previews||fH.length},get_previews:function(){return fH},current_index:function(){return fc},close_more_actions_menu:fM,toggle_more_actions_menu:e5,update_share_button_text:e3,toggle_delete:fl,delete_current:eZ,back:fh,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:fa,reload:false,NEXT:1,PREV:-1,vid_thumbnail_hidden:null,KEY_SCOPE:"lightbox",LIGHTBOX_HIDE_EVT:"lightbox-hide",LIGHTBOX_SHOW_EVT:"lightbox-preview"}})();var bs;bs=B.Tour=(function(){var eV,eU,eX,eY,e2,e0,e1,eZ,eW,e3,eT,T;eU=6;eV=0;eT=function(e4){var fd,fc,fb,e6,e5,e7,e9,fa,e8;$$(".page-end").each(Element.remove);e5=e4;e9=eU-e4-1;fd=document.createDocumentFragment();for(fc=fa=0;0<=e5?fa<e5:fa>e5;fc=0<=e5?++fa:--fa){e6=new Element("img",{src:"/static/images/page-left-vflvWgvOr.png","class":"page-end-left page-end"});e6.style.left=(28-fc*5)+"px";e6.style.zIndex=eU-fc;fd.appendChild(e6)}for(fb=e8=0;0<=e9?e8<e9:e8>e9;fb=0<=e9?++e8:--e8){e7=new Element("img",{src:"/static/images/page-right-vflnAeb-6.png","class":"page-end-right page-end"});e7.style.right=(31-fb*5)+"px";e7.style.zIndex=eU-fb;fd.appendChild(e7)}return $("book").appendChild(fd)};T=function(e4){(e4>0?Element.show:Element.hide)("tour-page-back");return(e4+1<eU?Element.show:Element.hide)("tour-page-forward")};eW=function(e4){$$(".pages").invoke("hide");return $("page-"+e4).show()};eX=function(e4){T(e4);eT(e4);eW(e4);return eV=e4};eZ=function(e5){var e4;Event.extend(e5).preventDefault();e4=eV-1;if(e4<0){return}eX(e4);return ei.push_state("/tour/"+e4)};e0=function(e5){var e4;Event.extend(e5).preventDefault();e4=eV+1;if(e4>=eU){return}eX(e4);return ei.push_state("/tour/"+e4)};e3=function(e5,e6){var e4;e5.preventDefault();e4=parseInt(e6.href.split("/").last(),10);eX(e4);return ei.push_state("/tour/"+e4)};e2=function(){$("tour-page-back").observe("click",eZ);$("tour-page-forward").observe("click",e0);key("right",e0);key("left",eZ);return $("toc").on("click","a",e3)};eY=function(e5,e6){var e4;e4=parseInt(e5,10)||0;if(e4<0||e4>=eU){e4=0}return eX(e4)};e1=function(){var e8,e7,e5,e6,e4;e6=$$(".page-right img");e4=[];for(e7=0,e5=e6.length;e7<e5;e7++){e8=e6[e7];e4.push(dL.preload_image(e8.src))}return e4};return{setup:function(){return br(function(){ei.add_callback("/tour",eY);e2();return e1()})}}})();var bC,bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1};bC=INLINE_JS.Photos=B.Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(eY,eT,eV,e2,eZ,eU,T,e0,e4){var eX,e1,e3,eW;this.event_metadata_cache=T;this.initialized=true;this.disable_selection();dL.disable_ie_image_dragging();this._tmpl=eP.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=eP.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=eZ!=null?eZ.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=e0.include_shared_folders;this.show_hidden=e0.show_hidden;this.timestamp_edit_enabled=e4.timestamp_edit_enabled;this.undo_enabled=e4.undo_enabled;this.local_storage_enabled=e4.local_storage_enabled;e1=ei.deconstruct_url();eW="share" in e1.qargs;for(e3 in e2){if(e2.hasOwnProperty(e3)){ez.inc_num_loading_events_before_select(eW)}}this._init_timeline(eY,eT,eV,e2);this._init_lightbox();eX=[];if(eZ!=null){eX.push(new Z(eZ,false))}ct.init(eX,eU);ez.drag_select_enabled=e4.drag_select_enabled;if(e0.show_photos_tour){aE.next()}delete e1.qargs.selr;delete e1.qargs.user_email;delete e1.qargs.uid;delete e1.qargs.share;delete e1.qargs.m;if("uuid" in e1.qargs){delete e1.qargs.uuid;delete e1.qargs.id}if(ds){ei.replace_state(e1.path,e1.qargs)}else{if(!D.parse(window.location.href).fragment){ei.push_state("/photos",e1.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(aD.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(aD.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(aD.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(aD.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(bc.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));ei.add_callback("/photos",this._history_change_handler.bind(this));document.observe(cU.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(cU.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(b6.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(b6.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));br("#photos-nav-item").on("click",this.show_all_photos.bind(this));br("#back-to-photos").on("click",this._back_to_photos.bind(this));br("#back-to-albums").on("click",this._back_to_albums.bind(this));br("#share-selected").on("click",this._share_selected.bind(this));br("#clear-selected").on("click",this._clear_selected.bind(this));br("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){br("#do-include-shared-folders").prop("checked",true)}else{br("#dont-include-shared-folders").prop("checked",true)}ct.listen();ez.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));$(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this));return br(".show-all-photos").on("click",this.show_all_photos.bind(this))},_select_event:function(eZ){var eV,eY,eU,eX,eT,eW,T;eY=$(eZ.target).up(".cu-month-header").identify().slice(2);eV=this.get_timeline().events.valueFromKey(eY);eW=eV.photos;T=[];for(eX=0,eT=eW.length;eX<eT;eX++){eU=eW[eX];T.push(ez._add(eU))}return T},_share_event:function(eY){var eU,eX,eT,eW,T,eV;eX=$(eY.target).up(".cu-month-header").identify().slice(2);eU=this.get_timeline().events.valueFromKey(eX);eV=eU.photos;for(eW=0,T=eV.length;eW<T;eW++){eT=eV[eW];ez._add(eT)}return this._share_selected()},_add_event_to_album:function(eY){var eU,eX,eT,eW,T,eV;eX=$(eY.target).up(".cu-month-header").identify().slice(2);eU=this.get_timeline().events.valueFromKey(eX);eV=eU.photos;for(eW=0,T=eV.length;eW<T;eW++){eT=eV[eW];ez._add(eT)}return ct.show_add_to_album_modal(eY,ez.get())},_init_timeline:function(eZ,eU,eV,e1){var eT,e2,e0,T,e3,eY,eX,eW;if(!eZ.length){this.show_empty_state();return}eT=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");eY=$("cu-view").cumulativeOffset().top+eT.getLayout().get("margin-top")+eT.getLayout().get("padding-top");if(br("#carousel-promo-banner").outerHeight()){eY+=br("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}e0=$("cu-view").cumulativeOffset().left+eT.getLayout().get("margin-left")+eT.getLayout().get("padding-left");e2={top_offset:eY,left_offset:e0,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};T={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};e3=new b6(eT,null,eZ,eU,eV,e1,this._tmpl,e2,T);if(this.in_single_collection_view()){if((eX=this._single_collection_timeline)!=null){eX.unlisten()}this._single_collection_timeline=e3}else{if((eW=this._all_photos_timeline)!=null){eW.unlisten()}this._all_photos_timeline=e3}return this.get_timeline().render()},_init_lightbox:function(){var eT,T;if(this.get_timeline()==null){return}if(aD.shown){T=this.get_timeline().get_preview_objs();if(T.length){aD.update_previews(T);eT=Math.min(aD.current_index(),T.length-1);return aD.jump_to(eT)}else{return aD.back()}}else{return aD.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(eT){var T;if((T=this.get_timeline())!=null){T.unlisten()}ez.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(eT);return window.scrollTo(0,0)},_refresh_photo_events:function(T){this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:(function(eT){return function(eU){var eV;eV=JSON.parse(eU.responseText);if(eV==="deleted_collection"){eT._current_collection_gid=null;ct.reload();eT.show_all_collections();ab.error(ef("This album has been deleted!"));return}eT._init_timeline(eV.header_ids,eV.header_id_to_name,eV.header_id_to_num_photos,{});eT._init_lightbox();return typeof T==="function"?T():void 0}})(this)})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(T){if(T.duplicates_info!=null){return this._show_duplicates_modal(T,false)}else{return window.open(this._get_browse_link(T),"_blank")}},_get_browse_link:function(eT){var T;T=eR.get_browse_root(cy.get_viewer().photos_user);return String(D({path:""+T+(au.normalize(au.parent_dir(eT.fq_path))),query:{select:eT.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return ct.get(this._current_collection_gid)}else{return null}},enable_selection:function(){return dL.enableSelection($(document.body))},disable_selection:function(){return dL.disableSelection($(document.body))},show_collection:function(eU){var eT,T;h.log_transition_to(b9.SINGLE_COLLECTION_VIEW);T=ei.deconstruct_url();eT="/lightbox";if(T.path.indexOf(eT)===0){T.path=T.path.slice(eT.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(bx.call(T.path,"/album/")<0){if(T.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(eU!=null){T.path=ct.get(eU).url}return ei.push_state(T.path,T.qargs)},show_all_collections:function(){h.log_transition_to(b9.ALBUMS_VIEW);return ei.push_state("/photos/all_albums")},show_all_photos:function(eT){var T;eT.preventDefault();h.log_transition_to(b9.PHOTOS_VIEW);T=ei.deconstruct_url();if(T.path==="/photos"){return this._refresh_view()}else{ez.clear();return ei.push_state("/photos")}},_back_to_photos:function(T){ez.clear();return this.show_all_photos(T)},_back_to_albums:function(T){ez.clear();return this.show_all_collections()},get_thumb_click_event_data:function(eU,T){var eT;eT=eU.event;return{timeline_photo_index:T,event_photo_index:eT.photos.indexOf(eU),num_photos_in_event:eT.photos.length,event_index:this.get_timeline().events.list.indexOf(eT.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(eT){var T;T=this.get_timeline().get_photo_for_thumb_elm($(eT.target));if(ez._drag_drop.ignore_next_click){return ez._drag_drop.ignore_next_click=false}else{return ez.photo_click(eT,T)}},_thumb_double_click:function(eV){var eU,eT,T;eT=this.get_timeline().get_photo_for_thumb_elm($(eV.target));T=this.get_timeline().index_of_photo(eT);this._preview(T);eU=this.get_thumb_click_event_data(eT,T);return h.log_interaction(d2.OPEN_LIGHTBOX,cT.DBL_CLICK,eU)},_thumb_context_menu:function(eX){var eU,eY,eW,eT,eV,T;eU=this.get_timeline().get_photo_for_thumb_elm($(eX.target));if(eX.shiftKey){ez.photo_click(eX,eU);return}if(ez.contains(eU)){eY=ez.get()}else{eY=[eU]}bc.show_photos(eX,eY);T=[];for(eW=0,eT=eY.length;eW<eT;eW++){eU=eY[eW];T.push((eV=this.get_timeline().get_thumb_elm_for_photo(eU))!=null?eV.addClassName("context-selected"):void 0)}return T},_context_menu_hide:function(T){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(eT){var T;T=ez.get();if(!T.length){return}ee.show(T,false);return h.log_interaction(d2.SHARE,cT.SAH,{num_photos:T.length})},_clear_selected:function(eT){var T;T=ez.get().length;ez.clear();return h.log_interaction(d2.CLEAR_SELECTED,cT.SAH,{num_photos:T})},_share_collection:function(eT){var T;cw(this.in_single_collection_view(),"_share_collection can only happen in single collection view");T=this.get_current_collection();if(T.num_items===0){ab.error(ef("This album is empty. Add some photos before you share it!"));return}ee.show(this.get_current_collection(),true);return h.log_interaction(d2.SHARE_ALBUM,cT.SCA)},toggle_mem_lane_settings:function(T){var eU,eT;if(T){Event.extend(T).preventDefault()}if(!br("#memory-lane-settings-menu").visible()){eT=br("#memory-lane-settings-menu");ex.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));eU=function(eV){return eV.stopPropagation()};eT.off("mousedown");eT.off("click");eT.on("mousedown",eU);return eT.on("click",eU)}},show_delete_photos_modal:function(e0){var e1,eX,eU,eY,T,eT,eV,eZ,eW;if(e0.length===1){eT=e0[0];if(eT.duplicates_info!=null){this._show_duplicates_modal(eT,true);return}}else{e1=[];for(eV=0,eZ=e0.length;eV<eZ;eV++){eT=e0[eV];if(eT.duplicates_info!=null){eX=eT.duplicates_info.slice(0);eX.push(eT);eX.sort(function(e3,e2){return e2.mtime-e3.mtime});e1=e1.concat(eX)}}if(e1.length){this._show_delete_multiple_duplicates_modal(e0,e1);return}}eW=cR.categorize_files(e0),eY=eW[0],T=eW[1];if(eY&&T){eU=a1("Delete %(file_count)s item?","Delete %(file_count)s items?",e0.length)}else{if(eY){eU=a1("Delete %(file_count)s photo?","Delete %(file_count)s photos?",e0.length)}else{eU=a1("Delete %(file_count)s video?","Delete %(file_count)s videos?",e0.length)}}return dt.show({title_text:eU.format({file_count:e0.length}),body_html:ef("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:cR.file_desc(e0)}),confirm_text:ef("Delete"),cancel_text:ef("Cancel"),confirm_callback:(function(e2){return function(){return e2._delete_photos(e0)}})(this)})},_delete_photos:function(e7){var e3,e1,eV,e4,T,eT,e6,e0,eY,eX,e5,eU,eZ,eW,e2;e7=e7.slice(0);e6=[];for(eY=0,e5=e7.length;eY<e5;eY++){eT=e7[eY];e6.push(eT.fq_path);if(eT.duplicates_info!=null){eZ=eT.duplicates_info;for(eX=0,eU=eZ.length;eX<eU;eX++){eV=eZ[eX];e6.push(eV.fq_path)}}}eW=cR.categorize_files(e7),e4=eW[0],T=eW[1];if(e4&&T){e1=a1("Deleting file","Deleting files",e6.length);e3=a1("Deleted file.","Deleted files.",e6.length)}else{if(e4){e1=a1("Deleting photo","Deleting photos",e6.length);e3=a1("Deleted photo.","Deleted photos.",e6.length)}else{e1=a1("Deleting video","Deleting videos",e6.length);e3=a1("Deleted video.","Deleted videos.",e6.length)}}e2=function(e8){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(e8)},html_in_error_msg:true,progress_text:ef("Undoing..."),onSuccess:function(e9){var fa;fa=ef("Undo complete");ab.success(fa);return bC._all_photos_timeline.restore_removed_photos()},subject_user:cy.get_viewer().photos_user})};e0=(function(e8){return function(e9){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:e6},job:e6.length>bC.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:cy.get_viewer().photos_user,progress_text:e1,onSuccess:function(fc){var fa,fd,fb;fd=fc.responseText.evalJSON();fb=bC.undo_enabled&&(bC._all_photos_timeline!=null);fa=fb?fd.changesets:null;U.notifyWithUndo(e1,fa,e2);bC.get_timeline().remove_photos(e7);if(e9.length>0){return ct.refresh_album_views(e9)}},subject_user:cy.get_viewer().photos_user})}})(this);return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(e6)},onSuccess:(function(e8){return function(fb){var fa,e9,fc,fd;e9=JSON.parse(fb.responseText);fc=[];for(fd in e9){fa=e9[fd];fc=fc.concat(fa)}return e0(fc)}})(this)})},_preview:function(T){return aD.show(T)},_lightbox_delete:function(T){var eT;eT=T.memo.photo;h.log_interaction(d2.DELETE,cT.LIGHTBOX);return this.show_delete_photos_modal([eT])},_lightbox_remove:function(eT){var T;T=eT.memo.photo;this.get_current_collection().remove_photos([T]);return h.log_interaction(d2.REMOVE,cT.LIGHTBOX)},_show_duplicates_modal:function(eT,e8){var e0,e7,eY,e2,e1,eV,e4,eU,eZ,e3,T,e6,eW,e5,eX;e1=eT.duplicates_info.slice(0);e1.push(eT);e1.sort(function(fa,e9){return e9.mtime-fa.mtime});e2=$("cu-duplicate-files");eV=[];for(eW=0,e5=e1.length;eW<e5;eW++){eY=e1[eW];e7="Dropbox"+au.normalize(au.parent_dir(eY.fq_path));eV.push(this._cu_duplicate_tmpl({thumbnail_url:eY.thumbnail_url,filename_snippet:bG.em_snippet(eY.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bG.em_snippet(e7,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(eY)}))}e2.__date(eV);if(e1.length>=5){e2.addClassName("scroll")}else{e2.removeClassName("scroll")}eX=cR.categorize_files([eT]),e3=eX[0],T=eX[1];if(e3){eU=ef("There are multiple copies of this photo.");eZ=ef("Delete all copies of this photo?")}else{eU=ef("There are multiple copies of this video.");eZ=ef("Delete all copies of this video?")}if(e8){e4="delete_32";e6=eZ;e0=eU+" "+ef("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{e4="folder_32";e6=ef("Show in folder");e0=eU+" "+ef("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}c9.fillVal(e0,"cu-duplicates-desc");return eM.show(e6,$("cu-duplicates-modal"),{action:this._delete_photos.curry([eT])})},_show_delete_multiple_duplicates_modal:function(e5,e0){var e4,eY,e1,eU,eT,eZ,eX,e2,T,eV,e3,eW;e1=$("cu-multiple-duplicate-files");eU=[];for(eV=0,e3=e0.length;eV<e3;eV++){eY=e0[eV];e4="Dropbox"+au.normalize(au.parent_dir(eY.fq_path));eU.push(this._cu_duplicate_tmpl({thumbnail_url:eY.thumbnail_url,filename_snippet:bG.em_snippet(eY.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bG.em_snippet(e4,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(eY)}))}e1.__date(eU);if(e0.length>=5){e1.addClassName("scroll")}else{e1.removeClassName("scroll")}eW=cR.categorize_files(e5),e2=eW[0],T=eW[1];if(e2&&T){eT=ef("Delete %(num_files)s files and all copies?").format({num_files:e5.length});eZ=ef("There are multiple copies of these files in your Dropbox.");eX=ef("Show files with multiple copies")}else{if(e2){eT=ef("Delete %(num_photos)s photos and all copies?").format({num_photos:e5.length});eZ=ef("There are multiple copies of these photos in your Dropbox.");eX=ef("Show photos with multiple copies")}else{eT=ef("Delete %(num_videos)s videos and all copies?").format({num_videos:e5.length});eZ=ef("There are multiple copies of these videos in your Dropbox.");eX=ef("Show videos with multiple copies")}}c9.fillVal(eZ,"cu-multiple-duplicates-desc");c9.fillVal(eX,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return eM.show(eT,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(e5)})},show_timestamps_modal:function(eX){var eT,eU,eV,T,eW;eX.sort_by_key((function(eY){return eY.time_taken}),true);T=(function(){var e0,eZ,eY;eY=[];for(e0=0,eZ=eX.length;e0<eZ;e0++){eV=eX[e0];eY.push(eV.time_taken)}return eY})();eT=(function(){var e0,eZ,eY;eY=[];for(e0=0,eZ=eX.length;e0<eZ;e0++){eV=eX[e0];eY.push(eV.item_counter)}return eY})();eU=(function(){var e0,eZ,eY;eY=[];for(e0=0,eZ=T.length;e0<eZ;e0++){eW=T[e0];if(eW==null){eY.push(eW)}}return eY})();if(eU.length===T.length){return this._show_add_timestamps_modal(eX,T,eT)}else{if(eU.length===0){return this._show_edit_timestamps_modal(eX,T,eT)}else{return cw(false,"Timestamp modal should only open when all selected photos either have or don't have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(T,eT){return this._refresh_photo_events((function(eU){return function(){var eV,eW;eW=("m_"+(eT.getFullYear()))+(""+(eT.getMonth()+1)).lpad(2);eV=eU.get_timeline().events.valueFromKey(eW);cw(eV!=null,"Event is missing after a timestamp edit!");eg.update("2/3");eV.on_load_all_metadata=function(){eU.get_timeline().scroll_to_photo_with_key(T.uniqueness_key);eg.hide();return ab.success("New timestamps have been saved!")};if(eV.has_loaded_metadata()){eV.on_load_all_metadata();return eV.on_load_all_metadata=null}else{return eV.load_metadata()}}})(this))},_show_add_timestamps_modal:function(eW,eT,T){var eV,eU;eU=br("#add-timestamp-modal");eV=new F("date_picker",{disable_future:true});return eM.show("Set Timestamps",eU[0],{action:(function(eX){return function(){var e1,e5,e3,e4,eZ,e0,e2,eY;e3=dL.to_iso8601_date(eV.selected_date,false,true);e4=(function(){var e8,e7,e6;e6=[];for(e0=e8=0,e7=eW.length;0<=e7?e8<e7:e8>e7;e0=0<=e7?++e8:--e8){e6.push(e3)}return e6})();eZ={};for(e1=e2=0,eY=T.length;e2<eY;e1=++e2){e5=T[e1];eZ[e5]=e4[e1]}eg.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(eZ)},onSuccess:function(e6){eg.update("1/3");return eX._scroll_to_photo_after_timestamp_edit(eW[0],eV.selected_date)}})}})(this)})},_show_edit_timestamps_modal:function(e0,eZ,eV){var T,eY,eU,eW,eX,eT;eY=br("#edit-timestamp-modal");T=(function(){var e3,e2,e1;e1=[];for(e3=0,e2=eZ.length;e3<e2;e3++){eW=eZ[e3];e1.push(K.toUTCDate(new Date(eW)))}return e1})();eU={year:0,month:0,day:0,hour:0};eX=function(e1){return ef("%(date)s at %(time)s").format({date:K.localize(e1),time:K.format(e1,Constants.time_format)})};eT=function(e1,e5,e6,e4){var e3,e2;if(e1==null){e1=0}if(e5==null){e5=0}if(e6==null){e6=0}if(e4==null){e4=0}eU.year+=e1;eU.month+=e5;eU.day+=e6;eU.hour+=e4;e2=bR.increment_date(new Date(T[0]),eU.year,eU.month,eU.day,eU.hour,0);e3=bR.increment_date(new Date(T[T.length-1]),eU.year,eU.month,eU.day,eU.hour,0);if(e0.length===1){return eY.find("#timestamp-new").text(eX(e2))}else{eY.find("#timestamp-new-start").text(eX(e2));return eY.find("#timestamp-new-end").text(eX(e3))}};if(e0.length===1){eY.find("#edit-timestamp-single").show();eY.find("#edit-timestamp-multi").hide();eY.find("#timestamp-current").text(eX(T[0]))}else{eY.find("#edit-timestamp-single").hide();eY.find("#edit-timestamp-multi").show();eY.find("#timestamp-current-start").text(eX(T[0]));eY.find("#timestamp-current-end").text(eX(T[T.length-1]))}eT();br("#timestamp-year-plus").on("click",eT.curry(1,0,0,0));br("#timestamp-year-minus").on("click",eT.curry(-1,0,0,0));br("#timestamp-month-plus").on("click",eT.curry(0,1,0,0));br("#timestamp-month-minus").on("click",eT.curry(0,-1,0,0));br("#timestamp-day-plus").on("click",eT.curry(0,0,1,0));br("#timestamp-day-minus").on("click",eT.curry(0,0,-1,0));br("#timestamp-hour-plus").on("click",eT.curry(0,0,0,1));br("#timestamp-hour-minus").on("click",eT.curry(0,0,0,-1));eM.onHide=function(){var e1,e4,e2,e3;e3=["year","month","day","hour"];for(e4=0,e2=e3.length;e4<e2;e4++){e1=e3[e4];br("#timestamp-"+e1+"-plus").off("click");br("#timestamp-"+e1+"-minus").off("click")}eM.onHide=null;return eM.hide()};return eM.show("Edit Timestamps",eY[0],{action:(function(e1){return function(){var fb,e8,e2,e3,e9,fd,fa,e6,fc,e7,e5,e4;if((((eU.year===(e4=eU.month)&&e4===(e5=eU.day))&&e5===(e7=eU.hour))&&e7===0)){return}h.log_interaction(d2.EDIT_TIMESTAMP,cT.PCM,{num_photos:e0.length});e3=(function(){var fg,ff,fe;fe=[];for(fg=0,ff=T.length;fg<ff;fg++){fb=T[fg];fe.push(bR.increment_date(fb,eU.year,eU.month,eU.day,eU.hour,0))}return fe})();e9=(function(){var fg,ff,fe;fe=[];for(fg=0,ff=e3.length;fg<ff;fg++){fd=e3[fg];fe.push(dL.to_iso8601_date(fd,false,true))}return fe})();fa={};for(e8=e6=0,fc=eV.length;e6<fc;e8=++e6){e2=eV[e8];fa[e2]=e9[e8]}eg.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fa)},job:e0.length>e1.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:cy.get_viewer().photos_user,onSuccess:function(fe){eg.update("1/3");return e1._scroll_to_photo_after_timestamp_edit(e0[0],e3[0])}})}})(this)})},_preload_file_previews:function(eV){var e1,eZ,eU,T,e6,e5,e2,e0,e3,eY,eX,e4,eT,eW;e3=this.get_timeline().get_photos();if(eV[0]<=eV[eV.length-1]){e0=null;for(eY=0,e4=eV.length;eY<e4;eY++){eZ=eV[eY];T=e3[eZ];if(T.status!==H.PLACEHOLDER){continue}e6=T.event;if(e0==null){e0=e6;e2=T}if(e6===e0){continue}if(e0.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}e0.load_metadata();e0=e6;e2=T}if((e0!=null)&&!e0.has_loaded_metadata()){e1=e0.photos.indexOf(e2);eU=e0.photos.indexOf(T);if(e0.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return e0.load_metadata_range(e1,eU)}}else{eW=[];for(eX=0,eT=eV.length;eX<eT;eX++){eZ=eV[eX];T=e3[eZ];if(T.status!==H.PLACEHOLDER){continue}e6=T.event;e5=e6.photos.indexOf(T);eW.push(e6.load_metadata(e5))}return eW}},_lightbox_photo_change:function(e0){var T,e2,eX,e1,eY,eW,eZ,eV,eU,eT;this._last_lightbox_photo=e0.memo.preview_obj.photo;T=e0.memo.index;eX=aD.num_previews();if(T===0||T===eX-1){return}if(e0.memo.direction===aD.NEXT||(e0.memo.direction==null)){e2=Math.min(T+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,eX-1);return this._preload_file_previews((function(){eU=[];for(var e3=eZ=T+1;eZ<=e2?e3<=e2:e3>=e2;eZ<=e2?e3++:e3--){eU.push(e3)}return eU}).apply(this))}else{if(e0.memo.direction===aD.PREV){e1=Math.max(T-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){eT=[];for(var e3=eV=T-1;eV<=e1?e3<=e1:e3>=e1;eV<=e1?e3++:e3--){eT.push(e3)}return eT}).apply(this))}}},_lightbox_exit:function(T){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var eU,eT,eV,T;eT=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");if(br("#carousel-promo-banner").outerHeight()){eT+=br("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}eU=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((eV=this._all_photos_timeline)!=null){eV.update_offsets(eT,eU)}return(T=this._single_collection_timeline)!=null?T.update_offsets(eT,eU):void 0},_history_change_handler:function(e5,e4){var e0,e1,e2,eX,eV,eY,e3,eZ,eW,eU,eT,T;if(this._init_finished){if(eM.shown()){eM.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((eZ=this.get_timeline())!=null){eZ.unlisten()}if(e5==="all_albums"){ct.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((eW=$("all-albums-sidebar"))!=null){eW.addClassName("selected")}ez.clear();document.title=ef("Albums")+" - Dropbox";ct.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(e5.startsWith("album/")){e0=ct.get_from_url("/photos/"+e5);eU=$$(".sidebar-album");for(eY=0,e3=eU.length;eY<e3;eY++){e2=eU[eY];if(e2.readAttribute("data-gid")===e0.gid){e2.addClassName("selected");break}}$("single-collection-title").__date(bG.em_snippet(e0.name,ct.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(e0.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",e0.shmodel_url);if(((eT=e0.member_fnames)!=null?eT.length:void 0)>1){e1=ef("%(photo_video_desc)s from %(album_members)s",{comment:'for example: "3 photos and 1 video from Peter, Boris, and Ryan"'}).format({photo_video_desc:cR.album_desc(e0),album_members:dL.nice_list(e0.member_fnames)});$("single-collection-share-status").__date(e1)}else{$("single-collection-share-status").__date(ef("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!e0.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=""+e0.name+" - Dropbox";cl.log_event("show_collection",e0.gid,e0.num_photos,e0.is_anonymous)}else{e0=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=ef("Photos")+" - Dropbox"}eX=false;if(e0!=null){if(e0.gid!==this._current_collection_gid){eX=true}}else{if(this._all_photos_timeline==null){eX=true}}this._current_collection_gid=e0!=null?e0.gid:null;if(eX){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){eV=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(eV);if((T=$(eV))!=null){T.addClassName("wiggobble")}setTimeout((function(){return $(eV).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var aE;aE=INLINE_JS.PhotosTour=B.PhotosTour={_frame:0,next:function(){var T;eM.show("",br("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);T=this._frame;h.log_interaction(aZ.SHOW_MODAL,"",{frame:T});br("#modal-x").off("click");br("#modal-x").on("click",((function(eT){return function(){return h.log_interaction(aZ.EXIT_MODAL,"",{frame:T})}})(this)));return this._frame=(this._frame+1)%4},hide:function(T){h.log_interaction(T,"");return eM.hide()}};var cR;cR=B.PhotosUtil={categorize_files:function(eT){var eU,T;eU=eT.filter(function(eV){return eV.preview_type==="photo"});T=eT.filter(function(eV){return eV.preview_type==="video"});return[eU.length,T.length]},file_desc:function(eX,eU,T){var eT,eW,eV;if(eU==null){eU=false}if(T==null){T=false}eV=this.categorize_files(eX),eT=eV[0],eW=eV[1];return this._photo_video_desc(eT,eW,eU,T)},album_desc:function(eU,eT,T){if(eT==null){eT=false}if(T==null){T=false}return this._photo_video_desc(eU.num_photos,eU.num_videos,eT,T)},_photo_video_desc:function(eT,eY,eU,T){var eV,eX,eW;eX=a1("%d photo","%d photos",eT,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(eT);eW=a1("%d video","%d videos",eY,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(eY);if(eT&&eY){if(eU){eV=eT+eY;return a1("%d item","%d items",eV).format(eV)}else{if(T){return new eP(""+eX+"<br/>"+eW)}else{return ef("%(num_photos)s and %(num_videos)s",{comment:"num_photos and num_videos may be like either '1 photo' or '%d photos'"}).format({num_photos:eX,num_videos:eW})}}}else{if(eT){return eX}else{if(eY){return eW}else{return""}}}}};var ez,bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1};ez=INLINE_JS.PhotosSelection=B.PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){$(document.body).on("keydown",(function(T){return function(eT){if(eT.keyCode===T.SHIFT_KEY_CODE&&T._last_mouseover&&!z.focus_in_input()){return T._highlight_range(T._last_selected,T._last_mouseover)}}})(this));$(document.body).on("keyup",(function(T){return function(eT){if(eT.keyCode===T.SHIFT_KEY_CODE&&!T._marquee.active){return T.clear_highlighted()}}})(this));key("delete, command+backspace, backspace",bC.KEY_SCOPE,(function(T){return function(eT){eT.preventDefault();if(bC.in_single_collection_view()){if(T._selected.length){return ct.show_remove_photos_modal(bC.get_current_collection(),T._selected)}}else{if(T._selected.length){return bC.show_delete_photos_modal(T._selected)}}}})(this));key("esc",bC.KEY_SCOPE,(function(T){return function(eU){var eT;if(typeof eU.preventDefault==="function"){eU.preventDefault()}if(T._drag_drop.active){T._drag_drop.active=false;if((eT=$("albums-sidebar-list"))!=null){eT.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{T.clear();return h.log_interaction(d2.CLEAR_SELECTED,cT.ESC)}}})(this));$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return y.init(null,br("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(eT){var T,eV,eU;eV=(function(){var eZ,eX,eY,eW;eY=this._selected;eW=[];for(eZ=0,eX=eY.length;eZ<eX;eZ++){T=eY[eZ];eW.push(T.uniqueness_key)}return eW}).call(this);return eU=eT.uniqueness_key,bx.call(eV,eU)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");ex.hide_all();return document.fire(ez.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(eT,T){if(eT.isRightClick()&&!eT.shiftKey){return}if(eT.shiftKey){return this._select_highlighted()}else{if(this.contains(T)){return this._remove(T)}else{return this._add(T)}}},num_selected:function(){return this._selected.length},refresh:function(eV){var eX,eY,eU,eZ,eW,eT,T;eZ=(function(){var e3,e1,e2,e0;e2=this._selected;e0=[];for(e3=0,e1=e2.length;e3<e1;e3++){eU=e2[e3];e0.push(eU.uniqueness_key)}return e0}).call(this);T=[];for(eW=0,eT=eV.length;eW<eT;eW++){eY=eV[eW];eX=eZ.indexOf(eY.uniqueness_key);if(eX>=0){T.push(this._selected[eX]=eY)}else{T.push(void 0)}}return T},inc_num_loading_events_before_select:function(T){if(!this._show_share_after_loading_selected){eg.show(ef("Loading photos..."))}this._show_share_after_loading_selected=T;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;eg.update(""+(this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){eg.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return bC._share_selected()}}}},_photo_mouseover:function(T){this._last_mouseover=bC.get_timeline().get_photo_for_thumb_elm($(T.target));if(T.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(T){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(eV){var T,eT,eU;if(bC.in_all_collections_view()||eV.isRightClick()||this._invalid_mouse_target($(eV.target))){return}bc.hide();ex.hide_all();T=(eU=bC.get_timeline())!=null?eU.get_photo_for_thumb_elm($(eV.target)):void 0;if(T!=null){if(this.contains(T)||!ez.drag_select_enabled){eT=z.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=eV.clientX+eT.left;this._drag_drop.start_y=eV.clientY+eT.top;this._drag_drop.anchor=$(eV.target);this._drag_drop.single_photo=this.contains(T)?null:T;this._build_drag_status(T);this._update_drag_status_position(eV)}else{this._drag_select.active=true;this._drag_select.anchor=T}}else{eT=z.scroll_offsets();if((eV.clientX+eT.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=eV.clientX+eT.left;this._marquee.start_y=eV.clientY+eT.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return y.start()},_body_mousemove:function(eV){var eT,T,eW,eU;eT=z.scroll_offsets();T=eV.clientX+eT.left;eW=eV.clientY+eT.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(T-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(eW-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=T;this._marquee.end_y=eW;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(T-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(eW-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(eV);$$(".sidebar-album").invoke("removeClassName","album-flash");if((eU=$("albums-sidebar-list"))!=null){eU.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(eU){var eT,T;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();eT=this._highlighted.length;this._select_highlighted();if(eT){h.log_interaction(d2.MARQUEE_SELECT,cT.DRAG,{num_selected:eT})}}if(this._drag_drop.active){if($(eU.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((T=$("albums-sidebar-list"))!=null){T.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return y.end()},_body_double_click:function(T){if(bC.get_timeline().get_photo_for_thumb_elm($(T.target))||this._invalid_mouse_target($(T.target))){return}this.clear();return h.log_interaction(d2.CLEAR_SELECTED,cT.DBL_CLICK)},_draw_marquee:function(){var T,eW,eV,eU,eT;eT=Math.abs(this._marquee.start_x-this._marquee.end_x);T=Math.abs(this._marquee.start_y-this._marquee.end_y);eV=Math.min(this._marquee.start_y,this._marquee.end_y);eW=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:eT+"px",height:T+"px",top:eV+"px",left:eW+"px"});$("marquee").show();eU=false;if(bC.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);eU=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);eU=true}if(eU){return this._update_marquee_highlight(eV,eW,eT,T)}}},_update_marquee_highlight:function(e3,eU,T,e5){var e1,e2,eZ,eT,eY,eX,e4,e0,eW,eV;this.clear_highlighted();eT=[];e2=bC.get_timeline().grid.photo_col_offsets.length;e0=bC.get_timeline().grid.photo_col_offsets.slice(0,e2-1);for(e1=eY=0,e4=e0.length;eY<e4;e1=++eY){eZ=e0[e1];if(eZ<=eU+T&&bC.get_timeline().grid.photo_col_offsets[e1+1]>=eU){eT.push(e1)}}eV=[];for(e1=eX=0,eW=bC.get_timeline().events.length();0<=eW?eX<eW:eX>eW;e1=0<=eW?++eX:--eX){eV.push(bC.get_timeline().events.valueAtIndex(e1).marquee_highlight(e3,e3+e5,eT))}return eV},_update_marquee_x_bounds:function(T){var eV,eY,eZ,eX,eU,eW,eT;eY=$(document.body).getWidth();if(T<bC.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=bC.get_timeline().grid.photo_col_offsets.first()}else{if(T>bC.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=bC.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=eY}else{eW=bC.get_timeline().grid.photo_col_offsets;eT=[];for(eV=eX=0,eU=eW.length;eX<eU;eV=++eX){eZ=eW[eV];if(eZ>T){this._marquee.x_min_boundary=bC.get_timeline().grid.photo_col_offsets[eV-1];this._marquee.x_max_boundary=eZ;break}else{eT.push(void 0)}}return eT}}},_update_marquee_y_bounds:function(eZ){var T,eW,eV,eY,eU,eX,eT;eV=$(document.body).getHeight();if(eZ<bC.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=bC.get_timeline().grid.photo_row_offsets.first()}else{if(eZ>bC.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=bC.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=eV}else{eX=bC.get_timeline().grid.photo_row_offsets;eT=[];for(eW=eY=0,eU=eX.length;eY<eU;eW=++eY){T=eX[eW];if(T>eZ){this._marquee.y_min_boundary=bC.get_timeline().grid.photo_row_offsets[eW-1];this._marquee.y_max_boundary=T;break}else{eT.push(void 0)}}return eT}}},_build_drag_status:function(eV){var eU,T,eT;T=bC.get_timeline().get_thumb_elm_for_photo(eV);eT=T.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(eT);eU=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(cR.file_desc(eU,false,true))},_update_drag_status_position:function(T){return $("photos-drag-status").setStyle({left:(T.pointerX()-z.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(T.pointerY()-z.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(e4,e3,eU){var e2,T,eV,eZ,e1,e0,eT,eX,eY,eW;if(eU==null){eU=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=e4;this._last_highlight_to_photo=e3;eV=bC.get_timeline().index_of_photo(e4);eT=bC.get_timeline().index_of_photo(e3);e2=!eU&&this.contains(e3)&&!this.contains(e4);eW=[];for(eZ=eX=eV;eV<=eT?eX<=eT:eX>=eT;eZ=eV<=eT?++eX:--eX){e0=bC.get_timeline().photo_at_index(eZ);if(e0.status===H.PLACEHOLDER){if(e0.event!==e1){T=e0.event;if(!T.has_loaded_metadata()){T.on_load_all_metadata=this._highlight_range_incremental.bind(this);T.load_metadata();if(eY=T.unique_id,bx.call(this._events_highlighting,eY)<0){this._events_highlighting.push(T.unique_id)}eW.push(e1=T)}else{eW.push(void 0)}}else{eW.push(void 0)}}else{if(this.contains(e0)){if(e2){eW.push(this._dehighlight(e0))}else{eW.push(void 0)}}else{if(!e2){eW.push(this._highlight(e0))}else{eW.push(void 0)}}}}return eW},_highlight_range_incremental:function(T){var eZ,eU,e0,eW,eX,eT,eY,eV;e0=this._last_highlight_from_photo;eY=this._last_highlight_to_photo;if(!((e0!=null)&&(eY!=null))){return}eU=bC.get_timeline().index_of_photo(e0);eT=bC.get_timeline().index_of_photo(eY);for(eW=eV=eU;eU<=eT?eV<=eT:eV>=eT;eW=eU<=eT?++eV:--eV){eX=bC.get_timeline().photo_at_index(eW);if(eX.status!==H.PLACEHOLDER&&!this.contains(eX)&&this._highlighted.indexOf(eX)===-1){this._highlight(eX)}}eZ=this._events_highlighting.indexOf(T.unique_id);if(eZ>=0){this._events_highlighting.splice(eZ,1)}if(this._select_highlighted_waiting){eg.update(""+(this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(eV){var eU,eW,eT,T;this.clear_highlighted();T=[];for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];if(!this.contains(eU)){T.push(this._highlight(eU))}else{T.push(void 0)}}return T},_select_highlighted:function(){var eV,eY,eW,eU,eT,eX,T;if(this._events_highlighting.length>0){eg.show(ef("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}eX=this._highlighted;for(eY=0,eU=eX.length;eY<eU;eY++){eV=eX[eY];this._add(eV)}T=this._dehighlighted;for(eW=0,eT=T.length;eW<eT;eW++){eV=T[eW];this._remove(eV)}if(this._select_highlighted_waiting){eg.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(eT){var T;this._highlighted.push(eT);T=bC.get_timeline().get_thumb_elm_for_photo(eT);return T!=null?T.addClassName("highlighted"):void 0},_dehighlight:function(eT){var T;this._dehighlighted.push(eT);T=bC.get_timeline().get_thumb_elm_for_photo(eT);return T!=null?T.addClassName("dehighlighted"):void 0},_add:function(eT){var T;cw(eT.status!==H.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);T=bC.get_timeline().get_thumb_elm_for_photo(eT);if(T!=null){T.addClassName("selected")}this._selected.push(eT);this._last_selected=eT;c9.fillVal(cR.file_desc(this._selected,true),"selected-desc");c9.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(ez.CHANGE_EVT)},_remove:function(eU){var eT,T;T=bC.get_timeline().get_thumb_elm_for_photo(eU);if(T!=null){T.removeClassName("selected")}eT=this._selected.indexOf(eU);if(eT!==-1){this._selected.splice(eT,1);this._last_selected=eU;if(this._selected.length){c9.fillVal(cR.file_desc(this._selected,true),"selected-desc");c9.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(ez.CHANGE_EVT)},_invalid_mouse_target:function(eV){var eT,eU,T;eT=eV.classNames().toArray().concat(eV.up().classNames().toArray());return(bx.call(eT,"freshbutton")>=0)||(bx.call(eT,"freshbutton-blue")>=0)||(bx.call(eT,"freshbutton-lightblue")>=0)||(bx.call(eT,"freshbutton-blue-on-gray")>=0)||(bx.call(eT,"timeline-elm")>=0)||(eV.up(".no-marquee")!=null)||(eV.up("#context-menu")!=null)||(eV.up(".freshdropdown-menu")!=null)||eV.nodeName==="A"||((eU=eV.tagName.toUpperCase())==="INPUT"||eU==="TEXTAREA"||eU==="SELECT")||eM.shown()||((T=$("modal-progress-content"))!=null?T.visible():void 0)||aD.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var ct,bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1};ct=INLINE_JS.PhotosCollections=B.PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new eP('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(eT,T){this._collections=eT;this._gid_to_collection=eT.dict_by("gid");this._url_to_collection=eT.dict_by("url");this._collection_list_item_tmpl=eP.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=eP.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var T;T=ei.deconstruct_url();if(T.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(T){if(this._num_loading_collections!==null&&(this._num_loading_collections<T||T===null)){this._num_loading_collections=T;return new Ajax.DBRequest("/collections",{parameters:{limit:T},allow_retries:true,onSuccess:(function(eT){return function(eW){var e0,eZ,eV,eY,eU,eX;eV=JSON.parse(eW.responseText);for(eY=0,eU=eV.length;eY<eU;eY++){eZ=eV[eY];if(!(eZ.gid in eT._gid_to_collection)&&!(eX=eZ.gid,bx.call(eT._removed_pre_load,eX)>=0)){e0=new Z(eZ,false);eT._collections.push(e0);eT._gid_to_collection[e0.gid]=e0;eT._url_to_collection[e0.url]=e0}}if(T===null||eV.length<T){eT._all_collections_loaded=true;eT._sidebar_collections_loaded=true}if(T>=5){eT._sidebar_collections_loaded=true}return eT.refresh_album_views()}})(this)})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){$("single-collection-title").observe("click",(function(T){return function(eT){if(!bC.get_current_collection().is_creator){return}T.header_rename();return h.log_interaction(d2.RENAME_ALBUM,cT.CLICK_TITLE)}})(this));$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(bc.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(Z.CREATE_EVT,this._collection_created.bind(this));document.observe(Z.ADD_EVT,this._collection_photos_added.bind(this));document.observe(Z.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(Z.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(Z.RENAME_EVT,this._collection_renamed.bind(this));document.observe(Z.DELETE_EVT,this._collection_deleted.bind(this));document.observe(Z.SHARE_EVT,this._collection_shared.bind(this));document.observe(Z.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(Z.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var eW,eT,eV,T,eU;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}eT=[];eU=this._collections;for(eV=0,T=eU.length;eV<T;eV++){eW=eU[eV];eT.push(this._collection_list_item_tmpl({collection:eW,additional_class:"albums-list-item show-collection-target",Sprite:cj,Emstring:bG}))}$("albums-list").__date(eT);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var eX,eT,eU,eW,T,eV;eT=[];eU={name:ef("Create new album"),thumbnail_url_256:"/static/images/new_album_big-vflQJ5xd7.png"};eT.push(this._collection_list_item_tmpl({collection:eU,additional_class:"create-album-target",hide_icons:true,Sprite:cj,Emstring:bG}));eV=this._collections;for(eW=0,T=eV.length;eW<T;eW++){eX=eV[eW];eT.push(this._collection_list_item_tmpl({collection:eX,additional_class:"add-to-album-target",Sprite:cj,Emstring:bG}))}$("add-to-album-modal-list").__date(eT);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var eY,e0,eW,eZ,eX,eV,eT,T,eU;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();e0=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5),_:ef,Sprite:cj,PhotosCollections:ct});if((eX=$("albums-sidebar"))!=null){eX.__date(e0)}if((eV=$("all-albums-sidebar"))!=null){eV.observe("click",bC.show_all_collections)}if((eT=$("all-albums-sidebar"))!=null){eT.observe("mouseup",(function(e1){return function(e2){var e3;if(!ez._drag_drop.active){return}if(ez._drag_drop.single_photo!=null){e3=[ez._drag_drop.single_photo]}else{e3=ez.get()}e1.show_add_to_album_modal(e2,e3);return h.log_interaction(d2.ADD_TO_OTHER_ALBUM,cT.DROP_TARGET,{num_photos:ez.get().length})}})(this))}if(bC.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(bC.in_single_collection_view()){T=$$(".sidebar-album");eU=[];for(eW=0,eZ=T.length;eW<eZ;eW++){eY=T[eW];if(eY.readAttribute("data-gid")===bC.get_current_collection().gid){eY.addClassName("selected");break}else{eU.push(void 0)}}return eU}}},refresh_album_views:function(eT){var T;if(eT==null){eT=null}T=(function(eU){return function(){eU.render_all_albums_view();eU.render_albums_sidebar();return eU.render_add_to_album_modal()}})(this);if(eT!=null?eT.length:void 0){return new Ajax.DBRequest("/collections",{allow_retries:true,parameters:{collection_gids:JSON.stringify(eT.unique())},onSuccess:(function(eU){return function(e4){var e3,e2,eW,e1,eZ,eY,e5,eV,e0,eX;e0=JSON.parse(e4.responseText);for(eZ=0,e5=e0.length;eZ<e5;eZ++){eW=e0[eZ];e2=new Z(eW,false);eU._gid_to_collection[e2.gid]=e2;eU._url_to_collection[e2.url]=e2;eX=eU._collections;for(e1=eY=0,eV=eX.length;eY<eV;e1=++eY){e3=eX[e1];if(e3.gid===e2.gid){eU._collections[e1]=e2;break}}}return T()}})(this)})}else{return T()}},show_add_to_album_modal:function(T,eT){if(eT!==ez.get()&&(ez._drag_drop.single_photo==null)){ez._context_selected=eT}eM.onHide=function(){ez._context_selected=null;delete eM.onHide;return eM.hide()};eM.show(ef("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(eU,eW,eT){var T,eV;if(eT==null){eT=true}eV=null;if(bC.in_single_collection_view()){eV=bC.get_current_collection().gid}T=eW.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;ab.success(ef("Adding to album..."));return eU.add_photos(eW,eV,T,eT)},show_remove_photos_modal:function(eV,eX){var eU,T,eW,eT;eT=cR.categorize_files(eX),T=eT[0],eW=eT[1];if(T&&eW){eU=a1("Remove %(file_count)s item?","Remove %(file_count)s items?",eX.length)}else{if(T){eU=a1("Remove %(file_count)s photo?","Remove %(file_count)s photos?",eX.length)}else{eU=a1("Remove %(file_count)s video?","Remove %(file_count)s videos?",eX.length)}}eU=eU.format({file_count:eX.length});c9.fillVal(cR.file_desc(eX),"collection-remove-files");c9.fillVal(eV.name.escapeHTML(),"collection-remove-name");return eM.show(eU,c9.fromElm("collection-remove-modal"),{action:(function(eY){return function(){var eZ;eX=eX.slice(0);eZ=eX.length>eY.NUM_PHOTOS_LONG_RUNNING_REMOVES;return eV.remove_photos(eX,eZ)}})(this)})},header_rename:function(){if(br("#single-collection-title-container").hasClass("editing")){return}br("#single-collection-title-container").addClass("editing");return bC.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(eT){var T;c9.fillVal(eT.name.escapeHTML(),"collection-delete-name");T=ef("Delete album?");return eM.show(T,c9.fromElm("collection-delete-modal"),{action:function(){if(eT.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){ab.success(ef("Deleting '%(collection_name)s'...").format({collection_name:eT.name}),100)}return eT["delete"]()}})},show_unshare_modal:function(eT){var T;c9.fillVal(eT.name.escapeHTML(),"collection-unshare-name");T=ef("Unshare album?");return eM.show(T,c9.fromElm("collection-unshare-modal"),{action:function(){return eT.unshare()}})},create:function(e0,eZ,e4,eT){var eV,eW,eU,eX,e2,e3,e1,T,eY;if(eT==null){eT=false}if(e0){Event.extend(e0).preventDefault();eY=$(e0.target);if(eY.hasClassName("inplaceeditor-form")||(eY.up(".inplaceeditor-form")!=null)){return}if(eY.up("#context-menu")){eV=true}else{if(eY.up(".freshdropdown-menu")){eU=true}}}bC.enable_selection();if(!e4){e4=ez.get()}eX=(function(){var e7,e6,e5;e5=[];for(e7=0,e6=e4.length;e7<e6;e7++){T=e4[e7];e5.push(T.item_counter)}return e5})();e4.sort_by_key(function(e5){return e5.time_taken});e2=e4.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;e1=(function(e5){return function(e7){var fa,e8,e6,e9;e8=JSON.parse(e7.responseText);fa=new Z(e8);ez.clear();ex.hide_all();bc.hide();eM.hide();bC.disable_selection();e9=ef("Created '%(collection_name)s'");e6=fa.name.escapeHTML();e9=e9.format({collection_name:"<a data-gid='"+fa.gid+"' class='show-collection-target'>"+e6+"</a>"});ab.success(new eP(e9));return e5.flash_sidebar_album(fa.gid)}})(this);e3=function(){if(!eU){ex.hide_all()}if(!eV){bc.hide()}ct.render_albums_sidebar();return bC.disable_selection()};eW=new Ajax.InPlaceEditor(eZ,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:eT,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:e3,onFailure:function(){},savingText:ef("Creating..."),onLeaveEditMode:bC.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:e1,job:e2,job_user:cy.get_viewer().photos_user,progress_text:ef("Creating album...")},callback:function(e5,e7){var e6;ab.success(ef("Creating album..."));e6={collection_name:e7,item_counters:JSON.stringify(eX)};if(bC.in_single_collection_view()){e6.source_collection_gid=bC.get_current_collection().gid}return e6}});eW.enterEditMode();if(!eT){return eW._controls.editor.observe("blur",e3)}},toggle_more_selected_actions:function(T){if(T){Event.extend(T).preventDefault()}if(!$("more-selected-actions-menu").visible()){return ex.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(T){var eT;if(T){Event.extend(T).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(bC.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(bO.msie_version_at_most(10)){eT=br("#more-collection-actions-menu");if(!eT.parent().is("body")){br(document.body).append(eT.remove())}}return ex.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(T){var eT;eT=T.memo.collection;if(!eT.is_anonymous){this._collections.unshift(eT)}this._gid_to_collection[eT.gid]=eT;this._url_to_collection[eT.url]=eT;return this.refresh_album_views()},_collection_changed:function(T){this._collections.removeItem(T);this._collections.unshift(T);return this.refresh_album_views()},_collection_photos_added:function(eZ){var eY,eW,eV,e0,e1,eU,T,eT,e2,eX;eY=eZ.memo.collection;e2=eZ.memo.photos;e0=eZ.memo.num_items_added;eU=eZ.memo.num_photos_added;eT=eZ.memo.num_videos_added;if(eZ.memo.promote_collection&&e0>0){this._collection_changed(eY)}else{this.refresh_album_views()}if(e2===ez.get()){ez.clear()}if(e0<1){eX=cR.categorize_files(e2),e1=eX[0],T=eX[1];if(e1&&T){eV=a1("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",e2.length)}else{if(e1){eV=a1("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",e2.length)}else{eV=a1("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",e2.length)}}}else{if(eU&&eT){eV=a1("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",e2.length)}else{if(eU){eV=a1("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",e2.length)}else{eV=a1("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",e2.length)}}}eW=eY.name.escapeHTML();eV=eV.format({collection_name:"<a data-gid='"+eY.gid+"' class='show-collection-target'>"+eW+"</a>"});return ab.success(new eP(eV))},_collection_photos_removed:function(eT){var eU,eV,T;eU=eT.memo.collection;eV=eT.memo.photos;T=bC.undo_enabled?eT.memo.undo_changeset:null;bC.get_timeline().remove_photos(eV);this._collection_changed(eU);return ab.success(ef("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:cR.file_desc(eV),collection_name:eU.name}),null,null,T,(function(){return eU.undo_remove(T)}))},_collection_undid_remove:function(T){var eT;eT=T.memo.collection;bC.get_timeline().restore_removed_photos();ct.refresh_album_views([eT.gid]);return ab.success(ef("Undo complete"))},_collection_renamed:function(eT){var eU,T;eU=eT.memo.collection;if(((T=bC.get_current_collection())!=null?T.gid:void 0)===eU.gid){br("#single-collection-title").text(bG.em_snippet(eU.name,this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=""+eU.name+" - Dropbox"}this._collection_changed(eU);return ab.success(ef("Renamed '%(collection_name)s'").format({collection_name:eU.name}))},_collection_deleted:function(eT){var eU,T;eU=eT.memo.collection;this._collections.removeItem(eU);if(!this._all_collections_loaded){this._removed_pre_load.push(eU.gid)}this.refresh_album_views();if(((T=bC.get_current_collection())!=null?T.gid:void 0)===eU.gid){bC.show_all_collections()}delete this._gid_to_collection[eU.gid];delete this._url_to_collection[eU.url];return ab.success(ef("Deleted '%(collection_name)s'").format({collection_name:eU.name}))},_collection_shared:function(eT){var eU,T;eU=eT.memo.collection;this._collection_changed(eU);if(((T=bC.get_current_collection())!=null?T.gid:void 0)===eU.gid){br("#single-collection-share-status").text(ef("Shared"));return br("#single-collection-share-status").attr("href",eU.shmodel_url)}},_collection_unshared:function(eT){var eU,T;eU=eT.memo.collection;if(((T=bC.get_current_collection())!=null?T.gid:void 0)===eU.gid){br("#single-collection-share-status").text("")}return ab.success(ef("Unshared '%(collection_name)s'").format({collection_name:eU.name}))},_collection_cover_changed:function(T){var eU,eT;eU=T.memo.collection;this._collection_changed(eU);eT=ef("Changed cover photo for '%(collection_name)s'");eT=eT.format({collection_name:eU.name.escapeHTML()});return ab.success(eT)},_albums_list_item_contextmenu:function(eT,T){bc.show_photo_collection(eT,this.get(T.readAttribute("data-gid")),T);T.removeClassName("album-flash");return T.addClassName("context-selected")},_show_collection_click:function(eU,T){var eT;eT=$(eU.target);if(eT.hasClassName("inplaceeditor-form")||(eT.up(".inplaceeditor-form")!=null)){return}return bC.show_collection(T.readAttribute("data-gid"))},_collection_shmodel_click:function(eT,T){return this.go_to_link(this.get(T.readAttribute("data-gid")))},_add_to_album_click:function(eT,T){if(ez._context_selected){this.add_photos(this.get(T.readAttribute("data-gid")),ez._context_selected);ez._context_selected=null}else{this.add_photos(this.get(T.readAttribute("data-gid")),ez.get())}delete eM.onHide;eM.hide();return h.log_interaction(d2.ADD_TO_RECENT_ALBUM,cT.SAH,{num_photos:ez.get().length})},_drop_target_mouseover:function(eT,T){if(ez._drag_drop.active){T.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(eT,T){if(ez._drag_drop.active){T.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(eT,T){var eU;if(T.hasClassName("hovered")){T.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(ez._drag_drop.single_photo!=null){eU=[ez._drag_drop.single_photo]}else{eU=ez.get()}if(T.readAttribute("data-gid")!=null){this.add_photos(this.get(T.readAttribute("data-gid")),eU,false)}if(T.identify()==="add-to-album-sidebar-new"){return h.log_interaction(d2.ADD_TO_NEW_ALBUM,cT.DROP_TARGET,{num_photos:ez.get().length})}else{if(T.identify()==="all-albums-sidebar"){return h.log_interaction(d2.ADD_TO_OTHER_ALBUM,cT.DROP_TARGET,{num_photos:ez.get().length})}else{return h.log_interaction(d2.ADD_TO_RECENT_ALBUM,cT.DROP_TARGET,{num_photos:ez.get().length})}}}},_create_album_click:function(T,eT){if(ez._context_selected){this.create(T,eT.down(".collection-name"),ez._context_selected,true);return ez._context_selected=null}else{return this.create(T,eT.down(".collection-name"),ez.get(),true)}},_window_scroll:function(){if(bC.in_all_collections_view()){return this._all_albums_scroll_position=z.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(T){return this._url_to_collection[T]},get:function(T){return this._gid_to_collection[T]},go_to_link:function(T){return window.open(T.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(eU,eT){var T,eW,eV;T=bG.em_snippet(eU,eT,1);eW=T.lastIndexOf(" ");if(eW===-1){return T}else{T=T.slice(0,+eW+1||9000000000);eV=bG.em_snippet(eU.slice(eW+1),eT,1);return T+eV}},get_default_album_name:function(){var T;T=ef("Untitled album");return this.increment_collection_name_until_valid(T)},collection_name_in_use:function(eT){var eW,eV,T,eU;eU=this.get_all();for(eV=0,T=eU.length;eV<T;eV++){eW=eU[eV];if(eW.name===eT.trim()){return true}}return false},increment_collection_name_until_valid:function(eT){var eU,T;eU=this.collection_name_in_use(eT);T=0;while(eU){T++;eU=this.collection_name_in_use(eT+(" ("+T+")"))}return(T===0?eT:eT+(" ("+T+")"))},flash_sidebar_album:function(eW){var eX,eV,eT,eU,T;eU=$$(".sidebar-album");T=[];for(eV=0,eT=eU.length;eV<eT;eV++){eX=eU[eV];if(eX.readAttribute("data-gid")===eW){eX.removeClassName("album-flash");eX.addClassName("album-flash");break}else{T.push(void 0)}}return T}};var b6;b6=B.PhotoTimeline=(function(){T.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";T.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";T.prototype.THUMB_SIZE=null;T.prototype.HEADER_HEIGHT=null;T.prototype.THUMBS_PER_ROW=4;T.prototype.RENDER_SCROLL_WAIT=100;T.prototype.RENDER_SCROLL_MAX_WAIT=750;T.prototype.HIDE_TIMELINE_NAV_DELAY=1500;T.prototype.THUMBS_BATCH_SIZE=12;T.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;T.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;T.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;T.prototype.TIMELINE_NAV_ELM_HEIGHT=20;T.prototype.TIMELINE_DOT_HTML=cj.html("web","timeline_dot");T.container;T.scroll_container;T.events;T.current_event;T.key_to_photo;T.preview_objs;T.tmpl;T.last_render_scroll_timeout;T.start_render_scroll_time;T.last_scroll_position;T.hide_timeline_nav_timeout;T.grid;T._skip_scroll_update;T.header_id_to_sel_items;T.event_remove_info;T.opts;function T(eU,eV,eY,eW,eX,eZ,e0,e1,eT){this.container=eU;this.scroll_container=eV;this.tmpl=e0;this.opts=eT;this.THUMB_SIZE=e1.thumb_size;this.HEADER_HEIGHT=e1.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=eZ;this.event_remove_info=[];this._init_events(eY,eW,eX);this.update_offsets(e1.top_offset,e1.left_offset);this.listen();df.start_capture(this.scroll_container)}T.prototype._init_events=function(e1,eV,eX){var eU,eZ,e4,eW,eY,e2,eT,e0,e3;if(e1.length<1){this.events=new aR([],{});return}eZ=[];eY={};e4=false;for(e0=0,e3=e1.length;e0<e3;e0++){eW=e1[e0];eW=String(eW);eT=eW in this.header_id_to_sel_items?this.header_id_to_sel_items[eW]:[];e2=false;if(eT.length&&!e4){e4=true;e2=true}eU=new cU(this,eW,eV[eW],eX[eW],eT,e2);eZ.push(eW);eY[eW]=eU}return this.events=new aR(eZ,eY)};T.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(cU.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};T.prototype.unlisten=function(){var eU,eT,eV;if((eU=this._body_mousemove_handler)!=null){eU.stop()}if((eT=this._timeline_elm_click_handler)!=null){eT.stop()}if((eV=this._show_missing_timestamp_bucket_handler)!=null){eV.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(cU.EVENT_MISCOUNT_EVT)};T.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};T.prototype.update_offsets=function(eV,eU){var eW,eY,eX,eT;cw(this.THUMBS_PER_ROW>0,"Invalid THUMBS_PER_ROW: "+this.THUMBS_PER_ROW);this.top_offset=eV;this.refresh_row_offsets();this.left_offset=eU;this.grid.photo_col_offsets=[];eT=[];for(eW=eY=0,eX=this.THUMBS_PER_ROW;0<=eX?eY<=eX:eY>=eX;eW=0<=eX?++eY:--eY){eT.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*eW))}return eT};T.prototype.refresh_row_offsets=function(){var e0,eX,eV,eZ,eW,eU,eY,eT;this.grid.photo_row_offsets=[];e0=this.top_offset;eY=this.events.getValues();for(eZ=0,eU=eY.length;eZ<eU;eZ++){eX=eY[eZ];eX.top_offset=e0;e0+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(e0);for(eV=eW=0,eT=eX.get_num_rows();0<=eT?eW<eT:eW>eT;eV=0<=eT?++eW:--eW){e0+=this.THUMB_SIZE;this.grid.photo_row_offsets.push(e0)}}};T.prototype._render_empty_grid=function(){var eU,eX,eW,eT,eV;this.container.__date();eV=this.events.getValues();for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];if(!(eU.is_missing_timestamp_bucket()&&this.events.length()>1)){eU.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){eX=br('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(ef("Show photos with missing dates"));return br(this.container).append(eX)}};T.prototype._render_viewport=function(eW){var eU,e5,eX,e4,e7,e2,e1,eZ,e6,eV,eT,e3,e0,eY;if(eW==null){eW=false}this.start_render_scroll_time=-1;e7=this.get_viewport_info();e5=[];e3=this.events.getValues();for(e2=0,e6=e3.length;e2<e6;e2++){eU=e3[e2];if(!(eU.has_loaded_metadata()||eU.loading_metadata||(eU.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(eU.in_current_viewport(e7,false)){e5.unshift(eU)}else{if(eU.in_current_viewport(e7,true)){e5.push(eU)}}}}for(e1=0,eV=e5.length;e1<eV;e1++){eU=e5[e1];e0=eU.get_photo_range_to_render(e7,true),eX=e0[0],e4=e0[1];eU.load_metadata_range(eX,e4)}if(eW){e7=this.get_viewport_info();eY=this.events.getValues();for(eZ=0,eT=eY.length;eZ<eT;eZ++){eU=eY[eZ];if(eU.in_current_viewport(e7,false)){eU.timing_stopped_scrolling_on_event=bR.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};T.prototype._load_metadata_for_sel_events=function(){var eV,eX,eT,eW,eU;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}eW=this.header_id_to_sel_items;eU=[];for(eX in eW){eT=eW[eX];eV=this.events.valueFromKey(eX);if(eV!=null){eV.load_metadata()}eU.push(cw(eV!=null,"Missing "+eX+" in list of events with selected photos"))}return eU};T.prototype._load_visible_photos=function(){var eV,eX,eU,eW,eT;eW=this.events.getValues();eT=[];for(eX=0,eU=eW.length;eX<eU;eX++){eV=eW[eX];if(!(eV.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){eT.push(eV.update_photo_divs())}else{eT.push(void 0)}}return eT};T.prototype._body_mousemove=function(eT){if(!this.opts.uses_timeline_nav){return}if((eT.clientX+z.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};T.prototype._timeline_elm_click=function(eW,eV){var eT,eU;eU=eV.readAttribute("data-event-id");if(eU){eT=this.events.valueFromKey(eU)}this._update_timeline_position(eT);if(eT.is_missing_timestamp_bucket()){h.log_interaction(b9.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(eT)};T.prototype._scroll_to_event=function(eV,eT){var eU;if(eT==null){eT=false}eU=eV.top_offset-this.top_offset;if(eV&&(z.scroll_offsets().top!==eU)){if(eT){return br("html, body").animate({scrollTop:eU},200)}else{this._skip_scroll_update=true;return window.scrollTo(z.scroll_offsets().left,eU)}}};T.prototype._window_scroll=function(){var eW,eV,eZ,eY,eU,eX,eT;eV=bR.time();bh.clear_all_pending_batches();if(this.start_render_scroll_time===-1||eV-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=eV}eZ=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),eZ);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout(((function(e0){return function(){return $("timeline-nav").removeClassName("scroll-active")}})(this)),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=z.scroll_offsets().top;bC.scroll_count++;eX=this.events.getValues();eT=[];for(eY=0,eU=eX.length;eY<eU;eY++){eW=eX[eY];eT.push(eW.logged_thumbs_arrived=false)}return eT};T.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};T.prototype.init_timeline_nav=function(){var eU,eW,eT,eV;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();eV=this.events.getValues().reverse();for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];eU.add_to_timeline_nav(eU===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};T.prototype._resize_timeline_nav=function(){var eT;if(!this.opts.uses_timeline_nav){return}eT=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:eT+"px"})};T.prototype._update_timeline_position=function(eZ){var e3,e0,eT,e2,eX,eW,e1,eU,eY,eV;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(eZ==null){e2=this.get_viewport_info();if(this.scroll_container==null){e2.top=document.viewport.getScrollOffsets().top}e3=e2.top+e2.height/2;eY=this.events.getValues();for(eX=0,e1=eY.length;eX<e1;eX++){eT=eY[eX];if(eT.top_offset>e3){break}eZ=eT}}if((eZ==null)||eZ===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");eV=$$(".timeline-elm");for(eW=0,eU=eV.length;eW<eU;eW++){e0=eV[eW];if(e0.readAttribute("data-event-id")===eZ.unique_id){e0.addClassName("current");break}}return this.current_event=eZ};T.prototype._show_hide_timeline_elms=function(){var e0,eX,eV,eW,eZ,eU,eY,eT;if(!this.opts.uses_timeline_nav){return}eV=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();eX=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();eY=$$(".timeline-elm");eT=[];for(eZ=0,eU=eY.length;eZ<eU;eZ++){e0=eY[eZ];e0.show();eW=e0.cumulativeOffset();if(eW.top<eX&&eW.left<eV){eT.push(e0.hide())}else{eT.push(void 0)}}return eT};T.prototype._event_miscount=function(eT){this.refresh_row_offsets();return this._load_visible_photos()};T.prototype.remove_photos=function(e0){var eW,eY,eZ,eV,eU,eX,eT;e0=e0.slice(0);this.event_remove_info=[];eZ={};for(eX=0,eT=e0.length;eX<eT;eX++){eV=e0[eX];eY=eV.event.unique_id;if(eY in eZ){eZ[eY].push(eV)}else{eZ[eY]=[eV]}}for(eY in eZ){e0=eZ[eY];eW=this.events.valueFromKey(eY);eU=eW.remove_photos(e0);this.event_remove_info.push({event:eW,remove_info:eU})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(T.PHOTOS_REMOVED_EVT,this)};T.prototype.restore_removed_photos=function(){var eU,e8,e4,e7,e5,eW,e3,e1,e0,eY,e6,eV,eT,e2,eZ,eX;ez.clear();e2=this.event_remove_info.reverse();for(e1=0,e6=e2.length;e1<e6;e1++){e8=e2[e1];eU=e8.event;e5=e8.remove_info;if(e5.removed_event_index!=null){this.events.insertAtIndex(e5.removed_event_index,eU.unique_id,eU);eU.restore()}eU.add_photos(e5.removed_photos_and_indexes.reverse());eZ=e5.removed_photos_and_indexes;for(e0=0,eV=eZ.length;e0<eV;e0++){e7=eZ[e0];ez._add(e7.photo)}}eW=null;e3=null;eX=this.event_remove_info;for(eY=0,eT=eX.length;eY<eT;eY++){e8=eX[eY];eU=e8.event;e5=e8.remove_info;e4=this.events.indexOfKey(eU.unique_id);if((eW==null)||eW>e4){eW=e4;e3=e5.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(e3!=null){this.scroll_to_photo_with_key(e3.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(T.PHOTOS_ADDED_EVT,this)};T.prototype.get_photos=function(){var eU,eX,eW,eT,eV;eX=[];eV=this.events.getValues();for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];eX=eX.concat(eU.photos)}return eX};T.prototype.num_photos=function(){var eV,eU,eX,eT,eW;eU=0;eW=this.events.getValues();for(eX=0,eT=eW.length;eX<eT;eX++){eV=eW[eX];eU+=eV.photos.length}return eU};T.prototype.get_preview_objs=function(){var eT,eU,e0,eY,eX,e1,eV,eZ,eW;e0=[];eZ=this.events.getValues();for(eY=0,e1=eZ.length;eY<e1;eY++){eT=eZ[eY];eW=eT.photos;for(eX=0,eV=eW.length;eX<eV;eX++){eU=eW[eX];e0.push(eU.preview_obj)}}return e0};T.prototype.index_of_photo=function(eV){var eW,eU,eY,eT,eX;eU=0;eX=this.events.getValues();for(eY=0,eT=eX.length;eY<eT;eY++){eW=eX[eY];if(eW===eV.event){eU+=eW.photos.indexOf(eV);break}else{eU+=eW.photos.length}}return eU};T.prototype.photo_at_index=function(eV){var eT,eW,eY,eU,eX;eT=0;eX=this.events.getValues();for(eY=0,eU=eX.length;eY<eU;eY++){eW=eX[eY];if(eT+eW.photos.length>eV){return eW.photos[eV-eT]}else{eT+=eW.photos.length}}return null};T.prototype.get_thumb_elm_for_photo=function(eT){return $(eT.uniqueness_key)};T.prototype.get_photo_for_thumb_elm=function(eT){if(!eT.hasClassName("cu-thumb")){eT=eT.up(".cu-thumb")}if(eT){return this.key_to_photo[eT.identify()]}else{return null}};T.prototype.get_viewport_info=function(){var eT,eU;if(this.scroll_container!=null){eU=this.scroll_container.scrollTop;eT=this.scroll_container.getHeight()}else{eU=z.scroll_offsets().top;eT=z.viewport_dimensions().height}return{top:eU,height:eT,bottom:eU+eT}};T.prototype.scroll_to_photo_with_key=function(eU){var eY,eV,eT,eX,eW;z.scroll_unlock_document();eY=$(eU);if(eY!=null?eY.visible():void 0){dL.scroll_to_thumb(eY)}else{eT=this.key_to_photo[eU];eV=eT.event;if(eT.event!=null){eX=Math.floor(eV.photos.indexOf(eT)/this.THUMBS_PER_ROW);eW=this.get_viewport_info().height;z.scroll_to(0,eV.top_offset+this.HEADER_HEIGHT+eX*this.THUMB_SIZE-eW/2)}}return this._load_visible_photos()};T.prototype.restore_scroll_position=function(){z.scroll_unlock_document();if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};T.prototype.visible_thumbs_loaded=function(){var eU,eW,eT,eV;eV=this.events.getValues();for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];if(!eU.visible_thumbs_loaded()){return false}}return true};T.prototype.has_missing_timestamp_bucket=function(){var eT;eT=this.events.getValues();return eT[eT.length-1].is_missing_timestamp_bucket()};T.prototype.is_missing_timestamp_bucket_shown=function(){var eT,eU;if(!this.has_missing_timestamp_bucket()){return false}eT=this.events.getValues();eU=eT[eT.length-1].unique_id;return br("#p-"+eU).length>0};T.prototype._show_missing_timestamp_bucket=function(eT,eW){var eV,eU;if(eT==null){eT=true}if(eW==null){eW=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}eU=this.events.getValues();eV=eU[eU.length-1];br("#show-missing-timestamps-button").hide();eV.add_html_elements_to(this.container);if(!eW){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(eV,eT);this._render_viewport()}return this.init_timeline_nav()};return T})();var cU;cU=B.PhotoEvent=(function(){T.EVENT_MISCOUNT_EVT="db:photoevent:miscount";T.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";T.prototype.MONTH_PREFIX="m_";T.prototype.COLLECTION_PREFIX="c_";T.prototype.EVENT_PREFIX="e_";T.prototype.MISSING_TIMESTAMP_PREFIX="a_";T.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;T.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;T.timeline;T.unique_id;T.name;T.init_num_photos;T.photos;T.header_html;T.placeholder_html;T.top_offset;T.loading_metadata;T.cursor;T.num_photos_loaded;T.prototype.LOADING_ORDER_NOT_DECIDED=-1;T.prototype.LOADING_ORDER_TOP_DOWN=0;T.prototype.LOADING_ORDER_BOTTOM_UP=1;T.loading_order;T.num_photos_to_load;T.on_load_all_metadata;T.init_sel_items;T.scroll_to_first_sel;T.num_to_select;T.logged_thumbs_arrived;T.timing_metadata_received;T.timing_stopped_scrolling_on_event;T.scroll_count;function T(e1,eY,eU,eZ,eT,eX){var eW,e2,eV,e0;this.timeline=e1;this.unique_id=eY;this.name=eU;this.init_num_photos=eZ;this.photos=(function(){var e4,e3;e3=[];for(eW=e4=0;0<=eZ?e4<eZ:e4>eZ;eW=0<=eZ?++e4:--e4){e3.push(new H(this))}return e3}).call(this);this.init_sel_items={};for(eV=0,e0=eT.length;eV<e0;eV++){e2=eT[eV];this.init_sel_items[e2]=true}this.num_to_select=eT.length;this.scroll_to_first_sel=eX;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(eZ===0){$("single-album-empty").show()}}T.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};T.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};T.prototype.get_month=function(){var eT;cw(this.is_month(),"this must be a month event");eT=parseInt(this.unique_id.slice(6,8),10);cw(!isNaN(eT),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return eT};T.prototype.get_year=function(){var eT;cw(this.is_month(),"this must be a month event");eT=parseInt(this.unique_id.slice(2,6),10);cw(!isNaN(eT),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return eT};T.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};T.prototype.get_collection_gid=function(){cw(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};T.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};T.prototype._generate_container_html=function(){var eW,eU,eX,eZ,eV,eT,eY;eZ=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(eZ);eW=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});eW.__date(cj.html("web","event_add_to_album"));this.header_html.__sert(eW);eY=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});eY.__date(cj.html("web","event_share"));this.header_html.__sert(eY);eT=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});eT.__date(cj.html("web","event_select"));this.header_html.__sert(eT)}else{this.header_html=new eP("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+eZ+"</span></h1>")}eU=this.get_content_height();eV=this.photos.length%this.timeline.THUMBS_PER_ROW;eX=eV===0?0:(this.timeline.THUMBS_PER_ROW-eV)*this.timeline.THUMB_SIZE;return this.placeholder_html=new eP('<div style="height: '+eU+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+eU+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+eX+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};T.prototype.add_html_elements_to=function(eU){var eT;if(this.is_event()){eT=new Element("div",{"class":"photo-event"});eT.__sert(this.header_html);eT.__sert(this.placeholder_html);return eU.__sert(eT)}else{eU.__sert(this.header_html);return eU.__sert(this.placeholder_html)}};T.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};T.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};T.prototype.add_to_timeline_nav=function(e0){var eT,eY,e1,eU,e2,eX,eW,eZ,eV;if(e0==null){e0=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}eV=this.timeline.get_viewport_info().height;e2=this.timeline.TIMELINE_NAV_ELM_HEIGHT;eX=$(document.body).getHeight();eW=this.top_offset/eX*100;if(this.is_event()){eU=this.name}else{if(this.is_missing_timestamp_bucket()){eU=ef("Missing dates")}else{eU=bR.month_abbr_with_year(this.get_month()-1,this.get_year())}}e1=false;for(eZ in this.timeline.grid.side_nav){eT=Math.abs(this.timeline.events.valueFromKey(eZ).top_offset-this.top_offset);if(eT/eX*eV<e2){e1=true;if(e0){br("#timeline-nav-"+eZ).remove()}}}eY=br("#timeline-nav-"+this.unique_id);if(!e1||e0){if(eY.length){eY.css("top",""+eW+"%")}else{eY=br("<div/>");eY.addClass("timeline-elm");eY.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});eY.css("top",""+eW+"%");eY.text(eU);br("#timeline-nav").append(eY)}return this.timeline.grid.side_nav[this.unique_id]=eW}else{if(eY.length){return eY.remove()}}};T.prototype.marquee_highlight=function(eT,e0,eX){var eV,e1,eU,e2,e4,eW,eZ,eY,e3;if(this.top_offset>e0||this.top_offset+this.get_height()<eT){return}if(eT<this.top_offset){e0-=this.top_offset;if(e0<this.timeline.HEADER_HEIGHT){return}eW=0;e4=Math.floor((e0-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(e0>this.top_offset+this.get_height()){eT-=this.top_offset;e4=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(eT<this.timeline.HEADER_HEIGHT){eW=0}else{eW=Math.floor((eT-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{eT-=this.top_offset;e0-=this.top_offset;if(eT<this.timeline.HEADER_HEIGHT&&e0<this.timeline.HEADER_HEIGHT){return}else{if(eT<this.timeline.HEADER_HEIGHT){eW=0;e4=Math.floor((e0-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{eW=Math.floor((eT-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);e4=Math.floor((e0-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(e2=eZ=eW;eW<=e4?eZ<=e4:eZ>=e4;e2=eW<=e4?++eZ:--eZ){for(eY=0,e3=eX.length;eY<e3;eY++){eV=eX[eY];e1=this.timeline.THUMBS_PER_ROW*e2+eV;if(e1<this.photos.length){eU=this.photos[e1];if(eU.status!==H.PLACEHOLDER&&!ez.contains(eU)){ez._highlight(eU)}}}}};T.prototype.add_photos=function(eW){var eV,eU,eX,eY,eT;for(eY=0,eT=eW.length;eY<eT;eY++){eX=eW[eY];eU=eX.photo;eV=eX.index;cw(eV<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(eV,0,eU);if(eU.status>=H.LOADED){eU.status=H.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};T.prototype.remove_photos=function(e1){var eY,eT,eX,eZ,eU,eV,e0,eW;eY=this.timeline.events.indexOfKey(this.unique_id);eU=[];for(eV=0,e0=e1.length;eV<e0;eV++){eT=e1[eV];eX=this.photos.indexOf(eT);cw(eX>-1,"Photo not found in the photos array!");this.photos.splice(eX,1);if(eT.status>=H.LOADED){this.num_photos_loaded--;if((eW=$(eT.uniqueness_key))!=null){eW.remove()}eT.status=H.LOADED}ez._remove(eT);eU.push({photo:eT,index:eX})}this._num_photos_changed();eZ={removed_photos_and_indexes:eU};if(this.photos.length===0){eZ.removed_event_index=eY}return eZ};T.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};T.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};T.prototype._update_placeholder_container=function(){var eU,eT;$("p-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});eT=this.photos.length%this.timeline.THUMBS_PER_ROW;eU=eT!==0?(this.timeline.THUMBS_PER_ROW-eT)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:""+eU+"px"})};T.prototype.load_metadata=function(e0){var eV,eU,eZ,eT,eX,eY,eW;eT=0;if((!this._is_valid_photo_index(e0))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}eT=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=e0*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}eT=this._is_loading_from_bottom()?this.photos.length-e0:e0+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,eT);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;eX={show_hidden:bC.show_hidden};if(this.cursor!=null){eX.cursor=this.cursor}if(this._is_loading_from_bottom()){eX.chron_order=true}eX.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(eX.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){eX.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){eY=this.unique_id.split("_");eV=eY[2];eU=eY[1];eX.filters=JSON.stringify({date_begin:eV,date_end:eU},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){eX.filters=JSON.stringify({other:true})}else{if(this.is_month()){eW=this.get_year();eZ=this.get_month();eV=dL.to_iso8601_date(new Date(eW,eZ-1,1,0,0,0,0),false,true);eU=dL.to_iso8601_date(new Date(eW,eZ,1,0,0,0),false,true);eX.filters=JSON.stringify({date_begin:eV,date_end:eU},{year:eW,month:eZ})}else{if(this.is_collection()){eX.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{cw(false,"invalid photo event id: "+this.unique_id)}}}}return new Ajax.DBRequest("/photos_event_metadata",{parameters:eX,allow_retries:true,onSuccess:(function(e1){return function(e2){var e3;e3=JSON.parse(e2.responseText);e1.timing_metadata_received=bR.time();e1.cursor=e3.cursor;return e1._load_metadata_callback(e3.photos,e3.key_to_duplicates,(e3.more!=null)&&e3.more)}})(this)})};T.prototype.load_metadata_range=function(eU,eT){if(!(this._is_valid_photo_index(eU)&&this._is_valid_photo_index(eT))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=eU*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(eU)}else{return this.load_metadata(eT)}};T.prototype.load_cached_metadata=function(){var eT,eU;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||(((eU=bC.event_metadata_cache)!=null?eU[this.unique_id]:void 0)==null)){return false}eT=bC.event_metadata_cache[this.unique_id];this.cursor=eT.cursor;this._load_metadata_callback(eT.photos,eT.key_to_duplicates,eT.more);return true};T.prototype._load_metadata_callback=function(e5,eY,eZ){var e4,e0,fa,e1,fb,eV,e2,e8,eX,e6,eW,e3,eU,eT,e7,e9;e1=[];eX=[];e3=false;for(e4=eU=0,e7=e5.length;eU<e7;e4=++eU){e2=e5[e4];if(this.has_loaded_metadata()){eV=new H(this);if(this._is_loading_from_bottom()){this.photos.unshift(eV)}else{this.photos.push(eV)}e3=true}else{if(this.num_photos_loaded<this.photos.length){e0=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;eV=this.photos[e0]}else{cw(false,"num_photos_loaded should never be greater than photos.length")}}eV.init_metadata(e2);if(eV.uniqueness_key in eY){eV.set_duplicates(eY[eV.uniqueness_key])}if(e4<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){eX.push(eV.preview_obj)}e1.push(eV)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var ff,fe,fd,fc;fc=[];for(fe=0,fd=eX.length;fe<fd;fe++){ff=eX[fe];fc.push(ff.preload())}return fc}),500)}ez.refresh(e1);for(eT=0,e9=e1.length;eT<e9;eT++){eV=e1[eT];if(eV.item_counter in this.init_sel_items){ez._add(eV);this.num_to_select--;if(this.num_to_select===0){ez.dec_num_loading_events_before_select()}delete this.init_sel_items[eV.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;eW=this.timeline;fa=eV.uniqueness_key;br(document).ready(function(){return eW.scroll_to_photo_with_key(fa)})}}}if(!eZ){if(this.num_photos_loaded<this.photos.length){fb=this.photos.length-this.num_photos_loaded;e6=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(e6,fb);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(e3||fb){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(T.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){e8=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(e8)}};T.prototype._fix_photo_miscount=function(){var eV,eU,eT;eV=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);eU=this.get_num_rows()-eV;if(typeof h!=="undefined"&&h!==null){h.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}eT=z.scroll_offsets().top;if(this.top_offset+this.get_height()<eT){z.scroll_to(0,eT+eU*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(T.EVENT_MISCOUNT_EVT,this)};T.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};T.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};T.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};T.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};T.prototype.visible_thumbs_loaded=function(eV){var eZ,eY,eU,eT,eX,eW;if(eV==null){eV=this.timeline.get_viewport_info()}eW=this.get_photo_range_to_render(eV,false),eZ=eW[0],eY=eW[1];if(eZ===null&&eY===null){return true}for(eT=eX=eZ;eZ<=eY?eX<=eY:eX>=eY;eT=eZ<=eY?++eX:--eX){eU=this.photos[eT];if((eU==null)||!(eU.status>=H.RENDERED)){return false}}return true};T.prototype._is_loaded=function(eT){var eU,eV;if(this._is_loading_from_bottom()){eV=this.photos.length-this.num_photos_loaded;eU=this.photos.length-1}else{eV=0;eU=this.num_photos_loaded-1}return(eV<=eT&&eT<=eU)};T.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};T.prototype._is_valid_photo_index=function(eT){return(eT!=null)&&(eT>=0)&&(eT<=this.photos.length-1)};T.prototype.update_photo_divs=function(){var eV,eU,fa,e9,fe,fh,fb,e6,e0,fi,e8,ff,e4,e1,eY,eW,fj,fk,eT,fg,e7,e5,e3,eZ,eX,e2,fd,fc;if(!this.num_photos_loaded){return}ff=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(ff)){return}fg=this.get_photo_range_to_render(ff),fa=fg[0],e9=fg[1];cw((fa!=null)&&(e9!=null),"This line is after @hide_photos_if_not_in_ current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(fa))||(!this._is_loaded(e9)))){this.load_metadata_range(fa,e9);if(this._is_loading_from_bottom()){fa=Math.max(fa,this.photos.length-this.num_photos_loaded)}else{e9=Math.min(e9,this.num_photos_loaded-1)}if(fa>e9){return}}fh=Math.floor(fa/this.timeline.THUMBS_PER_ROW);e8=fh*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:e8+"px"});fe=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(e9/this.timeline.THUMBS_PER_ROW);eU=fe*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:eU+"px"});this._hide_photos((function(){e2=[];for(var fl=0;0<=fa?fl<fa:fl>fa;0<=fa?fl++:fl--){e2.push(fl)}return e2}).apply(this));this._hide_photos((function(){fd=[];for(var fl=e7=e9+1,fm=this.photos.length;e7<=fm?fl<fm:fl>fm;e7<=fm?fl++:fl--){fd.push(fl)}return fd}).apply(this));this._show_photos((function(){fc=[];for(var fl=fa;fa<=e9?fl<=e9:fl>=e9;fa<=e9?fl++:fl--){fc.push(fl)}return fc}).apply(this));e3=ez.get();for(eW=0,fj=e3.length;eW<fj;eW++){e6=e3[eW];if((eZ=$(e6.uniqueness_key))!=null){eZ.addClassName("selected")}}this.scroll_count=bC.scroll_count;eV=[];eX=this.get_thumb_indexes_to_load(ff);for(eT=0,fk=eX.length;eT<fk;eT++){e0=eX[eT];e6=this.photos[e0];if((e6!=null)&&e6.status>=H.RENDERED){fi=$(e6.uniqueness_key);if((fi!=null?fi.down("img"):void 0)!=null){eV.push(fi.down("img"))}}}fb=function(fl){return fl.up(".cu-thumb").addClassName("thumb-loaded")};return bh.batch_load_thumbs(eV,this.timeline.THUMBS_BATCH_SIZE,fb,this.log_thumb_load.bind(this))};T.prototype._hide_photos=function(eX){var eV,eW,eU,eT;eT=[];for(eW=0,eU=eX.length;eW<eU;eW++){eV=eX[eW];eT.push(this._hide_photo(eV))}return eT};T.prototype._hide_photo=function(eT){var eU;eU=this.photos[eT];if((eU==null)||!(eU.status===H.DISPLAYED)){return}$(eU.uniqueness_key).hide();return eU.status=H.RENDERED};T.prototype._show_photos=function(e9){var e5,e4,e8,eX,e6,e2,eW,e3,e1,eZ,eY,e7,eV,eU,eT,e0;eX=[];for(e3=0,e7=e9.length;e3<e7;e3++){e4=e9[e3];e6=this._get_photo_insert_info(e4);if(!e6){continue}e8=e6[0],eW=e6[1];e2=false;for(e1=0,eV=eX.length;e1<eV;e1++){e5=eX[e1];if(e5.after===e8){e5.photos.push(eW);e2=true;break}}if(!e2){eX.push({after:e8,photos:[eW]})}}for(eZ=0,eU=eX.length;eZ<eU;eZ++){e5=eX[eZ];e5.after.__sert({after:e5.photos})}e0=[];for(eY=0,eT=e9.length;eY<eT;eY++){e4=e9[eY];e0.push(this.photos[e4].status=H.DISPLAYED)}return e0};T.prototype._get_photo_insert_info=function(eT){var eW,eU,eV,e0,eX,eZ,eY;eV=this.photos[eT];if((eV==null)||eV.status===H.DISPLAYED){return}if(eV.status===H.RENDERED){$(eV.uniqueness_key).show()}else{eU=$("p-top-"+this.unique_id);if(eT!==0){for(eW=eZ=eY=eT-1;eY<=0?eZ<=0:eZ>=0;eW=eY<=0?++eZ:--eZ){e0=this.photos[eW];if((e0!=null)&&e0.status>=H.RENDERED){eX=$(e0.uniqueness_key);cw(eX!=null,"photo "+eW+" was marked as rendered, but its thumb elm doesn't exist");eU=eX;break}}}return[eU,eV.thumb_html]}};T.prototype.in_y_range=function(eU,eT){return !(this.top_offset+this.timeline.HEADER_HEIGHT>eT||this.top_offset+this.get_height()<eU)};T.prototype.in_current_viewport=function(eV,eX){var eT,eU,eW;if(eV==null){eV=this.timeline.get_viewport_info()}if(eX==null){eX=true}eU=eV.top;eT=eV.top+eV.height;if(eX){eW=this._blur_range(eU,eT,eV),eU=eW[0],eT=eW[1]}return this.in_y_range(eU,eT)};T.prototype.hide_photos_if_not_in_current_viewport=function(eW){var eU,eY,eV,eX,eT,eZ;if(!this.in_current_viewport(eW)){if(this._is_loading_from_bottom()){for(eU=eY=eX=this.photos.length-this.num_photos_loaded,eT=this.photos.length;eX<=eT?eY<eT:eY>eT;eU=eX<=eT?++eY:--eY){this._hide_photo(eU)}}else{for(eU=eV=0,eZ=this.num_photos_loaded;0<=eZ?eV<eZ:eV>eZ;eU=0<=eZ?++eV:--eV){this._hide_photo(eU)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};T.prototype._blur_range=function(eW,eT,eY){var eV,eU,eX;if(eY==null){eY=this.timeline.get_viewport_info()}eX=df.get();if(eX>=0){eU=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;eV=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(eX<0){eU=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;eV=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}eW-=eU*eY.height;eT+=eV*eY.height;return[eW,eT]};T.prototype.get_photo_range_to_render=function(e1,eV){var eZ,eU,eY,e0,eX,eT,eW;if(eV==null){eV=true}eT=e1.top;eX=e1.bottom;if(eV){eW=this._blur_range(eT,eX,e1),eT=eW[0],eX=eW[1]}if(!this.in_y_range(eT,eX)){return[null,null]}e0=Math.floor((eT-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);eZ=Math.floor((eX-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);eU=Math.min(this.photos.length-1,e0*this.timeline.THUMBS_PER_ROW);eY=Math.min(this.photos.length-1,(eZ+1)*this.timeline.THUMBS_PER_ROW-1);cw(!isNaN(eY),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+e1.bottom+" ")+("viewport_data.height="+e1.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+eZ+" "),true,["photo_event_nan_limit"]);return[Math.max(0,eU),eY]};T.prototype.get_photo_range_to_render_with_blur=function(eW){var eU,eZ,eV,eY,eX,eT;eX=this.get_photo_range_to_render(eW,true),eZ=eX[0],eY=eX[1];eT=this.get_photo_range_to_render(eW,false),eU=eT[0],eV=eT[1];return[eZ,eU,eV,eY]};T.prototype.get_thumb_indexes_to_load=function(e6){var fd,e3,e1,e0,fa,fc,e9,fb,e7,eX,eV,eU,eT,e8,eZ,eY,eW,e5,e4,e2;e8=this.get_photo_range_to_render_with_blur(e6),e3=e8[0],fd=e8[1],e1=e8[2],e0=e8[3];if(fd==null){fa=(function(){eW=[];for(var fe=e3;e3<=e0?fe<=e0:fe>=e0;e3<=e0?fe++:fe--){eW.push(fe)}return eW}).apply(this);if(this.top_offset>e6.bottom){return fa}else{return fa.reverse()}}fb=(function(){e5=[];for(var fe=fd;fd<=e1?fe<=e1:fe>=e1;fd<=e1?fe++:fe--){e5.push(fe)}return e5}).apply(this);fc=[];e9=[];if(e3<fd){fc=(function(){e4=[];for(var fe=eZ=fd-1;eZ<=e3?fe<=e3:fe>=e3;eZ<=e3?fe++:fe--){e4.push(fe)}return e4}).apply(this)}if(e0>e1){e9=(function(){e2=[];for(var fe=eY=e1+1;eY<=e0?fe<=e0:fe>=e0;eY<=e0?fe++:fe--){e2.push(fe)}return e2}).apply(this)}e7=df.get();if(e7>=0){return fb.concat(e9).concat(fc)}else{return fb.concat(fc).concat(e9)}};T.prototype.log_thumb_load=function(eU,eV){var eX,eT,eW;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===bC.scroll_count&&!this.logged_thumbs_arrived){if((eU+1)%this.timeline.THUMBS_PER_ROW===0||eU+1===eV){if(this.visible_thumbs_loaded()){eT=this.timeline.get_viewport_info();eX=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<eT.bottom&&eT.bottom<this.top_offset+this.get_height())||eX){if(bC.scroll_count<2&&((eW=h.get_current_view())===b9.PHOTOS_VIEW||eW===b9.CAMERA_VIEW)){this.log_timing_event(G.viewport_initial_load);bC.scroll_count+=2}else{this.log_timing_event(G.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};T.prototype.log_timing_event=function(eW){var eT,eU,eX,eV;eU=bR.time();eT={};if(eW===G.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(eV=performance.timing)!=null?eV.navigationStart:void 0:void 0)!=null){eX=bR.time()-performance.timing.navigationStart;eT={current_view:h.get_current_view()};dX.log_ajax_transition(eX,eW,eT,eW)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(eW===G.viewport_loaded){eX=eU-this.timing_stopped_scrolling_on_event}return dX.log_ajax_transition(eX,eW,eT,eW)};return T})();var H;H=B.Photo=(function(){T.PLACEHOLDER=0;T.LOADED=1;T.RENDERED=2;T.DISPLAYED=3;T.uniqueness_key;T.item_counter;T.filename;T.ns_id;T.ns_path;T.fq_path;T.href;T.thumbnail_url;T.large_thumbnail_url;T.time_taken;T.display_time_taken;T.preview_type;T.mtime;T.video_streaming_url;T.is_visible;T.user_id;T.event;T.status;T.thumb_html;T.preview_obj;T.duplicates_info;function T(eT){this.event=eT;this.status=T.PLACEHOLDER;this.preview_obj=eT.unique_id}T.prototype.init_metadata=function(eT){this.uniqueness_key=eT.uniqueness_key;this.item_counter=eT.item_counter;this.filename=eT.filename;this.ns_id=eT.ns_id;this.ns_path=eT.ns_path;this.fq_path=eT.path;this.href=eT.href;this.thumbnail_url=eT.thumbnail_url;this.large_thumbnail_url=eT.large_thumbnail_url;this.time_taken=eT.time_taken;this.display_time_taken=eT.display_time_taken;this.preview_type=eT.preview_type;this.mtime=eT.mtime;this.video_streaming_url=eT.video_streaming_url;this.is_visible=eT.is_visible;this.user_id=eT.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true,Sprite:cj});this.preview_obj=this._get_preview_obj();this.status=T.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};T.prototype.set_duplicates=function(eV){var eU,eW,eT;for(eW=0,eT=eV.length;eW<eT;eW++){eU=eV[eW];eU.fq_path=eU.path}return this.duplicates_info=eV};T.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(bC.in_single_collection_view()){return new ew({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:D.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new c7({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:D.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(bC.in_single_collection_view()){return new ao({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:D.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new eD({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:D.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};T.prototype._get_display_date=function(){var eT;if(this.time_taken!=null){eT=new Date(this.time_taken);return bR.nice_date_with_month_name(eT,eT.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return T})();var Z;Z=B.PhotoCollection=(function(){T.CREATE_EVT="db:photocollection:create";T.ADD_EVT="db:photocollection:add";T.REMOVE_EVT="db:photocollection:remove";T.UNDO_REMOVE_EVT="db:photocollection:undo_remove";T.RENAME_EVT="db:photocollection:rename";T.DELETE_EVT="db:photocollection:delete";T.SHARE_EVT="db:photocollection:share";T.UNSHARE_EVT="db:photocollection:unshare";T.COVER_CHANGE_EVT="db:photocollection:cover_change";T.gid;T.name;T.num_items;T.num_photos;T.num_videos;T.thumbnail_url_32;T.thumbnail_url_256;T.is_anonymous;T.share_tkey;T.shmodel_url;T.short_url;T.is_creator;T.member_fnames;function T(eU,eT){if(eT==null){eT=true}cw((eU.gid!=null)&&(eU.url!=null)&&(eU.name!=null)&&(eU.num_items!=null)&&(eU.num_photos!=null)&&(eU.num_videos!=null),"missing required PhotoCollection params");this.gid=eU.gid;this.url=eU.url;this.name=eU.name;this.num_items=eU.num_items;this.num_photos=eU.num_photos;this.num_videos=eU.num_videos;this.thumbnail_url_32=eU.thumbnail_url_32||null;this.thumbnail_url_256=eU.thumbnail_url_256||null;this.is_anonymous=eU.is_anonymous!=null?eU.is_anonymous:false;this.share_tkey=eU.share_tkey||null;this.shmodel_url=eU.shmodel_url||null;this.short_url=eU.short_url||null;this.is_creator=eU.is_creator!=null?eU.is_creator:true;this.member_fnames=eU.member_fnames||[ef("You")];if(eT){document.fire(T.CREATE_EVT,{collection:this})}}T.prototype.add_photos=function(eZ,eY,eV,eX){var eT,eW,eU;if(eY==null){eY=null}if(eV==null){eV=false}if(eX==null){eX=true}eT=(function(){var e2,e1,e0;e0=[];for(e2=0,e1=eZ.length;e2<e1;e2++){eU=eZ[e2];e0.push(eU.item_counter)}return e0})();cw(eT.length,"Have to add at least one photo");eW={collection_gid:this.gid,item_counters:JSON.stringify(eT)};if(eY!=null){eW.source_collection_gid=eY}return new Ajax.DBRequest("/collection_add",{parameters:eW,job:eV,job_user:cy.get_viewer().photos_user,progress_text:ef("Adding to album..."),onSuccess:(function(e0){return function(e3){var e1,e4,e2,e5;e5=JSON.parse(e3.responseText);e0.thumbnail_url_32=e5.thumbnail_url_32;e0.thumbnail_url_256=e5.thumbnail_url_256;e4=e5.new_num_photos-e0.num_photos;e2=e5.new_num_videos-e0.num_videos;e1=e5.new_num_items-e0.num_items;e0.num_photos=e5.new_num_photos;e0.num_videos=e5.new_num_videos;e0.num_items=e5.new_num_items;return document.fire(T.ADD_EVT,{collection:e0,photos:eZ,num_items_added:e1,num_photos_added:e4,num_videos_added:e2,promote_collection:eX})}})(this)})};T.prototype.remove_photos=function(eW,eV){var eT,eU;if(eV==null){eV=false}eT=(function(){var eZ,eY,eX;eX=[];for(eZ=0,eY=eW.length;eZ<eY;eZ++){eU=eW[eZ];eX.push(eU.item_counter)}return eX})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(eT),is_shared:this.share_tkey!=null,num_items:this.num_items},job:eV,job_user:cy.get_viewer().photos_user,progress_text:ef("Removing from album..."),onSuccess:(function(eX){return function(eY){var eZ;eZ=JSON.parse(eY.responseText);eX.thumbnail_url_32=eZ.thumbnail_url_32;eX.thumbnail_url_256=eZ.thumbnail_url_256;eX.num_photos=eZ.new_num_photos;eX.num_videos=eZ.new_num_videos;eX.num_items=eZ.new_num_items;return document.fire(T.REMOVE_EVT,{collection:eX,photos:eW,undo_changeset:eZ.undo_changeset})}})(this)})};T.prototype.undo_remove=function(eT){return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:eT},html_in_error_msg:true,progress_text:ef("Undoing..."),onSuccess:(function(eU){return function(){return document.fire(T.UNDO_REMOVE_EVT,{collection:eU})}})(this)})};T.prototype.rename=function(eU){var eT;bC.enable_selection();eT=new Ajax.InPlaceEditor(eU,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return br("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:ef("Saving..."),onLeaveEditMode:bC.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:(function(eV){return function(eW){eV.name=eW.responseText;return document.fire(T.RENAME_EVT,{collection:eV})}})(this)},callback:(function(eV){return function(eW,eX){return{collection_gid:eV.gid,new_collection_name:eX,is_shared:eV.share_tkey!=null}}})(this)});return eT.enterEditMode()};T.prototype["delete"]=function(){if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:cy.get_viewer().photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:cy.get_viewer().photos_user,onSuccess:(function(eT){return function(){return document.fire(T.DELETE_EVT,{collection:eT})}})(this)})};T.prototype.attach_to_token=function(eV,eX,eU,eW,eT){return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:eV,collection_gid:this.gid,num_items:this.num_items},onSuccess:(function(eY){return function(){eY.share_tkey=eV;eY.shmodel_url=eX;eY.short_url=eU;if(typeof eW==="function"){eW()}return document.fire(T.SHARE_EVT,{collection:eY})}})(this),onFailure:function(){return typeof eT==="function"?eT():void 0}})};T.prototype.send_link=function(eU,eW,e0,eV,eZ,eT){var eY,eX;eY=(function(e1){return function(){e1.share_tkey=eW;e1.shmodel_url=e0;e1.short_url=eV;if(typeof eZ==="function"){eZ()}return document.fire(T.SHARE_EVT,{collection:e1})}})(this);eX={collection_gid:this.gid,share_tkey:eW,num_items:this.num_items};return bF.ajax_submit(eU,"/collection_share",eY,eT,eU.down(".tokenizer-submit-button"),eX)};T.prototype.unshare=function(){cw(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:(function(eT){return function(){eT.share_tkey=null;eT.shmodel_url=null;eT.short_url=null;return document.fire(T.UNSHARE_EVT,{collection:eT})}})(this),subject_user:cy.get_viewer().photos_user})};T.prototype.set_cover=function(eT){return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:eT.item_counter},onSuccess:(function(eU){return function(eV){var eW;eW=JSON.parse(eV.responseText);eU.thumbnail_url_32=eW.thumbnail_url_32;eU.thumbnail_url_256=eW.thumbnail_url_256;return document.fire(T.COVER_CHANGE_EVT,{collection:eU})}})(this)})};return T})();var bS,k;bS=__PARENT_SCOPE__.FilePreview=INLINE_JS.FilePreview=B.FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,init_pdf:function(eX,eW,eU,T){var eT,eV;this._pdfLink=T;this._log_pdf_render_time(eX);if(eX==="pdf-native"||eX==="pdf-embedded"||eX==="pdf-js"){window.addEventListener("message",k,false);br((function(eY){return function(){br("#pdf-embed-iframe").attr("src",eW);br("#pdf-embed-iframe").attr("type","application/pdf");br("#pdf-embed-iframe").attr("allowfullscreen","");br("html, body").addClass("full_height");return eY._fire_pdf_render_event()}})(this));this.preview_status=eU;if(bO.chrome){eV=function(){var eY;eY=br('link[rel="shortcut icon"]').remove();return br("head").append(eY)};setTimeout(eV,1000)}eT=$$("#pdf-embed-container iframe");return window.setTimeout(((function(eY){return function(){return eT.invoke("setStyle",{visibility:"visible"})}})(this)),200)}},init_excel:function(T){window.addEventListener("message",k,false);return br("#pdf-embed-iframe").attr("src",T)},excel_preview_unsupported:function(){return this.preview_failed()},init_font:function(){return br((function(T){return function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}}})(this))},init_photo:function(eV,eZ,eX){var e1,eW,e0,eY,eU,T,eT;$("preview-img").observe("error",this.preview_failed.bind(this));if((eY=window.performance)!=null?(eU=eY.timing)!=null?eU.navigationStart:void 0:void 0){$("preview-img").observe("load",function(){var e2;e2=bR.time()-window.performance.timing.navigationStart;return dX.log_ajax_transition(e2,"file-preview-photo")})}$("full-img").src=eV;T=$$("#preview-img, #full-img");eT=[];for(eW=0,e0=T.length;eW<e0;eW++){e1=T[eW];e1.setAttribute("data-original-href",eZ);e1.setAttribute("enable-download",eX);eT.push(e1.on("contextmenu","img",bc.show_shmodel.bind(bc)))}return eT},init_htmlified:function(){if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this.preview_failed();return}return setTimeout(((function(T){return function(){if(!window.htmlified_height){return T.preview_failed()}}})(this)),10000)},htmlified_loaded:function(){var T;if((T=$("htmlified-loading"))!=null){T.remove()}if(br("#htmlified-wrapper[data-docpreview-ui-rams-enabled='True'] iframe, code-wrapper[data-docpreview-ui-rams-enabled='True'] iframe").length===0){$("htmlified").style.height=window.htmlified_height+"px"}return $("htmlified").style.visibility=""},init_video:function(eW,eY,eT,eV,T,eU,eX){return br((function(eZ){return function(){var e2,e0,e1;e1=eX.width()*0.9;e0=e1*0.55;e2=eZ._video_preview_failed;if(eV==="hls"){eZ.player=bi.embed("#video",{src:eT,type:"application/vnd.apple.mpegurl",width:e1,height:e0,controls:true,poster:T,onError:e2,onReady:eZ._player_ready,metadata_link:eU})}else{br("#video").empty();if(eW){if(eY){eZ.player=bi.embed("#video",{src:eT,type:"video/mp4",width:e1,height:e0,controls:true,poster:T,onError:e2,onReady:eZ._player_ready,metadata_link:eU})}else{e2()}}else{eZ.player=bi.embed("#video",{src:eT,type:"video/flv",width:e1,height:e0,controls:true,poster:T,onError:e2,onReady:eZ._player_ready,metadata_link:eU})}}br(".vjs-poster").hide();br(".vjs-big-play-button").hide();eZ.player.on("play",eZ._onPlay);return eZ.player.on("ended",eZ._onEnded)}})(this))},photo_loaded:function(eU){var eT,T;if((eT=window.performance)!=null?(T=eT.timing)!=null?T.navigationStart:void 0:void 0){eU=eU-window.performance.timing.navigationStart;return dX.log_ajax_transition(eU,"file-preview-photo")}},_player_ready:function(){var T;T=function(){br(".vjs-poster").show();br(".vjs-big-play-button").show();return br(".vjs-big-play-button").focus()};return T.defer()},_onPlay:function(){br(".vjs-poster").hide();return br(".vjs-big-play-button").hide()},_onEnded:function(){br(".vjs-poster").show();br(".vjs-big-play-button").show();return br(".vjs-loading-spinner").hide()},_video_preview_failed:function(T){if(T==="needflash"){br("#video-preview-flash-message").show()}return bS.preview_failed()},preview_failed:function(){var T;T=br(document.body);if(T.hasClass("shmodel-body")){T.removeClass("file-preview-body")}ab.error(ef("Preview failed."));return br(document).trigger("preview_failed")},_fire_pdf_render_event:function(){var T;if(document.createEvent&&window.dispatchEvent){T=document.createEvent("UIEvents");T.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(T)}},_log_pdf_render_time:function(eT){var T;T=function(eX){var eV,eW,eU;if((eW=window.performance)!=null?(eU=eW.timing)!=null?eU.navigationStart:void 0:void 0){eV=bR.time()-window.performance.timing.navigationStart;return dX.log_ajax_transition(eV,eX)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return T(eT)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return T(""+eT+"-parse")})},_getEmbedContainer:function(){var T;T=br("#pdf-embed-container, #html-container, #htmlified-wrapper, #code-wrapper");if(T.length!==1){T=[]}return T},nativePdfPrint:function(){var T,eU,eT;if(!br("body").hasClass("file-preview-body")||br("#pdf-embed-iframe").length!==1||(this._pdfLink==null)){return false}eT=D.parse(bO.get_href());eT.setQuery({preview:1,force_no_progressive:1});T=D.parse(this._pdfLink).getAuthority();eU=bH.getNativePrintUrl(eT.toString(),T,br("#pdf-embed-container"));if(eU==null){return false}window.open(eU,"_blank");return true},enter_rams_fullscreen:function(){return bH.enter_rams_fullscreen(br(this._getEmbedContainer()))},exit_rams_fullscreen:function(){return bH.exit_rams_fullscreen(br(this._getEmbedContainer()))},is_rams_fullscreen_active:function(){return bH.is_rams_fullscreen_active(br(this._getEmbedContainer()))}};k=function(eW){var eV,eT,eU,T;eT={"https://dl-doc.dropbox.com":true,"https://dl.dropbox.com":true};eT["https://"+Constants.DL_DOC_USER_CONTENT_DOMAIN]=true;eT["https://"+Constants.PUBSERVER]=true;eT[Constants.WEB_STATIC_DROPBOX]=true;if(eT[eW.origin]){eU={};try{eU=JSON.parse(eW.data);eV=eU.action}catch(eX){T=eX;eV=eW.data}switch(eV){case"failed":return bS.preview_failed()}}};var dU;Effect.BlindFadeUp=function(eV,eU){var eT,T;eT=new Effect.BlindUp(eV,eU);T=new Effect.Fade(eV,eU);this.cancel=function(){eT.cancel();return T.cancel()}};Effect.BlindFadeDown=function(eV,eU){var eT,T;eT=new Effect.BlindDown(eV,eU);T=new Effect.Appear(eV,eU);this.cancel=function(){eT.cancel();return T.cancel()}};Effect.Flash=function(eU,eT,T){cw(eT.startcolor&&eT.endcolor,"Start and end colors must be specified");cw(eT.cycles,"Fade cycles must be specified");T=T||0;return new Effect.Highlight(eU,{duration:1,startcolor:eT.startcolor,endcolor:eT.endcolor,restorecolor:eT.endcolor,afterFinish:function(){return new Effect.Highlight(eU,{duration:1,startcolor:eT.endcolor,endcolor:eT.startcolor,restorecolor:eT.startcolor,afterFinish:function(){if(T<eT.cycles){return Effect.Flash(eU,eT,T+1)}}})}})};Effect.ScaleComprehensive=Class.create(Effect.Scale,{setup:function(){var e8,e6,fe,e2,e7,e9,e3,e4,eZ,eW,eU,eT,ff,fk,fi,fg,fd,fc,fb,fa,T,fl,fj,fh,e5,e1,e0,eY,eV,eX;this.restoreAfterFinish=this.options.restoreAfterFinish||false;this.elementPositioning=this.element.getStyle("position");this.originalStyle={};e5=["top","left","width","height","fontSize"];for(eZ=0,ff=e5.length;eZ<ff;eZ++){e9=e5[eZ];this.originalStyle[e9]=this.element.style[e9]}this.originalTop=this.element.offsetTop;this.originalLeft=this.element.offsetLeft;e2=this.element.getStyle("font-size")||"100%";e1=["em","px","%","pt"];for(eW=0,fk=e1.length;eW<fk;eW++){e7=e1[eW];if(e2.indexOf(e7)>0){this.fontSize=parseFloat(e2);this.fontSizeType=e7}}this.factor=(this.options.scaleTo-this.options.scaleFrom)/100;if(this.options.scaleMode==="box"){this.dims={height:this.element.offsetHeight,width:this.element.offsetWidth}}if(/^content/.test(this.options.scaleMode)){this.dims={height:this.element.scrollHeight,width:this.element.scrollWidth}}if(!this.dims){this.dims={height:this.options.scaleMode.originalHeight,width:this.options.scaleMode.originalWidth}}this.full_height=this.dims.height;this.full_width=this.dims.width;e6=["border%sWidth","margin%s","padding%s"];for(eU=0,fi=e6.length;eU<fi;eU++){e3=e6[eU];e0=["Top","Bottom","Left","Right"];for(eT=0,fg=e0.length;eT<fg;eT++){fe=e0[eT];e4=e3.format(fe);this.dims[e4]=parseFloat(this.element.getStyle(e4));if(fe==="Top"||fe==="Bottom"){this.full_height+=this.dims[e4]}else{this.full_width+=this.dims[e4]}}}this.attrs_vertical=[];this.attrs_horizontal=[];if(this.options.scaleX){for(T=0,fd=e6.length;T<fd;T++){e8=e6[T];this.attrs_horizontal.push(e8.format("Left"))}this.attrs_horizontal.push("width");eY=e6.reverse();for(fl=0,fc=eY.length;fl<fc;fl++){e8=eY[fl];this.attrs_horizontal.push(e8.format("Right"))}}if(this.options.scaleY){for(fj=0,fb=e6.length;fj<fb;fj++){e8=e6[fj];this.attrs_vertical.push(e8.format("Top"))}this.attrs_vertical.push("height");eV=e6.reverse();eX=[];for(fh=0,fa=eV.length;fh<fa;fh++){e8=eV[fh];eX.push(this.attrs_vertical.push(e8.format("Bottom")))}return eX}},update:function(T){var eT;eT=(this.options.scaleFrom/100)+(this.factor*T);eT=(-0.5+1/(1+Math.exp((0.5-eT)*7)))*1.055+0.5;if(this.options.scaleContent&&this.fontSize){this.element.setStyle({fontSize:this.fontSize*eT+this.fontSizeType})}return this.setDimensions(eT)},setDimensions:function(eW){var e1,e4,e2,eZ,e0,eT,eX,eV,e3,T,eY,eU;e2={};eY=[[this.full_width,this.attrs_horizontal],[this.full_height,this.attrs_vertical]];for(eX=0,e3=eY.length;eX<e3;eX++){eU=eY[eX],eZ=eU[0],e4=eU[1];e0=eZ*eW;for(eV=0,T=e4.length;eV<T;eV++){e1=e4[eV];eT=this.dims[e1];if(eT<e0){e2[e1]=eT+"px";e0-=eT}else{e2[e1]=e0.round()+"px";e0=0}}}return this.element.setStyle(e2)}});Effect.BlindUpComprehensive=function(T){T=$(T);T.makeClipping();return new Effect.ScaleComprehensive(T,0,Object.extend({scaleContent:false,scaleX:false,restoreAfterFinish:true,afterFinishInternal:function(eT){return eT.element.hide().undoClipping()}},arguments[1]||{}))};Effect.BlindDownComprehensive=function(eT){var T;eT=$(eT);T=eT.getDimensions();return new Effect.ScaleComprehensive(eT,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:0,scaleMode:{originalHeight:T.height,originalWidth:T.width},restoreAfterFinish:true,afterSetup:function(eU){return eU.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(eU){return eU.element.undoClipping()}},arguments[1]||{}))};Effect.HighlightForcedWithAlpha=Class.create(Effect.Highlight,{setup:function(){var e0,eY,eU,eX,eZ,eV,e1,eW,eT,T;this.oldStyle={};if(!this.options.keepBackgroundImage){this.oldStyle.backgroundImage=this.element.getStyle("background-image");this.element.setStyle({backgroundImage:"none"})}if(!this.options.endcolor){this.options.endcolor=this.element.getStyle("background-color")}if(!this.options.restorecolor){this.options.restorecolor=this.element.getStyle("background-color")}this._supports_alpha=false;try{eY=new Element("div");eZ="rgba(1, 1, 1, 0)";eY.setStyle({backgroundColor:eZ});this._supports_alpha=(eY.getStyle("background-color"))===eZ}catch(e2){}this._base=dU(this.options.startcolor);if((eW=this.options.endcolor)==="transparent"||eW==="rgba(0, 0, 0, 0)"){if(this._supports_alpha){eU=this._base.slice(0);eU[3]=0}else{eU=[255,255,255,1]}}else{eU=dU(this.options.endcolor)}this._delta=[];eT=this._base;T=[];for(eX=eV=0,e1=eT.length;eV<e1;eX=++eV){e0=eT[eX];T.push(this._delta.push(eU[eX]-e0))}return T},update:function(T){var eZ,eU,eY,eV,eX,eT,eW;eY=[];eW=this._base;for(eV=eX=0,eT=eW.length;eX<eT;eV=++eX){eZ=eW[eV];eU=eZ+this._delta[eV]*T;if(!(eV>2)){eU=Math.round(eU)}eY.push(eU)}if(this._supports_alpha){return this.element.setStyle({backgroundColor:"rgba("+(eY.join(", "))+")"})}else{return this.element.setStyle({backgroundColor:"rgb("+(eY.slice(0,3).join(", "))+")"})}}});dU=function(eU){var eV,eY,eX,eW,T,eT,eZ,e1,e0;eT=/^rgb\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)$/;T=/^rgba\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3}), ?(\d+?\.?\d*)\)$/;eW=/^#([0-9A-F])([0-9A-F])([0-9A-F])$/i;eY=/^#([0-9A-F])([0-9A-F])([0-9A-F])([0-9A-F])$/i;eX=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;eV=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;if(e1=eU.match(eT)){e0=(function(){var e5,e3,e4,e2;e4=e1.slice(1);e2=[];for(e5=0,e3=e4.length;e5<e3;e5++){eU=e4[e5];e2.push(parseInt(eU,10))}return e2})()}else{if(e1=eU.match(T)){e0=(function(){var e5,e3,e4,e2;e4=e1.slice(1,4);e2=[];for(e5=0,e3=e4.length;e5<e3;e5++){eU=e4[e5];e2.push(parseInt(eU,10))}return e2})();e0[3]=parseFloat(e1[4])}else{if(e1=eU.match(eW)){e0=(function(){var e5,e3,e4,e2;e4=e1.slice(1);e2=[];for(e5=0,e3=e4.length;e5<e3;e5++){eU=e4[e5];e2.push(parseInt(eU+eU,16))}return e2})()}else{if(e1=eU.match(eY)){e0=(function(){var e5,e3,e4,e2;e4=e1.slice(1);e2=[];for(e5=0,e3=e4.length;e5<e3;e5++){eU=e4[e5];e2.push(parseInt(eU+eU,16))}return e2})()}else{if(e1=eU.match(eX)){e0=(function(){var e5,e3,e4,e2;e4=e1.slice(1);e2=[];for(e5=0,e3=e4.length;e5<e3;e5++){eU=e4[e5];e2.push(parseInt(eU,16))}return e2})()}else{if(e1=eU.match(eV)){e0=(function(){var e5,e3,e4,e2;e4=e1.slice(1);e2=[];for(e5=0,e3=e4.length;e5<e3;e5++){eU=e4[e5];e2.push(parseInt(eU,16))}return e2})()}}}}}}e0=e0||[255,255,255,1];eZ=e0.length;if(eZ===3){e0.push(1)}else{if(eZ===4&&e0[eZ-1]>1){e0[eZ-1]=e0[eZ-1]/255}}return e0};var ax;ax=B.ClientDownload=(function(){function T(){}T.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(eT){var eU;eU=br("<div",{"class":"brodal-header",text:ef("Install Dropbox")});return eM.show(eU[0],$("client-download"),{},false,450)},subject_user:cf.active_user})};return T})();var cl,d2,h,G,aZ,cT,b9;cl=B.AlbumsLogger={log_share:function(eT,eW,eV,eU,T){return cl.log(eT,eW,true,eV,eU,T)},log_event:function(T,eV,eU,eT){return cl.log(T,eV,false,eU,eT)},log:function(eT,eY,eV,eX,eW,T){var eU;eU={evt:eT,collection_gid:eY,is_anonymous:eW};if(eV!=null){eU.share_event=eV}if(eX!=null){eU.num_items=eX}if(T!=null){eU.on_create=T}return new Ajax.DBRequest("/collection_log",{method:"post",noAutonotify:true,parameters:eU})}};d2=INLINE_JS.PhotosEvents=B.PhotosEvents={CLEAR_SELECTED:"clear_selected",SHARE:"share",SHARE_ALBUM:"share_album",GO_TO_ALBUM_LINK:"go_to_album_link",UNSHARE_ALBUM:"unshare_album",ADD_TO_NEW_ALBUM:"add_to_new_album",ADD_TO_RECENT_ALBUM:"add_to_recent_album",ADD_TO_OTHER_ALBUM:"add_to_other_album",SHOW_IN_FOLDER:"show_in_folder",DELETE:"delete",DELETE_ALBUM:"delete_album",REMOVE:"remove",SET_AS_COVER:"set_as_cover",RENAME_ALBUM:"rename_album",OPEN_LIGHTBOX:"open_lightbox",MARQUEE_SELECT:"marquee_select",SEND:"send",GET_LINK:"get_link",FB_SHARE:"fb_share",TWITTER_SHARE:"twitter_share"};aZ=INLINE_JS.PhotosTourEvents=B.PhotosTourEvents={SKIP:"skip",AWESOME:"awesome",EXIT_MODAL:"exit_modal",SHOW_MODAL:"show_modal"};cT=INLINE_JS.PhotosTriggers=B.PhotosTriggers={SAH:"selected_actions_header",PCM:"photos_context_menu",CCM:"collections_context_menu",SCA:"single_collection_action",CLICK:"click",DBL_CLICK:"double_click",DRAG:"drag",ESC:"escape",CLICK_TITLE:"click_title",LIGHTBOX:"lightbox",DROP_TARGET:"drop_target",FOSHMODAL:"foshmodal"};b9=B.PhotosViews={PHOTOS_VIEW:"photos_view",CAMERA_VIEW:"camera_view",ALBUMS_VIEW:"albums_view",SINGLE_COLLECTION_VIEW:"single_collection_view",NOT_PHOTOS:"not_photos",MISSING_TIMESTAMPS_VIEW:"missing_timestamps_view"};h=INLINE_JS.PhotosLogger=B.PhotosLogger={last_logged_error_msg:null,last_error_msg_url:null,get_current_view:function(){var T,eU,eT;T=((eT=$("modal"))!=null?eT.visible():void 0)&&$("shmodal").visible();eU=T?"-foshmodal":"";if(bC.in_single_collection_view()){return b9.SINGLE_COLLECTION_VIEW+eU}else{if(bC.in_all_collections_view()){return b9.ALBUMS_VIEW+eU}else{if(bC.initialized){return b9.PHOTOS_VIEW+eU}else{return b9.NOT_PHOTOS}}}},log_interaction:function(T,eT,eU){return h.log(T,eT,null,h.get_current_view(),eU)},log_transition_to:function(T){return h.log(T,null,null,h.get_current_view(),null,true)},log:function(eT,eU,T,eY,eW,eX){var eV;eV={evt:eT,trigger:eU,view:T};if(eW!=null){eV.data=JSON.stringify(eW)}if(eY!=null){eV.start_view=eY}if(eX!=null){eV.transition=true}return new Ajax.DBRequest("/photos_log",{method:"post",noAutonotify:true,parameters:eV})}};G=B.PhotosTimingEvents={viewport_loaded:"viewport_loaded",viewport_initial_load:"viewport_initial_load"};var dr,aG;aG=B.ShmodelLogger={CLICK_SIGN_IN:"click_sign_in",CLICK_ADD_TO_MY_DROPBOX:"click_add_to_my_dropbox",REMOVE_LINK:"remove_link",CLICK_FILENAME:"click_filename",CLICK_DOWNLOAD:"click_download",LOGIN_THRU_DEFAULT_DROPDOWN:"login_thru_default_dropdown",CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN:"click_signup_thru_default_dropdown",CLICK_SHARE:"click_share",log:function(T){return new Ajax.DBRequest("/shmlog",{method:"post",noAutonotify:true,parameters:{evt:T,url:window.location.href}})},attachLogListener:function(T,eT){if(eT==null){return}return eT.observe("click",function(eU){aG.log(T);if(eT.href&&eT.href!=="#"&&eT.target!=="_blank"){Event.stop(eU);return(function(){return window.location.href=eT.href}).defer()}})}};dr=B.RegistrationLogger={log:function(T){var eT;eT=window.location.href;return new Ajax.DBRequest("/share/reglog",{method:"post",noAutonotify:true,parameters:{evt:T,url:eT}})},attachLogListener:function(T,eT){if(eT==null){return}return eT.observe("click",function(eU){dr.log(T);if(eT.href&&eT.href!=="#"&&eT.target!=="_blank"){Event.stop(eU);return(function(){return window.location.href=eT.href}).defer()}})}};var e;e=B.ModalFlow=(function(){function T(e1,eZ,e3,eV,eU,eY,e2){var eT,eW,e0,eX;this.title=e1;this.icon=eZ;this.states=e3;this.next_state_table=eV;this.previous_state_table=eU;this.initial=eY;this.onStart=e2;this._state_map={};eX=this.states;for(eW=0,e0=eX.length;eW<e0;eW++){eT=eX[eW];this._state_map[eT.name]=eT}this.state=null;this._exit_listeners=[];this._cleanup_queue=[]}T.prototype.start=function(){var eW,eV,eT,eU;this.vars={};eU=this.states;for(eV=0,eT=eU.length;eV<eT;eV++){eW=eU[eV];eW.next=this._next.bind(this,eW);eW.back=this._back.bind(this,eW);if(eW.onSubmit){eW.onSubmitFn=(function(eX,eY){eX.onSubmit(this,eX,eY);return false}).bind(this,eW)}else{eW.onSubmitFn=((function(eX){return function(eY,eZ){eY.next();return false}})(this)).bind(this,eW)}eW.contents.on("submit",eW.onSubmitFn);eW.contents.find(".backbutton").on("click",eW.back)}eM.onHide=this._onExit.bind(this);if(this.onStart){this.onStart()}this.to_state(this.initial);return false};T.prototype.to_state=function(eU){var eT;this.state=this._state_map[eU];eT=this.title;if(this.state.title!=null){eT=this.state.title}eM.show(eT,this.state.contents[0]);return this.state.enter(this)};T.prototype._next=function(eT){var eU;if(eT===this.state){eU=this.next_state_table[this.state.name](this);if(eU==="__exit__"){return this.exit()}else{return this.to_state(eU)}}};T.prototype._back=function(eT){var eU;if(eT===this.state){eU=this.previous_state_table[this.state.name](this);if(eU==="__cancel__"){return this.exit()}else{if(eU){return this.to_state(eU)}}}};T.prototype.exit=function(){return this._onExit()};T.prototype._onExit=function(e0){var eV,eT,eY,eX,e1,eU,eZ,eW;eZ=this.states;for(eY=0,e1=eZ.length;eY<e1;eY++){eT=eZ[eY];eT.contents.off("submit",eT.onSubmitFn)}this._cleanUpExitListeners();eW=this._exit_listeners;for(eX=0,eU=eW.length;eX<eU;eX++){eV=eW[eX];eV(e0)}eM.onHide=null;return eM.hide()};T.prototype.addExitListener=function(eT){return this._exit_listeners.push(eT)};T.prototype.removeExitListener=function(eT){return this._cleanup_queue.push(eT)};T.prototype._cleanUpExitListeners=function(){var eW,eV,eY,eU,eX,eT;eX=this._cleanup_queue;eT=[];for(eY=0,eU=eX.length;eY<eU;eY++){eW=eX[eY];eV=this._exit_listeners.indexOf(eW);eT.push(this._exit_listeners.splice(eV,1))}return eT};return T})();var cr;cr=B.TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(T){this._user=cy.get_viewer().get_user_by_id(T);cw(this._user,""+T+" is invalid");return br("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){br("#resend-link").on("click",this.resend_phone_code.bind(this));return br("#code").focus()},init:function(T){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();return dL.async_load_script(T)},account_listen:function(){var eY,T,eT,eV,eW,e1,e2,eU,e0,eX,eZ;e0={name:"delivery_choice",enter:(function(e3){return function(e4){var e5;e3.hide_error();e5=0;br(".delivery-choice").each(function(){var e6;e6=br(this).height();return e5=Math.max(e6,e5)});br(".delivery-choice").height(e5);return br(".delivery-choice.selected > input").prop("checked",true)}})(this),contents:br("#twofactor-delivery-choice"),onSubmit:(function(e3){return function(e4,e5,e6){e4.vars.sms=!!(br("#use-sms")[0].getValue()==="on");if(!e4.vars.sms){return e3.fetch_offline_key(e4,e5)}else{return e5.next()}}})(this)};eX={name:"enter_phone_number",enter:(function(e3){return function(e5){var e6,e4;e3.hide_error();e3._is_offline_setup=false;e3._phone_number=null;e6=$("twofactor-enter-phone");e4=e3.fill_phone_number_for_edit(e6,br("#twofactor-row-"+e3._user.role+" #twofactor-sms-number").text());return e4.focus()}})(this),contents:br("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};eZ={name:"offline_setup",enter:(function(e3){return function(e4){e3.hide_error();e3._is_offline_setup=true;return e3._phone_number=null}})(this),contents:br("#twofactor-offline-setup")};eU={name:"confirm_phone",enter:(function(e3){return function(e4){var e5;e3._invalid_code_count=0;if(e3._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{e5=e4.vars.phone_number;cw(e5,"expected a display_phone argument");$("phone-number-placeholder").__date(e5);$("twofactor-enable-confirm").removeClassName("offline")}e3.hide_error();$("phone-code").clear().focus();return e3.fill_delivery_choice(e5)}})(this),onSubmit:this.submit_phone_code.bind(this),contents:br("#twofactor-enable-confirm")};e2={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:br("#twofactor-enter-backup-phone")};eW=new e(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:br("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,(function(e3){return function(e4,e5){e3.successfully_enabled=false;e4.vars.mode="ENABLE";e4.vars.passed_password=true;return e5.next()}})(this)),contents:br("#twofactor-enter-password")},e0,eX,eZ,eU,e2,{name:"recovery_code",enter:(function(e3){return function(){e3.fill_backup_phone(e3._backup_phone);return e3.hide_error.bind(e3)}})(this),onSubmit:this.submit_finish.bind(this),contents:br("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:ef("Congrats! You've enabled two-step verification!"),contents:br("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:((function(e3){return function(e4){if(e4.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}})(this)),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(e3){if(e3.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});eW.addExitListener((function(e3){return function(e4){if(eW.vars.passed_password&&e4&&!e3.successfully_enabled){return ab.error(ef("Two-step verification is not enabled"))}}})(this));eV=new e(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(e3){return function(e5,e6){var e4;e3.successfully_enabled=false;br(".delivery-choice").removeClass("selected");e4=!br("#twofactor-row").hasClass("with-sms");br(e4?"#app-choice":"#sms-choice").addClass("selected");br("#twofactor-recovery").addClass("edit-mode");e5.vars.passed_password=true;return e6.next()}})(this)),contents:br("#twofactor-enter-password")},e0,eX,eZ,eU,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:br("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:((function(e3){return function(e4){if(e4.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}})(this)),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(e3){if(e3.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});eV.addExitListener((function(e3){return function(e4){if(eV.vars.passed_password&&e4&&!e3.successfully_enabled){return ab.error(ef("Two-step verification has not been changed"))}}})(this));T=new e(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,(function(e3){return function(e4,e5){e3.successfully_disabled=false;e4.vars.passed_password=true;return e5.next()}})(this)),contents:br("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:br("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});T.addExitListener((function(e3){return function(e4){if(T.vars.passed_password&&e4&&!e3.successfully_disabled){return ab.error(ef("Two-step verification is still enabled"))}}})(this));eY=new e(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(e3){return function(e4,e5){return e5.next()}})(this)),contents:br("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:br("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");eT=new e(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(e3){return function(e4,e5){return e5.next()}})(this)),contents:br("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:br("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");e1=new e(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(e3){return function(e4,e5){return new Ajax.DBRequest(e3.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:e3._checkpoint_token},onSuccess:function(e6){var e7;e7=e6.responseText.strip();if(e7.startsWith("OK:")){e3.fill_recovery_code(e7.substr(3),"backup-code-div-edit");return e5.next()}else{switch(e7){case"EXPIRED":return e3.show_error_expired();case"ALREADY_DISABLED":br("#twofactor-row").removeClass("twofactor-enabled");ab.success(ef("Two-step verification is already disabled. Did you maybe disable it in another window?"));return eM.hide()}}},onFailure:e3.show_error500.bind(e3),cleanUp:e3.hide_loading.bind(e3),subject_user:e3._user})}})(this)),contents:br("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:br("#twofactor-recovery-edit"),onSubmit:(function(e3){return function(e4,e5){e3._checkpoint_token=null;return e5.next()}})(this)}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");br(".enable-twofactor").on("click",(function(e3){return function(e4){return e3.start_flow(e4,eW)}})(this));br(".disable-twofactor").on("click",(function(e3){return function(e4){return e3.start_flow(e4,T)}})(this));br(".add-twofactor-backup-link").on("click",(function(e3){return function(e4){return e3.start_flow(e4,eY)}})(this));br(".edit-twofactor-backup").on("click",(function(e3){return function(e4){return e3.start_flow(e4,eT)}})(this));br(".edit-twofactor-recovery").on("click",(function(e3){return function(e4){return e3.start_flow(e4,e1)}})(this));br(".edit-twofactor-sms, .edit-twofactor-offline").on("click",(function(e3){return function(e4){return e3.start_flow(e4,eV)}})(this));br("#generate-new-recovery-code").on("click",(function(e3){return function(e4){e3.show_loading();return new Ajax.DBRequest(e3.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:e3._checkpoint_token},onSuccess:function(e5){var e6;e6=e5.responseText.strip();if(e6.startsWith("OK:")){return e3.fill_recovery_code(e6.substr(3),"backup-code-div-edit")}else{switch(e6){case"EXPIRED":e1.to_state("password");return e3.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ab.success(ef("Two-step verification is disabled. Did you maybe disable it in another window?"));return eM.hide()}}},onFailure:e3.show_error500.bind(e3),cleanUp:e3.hide_loading.bind(e3),subject_user:e3._user})}})(this));br("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));br("#resend-link").on("click",this.enable_resend_phone_code.bind(this));br("#twofactor-delivery-choice input").change(function(){br(".delivery-choice").removeClass("selected");return br(this).parents(".delivery-choice").addClass("selected")});br("#show-qr").on("click",(function(e3){return function(e4){br("#twofactor-offline-setup").addClass("showing-qr");return false}})(this));br("#hide-qr").on("click",(function(e3){return function(e4){br("#twofactor-offline-setup").removeClass("showing-qr");return false}})(this));if(window.location.hash==="#backup2fa"&&br("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(eY)}},start_flow:function(eU,eT){var T;eU.preventDefault();T=br(eU.target).data("uid");cr.set_user(cy.get_viewer().get_user_by_id(T));this._current_flow=eT;eT.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return br("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(eT){var T;if(this.is_resending()){return}this.show_resending();T="/twofactor_resend";if(br("#twofactor-confirm").hasClass("backup")){T=D.parse(T).updateQuery({backup:true}).toString()}new Ajax.DBRequest(T,{onSuccess:(function(eU){return function(eV){switch(eV.responseText.strip()){case"OK":eU.hide_error();return eU.notify_resent();case"UNREACHABLE":return eU.show_error_unreachable(true);case"BADCARRIER":return eU.show_error_bad_carrier();case"INVALIDNUMBER":return eU.show_error_invalid_number();case"NOTAMOBILE":return eU.show_error_not_a_mobile();case"RATELIMIT":return ab.error(ef("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(T){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(eT){return function(eU){switch(eU.responseText.strip()){case"OK":eT.hide_error();return eT.notify_resent();case"UNREACHABLE":return ab.error(error_unreachable(true));case"BADCARRIER":return ab.error(error_bad_carrier());case"INVALIDNUMBER":return eT.show_error_invalid_number();case"NOTAMOBILE":return ab.error(error_not_a_mobile());case"RATELIMIT":return ab.error(ef("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}}})(this),onFailure:(function(eT){return function(eU){return ab.error(eT.error500())}})(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(T){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(eT){return function(eU){switch(eU.responseText.strip()){case"OK":eT.hide_error();return eT.notify_resent();case"UNREACHABLE":return eT.show_error_unreachable();case"BADCARRIER":return eT.show_error_bad_carrier();case"INVALIDNUMBER":return eT.show_error_invalid_number();case"NOTAMOBILE":return eT.show_error_not_a_mobile();case"RATELIMIT":return ab.error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":eT._current_flow.to_state("password");return eT.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:ef("Enable two-step verification"),DEFAULT_EDIT_TITLE:ef("Edit two-step verification"),DEFAULT_DISABLE_TITLE:ef("Disable two-step verification"),ADD_BACKUP_TITLE:ef("Add a backup phone number"),EDIT_BACKUP_TITLE:ef("Edit backup phone number"),EDIT_RECOVERY_TITLE:ef("View recovery code"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var T;this.hide_error();br("#twofactor-recovery").removeClass("edit-mode");T=$("twofactor-enter-password");br("#password",T).val("").focus();return false},submit_password:function(eU,eX,T,eV,eW){var eT;eT=$("password").getValue();if(!eT){this.show_error(ef("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(eU,{parameters:{password:eT},onSuccess:(function(eY){return function(eZ){var e0;e0=eZ.responseText.strip();if(e0.startsWith("OK:")){eY._checkpoint_token=e0.substr(3);return eX(T,eV)}else{switch(e0){case"EXPIRED_PASSWORD":return eY.show_error_expired_password();case"INVALID":return eY.show_error(ef("Invalid password"));case"RATELIMIT":return eY.show_error(ef("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");ab.success(ef("Two-step verification is already enabled. Did you maybe enable it in another window?"));return eM.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ab.success(ef("Two-step verification is already disabled. Did you maybe disable it in another window?"));return eM.hide()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(T,eT){this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:(function(eU){return function(eV){var eW;eW=eV.responseText.strip();if(eW.startsWith("OK:")){eU.fill_key(eW.substr(3));return eT.next()}else{switch(eW){case"EXPIRED":T.to_state("password");return eU.show_error_expired()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(eT){var T,eV,eU;eT=eT.replace(new RegExp("=+$"),"");T=eT.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(T);$("qr-div").__date();eU=Constants.IS_PROD?"Dropbox":"DropboxDev";eV={text:"otpauth://totp/"+eU+":"+this._user.email+"?secret="+eT+"&issuer="+eU,width:200,height:200};if(!Modernizr.canvas){eV.render="table"}br("#qr-div").qrcode(eV);if(!Modernizr.canvas){return br("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(eT,eV,eW){var T,eU;T=br("#twofactor-enter-phone .twofactor-phone-number");if(!T.controller().validate_on_submit()){return}eU=T.val();this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:eU},onSuccess:(function(eX){return function(eY){switch(eY.responseText.strip()){case"OK":eX._phone_number=eU;eT.vars.phone_number=eU;return eV.next();case"EXPIRED":eT.to_state("password");return eX.show_error_expired();case"UNREACHABLE":return eX.show_error_unreachable(T);case"BADCARRIER":return eX.show_error_bad_carrier(T);case"INVALIDNUMBER":return eX.show_error_invalid_number(T);case"NOTAMOBILE":return eX.show_error_not_a_mobile(T);case"RATELIMIT":return eX.show_error(ef("You've added too many phone numbers. Please try again in a few minutes."))}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},submit_phone_code:function(T,eT,eV){var eU;eU=$("phone-code").getValue().strip();if(!eU){this.show_error(ef("Please enter the security code"));return}if(eU.search(/^\d{6}$/)===-1){this.show_error(ef("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:eU},onSuccess:(function(eW){return function(eX){var eZ,eY;eY=eX.responseText.strip();if(eY.startsWith("OK:")){eW.fill_recovery_code(eY.substr(3),"backup-code-div");return eT.next()}else{switch(eY){case"INVALID":eW._invalid_code_count+=1;eZ=eW._invalid_code_count<=2?ef("Invalid code"):eW._is_offline_setup?ef("Invalid code. Check the clock on your phone: it must be accurate to the minute."):ef("Invalid code");return eW.show_error(eZ);case"EXPIRED":T.to_state("password");return eW.show_error_expired();case"RATELIMIT":return eW.show_error(ef("Too many invalid codes. Try again in a few minutes."))}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(eV,eT){var eU,T;this.hide_error();eU=$("twofactor-enter-backup-phone");T=this.fill_phone_number_for_edit(eU,br("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());T.focus();if(eV==="back_next"){br("#twofactor-backup-back-next").show();br("#twofactor-backup-cancel-save").hide();return br("#twofactor-backup-back-save").hide()}else{if(eV==="cancel_save"){br("#twofactor-backup-back-next").hide();br("#twofactor-backup-cancel-save").show();return br("#twofactor-backup-back-save").hide()}else{if(eV==="back_save"){br("#twofactor-backup-back-next").hide();br("#twofactor-backup-cancel-save").hide();return br("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(eW,eV,eT,eX,eY){var T,eU;T=br("#twofactor-enter-backup-phone .twofactor-backup-phone-number");if(!T.controller().validate_on_blur()){return}eU=T.val();if(eU){if(this.is_primary_number(eU)){T.controller().show_error(ef("You can't use your primary phone as your backup",T));return}}else{if(eW){T.controller().show_error(ef("Please enter phone number",T));return}}this._backup_phone=eU;if(eV==="save_backup_phone"){this.save_added_backup_phone(eT,eW,eU)}else{if(eV==="save_everything"){this.submit_finish(eT,eX,eY)}else{if(eV==="save_none"){return eX.next()}}}},is_same_phone_number:function(eT,T){if(!eT||!T){return false}return eT.replace(/\D+/g,"")===T.replace(/\D+/g,"")},is_primary_number:function(T){var eT;eT=br("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this.is_same_phone_number(T,eT.data("primary_phone"))){return true}if(this.is_same_phone_number(T,br("#twofactor-sms-number",eT).text())){return true}return false},save_added_backup_phone:function(T,eU,eT){this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:eT},onSuccess:(function(eV){return function(eW){var eX;switch(eW.responseText.strip()){case"OK":eV.hide_error();eX="#twofactor-row-"+eV._user.role;br(""+eX+" #twofactor-backup-number").text(eT);br(eX).toggleClass("with-backup",!!eT);if(!eT){ab.success(ef("Backup phone number removed"))}else{if(!eU){ab.success(ef("Backup phone number updated"))}else{ab.success(ef("Backup phone number added"))}}return eM.hide();case"EXPIRED":T.to_state("password");return eV.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(eV,eX){var eW,eT,eU,T;eT=br(".sick-input > input",eV);if(!eX){return eT.val("")}T=br('select[name="country_code"]',eV);eW=/^\+\d+/.exec(eX);eW=eW?eW[0]:"";eU=this.option_for_country_code(T,eW);if(eU!=null){eU.selected=true}eT.val(br.trim(eX.slice(eW.length)));if(eT.length){eT[0].select()}return eT},option_for_country_code:function(T,eU){var eT;if(eU){eT=br('option[value="'+eU+'"]',T);if(eT.length>1){eT=eT.filter("[selected]")}if(eT.length){return eT[0]}}return br("option[selected]",T)[0]},fill_delivery_choice:function(T){br("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!T);br("#twofactor-delivery-offline-label").toggle(!T);br("#confirm-phone-primary-number").text(T);return br("#twofactor-row-"+this._user.role).data("primary_phone",T)},fill_backup_phone:function(T){br("#confirm-phone-backup").toggle(!!T);return br("#confirm-phone-backup-number").text(T)},fill_recovery_code:function(eT,T){eT=eT.toLowerCase().replace(/(.{4})/g,"$1 ");return $(T).__date(eT)},submit_finish:function(T,eT,eU){var eV;this.show_loading();eV={checkpoint_token:this._checkpoint_token};if(this._backup_phone){eV.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:eV,onSuccess:(function(eW){return function(eX){switch(eX.responseText.strip()){case"OK":eW.successfully_enabled=true;if(T.vars.mode!=="ENABLE"){return eW.after_enabled(T,eT)}else{return eT.next()}break;case"EXPIRED":T.to_state("password");return eW.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(eT,eU){var T;this._checkpoint_token=null;this.hide_error();T=br("#twofactor-row-"+this._user.role);T.toggleClass("with-sms",!!this._phone_number);br("#twofactor-sms-number",T).text(this._phone_number||"");T.toggleClass("with-backup",!!this._backup_phone);br("#twofactor-backup-number",T).text(this._backup_phone||"");T.addClass("twofactor-enabled");if(eT.vars.mode!=="ENABLE"){ab.success(ef("Two-step verification updated"));return eU!=null?eU.next():void 0}},disable_submit:function(T,eT){this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:(function(eU){return function(eW){var eV;switch(eW.responseText.strip()){case"OK":eU.successfully_disabled=true;eU._checkpoint_token=null;eV=br("#twofactor-row-"+eU._user.role);eV.removeClass("twofactor-enabled with-sms with-backup");br("#twofactor-sms-number, #twofactor-backup-number",eV).text("");ab.success(ef("Two-step verification is now disabled."));return eT.next();case"EXPIRED":T.to_state("password");return eU.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(eU,T){var eT;if(T){T.controller().show_error(eU);return}eT=$$(this._error_selector);if(eU===this.error_expired_password()||eU===this.error_unreachable(true)){eT.invoke("update",eU)}else{eT.invoke("__date",eU)}return eT.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(T){return this.show_error(this.error_bad_carrier(),T)},show_error_invalid_number:function(T){return this.show_error(this.error_invalid_number(),T)},show_error_not_a_mobile:function(T){return this.show_error(this.error_not_a_mobile(),T)},show_error_unreachable:function(T,eT){if(eT==null){eT=false}return this.show_error(this.error_unreachable(eT),T)},show_error_expired:function(T){return this.show_error(this.error_expired(),T)},show_error_expired_password:function(T){return this.show_error(this.error_expired_password(),T)},error_500:function(){return ef("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return ef("Unfortunately, your carrier is not supported at this time.")},error_invalid_number:function(){return ef("That is not a valid phone number.")},error_not_a_mobile:function(){return ef("That phone number does not appear to be a valid mobile number.")},error_unreachable:function(T){if(T==null){T=false}if(T){return ef('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return ef("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return ef("Since it's been a while, please enter your password again.")},error_expired_password:function(){return ef('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return ab.success(ef("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(eT){var T,eU;T=eT.element();eU=br(".sick-input",T.form);br("input",eU).val("").focus();return this.fill_example_phone_number(T,eU)},fill_example_phone_number:function(T,eV){var eU,eT;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){eU=br(T).val().substr(1);eT=phone_helpers.get_example_mobile_number(eU);return br("label",eV).text(ef("Example: ")+eT)}},reset_phone_field_and_backup_country:function(eT){var T;this.reset_phone_field(eT);if(br("#backup-phone-number").val()===""){T=br("#twofactor-enter-backup-phone #country-code");T.val(eT.element().getValue());return this.fill_example_phone_number(T,br(".sick-input",T[0].form))}}};var bX;bX=B.PseudoLocalStorage={_store:{},getItem:function(T){return this._store[T]},setItem:function(T,eT){return this._store[T]=eT},removeItem:function(T){return delete this._store[T]},clear:function(){return this._store={}}};var bH,bx=[].indexOf||function(eU){for(var eT=0,T=this.length;eT<T;eT++){if(eT in this&&this[eT]===eU){return eT}}return -1};bH=B.FileViewRamsCommon={RAMS_FULLSCREEN_TRANSITION_TIME_MSEC:1000,_PDF_PREVIEW_DOMAINS:["dl-doc.dropbox.com","dl-web.dropbox.com","dl.dropboxusercontent.com","dl-doc.dropboxusercontent.com"],_DEV_DOMAIN_SUFFIX:".dev.corp.dropbox.com",enter_rams_fullscreen:function(T){T.addClass("rams-fullscreen").data("rams-fullscreen",true);return br(window).resize()},exit_rams_fullscreen:function(T){T.removeClass("rams-fullscreen").removeData("rams-fullscreen");return br(window).resize()},is_rams_fullscreen_active:function(eT){var T;T=eT.data("rams-fullscreen");return(T!=null)&&T},_isPdfPreviewDomain:function(T){T=T.toLowerCase();return bx.call(this._PDF_PREVIEW_DOMAINS,T)>=0||T.endsWith(this._DEV_DOMAIN_SUFFIX)},_supportsNativePrinting:function(T){return T.attr("data-docpreview-pdf-native-print-enabled")==="True"},getNativePrintUrl:function(eU,T,eT){var eV;if(!this._supportsNativePrinting(eT)){return null}if(!this._isPdfPreviewDomain(T)){console.warn("Blocked attempt to load pdf native print for unexpected domain");return null}eV=D.parse("https://"+T+"/nativeprint");eV.updateQuery({file:eU});return eV.toString()}};var l;l=__PARENT_SCOPE__.FileViewer=INLINE_JS.FileViewer=B.FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,MAX_CHECK_LOCK_TRIES:8,MAX_GIF_FILE_SIZE_B:80*1024*1024,_FADE_MSEC:300,file:null,has_preview:false,preview_locked:false,preview_lock_listener:null,modal_type:this._MODAL_FILEINFO,is_loaded:false,has_key_listener:false,history_length:null,preview_status_timeout_obj:null,preview_status_request:null,_non_fullscreen_vert_overflow:null,hiding:false,check_lock_request:null,check_lock_timeout:null,file_locked:false,_frameMessenger:null,active_user:null,in_browse:true,globalPreviewStateModel:new Backbone.Model({state:"closed",file_obj:null}),globalOpenWithWebButtonStateModel:new Backbone.Model({state:"hidden",file_extension:null}),_get_extension:function(eT){var T;T=eT.lastIndexOf(".");return(T===-1?"":eT.substr(T+1))},show:function(eW,eY,e0,eV,eT,eU){var eZ,eX,T;if(eV==null){eV=false}if(eT==null){eT=[]}if(eU==null){eU=false}T=br("#file-viewer");if(this.hiding){T.finish()}else{if(this.shown()){this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);return}else{T.hide()}}this.file=eW;this.active_user=eY;this.in_browse=e0;this.flippable_files=this._filterFlippableFiles(eT);this.from_shared_link=eU;this._start_time=Date.now();this.history_length=window.history.length;if(this.file.preview_type==="download"){window.location.href=this.file.href}else{z.scroll_lock_document();T.css("pointer-events","").fadeIn(this._FADE_MSEC);eZ=br(".left-flip-button");eZ.off("click");eZ.on("click",(function(e1){return function(){return e1.loadPreviousFlippable()}})(this));eX=br(".right-flip-button");eX.off("click");eX.on("click",(function(e1){return function(){return e1.loadNextFlippable()}})(this));return this.load(this.file,eV)}},load:function(eT,eU){var T;if(eU==null){eU=false}this.file=eT;document.title=this.file.filename;T=br("#file-viewer");if(T.data("is-openwith-allowed")==="True"){if(__CONDITIONAL_JS__.OpenWith.file_supported(this.file)){if(eU){this.file_locked=false}else{this.file_locked=true;this.check_lock()}}}this._render_viewer();return br("#file-viewer").trigger("db:filepreview:open",[this.file,this.from_shared_link,this.active_user.id])},_isFlippable:function(T){var eT;return(eT=T.preview_type)==="photo"||eT==="video"},_filterFlippableFiles:function(eT){var T;return(function(){var eW,eV,eU;eU=[];for(eW=0,eV=eT.length;eW<eV;eW++){T=eT[eW];if(this._isFlippable(T)){eU.push(T)}}return eU}).call(this)},currentFlippableFileIndex:function(){var eU,eT,eW,T,eV;eV=this.flippable_files;for(eT=eW=0,T=eV.length;eW<T;eT=++eW){eU=eV[eT];if(this.file.sjid===eU.sjid){return eT}}return -1},cancel_check_lock:function(){this.file_locked=false;if(this.check_lock_request!=null){this.check_lock_request.abort();this.check_lock_request=null}if(this.check_lock_timeout!=null){clearTimeout(this.check_lock_timeout);return this.check_lock_timeout=null}},check_lock:function(){var eV,eU,eY,T,eZ,eW,eT,eX;if(this.check_lock_request!=null){return}this.check_lock_timeout=null;eV=0;T=this.active_user.id;eY=this.file.fq_path;eU=1000;eX=(function(e0){return function(){eV++;if(eV<e0.MAX_CHECK_LOCK_TRIES){if(eV===2){INLINE_JS.Notify.warning(ef("Office Online is saving your file."))}else{if(eV===5){INLINE_JS.Notify.warning(ef("Office Online is taking longer than expected to save. Your changes are safe and will eventually be saved to Dropbox."))}}e0.check_lock_timeout=setTimeout(eZ,eU);return eU=eU*2}else{clearTimeout(e0.check_lock_timeout);e0.check_lock_request=null;e0.file_locked=false;return e0._render_preview(true,true)}}})(this);eT=(function(e0){return function(e1){e1=JSON.parse(e1);if(e1!=null?e1.has_lock:void 0){return eX()}else{e0.check_lock_request=null;e0.file_locked=false;return e0._render_preview(true,true)}}})(this);eW=(function(e0){return function(e3,e1,e2){return eX()}})(this);eZ=(function(e0){return function(){return e0.check_lock_request=cp.WebRequest({url:"/ow/msft/check_lock",data:{user_id:T,fq_path:eY},success:eT,error:eW})}})(this);return eZ()},shown:function(){return br("#file-viewer").css("display")!=="none"},clear_preview_url_timer:function(){if(this.previewUrlTimer!=null){return clearTimeout(this.previewUrlTimer)}},set_preview_url_w_timeout:function(eT,T,eU){this.clear_preview_url_timer();return this.previewUrlTimer=setTimeout((function(eV){return function(){return eV.set_preview_url(eV.file,eV.active_user,eV.in_browse)}})(this),250)},set_preview_url:function(eT,T,eV){var eX,eW,eU;eX=D.parse(ei.get_url());eW=eX.getPath();eU=eX.removeQuery("select").updateQuery({preview:eT.filename}).getQuery();return ei.push_state(D.encode_parts(eW),eU)},unset_preview_url:function(){var eU,eT,T;this.clear_preview_url_timer();eU=D.parse(ei.get_url());if(!this.from_shared_link&&(eU.getPath().match(/^\/s[h]?\/.+/)||!this.in_browse)){return}if(!("preview" in eU.getQuery())){return}eT=eU.getPath();T=eU.removeQuery("select").removeQuery("preview").getQuery();return ei.push_state(D.encode_parts(eT),T)},render_file_failed:function(){var T,eU,eT;eU=this.file;T=this.active_user;eT=this.in_browse;this.hide();eU.doc_preview_status=Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE;this.show(eU,T,eT,!this.file_locked);br("#file-viewer").show();return br("#file-viewer").trigger("preview_failed")},_log_view:function(T,eT){var eU;eU={mode:"file-preview",file_ext:au.file_extension_for_logging(this.file.filename),preview_type:this.file.preview_type,preview_status:this.file.doc_preview_status,time_taken:T,file_bytes:this.file.bytes,is_team:this.active_user.is_team===1,paid:this.active_user.paid===1,in_progress:eT,ns_id:this.file.ns_id,sjid:this.file.sjid,user_id:this.active_user.id};return a0.UserActivityLogger.log("web","file_view",eU)},_render_viewer:function(){var eZ,eT,e2,e3,eV,e5,T,e4,e1,e6,eU,eW,e0,eY,eX;eT=br("#file-viewer");eZ=eT.find(".download-button");e3=D.parse(this.file.href).updateQuery({dl:1}).toString();e0=(function(e7){return function(fe){var fa,fc,e9,fb,fd,e8;if(fe==null){fe=true}e9=bG.em_snippet(e7.file.filename,35);fa=eT.find(".title-bar .filename");fd={"class":"icon",alt:e7.file.caption};fb=cj.html("web",e7.file.icon,fd).toHTML();fc=br("<span />",{"class":"filename-text"}).text(e9);fa.html(fb).append(fc);eT.addClass("has-preview");if(e7.file.htmlified_link){eT.addClass("htmlified-preview")}else{if(e7.file.preview_type==="excel"){eT.addClass("html-preview");eT.find(".loading").css("z-index","-1")}else{eT.addClass(""+e7.file.preview_type+"-preview")}}if(fe){eT.find(".loading").show()}eZ.on("click",function(ff){ff.preventDefault();return window.location.href=e3});if(e7.file.tkey===void 0&&l.active_user.is_email_verified){e8=function(ff){this.file.tkey=ff.tkey;return this._update_title_bar_buttons()};cp.WebRequest({url:"/sm/get_token",type:"POST",data:{path:e7.file.fq_path},dataType:"json",subject_user:e7.active_user.id,success:e8.bind(e7)})}else{e7._update_title_bar_buttons()}e7.modal_type=e7._MODAL_PREVIEW;e7._first_render_completed=false;return e7._listen()}})(this);e5=(function(e7){return function(){eT.removeClass();eT.find(".loading").hide();return e7._unlisten()}})(this);eW=(function(e7){return function(e8,fd,fb,fa,e9){var fc;if(e8==null){e8=false}if(fd==null){fd=true}if(fb==null){fb=false}if(fa==null){fa=false}if(e9==null){e9=true}e7._log_view(Date.now()-e7._start_time,fa);fc=e7._get_extension(e7.file.filename);if(fc==="doc"||fc==="docx"||fc==="ppt"||fc==="pptx"||fc==="xls"||fc==="xlsx"||fc==="pdf"||fc==="eps"||fc==="ai"||fc==="psd"||fc==="svg"||fc==="txt"||fc==="rtf"||fc==="pspimage"||fc==="tif"||fc==="tiff"||fc==="yuv"||fc==="url"||fc==="webloc"||fc==="website"){e7.globalPreviewStateModel.set({state:"open",file_obj:e7.file})}if(!e8){e0(fd);e7._update_title_bar_buttons()}e7._render_preview(fb,e9);return e7._initial_resize()}})(this);eU=(function(e7){return function(e9){var e8,fb,fc,fa;if(e9==null){e9=false}e8=e7.file.filename.indexOf(".");fb=e7.file.filename.substring(e8+1);if(fb==="key"&&e7.file.preview_type===null){fa="/static/images/icons128/"+(au.file_icon("_other"))+".png"}else{fa="/static/images/icons128/"+(au.file_icon(e7.file.filename))+".png"}e7.globalPreviewStateModel.set({state:"closed",file_obj:null});fc=bG.em_snippet(e7.file.filename,20);eT.find(".title-bar .filename").text(fc);eT.addClass("no-preview");eT.find(".file-thumbnail img").attr({src:fa});eT.find(".file-type").text(fc);eT.find(".file-size").text(e7.file.size);eT.find(".file-modified").text(e7.file.ago||"");eZ.on("click",function(){return bO.redirect(e3)});e7.modal_type=e7._MODAL_FILEINFO;e7._listen();e7._log_view(Date.now()-e7._start_time,e9);e7._update_title_bar_buttons();return e7._initial_resize()}})(this);eV=this._get_extension(this.file.filename);e6=((eX=this.file.preview_type)==="doc"||eX==="excel"||eX==="keynote"||eX==="adobecs"||eX==="linkfile")&&(this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B||au.file_extension(this.file.filename).toLowerCase()!=="pdf")&&!bO.msie_version_at_most(9);this.has_preview=(this._is_zoomzoom_ui()&&this.file.preview_type==="photo")||(this._is_zoomzoom_ui()&&this.file.preview_type==="video")||(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(this.file.preview_type==="linkfile")||(e6&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE&&!this.file_locked);T=e6&&this._preview_progressive_try(eV)&&this.file.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE&&!this.file_locked;if(this.has_preview||T){return eW(false,!(this.file.preview_type==="doc"),false,false,this.has_preview)}e4=this.file_locked||(e6&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS);if(!e4){return eU()}e0();e1=D({path:"/doc_preview_status"+this.file.fq_path}).toString();eY=Date.now();return(e2=(function(e7){return function(){var e8;e8=Date.now();if(e8-eY>=5000){setTimeout(br.proxy(e7.render_file_failed,e7),0);return}return e7.preview_status_request=br.ajax(e1,{success:function(e9){if(e7.file){return e7.file.doc_preview_status=parseInt(e9,10)}},complete:function(e9,fa){if(fa==="abort"){return}if(e7.file_locked){return}if(e7.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){e7.has_preview=true;return eW(true,false,true,true)}else{if(e7.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return e7.preview_status_timeout_obj=setTimeout(e2,1000)}else{e7.render_file_failed()}}},timeout:5000-(e8-eY),subject_user:e7.active_user})}})(this))()},_remove_loading:function(T){var eT;if(T==null){T=true}eT=br("#file-viewer .loading");eT.hide();eT.css("z-index","");return this.is_loaded=T},_render_blank:function(){var eT,T;eT=br("#file-viewer .preview-content-container");T=dg.createElement(E,{icon:this.file.icon,filename:this.file.filename,created:new Date(this.file.ts*1000),size:this.file.size});return dg.render(T,eT.get(0))},_render_linkfile:function(){var eT,T;eT=br("#file-viewer .preview-content-container");T=dg.createElement(P,{});return dg.render(T,eT.get(0))},_update_title_bar_buttons:function(){var eU,eT,eY,e7,e3,eX,fb,eZ,e0,eW,eV,T,e5,e9,fa,e6,e8,fc,e2,e4,e1;eX=br("#file-viewer");e3=eX.find(".share-button");if(this.from_shared_link){e3.remove()}eU=eX.find(".download-button");eT=eX.find(".split-button.openwith");e7=eT!=null?eT.find(".main-button"):void 0;eY=eT!=null?eT.find(".more-button"):void 0;fb=ef("Open",{comment:"Open a file natively on the user's computer"});e4=function(){return eX.data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)};e2=(function(fd){return function(ff){var fg,fe;return eX.data("is-openwith-allowed")==="True"&&((fg=__CONDITIONAL_JS__.OpenWith)!=null?fg.get_open_handler_for(ff,fd.active_user):void 0)&&ff.bytes<((fe=__CONDITIONAL_JS__.OpenWith)!=null?fe.MAX_SUPPORTED_FILE_SIZE_B:void 0)&&ff.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_PROTECTED_DOC}})(this);e9=(function(fd){return function(){return __CONDITIONAL_JS__.UnityFeatures.open_file(fd.file.ns_id,fd.file.ns_path,fd.file.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fe){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})}})(this);fa=(function(fd){return function(){var ff,fe,fg;ff=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fd.file,fd.active_user);if(ff){if((fg=__CONDITIONAL_JS__.OpenWithMicrosoftLogger)!=null){fg.log_open_button_pressed(fd.active_user.id,au.file_extension(fd.file.filename).toLowerCase(),fd.file.ns_id,fd.file.ns_path)}fe=ff.uri+"?hpt_click_ts="+Date.now();return bO.redirect(fe)}}})(this);fc=(function(fd){return function(ff,fe,fj){var fg,fh,fi;if(!ff&&!fe){e6(false)}else{if(ff&&fe){eV(fb,fd.file,e9,fa)}else{if(ff){eW(fb,fa)}else{eW(fb,e9)}}}if(!ff&&!fe){fh=false}else{if(fe){fh=false}else{fh=true}}if(!fh&&!fj){fd._hide_more_button()}else{fd._show_more_button(fj,fh)}fg=function(fk,fm,fn,fl){if(fd._open_button_update_state_timeout){clearTimeout(fd._open_button_update_state_timeout)}return fd._open_button_update_state_timeout=setTimeout((function(){fd.globalOpenWithWebButtonStateModel.set({user_id:fk,state:fm,file_extension:fn,target_button:fl});return fd._open_button_update_state_timeout=null}),200)};if(ff){fi=au.file_extension(fd.file.filename).toLowerCase();if(fe){return fg(fd.active_user.id,"visible",fi,eY)}else{return fg(fd.active_user.id,"visible",fi,e7)}}else{return fg(null,"hidden",null,null)}}})(this);e6=function(fd){if(eT!=null){eT.toggleClass("shown",fd)}return eU.toggle(!fd)};eW=function(fd,fe){if((eT==null)&&(e7==null)){return}e6(true);eT.removeClass("split");e7.text(fd);return e7.off("click").on("click",fe)};eV=(function(fd){return function(fj,fe,fi,fh){var fg,ff;if((eT==null)&&(e7==null)&&(eY==null)){return}e6(true);eT.addClass("split");e7.text(fj);fg=eX.find(".openwith-dropdown");e7.off("click").on("click",function(fk){return fi(fk)});eY.off("click").on("click",function(fl){var fk;fk=br(this).parent().siblings(".openwith-dropdown");if(fk.is(":visible")){return}ex.show(fk,this,null,true);return fl.stopPropagation()});fg.find(".openwith-desktop-link").off("click").on("click",function(fk){fk.preventDefault();return fi(fk)});ff=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fe,fd.active_user);fg.each(function(){return cj.src(br(this).find(".openwith-link .sprite")[0],"web",ff.icon)});fg.find(".openwith-link .sprite-text-inner").text(ff.name);fg.find(".openwith-link").off("click").on("click",function(fk){fk.preventDefault();return fh(fk)});return br("#file-viewer-container").off("click",ex.hide_all).on("click",ex.hide_all)}})(this);e8=!!e4();eZ=!!e2(this.file);e0=!!this.file.tkey;fc(eZ,false,e0);if(e8){T=(function(fd){return function(){return fc(eZ,true,e0)}})(this);if((e1=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?e1.is_cached_and_locally_available(this.file.ns_id,this.file.ns_path):void 0){return T()}else{e5=(function(fd){return function(fe){if(fe.is_locally_available){return T()}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.file.ns_id,this.file.ns_path,this.file.user_id,e5)}}},_show_more_button:function(eY,eT){var eW,eX,eU,eV,T;T=br("#file-viewer");eW=T.find(".more-options-button");eW.show();eU=T.find(".more-options-dropdown");eW.on("click",(function(eZ){return function(e0){if(eU.is(":visible")){return}ex.show(eU,eW,null,true);return e0.stopPropagation()}})(this));br("#file-viewer-container").on("click",ex.hide_all);eV=eU.find(".remove-link");eV.off("click");if(eY){eV.show();eV.on("click",(function(eZ){return function(e0){ex.hide_all();return ag.confirm_remove(eZ.file.filename,eZ.file.tkey,0,0,0,eZ.file.user_id)}})(this))}else{eV.hide()}eX=eU.find(".download-button");return eX.toggle(eT)},_hide_more_button:function(){var eT,T;T=br("#file-viewer");eT=T.find(".more-options-button");eT.off("click").hide();br("#file-viewer-container").off("click",ex.hide_all);return T.find(".remove-link").off("click")},_initial_resize:function(){var T;if(this.is_loaded){return}T=function(){return br("window").trigger("resize")};return setTimeout(T,0)},_get_progressive_url:function(eW,eV){var eX,T,eU,eT;eT=this.active_user;eW=eW.substring(0,3).replace("rtf","doc").replace("pps","ppt");eU=D.parse(eV);T=false;if((eW==="doc"&&eT.progressive_previews_doc)||(eW==="key")||(eW==="keynote")||(eW==="adobecs")){if(!(Constants.PDF_PREVIEW_MODE==="pdf-js")){eU=eU.updateQuery({post_message_on_failure:1})}}else{if(eW==="ppt"&&eT.progressive_previews_ppt){eX="private_progressive_viewer";T=true}else{if(eW==="xls"&&eT.progressive_previews_xls){if(eT.xls_edit){eX="xls/edit"}else{eX="xls/preview"}}}}if(eX){if(T){eU.setAuthority(Constants.WEBSERVER)}else{eU.setAuthority(eU.getAuthority().replace("dl-web","dl-doc"))}eU.setPath(eU.getPath().replace("/get/","/"+eX+"/"))}eU=eU.updateQuery({get_preview:1,rams_ui:this._is_rams_ui()?1:0});return eU},_get_pdf_js_url:function(T){var eT;if(Constants.PDF_PREVIEW_MODE==="pdf-js"){eT=T.toString();T=D.parse(Constants.static_url_pdfjs_viewer);T.setQuery({file:eT})}return T},_preview_is_progressive:function(eT){var T;eT=eT.substring(0,3).replace("rtf","doc").replace("pps","ppt");T=this.active_user;return(eT==="doc"&&T.progressive_previews_doc)||(eT==="ppt"&&T.progressive_previews_ppt)||(eT==="xls"&&T.progressive_previews_xls)||(eT==="key"||eT==="keynote")||(eT==="eps"||eT==="ai")},_preview_progressive_try:function(eT){var eU,T;if(!this._preview_is_progressive(eT)){return false}if(this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return true}eT=eT.substring(0,3).replace("rtf","doc").replace("pps","ppt");eU=this.file.doc_preview_status===Constants.DOC_PREVIEW_UNAVAILABLE_FAILED&&((eT==="ppt"&&this.active_user.progressive_previews_ppt_try_failed)||(eT==="doc"&&this.active_user.progressive_previews_doc_try_failed)||(eT==="xls"&&this.active_user.progressive_previews_xls_try_failed)||(eT==="eps"||eT==="ai"));T=eT==="key"||eT==="keynote";return eU||T},_set_previews_sandbox_params:function(eT,T){eT=eT.substring(0,3).replace("rtf","doc").replace("pps","ppt");if(eT!=="xls"){return""}else{return null}},_render_preview:function(e6,e4){var e8,eV,T,eU,e5,e1,e7,eX,e3,eW,e2,e9,eT,e0,eZ,eY;if(e6==null){e6=false}if(e4==null){e4=true}if(e6){this._remove_loading(false)}e2=br("#file-viewer .preview-content-container");if(e2.find("iframe").length>0){return}T=this.currentFlippableFileIndex();e8=br(".left-flip-button");eV=br(".right-flip-button");if(T>=0&&this.flippable_files.length>1){e8.toggle(T>0);eV.toggle((T+1)<this.flippable_files.length)}else{e8.hide();eV.hide()}if(this.file.htmlified_link){eX=br("<iframe/>",{src:this.file.htmlified_link});e2.append(eX);return eX.on("load",this._remove_loading)}else{if(this.file.preview_type==="doc"){eU=this._get_extension(this.file.filename);eT=this._get_progressive_url(eU,this.file.href);eU=eU.substring(0,3).replace("rtf","doc").replace("pps","ppt");if(eU==="ppt"){eX=br("<iframe/>",{src:eT.toString(),allowfullscreen:"",type:"application/pdf"});e2.append(eX)}else{if(this.active_user.inline_commenting){br("#file-viewer-container").css({marginLeft:"0",width:"90%",left:"5%"});eT.setAuthority(eT.getAuthority().replace("dl-web","dl-doc"));eT.setPath(eT.getPath().replace("/get/","/dochax_private_commentless_preview/"));e1=eT.toString();eT=D.parse(Constants.static_url_pdfjs_hack_viewer);eT.setQuery({file:e1})}else{if(!e4){eT=eT.updateQuery({generate_preview:1});eT.setAuthority(eT.getAuthority().replace("dl-web","dl-doc"))}eT=this._get_pdf_js_url(eT)}eT=eT.updateQuery(Constants.UID_PARAM_NAME,this.active_user);if(this._is_annotation_marker_enabled()){eT=eT.updateQuery("annotation_marker","1")}eX=br("<iframe/>",{src:String(eT),type:"application/pdf"});e2.append(eX)}return eX.on("load",this._remove_loading)}else{if(this.file.preview_type==="html"){eX=br("<iframe/>",{src:this.file.href,sandbox:""});e2.append(eX);return eX.on("load",this._remove_loading)}else{if(this.file.preview_type==="excel"){eT=this._get_progressive_url("xls",this.file.href);eX=br("<iframe/>",{src:eT,type:"application/pdf"});this._set_previews_sandbox_params("xls",eX);e2.append(eX);return eX.on("load",this._remove_loading)}else{if(this.file.preview_type==="keynote"){eT=this._get_progressive_url("html",this.file.href);eT=eT.updateQuery({generate_preview:1});eT=eT.updateQuery({post_message_on_failure:1});eX=br("<iframe/>",{src:eT,type:"text/html"});e2.append(eX);return eX.on("load",this._remove_loading)}else{if(this.file.preview_type==="adobecs"){eT=this._get_progressive_url("adobecs",this.file.href);eT=eT.updateQuery({generate_preview:1});eT=this._get_pdf_js_url(eT);eZ=String(eT.updateQuery(Constants.UID_PARAM_NAME,this.active_user));eX=br("<iframe/>",{src:eZ,type:"application/pdf"});e2.append(eX);return eX.on("load",this._remove_loading)}else{if(this.file.preview_type==="linkfile"){this._remove_loading();return this._render_linkfile()}else{if(this._is_zoomzoom_ui()){if((eY=this.file.preview_type)==="photo"||eY==="video"){dg.unmountComponentAtNode(e2.get(0));br("#file-viewer .loading").css("z-index","1");e9=(function(){var fc,fb,fa;if(this.file.preview_type==="photo"){e3=[];fa=[1,2,3,4,5,6,-1,-2];for(fc=0,fb=fa.length;fc<fb;fc++){e7=fa[fc];eW=T+e7;if(0<=eW&&eW<this.flippable_files.length){e3.push(this.flippable_files[eW].thumbnail_url_tmpl)}}e5=this._get_extension(this.file.filename);if(e5==="gif"&&this.file.bytes>this.MAX_GIF_FILE_SIZE_B){this._remove_loading();return dg.createElement(E,{icon:this.file.icon,filename:this.file.filename,created:new Date(this.file.ts*1000),size:this.file.size})}else{if(e5==="gif"){e0=this.file.href}else{e0=this.file.thumbnail_url_tmpl}return dg.createElement(u,{"thumbnail-url-tmpl":e0,imagesToPreload:e3,onLoad:(function(fd){return function(){fd._remove_loading()}})(this),onError:(function(fd){return function(){fd._remove_loading();fd._render_blank()}})(this)})}}else{if(this.file.preview_type==="video"){return dg.createElement(d0,{"preview-url":this.file.video_transcode_url(),"thumbnail-url-tmpl":this.file.thumbnail_url_tmpl,onLoad:(function(fd){return function(){fd._remove_loading()}})(this)})}}}).call(this);return dg.render(e9,e2.get(0))}}}}}}}}}},post_preview_message:function(e0){var eZ,eW,eX,e1,eT,T,eV,eY,eU;eX=br("#file-viewer .preview-content-container iframe");eU=[];for(eV=0,eY=eX.length;eV<eY;eV++){eW=eX[eV];T=eW.src;eT="://";e1=T.indexOf(eT);if(e1===-1){eZ=T.indexOf("/")}else{eZ=T.indexOf("/",e1+eT.length)}if(eZ!==-1){T=T.substring(0,eZ)}eU.push(eW.contentWindow.postMessage(e0,T))}return eU},notify_preview_sfj:function(){if(this.file_locked){this.cancel_check_lock();this._render_preview(true,false)}return l.post_preview_message('{"action":"notify_sfj"}')},loadPreviousFlippable:function(){if(this._isFlippable(this.file)&&this.currentFlippableFileIndex()>0){this.load(this.flippable_files[this.currentFlippableFileIndex()-1]);this.set_preview_url(this.file,this.active_user,this.in_browse);return br("#file-viewer").trigger("db:filepreview:prev",[this.file,this.from_shared_link,this.active_user.id])}},loadNextFlippable:function(){if(this._isFlippable(this.file)&&this.currentFlippableFileIndex()<this.flippable_files.length-1){this.load(this.flippable_files[this.currentFlippableFileIndex()+1]);this.set_preview_url(this.file,this.active_user,this.in_browse);return br("#file-viewer").trigger("db:filepreview:next",[this.file,this.from_shared_link,this.active_user.id])}},_listen:function(){var eT,T,eU;eT=br("#file-viewer");eT.on("click",br.proxy(this._hide,this));eT.find("#file-viewer-container").on("click",function(eV){return eV.stopPropagation()});eT.find(".js-close-button").on("click",br.proxy(this._on_close,this));if(this.in_browse){this.sfj_callback_handle=cf.add_subscribe_sfj_callback(l.notify_preview_sfj.bind(this))}if(!this.has_key_listener){key("esc",this.KEY_SCOPE,(function(eV){return function(eW){if(eV.is_rams_fullscreen_active()){return}return eV._hide()}})(this));key("left",this.KEY_SCOPE,(function(eV){return function(eW){return eV.loadPreviousFlippable()}})(this));key("right",this.KEY_SCOPE,(function(eV){return function(eW){return eV.loadNextFlippable()}})(this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){eT.find(".share-button").on("click",br.proxy(this._share,this));eU=(function(eV){return function(eW){if(eV.file.fq_path.toLowerCase()===eW.memo.fq_path.toLowerCase()){eV.file.tkey=eW.memo.tkey;return eV._update_title_bar_buttons()}}})(this);T=(function(eV){return function(eW){if(eV.file.tkey===eW.memo.token){eV.file.tkey=null;return eV._update_title_bar_buttons()}}})(this);this.share_link_callback=eU.bind(this);this.remove_link_callback=T.bind(this);document.observe(aB.LINKS_ADD,this.share_link_callback);document.observe(aB.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){eT.find(".share-button").on("click",br.proxy(this._share,this))}}br(window).on("resize",br.proxy(this._resize,this));this.handleMessageFromChild=function(eV){switch(eV.action){case"failed":return l.render_file_failed();case"lock_preview":return l.preview_locked=true;case"unlock_preview":return l.preview_locked=false;case"toggle_preview_lock":return l.preview_locked=!l.preview_locked;case"hide_iframe":return l._hide();case"loaded":return l.post_preview_message('{"action":"listening_sfj"}');case"pagerendered":return l._handle_page_rendered(eV.parameters.stats)}};this._frameMessenger=new ea();this._frameMessenger.configureChildMessaging(".preview-content-container > iframe",br.proxy(this.handleMessageFromChild,this),["failed","lock_preview","unlock_preview","toggle_preview_lock","hide_iframe","loaded","pagerendered"]);this._frameMessenger.startListening();return window.onbeforeunload=function(eV){if(l.preview_locked){return""}else{return void 0}}},_unlisten:function(){var T;T=br("#file-viewer");T.off("click",br.proxy(this._hide,this));T.find("#file-viewer-container").off("click",function(eT){return eT.stopPropagation()});T.find(".js-close-button").off("click",br.proxy(this._on_close,this));if(this.modal_type===this._MODAL_PREVIEW){T.find(".share-button").off("click",br.proxy(this._share,this));T.find(".download-button").off("click");br(document).off("click",ex.hide_all);document.stopObserving(aB.LINKS_ADD,this.share_link_callback);document.stopObserving(aB.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){T.find(".share-button").off("click",br.proxy(this._share,this))}}br(window).off("resize",br.proxy(this._resize,this));key.setScope(this.prev_scope);if(this.in_browse){cf.remove_sfj_callback(this.sfj_callback_handle);return this.sfj_callback_handle=null}},_resize:function(eU){var eT,T;if(!this._is_rams_ui()){eT=br("#file-viewer");T=eT.find("#file-viewer-container").height()-(eT.find(".title-bar").height()+1);eT.find(".preview").height(T);return eT.trigger("height-resize",{height:T})}},_share:function(T){a0.ShmodelUILogger.log("via-browse-file-viewer");T.preventDefault();return new cY(this.active_user.id,this.file.fq_path,"file_viewer").show()},_on_close:function(T){T.preventDefault();return this._hide()},_hide:function(){var T;if(this.hiding){return}this.hiding=true;this.clear_preview_url_timer();this.globalPreviewStateModel.set({state:"closed",file_obj:null});if(this.preview_locked){if(!confirm("You have unsaved changes. Are you sure you want to leave this page?")){return}}if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}if(this.in_browse){eA.set_selected_files(this.file)}if(this.in_browse||this.from_shared_link){l.unset_preview_url()}z.scroll_unlock_document();T=br("#file-viewer");return T.css("pointer-events","none").fadeOut({duration:this._FADE_MSEC,always:(function(eT){return function(){var eW,eV,eU;if(eT.is_rams_fullscreen_active()){eT.exit_rams_fullscreen()}if(__CONDITIONAL_JS__.UnityFeatures!=null){eU=ef("Download");eW=T.find(".download-button");eW.text(eU);eW.off("click")}eT._hide_more_button();T.removeClass("has-preview").removeClass("no-preview");eV=T.find(".preview-content-container");dg.unmountComponentAtNode(eV.get(0));eV.empty();T.find(".file-thumbnail img").attr({src:""});T.find(".title-bar .filename").text("");T.attr({"class":""});eT._unlisten();eT._remove_loading();eT.last_file=eT.file;eT.file=null;eT.preview_locked=false;window.removeEventListener("message",eT.preview_lock_listener);eT.is_loaded=false;eT.hiding=false;eT.cancel_check_lock();T.trigger("db:filepreview:close")}})(this)})},_handle_page_rendered:function(eV){var T,eU,eW,eX,eT;if(!this._first_render_completed){T={total_time:Date.now()-this._start_time,file_ext:au.file_extension_for_logging(this.file.filename)};for(eX=0,eT=eV.length;eX<eT;eX++){eW=eV[eX];eU=(function(){switch(eW.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}})();T[eU]=eW.end-eW.start}a0.UserActivityLogger.log("web","file_view_first_page_rendered",T);return this._first_render_completed=true}},resize:function(){return this._resize(null)},hide:function(){return this._hide()},nativePdfPrint:function(){var eT,eV,T,eU;if(this.file.doc_preview_status!==Constants.DOC_PREVIEW_AVAILABLE||((eU=this.file.preview_type)!=="doc"&&eU!=="ppt"&&eU!=="adobecs")){return false}T=this._get_progressive_url("doc",this.file.href);eT=D.parse(T).getAuthority();eV=bH.getNativePrintUrl(T,eT,br("#file-viewer"));if(eV==null){return false}window.open(eV,"_blank");return true},_is_annotation_marker_enabled:function(){return br("#file-viewer").attr("data-docpreview-annotation-marker-enabled")==="True"},_is_rams_ui:function(){return br("#file-viewer").attr("data-docpreview-ui-rams-enabled")==="True"},enter_rams_fullscreen:function(){var T;bH.enter_rams_fullscreen(br(".preview"));T=br("html");this._non_fullscreen_vert_overflow=T.css("overflow-y");return T.css("overflow-y","hidden")},exit_rams_fullscreen:function(){bH.exit_rams_fullscreen(br(".preview"));br("html").css("overflow-y",this._non_fullscreen_vert_overflow);return this._non_fullscreen_vert_overflow=null},is_rams_fullscreen_active:function(){return bH.is_rams_fullscreen_active(br(".preview"))},_is_zoomzoom_ui:function(){return br("#file-viewer").attr("data-photopreview-ui-zoomzoom-enabled")}};var dG;dG=B.Index2={init:function(e0,eW){var eY,e1,eT,e2,eX,T,eV,eU,eZ;if(eW){br("#sign-in").on("click",function(e8){var e3,e6,e5,e4,e7;e8.preventDefault();e5=br("#sign-in-form");eM.show(ef("Sign in"),e5[0],false,false,416,false,"sign-in-modal");e6=e5.find("#login_email");e6.focus();return new bT(e3=e6,e7=function(){e5.find("#password-field").hide();e5.find("#remember-me").hide();e5.find("#login_submit").val(ef("Continue"));e5.find("#forgot_password_link").hide();return e5.find("#sso_description_footer").show()},e4=function(){e5.find("#password-field").show();e5.find("#remember-me").show();e5.find("#login_submit").val(ef("Sign in"));e5.find("#forgot_password_link").show();return e5.find("#sso_description_footer").hide()})})}eY=function(){if(!br("#signup-container").hasClass("form_shown")){return br.when(br("#signup-container").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){br("#signup-container").addClass("form_shown");return br("#signup-container .text-input input:visible").first().focus()})}};if(!e0){br(".register").find(".login-button").on("click",function(e3){if(!br("#signup-container").hasClass("form_shown")){e3.preventDefault();return eY()}});dG.animate()}else{br(".photo").show()}e1=function(){if(!br("#signup-container").hasClass("form_shown")){return br(".register").find(".login-button").trigger("click")}};br(".buttons .freshbutton-blue").on("click",function(e3){e3.preventDefault();br("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:e1});return false});br("#learn-more").on("click",function(e3){e3.preventDefault();br("html, body").animate({scrollTop:br("#divider").offset().top},{queue:false,duration:500});return false});if(bk.are_enabled()){a0.WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}else{ab.error(ef("Please enable browser-cookies to use the Dropbox website."))}T=["#devices-background",".register-button","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];eV=function(e3){return br(e3).on("click",function(){return a0.WebMiscActivityLogger.log("index_page",{event_name:"click",id:e3})})};for(eU=0,eZ=T.length;eU<eZ;eU++){eT=T[eU];eV(eT)}eX=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];e2={};return br(window).scroll(function(){var e9,fa,e8,e6,e5,e7,e4,e3;e3=[];for(e7=0,e4=eX.length;e7<e4;e7++){e8=eX[e7];if(br(e8).length&&!e2[e8]){fa=br(window).scrollTop();e9=fa+br(window).outerHeight();e5=br(e8).offset().top;e6=e5+br(e8).outerHeight();if(e6<=e9){a0.WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:e8});e3.push(e2[e8]=true)}else{e3.push(void 0)}}else{e3.push(void 0)}}return e3})},_animate_points:function(eY,eZ,e0,eT,e2,eX,T){var eV,eU,eW,e1;if(T==null){T=0}T=Math.min(Math.max(T,0),1);eW=eX(T);e1=[(function(){var e5,e4,e3;e3=[];for(eV=e5=0,e4=eZ.length;0<=e4?e5<e4:e5>e4;eV=0<=e4?++e5:--e5){e3.push([(function(){var e7,e6;e6=[];for(eU=e7=0;e7<2;eU=++e7){e6.push(eZ[eV][eU]+(e0[eV][eU]-eZ[eV][eU])*eW)}return e6})()])}return e3})()];eY.attr("points",dG.points_array_to_str(e1));if(T>=1){return e2.resolve()}else{return setTimeout(function(){return dG._animate_points(eY,eZ,e0,eT,e2,eX,T+(10/eT))},10)}},animate_points:function(eT,eY,eX,eU,eW,eV){var T;if(eV==null){eV=jQuery.easing.linear}T=br.Deferred();dG._animate_points(eT,eY,eX,eU,T,eV);return T.done(function(){return typeof eW==="function"?eW():void 0}).promise()},animate_hide_rects:function(eT,eX,eZ){var T,eU,eY,eW,eV;T=br.Deferred().resolve().promise();eY=function(e0){var e5,e2,e4,e1,e3;e1=br(eT[e0]);e5=dG.points_str_to_array(e1.attr("points"));e3=[e5[1],e5[1],e5[2],e5[2]];e2=dG.inverse(jQuery.easing.linear);e4=eX*(e2((e0+1)/eT.length)-e2(e0/eT.length));return T=T.then(function(){return dG.animate_points(e1,e5,e3,e4)})};for(eU=eW=0,eV=eT.length;0<=eV?eW<eV:eW>eV;eU=0<=eV?++eW:--eW){eY(eU)}return T.done(function(){return typeof eZ==="function"?eZ():void 0}).promise()},animate_delay:function(eT){var T;T=br.Deferred();setTimeout(T.resolve,eT);return T.promise()},animate:function(){return br.Deferred().resolve().promise().then(function(){return dG.animate_docs()}).then(function(){return dG.animate_graphs()}).then(function(){return dG.animate_photos()})},inverse:function(eT,T){if(T==null){T=0.000001}return function(eX){var eV,eW,eU;eW=0;eV=1;while(eV-eW>T){eU=(eW+eV)/2;if(eT(eU)<eX){eW=eU}else{eV=eU}}return eW}},points_str_to_array:function(eY){var eU,eX,eW,eT,eV,T;eV=eY.split(" ");T=[];for(eW=0,eT=eV.length;eW<eT;eW++){eX=eV[eW];T.push((function(){var e2,e0,eZ,e1;eZ=eX.split(",");e1=[];for(e2=0,e0=eZ.length;e2<e0;e2++){eU=eZ[e2];e1.push(parseFloat(eU))}return e1})())}return T},points_array_to_str:function(eT){var T;return((function(){var eW,eV,eU;eU=[];for(eW=0,eV=eT.length;eW<eV;eW++){T=eT[eW];eU.push(T.join(","))}return eU})()).join(" ")},animate_docs:function(){var eY,T,eV,eU,eX,eT,eW;eT=[[5,6],[177,1],[184,157],[13,180]];T="";for(eX=eW=0.475;eW<=0.625;eX=eW+=0.05){eY=eX+0.05;eV=[[eT[0][0]+(eT[3][0]-eT[0][0])*eX,eT[0][1]+(eT[3][1]-eT[0][1])*eX],[eT[1][0]+(eT[2][0]-eT[1][0])*eX,eT[1][1]+(eT[2][1]-eT[1][1])*eX],[eT[1][0]+(eT[2][0]-eT[1][0])*eY,eT[1][1]+(eT[2][1]-eT[1][1])*eY],[eT[0][0]+(eT[3][0]-eT[0][0])*eY,eT[0][1]+(eT[3][1]-eT[0][1])*eY]];eV=dG.points_array_to_str(eV);T+="<polygon points='"+eV+"' style='fill:#f5f9fc;stroke:none;' />"}eU=br('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+T+"\n</svg>");return br.Deferred().resolve().promise().then(function(){br(".doc, .graph, .photo").hide();br(".comp.doc").append(eU);return br(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return dG.animate_hide_rects(eU.find("polygon"),2500,function(){return eU.remove()})}).then(function(){return dG.animate_delay(500)}).then(function(){return br(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return dG.animate_delay(1500)}).then(function(){return br(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var eT,T;eT=[[83,98],[158,37],[241,77],[171,145]];T=br('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');T.find("polygon").attr("points",dG.points_array_to_str(eT));return br.Deferred().resolve().promise().then(function(){br(".doc, .graph, .photo").hide();br(".tablet.graph .graph-grid").hide();br(".tablet.graph").append(T);return br(".tablet.graph").show("fade",{},500).promise()}).then(function(){var eU;eU=[eT[0],eT[1],eT[1],eT[0]];return dG.animate_points(T.find("polygon"),eT,eU,600,function(){return T.remove()})}).then(function(){if(!bO.msie_version_at_most(8)){return br(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return dG.animate_delay(500)}).then(function(){return br(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return dG.animate_delay(2000)}).then(function(){return br(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return br.Deferred().resolve().promise().then(function(){br(".doc, .graph, .photo").hide();br(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});br(".phone.photo").show();return br.when((function(){if(!bO.msie_version_at_most(8)){return br(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return br.Deferred().resolve().promise().then(function(){return br(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return dG.animate_delay(750)}).then(function(){return br(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var dh,J,db=function(T,eT){return function(){return T.apply(eT,arguments)}},ar={}.hasOwnProperty,cA=function(eV,eT){for(var T in eT){if(ar.call(eT,T)){eV[T]=eT[T]}}function eU(){this.constructor=eV}eU.prototype=eT.prototype;eV.prototype=new eU();eV.__super__=eT.prototype;return eV};J=INLINE_JS.UserNotifier=B.UserNotifier={USER_NOTIFICATION_STATUS_UNREAD:0,USER_NOTIFICATION_STATUS_READ:1,USER_NOTIFICATION_STATUS_INVISIBLE:2,MAX_ROWS_TO_RETRIEVE:100,MAX_INITIAL_ROWS:10,NUM_ROWS_TO_APPEND:10,SCROLLING_OFFSET:10,_is_retrieving_feed:false,_unread_count:0,_notifications:[],LAST_ACKED_META_ID_KEY:"last_acked_meta_id_key",_current_meta_not_id:null,_num_event_rows:0,_acked_ids:{},_shown:{},_has_more:false,_has_acked:false,THUMBS_BATCH_SIZE:16,_thumb_cache:{},init:function(){var eT,eU,T;this.refresh_feed();br("#event-feed-container").scroll(function(){if(J._has_more){if(J._scroller_within_offset_to_bottom(J.SCROLLING_OFFSET)){return J._append_event_rows(false)}}});Event.observe($("event-feed-container"),"mousewheel",this.scrolling.bind(this));Event.observe($("event-feed-container"),"DOMMouseScroll",this.scrolling.bind(this));br("#event-feed").on("click",this._mouseclick.bind(this));T=[];for(eU in O){eT=O[eU];T.push(this._subscribe_user(eT))}return T},refresh_feed:function(T,eT){var eV,eW,eU;eU=(function(eX){return function(eZ){var e2,e0,e1,eY;eX._unread_count=eZ.unread_count;eX._notifications=eZ.notifications;if(eZ.meta_notification){e0=eZ.meta_notification;e1=eX._identifier(e0);if(e1!==eX._get_last_acked_meta_not_id()){eX._unread_count++}eX._current_meta_not_id=e1;eX._notifications.push(e0)}eX._has_acked=false;eX._notifications.sort(eX._sort_key);eX._append_event_rows(true);eX.update_jewel_ui(eX._unread_count);if((T!=null)&&(eT!=null)){eY=T.get_user_id();e2=eZ.latest_nid[eY];T.handler_success(eT,{nid:eZ.latest_nid[eY]})}if(bM){return bM.refresh_inbox_counts()}}})(this);eW=(function(eX){return function(){return eX._is_retrieving_feed=false}})(this);eV=(function(eX){return function(){var eY;eX._is_retrieving_feed=true;eY={count:eX.MAX_ROWS_TO_RETRIEVE};return new br.ajax("/web/notifications/retrieve",{data:eY,dataType:"json",type:"POST",success:eU,error:function(){if((T!=null)&&(eT!=null)){return T.handler_failure(eT)}},complete:eW})}})(this);return eV()},ack_unread_notifications:function(){if(!this._has_acked&&this._unread_count>0){this.update_jewel_ui(0);if(this._get_last_acked_meta_not_id()!==this._current_meta_not_id){this._set_last_acked_meta_not_id(this._current_meta_not_id);this._acked_ids[this._current_meta_not_id]=true}new br.ajax("/web/notifications/ack_all",{dataType:"json",type:"POST",success:(function(T){return function(eV){var eW,eY,eX,eU,eT;eT=[];for(eX=0,eU=eV.length;eX<eU;eX++){eY=eV[eX];eW=T._identifier(eY);T._acked_ids[eW]=true;eT.push(T._append_event_rows())}return eT}})(this)});return this._has_acked=true}},update_jewel_ui:function(T){br("#new-notification-count").text(T).toggleClass("show",T>0);if(T>0){br(".notifications-bell").addClass("shake")}return setTimeout((function(){return br(".notifications-bell").removeClass("shake")}),500)},scrolling:function(T){var eT;if(T.originalEvent){T=T.originalEvent}eT=T.detail?T.detail*(-40):T.wheelDelta;if(!this._has_more&&eT<=0&&this._scroller_within_offset_to_bottom(0)){return this.preventDefault(T)}else{if(eT>=0&&$("event-feed-container").scrollTop===0){return this.preventDefault(T)}}},clear_cached_client_states:function(){if(this._is_retrieving_feed){return}this._acked_ids={};return this._append_event_rows(true)},preventDefault:function(T){if(typeof T.preventDefault==="function"){T.preventDefault()}return T.returnValue=false},_subscribe_user:function(T){var eT;return eT=T.subscribe_user({name:"NotificationFeedUpdater",handler:(function(eU){return function(){return eU.refresh_feed(T,eT)}})(this)})},_append_event_rows:function(e1){var T,e5,e8,eU,e3,eZ,e2,e0,eY,e4,eT,eW,e7,eV,e6,eX;if(e1==null){e1=false}if(e1){br("#event-feed").empty();this._shown={};this._num_event_rows=Math.min(this._notifications.length,this.MAX_INITIAL_ROWS)}else{this._num_event_rows+=this.NUM_ROWS_TO_APPEND;this._num_event_rows=Math.min(this._num_event_rows,this._notifications.length)}e4=br(".feed-row").size();e5=[];eX=this._notifications;for(e2=eV=0,e6=eX.length;eV<e6;e2=++eV){eY=eX[e2];if(e4>=this._num_event_rows){break}e3=this._identifier(eY);if(e3 in this._shown){continue}this._shown[e3]=true;eW=eY.status;eU=br(eY.notification_div);br("#event-feed").append(eU);e4++;eZ=eU.find("img").get(0);if(eZ){T=br(eZ);e8=T.attr("data-src");if(e8){if(this._thumb_cache[e8]){e0=this._thumb_cache[e8];T.attr("src",e0);if(!e0.endsWith(cj.SPACER)){this._add_thumbnail_frame(T)}}else{if(!(e8 in this._thumb_cache)){this._thumb_cache[e8]=false;e7=eY.user_id;T.data("uid",e7);T.data("not-identifier",e3);e5.push($(eZ))}}}}if(!eU.hasClass("feed-row")){eU=eU.find(".feed-row")}if(eY.type_id===Constants.NOTIFICATION_TYPE_META){eU.addClass("meta-feed");if((!(e3 in this._acked_ids))&&(e3===this._get_last_acked_meta_not_id())){eU.addClass("read")}}if(eW===this.USER_NOTIFICATION_STATUS_INVISIBLE){eU.addClass("invisible");if(e3 in this._acked_ids){delete this._acked_ids[e3]}}if(eW===this.USER_NOTIFICATION_STATUS_READ){if(!(e3 in this._acked_ids)){eU.addClass("read")}}}eT=(function(e9){return function(fd){var fb,fa,fc;if(!fd.src.endsWith(cj.SPACER)){fb=br(fd);e9._add_thumbnail_frame(fb);e3=fb.data("not-identifier");fc=fb.attr("data-src");fa=fb.attr("src");return e9._thumb_cache[fc]=fa}}})(this);bh.batch_load_thumbs(e5,this.THUMBS_BATCH_SIZE,eT);this._has_more=this._num_event_rows<this._notifications.length;if(br(".feed-row").length===0){return br("#event-feed-container").addClass("empty")}else{return br("#event-feed-container").removeClass("empty")}},_identifier:function(T){return""+T.user_id+" "+T.type_id+" "+T.target_object_key},_sort_key:function(eT,T){if(eT.sticky&&!T.sticky){return -1}if(T.sticky&&!eT.sticky){return 1}if(eT.status===J.USER_NOTIFICATION_STATUS_UNREAD&&T.status!==J.USER_NOTIFICATION_STATUS_UNREAD){return -1}if(T.status===J.USER_NOTIFICATION_STATUS_UNREAD&&eT.status!==J.USER_NOTIFICATION_STATUS_UNREAD){return 1}return T.feed_time-eT.feed_time},_get_last_acked_meta_not_id:function(){if(window.localStorage){return localStorage.getItem(this.LAST_ACKED_META_ID_KEY)}},_set_last_acked_meta_not_id:function(T){if(window.localStorage){return localStorage.setItem(this.LAST_ACKED_META_ID_KEY,T)}},_add_thumbnail_frame:function(T){br(T).addClass("thumbnail");return br(T).parent(".feed-thumbnail").addClass("has-frame")},_mouseclick:function(eU){var eT,T;eT=br(eU.target);if(eT.is("a")){if(eT.hasClass("view")){eU.preventDefault();T=eT.attr("data-mount");window.open(T)}}if(eT.closest("a").hasClass("meta-notification-sign-in-needed")){eU.preventDefault();return bB.show_page_login_modal((function(eV){return function(){return eV.refresh_feed()}})(this))}},_scroller_within_offset_to_bottom:function(eT){var T;T=$("event-feed-container");return T.scrollTop+T.offsetHeight+eT>=T.scrollHeight}};dh=B.NotificationUIButton=(function(eT){cA(T,eT);T.prototype.selector=function(){return".notification-button"};function T(){this.clear=db(this.clear,this);this.active=db(this.active,this);this._clear_sticky_notification_on_popover_close=db(this._clear_sticky_notification_on_popover_close,this);T.__super__.constructor.call(this);this._overflowY="auto";this._position="static";this._max_height="0px"}T.prototype._clear_sticky_notification_on_popover_close=function(){if(!br(this.selector())[0].hasClassName("active")){return J.clear_cached_client_states()}};T.prototype.active=function(eU,eW){var eV;eV=eU.target.hasClassName("feed-row")?eU.target:$(eU.target).up(".feed-row");if(eV){if(!eV.hasClassName("clickable")){return}}T.__super__.active.call(this,eU,eW);return this._clear_sticky_notification_on_popover_close()};T.prototype.clear=function(eU){T.__super__.clear.call(this,eU);return this._clear_sticky_notification_on_popover_close()};return T})(dC);var bo,ca,es;es=B.UnsupportedBrowser={init:function(){return br("#unsupported-browser-dismiss").on("click",function(T){T.preventDefault();eI.hide();return br.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};ca=B.ExpiredCCNotificationBar={init:function(T){return br(".expired-dismiss").on("click",function(eT){eT.preventDefault();eI.hide();return br.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:T}})})}};bo=B.BetaLocaleNotificationBar={init:function(T){return br(".beta-locale-dismiss").on("click",function(eT){eT.preventDefault();eI.hide();return br.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:T}})})}};var d;d=INLINE_JS.viewer=cy.get_viewer();require(["modules/dirty/eventbus_dark_launch"],function(T){return __CIRCULAR_DEPENDENCY__.EventbusDarkLaunch=T});var I,bZ,g,f,cB,cv,v,d1;if(!Constants.is_test){br(ev.check_timezone)}if(window._document_observe_listeners){v=window._document_observe_listeners;for(g=0,cB=v.length;g<cB;g++){bZ=v[g];if(document.loaded){bZ.func()}else{document.observe(bZ.event,bZ.func)}}}if(window._jquery_ready_handlers){d1=window._jquery_ready_handlers;for(f=0,cv=d1.length;f<cv;f++){I=d1[f];br(I)}}br(function(){Event.fire(document,"script:loaded");return $(document.body).removeClassName("deferred-resources")});return B});